<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS â€” BudÅ¼et (ulepszona wersja)</title>
  <link rel="stylesheet" href="styles.css">
    <style>
    .row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .budget-tabs {
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 8;
      padding: 8px 0;
      margin-bottom: 0;
    }

    .trend {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .progress {
      height: 8px;
      background: #e2e8f0;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress > i {
      display: block;
      height: 100%;
      background: var(--ink);
    }

    .progress.good > i { background: var(--green); }
    .progress.warn > i { background: var(--orange); }

    .chart-box {
      height: 240px;
      position: relative;
    }

    .chart-box.tall { height: 320px; }
    .chart-box.wide { height: 280px; }

    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .quick-actions .quick-btn {
      display: flex;
      flex-direction: column;
      gap: 2px;
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      text-align: center;
      transition: all .2s ease;
      background: var(--surface);
    }

    .quick-actions .quick-btn:hover {
      border-style: solid;
      border-color: var(--blue);
      background: #eff6ff;
    }

    .heat-day {
      width: 22px;
      height: 22px;
      border-radius: 4px;
      display: grid;
      place-items: center;
      font-size: 10px;
    }

    .heatmap-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recent-calendar-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recent-calendar {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
    }

    .recent-day {
      background: var(--surface);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 14px;
      padding: 8px 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
      transition: border-color .2s ease, transform .2s ease;
    }

    .recent-day:hover {
      border-color: rgba(59, 130, 246, 0.35);
      transform: translateY(-1px);
    }

    .recent-day-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 4px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .recent-day-header span {
      display: block;
      line-height: 1.1;
    }

    .recent-day-weekday {
      font-size: 10px;
      font-weight: 600;
    }

    .recent-day-date {
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
      text-transform: none;
      letter-spacing: 0.02em;
    }

    .recent-day-total {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }

    .recent-day-body {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .recent-entry {
      display: flex;
      gap: 6px;
      align-items: flex-start;
      padding: 4px 6px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: rgba(148, 163, 184, 0.08);
      transition: border-color .2s ease, background .2s ease;
      font-size: 10px;
    }

    .recent-entry-emoji {
      width: 20px;
      height: 20px;
      display: grid;
      place-items: center;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      line-height: 1;
      flex-shrink: 0;
    }

    .recent-entry-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .recent-entry-amount {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      font-size: 11px;
      line-height: 1.2;
      color: var(--ink);
    }

    .recent-entry-note {
      font-size: 9px;
      color: var(--muted);
      line-height: 1.2;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .recent-entry.top-spend {
      border-color: rgba(248, 113, 113, 0.55);
      background: rgba(248, 113, 113, 0.12);
    }

    .recent-entry.top-spend .recent-entry-emoji {
      background: rgba(248, 113, 113, 0.18);
    }

    .recent-entry.top-spend .recent-entry-amount {
      color: #b91c1c;
    }

    .recent-entry-hidden {
      display: none;
    }

    .recent-more {
      border: none;
      background: transparent;
      color: var(--blue);
      font-size: 9px;
      font-weight: 600;
      padding: 0;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      align-self: flex-start;
    }

    .recent-more::after {
      content: 'â€º';
      font-size: 10px;
      transition: transform .2s ease;
    }

    .recent-day.expanded .recent-more::after {
      transform: rotate(90deg);
    }

    .recent-empty {
      font-size: 9px;
      color: var(--muted);
      text-align: center;
      padding: 8px 0 4px;
    }

    .recent-day.recent-day-empty {
      border-style: dashed;
    }

    .recent-day.recent-day-empty .recent-day-total {
      color: var(--muted);
    }

    @media (max-width: 1100px) {
      .recent-calendar {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
    }

    .heatmap-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--surface);
      max-height: 120px;
      overflow-y: auto;
    }

    .heat-legend {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
      color: #64748b;
    }

    .table-compact thead th,
    .table-compact tbody td {
      padding: 6px 8px;
      font-size: 12px;
      line-height: 1.25;
    }

    .table-compact tbody tr:nth-child(even) {
      background: transparent;
    }

    .editor-section {
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
      background: var(--surface);
    }

    .qa-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .qa-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .split-box {
      border: 1px dashed var(--line);
      padding: 8px;
      border-radius: 10px;
      background: var(--surface);
    }

    .banner {
      background: #ecfeff;
      border: 1px solid #cffafe;
      border-radius: 12px;
      padding: 10px;
    }

    .hint { font-size: 12px; color: #64748b; }

    .timeline-wrapper { position: relative; padding-top: 40px; margin-top: 16px; }
    .timeline-labels { position: relative; height: 30px; margin-bottom: 5px; }
    .timeline-label { position: absolute; bottom: 0; transform: translateX(-50%); background: var(--bg); border: 1px solid var(--line); font-size: 11px; padding: 2px 6px; border-radius: 6px; white-space: nowrap; }
    .timeline-label::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid var(--line); }
    .timeline-axis { display: flex; justify-content: space-between; font-size: 10px; color: var(--muted); border-top: 1px solid var(--line); padding-top: 4px; }
    .timeline-goals { position: relative; margin-top: 10px; }
    .timeline-bar { position: absolute; height: 24px; background: linear-gradient(90deg, var(--blue) 0%, var(--blue) 100%); border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; color: white; font-size: 12px; white-space: nowrap; }
    .timeline-bar .bar-label { font-weight: 500; }
    .timeline-bar .bar-progress { opacity: 0.7; }

    .analytics-cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

    .analytics-filter-card {
      margin-top: 12px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: 0 1px 2px rgb(15 23 42 / 0.08);
    }

    .analytics-filter-grid {
      margin-top: 12px;
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .analytics-filter-grid label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
    }

    .analytics-filter-grid label.active {
      border-color: var(--blue);
      background: #eff6ff;
    }

    .analytics-filter-grid label span {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .analytics-filter-actions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .analytics-summary { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .analytics-month-picker { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .analytics-month-chip { padding: 6px 10px; border-radius: 10px; border: 1px solid var(--line); background: #fff; cursor: pointer; font-size: 12px; transition: all .2s ease; }
    .analytics-month-chip.active { background: #0f172a; color: #fff; border-color: #0f172a; }
    .analytics-month-chip:hover { border-color: var(--blue); }

    .table-sortable th { position: relative; white-space: nowrap; }
    .table-sortable th[data-sort] { cursor: pointer; }
    .table-sortable th .sort-indicator { font-size: 10px; margin-left: 4px; color: var(--muted); }

    .th-label { display: inline-flex; align-items: center; gap: 4px; }

    .delta-up { color: var(--green); font-weight: 600; }
    .delta-down { color: var(--red); font-weight: 600; }
    .delta-neutral { color: var(--muted); font-weight: 500; }

    .insight-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 12px;
      background: var(--surface);
      margin-right: 6px;
      margin-top: 4px;
    }

    .insight-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }

    .eom-panel {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
    }

    .eom-panel .title { font-size: 18px; margin: 0 0 6px 0; }

    .table-modern thead th {
      background: #f1f5f9;
      font-weight: 600;
      font-size: 13px;
      color: #475569;
      border-bottom: 1px solid var(--line);
    }

    .table-modern tbody tr:nth-child(even) { background: #f8fafc; }
    .table-modern td { vertical-align: top; }

    .kpi-card {
      background: #0f172a;
      color: #fff;
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 120px;
    }

    .kpi-card.light {
      background: var(--surface);
      color: var(--ink);
      border: 1px solid var(--line);
    }

    .kpi-card .label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.7; }
    .kpi-card .value { font-size: 26px; font-weight: 700; }
    .kpi-card .sub { font-size: 12px; opacity: 0.8; }

    .kpi-trend { font-size: 12px; font-weight: 600; }
    .kpi-trend.trend-up { color: var(--green); }
    .kpi-trend.trend-down { color: var(--red); }
    .kpi-trend.trend-flat { color: var(--muted); }

    .mom-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .mom-control {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .mom-control select,
    .mom-control input[type="number"] {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 13px;
      background: #fff;
      min-width: 140px;
    }

    #mom-table tbody tr {
      cursor: pointer;
      transition: background .2s ease;
    }

    #mom-table tbody tr:hover { background: rgba(59, 130, 246, 0.1); }
    #mom-table tbody tr.active { background: rgba(59, 130, 246, 0.16); }

    .mom-summary { font-size: 12px; color: var(--muted); margin-top: 6px; }


    .chart-empty {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>
<body data-page="budget">
  <div class="layout">
    <aside class="sidebar" aria-label="GÅ‚Ã³wna nawigacja">
      <div class="sidebar__header">
        <span class="sidebar__emoji">ğŸ§­</span>
        <span class="sidebar__brand">LifeOS</span>
      </div>
      <nav class="sidebar__nav" aria-label="Sekcje LifeOS">
        <ul class="sidebar__list">
          <li class="sidebar__item">
            <a class="sidebar__link" href="index.html" data-page="dashboard">
              <span class="sidebar__icon">ğŸ“Š</span>
              <span class="sidebar__label">Dashboard</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="budget.html" data-page="budget">
              <span class="sidebar__icon">ğŸ’°</span>
              <span class="sidebar__label">BudÅ¼et</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="tasks.html" data-page="tasks">
              <span class="sidebar__icon">âœ…</span>
              <span class="sidebar__label">Zadania</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="trainings.html" data-page="trainings">
              <span class="sidebar__icon">ğŸ’ª</span>
              <span class="sidebar__label">Progres</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="fuel.html" data-page="fuel">
              <span class="sidebar__icon">â›½</span>
              <span class="sidebar__label">Paliwo</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="loan.html" data-page="loan">
              <span class="sidebar__icon">ğŸ¦</span>
              <span class="sidebar__label">Kredyt</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="inventory.html" data-page="inventory">
              <span class="sidebar__icon">ğŸ“¦</span>
              <span class="sidebar__label">Magazyn</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="house.html" data-page="house">
              <span class="sidebar__icon">ğŸ </span>
              <span class="sidebar__label">Budowa</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar__footer">
        <strong>TwÃ³j cyfrowy dom</strong>
        ZarzÄ…dzaj budÅ¼etem, zadaniami i celami w jednym miejscu.
      </div>
    </aside>

    <div class="main">
      <header class="page-header" role="banner">
        <div class="page-header__top">
          <span class="page-overline">Finanse</span>
          <h1 class="page-title">
            <span class="page-title__icon">ğŸ’°</span>
            <span class="page-title__text">BudÅ¼et</span>
          </h1>
        </div>
        <div class="page-header__actions page-header__actions--spread" aria-label="Akcje strony">
          <div class="page-header__badges">
            <span class="badge">ğŸ’¾ Dane lokalne</span>
            <span class="badge">ğŸ“ˆ Analiza offline</span>
          </div>
          <div class="toolbar budget-month-nav">
            <button class="btn soft" id="prevMonthBtn" title="Poprzedni miesiÄ…c">â†</button>
            <span class="pill" id="workingMonth">YYYY-MM</span>
            <button class="btn soft" id="nextMonthBtn" title="NastÄ™pny miesiÄ…c">â†’</button>
          </div>
          <div class="toolbar budget-io-actions">
            <button class="btn ghost" id="exportBtn">â¬‡ï¸ Eksport JSON</button>
            <button class="btn ghost" id="importBtn">â¬†ï¸ Import JSON</button>
            <input type="file" id="importFile" accept="application/json" style="display:none" />
          </div>
        </div>
      </header>

      <div class="content">
        <main class="page-content content-main stack">
    <div class="tabs budget-tabs" style="margin-top:12px">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="overview">PrzeglÄ…d</button>
      <button class="tab" data-tab="incomes">Przychody</button>
      <button class="tab" data-tab="fixed">StaÅ‚e wydatki</button>
      <button class="tab" data-tab="variable">Wydatki zmienne</button>
      <button class="tab" data-tab="categories">Kategorie</button>
      <button class="tab" data-tab="eom">Salda (EOM)</button>
      <button class="tab" data-tab="goals">Cele</button>
      <button class="tab" data-tab="analytics">Analityka</button>
      <button class="tab" data-tab="mom">PorÃ³wnanie MoM</button>
    </div>

    <!-- Dashboard -->
    <section id="tab-dashboard" class="card" style="margin-top:12px">
      <h3 class="title">Dashboard finansowy</h3>
      <div class="grid-2" style="margin-top:12px">
        <div class="card">
          <div class="title">Wydatki dzieÅ„ po dniu</div>
          <div class="chart-box"><canvas id="dailyLine"></canvas></div>
        </div>
        <div class="card">
          <div class="title">Skumulowane: limit vs wydatki</div>
          <div class="hint">Dwie linie: oczekiwane (np. 400 zÅ‚/dzieÅ„) vs faktyczne (wydatki + oszczÄ™dnoÅ›ci)</div>
          <div class="chart-box"><canvas id="cumulativeLine"></canvas></div>
        </div>
      </div>

      <div class="card heatmap-card" style="margin-top:16px">
        <div class="title">Wydatki dzienne â€” heatmap</div>
        <div class="muted" style="margin-bottom:4px">Zielone = w budÅ¼ecie, PomaraÅ„czowe = przekroczenie, Czerwone = duÅ¼e przekroczenie</div>
        <div id="daily-spending-calendar" class="heatmap-strip"></div>
        <div class="heat-legend">
          <span class="heat-day" style="background:#dcfce7"> </span> w normie
          <span class="heat-day" style="background:#ffedd5"> </span> lekko powyÅ¼ej
          <span class="heat-day" style="background:#fee2e2"> </span> mocno powyÅ¼ej
        </div>
      </div>

      <div class="card recent-calendar-card" style="margin-top:16px">
        <div class="row" style="justify-content:space-between;align-items:flex-start;gap:12px">
          <div>
            <div class="title">Ostatnie 7 dni â€” wydatki</div>
            <p class="muted tiny">NajwiÄ™ksze wydatki z ostatnich dni, posegregowane malejÄ…co. Top 5 oznaczone na czerwono.</p>
          </div>
          <div class="chip" style="margin:0" id="recent-seven-total">ÅÄ…cznie: â€”</div>
        </div>
        <div id="recent-spending-calendar" class="recent-calendar"></div>
      </div>

      <div id="var-table-dashboard-slot" style="display:none">
        <div id="var-transactions-card" class="card">
          <div class="row" style="justify-content:space-between;align-items:flex-end;gap:12px">
            <div>
              <div class="title">Transakcje w miesiÄ…cu</div>
              <p class="muted tiny">Monitoruj wszystkie wydatki zmienne w aktywnym okresie.</p>
            </div>
            <div class="chip" style="margin:0">
              Suma: <b id="var-sum">0</b>
            </div>
          </div>
          <div class="row" style="margin:12px 0;gap:8px;align-items:center;flex-wrap:wrap">
            <label class="tiny" style="display:flex;flex-direction:column;gap:6px">
              Filtr kategorii
              <select id="var-filter-cat"><option value="">Wszystkie kategorie</option></select>
            </label>
          </div>
          <div class="table-wrapper" style="max-height:320px;overflow:auto">
            <table class="table-compact">
              <thead><tr><th>Data</th><th>Kategoria</th><th>Konto</th><th>Kwota</th><th>Notatka</th><th></th></tr></thead>
              <tbody id="var-rows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="quick-actions" style="margin-top:12px">
        <div class="row">
          <div class="title">Szybkie akcje</div>
          <div class="row" style="gap:8px">
            <button id="qa-edit-toggle" class="btn ghost">âš™ï¸ Edytuj szybkie akcje</button>
          </div>
        </div>
        <div id="qa-grid" class="grid g-4" style="margin-top:8px"></div>
        <div id="qa-editor" class="editor-section" style="display:none">
          <div class="title">Edycja szybkich akcji</div>
          <div class="tiny">Zapisuje siÄ™ w pamiÄ™ci przeglÄ…darki (localStorage).</div>
          <form id="qa-add-form" class="grid g-4" style="margin-top:10px">
            <input name="label" placeholder="Nazwa (np. Jedzenie)" required />
            <input name="emoji" placeholder="Emoji (np. ğŸ•)" />
            <select name="categoryId" required></select>
            <select name="accountId" required></select>
            <input name="defaultAmount" placeholder="DomyÅ›lna kwota (zÅ‚)" inputmode="decimal" />
            <input name="defaultNote" placeholder="DomyÅ›lna notatka" />
            <button class="btn" type="submit" style="grid-column: 1 / -1;">Dodaj akcjÄ™</button>
          </form>
          <table style="margin-top:10px">
            <thead><tr><th>Emoji</th><th>Nazwa</th><th>Kategoria</th><th>Konto</th><th>DomyÅ›lna kwota</th><th>Notatka</th><th></th></tr></thead>
            <tbody id="qa-rows"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Overview -->
    <section id="tab-overview" class="card" style="margin-top:12px;display:none">
      <h3 class="title">PrzeglÄ…d miesiÄ…ca â€” <span id="ov-month">YYYY-MM</span></h3>
      <div class="grid g-4">
        <div class="stat-card"><div class="muted">Przychody</div><div class="big-number" id="ov-inc">0</div></div>
        <div class="stat-card"><div class="muted">StaÅ‚e zaplanowane</div><div class="big-number" id="ov-fixed-planned">0</div></div>
        <div class="stat-card"><div class="muted">StaÅ‚e zapÅ‚acone</div><div class="big-number ok" id="ov-fixed-paid">0</div></div>
        <div class="stat-card"><div class="muted">StaÅ‚e do zapÅ‚acenia</div><div class="big-number warn" id="ov-fixed-unpaid">0</div></div>
        <div class="stat-card"><div class="muted">Wydatki zmienne</div><div class="big-number bad" id="ov-var-spent">0</div></div>
        <div class="stat-card"><div class="muted">OszczÄ™dnoÅ›ci</div><div class="big-number" style="color:var(--blue)" id="ov-savings">0</div></div>
        <div class="stat-card"><div class="muted">BudÅ¼et zmienny do dyspozycji</div><div class="big-number" id="ov-remaining">0</div></div>
        <div class="stat-card"><div class="muted">Prognozowana stopa oszczÄ™dnoÅ›ci</div><div class="big-number" id="stat-savings-rate">0%</div></div>
      </div>
    </section>

    <!-- Incomes -->
    <section id="tab-incomes" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Przychody â€” <span id="inc-month">YYYY-MM</span></h3>
      <form id="inc-form" class="grid g-3" style="margin-bottom:8px">
        <input required name="amount" placeholder="Kwota (zÅ‚)" inputmode="decimal" />
        <input name="note" placeholder="Notatka (np. pensja)" />
        <button class="btn" type="submit">Dodaj przychÃ³d</button>
      </form>
      <div class="muted" style="margin-bottom:4px">Suma: <b id="inc-sum">0</b></div>
      <table><thead><tr><th>Kwota</th><th>Notatka</th><th></th></tr></thead><tbody id="inc-rows"></tbody></table>
    </section>

    <!-- Fixed Expenses -->
    <section id="tab-fixed" class="card" style="margin-top:12px;display:none">
      <div class="row">
        <h3 class="title" style="margin: 0;">StaÅ‚e wydatki â€” <span id="fix-month">YYYY-MM</span></h3>
        <button id="fix-manage-templates-btn" class="btn ghost">âš™ï¸ ZarzÄ…dzaj szablonami</button>
      </div>
      
      <!-- NEW: Fixed expense templates manager -->
      <div id="fix-templates-manager" class="editor-section" style="margin-bottom:12px; display:none">
        <div class="title">ZarzÄ…dzaj szablonami staÅ‚ych wydatkÃ³w</div>
        <p class="tiny">Zdefiniuj staÅ‚e opÅ‚aty (np. czynsz, abonamenty), a aplikacja bÄ™dzie sugerowaÄ‡ ich dodanie w kaÅ¼dym miesiÄ…cu.</p>
        <form id="fix-template-form" class="grid g-4" style="margin-top:8px">
          <input name="title" placeholder="Nazwa (np. Czynsz)" required />
          <input name="amount" placeholder="Kwota (zÅ‚)" inputmode="decimal" required />
          <input name="day" type="number" min="1" max="31" placeholder="DzieÅ„ pÅ‚atnoÅ›ci (1-31)" required />
          <button class="btn" type="submit">Dodaj szablon</button>
        </form>
        <table style="margin-top:10px">
          <thead><tr><th>Nazwa</th><th>Kwota</th><th>DzieÅ„ miesiÄ…ca</th><th></th></tr></thead>
          <tbody id="fix-templates-tbody"></tbody>
        </table>
      </div>

      <!-- NEW: Fixed expense suggestions -->
      <div id="fix-suggestions-box" class="card" style="margin-bottom: 12px; display: none; background: #f8fafc;">
        <div class="row">
          <div class="title">ğŸ’¡ Sugestie na ten miesiÄ…c</div>
          <button id="fix-apply-all-btn" class="btn soft">Dodaj wszystkie</button>
        </div>
        <div id="fix-suggestions-list" class="grid g-3" style="margin-top:8px; gap:8px"></div>
      </div>

      <form id="fix-form" class="grid g-4" style="margin:8px 0">
        <input required name="title" placeholder="TytuÅ‚ (np. czynsz)" />
        <input required name="amount" placeholder="Kwota (zÅ‚)" inputmode="decimal" />
        <input name="due" type="date" />
        <input type="hidden" name="categoryId" value="c_fixed"/>
        <button class="btn" type="submit">Dodaj jednorazowo</button>
      </form>
      
      <div class="row" style="margin-bottom:12px">
        <label style="display:inline-flex;gap:8px;align-items:center">
          <input type="checkbox" id="autoTx" checked />Automatycznie dodaj transakcjÄ™ po opÅ‚aceniu
        </label>
        <button class="btn soft" id="payAllFixed">OpÅ‚aÄ‡ wszystkie</button>
      </div>

      <table>
        <thead><tr><th>Status</th><th>TytuÅ‚</th><th>Kwota</th><th>Termin</th><th>Dni do terminu</th><th></th></tr></thead>
        <tbody id="fix-rows"></tbody>
      </table>
      <div class="muted" style="margin-top:8px">Suma nieopÅ‚aconych: <b id="fix-unpaid-sum">0</b></div>
    </section>

    <!-- Variable -->
    <section id="tab-variable" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Wydatki zmienne â€” <span id="var-month">YYYY-MM</span></h3>

      <!-- Sugestie cykliczne -->
      <div id="rec-suggestions" class="card" style="margin-bottom:10px; display:none">
        <div class="row">
          <div class="title">ğŸ” Cykliczne â€” Sugestie na <span id="rec-sugg-month"></span></div>
          <button class="btn ghost" id="rec-manage-toggle">âš™ï¸ ZarzÄ…dzaj szablonami</button>
        </div>
        <div id="rec-sugg-list" class="grid" style="gap:8px"></div>
      </div>

      <!-- ZarzÄ…dzanie szablonami (zmienne) -->
      <div id="rec-manage" class="editor-section" style="display:none">
        <div class="title">Szablony cykliczne</div>
        <div class="tiny">MiesiÄ™czny harmonogram (dzieÅ„ 1â€“31). ObsÅ‚uga splitu.</div>
        <form id="rec-add-form" class="grid g-4" style="margin-top:8px">
          <input name="label" placeholder="Nazwa (np. Abonament)" required />
          <input name="day" type="number" min="1" max="31" placeholder="DzieÅ„ miesiÄ…ca" required />
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" name="isSplit" /> Split</label><span></span>
          <div data-mode="single" class="grid g-4" style="grid-column:1/-1;gap:8px">
            <select name="categoryId"></select>
            <select name="accountId"></select>
            <input name="amount" placeholder="Kwota (zÅ‚)" inputmode="decimal" />
            <input name="note" placeholder="Notatka" />
          </div>
          <div data-mode="split" class="split-box" style="grid-column:1/-1;display:none">
            <table style="width:100%"><thead><tr><th>Kategoria</th><th>Kwota</th><th></th></tr></thead><tbody class="rec-split-rows"></tbody></table>
            <div style="margin-top:6px"><button class="btn soft" type="button" id="rec-split-add">+ wiersz</button></div>
          </div>
          <button class="btn" type="submit" style="grid-column:1/-1">Dodaj szablon</button>
        </form>
        <table style="margin-top:10px">
          <thead><tr><th>Nazwa</th><th>DzieÅ„</th><th>Tryb</th><th>Podsumowanie</th><th>Konto</th><th>Notatka</th><th></th></tr></thead>
          <tbody id="rec-rows"></tbody>
        </table>
      </div>

      <!-- Dodawanie transakcji -->
      <form id="var-form" class="grid g-4" style="margin:10px 0">
        <input type="date" name="date" />
        <input required name="amount" placeholder="Kwota (zÅ‚)" inputmode="decimal" />
        <select name="categoryId"></select>
        <select name="accountId"></select>
        <input name="note" placeholder="Notatka" />
        <button class="btn" type="submit">Dodaj wydatek</button>
      </form>

      <div id="var-table-variable-slot" style="margin-top:12px"></div>

      <div class="insight-bubble" style="margin-top:12px">ğŸ“Š SzczegÃ³Å‚owÄ… tabelÄ™ transakcji znajdziesz poniÅ¼ej lub w panelu â€Dashboard finansowyâ€.</div>
    </section>

    <!-- Categories -->
    <section id="tab-categories" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Kategorie</h3>
      <form id="cat-form" class="grid g-4" style="margin-bottom:8px">
        <input required name="name" placeholder="Nazwa" />
        <select name="type">
          <option value="expense">Wydatek</option>
          <option value="income">PrzychÃ³d</option>
          <option value="saving">OszczÄ™dnoÅ›Ä‡</option>
        </select>
        <input name="emoji" placeholder="Emoji (np. ğŸ•)" />
        <input name="budget" placeholder="BudÅ¼et (zÅ‚)" inputmode="decimal" />
        <button class="btn" type="submit">Dodaj kategoriÄ™</button>
      </form>
      <div class="muted" id="cat-empty" style="display:none;margin-bottom:8px">Brak kategorii â€” dodaj pierwszÄ… powyÅ¼ej.</div>
      <table>
        <thead><tr><th>Emoji</th><th>Nazwa</th><th>Typ</th><th>BudÅ¼et</th><th>Wydano</th><th>Status</th><th></th></tr></thead>
        <tbody id="cat-rows"></tbody>
      </table>
    </section>

    <!-- EOM -->
    <section id="tab-eom" class="card" style="margin-top:12px;display:none">
      <div class="row" style="align-items:flex-start;gap:12px">
        <div>
          <h3 class="title" style="margin-bottom:4px">Salda i majÄ…tek netto</h3>
          <p id="eom-prompt" class="tiny"></p>
        </div>
        <div class="row" style="gap:8px;align-items:center">
          <div class="tiny muted" style="display:flex;align-items:center;gap:6px">Aktywny miesiÄ…c <span class="pill" id="eom-active-month"></span></div>
          <button class="btn soft" type="button" id="eom-copy-last">Skopiuj poprzedni zapis</button>
        </div>
      </div>

      <div id="eom-kpis" class="grid g-4" style="margin-top:16px"></div>
      <div id="eom-insights" class="insight-row"></div>

      <div class="grid g-2" style="margin-top:16px;gap:16px">
        <div class="eom-panel">
          <div class="row" style="align-items:flex-end;gap:12px">
            <div>
              <div class="title" style="margin-bottom:4px">Rejestr sald</div>
              <p class="tiny">Dodaj konta i uzupeÅ‚nij ich stany na koniec miesiÄ…ca. Dane sÄ… przechowywane lokalnie w przeglÄ…darce.</p>
            </div>
            <label class="tiny" style="display:flex;flex-direction:column;gap:4px;align-items:flex-start">
              Filtr kont
              <select id="eom-account-filter" style="min-width:180px">
                <option value="all">Wszystkie konta</option>
                <option value="positive">Saldo dodatnie</option>
                <option value="negative">Saldo ujemne</option>
              </select>
            </label>
          </div>
          <form id="acct-form" class="grid g-3" style="gap:8px;margin:12px 0">
            <input name="name" placeholder="Dodaj konto (np. OszczÄ™dnoÅ›ci, DÅ‚ug na karcie)" style="grid-column: span 2;"/>
            <button class="btn soft" type="submit">Dodaj konto</button>
          </form>
          <div style="overflow-x:auto">
            <table id="eom-table" class="table-modern">
              <thead></thead>
              <tbody id="eom-rows"></tbody>
            </table>
          </div>
          <div class="row" style="margin-top:12px">
            <div class="muted">Suma sald (MajÄ…tek Netto): <b id="eom-total">0</b></div>
            <div class="row" style="gap:8px">
              <button class="btn ghost" type="button" id="eom-reset-inputs">WyczyÅ›Ä‡ pola</button>
              <button id="eom-save" class="btn" type="button">Zapisz salda</button>
            </div>
          </div>
        </div>
        <div class="eom-panel">
          <div class="title" style="margin-bottom:4px">Trendy majÄ…tku</div>
          <p class="tiny">Zobacz, jak zmienia siÄ™ Å‚Ä…czny majÄ…tek netto oraz ktÃ³re konta odpowiadajÄ… za najwiÄ™ksze ruchy.</p>
          <div class="chart-box tall"><canvas id="eom-networth-chart"></canvas></div>
          <div class="chart-box tall" style="margin-top:16px"><canvas id="eom-accounts-chart"></canvas></div>
          <div style="margin-top:16px;overflow-x:auto">
            <table id="eom-change-table" class="table-modern table-sortable">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="eom-panel" style="margin-top:16px">
        <div class="row" style="align-items:flex-end;gap:12px">
          <div>
            <div class="title" style="margin-bottom:4px">Historia sald i majÄ…tku netto</div>
            <p class="tiny">Analizuj zmiany w czasie, aby wychwyciÄ‡ trendy, rekordy i anomalie.</p>
          </div>
          <label class="tiny" style="display:flex;flex-direction:column;gap:4px;align-items:flex-start">
            Zakres miesiÄ™cy
            <select id="eom-history-months" style="min-width:160px">
              <option value="3">3 miesiÄ…ce</option>
              <option value="6" selected>6 miesiÄ™cy</option>
              <option value="12">12 miesiÄ™cy</option>
              <option value="all">Wszystkie</option>
            </select>
          </label>
        </div>
        <div style="overflow-x:auto;margin-top:12px">
          <table id="eom-accounts-history" class="table-modern">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="overflow-x:auto;margin-top:16px">
          <table id="eom-monthly-summary" class="table-modern table-sortable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Goals -->
    <section id="tab-goals" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Cele oszczÄ™dnoÅ›ciowe</h3>
      <form id="goal-form" class="grid g-4" style="margin-bottom:8px">
        <input required name="name" placeholder="Nazwa (np. Poduszka)" />
        <input required name="target" placeholder="Kwota celu" inputmode="decimal" />
        <label class="tiny" for="startdate">PoczÄ…tek oszczÄ™dzania</label>
        <label class="tiny" for="deadline">Termin koÅ„cowy</label>
        <input name="startdate" type="date" title="Data rozpoczÄ™cia oszczÄ™dzania"/>
        <input name="deadline" type="date" title="Data koÅ„cowa"/>
        <button class="btn" type="submit" style="grid-column: 1 / -1;">Dodaj cel</button>
      </form>

      <div id="goal-summary" class="card" style="margin-top:16px; background: #f8fafc;"></div>

      <div id="goal-timeline-wrapper" class="card" style="margin-top:16px;">
        <h4 class="title">OÅ› czasu celÃ³w</h4>
        <div class="timeline-wrapper">
            <div id="timeline-labels" class="timeline-labels"></div>
            <div id="goal-timeline" class="timeline-goals"></div>
            <div id="timeline-axis" class="timeline-axis"></div>
        </div>
      </div>
      
      <div class="card" style="margin-top:16px;">
        <h4 class="title">Harmonogram MiesiÄ™cznych WpÅ‚at na Cele</h4>
        <div style="overflow-x:auto;">
            <table id="goal-commitment-table"></table>
        </div>
      </div>

      <div id="goal-list" class="grid g-2" style="gap:10px; margin-top: 16px;"></div>

      <div class="card" style="margin-top:16px">
        <div class="title" id="alloc-form-title">Dodaj alokacjÄ™ na cel</div>
        <form id="alloc-form" class="grid g-3">
          <input type="hidden" name="allocId" />
          <select name="goalId"></select>
          <input name="date" type="date" />
          <input name="amount" placeholder="Kwota" inputmode="decimal" />
          <div style="grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 8px;">
            <button id="alloc-cancel-btn" type="button" class="btn ghost" style="display: none;">Anuluj</button>
            <button id="alloc-submit-btn" type="submit" class="btn">Dodaj alokacjÄ™</button>
          </div>
        </form>
      </div>
      
      <div class="card" style="margin-top:16px">
        <h4 class="title">Historia ostatnich alokacji</h4>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cel</th>
                    <th>Kwota</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="alloc-history-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Analytics -->
    <section id="tab-analytics" class="card" style="margin-top:12px;display:none">
      <div class="row" style="align-items:center">
        <h3 class="title" style="margin-bottom:0">Centrum Analityczne</h3>
      </div>

      <div class="analytics-filter-card">
        <div class="row" style="align-items:flex-start;gap:12px">
          <div style="flex:1">
            <div class="title" style="margin:0;font-size:18px">Zakres miesiÄ™cy</div>
            <div id="analytics-month-summary" class="analytics-summary">Kliknij miesiÄ…ce, aby ustawiÄ‡ dokÅ‚adny okres analizy.</div>
          </div>
          <div class="analytics-filter-actions" id="analytics-month-quick">
            <button class="btn soft" data-range="current">BieÅ¼Ä…cy</button>
            <button class="btn soft" data-range="last3">Ostatnie 3</button>
            <button class="btn soft" data-range="last6">Ostatnie 6</button>
            <button class="btn soft" data-range="year">BieÅ¼Ä…cy rok</button>
            <button class="btn soft" data-range="all">Wszystkie</button>
          </div>
        </div>
        <div id="analytics-month-picker" class="analytics-month-picker"></div>
      </div>

      <div class="analytics-filter-card">
        <div class="row" style="align-items:flex-start;gap:12px">
          <div style="flex:1">
            <div class="title" style="margin:0;font-size:18px">Filtry kategorii</div>
            <div id="analytics-filter-summary" class="analytics-summary">Zaznacz kategorie, aby analizowaÄ‡ je w szczegÃ³Å‚ach.</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <input id="analytics-category-search" placeholder="Szukaj kategorii" style="min-width:220px" />
            <div class="analytics-filter-actions">
              <button class="btn soft" id="analytics-select-all">Wszystkie</button>
              <button class="btn soft" id="analytics-select-none">WyczyÅ›Ä‡</button>
              <button class="btn soft" id="analytics-select-expense">Tylko wydatki</button>
              <button class="btn soft" id="analytics-select-savings">Tylko oszczÄ™dnoÅ›ci</button>
              <button class="btn soft" id="analytics-select-top5">Top 5 wg sumy</button>
            </div>
          </div>
        </div>
        <div id="analytics-category-filter-list" class="analytics-filter-grid"></div>
      </div>

      <div id="analytics-kpis" class="grid g-4" style="margin-top:12px"></div>

      <div class="grid g-2" style="margin-top:12px">
        <div class="card">
          <div class="title">Przychody vs Wydatki</div>
          <div class="hint">PorÃ³wnanie caÅ‚kowitych wpÅ‚ywÃ³w, wydatkÃ³w oraz wydatkÃ³w z wybranych kategorii.</div>
          <div class="chart-box"><canvas id="analytics-income-expense-chart"></canvas></div>
        </div>
        <div class="card">
          <div class="title">Struktura wybranych kategorii</div>
          <div class="hint">Wizualizacja udziaÅ‚Ã³w kategorii w sumie wydatkÃ³w objÄ™tych filtrem.</div>
          <div class="chart-box"><canvas id="analytics-category-chart"></canvas></div>
        </div>
      </div>

      <div class="grid g-2" style="margin-top:12px">
        <div class="card">
          <div class="title">AktywnoÅ›Ä‡ miesiÄ™czna (wybrane kategorie)</div>
          <div class="hint">SprawdÅº, czy zmiany wynikajÄ… z wiÄ™kszej liczby transakcji czy z wyÅ¼szych kwot.</div>
          <div class="chart-box"><canvas id="analytics-monthly-activity-chart"></canvas></div>
        </div>
        <div class="card">
          <div class="title">Åšrednia i mediana transakcji</div>
          <div class="hint">PorÃ³wnanie trendu Å›redniej i mediany dla wybranych kategorii.</div>
          <div class="chart-box"><canvas id="analytics-avg-trend-chart"></canvas></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Top kategorie â€” suma, czÄ™stotliwoÅ›Ä‡ i Å›rednia</div>
        <div class="hint">Åatwo ocenisz, ktÃ³re kategorie rosnÄ… przez wiÄ™kszÄ… liczbÄ™ transakcji, a ktÃ³re przez wyÅ¼sze rachunki.</div>
        <div class="chart-box tall"><canvas id="analytics-category-leader-chart"></canvas></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Trendy najwaÅ¼niejszych kategorii</div>
        <div class="hint">MiesiÄ™czne wydatki w kluczowych kategoriach objÄ™tych filtrem.</div>
        <div class="chart-box tall"><canvas id="analytics-category-trend-chart"></canvas></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 class="title">Macierz kategorii Ã— miesiÄ…c</h4>
        <p class="tiny">W kaÅ¼dej komÃ³rce znajdziesz sumÄ™, liczbÄ™ transakcji oraz Å›redniÄ… wartoÅ›Ä‡. Kolor wskazuje odchylenie od Å›redniej dla danej kategorii.</p>
        <div style="overflow-x:auto;">
          <table id="analytics-category-trends"></table>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="align-items:flex-end">
          <h4 class="title">Ranking kategorii (wybrane)</h4>
          <span class="tiny muted">Kliknij nagÅ‚Ã³wek, aby sortowaÄ‡ po dowolnym KPI.</span>
        </div>
        <div style="overflow-x:auto;">
          <table id="analytics-category-summary" class="table-sortable"></table>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 class="title">Zmiany miesiÄ…c do miesiÄ…ca</h4>
        <p class="tiny">Analiza czy wzrost wynika z liczby transakcji czy z ich wartoÅ›ci.</p>
        <div style="overflow-x:auto;">
          <table id="analytics-category-momentum" class="table-sortable"></table>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 class="title">PrzeglÄ…d miesiÄ™czny (wybrane kategorie)</h4>
        <div style="overflow-x:auto;">
          <table id="analytics-monthly-breakdown"></table>
        </div>
      </div>

      <div class="card" style="margin-top:12px; position: relative;">
        <div class="row">
          <h4 class="title">NajwiÄ™ksze Pojedyncze Wydatki</h4>
          <span class="tiny muted">Lista respektuje aktualne filtry kategorii.</span>
        </div>
        <p class="tiny">Twoje 10 najwiÄ™kszych transakcji w wybranym okresie. To dobre miejsce do szukania oszczÄ™dnoÅ›ci.</p>
        <table id="analytics-top-transactions"></table>
      </div>
    </section>

    <!-- MoM Comparison -->
    <section id="tab-mom" class="card" style="margin-top:12px;display:none">
      <div class="row" style="align-items:flex-start;justify-content:space-between;gap:12px">
        <div>
          <h3 class="title" style="margin-bottom:4px">PorÃ³wnanie miesiÄ…c do miesiÄ…ca</h3>
          <div class="muted" id="mom-info">Wybierz miesiÄ…ce, aby zobaczyÄ‡ zestawienie wydatkÃ³w.</div>
          <div class="mom-summary" id="mom-summary" style="display:none"></div>
        </div>
        <div class="mom-controls">
          <label class="mom-control">MiesiÄ…c A
            <select id="mom-month-a"></select>
          </label>
          <label class="mom-control">MiesiÄ…c B
            <select id="mom-month-b"></select>
          </label>
          <label class="mom-control">DzieÅ„ miesiÄ…ca
            <input type="number" id="mom-day-input" min="1" max="31" />
          </label>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="align-items:flex-end;justify-content:space-between">
          <h4 class="title">Tempo wydatkÃ³w</h4>
          <span class="tiny muted">Kliknij kategoriÄ™ z tabeli, aby zobaczyÄ‡ jej przebieg.</span>
        </div>
        <div class="chart-box wide">
          <canvas id="mom-chart"></canvas>
          <div class="chart-empty" id="mom-chart-empty" style="display:none">Brak danych do wyÅ›wietlenia.</div>
        </div>
        <p class="tiny muted" id="mom-chart-caption" style="margin-top:8px"></p>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="align-items:flex-end;justify-content:space-between">
          <h4 class="title">Dzienna rÃ³Å¼nica (A âˆ’ B)</h4>
          <span class="tiny muted">Czerwone sÅ‚upki oznaczajÄ… szybsze tempo w miesiÄ…cu A, zielone â€” wolniejsze.</span>
        </div>
        <div class="chart-box wide">
          <canvas id="mom-diff-chart"></canvas>
          <div class="chart-empty" id="mom-diff-empty" style="display:none">Brak danych do wyÅ›wietlenia.</div>
        </div>
        <p class="tiny muted" id="mom-diff-caption" style="margin-top:8px"></p>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="align-items:flex-end;justify-content:space-between">
          <h4 class="title">Zestawienie kategorii</h4>
          <span class="tiny muted">Kwoty obejmujÄ… wydatki do wybranego dnia.</span>
        </div>
        <div style="overflow-x:auto;">
          <table id="mom-table" class="table-compact">
            <thead>
              <tr>
                <th>Kategoria</th>
                <th id="mom-col-a">MiesiÄ…c A</th>
                <th id="mom-col-b">MiesiÄ…c B</th>
                <th>RÃ³Å¼nica</th>
                <th>Tempo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
        </main>
        <aside class="right-rail">
          <div class="kpi-compact" id="forecast-kpi">
            <span class="kpi-emoji">ğŸ”®</span>
            <div class="kpi-body">
              <span class="kpi-label">Prognozowane oszczÄ™dnoÅ›ci</span>
              <span class="kpi-value" id="forecast-content">0</span>
              <span class="tiny muted" id="forecast-note">Przy obecnym tempie wydatkÃ³w</span>
            </div>
          </div>
          <div class="kpi-compact" id="buffer-kpi">
            <span class="kpi-emoji">ğŸ’°</span>
            <div class="kpi-body">
              <span class="kpi-label">Zapas/dÅ‚ug na dziÅ›</span>
              <span class="kpi-value" id="buffer-content">0</span>
              <span class="tiny muted" id="buffer-note">Plan vs wydatki do dziÅ›</span>
            </div>
          </div>
          <div class="kpi-compact" id="mom-diff-kpi">
            <span class="kpi-emoji">ğŸ†š</span>
            <div class="kpi-body">
              <span class="kpi-label">MoM bez staÅ‚ych</span>
              <span class="kpi-value" id="dash-mom-diff">â€”</span>
              <span class="tiny muted" id="dash-mom-note">PorÃ³wnanie dostÄ™pne dla bieÅ¼Ä…cego miesiÄ…ca</span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">ğŸ’¸</span>
            <div class="kpi-body">
              <span class="kpi-label">PozostaÅ‚y budÅ¼et</span>
              <span class="kpi-value" id="dash-remaining">0</span>
              <span class="tiny muted">Na wydatki zmienne</span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">ğŸ“‰</span>
            <div class="kpi-body">
              <span class="kpi-label">Limit dzienny</span>
              <span class="kpi-value" id="dash-daily-budget">0</span>
              <span class="tiny muted">Trend: <span id="dash-daily-trend">â€”</span></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">ğŸ“…</span>
            <div class="kpi-body">
              <span class="kpi-label">Wydane dziÅ›</span>
              <span class="kpi-value" id="dash-today-spent">0</span>
              <span class="tiny muted">Status: <span id="dash-today-vs-budget">â€”</span></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">ğŸ“Š</span>
            <div class="kpi-body">
              <span class="kpi-label">Åšrednia dzienna</span>
              <span class="kpi-value" id="dash-avg-daily">0</span>
              <span class="tiny muted">PorÃ³wnanie: <span id="dash-avg-trend">â€”</span></span>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    (function activateSidebarLink() {
      const currentPage = document.body.dataset.page;
      if (!currentPage) return;
      document.querySelectorAll('.sidebar__link[data-page]').forEach((link) => {
        if (link.dataset.page === currentPage) {
          link.classList.add('sidebar__link--active');
          link.setAttribute('aria-current', 'page');
        } else {
          link.classList.remove('sidebar__link--active');
          link.removeAttribute('aria-current');
        }
      });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // --- Storage & helpers ------------------------------------------------------
  const STORAGE_KEY='lifeos_budget_v4';

  function monthKey(d=new Date()){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
  function ymAdd(ym,delta){const d=new Date(ym+'-01'); d.setMonth(d.getMonth()+delta); return monthKey(d)}
  
  function fmt(n, c = 'PLN') {
    try {
        const numValue = Number(n || 0);
        const parts = numValue.toFixed(2).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "\u00A0");
        return `${parts.join(',')}\u00A0${c}`;
    } catch {
        return `${Number(n || 0).toFixed(2)}\u00A0${c}`;
    }
  }

  function num(s){
    if(typeof s==='number') return s;
    if(!s) return 0;
    const raw = String(s).replace(/\s|\u00A0/g,'');
    let normalized = raw;
    if(raw.includes(',') && raw.includes('.')) normalized = raw.replace(/\./g,'').replace(',','.');
    else normalized = raw.replace(',','.');
    normalized = normalized.replace(/[^0-9.\-]/g,'');
    const n = Number(normalized);
    return Number.isFinite(n) ? n : 0;
  }
  function daysInYm(ym){const [y,m]=ym.split('-').map(Number); return new Date(y,m,0).getDate()}
  function dateFromYmDay(ym,day){const d=Math.min(Math.max(1,Number(day)||1), daysInYm(ym)); return `${ym}-${String(d).padStart(2,'0')}`}

  function load(){try{const raw=localStorage.getItem(STORAGE_KEY);return raw?JSON.parse(raw):null}catch{return null}}
  function save(s){localStorage.setItem(STORAGE_KEY,JSON.stringify(s))}

  // --- State Migration & Definition --------------------------------------------
  function migrateState(st){
    if(!st || !st.modules) st={modules:{}};
    if(!st.currency) st.currency = 'PLN';
    if(!st.modules.budget) st.modules.budget={};
    const bud=st.modules.budget;
    if(!Array.isArray(bud.categories)) bud.categories=[];
    bud.categories = bud.categories.map(c=>{
      const id = c?.id || ('cat_'+Math.random().toString(36).slice(2));
      const name = (c?.name || 'Bez nazwy').toString();
      let type = c?.type; if(!['expense','income','saving'].includes(type)) type='expense';
      return {emoji:c?.emoji||'', budget:num(c?.budget)||0, id, name, type};
    });
    if(bud.categories.length===0){
      bud.categories.push(
        {id:'c_inc',name:'Wynagrodzenie',type:'income'},
        {id:'c_save',name:'OszczÄ™dnoÅ›ci',type:'saving', emoji:'ğŸ¦'},
        {id:'c_fixed',name:'Wydatki staÅ‚e',type:'expense',emoji:'ğŸ’³'},
        {id:'c_food',name:'Jedzenie',type:'expense',emoji:'ğŸ•'},
        {id:'c_transport',name:'Transport',type:'expense',emoji:'ğŸšŒ'},
        {id:'c_misc',name:'RÃ³Å¼ne',type:'expense',emoji:'ğŸ›’'}
      );
    }
    const cf=bud.categories.find(c=>c.id==='c_fixed' || c.name==='Wydatki staÅ‚e');
    if(!cf) bud.categories.unshift({id:'c_fixed',name:'Wydatki staÅ‚e',type:'expense',emoji:'ğŸ’³'});
    else {cf.id='c_fixed'; cf.name='Wydatki staÅ‚e'; cf.type='expense'; cf.emoji=cf.emoji||'ğŸ’³'}

    if(!Array.isArray(bud.accounts)) bud.accounts=[{id:'a_main',name:'Konto gÅ‚Ã³wne'}];
    if(!Array.isArray(bud.quickActions)) bud.quickActions=[];
    if(typeof bud.workingMonth!=='string' || !/^\d{4}-\d{2}$/.test(bud.workingMonth)) bud.workingMonth=monthKey();
    if(!bud.monthly) bud.monthly={};
    if(!Array.isArray(bud.transactions)) bud.transactions=[];
    if(!Array.isArray(bud.eom)) bud.eom=[];
    if(!Array.isArray(bud.goals)) bud.goals=[];
    bud.goals = bud.goals.map(g => ({...g, startDate: g.startDate || new Date().toISOString().slice(0,10)}));
    if(!Array.isArray(bud.goalAllocations)) bud.goalAllocations=[];
    if(typeof bud.createTxOnFixedPay!=='boolean') bud.createTxOnFixedPay=true;
    if(!Array.isArray(bud.recurringTemplates)) bud.recurringTemplates=[];
    if(!Array.isArray(bud.recurringLog)) bud.recurringLog=[];
    // NEW: fixed expense templates
    if(!Array.isArray(bud.fixedTemplates)) bud.fixedTemplates=[];

    return st;
  }

  function def(){
    return migrateState({
      version:4, currency:'PLN',
      modules:{budget:{
        categories:[
          {id:'c_inc',name:'Wynagrodzenie',type:'income'},
          {id:'c_save',name:'OszczÄ™dnoÅ›ci',type:'saving', emoji:'ğŸ¦'},
          {id:'c_fixed',name:'Wydatki staÅ‚e',type:'expense',emoji:'ğŸ’³'},
          {id:'c_food',name:'Jedzenie',type:'expense',emoji:'ğŸ•'},
          {id:'c_transport',name:'Transport',type:'expense',emoji:'ğŸšŒ'},
          {id:'c_misc',name:'RÃ³Å¼ne',type:'expense',emoji:'ğŸ›’'}
        ],
        accounts:[{id:'a_main',name:'Konto gÅ‚Ã³wne'},{id:'a_sav',name:'OszczÄ™dnoÅ›ci'}],
        quickActions:[],
        monthly:{},transactions:[],eom:[],goals:[],goalAllocations:[],
        workingMonth:monthKey(),
        createTxOnFixedPay:true,
        recurringTemplates:[],recurringLog:[],
        fixedTemplates:[]
      }}
    });
  }

  let state = migrateState(load()) || def();
  const b=()=>state.modules.budget;

  // --- Core Helpers ----------------------------------------------------------------
  function ensureMonth(ym){if(!b().monthly[ym]) b().monthly[ym]={ incomes:[], fixed:[] }}
  function setDefaultDate(){const i=document.querySelector('#var-form input[name="date"]'); if(i && !i.value){i.value=new Date().toISOString().slice(0,10)}}
  const catsById=()=>Object.fromEntries((b().categories||[]).map(c=>[c.id,c]));
  function catType(id){const c=catsById()[id];return c?c.type:undefined}
  function signFor(catId, amt){const t=catType(catId); return t==='expense'?-Math.abs(amt):Math.abs(amt)}
  function txTotalSigned(tx){
    if(tx.splits?.length){return tx.splits.reduce((s,sp)=>s+signFor(sp.categoryId,num(sp.amount)),0)}
    return num(tx.amount)
  }
  function entriesForMonth(ym){
    const out=[];
    for(const t of (b().transactions||[])){
      if(!String(t.date||'').startsWith(ym)) continue;
      if(t.splits?.length){
        for(const s of t.splits){
          out.push({date:t.date,categoryId:s.categoryId,accountId:t.accountId,amount:signFor(s.categoryId,num(s.amount)),parentId:t.id,note:t.note});
        }
      }else{
        out.push({date:t.date,categoryId:t.categoryId,accountId:t.accountId,amount:num(t.amount),parentId:t.id,note:t.note});
      }
    }
    return out;
  }

  // --- UI glue ----------------------------------------------------------------
  function bindMoneyInputs(root=document){
    root.querySelectorAll('input[inputmode="decimal"]').forEach(inp=>{
      if(inp.dataset.moneyBound) return;
      inp.dataset.moneyBound='1';
      inp.addEventListener('input', e=>{e.target.value=e.target.value.replace(/\u00A0/g,' ').replace(/[^\d.,\-\s]/g,'')});
      inp.addEventListener('blur', e=>{const v=num(e.target.value); e.target.value=v===0?'':String(v).replace('.',',')});
    });
  }
  const tabs=document.querySelectorAll('.tab');
  const sections={dashboard:tab('dashboard'),overview:tab('overview'),incomes:tab('incomes'),fixed:tab('fixed'),variable:tab('variable'),categories:tab('categories'),eom:tab('eom'),goals:tab('goals'),analytics:tab('analytics'),mom:tab('mom')};
  const varCard=document.getElementById('var-transactions-card');
  const varSlots={dashboard:document.getElementById('var-table-dashboard-slot'),variable:document.getElementById('var-table-variable-slot')};
  function placeVarCard(target){
    if(!varCard) return;
    const slot=varSlots[target];
    if(slot && varCard.parentElement!==slot){
      slot.appendChild(varCard);
    }
  }
  placeVarCard('dashboard');
  function tab(id){return document.getElementById('tab-'+id)}
  for(const t of tabs){
    t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      Object.values(sections).forEach(s=>s.style.display='none'); sections[t.dataset.tab].style.display='block';
      if(t.dataset.tab==='variable'){placeVarCard('variable'); setDefaultDate()}
      else if(t.dataset.tab==='dashboard'){placeVarCard('dashboard')}
      if(t.dataset.tab==='analytics') renderAnalytics(); // Render analytics when tab is clicked
      if(t.dataset.tab==='eom') renderEOMHistory(); // Render history when tab is clicked
      if(t.dataset.tab==='mom') renderMomComparison();
      bindMoneyInputs();
    });
  }
  document.getElementById('prevMonthBtn').onclick=()=>{b().workingMonth=ymAdd(b().workingMonth,-1);save(state);renderAll()};
  document.getElementById('nextMonthBtn').onclick=()=>{b().workingMonth=ymAdd(b().workingMonth,1);save(state);renderAll()};
  document.getElementById('exportBtn').onclick=()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`budzet_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove()},0);
  };
  document.getElementById('importBtn').onclick=()=>document.getElementById('importFile').click();
  document.getElementById('importFile').addEventListener('change', async (e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    try{
      const text=await file.text(); const json=JSON.parse(text);
      const migrated=migrateState(json);
      if(!migrated?.modules?.budget){alert('Plik nie wyglÄ…da na poprawny eksport.'); return;}
      if(!confirm('Czy na pewno chcesz nadpisaÄ‡ obecne dane danymi z pliku?')) return;
      state=migrated; save(state); location.reload();
    }catch(err){console.error(err); alert('BÅ‚Ä…d podczas importu pliku.')}
  });

  // --- Quick actions ----------------------------------------------------------
  function renderQuickActions(){
    const grid=document.getElementById('qa-grid'); grid.innerHTML='';
    for(const qa of (b().quickActions||[])){
      const cat=catsById()[qa.categoryId];
      const btn=document.createElement('div'); btn.className='quick-btn';
      btn.innerHTML=`<div>${qa.emoji||'âš¡'} ${qa.label}</div><div class="muted">${cat?.type==='expense'?'Wydatek': cat?.type==='saving'?'OszczÄ™dnoÅ›Ä‡':'WpÅ‚yw'}</div>`;
      btn.onclick=()=>quickActionRun(qa.id); grid.appendChild(btn);
    }
    fillQaEditorSelects(); renderQuickActionsEditorRows();
  }
  function quickActionRun(id){
    const qa=(b().quickActions||[]).find(x=>x.id===id); if(!qa){alert('Nie znaleziono akcji');return;}
    const amtStr=prompt('Podaj kwotÄ™:', qa.defaultAmount ?? ''); if(amtStr===null) return;
    const amountRaw=num(amtStr);
    const note=prompt('Notatka (opcjonalnie):', qa.defaultNote ?? '')||'';
    const signed = signFor(qa.categoryId, amountRaw);
    const date=new Date().toISOString().slice(0,10);
    b().transactions.unshift({id:`tx_${Math.random().toString(36).slice(2)}`,date,amount:signed,categoryId:qa.categoryId,accountId:qa.accountId||b().accounts[0]?.id||'a_main',note});
    save(state); renderAll();
  }
  function fillQaEditorSelects(){
    const editor=document.getElementById('qa-editor');
    const catSel=editor.querySelector('select[name="categoryId"]'); if(catSel){catSel.innerHTML=''; for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}}
    const accSel=editor.querySelector('select[name="accountId"]'); if(accSel){accSel.innerHTML=''; for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id))}}
  }
  document.getElementById('qa-edit-toggle').onclick=()=>{const ed=document.getElementById('qa-editor'); ed.style.display = ed.style.display==='none' ? 'block' : 'none';};
  document.getElementById('qa-add-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const qa={id:'qa_'+Math.random().toString(36).slice(2),label:String(f.get('label')||''),emoji:String(f.get('emoji')||''),categoryId:String(f.get('categoryId')),accountId:String(f.get('accountId')),defaultAmount:String(f.get('defaultAmount')||''),defaultNote:String(f.get('defaultNote')||'')};
    b().quickActions.push(qa); save(state); e.target.reset(); renderQuickActions(); bindMoneyInputs(document.getElementById('qa-editor'));
  }
  function renderQuickActionsEditorRows(){
    const tbody=document.getElementById('qa-rows'); tbody.innerHTML='';
    for(const qa of (b().quickActions||[])){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input value="${qa.emoji||''}" data-k="emoji" /></td>
        <td><input value="${qa.label||''}" data-k="label" /></td>
        <td><select data-k="categoryId"></select></td>
        <td><select data-k="accountId"></select></td>
        <td><input inputmode="decimal" value="${qa.defaultAmount||''}" data-k="defaultAmount" /></td>
        <td><input value="${qa.defaultNote||''}" data-k="defaultNote" /></td>
        <td class="row" style="gap:6px">
          <button class="btn soft" data-act="save">Zapisz</button>
          <button class="btn danger" data-act="del">X</button>
        </td>`;
      const catSel=tr.querySelector('select[data-k="categoryId"]');
      const accSel=tr.querySelector('select[data-k="accountId"]');
      for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id, false, c.id===qa.categoryId))}
      for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id, false, a.id===qa.accountId))}
      tr.querySelector('[data-act="save"]').onclick=()=>{
        qa.emoji=tr.querySelector('[data-k="emoji"]').value;
        qa.label=tr.querySelector('[data-k="label"]').value;
        qa.categoryId=tr.querySelector('[data-k="categoryId"]').value;
        qa.accountId=tr.querySelector('[data-k="accountId"]').value;
        qa.defaultAmount=tr.querySelector('[data-k="defaultAmount"]').value;
        qa.defaultNote=tr.querySelector('[data-k="defaultNote"]').value;
        save(state); renderQuickActions();
      };
      tr.querySelector('[data-act="del"]').onclick=()=>{ if(!confirm('UsunÄ…Ä‡ szybkÄ… akcjÄ™?')) return; b().quickActions=b().quickActions.filter(x=>x.id!==qa.id); save(state); renderQuickActions(); };
      tbody.appendChild(tr);
    }
    bindMoneyInputs(document.getElementById('qa-editor'));
  }
  
  // --- NEW: Fixed Expenses Templates & Suggestions ---------------------------------
  function fixedExistsForTpl(ym, tplId){ensureMonth(ym); return b().monthly[ym].fixed.some(f=>f.tplId===tplId)}

  function applyFixedTemplate(tpl, ym){
    ensureMonth(ym);
    if(fixedExistsForTpl(ym, tpl.id)) return;
    b().monthly[ym].fixed.push({
      id:`fix_${Math.random().toString(36).slice(2)}`,
      tplId: tpl.id, title: tpl.title, amount: num(tpl.amount),
      due: dateFromYmDay(ym, tpl.day), paid:false, categoryId:'c_fixed'
    });
  }

  function renderFixedSuggestions(){
    const ym=b().workingMonth;
    const box=document.getElementById('fix-suggestions-box');
    const list=document.getElementById('fix-suggestions-list');
    
    const candidates=(b().fixedTemplates||[]).filter(t=>!fixedExistsForTpl(ym,t.id));
    if(candidates.length === 0) {
      box.style.display='none';
      return;
    }

    box.style.display='block'; list.innerHTML='';
    for(const t of candidates){
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="row">
          <div><b>${t.title}</b> <span class="muted">(dzieÅ„ ${t.day})</span></div>
          <b>${fmt(num(t.amount),state.currency)}</b>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="hint">Termin w tym miesiÄ…cu: ${dateFromYmDay(ym,t.day)}</div>
          <button class="btn soft" data-act="add">Dodaj</button>
        </div>`;
      card.querySelector('[data-act="add"]').onclick=()=>{applyFixedTemplate(t,ym); save(state); renderAll()};
      list.appendChild(card);
    }
    document.getElementById('fix-apply-all-btn').onclick=()=>{
      for(const t of candidates) applyFixedTemplate(t,ym);
      save(state); renderAll();
    };
  }
  
  function renderFixedTemplatesManager(){
    const form = document.getElementById('fix-template-form');
    form.onsubmit = e => {
      e.preventDefault();
      const f = new FormData(form);
      const tpl = {
        id:'ftpl_'+Math.random().toString(36).slice(2),
        title: String(f.get('title')||'').trim(),
        amount: num(f.get('amount')),
        day: Number(f.get('day'))
      };
      if(!tpl.title || !tpl.amount || !tpl.day) {alert('UzupeÅ‚nij wszystkie pola szablonu.'); return;}
      b().fixedTemplates.push(tpl);
      save(state); form.reset(); renderFixedTemplatesManager(); renderFixedSuggestions();
    }

    const tbody = document.getElementById('fix-templates-tbody'); tbody.innerHTML = '';
    for(const t of (b().fixedTemplates||[])) {
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${t.title}</td>
        <td>${fmt(num(t.amount),state.currency)}</td>
        <td>${t.day}</td>
        <td><button class="btn danger" data-act="del">UsuÅ„</button></td>`;
      tr.querySelector('[data-act="del"]').onclick=()=>{
        if(!confirm(`Czy na pewno usunÄ…Ä‡ szablon "${t.title}"?`)) return;
        b().fixedTemplates = b().fixedTemplates.filter(x => x.id !== t.id);
        save(state); renderFixedTemplatesManager(); renderFixedSuggestions();
      };
      tbody.appendChild(tr);
    }
    bindMoneyInputs(form);
  }

  // --- Daily calculations (spending + savings) --------------------------------
  function getDailySpending(ym){
    const daily={};
    const entries=entriesForMonth(ym);
    for(const e of entries){
      const c=catsById()[e.categoryId];
      if(!c || !((c.type==='expense' && c.id!=='c_fixed') || c.type==='saving')) continue;
      const day=parseInt(e.date.slice(-2));
      daily[day]=(daily[day]||0)+Math.abs(e.amount);
    }
    return daily;
  }
  function getDaysRemaining(ym){
    const today=new Date(); const currentYm=monthKey(today);
    if(ym < currentYm) return 0; // Past month
    if(ym > currentYm) return daysInYm(ym); // Future month
    // Current month
    const daysInMonth = daysInYm(ym);
    return Math.max(0, daysInMonth - today.getDate());
  }

  // --- Dashboard --------------------------------------------------------------
  function renderDashboard(){
    const ym=b().workingMonth; ensureMonth(ym);
    const incSum=b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
    const fixSum=b().monthly[ym].fixed.reduce((s,x)=>s+num(x.amount),0);
    const days=daysInYm(ym);
    const dailyBudget=Math.max(0,(incSum-fixSum)/days);

      const entries=entriesForMonth(ym);
      const cb=catsById();
    
    const variableSpent = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return (c?.type === 'expense' && c.id !== 'c_fixed') ? s + Math.abs(e.amount) : s;
    }, 0);
    const savingsTransfers = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return c?.type === 'saving' ? s + Math.abs(e.amount) : s;
    }, 0);
    const remain = incSum - fixSum - variableSpent - savingsTransfers;

    document.getElementById('dash-remaining').textContent=fmt(remain, state.currency);
    document.getElementById('dash-daily-budget').textContent=fmt(dailyBudget, state.currency);

    const todayKey=new Date().toISOString().slice(0,10);
    const todaySpent=entries.filter(e=>e.date===todayKey).reduce((s,e)=>{
      const c=cb[e.categoryId];
      return (!c || !((c.type==='expense' && c.id!=='c_fixed') || c.type==='saving')) ? s : s + Math.abs(e.amount);
    },0);
    document.getElementById('dash-today-spent').textContent=fmt(todaySpent, state.currency);
    document.getElementById('dash-today-vs-budget').textContent = todaySpent<=dailyBudget ? 'âœ… w limicie dziennym' : 'âš ï¸ powyÅ¼ej limitu';

    const daysElapsed = (ym === monthKey()) ? new Date().getDate() : (monthKey() > ym ? days : 0);
    const daily=getDailySpending(ym);
    const spentSoFar=Object.values(daily).reduce((a,b)=>a+b,0);
    const avgDaily = (daysElapsed > 0 ? (spentSoFar / daysElapsed) : 0);
    document.getElementById('dash-avg-daily').textContent=fmt(avgDaily, state.currency);
    document.getElementById('dash-avg-trend').textContent = avgDaily <= dailyBudget ? 'ğŸ‘ poniÅ¼ej planu' : 'ğŸ‘ powyÅ¼ej planu';

    // Heatmap
    const cal=document.getElementById('daily-spending-calendar'); cal.innerHTML='';
    for(let d=1; d<=days; d++){
      const val=daily[d]||0;
      const box=document.createElement('div');
      let bg='#edf2f7'; // default for no spending
      if (val > 0) bg = '#dcfce7'; // in budget
      if(val>dailyBudget*1.2) bg='#fee2e2'; else if(val>dailyBudget) bg='#ffedd5';
      box.className='heat-day'; box.style.background=bg; box.title=`${String(d).padStart(2,'0')}: ${fmt(val, state.currency)}`; box.textContent=String(d);
      cal.appendChild(box);
    }

    renderRecentSpendingTiles();

    // --- Forecast & Buffer Section (NEW) ---
    const daysLeft = getDaysRemaining(ym);
    const totalVariableBudget = incSum - fixSum;
    const projectedTotalVariableOutflow = spentSoFar + (daysLeft * avgDaily);
    const forecastedSavings = totalVariableBudget - projectedTotalVariableOutflow;
    
    const forecastEl = document.getElementById('forecast-content');
    const forecastNote = document.getElementById('forecast-note');
    forecastEl.textContent = fmt(forecastedSavings, state.currency);
    forecastEl.classList.remove('ok', 'bad');
    forecastEl.classList.add(forecastedSavings >= 0 ? 'ok' : 'bad');
    forecastNote.textContent = forecastedSavings >= 0
      ? 'MoÅ¼liwa nadwyÅ¼ka przy obecnym tempie'
      : 'Ryzyko przekroczenia budÅ¼etu zmiennego';

    const bufferEl = document.getElementById('buffer-content');
    const bufferNote = document.getElementById('buffer-note');
    bufferEl.classList.remove('ok', 'bad');
    if (ym === monthKey() && daysElapsed > 0 && daysElapsed <= days) {
      const dayOfMonth = new Date().getDate();
      const allowedToSpendUntilToday = dailyBudget * dayOfMonth;
      const spentUntilToday = Object.entries(daily)
        .filter(([day]) => parseInt(day) <= dayOfMonth)
        .reduce((sum, [, amount]) => sum + amount, 0);
      const buffer = allowedToSpendUntilToday - spentUntilToday;
      bufferEl.textContent = fmt(buffer, state.currency);
      bufferEl.classList.add(buffer >= 0 ? 'ok' : 'bad');
      bufferNote.textContent = `Plan: ${fmt(allowedToSpendUntilToday, state.currency)} | Wydano: ${fmt(spentUntilToday, state.currency)}`;
    } else {
      bufferEl.textContent = 'â€”';
      bufferNote.textContent = 'DostÄ™pne tylko dla bieÅ¼Ä…cego miesiÄ…ca';
    }

    const momDiffValueEl = document.getElementById('dash-mom-diff');
    const momDiffNoteEl = document.getElementById('dash-mom-note');
    if (momDiffValueEl && momDiffNoteEl) {
      momDiffValueEl.classList.remove('ok', 'bad');
      if (ym === monthKey() && daysElapsed > 0 && daysElapsed <= days) {
        const today = new Date();
        const dayOfMonth = today.getDate();
        const currentDayLimit = Math.min(dayOfMonth, days);
        const prevYm = ymAdd(ym, -1);
        const prevDayLimit = Math.min(currentDayLimit, daysInYm(prevYm));
        const sumVariableToDay = (targetYm, limit) => {
          if (!limit) return 0;
          return entriesForMonth(targetYm).reduce((acc, entry) => {
            const cat = cb[entry.categoryId];
            if (!cat || cat.type !== 'expense' || cat.id === 'c_fixed') return acc;
            const day = Number(entry.date.slice(8, 10));
            if (!Number.isFinite(day) || day > limit) return acc;
            return acc + Math.abs(entry.amount);
          }, 0);
        };
        const currentSpent = sumVariableToDay(ym, currentDayLimit);
        const previousSpent = sumVariableToDay(prevYm, prevDayLimit);
        const diff = currentSpent - previousSpent;
        const diffFormatted = fmt(diff, state.currency);
        momDiffValueEl.textContent = diff > 0 ? `+${diffFormatted}` : diffFormatted;
        if (diff > 0) {
          momDiffValueEl.classList.add('bad');
        } else if (diff < 0) {
          momDiffValueEl.classList.add('ok');
        }
        const currentDayLabel = String(currentDayLimit).padStart(2, '0');
        const prevDayLabel = String(prevDayLimit).padStart(2, '0');
        const dayNote = prevDayLimit === currentDayLimit ? currentDayLabel : `${currentDayLabel} / ${prevDayLabel}`;
        momDiffNoteEl.textContent = `${ym}: ${fmt(currentSpent, state.currency)} | ${prevYm}: ${fmt(previousSpent, state.currency)} (do dnia ${dayNote})`;
      } else {
        momDiffValueEl.textContent = 'â€”';
        momDiffNoteEl.textContent = 'DostÄ™pne tylko dla bieÅ¼Ä…cego miesiÄ…ca';
      }
    }

    renderDashboardCharts(ym, dailyBudget, avgDaily);
    renderQuickActions();
  }

  function currencyTicks(v) {
    try {
        const numValue = Math.round(Number(v || 0));
        const integerPart = String(numValue).replace(/\B(?=(\d{3})+(?!\d))/g, "\u00A0");
        return `${integerPart}\u00A0${state.currency || 'PLN'}`;
    } catch {
        return `${Math.round(Number(v || 0))}\u00A0${state.currency || 'PLN'}`;
    }
  }

  function renderRecentSpendingTiles(){
    const container=document.getElementById('recent-spending-calendar');
    if(!container) return;
    container.innerHTML='';
    const totalChip=document.getElementById('recent-seven-total');
    const today=new Date();
    today.setHours(0,0,0,0);
    const dayKeyFromDate=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const dayDates=[];
    for(let offset=6; offset>=0; offset--){
      const d=new Date(today);
      d.setDate(today.getDate()-offset);
      dayDates.push(d);
    }
    const months=[...new Set(dayDates.map(d=>monthKey(d)))];
    let allEntries=[];
    for(const ym of months){
      allEntries=allEntries.concat(entriesForMonth(ym));
    }
    const cb=catsById();
    const accountsById=Object.fromEntries((b().accounts||[]).map(acc=>[acc.id,acc]));
    const startKey=dayKeyFromDate(dayDates[0]);
    const endKey=dayKeyFromDate(dayDates[dayDates.length-1]);
    const filteredBase=[];
    for(const entry of allEntries){
      if(entry.date<startKey || entry.date>endKey) continue;
      const cat=cb[entry.categoryId];
      if(!cat || cat.type!=='expense' || cat.id==='c_fixed') continue;
      const amount=Math.abs(entry.amount);
      if(amount<=0) continue;
      filteredBase.push({entry, amount, cat});
    }
    const filtered=filteredBase.map((item, idx)=>({...item, idx}));
    const totalAmount=filtered.reduce((sum,item)=>sum+item.amount,0);
    if(totalChip){
      totalChip.textContent=filtered.length?`ÅÄ…cznie: ${fmt(totalAmount, state.currency)}`:'ÅÄ…cznie: â€”';
    }
    const topIdx=new Set(filtered.slice().sort((a,b)=>b.amount-a.amount).slice(0,5).map(item=>item.idx));
    const grouped=new Map();
    for(const item of filtered){
      if(!grouped.has(item.entry.date)) grouped.set(item.entry.date, []);
      grouped.get(item.entry.date).push(item);
    }
    const weekdayFmt=new Intl.DateTimeFormat('pl-PL',{weekday:'short'});
    const dateFmt=new Intl.DateTimeFormat('pl-PL',{day:'2-digit',month:'2-digit'});
    const tooltipDateFmt=new Intl.DateTimeFormat('pl-PL',{year:'numeric',month:'short',day:'2-digit'});
    for(const dateObj of dayDates){
      const key=dayKeyFromDate(dateObj);
      const tile=document.createElement('div');
      tile.className='recent-day';
      const header=document.createElement('div');
      header.className='recent-day-header';
      const weekdayEl=document.createElement('span');
      weekdayEl.className='recent-day-weekday';
      weekdayEl.textContent=weekdayFmt.format(dateObj).replace('.', '').toUpperCase();
      const dateEl=document.createElement('span');
      dateEl.className='recent-day-date';
      dateEl.textContent=dateFmt.format(dateObj);
      header.append(weekdayEl, dateEl);
      tile.appendChild(header);
      const dayItems=(grouped.get(key)||[]).sort((a,b)=>b.amount-a.amount);
      const dayTotal=dayItems.reduce((sum,item)=>sum+item.amount,0);
      const total=document.createElement('div');
      total.className='recent-day-total';
      const totalIcon=document.createElement('span');
      totalIcon.setAttribute('aria-hidden','true');
      totalIcon.textContent='ğŸ’°';
      total.append(totalIcon, document.createTextNode(dayItems.length?fmt(dayTotal, state.currency):'â€”'));
      if(dayItems.length===0){
        tile.classList.add('recent-day-empty');
      }
      tile.appendChild(total);
      const body=document.createElement('div');
      body.className='recent-day-body';
      if(dayItems.length===0){
        const empty=document.createElement('div');
        empty.className='recent-empty';
        empty.textContent='brak ruchu';
        body.appendChild(empty);
      }else{
        const maxVisible=2;
        const extraRows=[];
        dayItems.forEach((item, idx)=>{
          const row=document.createElement('div');
          row.className='recent-entry';
          if(topIdx.has(item.idx)) row.classList.add('top-spend');
          if(idx>=maxVisible){
            row.classList.add('recent-entry-hidden');
            extraRows.push(row);
          }
          const emoji=item.cat?.emoji||'ğŸ’¸';
          const emojiEl=document.createElement('span');
          emojiEl.className='recent-entry-emoji';
          emojiEl.textContent=emoji;
          const textWrap=document.createElement('div');
          textWrap.className='recent-entry-text';
          const amountEl=document.createElement('span');
          amountEl.className='recent-entry-amount';
          amountEl.textContent=fmt(item.amount, state.currency);
          textWrap.appendChild(amountEl);
          const noteText=(item.entry.note||'').trim();
          if(noteText){
            const noteEl=document.createElement('span');
            noteEl.className='recent-entry-note';
            noteEl.textContent=noteText;
            textWrap.appendChild(noteEl);
          }
          const [yy,mm,dd]=item.entry.date.split('-').map(Number);
          const entryDate=new Date(yy, (mm||1)-1, dd||1);
          const tooltipParts=[
            [emoji, item.cat?.name||'Wydatek'].filter(Boolean).join(' '),
            `Kwota: ${fmt(item.amount, state.currency)}`,
            `Data: ${tooltipDateFmt.format(entryDate)}`,
            `Konto: ${accountsById[item.entry.accountId]?.name||'â€”'}`
          ];
          if(item.entry.note){
            tooltipParts.push(`Notatka: ${item.entry.note}`);
          }
          row.title=tooltipParts.join('\n');
          row.setAttribute('aria-label', tooltipParts.join(', '));
          row.append(emojiEl, textWrap);
          body.appendChild(row);
        });
        if(extraRows.length){
          const collapsedLabel=`+${extraRows.length}`;
          const toggle=document.createElement('button');
          toggle.type='button';
          toggle.className='recent-more';
          toggle.textContent=collapsedLabel;
          toggle.title='PokaÅ¼ wiÄ™cej wydatkÃ³w';
          toggle.setAttribute('aria-expanded','false');
          toggle.addEventListener('click',()=>{
            const expanded=tile.classList.toggle('expanded');
            extraRows.forEach(row=>row.classList.toggle('recent-entry-hidden', !expanded));
            toggle.textContent=expanded?'âˆ’':collapsedLabel;
            toggle.setAttribute('aria-expanded', expanded?'true':'false');
          });
          body.appendChild(toggle);
        }
      }
      tile.appendChild(body);
      container.appendChild(tile);
    }
  }

  function renderDashboardCharts(ym, dailyBudget, avgDaily) {
    const dailyCtx=document.getElementById('dailyLine').getContext('2d');
    const cumCtx=document.getElementById('cumulativeLine').getContext('2d');
    if(window.dashDaily) window.dashDaily.destroy();
    if(window.dashCum) window.dashCum.destroy();
    
    const daysInMonth=daysInYm(ym);
    const dailySpending=getDailySpending(ym);
    const labels=[]; const spendData=[]; const cumSpend=[]; const cumAllowed=[];
    let runningTotal=0;
    
    for(let d=1; d<=daysInMonth; d++){
      labels.push(d.toString());
      const dailyS=dailySpending[d]||0; 
      spendData.push(dailyS); 
      runningTotal+=dailyS; 
      cumSpend.push(runningTotal); 
      cumAllowed.push(d*dailyBudget);
    }
    
    const backgroundColors = [];
    const borderColors = [];
    for(const spending of spendData) {
        let color;
        if (spending === 0) {
            color = 'rgba(100, 116, 139, 0.5)'; // Muted
        } else if (spending > dailyBudget * 1.2) {
            color = 'rgba(190, 18, 60, 0.7)'; // Red
        } else if (spending > dailyBudget) {
            color = 'rgba(234, 88, 12, 0.7)'; // Orange
        } else {
            color = 'rgba(5, 150, 105, 0.7)'; // Green
        }
        backgroundColors.push(color);
        borderColors.push(color.replace(/0\.\d+\)/, '1)'));
    }
    const entries = entriesForMonth(ym);
    const cb = catsById();

    window.dashDaily = new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'Wydatki dzienne',
                    data: spendData,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                    order: 3
                },
                {
                    type: 'line',
                    label: 'Limit dzienny',
                    data: Array(daysInMonth).fill(dailyBudget),
                    borderColor: 'rgba(190, 18, 60, 0.7)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [6, 6],
                    tension: 0.1,
                    order: 1
                },
                {
                    type: 'line',
                    label: 'Åšrednia dzienna',
                    data: Array(daysInMonth).fill(avgDaily),
                    borderColor: 'rgba(234, 88, 12, 0.7)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    order: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: currencyTicks }
                },
                x: {
                    grid: { display: false }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${fmt(context.raw, state.currency)}`;
                        },
                        afterBody: function(tooltipItems) {
                            const dataIndex = tooltipItems[0].dataIndex;
                            const day = dataIndex + 1;
                            const dayString = `${ym}-${String(day).padStart(2, '0')}`;

                            const dayExpenses = entries
                                .filter(e => {
                                    const cat = cb[e.categoryId];
                                    return e.date === dayString && cat && (cat.type === 'expense' || cat.type === 'saving') && cat.id !== 'c_fixed';
                                })
                                .sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount));
                            
                            if (dayExpenses.length === 0) {
                                return [];
                            }

                            const top3 = dayExpenses.slice(0, 3);
                            const lines = top3.map(e => {
                                const cat = cb[e.categoryId];
                                return `  ${cat.emoji||'ğŸ’¸'} ${cat.name.slice(0,15)}: ${fmt(Math.abs(e.amount), '')}`;
                            });
                            
                            lines.unshift('');
                            lines.unshift('NajwiÄ™ksze wydatki:');
                            return lines;
                        }
                    }
                }
            }
        }
    });

    window.dashCum=new Chart(cumCtx,{type:'line',data:{labels,datasets:[{label:'Skumulowane wydatki',data:cumSpend,borderColor:'#be123c',backgroundColor:'rgba(190,18,60,0.08)',tension:0.3,fill:true},{label:'Skumulowany limit',data:cumAllowed,borderColor:'#059669',backgroundColor:'rgba(5,150,105,0.08)',tension:0.3,fill:true}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:currencyTicks}}}}});
  }

  // --- Overview ---------------------------------------------------------------
  function renderOverview(){
    const ym=b().workingMonth; ensureMonth(ym);
    document.getElementById('ov-month').textContent=ym;
    const cb=catsById();
    
    const incomes = b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
    
    const fixedAll = b().monthly[ym].fixed;
    const fixedPlanned = fixedAll.reduce((s,x)=>s+num(x.amount),0);
    const fixedPaid = fixedAll.filter(f => f.paid).reduce((s,x)=>s+num(x.amount),0);
    const fixedUnpaid = fixedPlanned - fixedPaid;

    const entries = entriesForMonth(ym);
    const varSpent = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return (c?.type === 'expense' && c.id !== 'c_fixed') ? s + Math.abs(e.amount) : s;
    }, 0);
    const savingsTransfers = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return c?.type === 'saving' ? s + Math.abs(e.amount) : s;
    }, 0);

    const remainingVariableBudget = incomes - fixedPlanned - varSpent - savingsTransfers;

    const days = daysInYm(ym);
    const daysElapsed = (ym === monthKey()) ? new Date().getDate() : (monthKey() > ym ? days : 0);
    const dailySpending = getDailySpending(ym);
    const spentSoFar = Object.values(dailySpending).reduce((a,b)=>a+b,0);
    const avgDaily = (daysElapsed > 0 ? (spentSoFar / daysElapsed) : 0);
    const daysLeft = getDaysRemaining(ym);
    const projectedTotalVariableOutflow = spentSoFar + (daysLeft * avgDaily);
    const forecastedSavings = (incomes - fixedPlanned) - projectedTotalVariableOutflow;
    const savingsRate = incomes > 0 ? (forecastedSavings / incomes) * 100 : 0;
    
    document.getElementById('ov-inc').textContent = fmt(incomes, state.currency);
    document.getElementById('ov-fixed-planned').textContent = fmt(fixedPlanned, state.currency);
    document.getElementById('ov-fixed-paid').textContent = fmt(fixedPaid, state.currency);
    document.getElementById('ov-fixed-unpaid').textContent = fmt(fixedUnpaid, state.currency);
    document.getElementById('ov-var-spent').textContent = fmt(varSpent, state.currency);
    document.getElementById('ov-savings').textContent = fmt(savingsTransfers, state.currency);
    document.getElementById('ov-remaining').textContent = fmt(remainingVariableBudget, state.currency);
    document.getElementById('stat-savings-rate').textContent = savingsRate.toFixed(0)+'%';
  }

  // --- Forms ------------------------------------------------------------------
  document.getElementById('inc-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target); const ym=b().workingMonth; ensureMonth(ym);
    b().monthly[ym].incomes.push({id:`inc_${Math.random().toString(36).slice(2)}`,amount:num(f.get('amount')),note:String(f.get('note')||'')});
    save(state); e.target.reset(); renderAll();
  };

  const fixForm=document.getElementById('fix-form');
  fixForm.onsubmit=(e)=>{e.preventDefault(); const f=new FormData(fixForm); const ym=b().workingMonth; ensureMonth(ym);
    b().monthly[ym].fixed.push({id:`fix_${Math.random().toString(36).slice(2)}`,title:String(f.get('title')),amount:num(f.get('amount')),due:f.get('due')||null,paid:false,categoryId:'c_fixed'});
    save(state); fixForm.reset(); renderAll()
  };
  document.getElementById('autoTx').onchange=(e)=>{b().createTxOnFixedPay=e.target.checked; save(state)};

  const varForm=document.getElementById('var-form');
  varForm.onsubmit=(e)=>{e.preventDefault(); const f=new FormData(varForm);
    const date=String(f.get('date')||new Date().toISOString().slice(0,10));
    const amount=num(f.get('amount')); const categoryId=String(f.get('categoryId')); const accountId=String(f.get('accountId')); const note=String(f.get('note')||'');
    const signed= signFor(categoryId, amount);
    b().transactions.unshift({id:`tx_${Math.random().toString(36).slice(2)}`,date,amount:signed,categoryId,accountId,note});
    save(state); varForm.reset(); setDefaultDate(); renderAll()
  };

  document.getElementById('cat-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const c={id:`cat_${Math.random().toString(36).slice(2)}`,name:String(f.get('name')),type:String(f.get('type')),emoji:String(f.get('emoji')||''),budget:num(f.get('budget'))||0};
    b().categories.push(c);
    save(state); e.target.reset(); renderAll();
  };

  document.getElementById('goal-form').onsubmit=(e)=>{e.preventDefault(); const f=new FormData(e.target);
    const startDate = String(f.get('startdate') || new Date().toISOString().slice(0,10));
    b().goals.push({id:`goal_${Math.random().toString(36).slice(2)}`,name:String(f.get('name')),target:num(f.get('target')),deadline:String(f.get('deadline')||'')||undefined, startDate});
    save(state); e.target.reset(); renderGoals()
  };
  
  const allocForm = document.getElementById('alloc-form');
  const allocCancelBtn = document.getElementById('alloc-cancel-btn');

  allocForm.onsubmit = (e) => {
    e.preventDefault();
    const f = new FormData(allocForm);
    const allocId = f.get('allocId');
    const goalId = String(f.get('goalId'));
    const date = String(f.get('date') || new Date().toISOString().slice(0, 10));
    const amount = num(f.get('amount'));

    if (!goalId || !amount) {
        alert('Wybierz cel i podaj kwotÄ™.');
        return;
    }

    if (allocId) {
        // Edit mode
        const index = b().goalAllocations.findIndex(a => a.id === allocId);
        if (index > -1) {
            b().goalAllocations[index] = { ...b().goalAllocations[index], goalId, date, amount, ym: date.slice(0,7) };
        }
    } else {
        // Add mode
        b().goalAllocations.unshift({ id: `alloc_${Math.random().toString(36).slice(2)}`, goalId, ym: date.slice(0, 7), date, amount });
    }
    
    save(state);
    resetAllocForm();
    renderGoals();
  };

  allocCancelBtn.onclick = resetAllocForm;

  function renderGoals(){
    const list=document.getElementById('goal-list');
    const summary=document.getElementById('goal-summary');
    const timelineWrapper=document.getElementById('goal-timeline-wrapper');
    const commitmentWrapper=document.getElementById('goal-commitment-table')?.parentElement?.parentElement;
    if(list) list.innerHTML='';
    if(summary) summary.innerHTML='';

    const goals=b().goals||[];
    const allocations=b().goalAllocations||[];
    const totalAllocatedByGoal=allocations.reduce((m,a)=>{m[a.goalId]=(m[a.goalId]||0)+num(a.amount);return m;},{});

    if(goals.length===0){
      if(list) list.innerHTML='<p class="muted" style="text-align:center;">Brak zdefiniowanych celÃ³w. UÅ¼yj formularza powyÅ¼ej, aby dodaÄ‡ swÃ³j pierwszy cel!</p>';
      if(timelineWrapper) timelineWrapper.style.display='none';
      if(commitmentWrapper) commitmentWrapper.style.display='none';
      if(summary) summary.style.display='none';
      return;
    }

    if(timelineWrapper) timelineWrapper.style.display='block';
    if(commitmentWrapper) commitmentWrapper.style.display='block';
    if(summary) summary.style.display='block';

    let totalTarget=0;
    let totalCollected=0;

    for(const g of goals){
      const collected=totalAllocatedByGoal[g.id]||0;
      totalTarget+=num(g.target);
      totalCollected+=collected;
      const pct=g.target>0?Math.min(100,(collected/g.target)*100):0;

      let monthlyNeeded='';
      if(g.deadline && g.startDate){
        const startDate=new Date(g.startDate);
        const deadlineDate=new Date(g.deadline);
        if(deadlineDate>startDate){
          const monthsLeft=Math.max(1,(deadlineDate.getFullYear()-startDate.getFullYear())*12+(deadlineDate.getMonth()-startDate.getMonth())+1);
          const needed=Math.max(0,g.target-collected);
          const monthly=needed/monthsLeft;
          monthlyNeeded=`<div class="muted" style="font-size:12px">Sugerowana wpÅ‚ata miesiÄ™czna: ${fmt(monthly,state.currency)}</div>`;
        }
      }

      const card=document.createElement('div');
      card.className='card';
      card.id=`goal-card-${g.id}`;
      card.innerHTML=`
        <div data-view="display">
          <div class="row">
            <div><b>${g.name}</b> <span class="muted">${g.startDate ? `${g.startDate} â†’ ` : ''}${g.deadline || ''}</span></div>
            <div>${fmt(collected,state.currency)} / ${fmt(g.target,state.currency)}</div>
          </div>
          <div class="progress ${pct>=100?'good':pct>=75?'warn':''}" style="margin-top:6px"><i style="width:${pct}%"></i></div>
          <div class="muted" style="font-size:12px;margin-top:4px">PostÄ™p: ${pct.toFixed(0)}%</div>
          ${monthlyNeeded}
          <div class="row" style="margin-top:8px; justify-content: flex-end; gap:8px;">
            <button class="btn soft" data-act="edit">Edytuj</button>
            <button class="btn danger" data-act="del">UsuÅ„</button>
          </div>
        </div>`;

      card.querySelector('[data-act="edit"]').onclick=()=>startEditGoal(g.id);
      card.querySelector('[data-act="del"]').onclick=()=>{
        if(!confirm('UsunÄ…Ä‡ cel (razem z alokacjami)?')) return;
        state.modules.budget.goals=(b().goals||[]).filter(x=>x.id!==g.id);
        state.modules.budget.goalAllocations=(b().goalAllocations||[]).filter(a=>a.goalId!==g.id);
        save(state);
        renderGoals();
      };
      list?.appendChild(card);
    }

    const totalProgressPct=totalTarget>0?(totalCollected/totalTarget)*100:0;
    if(summary){
      summary.innerHTML=`
        <div class="row">
          <div class="stat-card" style="flex:1;"><div class="muted">ÅÄ…cznie do zebrania</div><div class="big-number">${fmt(totalTarget,state.currency)}</div></div>
          <div class="stat-card" style="flex:1;"><div class="muted">Zebrano do tej pory</div><div class="big-number">${fmt(totalCollected,state.currency)}</div></div>
        </div>
        <div style="margin-top:8px;">
          <div class="muted">CaÅ‚kowity postÄ™p</div>
          <div class="progress ${totalProgressPct>=100?'good':totalProgressPct>=75?'warn':''}" style="margin-top:4px;height:12px;"><i style="width:${totalProgressPct}%"></i></div>
          <div class="muted" style="font-size:12px;margin-top:4px">${totalProgressPct.toFixed(1)}%</div>
        </div>
      `;
    }

    renderGoalsTimeline();
    renderAllocSelect();
    renderAllocationsHistory();
    setDefaultDateForAlloc();
  }

  function startEditGoal(id){
    const goal=(b().goals||[]).find(g=>g.id===id);
    if(!goal) return;
    const card=document.getElementById(`goal-card-${id}`);
    if(!card) return;
    card.innerHTML=`
      <div data-view="edit" class="grid g-4">
        <input name="name" value="${goal.name}" placeholder="Nazwa celu" style="grid-column: 1 / 3;"/>
        <input name="target" value="${String(goal.target).replace('.',',')}" placeholder="Kwota" inputmode="decimal" style="grid-column: 3 / 5;"/>
        <label class="tiny" style="grid-column: 1 / 3;">PoczÄ…tek oszczÄ™dzania<input name="startdate" type="date" value="${goal.startDate||''}" /></label>
        <label class="tiny" style="grid-column: 3 / 5;">Termin koÅ„cowy<input name="deadline" type="date" value="${goal.deadline||''}" /></label>
        <div class="row" style="grid-column: 1 / -1; justify-content: flex-end; gap:8px;">
          <button class="btn ghost" data-act="cancel">Anuluj</button>
          <button class="btn" data-act="save">Zapisz</button>
        </div>
      </div>`;
    bindMoneyInputs(card);
    card.querySelector('[data-act="save"]').onclick=()=>{
      goal.name=card.querySelector('[name="name"]').value;
      goal.target=num(card.querySelector('[name="target"]').value);
      goal.startDate=card.querySelector('[name="startdate"]').value||new Date().toISOString().slice(0,10);
      goal.deadline=card.querySelector('[name="deadline"]').value||undefined;
      save(state);
      renderGoals();
    };
    card.querySelector('[data-act="cancel"]').onclick=()=>renderGoals();
  }

  function renderGoalsTimeline(){
    const timeline=document.getElementById('goal-timeline');
    const axis=document.getElementById('timeline-axis');
    const labelsDiv=document.getElementById('timeline-labels');
    if(timeline) timeline.innerHTML='';
    if(axis) axis.innerHTML='';
    if(labelsDiv) labelsDiv.innerHTML='';

    const goalsWithDeadline=(b().goals||[]).filter(g=>g.deadline && g.startDate).sort((a,b)=>new Date(a.deadline)-new Date(b.deadline));
    if(goalsWithDeadline.length===0) return;

    const earliestStartDate=new Date(Math.min(...goalsWithDeadline.map(g=>new Date(g.startDate))));
    const furthestDeadline=new Date(Math.max(...goalsWithDeadline.map(g=>new Date(g.deadline))));
    const totalDurationDays=(furthestDeadline-earliestStartDate)/(1000*60*60*24);
    if(totalDurationDays<=0) return;

    const totalAllocatedByGoal=(b().goalAllocations||[]).reduce((m,a)=>{m[a.goalId]=(m[a.goalId]||0)+num(a.amount);return m;},{});

    let topOffset=0;
    for(const g of goalsWithDeadline){
      const startDate=new Date(g.startDate);
      const deadline=new Date(g.deadline);
      const duration=(deadline-startDate)/(1000*60*60*24);
      const left=((startDate-earliestStartDate)/(1000*60*60*24)/totalDurationDays)*100;
      const width=(duration/totalDurationDays)*100;
      const collected=totalAllocatedByGoal[g.id]||0;
      const pct=g.target>0?Math.min(100,(collected/g.target)*100):0;
      const bar=document.createElement('div');
      bar.className='timeline-bar';
      bar.style.top=`${topOffset}px`;
      bar.style.left=`${left}%`;
      bar.style.width=`${width}%`;
      bar.style.background=`linear-gradient(90deg, #3b82f6 ${pct}%, #93c5fd ${pct}%)`;
      bar.title=`${g.name}: ${pct.toFixed(0)}% zrealizowano (${fmt(collected)} / ${fmt(g.target)})`;
      bar.innerHTML=`<span class="bar-label">${g.name}</span> <span class="bar-progress">${pct.toFixed(0)}%</span>`;
      timeline?.appendChild(bar);
      topOffset+=30;
    }
    if(timeline) timeline.style.height=`${topOffset}px`;

    const monthlyCommitments={};
    goalsWithDeadline.forEach(g=>{
      const collected=totalAllocatedByGoal[g.id]||0;
      const needed=Math.max(0,num(g.target)-collected);
      const startDate=new Date(g.startDate);
      const deadlineDate=new Date(g.deadline);
      if(deadlineDate>startDate){
        const monthsLeft=Math.max(1,(deadlineDate.getFullYear()-startDate.getFullYear())*12+(deadlineDate.getMonth()-startDate.getMonth())+1);
        const monthlyAmount=needed/monthsLeft;
        for(let i=0;i<monthsLeft;i++){
          const targetMonth=ymAdd(monthKey(startDate),i);
          if(!monthlyCommitments[targetMonth]) monthlyCommitments[targetMonth]={};
          monthlyCommitments[targetMonth][g.id]=monthlyAmount;
        }
      }
    });

    const axisMonths=[];
    const iter=new Date(earliestStartDate.getFullYear(),earliestStartDate.getMonth(),1);
    while(iter<=furthestDeadline){
      axisMonths.push(new Date(iter));
      iter.setMonth(iter.getMonth()+1);
    }

    if(axis){
      axis.innerHTML=axisMonths.map(month=>{
        const monthStart=new Date(month.getFullYear(),month.getMonth(),1);
        const left=((monthStart-earliestStartDate)/(1000*60*60*24)/totalDurationDays)*100;
        if(left<0||left>100) return '';
        return `<div style="position:absolute; left: ${left}%; transform: translateX(-50%);">${month.toLocaleString('pl-PL',{month:'short',year:'numeric'})}</div>`;
      }).join('');
    }

    if(labelsDiv){
      labelsDiv.innerHTML=axisMonths.map(month=>{
        const ym=monthKey(month);
        const monthMid=new Date(month.getFullYear(),month.getMonth(),15);
        const left=((monthMid-earliestStartDate)/(1000*60*60*24)/totalDurationDays)*100;
        const totalForMonth=Object.values(monthlyCommitments[ym]||{}).reduce((s,a)=>s+a,0);
        if(left<0||left>100||totalForMonth===0) return '';
        return `<div class="timeline-label" style="left: ${left}%;">${fmt(totalForMonth,state.currency)}</div>`;
      }).join('');
    }

    renderGoalCommitmentTable(monthlyCommitments,goalsWithDeadline);
  }

  function renderGoalCommitmentTable(monthlyCommitments,goals){
    const table=document.getElementById('goal-commitment-table');
    if(!table) return;
    if(goals.length===0){ table.innerHTML=''; return; }
    let header='<thead><tr><th>MiesiÄ…c</th>';
    goals.forEach(g=>{header+=`<th>${g.name}</th>`;});
    header+='<th>Suma miesiÄ™czna</th></tr></thead>';
    const months=Object.keys(monthlyCommitments).sort();
    let body='<tbody>';
    months.forEach(ym=>{
      let monthlyTotal=0;
      body+=`<tr><td><b>${ym}</b></td>`;
      goals.forEach(g=>{
        const amount=monthlyCommitments[ym]?.[g.id]||0;
        if(amount>0){
          body+=`<td>${fmt(amount,state.currency)}</td>`;
          monthlyTotal+=amount;
        }else{
          body+='<td class="muted">â€”</td>';
        }
      });
      body+=`<td><b>${fmt(monthlyTotal,state.currency)}</b></td></tr>`;
    });
    body+='</tbody>';
    table.innerHTML=header+body;
  }

  function renderAllocationsHistory(){
    const tbody=document.getElementById('alloc-history-tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    const allocations=(b().goalAllocations||[]).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,15);
    const goalsById=Object.fromEntries((b().goals||[]).map(g=>[g.id,g]));
    if(allocations.length===0){
      tbody.innerHTML='<tr><td colspan="4" class="muted" style="text-align:center;">Brak historii alokacji.</td></tr>';
      return;
    }
    for(const alloc of allocations){
      const goal=goalsById[alloc.goalId];
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${alloc.date}</td>
        <td>${goal ? goal.name : '<em>UsuniÄ™ty cel</em>'}</td>
        <td>${fmt(alloc.amount,state.currency)}</td>
        <td class="row" style="justify-content:flex-end; gap:8px;">
          <button class="btn soft" data-edit-id="${alloc.id}">Edytuj</button>
          <button class="btn danger" data-del-id="${alloc.id}">UsuÅ„</button>
        </td>`;
      tr.querySelector('[data-edit-id]').onclick=()=>startEditAllocation(alloc.id);
      tr.querySelector('[data-del-id]').onclick=()=>{
        if(!confirm('Czy na pewno usunÄ…Ä‡ tÄ™ alokacjÄ™?')) return;
        state.modules.budget.goalAllocations=(b().goalAllocations||[]).filter(a=>a.id!==alloc.id);
        save(state);
        renderGoals();
      };
      tbody.appendChild(tr);
    }
  }

  function startEditAllocation(allocId){
    const alloc=(b().goalAllocations||[]).find(a=>a.id===allocId);
    if(!alloc) return;
    const form=document.getElementById('alloc-form');
    if(!form) return;
    const idField=form.querySelector('[name="allocId"]');
    if(idField) idField.value=alloc.id;
    const goalSel=form.querySelector('[name="goalId"]');
    if(goalSel) goalSel.value=alloc.goalId;
    const dateField=form.querySelector('[name="date"]');
    if(dateField) dateField.value=alloc.date;
    const amountField=form.querySelector('[name="amount"]');
    if(amountField) amountField.value=String(alloc.amount).replace('.',',');
    const title=document.getElementById('alloc-form-title');
    if(title) title.textContent='Edytuj alokacjÄ™';
    const submit=document.getElementById('alloc-submit-btn');
    if(submit) submit.textContent='Zapisz zmiany';
    const cancel=document.getElementById('alloc-cancel-btn');
    if(cancel) cancel.style.display='inline-flex';
  }

  function resetAllocForm(){
    const form=document.getElementById('alloc-form');
    form.reset();
    const idField=form.querySelector('[name="allocId"]');
    if(idField) idField.value='';
    const title=document.getElementById('alloc-form-title');
    if(title) title.textContent='Dodaj alokacjÄ™ na cel';
    const submit=document.getElementById('alloc-submit-btn');
    if(submit) submit.textContent='Dodaj alokacjÄ™';
    const cancel=document.getElementById('alloc-cancel-btn');
    if(cancel) cancel.style.display='none';
    setDefaultDateForAlloc();
  }


  document.getElementById('acct-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target); const name=String(f.get('name')||'').trim(); if(!name) return;
    const id='a_'+Math.random().toString(36).slice(2);
    b().accounts.push({id,name}); save(state); e.target.reset(); renderAll();
  };

  // --- Variable list + split editor + filter ---------------------------------
  function renderVariable(){
    const ym=b().workingMonth; document.getElementById('var-month').textContent=ym;
    renderRecurringSuggestions();

    const tbody=document.getElementById('var-rows');tbody.innerHTML='';
    const cb=catsById();
    const accById=Object.fromEntries((b().accounts||[]).map(a=>[a.id,a]));
    let txMonth=(b().transactions||[]).filter(t=>String(t.date).startsWith(ym));

    const filterSel=document.getElementById('var-filter-cat');
    const currentValue=filterSel.value;
    if(currentValue){
      txMonth = txMonth.filter(t=>{
        if(t.splits?.length) return t.splits.some(s=>s.categoryId===currentValue);
        return t.categoryId===currentValue;
      });
    }

    const entries=entriesForMonth(ym);
    const varSum=entries.reduce((s,e)=>{const c=cb[e.categoryId]; return (!c||c.type!=='expense' || c.id ==='c_fixed')?s:s+Math.abs(e.amount)},0);
    document.getElementById('var-sum').textContent = fmt(varSum, state.currency);

    for(const t of txMonth){
      const catMain = t.splits?.length ? null : cb[t.categoryId];
      const isExpense = t.splits?.length ? t.splits.some(s=>cb[s.categoryId]?.type==='expense') : (catMain?.type==='expense');
      const total = txTotalSigned(t);
      const catLabel = t.splits?.length ? `Split (${t.splits.length})` : ((catMain?.emoji||'')+' '+(catMain?.name||'â€”'));
      const tr=document.createElement('tr'); tr.setAttribute('data-id', t.id);
      tr.innerHTML=`<td>${t.date}</td><td>${catLabel}</td><td>${accById[t.accountId]?.name||'â€”'}</td><td class="${total<0 ? 'bad' : 'ok'}">${fmt(total,state.currency)}</td><td>${t.note||''}</td>
        <td class="row" style="gap:6px; justify-content:flex-end"><button class="btn soft" data-act="edit">Edytuj</button><button class="btn soft" data-act="copy">Kopiuj</button><button class="btn danger" data-act="del">X</button></td>`;
      tr.querySelector('[data-act="del"]').onclick=()=>{ if(!confirm('UsunÄ…Ä‡ tÄ™ transakcjÄ™?')) return; b().transactions=b().transactions.filter(x=>x.id!==t.id); save(state); renderAll() };
      tr.querySelector('[data-act="copy"]').onclick=()=>{ const today=new Date().toISOString().slice(0,10); const n=JSON.parse(JSON.stringify(t)); n.id=`tx_${Math.random().toString(36).slice(2)}`; n.date=today; b().transactions.unshift(n); save(state); alert('Skopiowano na dziÅ›.'); renderAll(); };
      tr.querySelector('[data-act="edit"]').onclick=()=>startEditTx(t);
      tbody.appendChild(tr);
    }

    filterSel.innerHTML='<option value="">Wszystkie kategorie</option>';
    for(const c of (b().categories||[])){filterSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}
    filterSel.value=currentValue; filterSel.onchange=renderVariable;

    const varCat=document.querySelector('#var-form select[name="categoryId"]'); if(varCat){varCat.innerHTML=''; for(const c of (b().categories||[])){varCat.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}}
    const accSel=document.querySelector('#var-form select[name="accountId"]'); if(accSel){accSel.innerHTML=''; for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id))}}
    setDefaultDate(); bindMoneyInputs(tbody);
  }

  function startEditTx(t){
    const row = document.querySelector(`#var-rows tr[data-id="${t.id}"]`); if(!row) return;
    const accs=b().accounts; const isSplit = !!(t.splits && t.splits.length);
    row.innerHTML=`
      <td><input type="date" value="${t.date}" data-k="date"/></td>
      <td colspan="1">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><label style="display:flex;align-items:center;gap:6px"><input type="checkbox" data-k="isSplit" ${isSplit?'checked':''}/> Split</label></div>
        <div data-mode="single" ${isSplit?'style="display:none"':''}><select data-k="categoryId"></select></div>
        <div data-mode="split" class="split-box" ${isSplit?'':'style="display:none"'}><table style="width:100%"><thead><tr><th>Kategoria</th><th>Kwota</th><th></th></tr></thead><tbody class="tx-split-rows"></tbody></table><div style="margin-top:6px"><button class="btn soft" type="button" data-act="split-add">+ wiersz</button></div></div>
      </td>
      <td><select data-k="accountId"></select></td>
      <td><div data-mode="single" ${isSplit?'style="display:none"':''}><input inputmode="decimal" value="${String(Math.abs(t.amount||0)).replace('.',',')}" data-k="amount"/></div><div data-mode="split" ${isSplit?'':'style="display:none"'} class="tiny">Kwoty w split wpisuj jako dodatnie.</div></td>
      <td><input value="${t.note||''}" data-k="note"/></td>
      <td class="row" style="gap:6px"><button class="btn" data-act="save">Zapisz</button><button class="btn ghost" data-act="cancel">Anuluj</button></td>`;
    const cb=catsById();
    const catSel=row.querySelector('select[data-k="categoryId"]'); for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id,false,c.id===t.categoryId))}
    const accSel=row.querySelector('select[data-k="accountId"]'); for(const a of (accs||[])){accSel.add(new Option(a.name,a.id,false,a.id===t.accountId))}
    const tbody=row.querySelector('.tx-split-rows');
    function addSplitRow(sp){const tr=document.createElement('tr'); tr.className='split-row'; tr.innerHTML=`<td><select class="sp-cat"></select></td><td><input class="sp-amt" inputmode="decimal" value="${sp?String(sp.amount).replace('.',','):''}" /></td><td><button class="btn danger" type="button">X</button></td>`; const sel=tr.querySelector('.sp-cat'); for(const c of (b().categories||[])){sel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id,false, sp?sp.categoryId===c.id:false))} tr.querySelector('button').onclick=()=>{tr.remove()}; tbody.appendChild(tr); bindMoneyInputs(tr);}
    if(t.splits?.length){for(const s of t.splits) addSplitRow(s)} else { addSplitRow(); }
    row.querySelector('[data-k="isSplit"]').onchange=()=>{const on = row.querySelector('[data-k="isSplit"]').checked; row.querySelectorAll('[data-mode="single"]').forEach(el=>el.style.display= on?'none':'block'); row.querySelectorAll('[data-mode="split"]').forEach(el=>el.style.display= on?'block':'none');};
    row.querySelector('[data-act="split-add"]').onclick=()=>addSplitRow();
    bindMoneyInputs(row);
    row.querySelector('[data-act="save"]').onclick=()=>{
      const date=row.querySelector('[data-k="date"]').value || t.date;
      const accountId=row.querySelector('[data-k="accountId"]').value;
      const note=row.querySelector('[data-k="note"]').value;
      const useSplit=row.querySelector('[data-k="isSplit"]').checked;
      const idx=b().transactions.findIndex(x=>x.id===t.id); if(idx === -1) return;
      
      if(useSplit){
        const rows=Array.from(row.querySelectorAll('.split-row')); if(rows.length===0){alert('Dodaj przynajmniej jeden wiersz split.'); return;}
        const splits=[]; for(const r of rows){const cat=r.querySelector('.sp-cat').value; const amt=num(r.querySelector('.sp-amt').value); if(!cat || amt <= 0){alert('UzupeÅ‚nij kategoriÄ™ i kwotÄ™ > 0 w kaÅ¼dym wierszu split.'); return;} splits.push({categoryId:cat, amount:amt});}
        const total=splits.reduce((s,sp)=>s+signFor(sp.categoryId,num(sp.amount)),0);
        const firstCat=splits[0].categoryId;
        b().transactions[idx]={...b().transactions[idx],date,accountId,note,categoryId:firstCat,amount:total,splits};
      }else{
        const categoryId=row.querySelector('[data-k="categoryId"]').value;
        const amountRaw=num(row.querySelector('[data-k="amount"]').value);
        const signed= signFor(categoryId, amountRaw);
        b().transactions[idx]={...b().transactions[idx],date,categoryId,accountId,amount:signed,note,splits:[]};
      }
      save(state); renderAll();
    };
    row.querySelector('[data-act="cancel"]').onclick=()=>renderVariable();
  }

  // --- Categories -------------------------------------------------------------
  function renderCategories(){
    const tbody=document.getElementById('cat-rows');tbody.innerHTML='';
    const emptyInfo=document.getElementById('cat-empty');
    const ym=b().workingMonth; const cats=b().categories||[];
    emptyInfo.style.display = cats.length===0 ? 'block' : 'none';

    const entries=entriesForMonth(ym);
    const spending={};
    for(const e of entries){
      const catId=e.categoryId; const c=cats.find(c=>c.id===catId);
      if(c && c.type==='expense'){spending[catId]=(spending[catId]||0)+Math.abs(e.amount)}
    }
    for(const c of cats){
      const spent=spending[c.id]||0; const budget=num(c.budget); let status='â€”';
      if(c.type==='expense' && budget>0){
        const pct=(spent/budget)*100;
        if(pct>100) status=`<span class="bad">${pct.toFixed(0)}% (przekroczenie)</span>`;
        else if(pct>80) status=`<span class="warn">${pct.toFixed(0)}%</span>`;
        else status=`<span class="ok">${pct.toFixed(0)}%</span>`;
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.emoji||''}</td><td>${c.name}</td><td>${c.type}</td><td>${budget>0?fmt(budget,state.currency):'â€”'}</td><td>${fmt(spent,state.currency)}</td><td>${status}</td><td><button class="btn danger">UsuÅ„</button></td>`;
      tr.querySelector('.btn').onclick=()=>{
        if(c.id==='c_fixed'){alert('Nie moÅ¼na usunÄ…Ä‡ kategorii â€Wydatki staÅ‚eâ€.'); return;}
        if(!confirm('UsunÄ…Ä‡ kategoriÄ™?')) return;
        b().categories=b().categories.filter(x=>x.id!==c.id && x.id!=='c_fixed'); save(state); renderAll()
      };
      tbody.appendChild(tr);
    }
  }

  // --- EOM --------------------------------------------------------------------
  function destroyEomChart(key){
    if(eomCharts[key]){
      eomCharts[key].destroy();
      delete eomCharts[key];
    }
  }

  function sumBalances(map){
    return Object.values(map || {}).reduce((sum, val) => sum + (Number(val) || 0), 0);
  }

  function buildEomContext(){
    const accounts = b().accounts || [];
    const entries = (b().eom || []).map(entry => ({
      ym: String(entry.ym),
      accountId: entry.accountId,
      balance: num(entry.balance)
    })).filter(entry => entry.ym && entry.accountId);

    const monthBalances = {};
    const accountHistory = {};

    for(const entry of entries){
      if(!monthBalances[entry.ym]) monthBalances[entry.ym] = {};
      monthBalances[entry.ym][entry.accountId] = entry.balance;
      if(!accountHistory[entry.accountId]) accountHistory[entry.accountId] = [];
      accountHistory[entry.accountId].push({ ym: entry.ym, balance: entry.balance });
    }

    Object.values(accountHistory).forEach(hist => hist.sort((a,b) => a.ym.localeCompare(b.ym)));

    const months = Object.keys(monthBalances).sort();
    const workingYm = b().workingMonth;
    const workingBalances = monthBalances[workingYm] || {};
    const hasWorking = Object.keys(workingBalances).length > 0;
    const latestMonth = months.length ? months[months.length - 1] : null;
    const focusMonth = hasWorking ? workingYm : latestMonth;
    const focusPrevMonth = focusMonth ? months.filter(m => m < focusMonth).pop() || null : null;
    const focusBalances = focusMonth ? (monthBalances[focusMonth] || {}) : {};
    const focusPrevBalances = focusPrevMonth ? (monthBalances[focusPrevMonth] || {}) : {};
    const netWorthByMonth = months.map(ym => ({ ym, total: sumBalances(monthBalances[ym]) }));

    return {
      accounts,
      accountHistory,
      monthBalances,
      months,
      workingYm,
      workingBalances,
      hasWorking,
      latestMonth,
      focusMonth,
      focusPrevMonth,
      focusBalances,
      focusPrevBalances,
      netWorthByMonth
    };
  }

  function entryForMonth(history, ym){
    if(!history) return null;
    return history.find(item => item.ym === ym) || null;
  }

  function lastEntryBefore(history, ym){
    if(!history) return null;
    let prev = null;
    for(const item of history){
      if(item.ym < ym){
        prev = item;
      } else if(item.ym >= ym){
        break;
      }
    }
    return prev;
  }

  function computeAccountStatsForMonth(ctx, targetMonth){
    if(!targetMonth) return [];
    const { accounts, accountHistory } = ctx;
    return accounts.map(acc => {
      const history = accountHistory[acc.id] || [];
      const historyUpTo = history.filter(item => item.ym <= targetMonth);
      if(historyUpTo.length === 0) return null;
      const currentEntry = entryForMonth(history, targetMonth);
      const prevEntry = lastEntryBefore(history, targetMonth);
      const delta = (currentEntry || prevEntry) ? ((currentEntry?.balance ?? 0) - (prevEntry?.balance ?? 0)) : null;
      const deltaPct = prevEntry && prevEntry.balance ? (delta / Math.abs(prevEntry.balance)) * 100 : null;
      const lastThree = historyUpTo.slice(-3);
      const avg3 = lastThree.length ? lastThree.reduce((sum, item) => sum + item.balance, 0) / lastThree.length : null;
      const trendVsAvg = currentEntry && avg3 !== null ? currentEntry.balance - avg3 : null;
      const maxEntry = historyUpTo.reduce((max, item) => !max || item.balance > max.balance ? item : max, null);
      const minEntry = historyUpTo.reduce((min, item) => !min || item.balance < min.balance ? item : min, null);
      return {
        account: acc,
        current: currentEntry ? currentEntry.balance : null,
        currentYm: currentEntry?.ym || targetMonth,
        previous: prevEntry ? prevEntry.balance : null,
        previousYm: prevEntry?.ym || null,
        delta,
        deltaPct,
        avg3,
        trendVsAvg,
        maxEntry,
        minEntry
      };
    }).filter(Boolean);
  }

  function computeMonthlySummary(ctx){
    const { months, monthBalances, accounts, accountHistory } = ctx;
    return months.map(ym => {
      const balances = monthBalances[ym] || {};
      const netWorth = sumBalances(balances);
      const prevMonth = months.filter(m => m < ym).pop() || null;
      const prevBalances = prevMonth ? (monthBalances[prevMonth] || {}) : {};
      const prevNetWorth = prevMonth !== null ? sumBalances(prevBalances) : null;
      const delta = prevNetWorth !== null ? netWorth - prevNetWorth : null;
      let positive = 0;
      let negative = 0;
      for(const value of Object.values(balances)){
        const val = Number(value) || 0;
        if(val >= 0) positive += val;
        else negative += val;
      }
      const base = positive + Math.abs(negative);
      const debtShare = base ? (Math.abs(negative) / base) * 100 : 0;
      let best = null;
      let worst = null;
      for(const acc of accounts){
        const history = accountHistory[acc.id] || [];
        if(history.length === 0) continue;
        const current = entryForMonth(history, ym)?.balance ?? null;
        const prevEntry = lastEntryBefore(history, ym);
        if(current === null && !prevEntry) continue;
        const deltaAcc = (current ?? 0) - (prevEntry?.balance ?? 0);
        if(!best || deltaAcc > best.delta) best = { account: acc, delta: deltaAcc };
        if(!worst || deltaAcc < worst.delta) worst = { account: acc, delta: deltaAcc };
      }
      return { ym, netWorth, delta, positive, negative, debtShare, best, worst };
    });
  }

  function renderDeltaBadge(delta){
    if(delta === null || delta === undefined) return '<span class="delta-neutral">â€”</span>';
    if(Math.abs(delta) < 0.005) return '<span class="delta-neutral">â€”</span>';
    const cls = delta > 0 ? 'delta-up' : 'delta-down';
    const sign = delta > 0 ? '+' : '';
    return `<span class="${cls}">${sign}${fmt(delta, state.currency)}</span>`;
  }

  function renderEomKpis(ctx, accountStats){
    const container = document.getElementById('eom-kpis');
    if(!container) return;
    if(!ctx.months.length){
      container.innerHTML = `<p class="muted" style="grid-column:1 / -1;text-align:center;">Dodaj pierwsze salda, aby zobaczyÄ‡ wskaÅºniki.</p>`;
      return;
    }
    const netWorth = sumBalances(ctx.focusBalances);
    const prevNetWorth = ctx.focusPrevMonth ? sumBalances(ctx.focusPrevBalances) : null;
    const delta = prevNetWorth !== null ? netWorth - prevNetWorth : null;
    const deltaExists = delta !== null && Math.abs(delta) >= 0.005;
    const deltaValue = deltaExists ? `${delta > 0 ? '+' : ''}${fmt(delta, state.currency)}` : 'â€”';
    let changeInfo = '<span class="kpi-trend trend-flat">Brak danych do porÃ³wnania</span>';
    if(deltaExists){
      const deltaPct = prevNetWorth ? (delta / prevNetWorth) * 100 : null;
      const pctText = deltaPct !== null ? ` (${delta > 0 ? '+' : ''}${deltaPct.toFixed(1)}%)` : '';
      changeInfo = `<span class="kpi-trend ${delta > 0 ? 'trend-up' : 'trend-down'}">${delta > 0 ? 'Wzrost' : 'Spadek'} ${delta > 0 ? '+' : ''}${fmt(delta, state.currency)}${pctText}</span>`;
    }
    const positive = Object.values(ctx.focusBalances).reduce((sum, val) => sum + (Number(val) >= 0 ? Number(val) : 0), 0);
    const liabilities = Object.values(ctx.focusBalances).reduce((sum, val) => sum + (Number(val) < 0 ? Number(val) : 0), 0);
    const base = positive + Math.abs(liabilities);
    const debtShare = base ? (Math.abs(liabilities) / base) * 100 : 0;
    const bestAccount = accountStats.filter(row => Number.isFinite(row.delta)).sort((a,b) => (b.delta || 0) - (a.delta || 0))[0];
    const worstAccount = accountStats.filter(row => Number.isFinite(row.delta)).sort((a,b) => (a.delta || 0) - (b.delta || 0))[0];
    const bestLine = bestAccount && Math.abs(bestAccount.delta || 0) >= 0.005
      ? `<div><span class="ok">â–² ${bestAccount.account.name}</span> ${fmt(bestAccount.delta, state.currency)}</div>`
      : '<div class="muted">Brak wzrostÃ³w</div>';
    const worstLine = worstAccount && Math.abs(worstAccount.delta || 0) >= 0.005
      ? `<div><span class="bad">â–¼ ${worstAccount.account.name}</span> ${fmt(worstAccount.delta, state.currency)}</div>`
      : '<div class="muted">Brak spadkÃ³w</div>';
    const focusLabel = ctx.focusMonth
      ? (ctx.focusMonth === ctx.workingYm ? `Dane z ${ctx.focusMonth}` : `Ostatni zapis: ${ctx.focusMonth}`)
      : 'Brak zapisÃ³w';

    container.innerHTML = `
      <div class="kpi-card">
        <div class="label">MajÄ…tek netto</div>
        <div class="value">${fmt(netWorth, state.currency)}</div>
        <div class="sub">${focusLabel}</div>
      </div>
      <div class="kpi-card light">
        <div class="label">Zmiana m/m</div>
        <div class="value">${deltaValue}</div>
        ${changeInfo}
      </div>
      <div class="kpi-card light">
        <div class="label">NajwiÄ™ksze ruchy</div>
        ${bestLine}
        ${worstLine}
      </div>
      <div class="kpi-card light">
        <div class="label">Struktura</div>
        <div>PÅ‚ynne aktywa: <b>${fmt(positive, state.currency)}</b></div>
        <div>ZobowiÄ…zania: <b>${fmt(Math.abs(liabilities), state.currency)}</b></div>
        <div class="sub">DÅ‚ug to ${debtShare.toFixed(1)}% portfela</div>
      </div>
    `;
  }

  function renderEomInsights(ctx, summaryRows){
    const container = document.getElementById('eom-insights');
    if(!container) return;
    if(!ctx.months.length){
      container.innerHTML = '';
      return;
    }
    const insights = [];
    if(ctx.netWorthByMonth.length){
      const record = ctx.netWorthByMonth.reduce((max, item) => item.total > (max?.total ?? -Infinity) ? item : max, null);
      if(record){
        insights.push(`<span class="insight-pill">ğŸ“ˆ Rekord: ${record.ym} â€” ${fmt(record.total, state.currency)}</span>`);
      }
      const low = ctx.netWorthByMonth.reduce((min, item) => item.total < (min?.total ?? Infinity) ? item : min, null);
      if(low && low.ym !== record?.ym){
        insights.push(`<span class="insight-pill">ğŸ“‰ NajniÅ¼szy poziom: ${low.ym} â€” ${fmt(low.total, state.currency)}</span>`);
      }
    }
    const swing = summaryRows.filter(row => row.delta !== null && Math.abs(row.delta) >= 0.005)
      .sort((a,b) => Math.abs((b.delta || 0)) - Math.abs((a.delta || 0)))[0];
    if(swing){
      insights.push(`<span class="insight-pill">${swing.delta > 0 ? 'ğŸŸ¢' : 'ğŸ”»'} NajwiÄ™ksza zmiana: ${swing.ym} ${swing.delta > 0 ? '+' : ''}${fmt(swing.delta, state.currency)}</span>`);
    }
    const total = sumBalances(ctx.focusBalances);
    if(total){
      let top = null;
      for(const acc of ctx.accounts){
        const value = ctx.focusBalances[acc.id];
        if(value === undefined) continue;
        const share = (value / total) * 100;
        if(!top || Math.abs(share) > Math.abs(top.share)){
          top = { account: acc, value, share };
        }
      }
      if(top){
        insights.push(`<span class="insight-pill">${top.value >= 0 ? 'ğŸ¦' : 'ğŸ’³'} ${top.account.name}: ${fmt(top.value, state.currency)} (${top.share.toFixed(1)}%)</span>`);
      }
    }
    const liabilities = Object.values(ctx.focusBalances).filter(v => Number(v) < 0).reduce((sum, val) => sum + Number(val), 0);
    if(liabilities){
      const base = Object.values(ctx.focusBalances).reduce((sum, val) => sum + Math.abs(Number(val) || 0), 0);
      const ratio = base ? (Math.abs(liabilities) / base) * 100 : 0;
      insights.push(`<span class="insight-pill">âš ï¸ DÅ‚ugi: ${fmt(Math.abs(liabilities), state.currency)} (${ratio.toFixed(1)}% aktywÃ³w)</span>`);
    }
    container.innerHTML = insights.join('');
  }

  function renderEomHistoryTable(ctx, monthsToShow){
    const table = document.getElementById('eom-accounts-history');
    if(!table) return;
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if(thead) thead.innerHTML = '';
    if(tbody) tbody.innerHTML = '';
    if(!monthsToShow.length){
      if(tbody) tbody.innerHTML = `<tr><td class="muted" style="text-align:center;padding:16px;">Brak danych historycznych do wyÅ›wietlenia.</td></tr>`;
      return;
    }
    if(!thead || !tbody) return;
    let header = '<tr><th>MiesiÄ…c</th>';
    for(const acc of ctx.accounts){ header += `<th>${acc.name}</th>`; }
    header += '<th>MajÄ…tek netto</th><th>Zmiana m/m</th></tr>';
    thead.innerHTML = header;
    let prevNetWorth = null;
    for(const ym of monthsToShow){
      const balances = ctx.monthBalances[ym] || {};
      const prevMonth = ctx.months.filter(m => m < ym).pop() || null;
      const prevBalances = prevMonth ? (ctx.monthBalances[prevMonth] || {}) : {};
      let row = `<td><b>${ym}</b></td>`;
      for(const acc of ctx.accounts){
        const value = balances[acc.id];
        if(value === undefined){
          row += '<td class="muted">â€”</td>';
        } else {
          const prevVal = prevBalances[acc.id];
          let change = '';
          if(prevVal !== undefined){
            const diff = value - prevVal;
            if(Math.abs(diff) >= 0.005){
              change = `<br><span class="tiny ${diff >= 0 ? 'ok' : 'bad'}">${diff >= 0 ? '+' : ''}${fmt(diff, state.currency)}</span>`;
            }
          }
          row += `<td>${fmt(value, state.currency)}${change}</td>`;
        }
      }
      const netWorth = sumBalances(balances);
      const deltaTotal = prevNetWorth !== null ? netWorth - prevNetWorth : null;
      row += `<td><b>${fmt(netWorth, state.currency)}</b></td>`;
      row += `<td>${deltaTotal === null ? '<span class="muted">â€”</span>' : renderDeltaBadge(deltaTotal)}</td>`;
      const tr = document.createElement('tr');
      tr.innerHTML = row;
      tbody.appendChild(tr);
      prevNetWorth = netWorth;
    }
  }

  function renderEomChangeTable(ctx, accountStats){
    const table = document.getElementById('eom-change-table');
    if(!table) return;
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if(thead) thead.innerHTML = '';
    if(tbody) tbody.innerHTML = '';
    if(!accountStats.length){
      if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center;padding:16px;">Brak historii kont do analizy.</td></tr>`;
      return;
    }
    if(!thead || !tbody) return;
    const sortState = eomUiState.changeSort;
    const cols = [
      { label:'Konto', key:'name' },
      { label:`Saldo (${ctx.focusMonth || ctx.workingYm})`, key:'current' },
      { label:ctx.focusPrevMonth ? `Poprzednio (${ctx.focusPrevMonth})` : 'Poprzednio', key:'previous' },
      { label:'Zmiana m/m', key:'delta' },
      { label:'Zmiana %', key:'deltaPct' },
      { label:'vs Å›rednia 3m', key:'trendVsAvg' },
      { label:'Rekord', key:'max' }
    ];
    thead.innerHTML = '<tr>' + cols.map(col => {
      const active = sortState.field === col.key;
      const indicator = active ? `<span class="sort-indicator">${sortState.dir === 'asc' ? 'â–²' : 'â–¼'}</span>` : '';
      return `<th data-sort="${col.key}">${col.label}${indicator}</th>`;
    }).join('') + '</tr>';

    const rows = accountStats.map(stat => ({
      ...stat,
      name: stat.account.name,
      max: stat.maxEntry?.balance ?? null
    }));

    rows.sort((a,b) => {
      const dir = sortState.dir === 'asc' ? 1 : -1;
      const key = sortState.field;
      if(key === 'name') return a.name.localeCompare(b.name, 'pl', { sensitivity:'base' }) * dir;
      const mapValue = (row) => {
        switch(key){
          case 'current': return row.current ?? -Infinity;
          case 'previous': return row.previous ?? -Infinity;
          case 'delta': return row.delta ?? 0;
          case 'deltaPct': return row.deltaPct ?? -Infinity;
          case 'trendVsAvg': return row.trendVsAvg ?? -Infinity;
          case 'max': return row.maxEntry?.balance ?? -Infinity;
          default: return row[key] ?? 0;
        }
      };
      const av = mapValue(a);
      const bv = mapValue(b);
      if(av === bv) return a.name.localeCompare(b.name, 'pl', { sensitivity:'base' }) * dir;
      return (av - bv) * dir;
    });

    tbody.innerHTML = rows.map(row => {
      const currentHtml = row.current === null
        ? '<span class="muted">â€”</span>'
        : `${fmt(row.current, state.currency)}${row.currentYm && row.currentYm !== ctx.focusMonth ? `<br><span class="tiny muted">${row.currentYm}</span>` : ''}`;
      const previousHtml = row.previous === null
        ? '<span class="muted">â€”</span>'
        : `${fmt(row.previous, state.currency)}${row.previousYm ? `<br><span class="tiny muted">${row.previousYm}</span>` : ''}`;
      const deltaHtml = row.delta === null ? '<span class="muted">â€”</span>' : renderDeltaBadge(row.delta);
      const pctHtml = row.deltaPct === null ? '<span class="muted">â€”</span>' : `<span class="${row.deltaPct >= 0 ? 'ok' : 'bad'}">${row.deltaPct >= 0 ? '+' : ''}${row.deltaPct.toFixed(1)}%</span>`;
      const avgHtml = row.trendVsAvg === null ? '<span class="muted">â€”</span>' : renderDeltaBadge(row.trendVsAvg);
      const maxHtml = row.maxEntry
        ? `${fmt(row.maxEntry.balance, state.currency)}<br><span class="tiny muted">${row.maxEntry.ym}</span>`
        : '<span class="muted">â€”</span>';
      return `<tr><td>${row.name}</td><td>${currentHtml}</td><td>${previousHtml}</td><td>${deltaHtml}</td><td>${pctHtml}</td><td>${avgHtml}</td><td>${maxHtml}</td></tr>`;
    }).join('');

    thead.querySelectorAll('th[data-sort]').forEach(th => {
      const key = th.dataset.sort;
      th.onclick = () => {
        if(eomUiState.changeSort.field === key){
          eomUiState.changeSort.dir = eomUiState.changeSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
          eomUiState.changeSort.field = key;
          eomUiState.changeSort.dir = key === 'name' ? 'asc' : 'desc';
        }
        renderEOMHistory();
      };
    });
  }

  function renderEomMonthlySummary(summaryRows){
    const table = document.getElementById('eom-monthly-summary');
    if(!table) return;
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if(thead) thead.innerHTML = '';
    if(tbody) tbody.innerHTML = '';
    if(!summaryRows.length){
      if(tbody) tbody.innerHTML = `<tr><td colspan="8" class="muted" style="text-align:center;padding:16px;">Brak danych historycznych do zestawienia.</td></tr>`;
      return;
    }
    if(!thead || !tbody) return;
    const sortState = eomUiState.monthlySort;
    const cols = [
      { label:'MiesiÄ…c', key:'ym' },
      { label:'MajÄ…tek netto', key:'netWorth' },
      { label:'Zmiana m/m', key:'delta' },
      { label:'NajwiÄ™kszy wzrost', key:'best' },
      { label:'NajwiÄ™kszy spadek', key:'worst' },
      { label:'Saldo dodatnie', key:'positive' },
      { label:'Saldo ujemne', key:'negative' },
      { label:'UdziaÅ‚ dÅ‚ugu', key:'debtShare' }
    ];
    thead.innerHTML = '<tr>' + cols.map(col => {
      const active = sortState.field === col.key;
      const indicator = active ? `<span class="sort-indicator">${sortState.dir === 'asc' ? 'â–²' : 'â–¼'}</span>` : '';
      return `<th data-sort="${col.key}">${col.label}${indicator}</th>`;
    }).join('') + '</tr>';

    const rows = [...summaryRows];
    rows.sort((a,b) => {
      const dir = sortState.dir === 'asc' ? 1 : -1;
      const key = sortState.field;
      if(key === 'ym') return a.ym.localeCompare(b.ym) * dir;
      if(key === 'best'){
        const av = a.best ? a.best.delta : -Infinity;
        const bv = b.best ? b.best.delta : -Infinity;
        if(av === bv) return a.ym.localeCompare(b.ym) * dir;
        return (av - bv) * dir;
      }
      if(key === 'worst'){
        const av = a.worst ? a.worst.delta : Infinity;
        const bv = b.worst ? b.worst.delta : Infinity;
        if(av === bv) return a.ym.localeCompare(b.ym) * dir;
        return (av - bv) * dir;
      }
      const av = Number(a[key] ?? 0);
      const bv = Number(b[key] ?? 0);
      if(av === bv) return a.ym.localeCompare(b.ym) * dir;
      return (av - bv) * dir;
    });

    tbody.innerHTML = rows.map(row => {
      const deltaHtml = row.delta === null ? '<span class="muted">â€”</span>' : renderDeltaBadge(row.delta);
      const bestHtml = row.best
        ? `<div>${row.best.account.name}</div><div class="tiny ok">${row.best.delta > 0 ? '+' : ''}${fmt(row.best.delta, state.currency)}</div>`
        : '<span class="muted">â€”</span>';
      const worstHtml = row.worst
        ? `<div>${row.worst.account.name}</div><div class="tiny bad">${row.worst.delta > 0 ? '+' : ''}${fmt(row.worst.delta, state.currency)}</div>`
        : '<span class="muted">â€”</span>';
      return `<tr><td><b>${row.ym}</b></td><td>${fmt(row.netWorth, state.currency)}</td><td>${deltaHtml}</td><td>${bestHtml}</td><td>${worstHtml}</td><td>${fmt(row.positive, state.currency)}</td><td>${fmt(Math.abs(row.negative), state.currency)}</td><td>${row.debtShare.toFixed(1)}%</td></tr>`;
    }).join('');

    thead.querySelectorAll('th[data-sort]').forEach(th => {
      const key = th.dataset.sort;
      th.onclick = () => {
        if(eomUiState.monthlySort.field === key){
          eomUiState.monthlySort.dir = eomUiState.monthlySort.dir === 'asc' ? 'desc' : 'asc';
        } else {
          eomUiState.monthlySort.field = key;
          eomUiState.monthlySort.dir = key === 'ym' ? 'desc' : 'desc';
        }
        renderEOMHistory();
      };
    });
  }

  function renderEomNetWorthChart(ctx, monthsToShow){
    const canvas = document.getElementById('eom-networth-chart');
    if(!canvas) return;
    destroyEomChart('netWorth');
    if(!monthsToShow.length) return;
    const labels = monthsToShow;
    const data = labels.map(ym => sumBalances(ctx.monthBalances[ym] || {}));
    eomCharts.netWorth = new Chart(canvas.getContext('2d'), {
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'MajÄ…tek netto',
          data,
          borderColor:'#0f172a',
          backgroundColor:'rgba(15,23,42,0.12)',
          borderWidth:2,
          tension:0.35,
          fill:true
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{ callbacks:{ label: context => `${fmt(context.parsed.y, state.currency)}` } }
        },
        scales:{
          y:{ ticks:{ callback: currencyTicks } }
        }
      }
    });
  }

  function renderEomAccountsChart(ctx, monthsToShow){
    const canvas = document.getElementById('eom-accounts-chart');
    if(!canvas) return;
    destroyEomChart('accounts');
    if(!monthsToShow.length) return;
    const ranked = ctx.accounts.map(acc => ({
      acc,
      value: Math.abs(ctx.focusBalances[acc.id] ?? 0)
    })).sort((a,b) => b.value - a.value).slice(0, 6);
    if(!ranked.length) return;
    const datasets = ranked.map((item, idx) => {
      const history = ctx.accountHistory[item.acc.id] || [];
      return {
        label: item.acc.name,
        data: monthsToShow.map(ym => {
          const entry = entryForMonth(history, ym);
          return entry ? entry.balance : null;
        }),
        borderColor: ANALYTICS_COLORS[idx % ANALYTICS_COLORS.length],
        backgroundColor: withAlpha(ANALYTICS_COLORS[idx % ANALYTICS_COLORS.length], 0.14),
        borderWidth:2,
        tension:0.35,
        fill:false,
        spanGaps:true
      };
    });
    eomCharts.accounts = new Chart(canvas.getContext('2d'), {
      type:'line',
      data:{ labels: monthsToShow, datasets },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ position:'bottom' },
          tooltip:{ callbacks:{ label: context => `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}` } }
        },
        scales:{
          y:{ ticks:{ callback: currencyTicks } }
        }
      }
    });
  }

  function renderEOM(){
    const ctx = buildEomContext();
    const ym = ctx.workingYm;
    const prompt = document.getElementById('eom-prompt');
    if(prompt){
      const lastInfo = ctx.hasWorking
        ? 'Masz juÅ¼ zapisane salda dla tego miesiÄ…ca â€” moÅ¼esz je zaktualizowaÄ‡.'
        : ctx.latestMonth ? `Ostatnio zapisano dane dla ${ctx.latestMonth}.` : 'To bÄ™dzie TwÃ³j pierwszy zapis sald.';
      prompt.innerHTML = `WprowadÅº salda swoich kont na koniec miesiÄ…ca <b>${ym}</b>. <span class="muted">${lastInfo}</span>`;
    }
    const badge = document.getElementById('eom-active-month');
    if(badge) badge.textContent = ym;

    const tableHeader = document.getElementById('eom-table')?.querySelector('thead');
    if(tableHeader){
      tableHeader.innerHTML = `<tr><th>Konto</th><th>Ostatni zapis</th><th>Saldo ${ym}</th><th>Zmiana</th><th></th></tr>`;
    }

    const tbody = document.getElementById('eom-rows');
    if(!tbody) return;
    tbody.innerHTML = '';

    const updateTotal = () => {
      const total = Array.from(tbody.querySelectorAll('input')).reduce((sum, input) => sum + (input.value.trim() ? num(input.value) : 0), 0);
      const totalEl = document.getElementById('eom-total');
      if(totalEl) totalEl.textContent = fmt(total, state.currency);
    };

    const filterSel = document.getElementById('eom-account-filter');
    const filterValue = filterSel ? filterSel.value : 'all';
    if(filterSel && !filterSel.dataset.bound){
      filterSel.dataset.bound = '1';
      filterSel.addEventListener('change', renderEOM);
    }

    const rows = ctx.accounts.map(acc => {
      const history = ctx.accountHistory[acc.id] || [];
      const currentEntry = entryForMonth(history, ym);
      const prevEntry = lastEntryBefore(history, ym);
      const referenceValue = currentEntry ? currentEntry.balance : (prevEntry ? prevEntry.balance : 0);
      if(filterValue === 'positive' && referenceValue <= 0) return null;
      if(filterValue === 'negative' && referenceValue >= 0) return null;
      return { acc, currentEntry, prevEntry };
    }).filter(Boolean);

    const updateFns = [];

    if(rows.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" class="muted" style="text-align:center;padding:16px;">Brak kont do wyÅ›wietlenia. Dodaj konto lub zmieÅ„ filtr.</td></tr>`;
    } else {
      for(const row of rows){
        const acc = row.acc;
        const prevEntry = row.prevEntry;
        const previousBalance = prevEntry ? prevEntry.balance : null;
        const previousLabel = prevEntry
          ? `${fmt(prevEntry.balance, state.currency)}<br><span class="tiny muted">${prevEntry.ym}</span>`
          : '<span class="muted">Brak danych</span>';
        const currentValue = row.currentEntry ? String(row.currentEntry.balance).replace('.',',') : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div><b>${acc.name}</b></div></td>
          <td>${previousLabel}</td>
          <td><input inputmode="decimal" data-id="${acc.id}" value="${currentValue}" placeholder="0,00"/></td>
          <td data-delta="${acc.id}"><span class="muted">â€”</span></td>
          <td><button class="btn danger" data-del="${acc.id}">UsuÅ„</button></td>
        `;
        const input = tr.querySelector('input');
        const deltaCell = tr.querySelector('[data-delta]');
        const updateRow = () => {
          const raw = input.value.trim() === '' ? null : num(input.value);
          if(raw === null){
            deltaCell.innerHTML = '<span class="muted">â€”</span>';
          } else {
            const baseline = previousBalance ?? 0;
            deltaCell.innerHTML = renderDeltaBadge(raw - baseline);
          }
          updateTotal();
        };
        updateFns.push(updateRow);
        input.addEventListener('input', updateRow);
        tr.querySelector('button[data-del]').onclick = () => {
          const used = (b().transactions || []).some(t => t.accountId === acc.id);
          if(used){ alert('Nie moÅ¼na usunÄ…Ä‡: konto ma powiÄ…zane transakcje.'); return; }
          if(!confirm('UsunÄ…Ä‡ konto i powiÄ…zane salda EOM?')) return;
          state.modules.budget.accounts = (b().accounts || []).filter(x => x.id !== acc.id);
          state.modules.budget.eom = (b().eom || []).filter(e => e.accountId !== acc.id);
          save(state);
          renderAll();
        };
        tbody.appendChild(tr);
      }
    }

    updateFns.forEach(fn => fn());
    updateTotal();
    bindMoneyInputs(tbody);

    const saveBtn = document.getElementById('eom-save');
    if(saveBtn){
      saveBtn.onclick = () => {
        const inputs = Array.from(tbody.querySelectorAll('input'));
        for(const inp of inputs){
          const accountId = inp.dataset.id;
          const raw = inp.value.trim();
          state.modules.budget.eom = (b().eom || []).filter(e => !(e.ym === ym && e.accountId === accountId));
          if(raw !== ''){
            const bal = num(inp.value) || 0;
            state.modules.budget.eom.push({ ym, accountId, balance: bal });
          }
        }
        save(state);
        renderEOM();
        renderEOMHistory();
      };
    }

    const copyBtn = document.getElementById('eom-copy-last');
    if(copyBtn){
      copyBtn.onclick = () => {
        for(const row of rows){
          const history = ctx.accountHistory[row.acc.id] || [];
          const source = lastEntryBefore(history, ym) || history[history.length - 1];
          if(!source) continue;
          const input = tbody.querySelector(`input[data-id="${row.acc.id}"]`);
          if(input){
            input.value = String(source.balance).replace('.',',');
            input.dispatchEvent(new Event('input', { bubbles:true }));
          }
        }
      };
    }

    const resetBtn = document.getElementById('eom-reset-inputs');
    if(resetBtn){
      resetBtn.onclick = () => {
        tbody.querySelectorAll('input').forEach(inp => {
          inp.value = '';
          inp.dispatchEvent(new Event('input', { bubbles:true }));
        });
      };
    }

    renderEOMHistory();
  }

  function renderEOMHistory(){
    const ctx = buildEomContext();
    const select = document.getElementById('eom-history-months');
    let limitValue = select ? select.value : '6';
    if(select && !select.dataset.bound){
      select.dataset.bound = '1';
      select.addEventListener('change', renderEOMHistory);
    }
    const months = ctx.months;
    const monthsToShow = !months.length
      ? []
      : (limitValue === 'all' ? months : months.slice(-Number(limitValue || 6)));

    if(!months.length){
      renderEomKpis(ctx, []);
      renderEomInsights(ctx, []);
      renderEomHistoryTable(ctx, []);
      renderEomChangeTable(ctx, []);
      renderEomMonthlySummary([]);
      destroyEomChart('netWorth');
      destroyEomChart('accounts');
      return;
    }

    const focusTarget = ctx.focusMonth || ctx.latestMonth || months[months.length - 1];
    const accountStats = computeAccountStatsForMonth(ctx, focusTarget);
    const monthlySummary = computeMonthlySummary(ctx);

    renderEomKpis(ctx, accountStats);
    renderEomInsights(ctx, monthlySummary);
    renderEomHistoryTable(ctx, monthsToShow);
    renderEomChangeTable(ctx, accountStats);
    renderEomMonthlySummary(monthlySummary.filter(row => monthsToShow.includes(row.ym)));
    renderEomNetWorthChart(ctx, monthsToShow);
    renderEomAccountsChart(ctx, monthsToShow);
  }

  const DAY_MS = 1000*60*60*24;

  function setDefaultDateForAlloc() {
    const dateInput = document.querySelector('#alloc-form input[name="date"]');
    if (dateInput && !dateInput.value) {
        dateInput.value = new Date().toISOString().slice(0, 10);
    }
  }

  function renderAllocSelect(){
    const sel=document.querySelector('#alloc-form select[name="goalId"]'); if(!sel) return;
    sel.innerHTML=''; for(const g of (b().goals||[])){ sel.add(new Option(g.name,g.id)); }
  }

  // --- Analytics Helpers ---
  const ANALYTICS_STATE_KEY='lifeos_budget_filters_v1';
  let analyticsUiState = loadAnalyticsUiState();
  const analyticsCharts={};
  const eomCharts={};
  const eomUiState={
    changeSort:{field:'delta',dir:'desc'},
    monthlySort:{field:'ym',dir:'desc'}
  };
  const ANALYTICS_COLORS=['#0ea5e9','#ef4444','#16a34a','#f97316','#8b5cf6','#14b8a6','#facc15','#6366f1','#0f172a'];

  function loadAnalyticsUiState(){
    try{
      const raw=localStorage.getItem(ANALYTICS_STATE_KEY);
      if(!raw) return {selectedCategoryIds:[],sortField:'total',sortDir:'desc',searchTerm:'',selectedMonths:null};
      const parsed=JSON.parse(raw);
      return {
        selectedCategoryIds:Array.isArray(parsed?.selectedCategoryIds)?parsed.selectedCategoryIds:[],
        sortField:typeof parsed?.sortField==='string'?parsed.sortField:'total',
        sortDir:parsed?.sortDir==='asc'?'asc':'desc',
        searchTerm:typeof parsed?.searchTerm==='string'?parsed.searchTerm:'',
        selectedMonths:Array.isArray(parsed?.selectedMonths)?parsed.selectedMonths:null
      };
    }catch(err){
      console.warn('Nie moÅ¼na odczytaÄ‡ ustawieÅ„ analityki',err);
      return {selectedCategoryIds:[],sortField:'total',sortDir:'desc',searchTerm:'',selectedMonths:null};
    }
  }
  function saveAnalyticsUiState(){
    try{localStorage.setItem(ANALYTICS_STATE_KEY,JSON.stringify(analyticsUiState));}catch(err){console.warn('Nie moÅ¼na zapisaÄ‡ ustawieÅ„ analityki',err);}
  }
  function analyticsExpenseCategories(){
    return (b().categories||[]).filter(c=>c.type==='expense'||c.type==='saving');
  }
  function getActiveAnalyticsCategoryIds(expenseCats=analyticsExpenseCategories()){
    const valid=(analyticsUiState?.selectedCategoryIds||[]).filter(id=>expenseCats.some(c=>c.id===id));
    return valid.length?valid:expenseCats.map(c=>c.id);
  }
  function setAnalyticsSelectedCategories(ids){
    analyticsUiState.selectedCategoryIds=Array.from(new Set(ids));
    saveAnalyticsUiState();
  }
  function setAnalyticsSelectedMonths(months){
    const unique=Array.from(new Set(Array.isArray(months)?months:[])).sort();
    analyticsUiState.selectedMonths=unique;
    saveAnalyticsUiState();
  }
  function getAnalyticsAvailableMonths(){
    const months=new Set();
    (b().transactions||[]).forEach(t=>{if(t?.date) months.add(t.date.slice(0,7));});
    if(b().monthly){
      Object.keys(b().monthly).forEach(ym=>months.add(ym));
    }
    return Array.from(months).sort();
  }
  function defaultAnalyticsMonths(allMonths){
    if(!allMonths.length) return [];
    const current=b().workingMonth;
    if(current && allMonths.includes(current)) return [current];
    return [allMonths[allMonths.length-1]];
  }
  function getAnalyticsSelectedMonths(allMonths){
    const currentRaw=Array.isArray(analyticsUiState.selectedMonths)?analyticsUiState.selectedMonths:[];
    const currentSorted=[...currentRaw].sort();
    let valid=currentRaw.filter(m=>allMonths.includes(m));
    if(valid.length===0 && allMonths.length>0){
      valid=defaultAnalyticsMonths(allMonths);
    }
    const normalized=Array.from(new Set(valid)).sort();
    const changed=normalized.length!==currentSorted.length || normalized.some((m,i)=>m!==currentSorted[i]);
    if(changed){
      analyticsUiState.selectedMonths=normalized;
      saveAnalyticsUiState();
    }
    return normalized;
  }
  function ensureAnalyticsSortDefaults(){
    if(!analyticsUiState.sortField) analyticsUiState.sortField='total';
    if(!['asc','desc'].includes(analyticsUiState.sortDir)) analyticsUiState.sortDir='desc';
  }
  function destroyAnalyticsChart(key){
    if(analyticsCharts[key]){analyticsCharts[key].destroy(); delete analyticsCharts[key];}
  }
  function calcMedian(values){
    if(!values||!values.length) return 0;
    const sorted=[...values].sort((a,b)=>a-b);
    const mid=Math.floor(sorted.length/2);
    return sorted.length%2?sorted[mid]:(sorted[mid-1]+sorted[mid])/2;
  }
  function formatTrend(amount, percent, type){
    if(!amount && !percent) return '<span class="delta-neutral">â€”</span>';
    const isPositive=amount>0;
    const good=type==='saving';
    const cls=isPositive?(good?'delta-up':'delta-down'):(good?'delta-down':'delta-up');
    const arrow=isPositive?'â–²':'â–¼';
    const pctText=percent?` (${percent>0?'+':''}${percent.toFixed(1)}%)`:'';
    return `<span class="${cls}">${arrow} ${fmt(amount, state.currency)}${pctText}</span>`;
  }
  function formatCountTrend(delta, prevCount, type){
    if(!delta) return '<span class="delta-neutral">â€”</span>';
    const isPositive=delta>0;
    const good=type==='saving';
    const cls=isPositive?(good?'delta-up':'delta-down'):(good?'delta-down':'delta-up');
    const arrow=isPositive?'â–²':'â–¼';
    const pct=prevCount?Math.abs(delta/prevCount)*100:0;
    const pctText=pct?` (${delta>0?'+':''}${pct.toFixed(0)}%)`:'';
    return `<span class="${cls}">${arrow} ${delta>0?'+':''}${delta}${pctText}</span>`;
  }
  function heatColor(ratio){
    if(!Number.isFinite(ratio)||ratio===0) return 'transparent';
    if(ratio>=1.5) return '#fee2e2';
    if(ratio>=1.15) return '#ffedd5';
    if(ratio>=0.9) return '#f8fafc';
    if(ratio>=0.65) return '#dcfce7';
    return '#dbeafe';
  }
  function withAlpha(hex,alpha){
    const raw=(hex||'').replace('#','');
    if(raw.length!==6){return hex;}
    const r=parseInt(raw.slice(0,2),16);
    const g=parseInt(raw.slice(2,4),16);
    const b=parseInt(raw.slice(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }
  function getVisibleTotal(chart) {
    if (!chart || !chart.getDatasetMeta) return 0;
    const meta = chart.getDatasetMeta(0);
    if (!meta || !meta.data) return 0;
    let visibleTotal = 0;
    for (let i = 0; i < meta.data.length; i++) {
        if (chart.getDataVisibility(i)) {
            visibleTotal += chart.data.datasets[0].data[i];
        }
    }
    return visibleTotal;
  }

  // --- Analytics --------------------------------------------------------------
  function renderAnalyticsMonthPicker(allMonths, selectedMonths){
    const container=document.getElementById('analytics-month-picker');
    const summary=document.getElementById('analytics-month-summary');
    const quick=document.getElementById('analytics-month-quick');
    if(!container) return;

    container.innerHTML='';

    if(!allMonths.length){
      if(summary){
        summary.textContent='Brak danych historycznych. Dodaj transakcje lub przychody, aby rozpoczÄ…Ä‡ analizÄ™.';
      }
      if(quick){ quick.style.display='none'; }
      return;
    }

    if(quick){ quick.style.display='flex'; }

    const selectedSet=new Set(selectedMonths);
    const monthsForDisplay=[...allMonths].sort().reverse();
    monthsForDisplay.forEach(ym=>{
      const chip=document.createElement('button');
      chip.type='button';
      chip.className='analytics-month-chip'+(selectedSet.has(ym)?' active':'');
      chip.textContent=ym;
      chip.onclick=()=>{
        const current=getAnalyticsSelectedMonths(allMonths);
        const next=new Set(current);
        if(next.has(ym)){
          if(next.size===1) return;
          next.delete(ym);
        }else{
          next.add(ym);
        }
        setAnalyticsSelectedMonths(Array.from(next));
        renderAnalytics();
      };
      container.appendChild(chip);
    });

    if(summary){
      if(selectedMonths.length<=1){
        const ym=selectedMonths[0]||'â€”';
        summary.textContent=`Wybrany miesiÄ…c: ${ym}. Dodaj kolejne, aby zobaczyÄ‡ porÃ³wnania.`;
      }else{
        const first=selectedMonths[0];
        const last=selectedMonths[selectedMonths.length-1];
        const prev=selectedMonths[selectedMonths.length-2];
        summary.textContent=`Wybrane miesiÄ…ce: ${selectedMonths.length} (${first} â†’ ${last}). PorÃ³wnania MoM: ${last} vs ${prev}.`;
      }
    }

    if(quick){
      quick.querySelectorAll('button[data-range]').forEach(btn=>{
        btn.onclick=()=>{
          const range=btn.dataset.range;
          let selection=[];
          switch(range){
            case 'current':{
              const current=b().workingMonth;
              if(current && allMonths.includes(current)) selection=[current];
              else selection=defaultAnalyticsMonths(allMonths);
              break;
            }
            case 'last3':
              selection=allMonths.slice(-3);
              break;
            case 'last6':
              selection=allMonths.slice(-6);
              break;
            case 'year':{
              const workingYear=(b().workingMonth||'').slice(0,4);
              if(workingYear){ selection=allMonths.filter(m=>m.startsWith(workingYear)); }
              if(!selection.length){
                const nowYear=String(new Date().getFullYear());
                selection=allMonths.filter(m=>m.startsWith(nowYear));
              }
              if(!selection.length){ selection=allMonths.slice(-12); }
              break;
            }
            case 'all':
              selection=[...allMonths];
              break;
            default:
              selection=defaultAnalyticsMonths(allMonths);
          }
          if(!selection.length){ selection=defaultAnalyticsMonths(allMonths); }
          setAnalyticsSelectedMonths(selection);
          renderAnalytics();
        };
      });
    }
  }

  function renderAnalyticsFilterPanel(expenseCats, categoryStats, totalExpense) {
    const list = document.getElementById('analytics-category-filter-list');
    const searchInput = document.getElementById('analytics-category-search');
    const summary = document.getElementById('analytics-filter-summary');
    if(!list || !searchInput || !summary) return;

    const selectedIds = getActiveAnalyticsCategoryIds(expenseCats);
    const searchTerm = (analyticsUiState.searchTerm||'').toLowerCase();
    searchInput.value = analyticsUiState.searchTerm || '';

    const buttons = {
      all: document.getElementById('analytics-select-all'),
      none: document.getElementById('analytics-select-none'),
      expense: document.getElementById('analytics-select-expense'),
      savings: document.getElementById('analytics-select-savings'),
      top5: document.getElementById('analytics-select-top5')
    };

    if(buttons.all){
      buttons.all.onclick=()=>{setAnalyticsSelectedCategories(expenseCats.map(c=>c.id)); renderAnalytics();};
    }
    if(buttons.none){
      buttons.none.onclick=()=>{setAnalyticsSelectedCategories([]); renderAnalytics();};
    }
    if(buttons.expense){
      buttons.expense.onclick=()=>{setAnalyticsSelectedCategories(expenseCats.filter(c=>c.type==='expense').map(c=>c.id)); renderAnalytics();};
    }
    if(buttons.savings){
      buttons.savings.onclick=()=>{setAnalyticsSelectedCategories(expenseCats.filter(c=>c.type==='saving').map(c=>c.id)); renderAnalytics();};
    }
    if(buttons.top5){
      buttons.top5.onclick=()=>{
        const sorted=[...expenseCats].sort((a,b)=>{
          const at=categoryStats[a.id]?.total||0;
          const bt=categoryStats[b.id]?.total||0;
          return bt-at;
        });
        setAnalyticsSelectedCategories(sorted.slice(0,5).map(c=>c.id));
        renderAnalytics();
      };
    }

    searchInput.oninput = (e)=>{
      analyticsUiState.searchTerm = e.target.value;
      saveAnalyticsUiState();
      renderAnalyticsFilterPanel(expenseCats, categoryStats, totalExpense);
    };

    const sortedCats=[...expenseCats].sort((a,b)=>{
      const at=categoryStats[a.id]?.total||0;
      const bt=categoryStats[b.id]?.total||0;
      return bt-at;
    });

    list.innerHTML='';
    for(const cat of sortedCats){
      const label=`${cat.emoji||''} ${cat.name}`.trim();
      if(searchTerm && !label.toLowerCase().includes(searchTerm)) continue;
      const wrapper=document.createElement('label');
      wrapper.className='analytics-filter-grid-label'+(selectedIds.includes(cat.id)?' active':'');
      wrapper.classList.add('tiny');
      wrapper.innerHTML=`<input type="checkbox" class="analytics-cat-filter-cb" value="${cat.id}" ${selectedIds.includes(cat.id)?'checked':''}> <span>${cat.emoji||''} ${cat.name}</span><span class="tiny muted" style="justify-content:flex-end;">${fmt(categoryStats[cat.id]?.total||0, state.currency)}</span>`;
      const checkbox=wrapper.querySelector('input');
      checkbox.onchange=()=>{
        const next=new Set(selectedIds);
        if(checkbox.checked) next.add(cat.id); else next.delete(cat.id);
        setAnalyticsSelectedCategories(Array.from(next));
        renderAnalytics();
      };
      list.appendChild(wrapper);
    }

    const selectedTotalAmount = selectedIds.reduce((s,id)=>s+(categoryStats[id]?.total||0),0);
    const share = totalExpense>0 ? (selectedTotalAmount/totalExpense)*100 : 0;
    const other = totalExpense - selectedTotalAmount;
    summary.textContent = `Wybrane ${selectedIds.length} z ${expenseCats.length} kategorii â€¢ ${fmt(selectedTotalAmount, state.currency)} (${share.toFixed(1)}% wydatkÃ³w) â€¢ PozostaÅ‚e: ${fmt(other, state.currency)}`;
  }

  function renderAnalyticsKpis(ctx) {
    const container = document.getElementById('analytics-kpis');
    if(!container) return;
    const {
      totalIncome,
      totalExpenseAll,
      netChange,
      avgSavingsRate,
      totalSelectedExpense,
      totalSelectedCount,
      selectedAvg,
      selectedMedian,
      selectedShare,
      monthsCount,
      lastMonthSummary,
      prevMonthSummary,
      lastVsPrevAmount,
      lastVsPrevPercent,
      lastCountDelta,
      avgDelta,
      avgDeltaPct,
      selectedMood,
      largestCategory,
      selectedTypeTotals
    } = ctx;

    const avgPerMonth = monthsCount ? totalSelectedExpense / monthsCount : 0;
    const countPerMonth = monthsCount ? totalSelectedCount / monthsCount : 0;
    const largestName = largestCategory ? `${largestCategory.category?.emoji||''} ${largestCategory.category?.name||'â€”'}`.trim() : 'â€”';
    const largestShare = largestCategory && totalSelectedExpense > 0 ? (largestCategory.total / totalSelectedExpense) * 100 : 0;
    const largestAvg = largestCategory && largestCategory.count ? largestCategory.total / largestCategory.count : 0;
    const totalSelectedStructure = (selectedTypeTotals?.expense || 0) + (selectedTypeTotals?.saving || 0);
    const savingsShare = totalSelectedStructure > 0 ? (selectedTypeTotals.saving / totalSelectedStructure) * 100 : 0;
    const expenseShare = totalSelectedStructure > 0 ? (selectedTypeTotals.expense / totalSelectedStructure) * 100 : 0;

    let html = `
      <div class="stat-card"><div class="muted">CaÅ‚kowity przychÃ³d</div><div class="big-number ok">${fmt(totalIncome, state.currency)}</div><div class="trend">Åšr. ${fmt(totalIncome / (monthsCount || 1), state.currency)} / miesiÄ…c</div></div>
      <div class="stat-card"><div class="muted">CaÅ‚kowite wydatki</div><div class="big-number bad">${fmt(totalExpenseAll, state.currency)}</div><div class="trend">Åšr. ${fmt(totalExpenseAll / (monthsCount || 1), state.currency)} / miesiÄ…c</div></div>
      <div class="stat-card"><div class="muted">Bilans (Netto)</div><div class="big-number ${netChange >= 0 ? 'ok' : 'bad'}">${fmt(netChange, state.currency)}</div><div class="trend">Stopa oszczÄ™dnoÅ›ci: ${avgSavingsRate.toFixed(1)}%</div></div>
      <div class="stat-card"><div class="muted">Wydatki (wybrane)</div><div class="big-number ${selectedMood === 'saving' ? 'ok' : 'bad'}">${fmt(totalSelectedExpense, state.currency)}</div><div class="trend">Åšr. ${fmt(avgPerMonth, state.currency)} / mies.</div></div>
      <div class="stat-card"><div class="muted">Transakcji (wybrane)</div><div class="big-number">${totalSelectedCount}</div><div class="trend">~${countPerMonth.toFixed(1)} / miesiÄ…c</div></div>
      <div class="stat-card"><div class="muted">Åšrednia vs mediana</div><div class="big-number">${fmt(selectedAvg, state.currency)}</div><div class="trend">Mediana: ${fmt(selectedMedian, state.currency)}</div></div>
      <div class="stat-card"><div class="muted">UdziaÅ‚ wybranych</div><div class="big-number">${selectedShare.toFixed(1)}%</div><div class="trend">PozostaÅ‚e: ${fmt(totalExpenseAll - totalSelectedExpense, state.currency)}</div></div>
      <div class="stat-card"><div class="muted">Dynamika ${lastMonthSummary?.ym || ''}</div><div class="big-number">${fmt(lastMonthSummary?.selectedTotal || 0, state.currency)}</div><div class="trend">Suma: ${formatTrend(lastVsPrevAmount, lastVsPrevPercent, selectedMood)}<br>Liczba: ${formatCountTrend(lastCountDelta, prevMonthSummary?.selectedCount || 0, selectedMood)}<br>Åšrednia: ${formatTrend(avgDelta, avgDeltaPct, selectedMood)}</div></div>
      <div class="stat-card"><div class="muted">Top kategoria</div><div class="big-number">${largestName}</div><div class="trend">${largestCategory ? `${fmt(largestCategory.total, state.currency)} (${largestShare.toFixed(1)}%) â€¢ ${largestCategory.count} Ã— ${fmt(largestAvg, state.currency)}` : 'Brak danych'}</div></div>
    `;

    if(totalSelectedStructure > 0){
      html += `<div class="stat-card"><div class="muted">Struktura wybranych</div><div class="big-number">${fmt(totalSelectedExpense, state.currency)}</div><div class="trend"><span class="insight-pill">Wydatki: ${expenseShare.toFixed(1)}%</span><span class="insight-pill">OszczÄ™dnoÅ›ci: ${savingsShare.toFixed(1)}%</span></div></div>`;
    }

    container.innerHTML = html;
  }

  function renderAnalytics(){
    const allMonths=getAnalyticsAvailableMonths();
    const selectedMonths=getAnalyticsSelectedMonths(allMonths);
    renderAnalyticsMonthPicker(allMonths, selectedMonths);

    ensureAnalyticsSortDefaults();
    const expenseCats=analyticsExpenseCategories();

    if(selectedMonths.length===0){
      const emptyStats={};
      for(const cat of expenseCats){
        emptyStats[cat.id]={
          category:cat,
          total:0,
          count:0,
          values:[],
          months:{},
          max:{amount:0,date:''},
          min:{amount:0,date:''}
        };
      }
      renderAnalyticsFilterPanel(expenseCats, emptyStats, 0);
      const message=allMonths.length? 'Wybierz miesiÄ…ce, aby zobaczyÄ‡ analizy.' : 'Brak danych historycznych do analizy.';
      const kpiBox=document.getElementById('analytics-kpis');
      if(kpiBox){kpiBox.innerHTML=`<p class='muted' style='grid-column:1 / -1; text-align:center;'>${message}</p>`;}
      const placeholder=`<tbody><tr><td class='muted' style='text-align:center;'>${message}</td></tr></tbody>`;
      ['analytics-category-summary','analytics-category-momentum','analytics-monthly-breakdown','analytics-top-transactions'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.innerHTML=placeholder;
      });
      const matrix=document.getElementById('analytics-category-trends');
      if(matrix) matrix.innerHTML=placeholder;
      ['incomeExpense','categoryShare','monthlyActivity','avgTrend','categoryLeader','categoryTrend'].forEach(key=>destroyAnalyticsChart(key));
      return;
    }

    const monthsToAnalyze=selectedMonths;
    const monthsSet=new Set(monthsToAnalyze);
    const selectedCatIds=getActiveAnalyticsCategoryIds(expenseCats);
    const selectedCatSet=new Set(selectedCatIds);
    const catsMap=catsById();

    const allEntriesInPeriod=b().transactions.filter(t=>monthsSet.has(t.date.slice(0,7)));

    const categoryStats={};
    const monthlySummaries=[];
    let totalIncome=0;
    let totalExpenseAll=0;
    let totalSelectedExpense=0;
    let totalSelectedCount=0;
    let totalEntriesAll=0;
    const selectedAmounts=[];

    monthsToAnalyze.forEach(ym=>{
      ensureMonth(ym);
      const monthIncome=b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
      totalIncome+=monthIncome;

      const monthEntries=entriesForMonth(ym);
      let monthExpense=0;
      let monthSelectedTotal=0;
      let monthSelectedCount=0;
      const monthSelectedValues=[];
      const byCategory={};

      monthEntries.forEach(e=>{
        const cat=catsMap[e.categoryId];
        if(!cat || (cat.type!=='expense' && cat.type!=='saving')) return;
        const amount=Math.abs(e.amount);
        monthExpense+=amount;
        totalExpenseAll+=amount;
        totalEntriesAll+=1;

        let stat=categoryStats[cat.id];
        if(!stat){
          stat=categoryStats[cat.id]={
            category:cat,
            total:0,
            count:0,
            values:[],
            months:{},
            max:{amount:0,date:''},
            min:{amount:Infinity,date:''}
          };
        }
        stat.total+=amount;
        stat.count+=1;
        stat.values.push(amount);
        if(!stat.months[ym]) stat.months[ym]={total:0,count:0,values:[]};
        stat.months[ym].total+=amount;
        stat.months[ym].count+=1;
        stat.months[ym].values.push(amount);
        if(amount>stat.max.amount) stat.max={amount,date:e.date};
        if(amount<stat.min.amount) stat.min={amount,date:e.date};

        if(!byCategory[cat.id]) byCategory[cat.id]={total:0,count:0,values:[]};
        byCategory[cat.id].total+=amount;
        byCategory[cat.id].count+=1;
        byCategory[cat.id].values.push(amount);

        if(selectedCatSet.has(cat.id)){
          monthSelectedTotal+=amount;
          monthSelectedCount+=1;
          totalSelectedExpense+=amount;
          totalSelectedCount+=1;
          selectedAmounts.push(amount);
          monthSelectedValues.push(amount);
        }
      });

      monthlySummaries.push({
        ym,
        incomes:monthIncome,
        expenses:monthExpense,
        selectedTotal:monthSelectedTotal,
        selectedCount:monthSelectedCount,
        selectedAvg:monthSelectedCount ? monthSelectedTotal/monthSelectedCount : 0,
        selectedMedian:calcMedian(monthSelectedValues),
        byCategory
      });
    });

    expenseCats.forEach(cat=>{
      if(!categoryStats[cat.id]){
        categoryStats[cat.id]={
          category:cat,
          total:0,
          count:0,
          values:[],
          months:{},
          max:{amount:0,date:''},
          min:{amount:0,date:''}
        };
      }else if(categoryStats[cat.id].min.amount===Infinity){
        categoryStats[cat.id].min={amount:0,date:''};
      }
    });

    const monthsCount=monthsToAnalyze.length;
    const netChange=totalIncome-totalExpenseAll;
    const avgSavingsRate=totalIncome>0?(netChange/totalIncome)*100:0;
    const selectedAvg=totalSelectedCount?totalSelectedExpense/totalSelectedCount:0;
    const selectedMedian=calcMedian(selectedAmounts);
    const selectedShare=totalExpenseAll>0?(totalSelectedExpense/totalExpenseAll)*100:0;
    const lastMonthSummary=monthlySummaries[monthlySummaries.length-1];
    const prevMonthSummary=monthlySummaries.length>=2?monthlySummaries[monthlySummaries.length-2]:null;
    const lastVsPrevAmount=prevMonthSummary?lastMonthSummary.selectedTotal-prevMonthSummary.selectedTotal:0;
    const lastVsPrevPercent=(prevMonthSummary && prevMonthSummary.selectedTotal>0)
      ?(lastVsPrevAmount/prevMonthSummary.selectedTotal)*100
      :0;
    const lastCountDelta=prevMonthSummary?lastMonthSummary.selectedCount-prevMonthSummary.selectedCount:0;
    const lastAvg=lastMonthSummary.selectedCount?lastMonthSummary.selectedTotal/lastMonthSummary.selectedCount:0;
    const prevAvg=prevMonthSummary && prevMonthSummary.selectedCount?prevMonthSummary.selectedTotal/prevMonthSummary.selectedCount:0;
    const avgDelta=lastAvg-prevAvg;
    const avgDeltaPct=prevAvg?(avgDelta/prevAvg)*100:0;
    const selectedTypeTotals=selectedCatIds.reduce((acc,id)=>{
      const cat=categoryStats[id]?.category;
      if(!cat) return acc;
      acc[cat.type]=(acc[cat.type]||0)+(categoryStats[id]?.total||0);
      return acc;
    },{expense:0,saving:0});
    const selectedMood=selectedTypeTotals.saving>selectedTypeTotals.expense?'saving':'expense';
    const largestCategory=selectedCatIds
      .map(id=>categoryStats[id])
      .filter(Boolean)
      .sort((a,b)=>(b?.total||0)-(a?.total||0))[0]||null;

    const analyticsContext={
      months:monthsToAnalyze,
      monthlySummaries,
      categoryStats,
      selectedCatIds,
      totalSelectedExpense,
      totalSelectedCount,
      selectedAvg,
      selectedMedian,
      selectedShare,
      totalExpenseAll,
      totalIncome,
      netChange,
      avgSavingsRate,
      monthsCount,
      lastMonthSummary,
      prevMonthSummary,
      lastVsPrevAmount,
      lastVsPrevPercent,
      lastCountDelta,
      avgDelta,
      avgDeltaPct,
      selectedMood,
      largestCategory,
      allEntriesInPeriod,
      totalEntriesAll,
      selectedTypeTotals
    };

    renderAnalyticsFilterPanel(expenseCats, categoryStats, totalExpenseAll);

    renderAnalyticsKpis(analyticsContext);
    renderAnalyticsIncomeExpenseChart(monthlySummaries);
    renderAnalyticsCategoryChart(categoryStats, selectedCatIds);
    renderAnalyticsMonthlyActivityChart(monthlySummaries, analyticsContext);
    renderAnalyticsAverageTrendChart(monthlySummaries);
    renderAnalyticsCategoryLeaderChart(categoryStats, selectedCatIds);
    renderAnalyticsCategoryTrendChart(monthsToAnalyze, categoryStats, selectedCatIds);
    renderAnalyticsCategoryTrends(monthsToAnalyze, categoryStats, selectedCatIds);
    renderAnalyticsCategorySummary(analyticsContext);
    renderAnalyticsMomentumTable(analyticsContext);
    renderAnalyticsMonthlyBreakdown(analyticsContext);
    renderAnalyticsTopTransactions(analyticsContext);
  }
  function renderAnalyticsIncomeExpenseChart(monthlySummaries) {
    const canvas = document.getElementById('analytics-income-expense-chart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    destroyAnalyticsChart('incomeExpense');

    const labels = monthlySummaries.map(m => m.ym);
    const incomes = monthlySummaries.map(m => m.incomes);
    const expenses = monthlySummaries.map(m => m.expenses);
    const selected = monthlySummaries.map(m => m.selectedTotal);

    analyticsCharts.incomeExpense = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'Przychody', data: incomes, backgroundColor: 'rgba(5,150,105,0.7)', order: 2 },
                { label: 'Wydatki (wszystkie)', data: expenses, backgroundColor: 'rgba(190,18,60,0.6)', order: 1 },
                { type: 'line', label: 'Wydatki (wybrane)', data: selected, borderColor: '#0f172a', backgroundColor: 'rgba(15,23,42,0.12)', borderWidth: 2, tension: 0.3, fill: false, order: 0 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { callback: currencyTicks } }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: context => `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}`
                    }
                }
            }
        }
    });
  }

  function renderAnalyticsCategoryChart(categoryStats, selectedCatIds) {
      const canvas = document.getElementById('analytics-category-chart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      destroyAnalyticsChart('categoryShare');

      const stats = selectedCatIds.map(id => categoryStats[id]).filter(Boolean).sort((a,b) => (b?.total||0) - (a?.total||0));
      const labels = stats.map(stat => `${stat.category?.emoji||''} ${stat.category?.name||'â€”'}`.trim());
      const data = stats.map(stat => stat.total);

      analyticsCharts.categoryShare = new Chart(ctx,{
          type:'doughnut',
          data:{
              labels,
              datasets:[{
                  data,
                  backgroundColor: labels.map((_,i)=>ANALYTICS_COLORS[i % ANALYTICS_COLORS.length])
              }]
          },
          options:{
              responsive:true,
              maintainAspectRatio:false,
              plugins:{
                  tooltip:{
                      callbacks:{
                          label:function(context){
                              const chart=context.chart;
                              const visibleTotal=getVisibleTotal(chart);
                              const value=context.raw;
                              const percentage=visibleTotal>0?((value/visibleTotal)*100).toFixed(1)+'%':'0%';
                              return `${context.label}: ${fmt(value, state.currency)} (${percentage})`;
                          }
                      }
                  },
                  legend:{
                      position:'top',
                      labels:{
                          generateLabels:function(chart){
                              const data=chart.data;
                              if(data.labels.length && data.datasets.length){
                                  const visibleTotal=getVisibleTotal(chart);
                                  return data.labels.map((label,i)=>{
                                      const meta=chart.getDatasetMeta(0);
                                      const style=meta.controller.getStyle(i);
                                      const value=data.datasets[0].data[i];
                                      const hidden=!chart.getDataVisibility(i);
                                      const percentage=!hidden && visibleTotal>0?((value/visibleTotal)*100).toFixed(1)+'%':'0%';
                                      return {
                                          text:`${label} (${!hidden ? percentage : 'ukryte'})`,
                                          fillStyle:style.backgroundColor,
                                          strokeStyle:style.borderColor,
                                          lineWidth:style.borderWidth,
                                          hidden:hidden,
                                          index:i
                                      };
                                  });
                              }
                              return [];
                          }
                      }
                  }
              }
          }
      });
  }
  
  function renderAnalyticsMonthlyActivityChart(monthlySummaries, ctx) {
    const canvas = document.getElementById('analytics-monthly-activity-chart');
    if(!canvas) return;
    const chartCtx = canvas.getContext('2d');
    destroyAnalyticsChart('monthlyActivity');

    const labels = monthlySummaries.map(m => m.ym);
    const totals = monthlySummaries.map(m => m.selectedTotal);
    const counts = monthlySummaries.map(m => m.selectedCount);
    const averages = monthlySummaries.map(m => m.selectedAvg);
    const barColor = ctx?.selectedMood === 'saving' ? 'rgba(5,150,105,0.65)' : 'rgba(190,18,60,0.65)';

    analyticsCharts.monthlyActivity = new Chart(chartCtx, {
        data: {
            labels,
            datasets: [
                { type:'bar', label:'Suma wydatkÃ³w (wybrane)', data: totals, backgroundColor: barColor, borderRadius:6, yAxisID:'y' },
                { type:'line', label:'Liczba transakcji', data: counts, borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,0.15)', borderWidth:2, tension:0.3, yAxisID:'y1', fill:false },
                { type:'line', label:'Åšrednia kwota', data: averages, borderColor:'#0f172a', backgroundColor:'rgba(15,23,42,0.1)', borderDash:[6,4], tension:0.3, yAxisID:'y' }
            ]
        },
        options: {
            responsive:true,
            maintainAspectRatio:false,
            scales: {
                y: { beginAtZero:true, ticks:{ callback: currencyTicks } },
                y1: { beginAtZero:true, position:'right', grid:{ drawOnChartArea:false }, ticks:{ precision:0 } }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: context => {
                            if(context.dataset.label === 'Liczba transakcji'){
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            }
                            return `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}`;
                        }
                    }
                }
            }
        }
    });
  }

  function renderAnalyticsAverageTrendChart(monthlySummaries) {
    const canvas = document.getElementById('analytics-avg-trend-chart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    destroyAnalyticsChart('avgTrend');

    const labels = monthlySummaries.map(m => m.ym);
    const averages = monthlySummaries.map(m => m.selectedAvg);
    const medians = monthlySummaries.map(m => m.selectedMedian);

    analyticsCharts.avgTrend = new Chart(ctx, {
        type:'line',
        data:{
            labels,
            datasets:[
                { label:'Åšrednia kwota', data: averages, borderColor:'#0f172a', backgroundColor:'rgba(15,23,42,0.12)', borderWidth:2, tension:0.3, fill:false },
                { label:'Mediana', data: medians, borderColor:'#8b5cf6', backgroundColor:'rgba(139,92,246,0.15)', borderWidth:2, tension:0.3, fill:false }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{ y:{ beginAtZero:true, ticks:{ callback: currencyTicks } } },
            plugins:{ tooltip:{ callbacks:{ label: context => `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}` } } }
        }
    });
  }

  function renderAnalyticsCategoryLeaderChart(categoryStats, selectedCatIds) {
    const canvas = document.getElementById('analytics-category-leader-chart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    destroyAnalyticsChart('categoryLeader');

    const stats = selectedCatIds.map(id => categoryStats[id]).filter(Boolean).sort((a,b)=> (b?.total||0)-(a?.total||0)).slice(0,6);
    const labels = stats.map(stat => `${stat.category?.emoji||''} ${stat.category?.name||'â€”'}`.trim());
    const totals = stats.map(stat => stat.total);
    const counts = stats.map(stat => stat.count);
    const averages = stats.map(stat => stat.count ? stat.total / stat.count : 0);

    analyticsCharts.categoryLeader = new Chart(ctx,{
        data:{
            labels,
            datasets:[
                { type:'bar', label:'Suma', data: totals, backgroundColor:'rgba(190,18,60,0.6)', yAxisID:'y', borderRadius:6 },
                { type:'bar', label:'Liczba transakcji', data: counts, backgroundColor:'rgba(14,165,233,0.35)', yAxisID:'y1', borderRadius:6 },
                { type:'line', label:'Åšrednia kwota', data: averages, borderColor:'#0f172a', backgroundColor:'rgba(15,23,42,0.1)', yAxisID:'y', borderWidth:2, tension:0.3, fill:false }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{
                y:{ beginAtZero:true, ticks:{ callback: currencyTicks } },
                y1:{ beginAtZero:true, position:'right', grid:{ drawOnChartArea:false }, ticks:{ precision:0 } }
            },
            plugins:{
                tooltip:{
                    callbacks:{
                        label: context => context.dataset.label === 'Liczba transakcji'
                            ? `${context.dataset.label}: ${context.parsed.y}`
                            : `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}`
                    }
                }
            }
        }
    });
  }

  function renderAnalyticsCategoryTrendChart(months, categoryStats, selectedCatIds) {
    const canvas = document.getElementById('analytics-category-trend-chart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    destroyAnalyticsChart('categoryTrend');

    const stats = selectedCatIds.map(id => categoryStats[id]).filter(Boolean).sort((a,b)=> (b?.total||0)-(a?.total||0)).slice(0,5);
    const datasets = stats.map((stat,idx)=>({
        label: `${stat.category?.emoji||''} ${stat.category?.name||'â€”'}`.trim(),
        data: months.map(ym => stat.months[ym]?.total || 0),
        borderColor: ANALYTICS_COLORS[idx % ANALYTICS_COLORS.length],
        backgroundColor: withAlpha(ANALYTICS_COLORS[idx % ANALYTICS_COLORS.length], 0.18),
        tension: 0.3,
        fill: false,
        borderWidth: 2
    }));

    analyticsCharts.categoryTrend = new Chart(ctx,{
        type:'line',
        data:{ labels: months, datasets },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{ y:{ beginAtZero:true, ticks:{ callback: currencyTicks } } },
            plugins:{ tooltip:{ callbacks:{ label: context => `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}` } } }
        }
    });
  }

  function renderAnalyticsCategoryTrends(months, categoryStats, selectedCatIds) {
    const table = document.getElementById('analytics-category-trends');
    if(!table) return;
    const rows = selectedCatIds.map(id => categoryStats[id]).filter(Boolean);
    if(rows.length === 0){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="${months.length+1}">Brak danych dla wybranych kategorii.</td></tr></tbody>`;
        return;
    }

    let header = '<thead><tr><th>Kategoria</th>';
    months.forEach(ym => header += `<th>${ym}</th>`);
    header += '</tr></thead>';

    let body = '<tbody>';
    rows.forEach(stat => {
        const cat = stat.category;
        const avgPerMonth = stat.total / (months.length || 1);
        body += `<tr><td>${cat?.emoji||''} ${cat?.name||'â€”'}</td>`;
        months.forEach(ym => {
            const monthData = stat.months[ym] || { total:0, count:0, values:[] };
            const avg = monthData.count ? monthData.total / monthData.count : 0;
            const ratio = avgPerMonth ? monthData.total / avgPerMonth : 0;
            const bg = heatColor(ratio);
            if(monthData.total > 0){
                body += `<td style="background:${bg}">${fmt(monthData.total, state.currency)}<br><span class="tiny muted">${monthData.count} Ã— ${fmt(avg, state.currency)}</span></td>`;
            } else {
                body += `<td style="background:${bg}"><span class="muted">â€”</span></td>`;
            }
        });
        body += '</tr>';
    });
    body += '</tbody>';

    table.innerHTML = header + body;
  }

  function renderAnalyticsCategorySummary(ctx) {
    const table = document.getElementById('analytics-category-summary');
    if(!table) return;
    const { categoryStats, selectedCatIds, totalSelectedExpense, selectedMood, lastMonthSummary, prevMonthSummary } = ctx;
    const rows = selectedCatIds.map(id => categoryStats[id]).filter(Boolean).map(stat => {
        const cat = stat.category;
        const label = `${cat?.emoji||''} ${cat?.name||'â€”'}`.trim();
        const avg = stat.count ? stat.total / stat.count : 0;
        const median = calcMedian(stat.values);
        const share = totalSelectedExpense > 0 ? (stat.total / totalSelectedExpense) * 100 : 0;
        const lastYm = lastMonthSummary?.ym;
        const prevYm = prevMonthSummary?.ym;
        const lastData = lastYm ? (stat.months[lastYm] || { total:0, count:0, values:[] }) : { total:0, count:0, values:[] };
        const prevData = prevYm ? (stat.months[prevYm] || { total:0, count:0, values:[] }) : null;
        const deltaAmount = prevData ? lastData.total - prevData.total : lastData.total;
        const deltaPercent = prevData && prevData.total > 0 ? (deltaAmount / prevData.total) * 100 : 0;
        const countDelta = prevData ? lastData.count - prevData.count : lastData.count;
        const avgLast = lastData.count ? lastData.total / lastData.count : 0;
        const avgPrev = prevData && prevData.count ? prevData.total / prevData.count : 0;
        const avgDelta = avgLast - avgPrev;
        const avgDeltaPercent = avgPrev ? (avgDelta / avgPrev) * 100 : 0;
        const maxAmount = stat.max?.amount || 0;
        const maxDate = stat.max?.date || '';
        return {
            label,
            total: stat.total,
            count: stat.count,
            avg,
            median,
            share,
            deltaAmount,
            deltaPercent,
            countDelta,
            prevCount: prevData?.count || 0,
            avgDelta,
            avgDeltaPercent,
            maxAmount,
            maxDate,
            type: cat?.type || selectedMood
        };
    });

    if(rows.length === 0){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="10">Brak danych dla wybranych kategorii.</td></tr></tbody>`;
        return;
    }

    ensureAnalyticsSortDefaults();
    const sortKey = analyticsUiState.sortField || 'total';
    const sortDir = analyticsUiState.sortDir === 'asc' ? 1 : -1;
    rows.sort((a,b) => {
        if(sortKey === 'label'){
            return a.label.localeCompare(b.label,'pl',{sensitivity:'base'}) * sortDir;
        }
        const av = Number(a[sortKey] || 0);
        const bv = Number(b[sortKey] || 0);
        if(av === bv){
            return a.label.localeCompare(b.label,'pl',{sensitivity:'base'});
        }
        return (av - bv) * sortDir;
    });

    const columns = [
        { label:'Kategoria', sortKey:'label', formatter: row => row.label },
        { label:`Suma (${state.currency})`, sortKey:'total', formatter: row => fmt(row.total, state.currency) },
        { label:'Liczba', sortKey:'count', formatter: row => row.count },
        { label:'Åšrednia', sortKey:'avg', formatter: row => fmt(row.avg, state.currency) },
        { label:'Mediana', sortKey:'median', formatter: row => fmt(row.median, state.currency) },
        { label:'UdziaÅ‚', sortKey:'share', formatter: row => `${row.share.toFixed(1)}%` },
        { label:'Zmiana m/m', sortKey:'deltaAmount', formatter: row => formatTrend(row.deltaAmount, row.deltaPercent, row.type) },
        { label:'Î” liczby', sortKey:'countDelta', formatter: row => formatCountTrend(row.countDelta, row.prevCount, row.type) },
        { label:'Î” Å›redniej', sortKey:'avgDelta', formatter: row => formatTrend(row.avgDelta, row.avgDeltaPercent, row.type) },
        { label:'NajwiÄ™ksza transakcja', sortKey:'maxAmount', formatter: row => row.maxAmount ? `${fmt(row.maxAmount, state.currency)}${row.maxDate ? `<br><span class="tiny muted">${row.maxDate}</span>` : ''}` : '<span class="muted">â€”</span>' }
    ];

    let header = '<thead><tr>';
    columns.forEach(col => {
        const active = analyticsUiState.sortField === col.sortKey;
        const indicator = active ? `<span class="sort-indicator">${analyticsUiState.sortDir === 'asc' ? 'â–²' : 'â–¼'}</span>` : '';
        header += `<th${col.sortKey ? ` data-sort="${col.sortKey}"` : ''}>${col.label}${indicator}</th>`;
    });
    header += '</tr></thead>';

    let body = '<tbody>';
    rows.forEach(row => {
        body += '<tr>' + columns.map(col => `<td>${col.formatter(row)}</td>`).join('') + '</tr>';
    });
    body += '</tbody>';

    table.innerHTML = header + body;

    table.querySelectorAll('th[data-sort]').forEach(th => {
        const key = th.dataset.sort;
        th.onclick = () => {
            if(analyticsUiState.sortField === key){
                analyticsUiState.sortDir = analyticsUiState.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                analyticsUiState.sortField = key;
                analyticsUiState.sortDir = key === 'label' ? 'asc' : 'desc';
            }
            saveAnalyticsUiState();
            renderAnalyticsCategorySummary(ctx);
        };
    });
  }

  function renderAnalyticsMomentumTable(ctx) {
    const table = document.getElementById('analytics-category-momentum');
    if(!table) return;
    const { categoryStats, selectedCatIds, lastMonthSummary, prevMonthSummary, selectedMood } = ctx;
    if(!lastMonthSummary){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="7">Wybierz okres obejmujÄ…cy co najmniej jeden miesiÄ…c.</td></tr></tbody>`;
        return;
    }

    const lastYm = lastMonthSummary.ym;
    const prevYm = prevMonthSummary?.ym;
    const rows = selectedCatIds.map(id => {
        const stat = categoryStats[id];
        if(!stat) return null;
        const cat = stat.category;
        const lastData = stat.months[lastYm] || { total:0, count:0, values:[] };
        const prevData = prevYm ? (stat.months[prevYm] || { total:0, count:0, values:[] }) : null;
        const avgLast = lastData.count ? lastData.total / lastData.count : 0;
        const avgPrev = prevData && prevData.count ? prevData.total / prevData.count : 0;
        const deltaAmount = prevData ? lastData.total - prevData.total : lastData.total;
        const deltaPercent = prevData && prevData.total > 0 ? (deltaAmount / prevData.total) * 100 : 0;
        const countDelta = prevData ? lastData.count - prevData.count : lastData.count;
        const avgDelta = avgLast - avgPrev;
        const avgDeltaPercent = avgPrev ? (avgDelta / avgPrev) * 100 : 0;
        const volumeChange = prevData && prevData.total > 0 ? Math.abs(deltaAmount / prevData.total) : (lastData.total ? 1 : 0);
        const countChange = prevData && prevData.count > 0 ? Math.abs(countDelta / prevData.count) : (countDelta ? 1 : 0);
        const avgChange = avgPrev ? Math.abs(avgDelta / avgPrev) : (avgLast ? 1 : 0);
        let comment = 'Stabilnie';
        if(!prevData || (prevData.total === 0 && prevData.count === 0)) {
            comment = deltaAmount > 0 ? 'Nowa aktywnoÅ›Ä‡' : 'Brak danych porÃ³wnawczych';
        } else if(volumeChange < 0.05 && countChange < 0.05) {
            comment = 'Stabilnie';
        } else if(countChange > avgChange * 1.2) {
            comment = deltaAmount >= 0 ? 'Wzrost liczby transakcji' : 'Spadek liczby transakcji';
        } else if(avgChange > countChange * 1.2) {
            comment = deltaAmount >= 0 ? 'WyÅ¼sze kwoty' : 'NiÅ¼sze kwoty';
        } else {
            comment = deltaAmount >= 0 ? 'Wzrost mieszany' : 'Spadek mieszany';
        }
        return { cat, lastData, prevData, avgLast, avgPrev, deltaAmount, deltaPercent, countDelta, avgDelta, avgDeltaPercent, type: cat?.type || selectedMood, comment };
    }).filter(Boolean);

    if(rows.length === 0){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="7">Brak danych do porÃ³wnania.</td></tr></tbody>`;
        return;
    }

    let header = '<thead><tr><th>Kategoria</th><th>Ostatni miesiÄ…c</th><th>Poprzedni miesiÄ…c</th><th>Î” suma</th><th>Î” liczby</th><th>Î” Å›redniej</th><th>Komentarz</th></tr></thead>';
    let body = '<tbody>';
    rows.forEach(row => {
        const cat = row.cat;
        const lastCell = `${fmt(row.lastData.total, state.currency)}<br><span class="tiny muted">${row.lastData.count} Ã— ${fmt(row.avgLast, state.currency)}</span>`;
        let prevCell = '<span class="muted">â€”</span>';
        if(row.prevData){
            if(row.prevData.total > 0){
                prevCell = `${fmt(row.prevData.total, state.currency)}<br><span class="tiny muted">${row.prevData.count} Ã— ${fmt(row.avgPrev, state.currency)}</span>`;
            } else {
                prevCell = '<span class="muted">â€”</span>';
            }
        }
        body += `<tr>
            <td>${cat?.emoji||''} ${cat?.name||'â€”'}</td>
            <td>${lastCell}</td>
            <td>${prevCell}</td>
            <td>${formatTrend(row.deltaAmount, row.deltaPercent, row.type)}</td>
            <td>${formatCountTrend(row.countDelta, row.prevData?.count || 0, row.type)}</td>
            <td>${formatTrend(row.avgDelta, row.avgDeltaPercent, row.type)}</td>
            <td>${row.comment}</td>
        </tr>`;
    });
    body += '</tbody>';
    table.innerHTML = header + body;
  }

  function renderAnalyticsMonthlyBreakdown(ctx) {
    const table = document.getElementById('analytics-monthly-breakdown');
    if(!table) return;
    const { monthlySummaries, selectedCatIds, categoryStats } = ctx;
    if(!monthlySummaries || monthlySummaries.length === 0){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="9">Brak danych do wyÅ›wietlenia.</td></tr></tbody>`;
        return;
    }

    let header = '<thead><tr><th>MiesiÄ…c</th><th>Przychody</th><th>Wydatki (wszystkie)</th><th>Wybrane kategorie</th><th>Liczba transakcji</th><th>Åšrednia</th><th>Mediana</th><th>Top kategoria</th><th>Bilans</th></tr></thead>';
    let body = '<tbody>';
    monthlySummaries.forEach(summary => {
        const top = selectedCatIds.map(id => ({ id, total: summary.byCategory[id]?.total || 0, count: summary.byCategory[id]?.count || 0 })).sort((a,b)=>b.total - a.total)[0];
        let topCell = '<span class="muted">â€”</span>';
        if(top && top.total > 0){
            const stat = categoryStats[top.id];
            const cat = stat?.category;
            const share = summary.selectedTotal > 0 ? (top.total / summary.selectedTotal) * 100 : 0;
            topCell = `${cat?.emoji||''} ${cat?.name||'â€”'}<br><span class="tiny muted">${fmt(top.total, state.currency)} (${share.toFixed(1)}%)</span>`;
        }
        const net = summary.incomes - summary.expenses;
        body += `<tr>
            <td>${summary.ym}</td>
            <td>${fmt(summary.incomes, state.currency)}</td>
            <td>${fmt(summary.expenses, state.currency)}</td>
            <td>${fmt(summary.selectedTotal, state.currency)}</td>
            <td>${summary.selectedCount}</td>
            <td>${fmt(summary.selectedAvg || 0, state.currency)}</td>
            <td>${fmt(summary.selectedMedian || 0, state.currency)}</td>
            <td>${topCell}</td>
            <td class="${net >= 0 ? 'ok' : 'bad'}">${fmt(net, state.currency)}</td>
        </tr>`;
    });
    body += '</tbody>';
    table.innerHTML = header + body;
  }

  function renderAnalyticsTopTransactions(ctx) {
      const table = document.getElementById('analytics-top-transactions');
      if(!table) return;
      const tbody = document.createElement('tbody');
      table.innerHTML = `<thead><tr><th>Data</th><th>Kategoria</th><th>Kwota</th><th>Notatka</th></tr></thead>`;
      table.appendChild(tbody);

      const selectedSet = new Set(ctx.selectedCatIds);
      const catsMap = catsById();

      const flattened = [];
      (ctx.allEntriesInPeriod || []).forEach(tx => {
        const processEntry = (entry, categoryId, rawAmount, note) => {
            const cat = catsMap[categoryId];
            if(!cat || (cat.type !== 'expense' && cat.type !== 'saving')) return;
            if(selectedSet.size > 0 && !selectedSet.has(categoryId)) return;
            const amount = Math.abs(num(rawAmount));
            if(amount <= 0) return;
            flattened.push({ date: entry.date, categoryId, amount, note: note || '' });
        };

        if(tx.splits && tx.splits.length > 0) {
            tx.splits.forEach(split => processEntry(tx, split.categoryId, split.amount, tx.note));
        } else {
            processEntry(tx, tx.categoryId, tx.amount, tx.note);
        }
      });

      const top10 = flattened.sort((a,b) => b.amount - a.amount).slice(0, 10);

      if (top10.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center;">Brak wydatkÃ³w w wybranych kategoriach w tym okresie.</td></tr>`;
          return;
      }

      tbody.innerHTML = top10.map(e => {
          const cat = catsMap[e.categoryId];
          const cls = cat?.type === 'saving' ? 'ok' : 'bad';
          return `
              <tr>
                  <td>${e.date}</td>
                  <td>${cat ? (cat.emoji||'') + ' ' + cat.name : 'â€”'}</td>
                  <td class="${cls}">${fmt(e.amount, state.currency)}</td>
                  <td>${e.note || 'â€”'}</td>
              </tr>
          `;
      }).join('');
  }

  // --- MoM comparison ----------------------------------------------------------
  const MOM_COLORS={a:'#0ea5e9',b:'#f97316'};
  const MOM_DIFF_COLORS={positive:'#ef4444',negative:'#22c55e',neutral:'#94a3b8'};
  const MOM_NO_FIXED_ID='__all_no_fixed';
  const MOM_NO_FIXED_LABEL='Wszystkie bez wydatkÃ³w staÅ‚ych';
  const MOM_FIXED_CATEGORY_ID='c_fixed';
  const momState={
    monthA:null,
    monthB:null,
    day:Math.min(31,Math.max(1,new Date().getDate())),
    selectedCategory:'__all'
  };
  let momChart=null;
  let momDiffChart=null;
  let momLastContext=null;

  function destroyMomChart(){
    if(momChart){momChart.destroy(); momChart=null;}
  }

  function destroyMomDiffChart(){
    if(momDiffChart){momDiffChart.destroy(); momDiffChart=null;}
  }

  function ensureMomState(months){
    const sorted=[...months].sort();
    if(sorted.length===0){
      momState.monthA=null;
      momState.monthB=null;
      momState.selectedCategory='__all';
      return;
    }

    const workingMonth=b().workingMonth;
    if(!sorted.includes(momState.monthA)){
      if(workingMonth && sorted.includes(workingMonth)) momState.monthA=workingMonth;
      else momState.monthA=sorted[sorted.length-1];
    }

    if(!sorted.includes(momState.monthB)){
      const base=sorted.includes(momState.monthA)?momState.monthA:sorted[sorted.length-1];
      const desiredPrev=base?ymAdd(base,-1):null;
      if(desiredPrev && sorted.includes(desiredPrev)) momState.monthB=desiredPrev;
      else {
        const idx=sorted.indexOf(base);
        if(idx>0) momState.monthB=sorted[idx-1];
        else if(sorted.length>1) momState.monthB=sorted[sorted.length-2];
        else momState.monthB=base;
      }
    }

    const rawDay=Number(momState.day);
    if(!Number.isFinite(rawDay) || rawDay<1){
      momState.day=Math.min(31,Math.max(1,new Date().getDate()));
    }else{
      momState.day=Math.min(31,Math.max(1,Math.round(rawDay)));
    }
  }

  function getMomEffectiveDay(monthA,monthB,requested){
    const values=[];
    if(Number.isFinite(requested) && requested>0) values.push(requested);
    if(monthA) values.push(daysInYm(monthA));
    if(monthB) values.push(daysInYm(monthB));
    if(!values.length) return 1;
    return Math.min(...values);
  }

  function buildMomSeries(ym,categoryIds){
    const out={ym,days:0,series:{}};
    categoryIds.forEach(id=>{out.series[id]=[];});
    if(!ym) return out;
    const days=daysInYm(ym);
    out.days=days;
    categoryIds.forEach(id=>{out.series[id]=Array(days).fill(0);});
    const catSet=new Set(categoryIds);
    const entries=entriesForMonth(ym);
    for(const entry of entries){
      const cat=catsById()[entry.categoryId];
      if(!cat || cat.type!=='expense') continue;
      if(!catSet.has(entry.categoryId)) continue;
      const day=Math.min(days,Math.max(1,Number(entry.date.slice(-2))||1));
      const idx=day-1;
      const amount=Math.abs(entry.amount);
      out.series[entry.categoryId][idx]+=amount;
      if(out.series.__all) out.series.__all[idx]+=amount;
      if(out.series[MOM_NO_FIXED_ID] && entry.categoryId!==MOM_FIXED_CATEGORY_ID){
        out.series[MOM_NO_FIXED_ID][idx]+=amount;
      }
    }
    for(const id of categoryIds){
      const arr=out.series[id];
      for(let i=1;i<arr.length;i++){arr[i]+=arr[i-1];}
    }
    return out;
  }

  function momSeriesSlice(seriesData,catId,dayLimit){
    const arr=seriesData?.series?.[catId];
    if(!arr || !arr.length) return [];
    const limit=Math.min(dayLimit,arr.length);
    return arr.slice(0,limit);
  }

  function momSeriesValue(seriesData,catId,dayLimit){
    const arr=seriesData?.series?.[catId];
    if(!arr || !arr.length) return 0;
    const idx=Math.min(dayLimit,arr.length);
    if(idx<=0) return 0;
    return arr[idx-1];
  }

  function formatMomDiff(diff){
    if(!Number.isFinite(diff) || Math.abs(diff)<0.01) return '<span class="delta-neutral">â€”</span>';
    const cls=diff>0?'delta-down':'delta-up';
    const arrow=diff>0?'â–²':'â–¼';
    return `<span class="${cls}">${arrow} ${fmt(Math.abs(diff), state.currency)}</span>`;
  }

  function formatMomPace(totalA,totalB){
    if(!Number.isFinite(totalA)) totalA=0;
    if(!Number.isFinite(totalB)) totalB=0;
    if(totalB<=0) return totalA>0?'<span class="delta-neutral">â€”</span>':'<span class="delta-neutral">â€”</span>';
    const pct=((totalA-totalB)/totalB)*100;
    if(!Number.isFinite(pct) || Math.abs(pct)<0.05) return '<span class="delta-neutral">â€”</span>';
    const cls=pct>0?'delta-down':'delta-up';
    const arrow=pct>0?'â–²':'â–¼';
    return `<span class="${cls}">${arrow} ${Math.abs(pct).toFixed(1)}%</span>`;
  }

  function momCategoryLabel(cat){
    if(!cat) return '';
    if(cat.id==='__all') return 'Wszystkie kategorie';
    const prefix=cat.emoji?cat.emoji+' ':'';
    return `${prefix}${cat.name}`;
  }

  function updateMomActiveRows(tbody){
    if(!tbody) return;
    tbody.querySelectorAll('tr').forEach(row=>{
      row.classList.toggle('active',row.dataset.catId===momState.selectedCategory);
    });
  }

  function renderMomComparison(){
    const section=document.getElementById('tab-mom');
    if(!section) return;
    const info=document.getElementById('mom-info');
    const summary=document.getElementById('mom-summary');
    const selectA=document.getElementById('mom-month-a');
    const selectB=document.getElementById('mom-month-b');
    const dayInput=document.getElementById('mom-day-input');
    const tableBody=document.querySelector('#mom-table tbody');
    const colA=document.getElementById('mom-col-a');
    const colB=document.getElementById('mom-col-b');
    const emptyChart=document.getElementById('mom-chart-empty');
    const chartCanvas=document.getElementById('mom-chart');
    const caption=document.getElementById('mom-chart-caption');
    const diffCanvas=document.getElementById('mom-diff-chart');
    const diffEmpty=document.getElementById('mom-diff-empty');
    const diffCaption=document.getElementById('mom-diff-caption');

    const months=getAnalyticsAvailableMonths();
    ensureMomState(months);

    if(selectA){
      selectA.innerHTML='';
      if(months.length===0){
        selectA.disabled=true;
        selectA.add(new Option('Brak danych',''));
      }else{
        selectA.disabled=false;
        months.forEach(m=>selectA.add(new Option(m,m,false,m===momState.monthA)));
      }
      selectA.onchange=e=>{momState.monthA=e.target.value||null; renderMomComparison();};
    }
    if(selectB){
      selectB.innerHTML='';
      if(months.length===0){
        selectB.disabled=true;
        selectB.add(new Option('Brak danych',''));
      }else{
        selectB.disabled=false;
        months.forEach(m=>selectB.add(new Option(m,m,false,m===momState.monthB)));
      }
      selectB.onchange=e=>{momState.monthB=e.target.value||null; renderMomComparison();};
    }
    if(dayInput){
      dayInput.disabled=months.length===0;
      dayInput.value=momState.day;
      dayInput.onchange=e=>{
        const raw=Number(e.target.value);
        if(!Number.isFinite(raw)){
          e.target.value=momState.day;
          return;
        }
        momState.day=Math.min(31,Math.max(1,Math.round(raw)));
        renderMomComparison();
      };
    }

    if(months.length===0){
      if(info) info.textContent='Brak danych do porÃ³wnania. Dodaj transakcje, aby rozpoczÄ…Ä‡ analizÄ™.';
      if(summary){summary.style.display='none'; summary.textContent='';}
      if(colA) colA.textContent='MiesiÄ…c A';
      if(colB) colB.textContent='MiesiÄ…c B';
      if(tableBody) tableBody.innerHTML='<tr><td colspan="5" class="muted" style="text-align:center;">Brak danych do wyÅ›wietlenia.</td></tr>';
      momLastContext=null;
      destroyMomChart();
      destroyMomDiffChart();
      if(chartCanvas) chartCanvas.style.display='none';
      if(emptyChart) emptyChart.style.display='flex';
      if(caption) caption.textContent='';
      if(diffCanvas) diffCanvas.style.display='none';
      if(diffEmpty) diffEmpty.style.display='flex';
      if(diffCaption) diffCaption.textContent='';
      return;
    }

    const effectiveDay=getMomEffectiveDay(momState.monthA,momState.monthB,Number(momState.day));

    if(info) info.textContent='PorÃ³wnuj tempo wydatkÃ³w w dwÃ³ch miesiÄ…cach roku.';
    if(summary){
      const requested=Number(momState.day);
      summary.style.display='block';
      const base=`PorÃ³wnanie do dnia ${String(effectiveDay).padStart(2,'0')}.`;
      summary.textContent = effectiveDay !== requested ? `${base} Dopasowano do liczby dni krÃ³tszego miesiÄ…ca.` : base;
    }
    if(colA) colA.textContent = momState.monthA ? `MiesiÄ…c A (${momState.monthA})` : 'MiesiÄ…c A';
    if(colB) colB.textContent = momState.monthB ? `MiesiÄ…c B (${momState.monthB})` : 'MiesiÄ…c B';

    const expenseCats=(b().categories||[]).filter(c=>c.type==='expense');
    const categories=[
      {id:'__all',name:'Wszystkie kategorie',emoji:'ğŸ“Š'},
      {id:MOM_NO_FIXED_ID,name:MOM_NO_FIXED_LABEL,emoji:'ğŸ§¾'}
    ];
    for(const cat of expenseCats){
      categories.push({id:cat.id,name:cat.name,emoji:cat.emoji||''});
    }
    if(!categories.some(c=>c.id===momState.selectedCategory)){
      momState.selectedCategory='__all';
    }

    const catIds=categories.map(c=>c.id);
    const monthAData=buildMomSeries(momState.monthA,catIds);
    const monthBData=buildMomSeries(momState.monthB,catIds);

    const rows=categories.map(cat=>{
      const totalA=momSeriesValue(monthAData,cat.id,effectiveDay);
      const totalB=momSeriesValue(monthBData,cat.id,effectiveDay);
      return {cat,totalA,totalB,diff:totalA-totalB};
    });
    const overall=rows.shift();
    const others=rows.sort((a,b)=>b.totalA-a.totalA);
    const ordered=overall?[overall,...others]:others;

    if(tableBody){
      tableBody.innerHTML='';
      ordered.forEach(row=>{
        const tr=document.createElement('tr');
        tr.dataset.catId=row.cat.id;
        const label=momCategoryLabel(row.cat);
        tr.innerHTML=`<td>${label}</td><td>${fmt(row.totalA, state.currency)}</td><td>${fmt(row.totalB, state.currency)}</td><td>${formatMomDiff(row.diff)}</td><td>${formatMomPace(row.totalA,row.totalB)}</td>`;
        tr.addEventListener('click',()=>{momState.selectedCategory=row.cat.id; updateMomActiveRows(tableBody); updateMomChart();});
        tableBody.appendChild(tr);
      });
      updateMomActiveRows(tableBody);
    }

    momLastContext={categories,monthA:momState.monthA,monthB:momState.monthB,dayLimit:effectiveDay,monthAData,monthBData};
    updateMomChart();
  }

  function updateMomChart(){
    const canvas=document.getElementById('mom-chart');
    const empty=document.getElementById('mom-chart-empty');
    const caption=document.getElementById('mom-chart-caption');
    const diffCanvas=document.getElementById('mom-diff-chart');
    const diffEmpty=document.getElementById('mom-diff-empty');
    const diffCaption=document.getElementById('mom-diff-caption');
    if(!canvas || !diffCanvas){
      destroyMomChart();
      destroyMomDiffChart();
      return;
    }
    if(!momLastContext){
      destroyMomChart();
      destroyMomDiffChart();
      if(empty) empty.style.display='flex';
      canvas.style.display='none';
      if(caption) caption.textContent='';
      if(diffEmpty) diffEmpty.style.display='flex';
      diffCanvas.style.display='none';
      if(diffCaption) diffCaption.textContent='';
      return;
    }
    const {categories,monthA,monthB,dayLimit,monthAData,monthBData}=momLastContext;
    const selected=categories.find(c=>c.id===momState.selectedCategory)||categories[0];
    const seriesA=momSeriesSlice(monthAData,selected.id,dayLimit);
    const seriesB=momSeriesSlice(monthBData,selected.id,dayLimit);
    const maxLen=Math.max(seriesA.length,seriesB.length);
    if(maxLen===0){
      destroyMomChart();
      destroyMomDiffChart();
      if(empty) empty.style.display='flex';
      canvas.style.display='none';
      if(caption) caption.textContent='Brak danych dla wybranej kategorii.';
      if(diffEmpty) diffEmpty.style.display='flex';
      diffCanvas.style.display='none';
      if(diffCaption) diffCaption.textContent='';
      return;
    }
    const labels=Array.from({length:maxLen},(_,i)=>String(i+1).padStart(2,'0'));
    const diffSeries=labels.map((_,idx)=>{
      const valA=idx<seriesA.length?seriesA[idx]:null;
      const valB=idx<seriesB.length?seriesB[idx]:null;
      if(valA===null && valB===null) return null;
      const safeA=Number.isFinite(valA)?valA:0;
      const safeB=Number.isFinite(valB)?valB:0;
      return safeA-safeB;
    });
    canvas.style.display='block';
    diffCanvas.style.display='block';
    if(empty) empty.style.display='none';
    if(diffEmpty) diffEmpty.style.display='none';
    destroyMomChart();
    destroyMomDiffChart();
    momChart=new Chart(canvas.getContext('2d'),{
      type:'line',
      data:{
        labels,
        datasets:[
          {label:monthA||'MiesiÄ…c A',data:seriesA,borderColor:MOM_COLORS.a,backgroundColor:withAlpha(MOM_COLORS.a,0.15),tension:0.3,fill:false,pointRadius:3,pointHoverRadius:4},
          {label:monthB||'MiesiÄ…c B',data:seriesB,borderColor:MOM_COLORS.b,backgroundColor:withAlpha(MOM_COLORS.b,0.15),tension:0.3,fill:false,pointRadius:3,pointHoverRadius:4}
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'index',intersect:false},
        plugins:{legend:{display:true}},
        scales:{
          x:{title:{display:true,text:'DzieÅ„ miesiÄ…ca'}},
          y:{beginAtZero:true,ticks:{callback:currencyTicks}}
        }
      }
    });
    const diffColors=diffSeries.map(v=>{
      if(v===null) return 'transparent';
      if(v>0) return withAlpha(MOM_DIFF_COLORS.positive,0.55);
      if(v<0) return withAlpha(MOM_DIFF_COLORS.negative,0.55);
      return withAlpha(MOM_DIFF_COLORS.neutral,0.35);
    });
    const diffBorderColors=diffSeries.map(v=>{
      if(v===null) return 'transparent';
      if(v>0) return MOM_DIFF_COLORS.positive;
      if(v<0) return MOM_DIFF_COLORS.negative;
      return MOM_DIFF_COLORS.neutral;
    });
    momDiffChart=new Chart(diffCanvas.getContext('2d'),{
      type:'bar',
      data:{
        labels,
        datasets:[{
          label:'RÃ³Å¼nica skumulowana (A âˆ’ B)',
          data:diffSeries,
          backgroundColor:diffColors,
          borderColor:diffBorderColors,
          borderWidth:1,
          borderRadius:4,
          barPercentage:0.9,
          categoryPercentage:1
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'index',intersect:false},
        plugins:{legend:{display:false}},
        scales:{
          x:{title:{display:true,text:'DzieÅ„ miesiÄ…ca'}},
          y:{beginAtZero:true,ticks:{callback:currencyTicks}}
        }
      }
    });
    if(caption){
      const label=momCategoryLabel(selected);
      caption.textContent=`Aktualnie porÃ³wnywana kategoria: ${label}.`;
    }
    if(diffCaption){
      diffCaption.textContent='WartoÅ›ci dodatnie wskazujÄ…, Å¼e miesiÄ…c A wyprzedza miesiÄ…c B (wydano wiÄ™cej).';
    }
  }


  // --- Recurring templates (variable expenses) --------------------------------
  function scheduledDateFor(tpl, ym){
    const d=Math.min(Math.max(1, Number(tpl.day)||1), daysInYm(ym));
    return `${ym}-${String(d).padStart(2,'0')}`;
  }
  function isLogged(templateId, ym){
    return (b().recurringLog||[]).some(r=>r.templateId===templateId && r.ym===ym);
  }
  function renderRecurringSuggestions(){
    const ym=b().workingMonth;
    const box=document.getElementById('rec-suggestions');
    const list=document.getElementById('rec-sugg-list');
    const monthLabel=document.getElementById('rec-sugg-month');
    monthLabel.textContent=ym;

    const candidates=(b().recurringTemplates||[])
      .map(t=>({t, date:scheduledDateFor(t,ym)}))
      .filter(x=>!isLogged(x.t.id, ym));

    if(candidates.length===0){ box.style.display='none'; }
    else{
      box.style.display='block';
      list.innerHTML='';
      for(const {t,date} of candidates){
        const summary = t.splits?.length
          ? `Split (${t.splits.length} pozycji)`
          : `${fmt(signFor(t.categoryId, num(t.amount)), state.currency)} â€¢ ${(catsById()[t.categoryId]?.name)||'â€”'}`;
        const div=document.createElement('div'); div.className='card';
        div.innerHTML=`
          <div class="row">
            <div><b>${t.label}</b> <span class="muted">(${date})</span></div>
            <div class="muted">${summary}</div>
          </div>
          <div class="row" style="margin-top:6px">
            <div class="tiny">${t.note||''}</div>
            <div style="display:flex;gap:6px">
              <button class="btn soft" data-act="add-date">Dodaj (na ${date})</button>
              <button class="btn soft" data-act="add-today">Dodaj na dziÅ›</button>
              <button class="btn danger" data-act="dismiss">OdrzuÄ‡</button>
            </div>
          </div>`;
        div.querySelector('[data-act="add-date"]').onclick=()=>applyTemplate(t,date);
        div.querySelector('[data-act="add-today"]').onclick=()=>applyTemplate(t,new Date().toISOString().slice(0,10));
        div.querySelector('[data-act="dismiss"]').onclick=()=>{b().recurringLog.push({templateId:t.id,ym,action:'dismissed'}); save(state); renderAll();};
        list.appendChild(div);
      }
    }
    document.getElementById('rec-manage-toggle').onclick=()=>{
      const m=document.getElementById('rec-manage');
      m.style.display = m.style.display==='none' ? 'block' : 'none';
      if(m.style.display==='block'){renderRecurringManage()}
    }
  }
  function applyTemplate(tpl,date){
    const txBase={id:`tx_${Math.random().toString(36).slice(2)}`,date,accountId:tpl.accountId||b().accounts[0]?.id||'a_main',note:tpl.note||tpl.label};
    if(tpl.splits?.length){
      const total=tpl.splits.reduce((s,sp)=>s+signFor(sp.categoryId,num(sp.amount)),0);
      b().transactions.unshift({...txBase,categoryId:tpl.splits[0].categoryId,amount:total,splits:tpl.splits.map(s=>({categoryId:s.categoryId,amount:num(s.amount)}))});
    }else{
      const signed=signFor(tpl.categoryId, num(t.amount));
      b().transactions.unshift({...txBase,categoryId:tpl.categoryId,amount:signed});
    }
    b().recurringLog.push({templateId:tpl.id,ym:date.slice(0,7),action:'added'});
    save(state); renderAll();
  }
  function renderRecurringManage(){
    const form=document.getElementById('rec-add-form');
    const catSel=form.querySelector('select[name="categoryId"]'); catSel.innerHTML=''; for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}
    const accSel=form.querySelector('select[name="accountId"]'); accSel.innerHTML=''; for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id))}
    const isSplit=form.querySelector('input[name="isSplit"]');
    const singleBox=form.querySelector('[data-mode="single"]');
    const splitBox=form.querySelector('[data-mode="split"]');
    isSplit.onchange=()=>{singleBox.style.display=isSplit.checked?'none':'grid'; splitBox.style.display=isSplit.checked?'block':'none'}
    const splitTbody=form.querySelector('.rec-split-rows');
    function addRow(sp){const tr=document.createElement('tr'); tr.className='rec-split-row'; tr.innerHTML=`<td><select class="sp-cat"></select></td><td><input class="sp-amt" inputmode="decimal" value="${sp?String(sp.amount).replace('.',','):''}" /></td><td><button class="btn danger" type="button">X</button></td>`; const sel=tr.querySelector('.sp-cat'); for(const c of (b().categories||[])){sel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id,false, sp?sp.categoryId===c.id:false))} tr.querySelector('button').onclick=()=>{tr.remove()}; splitTbody.appendChild(tr); bindMoneyInputs(tr);}
    document.getElementById('rec-split-add').onclick=()=>addRow();
    form.onsubmit=(e)=>{
      e.preventDefault();
      const f=new FormData(form);
      const label=String(f.get('label')); const day=Number(f.get('day'));
      const accountId=String(f.get('accountId')||b().accounts[0]?.id||'a_main'); const note=String(f.get('note')||'');
      if(isSplit.checked){
        const rows=Array.from(splitTbody.querySelectorAll('.rec-split-row')); if(rows.length===0){alert('Dodaj wiersze split.'); return;}
        const splits=[]; for(const r of rows){const cat=r.querySelector('.sp-cat').value; const amt=num(r.querySelector('.sp-amt').value); if(!cat || !amt){alert('UzupeÅ‚nij kategoriÄ™ i kwotÄ™ w kaÅ¼dym wierszu.'); return;} splits.push({categoryId:cat, amount:amt});}
        b().recurringTemplates.push({id:'rt_'+Math.random().toString(36).slice(2),label,day,accountId,note,splits});
      }else{
        const categoryId=String(f.get('categoryId')); const amount=num(f.get('amount')); if(!categoryId || !amount){alert('UzupeÅ‚nij kategoriÄ™ i kwotÄ™.'); return;}
        b().recurringTemplates.push({id:'rt_'+Math.random().toString(36).slice(2),label,day,accountId,categoryId,amount,note});
      }
      save(state); form.reset(); splitTbody.innerHTML=''; singleBox.style.display='grid'; splitBox.style.display='none'; isSplit.checked=false; renderRecurringManage();
    };
    const tbody=document.getElementById('rec-rows'); tbody.innerHTML='';
    for(const t of (b().recurringTemplates||[])){
      const mode=t.splits?.length?'split':'single';
      const summary = t.splits?.length ? t.splits.map(s=>`${(catsById()[s.categoryId]?.name)||'â€”'}: ${fmt(num(s.amount),state.currency)}`).join(' | ') : `${fmt(signFor(t.categoryId,num(t.amount)),state.currency)} â€¢ ${(catsById()[t.categoryId]?.name)||'â€”'}`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.label}</td><td>${t.day}</td><td>${mode}</td><td>${summary||'â€”'}</td><td>${(b().accounts||[]).find(a=>a.id===t.accountId)?.name||'â€”'}</td><td>${t.note||''}</td><td><button class="btn danger">UsuÅ„</button></td>`;
      tr.querySelector('.btn').onclick=()=>{ if(!confirm('UsunÄ…Ä‡ szablon cykliczny?')) return; b().recurringTemplates=(b().recurringTemplates||[]).filter(x=>x.id!==t.id); b().recurringLog=(b().recurringLog||[]).filter(x=>x.templateId!==t.id); save(state); renderRecurringManage(); };
      tbody.appendChild(tr);
    }
    bindMoneyInputs(form);
  }

  // --- Safe render orchestrator ----------------------------------------------
  function safeRender(fn, name){ try{ fn(); } catch(err){ console.error('Render error:', name, err); } }

  function renderIncomes(){
    const ym=b().workingMonth; ensureMonth(ym);
    document.getElementById('inc-month').textContent=ym;
    const tbody=document.getElementById('inc-rows');tbody.innerHTML='';
    const sum=b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
    document.getElementById('inc-sum').textContent=fmt(sum,state.currency);
    for(const r of b().monthly[ym].incomes){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmt(r.amount,state.currency)}</td><td>${r.note||''}</td><td><button data-id="${r.id}" class="btn danger">UsuÅ„</button></td>`;
      tr.querySelector('button').onclick=()=>{ if(!confirm('Na pewno usunÄ…Ä‡ ten przychÃ³d?')) return; b().monthly[ym].incomes=b().monthly[ym].incomes.filter(x=>x.id!==r.id); save(state); renderAll(); };
      tbody.appendChild(tr);
    }
  }

  function renderFixed(){
    const ym=b().workingMonth; ensureMonth(ym);
    document.getElementById('fix-month').textContent=ym;
    
    // NEW: Render suggestions from templates
    renderFixedSuggestions();

    // NEW: Setup manager toggle button
    document.getElementById('fix-manage-templates-btn').onclick=()=>{
      const manager = document.getElementById('fix-templates-manager');
      manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
      if(manager.style.display === 'block') renderFixedTemplatesManager();
    };

    const tbody=document.getElementById('fix-rows');tbody.innerHTML='';
    let unpaidSum = 0;
    const fixedForMonth = b().monthly[ym].fixed.sort((a,b) => (a.due||'').localeCompare(b.due||''));

    for(const r of fixedForMonth){
      if (!r.paid) unpaidSum += num(r.amount);
      let daysToDue = '';
      if (r.due) {
        const dueDate = new Date(r.due); const today = new Date(); today.setHours(0,0,0,0);
        const diffDays = Math.ceil((dueDate - today) / (1000*60*60*24));
        if (diffDays < 0) daysToDue = `<span class="bad">${Math.abs(diffDays)} dni po terminie</span>`;
        else if (diffDays <= 3) daysToDue = `<span class="warn">${diffDays} dni</span>`;
        else if (diffDays <= 7) daysToDue = `<span class="ok">${diffDays} dni</span>`;
        else daysToDue = `${diffDays} dni`;
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><label style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" ${r.paid?'checked':''}/> ${r.paid?'âœ… OpÅ‚acone':'â³ Do zapÅ‚aty'}</label></td><td>${r.title}</td><td>${fmt(r.amount,state.currency)}</td><td>${r.due||'â€”'}</td><td>${daysToDue}</td><td><button class="btn danger">UsuÅ„</button></td>`;
      tr.querySelector('input').onchange=()=>{
        r.paid=!r.paid;

        const existingTxIndex = b().transactions.findIndex(tx => tx.linkedFixedId === r.id);
        if (existingTxIndex > -1) {
            b().transactions.splice(existingTxIndex, 1);
        }

        if(r.paid && b().createTxOnFixedPay){
          const date = r.due && new Date(r.due) <= new Date() ? r.due : new Date().toISOString().slice(0,10);
          b().transactions.unshift({
            id:`tx_${Math.random().toString(36).slice(2)}`,
            date,
            amount:-Math.abs(r.amount),
            categoryId:'c_fixed',
            accountId:b().accounts[0]?.id||'a_main',
            note:`StaÅ‚y: ${r.title}`,
            linkedFixedId: r.id
          });
        }
        save(state); renderAll()
      };
      tr.querySelector('.btn').onclick=()=>{ if(!confirm('UsunÄ…Ä‡ ten staÅ‚y wydatek?')) return; b().monthly[ym].fixed=b().monthly[ym].fixed.filter(x=>x.id!==r.id); save(state); renderAll() };
      tbody.appendChild(tr);
    }
    document.getElementById('fix-unpaid-sum').textContent = fmt(unpaidSum, state.currency);
    document.getElementById('autoTx').checked = !!b().createTxOnFixedPay;
    document.getElementById('payAllFixed').onclick = ()=>{
      const unpaid = b().monthly[ym].fixed.filter(f=>!f.paid);
      if(unpaid.length === 0) { alert('Wszystkie staÅ‚e wydatki na ten miesiÄ…c sÄ… juÅ¼ opÅ‚acane.'); return; }
      if(!confirm(`Czy na pewno chcesz opÅ‚aciÄ‡ ${unpaid.length} pozycji?`)) return;
      for(const item of unpaid) {
        item.paid=true;
        if(b().createTxOnFixedPay){
            const txExists = b().transactions.some(tx => tx.linkedFixedId === item.id);
            if (!txExists) {
                const date = item.due && new Date(item.due) <= new Date() ? item.due : new Date().toISOString().slice(0,10);
                b().transactions.unshift({
                    id:`tx_${Math.random().toString(36).slice(2)}`,
                    date,
                    amount:-Math.abs(item.amount),
                    categoryId:'c_fixed',
                    accountId:b().accounts[0]?.id||'a_main',
                    note:`StaÅ‚y: ${item.title}`,
                    linkedFixedId: item.id
                });
            }
        }
      }
      save(state); renderAll();
    };
  }

  function renderGoalsAndEOM(){ safeRender(renderEOM,'EOM'); safeRender(renderGoals,'Goals'); }

  function renderAll(){
    const ym=b().workingMonth;
    document.getElementById('workingMonth').textContent=ym;
    safeRender(renderDashboard,'Dashboard');
    safeRender(renderOverview,'Overview');
    safeRender(renderIncomes,'Incomes');
    safeRender(renderFixed,'Fixed');
    safeRender(renderVariable,'Variable');
    safeRender(renderCategories,'Categories');
    safeRender(renderMomComparison,'MoM');
    safeRender(renderGoalsAndEOM,'Goals+EOM');
    bindMoneyInputs();
  }
  renderAll();
  </script>
</body>
</html>