<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS — Budżet (ulepszona wersja)</title>
  <link rel="stylesheet" href="styles.css">
    <style>
    .row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .budget-tabs {
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 8;
      padding: 8px 0;
      margin-bottom: 0;
    }

    .trend {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .progress {
      height: 8px;
      background: #e2e8f0;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress > i {
      display: block;
      height: 100%;
      background: var(--ink);
    }

    .progress.good > i { background: var(--green); }
    .progress.warn > i { background: var(--orange); }

    .chart-box {
      height: 240px;
      position: relative;
    }

    .eom-hero {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .eom-dashboard-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      margin: 16px 0 12px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(248, 250, 252, 0.7);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
    }

    .eom-dashboard-tab {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      flex: 1 1 160px;
      text-align: center;
      background: rgba(148, 163, 184, 0.12);
      color: var(--muted);
      cursor: pointer;
      transition: background-color .25s ease, color .25s ease, box-shadow .25s ease;
    }

    .eom-dashboard-tab:hover,
    .eom-dashboard-tab:focus-visible {
      outline: none;
      color: var(--ink);
      background: rgba(37, 99, 235, 0.16);
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.12);
    }

    .eom-dashboard-tab.is-active {
      background: linear-gradient(135deg, var(--accent), rgba(37, 99, 235, 0.85));
      color: #fff;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.28);
    }

    .eom-dashboard-panels {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .eom-dashboard-panel {
      display: none;
    }

    .eom-dashboard-panel.is-active {
      display: block;
      animation: eomPanelFade 0.35s ease;
    }

    @keyframes eomPanelFade {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .eom-networth-section {
      margin-top: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 20px;
      background: var(--surface);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .eom-networth-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
    }

    .eom-networth-title {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .eom-networth-title .title {
      margin: 0;
      font-size: 20px;
    }

    .eom-networth-tabs {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.12);
    }

    .eom-networth-tab {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      background: transparent;
      color: var(--ink);
      cursor: pointer;
      transition: background .2s ease, color .2s ease, transform .2s ease;
    }

    .eom-networth-tab:hover {
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent);
    }

    .eom-networth-tab.is-active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 10px 18px rgba(37, 99, 235, 0.22);
      transform: translateY(-1px);
    }

    .eom-networth-chart-shell {
      position: relative;
      height: 400px;
      width: 100%;
      border-radius: 18px;
      overflow: hidden;
      background: linear-gradient(145deg, rgba(226, 232, 240, 0.4), rgba(248, 250, 252, 0.8));
    }

    .eom-networth-chart-shell canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .eom-networth-empty {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px;
      color: var(--muted);
      font-size: 14px;
      background: linear-gradient(145deg, rgba(226, 232, 240, 0.55), rgba(248, 250, 252, 0.85));
    }

    .eom-networth-empty.is-visible {
      display: flex;
    }

    .eom-history-controls {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }

    .eom-history-controls label {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #eom-history-range {
      min-width: 160px;
    }

    #eom-history-search {
      min-width: 200px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .eom-history-checkbox {
      flex-direction: row !important;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .eom-history-checkbox input {
      transform: translateY(1px);
    }

    .eom-history-table-shell {
      margin-top: 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 16px;
      background: linear-gradient(145deg, rgba(226, 232, 240, 0.35), rgba(248, 250, 252, 0.75));
      position: relative;
    }

    .eom-history-table-scroll {
      max-height: 500px;
      overflow: auto;
      border-radius: inherit;
    }

    .eom-history-table {
      width: 100%;
      min-width: 720px;
      border-collapse: separate;
      border-spacing: 0;
    }

    .eom-history-table thead th {
      position: sticky;
      top: 0;
      background: rgba(248, 250, 252, 0.95);
      backdrop-filter: blur(6px);
      z-index: 5;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-weight: 700;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
    }

    .eom-history-table thead th button {
      background: none;
      border: none;
      padding: 8px 12px;
      width: 100%;
      text-align: left;
      font: inherit;
      color: inherit;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .eom-history-table th, .eom-history-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    .eom-history-table tbody tr:last-child td {
      border-bottom: none;
    }

    .eom-history-table td {
      position: relative;
      background-clip: padding-box;
      transition: background-color .2s ease, box-shadow .2s ease;
      font-variant-numeric: tabular-nums;
    }

    .eom-history-table td:hover {
      box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.18);
    }

    .eom-history-value {
      font-weight: 600;
      color: var(--ink);
    }

    .eom-history-arrow {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 11px;
      opacity: 0.7;
    }

    .eom-history-arrow.positive { color: var(--green); }
    .eom-history-arrow.negative { color: var(--red); }
    .eom-history-arrow.neutral { color: var(--muted); }

    .eom-history-table td.positive {
      color: var(--ink);
    }

    .eom-history-table td.negative {
      color: var(--ink);
    }

    .eom-history-table td.networth {
      font-weight: 700;
    }

    .eom-history-table td.delta {
      font-weight: 600;
    }

    .eom-history-table thead button[data-sort-dir]::after {
      content: attr(data-sort-dir);
      font-size: 10px;
      font-weight: 700;
      color: var(--accent);
    }

    .eom-history-footer {
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(37, 99, 235, 0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
      color: var(--ink);
    }

    .eom-history-footer strong {
      font-size: 18px;
    }

    .eom-history-footer .muted {
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .eom-networth-month-card {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 16px;
      padding: 16px;
      background: rgba(248, 250, 252, 0.65);
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    .eom-networth-month-card:hover {
      border-color: rgba(37, 99, 235, 0.4);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
    }

    .eom-networth-month-card.is-empty {
      justify-content: center;
      align-items: center;
      text-align: center;
      color: var(--muted);
      min-height: 110px;
    }

    .eom-networth-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .eom-networth-card-month {
      font-size: 13px;
      color: var(--ink);
      letter-spacing: 0.04em;
    }

    .eom-networth-card-total {
      font-size: clamp(28px, 3.4vw, 36px);
      font-weight: 700;
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }

    .eom-mom-section {
      margin-top: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 18px;
      background: var(--surface);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .eom-mom-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      justify-content: space-between;
    }

    .eom-mom-controls .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 170px;
    }

    .eom-mom-controls label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .eom-mom-controls select {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 8px 12px;
      font-size: 14px;
      background: rgba(248, 250, 252, 0.75);
      color: var(--ink);
    }

    .eom-mom-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .eom-mom-content {
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    .eom-mom-summary {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(248, 250, 252, 0.95);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
    }

    .eom-mom-summary-main {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
    }

    .eom-mom-summary-main .label {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .eom-mom-summary-main .value {
      font-size: clamp(24px, 2.8vw, 34px);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .eom-mom-summary-main .value.positive { color: var(--green); }
    .eom-mom-summary-main .value.negative { color: var(--red); }
    .eom-mom-summary-main .value.neutral { color: var(--muted); }

    .eom-mom-summary-text {
      font-size: 13px;
      color: var(--ink);
      line-height: 1.45;
    }

    .eom-mom-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .eom-mom-ranking {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(248, 250, 252, 0.85);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .eom-mom-ranking-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .eom-mom-ranking-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
    }

    .eom-mom-ranking .table-wrapper {
      overflow-x: auto;
    }

    .eom-mom-ranking table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .eom-mom-ranking tbody tr {
      cursor: pointer;
      transition: background-color .2s ease;
    }

    .eom-mom-ranking tbody tr:hover,
    .eom-mom-ranking tbody tr.is-highlighted {
      background: rgba(37, 99, 235, 0.08);
    }

    .eom-mom-change-bar {
      position: relative;
      padding: 6px 10px;
      border-radius: 12px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      overflow: hidden;
    }

    .eom-mom-change-bar::before {
      content: '';
      position: absolute;
      inset: 0;
      transform-origin: left center;
      transform: scaleX(var(--delta-progress, 0));
      background: rgba(34, 197, 94, 0.18);
      z-index: 0;
      transition: transform .3s ease;
    }

    .eom-mom-change-bar.negative::before {
      background: rgba(239, 68, 68, 0.18);
      transform-origin: right center;
    }

    .eom-mom-change-bar span {
      position: relative;
      z-index: 1;
    }

    .eom-mom-change-bar.negative span { color: var(--red); }
    .eom-mom-change-bar.positive span { color: var(--green); }
    .eom-mom-change-bar.neutral span { color: var(--muted); }

    .eom-mom-auto {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(248, 250, 252, 0.85);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .eom-mom-auto h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
    }

    .eom-mom-auto-list {
      display: grid;
      gap: 12px;
    }

    .eom-mom-auto-card {
      border-radius: 14px;
      border-left: 4px solid rgba(148, 163, 184, 0.4);
      background: rgba(255, 255, 255, 0.75);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: box-shadow .2s ease, transform .2s ease;
    }

    .eom-mom-auto-card .title {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .eom-mom-auto-card .description {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }

    .eom-mom-auto-card.success { border-left-color: rgba(34, 197, 94, 0.65); }
    .eom-mom-auto-card.warning { border-left-color: rgba(249, 115, 22, 0.75); }
    .eom-mom-auto-card.danger { border-left-color: rgba(239, 68, 68, 0.75); }
    .eom-mom-auto-card.info { border-left-color: rgba(59, 130, 246, 0.7); }

    .insight-pill.positive { background: rgba(34, 197, 94, 0.16); color: #166534; border-color: rgba(34, 197, 94, 0.38); }
    .insight-pill.negative { background: rgba(239, 68, 68, 0.16); color: #991b1b; border-color: rgba(239, 68, 68, 0.38); }
    .insight-pill.info { background: rgba(59, 130, 246, 0.14); color: #1d4ed8; border-color: rgba(59, 130, 246, 0.32); }
    .insight-pill.warning { background: rgba(249, 115, 22, 0.16); color: #b45309; border-color: rgba(249, 115, 22, 0.32); }
    .insight-pill.is-highlighted { border-color: rgba(37, 99, 235, 0.6); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.18); }
    .eom-mom-auto-card.is-highlighted { box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12); transform: translateY(-1px); }

    .eom-mom-empty {
      text-align: center;
      padding: 28px 16px;
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      color: var(--muted);
      background: rgba(248, 250, 252, 0.7);
    }

    @media (max-width: 959px) {
      .eom-dashboard-nav {
        gap: 6px;
        padding: 10px;
      }

      .eom-dashboard-tab {
        flex: 1 1 calc(50% - 6px);
      }

      .eom-mom-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .eom-mom-actions {
        justify-content: flex-start;
      }

      .eom-mom-summary {
        position: static;
      }
    }

    

    .eom-networth-card-delta {
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-variant-numeric: tabular-nums;
    }

    .eom-networth-card-delta.positive { color: var(--green); }
    .eom-networth-card-delta.negative { color: var(--red); }
    .eom-networth-card-delta.neutral { color: var(--muted); }

    .eom-networth-card-split {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .eom-networth-card-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .eom-networth-card-list > span {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .eom-networth-card-list ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .eom-networth-card-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(148, 163, 184, 0.14);
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }

    .eom-networth-card-list li.positive {
      background: rgba(34, 197, 94, 0.14);
      color: #166534;
    }

    .eom-networth-card-list li.negative {
      background: rgba(239, 68, 68, 0.14);
      color: #991b1b;
    }

    .eom-networth-card-list li span:last-child {
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .eom-networth-section {
        padding: 16px;
        gap: 14px;
      }

      .eom-networth-chart-shell {
        height: 280px;
      }

      .eom-networth-month-card {
        padding: 14px;
      }
    }

    .eom-hero-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .eom-performance-matrix {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    .eom-performance-column {
      background: var(--card);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 18px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .eom-performance-head {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .eom-performance-head .title {
      font-size: 18px;
      margin: 0;
    }

    .eom-performance-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .eom-performance-empty {
      border: 1px dashed rgba(148, 163, 184, 0.5);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      background: rgba(241, 245, 249, 0.45);
    }

    .eom-account-card {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-left-width: 4px;
      padding: 14px 16px;
      text-align: left;
      background: var(--card);
      color: var(--ink);
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      font: inherit;
    }

    .eom-account-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      border-color: var(--accent);
    }

    .eom-account-card.positive {
      border-left-color: var(--green);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(240, 253, 244, 0.65));
    }

    .eom-account-card.negative {
      border-left-color: var(--red);
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.12), rgba(254, 242, 242, 0.7));
    }

    .eom-account-card.is-focused {
      border-color: var(--accent);
      box-shadow: 0 14px 28px rgba(37, 99, 235, 0.18);
    }

    .eom-account-card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }

    .eom-account-name {
      font-weight: 600;
      font-size: 15px;
    }

    .eom-account-delta {
      font-weight: 600;
      font-size: 14px;
      font-variant-numeric: tabular-nums;
    }

    .eom-account-delta.positive { color: var(--green); }
    .eom-account-delta.negative { color: var(--red); }
    .eom-account-delta.attention { color: var(--orange); }

    .eom-account-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .eom-account-alert {
      align-self: flex-start;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: rgba(248, 113, 113, 0.14);
      color: var(--red);
      font-weight: 600;
    }

    .eom-account-card.positive .eom-account-alert {
      background: rgba(16, 185, 129, 0.14);
      color: var(--green);
    }

    .eom-account-spark {
      display: flex;
      align-items: center;
    }

    .eom-account-spark canvas {
      width: 100%;
      height: 30px;
      display: block;
    }

    .eom-account-card:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.35);
    }

    @media (max-width: 900px) {
      .eom-performance-matrix {
        grid-template-columns: 1fr;
      }
    }

    .eom-kpi-card {
      position: relative;
      padding: 14px 16px;
      border-radius: 18px;
      background: var(--card);
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      opacity: 0;
      transform: translateY(12px);
    }

    .eom-kpi-card.is-visible {
      animation: eomFadeUp .55s ease forwards;
      animation-delay: var(--eom-delay, 0s);
    }

    .eom-kpi-card:hover {
      transform: translateY(-3px);
      border-color: var(--accent);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
    }

    .eom-kpi-card.primary {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(37, 99, 235, 0.85));
      border: none;
      color: #fff;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.25);
    }

    .eom-kpi-card.primary:hover {
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.35);
    }

    .eom-kpi-label {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .eom-kpi-card.primary .eom-kpi-label {
      color: rgba(255, 255, 255, 0.68);
    }

    .eom-kpi-icon {
      font-size: 20px;
      line-height: 1;
    }

    .eom-kpi-value {
      font-size: clamp(24px, 2.6vw, 30px);
      font-weight: 700;
      color: inherit;
      font-variant-numeric: tabular-nums;
    }

    .eom-kpi-meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .eom-kpi-card.primary .eom-kpi-meta {
      color: rgba(255, 255, 255, 0.75);
    }

    .eom-kpi-trend {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .eom-kpi-trend.positive {
      color: var(--green);
      font-weight: 600;
    }

    .eom-kpi-trend.negative {
      color: var(--red);
      font-weight: 600;
    }

    .eom-kpi-trend.neutral {
      color: var(--muted);
    }

    .eom-kpi-card.primary .eom-kpi-trend.neutral {
      color: rgba(255, 255, 255, 0.75);
    }

    .eom-kpi-card.primary .eom-kpi-trend.positive {
      color: #bbf7d0;
    }

    .eom-kpi-card.primary .eom-kpi-trend.negative {
      color: #fecaca;
    }

    .eom-hero-insights {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .eom-insight-pill {
      background: rgba(37, 99, 235, 0.12);
      color: var(--ink);
      border: 1px solid rgba(37, 99, 235, 0.2);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .eom-insight-pill.negative {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.18);
    }

    @keyframes eomFadeUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chart-box.tall { height: 320px; }
    .chart-box.wide { height: 280px; }

    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .quick-actions .quick-btn {
      display: flex;
      flex-direction: column;
      gap: 2px;
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      text-align: center;
      transition: all .2s ease;
      background: var(--surface);
    }

    .quick-actions .quick-btn:hover {
      border-style: solid;
      border-color: var(--blue);
      background: #eff6ff;
    }

    .heat-day {
      width: 22px;
      height: 22px;
      border-radius: 4px;
      display: grid;
      place-items: center;
      font-size: 10px;
    }

    .heatmap-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recent-calendar-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recent-calendar {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
    }

    .recent-day {
      background: var(--surface);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 14px;
      padding: 8px 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
      transition: border-color .2s ease, transform .2s ease;
    }

    .recent-day:hover {
      border-color: rgba(59, 130, 246, 0.35);
      transform: translateY(-1px);
    }

    .recent-day-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 4px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .recent-day-header span {
      display: block;
      line-height: 1.1;
    }

    .recent-day-weekday {
      font-size: 10px;
      font-weight: 600;
    }

    .recent-day-date {
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
      text-transform: none;
      letter-spacing: 0.02em;
    }

    .recent-day-total {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }

    .recent-day-body {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .recent-entry {
      display: flex;
      gap: 6px;
      align-items: flex-start;
      padding: 4px 6px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: rgba(148, 163, 184, 0.08);
      transition: border-color .2s ease, background .2s ease;
      font-size: 10px;
    }

    .recent-entry-emoji {
      width: 20px;
      height: 20px;
      display: grid;
      place-items: center;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      line-height: 1;
      flex-shrink: 0;
    }

    .recent-entry-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .eom-control-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      margin-top: 16px;
      padding: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 14px;
      background: var(--surface);
    }

    .eom-control-bar .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 180px;
    }

    .eom-grid-shell {
      margin-top: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 16px;
      background: var(--surface);
      overflow: hidden;
    }

    .eom-account-toolbar {
      margin-top: 12px;
      padding: 12px 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 14px;
      background: var(--surface);
      display: flex;
      flex-wrap: wrap;
      gap: 12px 16px;
      align-items: center;
      justify-content: space-between;
    }

    .eom-account-toolbar .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 16px;
      align-items: center;
    }

    .eom-account-toolbar label.tiny {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    .eom-account-toolbar select,
    .eom-account-toolbar .checkboxes {
      font-size: 13px;
    }

    .eom-account-toolbar .checkboxes {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .eom-account-toolbar .checkboxes label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--ink);
      cursor: pointer;
    }

    .eom-account-toolbar .bulk-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .eom-account-toolbar .count {
      font-size: 12px;
      color: var(--muted);
      margin-left: auto;
    }

    .eom-account-accordion {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      max-height: unset;
      overflow: visible;
    }

    .eom-grid-empty {
      padding: 24px;
      text-align: center;
      font-size: 14px;
      color: var(--muted);
    }

    .eom-account-item {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 16px;
      background: var(--card);
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      position: relative;
    }

    .eom-account-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
    }

    .eom-account-item.is-priority {
      border-color: rgba(37, 99, 235, 0.45);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.18);
    }

    .eom-account-item.is-focused {
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.35);
    }

    .eom-account-item.is-debt {
      border-color: rgba(220, 38, 38, 0.45);
      background: linear-gradient(120deg, rgba(248, 113, 113, 0.08), rgba(248, 250, 252, 0.85));
    }

    .eom-account-item.is-dormant {
      opacity: 0.7;
    }

    .eom-account-header {
      width: 100%;
      border: none;
      background: none;
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(140px, auto) minmax(120px, auto) 28px;
      gap: 12px;
      align-items: center;
      padding: 14px 18px;
      cursor: pointer;
    }

    .eom-account-header:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .eom-account-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
      text-align: left;
      min-width: 0;
    }

    .eom-account-title strong {
      font-size: 16px;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .eom-account-title span {
      font-size: 12px;
      color: var(--muted);
    }

    .eom-account-balance {
      font-size: 18px;
      font-weight: 700;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .eom-account-trend {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .eom-account-trend .arrow.up { color: var(--green); }
    .eom-account-trend .arrow.down { color: var(--red); }
    .eom-account-trend .arrow.flat { color: var(--muted); }
    .eom-account-trend.up { color: var(--green); }
    .eom-account-trend.down { color: var(--red); }
    .eom-account-trend.flat { color: var(--muted); }

    .eom-account-toggle-icon {
      font-size: 18px;
      color: var(--muted);
      transition: transform .2s ease;
    }

    .eom-account-item.is-expanded .eom-account-toggle-icon {
      transform: rotate(180deg);
      color: var(--accent);
    }

    .eom-account-body {
      overflow: hidden;
      max-height: 0;
      transition: max-height .3s ease;
    }

    .eom-account-item.is-expanded .eom-account-body {
      max-height: 500px;
    }

    .eom-account-body-inner {
      padding: 0 18px 18px;
      display: grid;
      grid-template-columns: minmax(220px, 1.2fr) minmax(200px, 1fr);
      gap: 18px;
    }

    .eom-account-body-inner > div {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .eom-account-spark-large canvas {
      width: 100%;
      height: 60px;
    }

    .eom-account-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(226, 232, 240, 0.35);
    }

    .eom-account-stats div {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .eom-account-stats div strong {
      font-size: 14px;
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }

    .eom-account-change {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .eom-account-change .delta {
      font-size: 15px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .eom-account-change .delta.positive { color: var(--green); }
    .eom-account-change .delta.negative { color: var(--red); }
    .eom-account-change .delta.neutral { color: var(--muted); }

    .eom-account-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .eom-account-body-inner .tiny.muted {
      line-height: 1.2;
    }

    .eom-account-item .tooltip-target {
      position: relative;
    }

    @media (max-width: 960px) {
      .eom-account-header {
        grid-template-columns: minmax(0, 1fr) minmax(100px, auto) minmax(90px, auto) 24px;
      }
      .eom-account-body-inner {
        grid-template-columns: 1fr;
      }
      .eom-account-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      .eom-account-toolbar .count {
        margin-left: 0;
      }
    }

    @media (max-width: 640px) {
      .eom-account-toolbar {
        padding: 12px;
      }
      .eom-account-header {
        padding: 12px 14px;
      }
      .eom-account-balance {
        font-size: 16px;
      }
      .eom-account-item.is-expanded .eom-account-body {
        max-height: 620px;
      }
    }

    .eom-pivot-table {
      width: 100%;
      border-collapse: collapse;
    }

    .eom-pivot-table th,
    .eom-pivot-table td {
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 8px 10px;
      font-size: 12px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .eom-pivot-table th:first-child,
    .eom-pivot-table td:first-child {
      text-align: left;
    }

    .eom-heatmap-shell {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .eom-heatmap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }

    .eom-heatmap-cell {
      padding: 12px;
      border-radius: 12px;
      background: rgba(226, 232, 240, 0.45);
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .eom-heatmap-cell strong {
      font-size: 13px;
    }

    .eom-heatmap-scale {
      display: flex;
      gap: 4px;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }

    .eom-heatmap-scale span {
      width: 24px;
      height: 8px;
      border-radius: 4px;
      background: var(--line);
    }

    .eom-insight-alert {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.12);
      color: var(--blue);
      font-size: 12px;
    }

    table tr.focused {
      background: rgba(59, 130, 246, 0.12);
    }

    .recent-entry-amount {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      font-size: 11px;
      line-height: 1.2;
      color: var(--ink);
    }

    .recent-entry-note {
      font-size: 9px;
      color: var(--muted);
      line-height: 1.2;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .recent-entry.top-spend {
      border-color: rgba(248, 113, 113, 0.55);
      background: rgba(248, 113, 113, 0.12);
    }

    .recent-entry.top-spend .recent-entry-emoji {
      background: rgba(248, 113, 113, 0.18);
    }

    .recent-entry.top-spend .recent-entry-amount {
      color: #b91c1c;
    }

    .recent-entry-hidden {
      display: none;
    }

    .recent-more {
      border: none;
      background: transparent;
      color: var(--blue);
      font-size: 9px;
      font-weight: 600;
      padding: 0;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      align-self: flex-start;
    }

    .recent-more::after {
      content: '›';
      font-size: 10px;
      transition: transform .2s ease;
    }

    .recent-day.expanded .recent-more::after {
      transform: rotate(90deg);
    }

    .recent-empty {
      font-size: 9px;
      color: var(--muted);
      text-align: center;
      padding: 8px 0 4px;
    }

    .recent-day.recent-day-empty {
      border-style: dashed;
    }

    .recent-day.recent-day-empty .recent-day-total {
      color: var(--muted);
    }

    @media (max-width: 1100px) {
      .recent-calendar {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
    }

    .heatmap-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--surface);
      max-height: 120px;
      overflow-y: auto;
    }

    .heat-legend {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
      color: #64748b;
    }

    .table-compact thead th,
    .table-compact tbody td {
      padding: 6px 8px;
      font-size: 12px;
      line-height: 1.25;
    }

    .table-compact tbody tr:nth-child(even) {
      background: transparent;
    }

    .editor-section {
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
      background: var(--surface);
    }

    .qa-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .qa-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .split-box {
      border: 1px dashed var(--line);
      padding: 8px;
      border-radius: 10px;
      background: var(--surface);
    }

    .banner {
      background: #ecfeff;
      border: 1px solid #cffafe;
      border-radius: 12px;
      padding: 10px;
    }

    .hint { font-size: 12px; color: #64748b; }

    .timeline-wrapper { position: relative; padding-top: 40px; margin-top: 16px; }
    .timeline-labels { position: relative; height: 30px; margin-bottom: 5px; }
    .timeline-label { position: absolute; bottom: 0; transform: translateX(-50%); background: var(--bg); border: 1px solid var(--line); font-size: 11px; padding: 2px 6px; border-radius: 6px; white-space: nowrap; }
    .timeline-label::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid var(--line); }
    .timeline-axis { display: flex; justify-content: space-between; font-size: 10px; color: var(--muted); border-top: 1px solid var(--line); padding-top: 4px; }
    .timeline-goals { position: relative; margin-top: 10px; }
    .timeline-bar { position: absolute; height: 24px; background: linear-gradient(90deg, var(--blue) 0%, var(--blue) 100%); border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; color: white; font-size: 12px; white-space: nowrap; }
    .timeline-bar .bar-label { font-weight: 500; }
    .timeline-bar .bar-progress { opacity: 0.7; }

    .analytics-cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

    .analytics-filter-card {
      margin-top: 12px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: 0 1px 2px rgb(15 23 42 / 0.08);
    }

    .analytics-filter-grid {
      margin-top: 12px;
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .analytics-filter-grid label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
    }

    .analytics-filter-grid label.active {
      border-color: var(--blue);
      background: #eff6ff;
    }

    .analytics-filter-grid label span {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .analytics-filter-actions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .analytics-summary { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .analytics-month-picker { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .analytics-month-chip { padding: 6px 10px; border-radius: 10px; border: 1px solid var(--line); background: #fff; cursor: pointer; font-size: 12px; transition: all .2s ease; }
    .analytics-month-chip.active { background: #0f172a; color: #fff; border-color: #0f172a; }
    .analytics-month-chip:hover { border-color: var(--blue); }

    .table-sortable th { position: relative; white-space: nowrap; }
    .table-sortable th[data-sort] { cursor: pointer; }
    .table-sortable th .sort-indicator { font-size: 10px; margin-left: 4px; color: var(--muted); }

    .th-label { display: inline-flex; align-items: center; gap: 4px; }

    .delta-up { color: var(--green); font-weight: 600; }
    .delta-down { color: var(--red); font-weight: 600; }
    .delta-neutral { color: var(--muted); font-weight: 500; }

    .insight-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 12px;
      background: var(--surface);
      margin-right: 6px;
      margin-top: 4px;
      cursor: pointer;
      transition: box-shadow .2s ease, transform .2s ease, border-color .2s ease;
    }

    .insight-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }

    .eom-panel {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
    }

    .eom-panel .title { font-size: 18px; margin: 0 0 6px 0; }

    .table-modern thead th {
      background: #f1f5f9;
      font-weight: 600;
      font-size: 13px;
      color: #475569;
      border-bottom: 1px solid var(--line);
    }

    .table-modern tbody tr:nth-child(even) { background: #f8fafc; }
    .table-modern td { vertical-align: top; }

    .kpi-card {
      background: #0f172a;
      color: #fff;
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 120px;
    }

    .kpi-card.light {
      background: var(--surface);
      color: var(--ink);
      border: 1px solid var(--line);
    }

    .kpi-card .label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.7; }
    .kpi-card .value { font-size: 26px; font-weight: 700; }
    .kpi-card .sub { font-size: 12px; opacity: 0.8; }

    .kpi-trend { font-size: 12px; font-weight: 600; }
    .kpi-trend.trend-up { color: var(--green); }
    .kpi-trend.trend-down { color: var(--red); }
    .kpi-trend.trend-flat { color: var(--muted); }

    .mom-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .mom-control {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .mom-control select,
    .mom-control input[type="number"] {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 13px;
      background: #fff;
      min-width: 140px;
    }

    #mom-table tbody tr {
      cursor: pointer;
      transition: background .2s ease;
    }

    #mom-table tbody tr:hover { background: rgba(59, 130, 246, 0.1); }
    #mom-table tbody tr.active { background: rgba(59, 130, 246, 0.16); }

    .mom-summary { font-size: 12px; color: var(--muted); margin-top: 6px; }

    .mom-table-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .mom-table-header-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mom-detail-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding-inline: 16px;
      transition: all .25s ease;
      background: rgba(148, 163, 184, 0.16);
      color: var(--ink);
    }

    .mom-detail-button .icon {
      font-size: 16px;
    }

    .mom-detail-button:is(:hover,:focus-visible) {
      outline: none;
      background: rgba(37, 99, 235, 0.18);
      color: var(--accent);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.18);
      transform: translateY(-1px);
    }

    .mom-detail-button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .mom-detail-button.is-ready {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.18), rgba(37, 99, 235, 0.05));
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.22);
    }

    .mom-detail-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.38);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease;
      z-index: 40;
    }

    .mom-detail-backdrop.is-visible {
      opacity: 1;
      pointer-events: auto;
    }

    .mom-detail-panel {
      position: fixed;
      left: var(--mom-panel-left, 24px);
      right: var(--mom-panel-right, 24px);
      top: var(--mom-panel-top, auto);
      bottom: var(--mom-panel-bottom, 24px);
      background: var(--surface);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 28px 48px rgba(15, 23, 42, 0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      opacity: 0;
      transform: translateY(20px) scale(0.98);
      pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 41;
    }

    .mom-detail-panel.is-visible {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }

    .mom-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      padding: 24px 28px 12px;
    }

    .mom-detail-heading {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mom-detail-eyebrow {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .mom-detail-title {
      margin: 0;
      font-size: 18px;
      color: var(--ink);
    }

    .mom-detail-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .mom-detail-header-actions {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .mom-detail-sort {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.18);
    }

    .mom-detail-sort button {
      border: none;
      background: transparent;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      color: var(--muted);
      transition: all .2s ease;
    }

    .mom-detail-sort button.is-active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.26);
    }

    .mom-detail-sort button:not(.is-active):hover {
      color: var(--ink);
    }

    .mom-detail-close {
      border: none;
      background: rgba(148, 163, 184, 0.16);
      color: var(--ink);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease, color .2s ease;
    }

    .mom-detail-close:hover,
    .mom-detail-close:focus-visible {
      outline: none;
      background: rgba(37, 99, 235, 0.18);
      color: var(--accent);
      transform: translateY(-1px);
    }

    .mom-detail-meta {
      display: grid;
      gap: 16px;
      padding: 0 28px 20px;
    }

    .mom-detail-meta-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .mom-detail-tile {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      padding: 16px 18px;
      background: rgba(248, 250, 252, 0.92);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 120px;
    }

    .mom-detail-tile.highlight {
      background: linear-gradient(145deg, rgba(37, 99, 235, 0.08), rgba(37, 99, 235, 0.02));
      border-color: rgba(37, 99, 235, 0.25);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .mom-detail-tile.positive {
      border-color: rgba(239, 68, 68, 0.28);
      background: linear-gradient(150deg, rgba(239, 68, 68, 0.12), rgba(255, 255, 255, 0.92));
    }

    .mom-detail-tile.negative {
      border-color: rgba(34, 197, 94, 0.28);
      background: linear-gradient(150deg, rgba(34, 197, 94, 0.12), rgba(255, 255, 255, 0.92));
    }

    .mom-detail-tile-label {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .mom-detail-tile-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--ink);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: baseline;
    }

    .mom-detail-tile-value strong {
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
    }

    .mom-detail-tile-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--muted);
      background: rgba(148, 163, 184, 0.18);
      padding: 2px 8px;
      border-radius: 999px;
    }

    .mom-detail-tile-dot {
      color: var(--muted);
      font-weight: 700;
    }

    .mom-detail-tile-note {
      font-size: 13px;
      line-height: 1.45;
      color: var(--muted);
    }

    .mom-detail-cross {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      padding: 16px 18px 18px;
      background: rgba(248, 250, 252, 0.9);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mom-detail-cross.positive {
      border-color: rgba(239, 68, 68, 0.28);
      background: linear-gradient(150deg, rgba(239, 68, 68, 0.12), rgba(255, 255, 255, 0.96));
    }

    .mom-detail-cross.neutral {
      border-color: rgba(148, 163, 184, 0.24);
    }

    .mom-detail-cross-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .mom-detail-cross-label {
      font-size: 12px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .mom-detail-cross-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--ink);
    }

    .mom-detail-cross-bar {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.22);
      overflow: hidden;
    }

    .mom-detail-cross-bar span {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 12px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.75), rgba(239, 68, 68, 0.45));
      transform: translateX(-50%);
      left: var(--mom-cross-position, 0%);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9);
    }

    .mom-detail-cross-note {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }

    .mom-detail-body {
      padding: 0 28px 28px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
      flex: 1;
    }

    .mom-detail-day {
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 18px;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: linear-gradient(145deg, rgba(148, 163, 184, 0.12), rgba(255, 255, 255, 0.95));
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
    }

    .mom-detail-day.positive {
      border-left: 4px solid rgba(239, 68, 68, 0.55);
    }

    .mom-detail-day.negative {
      border-left: 4px solid rgba(34, 197, 94, 0.55);
    }

    .mom-detail-day-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }

    .mom-detail-day-title {
      font-weight: 600;
      color: var(--ink);
    }

    .mom-detail-day-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .mom-detail-day-subline {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .mom-detail-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(148, 163, 184, 0.18);
      color: var(--ink);
      white-space: nowrap;
    }

    .mom-detail-badge.positive {
      background: rgba(239, 68, 68, 0.16);
      color: var(--red);
    }

    .mom-detail-badge.negative {
      background: rgba(34, 197, 94, 0.16);
      color: var(--green);
    }

    .mom-detail-columns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .mom-detail-month {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mom-detail-month-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .mom-detail-month-count {
      font-size: 11px;
      font-weight: 600;
      color: var(--ink);
      background: rgba(148, 163, 184, 0.18);
      padding: 2px 8px;
      border-radius: 999px;
    }

    .mom-detail-entry {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(248, 250, 252, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.22);
    }

    .mom-detail-entry-amount {
      font-weight: 600;
      color: var(--ink);
      white-space: nowrap;
    }

    .mom-detail-entry-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mom-detail-entry-note {
      font-size: 13px;
      color: var(--ink);
      line-height: 1.4;
    }

    .mom-detail-entry-note .muted {
      color: var(--muted);
    }

    .mom-detail-month-empty {
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      font-size: 12px;
      text-align: center;
      color: var(--muted);
      background: rgba(248, 250, 252, 0.6);
    }

    .mom-detail-empty {
      padding: 24px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
    }

    @media (max-width: 900px) {
      .mom-detail-panel {
        border-radius: 18px;
      }

      .mom-detail-header {
        flex-direction: column;
        align-items: stretch;
        padding: 20px 20px 12px;
      }

      .mom-detail-meta {
        padding: 0 20px 20px;
      }

      .mom-detail-body {
        padding: 0 20px 24px;
      }
    }

    @media (max-width: 720px) {
      .mom-detail-header {
        flex-direction: column;
        align-items: stretch;
      }

      .mom-detail-header-actions {
        justify-content: space-between;
      }

      .mom-detail-columns {
        grid-template-columns: 1fr;
      }
    }


    .chart-empty {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>
<body data-page="budget">
  <div class="layout">
    <aside class="sidebar" aria-label="Główna nawigacja">
      <div class="sidebar__header">
        <span class="sidebar__emoji">🧭</span>
        <span class="sidebar__brand">LifeOS</span>
      </div>
      <nav class="sidebar__nav" aria-label="Sekcje LifeOS">
        <ul class="sidebar__list">
          <li class="sidebar__item">
            <a class="sidebar__link" href="index.html" data-page="dashboard">
              <span class="sidebar__icon">📊</span>
              <span class="sidebar__label">Dashboard</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="budget.html" data-page="budget">
              <span class="sidebar__icon">💰</span>
              <span class="sidebar__label">Budżet</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="tasks.html" data-page="tasks">
              <span class="sidebar__icon">✅</span>
              <span class="sidebar__label">Zadania</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="trainings.html" data-page="trainings">
              <span class="sidebar__icon">💪</span>
              <span class="sidebar__label">Progres</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="fuel.html" data-page="fuel">
              <span class="sidebar__icon">⛽</span>
              <span class="sidebar__label">Paliwo</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="loan.html" data-page="loan">
              <span class="sidebar__icon">🏦</span>
              <span class="sidebar__label">Kredyt</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="inventory.html" data-page="inventory">
              <span class="sidebar__icon">📦</span>
              <span class="sidebar__label">Magazyn</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="house.html" data-page="house">
              <span class="sidebar__icon">🏠</span>
              <span class="sidebar__label">Budowa</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar__footer">
        <strong>Twój cyfrowy dom</strong>
        Zarządzaj budżetem, zadaniami i celami w jednym miejscu.
      </div>
    </aside>

    <div class="main">
      <header class="page-header" role="banner">
        <div class="page-header__top">
          <span class="page-overline">Finanse</span>
          <h1 class="page-title">
            <span class="page-title__icon">💰</span>
            <span class="page-title__text">Budżet</span>
          </h1>
        </div>
        <div class="page-header__actions page-header__actions--spread" aria-label="Akcje strony">
          <div class="page-header__badges">
            <span class="badge">💾 Dane lokalne</span>
            <span class="badge">📈 Analiza offline</span>
          </div>
          <div class="toolbar budget-month-nav">
            <button class="btn soft" id="prevMonthBtn" title="Poprzedni miesiąc">←</button>
            <span class="pill" id="workingMonth">YYYY-MM</span>
            <button class="btn soft" id="nextMonthBtn" title="Następny miesiąc">→</button>
          </div>
          <div class="toolbar budget-io-actions">
            <button class="btn ghost" id="exportBtn">⬇️ Eksport JSON</button>
            <button class="btn ghost" id="importBtn">⬆️ Import JSON</button>
            <input type="file" id="importFile" accept="application/json" style="display:none" />
          </div>
        </div>
      </header>

      <div class="content">
        <main class="page-content content-main stack">
    <div class="tabs budget-tabs" style="margin-top:12px">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="overview">Przegląd</button>
      <button class="tab" data-tab="incomes">Przychody</button>
      <button class="tab" data-tab="fixed">Stałe wydatki</button>
      <button class="tab" data-tab="variable">Wydatki zmienne</button>
      <button class="tab" data-tab="categories">Kategorie</button>
      <button class="tab" data-tab="eom">Salda (EOM)</button>
      <button class="tab" data-tab="goals">Cele</button>
      <button class="tab" data-tab="analytics">Analityka</button>
      <button class="tab" data-tab="mom">Porównanie MoM</button>
    </div>

    <!-- Dashboard -->
    <section id="tab-dashboard" class="card" style="margin-top:12px">
      <h3 class="title">Dashboard finansowy</h3>
      <div class="grid-2" style="margin-top:12px">
        <div class="card">
          <div class="title">Wydatki dzień po dniu</div>
          <div class="chart-box"><canvas id="dailyLine"></canvas></div>
        </div>
        <div class="card">
          <div class="title">Skumulowane: limit vs wydatki</div>
          <div class="hint">Dwie linie: oczekiwane (np. 400 zł/dzień) vs faktyczne (wydatki + oszczędności)</div>
          <div class="chart-box"><canvas id="cumulativeLine"></canvas></div>
        </div>
      </div>

      <div class="card heatmap-card" style="margin-top:16px">
        <div class="title">Wydatki dzienne — heatmap</div>
        <div class="muted" style="margin-bottom:4px">Zielone = w budżecie, Pomarańczowe = przekroczenie, Czerwone = duże przekroczenie</div>
        <div id="daily-spending-calendar" class="heatmap-strip"></div>
        <div class="heat-legend">
          <span class="heat-day" style="background:#dcfce7"> </span> w normie
          <span class="heat-day" style="background:#ffedd5"> </span> lekko powyżej
          <span class="heat-day" style="background:#fee2e2"> </span> mocno powyżej
        </div>
      </div>

      <div class="card recent-calendar-card" style="margin-top:16px">
        <div class="row" style="justify-content:space-between;align-items:flex-start;gap:12px">
          <div>
            <div class="title">Ostatnie 7 dni — wydatki</div>
            <p class="muted tiny">Największe wydatki z ostatnich dni, posegregowane malejąco. Top 5 oznaczone na czerwono.</p>
          </div>
          <div class="chip" style="margin:0" id="recent-seven-total">Łącznie: —</div>
        </div>
        <div id="recent-spending-calendar" class="recent-calendar"></div>
      </div>

      <div id="var-table-dashboard-slot" style="display:none">
        <div id="var-transactions-card" class="card">
          <div class="row" style="justify-content:space-between;align-items:flex-end;gap:12px">
            <div>
              <div class="title">Transakcje w miesiącu</div>
              <p class="muted tiny">Monitoruj wszystkie wydatki zmienne w aktywnym okresie.</p>
            </div>
            <div class="chip" style="margin:0">
              Suma: <b id="var-sum">0</b>
            </div>
          </div>
          <div class="row" style="margin:12px 0;gap:8px;align-items:center;flex-wrap:wrap">
            <label class="tiny" style="display:flex;flex-direction:column;gap:6px">
              Filtr kategorii
              <select id="var-filter-cat"><option value="">Wszystkie kategorie</option></select>
            </label>
          </div>
          <div class="table-wrapper" style="max-height:320px;overflow:auto">
            <table class="table-compact">
              <thead><tr><th>Data</th><th>Kategoria</th><th>Konto</th><th>Kwota</th><th>Notatka</th><th></th></tr></thead>
              <tbody id="var-rows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="quick-actions" style="margin-top:12px">
        <div class="row">
          <div class="title">Szybkie akcje</div>
          <div class="row" style="gap:8px">
            <button id="qa-edit-toggle" class="btn ghost">⚙️ Edytuj szybkie akcje</button>
          </div>
        </div>
        <div id="qa-grid" class="grid g-4" style="margin-top:8px"></div>
        <div id="qa-editor" class="editor-section" style="display:none">
          <div class="title">Edycja szybkich akcji</div>
          <div class="tiny">Zapisuje się w pamięci przeglądarki (localStorage).</div>
          <form id="qa-add-form" class="grid g-4" style="margin-top:10px">
            <input name="label" placeholder="Nazwa (np. Jedzenie)" required />
            <input name="emoji" placeholder="Emoji (np. 🍕)" />
            <select name="categoryId" required></select>
            <select name="accountId" required></select>
            <input name="defaultAmount" placeholder="Domyślna kwota (zł)" inputmode="decimal" />
            <input name="defaultNote" placeholder="Domyślna notatka" />
            <button class="btn" type="submit" style="grid-column: 1 / -1;">Dodaj akcję</button>
          </form>
          <table style="margin-top:10px">
            <thead><tr><th>Emoji</th><th>Nazwa</th><th>Kategoria</th><th>Konto</th><th>Domyślna kwota</th><th>Notatka</th><th></th></tr></thead>
            <tbody id="qa-rows"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Overview -->
    <section id="tab-overview" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Przegląd miesiąca — <span id="ov-month">YYYY-MM</span></h3>
      <div class="grid g-4">
        <div class="stat-card"><div class="muted">Przychody</div><div class="big-number" id="ov-inc">0</div></div>
        <div class="stat-card"><div class="muted">Stałe zaplanowane</div><div class="big-number" id="ov-fixed-planned">0</div></div>
        <div class="stat-card"><div class="muted">Stałe zapłacone</div><div class="big-number ok" id="ov-fixed-paid">0</div></div>
        <div class="stat-card"><div class="muted">Stałe do zapłacenia</div><div class="big-number warn" id="ov-fixed-unpaid">0</div></div>
        <div class="stat-card"><div class="muted">Wydatki zmienne</div><div class="big-number bad" id="ov-var-spent">0</div></div>
        <div class="stat-card"><div class="muted">Oszczędności</div><div class="big-number" style="color:var(--blue)" id="ov-savings">0</div></div>
        <div class="stat-card"><div class="muted">Budżet zmienny do dyspozycji</div><div class="big-number" id="ov-remaining">0</div></div>
        <div class="stat-card"><div class="muted">Prognozowana stopa oszczędności</div><div class="big-number" id="stat-savings-rate">0%</div></div>
      </div>
    </section>

    <!-- Incomes -->
    <section id="tab-incomes" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Przychody — <span id="inc-month">YYYY-MM</span></h3>
      <form id="inc-form" class="grid g-3" style="margin-bottom:8px">
        <input required name="amount" placeholder="Kwota (zł)" inputmode="decimal" />
        <input name="note" placeholder="Notatka (np. pensja)" />
        <button class="btn" type="submit">Dodaj przychód</button>
      </form>
      <div class="muted" style="margin-bottom:4px">Suma: <b id="inc-sum">0</b></div>
      <table><thead><tr><th>Kwota</th><th>Notatka</th><th></th></tr></thead><tbody id="inc-rows"></tbody></table>
    </section>

    <!-- Fixed Expenses -->
    <section id="tab-fixed" class="card" style="margin-top:12px;display:none">
      <div class="row">
        <h3 class="title" style="margin: 0;">Stałe wydatki — <span id="fix-month">YYYY-MM</span></h3>
        <button id="fix-manage-templates-btn" class="btn ghost">⚙️ Zarządzaj szablonami</button>
      </div>
      
      <!-- NEW: Fixed expense templates manager -->
      <div id="fix-templates-manager" class="editor-section" style="margin-bottom:12px; display:none">
        <div class="title">Zarządzaj szablonami stałych wydatków</div>
        <p class="tiny">Zdefiniuj stałe opłaty (np. czynsz, abonamenty), a aplikacja będzie sugerować ich dodanie w każdym miesiącu.</p>
        <form id="fix-template-form" class="grid g-4" style="margin-top:8px">
          <input name="title" placeholder="Nazwa (np. Czynsz)" required />
          <input name="amount" placeholder="Kwota (zł)" inputmode="decimal" required />
          <input name="day" type="number" min="1" max="31" placeholder="Dzień płatności (1-31)" required />
          <button class="btn" type="submit">Dodaj szablon</button>
        </form>
        <table style="margin-top:10px">
          <thead><tr><th>Nazwa</th><th>Kwota</th><th>Dzień miesiąca</th><th></th></tr></thead>
          <tbody id="fix-templates-tbody"></tbody>
        </table>
      </div>

      <!-- NEW: Fixed expense suggestions -->
      <div id="fix-suggestions-box" class="card" style="margin-bottom: 12px; display: none; background: #f8fafc;">
        <div class="row">
          <div class="title">💡 Sugestie na ten miesiąc</div>
          <button id="fix-apply-all-btn" class="btn soft">Dodaj wszystkie</button>
        </div>
        <div id="fix-suggestions-list" class="grid g-3" style="margin-top:8px; gap:8px"></div>
      </div>

      <form id="fix-form" class="grid g-4" style="margin:8px 0">
        <input required name="title" placeholder="Tytuł (np. czynsz)" />
        <input required name="amount" placeholder="Kwota (zł)" inputmode="decimal" />
        <input name="due" type="date" />
        <input type="hidden" name="categoryId" value="c_fixed"/>
        <button class="btn" type="submit">Dodaj jednorazowo</button>
      </form>
      
      <div class="row" style="margin-bottom:12px">
        <label style="display:inline-flex;gap:8px;align-items:center">
          <input type="checkbox" id="autoTx" checked />Automatycznie dodaj transakcję po opłaceniu
        </label>
        <button class="btn soft" id="payAllFixed">Opłać wszystkie</button>
      </div>

      <table>
        <thead><tr><th>Status</th><th>Tytuł</th><th>Kwota</th><th>Termin</th><th>Dni do terminu</th><th></th></tr></thead>
        <tbody id="fix-rows"></tbody>
      </table>
      <div class="muted" style="margin-top:8px">Suma nieopłaconych: <b id="fix-unpaid-sum">0</b></div>
    </section>

    <!-- Variable -->
    <section id="tab-variable" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Wydatki zmienne — <span id="var-month">YYYY-MM</span></h3>

      <!-- Sugestie cykliczne -->
      <div id="rec-suggestions" class="card" style="margin-bottom:10px; display:none">
        <div class="row">
          <div class="title">🔁 Cykliczne — Sugestie na <span id="rec-sugg-month"></span></div>
          <button class="btn ghost" id="rec-manage-toggle">⚙️ Zarządzaj szablonami</button>
        </div>
        <div id="rec-sugg-list" class="grid" style="gap:8px"></div>
      </div>

      <!-- Zarządzanie szablonami (zmienne) -->
      <div id="rec-manage" class="editor-section" style="display:none">
        <div class="title">Szablony cykliczne</div>
        <div class="tiny">Miesięczny harmonogram (dzień 1–31). Obsługa splitu.</div>
        <form id="rec-add-form" class="grid g-4" style="margin-top:8px">
          <input name="label" placeholder="Nazwa (np. Abonament)" required />
          <input name="day" type="number" min="1" max="31" placeholder="Dzień miesiąca" required />
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" name="isSplit" /> Split</label><span></span>
          <div data-mode="single" class="grid g-4" style="grid-column:1/-1;gap:8px">
            <select name="categoryId"></select>
            <select name="accountId"></select>
            <input name="amount" placeholder="Kwota (zł)" inputmode="decimal" />
            <input name="note" placeholder="Notatka" />
          </div>
          <div data-mode="split" class="split-box" style="grid-column:1/-1;display:none">
            <table style="width:100%"><thead><tr><th>Kategoria</th><th>Kwota</th><th></th></tr></thead><tbody class="rec-split-rows"></tbody></table>
            <div style="margin-top:6px"><button class="btn soft" type="button" id="rec-split-add">+ wiersz</button></div>
          </div>
          <button class="btn" type="submit" style="grid-column:1/-1">Dodaj szablon</button>
        </form>
        <table style="margin-top:10px">
          <thead><tr><th>Nazwa</th><th>Dzień</th><th>Tryb</th><th>Podsumowanie</th><th>Konto</th><th>Notatka</th><th></th></tr></thead>
          <tbody id="rec-rows"></tbody>
        </table>
      </div>

      <!-- Dodawanie transakcji -->
      <form id="var-form" class="grid g-4" style="margin:10px 0">
        <input type="date" name="date" />
        <input required name="amount" placeholder="Kwota (zł)" inputmode="decimal" />
        <select name="categoryId"></select>
        <select name="accountId"></select>
        <input name="note" placeholder="Notatka" />
        <button class="btn" type="submit">Dodaj wydatek</button>
      </form>

      <div id="var-table-variable-slot" style="margin-top:12px"></div>

      <div class="insight-bubble" style="margin-top:12px">📊 Szczegółową tabelę transakcji znajdziesz poniżej lub w panelu „Dashboard finansowy”.</div>
    </section>

    <!-- Categories -->
    <section id="tab-categories" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Kategorie</h3>
      <form id="cat-form" class="grid g-4" style="margin-bottom:8px">
        <input required name="name" placeholder="Nazwa" />
        <select name="type">
          <option value="expense">Wydatek</option>
          <option value="income">Przychód</option>
          <option value="saving">Oszczędność</option>
        </select>
        <input name="emoji" placeholder="Emoji (np. 🍕)" />
        <input name="budget" placeholder="Budżet (zł)" inputmode="decimal" />
        <button class="btn" type="submit">Dodaj kategorię</button>
      </form>
      <div class="muted" id="cat-empty" style="display:none;margin-bottom:8px">Brak kategorii — dodaj pierwszą powyżej.</div>
      <table>
        <thead><tr><th>Emoji</th><th>Nazwa</th><th>Typ</th><th>Budżet</th><th>Wydano</th><th>Status</th><th></th></tr></thead>
        <tbody id="cat-rows"></tbody>
      </table>
    </section>

    <!-- EOM -->
    <section id="tab-eom" class="card" style="margin-top:12px;display:none">
      <div class="row" style="align-items:flex-start;gap:12px">
        <div>
          <h3 class="title" style="margin-bottom:4px">Salda i majątek netto</h3>
          <p id="eom-prompt" class="tiny"></p>
        </div>
        <div class="row" style="gap:8px;align-items:center">
          <div class="tiny muted" style="display:flex;align-items:center;gap:6px">Aktywny miesiąc <span class="pill" id="eom-active-month"></span></div>
          <button class="btn soft" type="button" id="eom-copy-last">Skopiuj poprzedni zapis</button>
        </div>
      </div>

      <div class="eom-hero">
        <div id="eom-kpis" class="eom-hero-grid"></div>
        <div id="eom-insights" class="eom-hero-insights"></div>
      </div>

      <div class="eom-dashboard-nav" id="eom-dashboard-nav" role="tablist" aria-label="Widoki Salda EoM">
        <button type="button" class="eom-dashboard-tab is-active" id="eom-dashboard-tab-overview" data-panel="overview" role="tab" aria-selected="true" aria-controls="eom-dashboard-overview" tabindex="0">Trend majątku</button>
        <button type="button" class="eom-dashboard-tab" id="eom-dashboard-tab-performance" data-panel="performance" role="tab" aria-selected="false" aria-controls="eom-dashboard-performance" tabindex="-1">Wydajność kont</button>
        <button type="button" class="eom-dashboard-tab" id="eom-dashboard-tab-accounts" data-panel="accounts" role="tab" aria-selected="false" aria-controls="eom-dashboard-accounts" tabindex="-1">Rejestr sald</button>
        <button type="button" class="eom-dashboard-tab" id="eom-dashboard-tab-history" data-panel="history" role="tab" aria-selected="false" aria-controls="eom-dashboard-history" tabindex="-1">Historia</button>
        <button type="button" class="eom-dashboard-tab" id="eom-dashboard-tab-comparison" data-panel="comparison" role="tab" aria-selected="false" aria-controls="eom-dashboard-comparison" tabindex="-1">Porównanie m/m</button>
      </div>

      <div class="eom-dashboard-panels" id="eom-dashboard-panels">
        <section class="eom-dashboard-panel is-active" data-panel="overview" id="eom-dashboard-overview" role="tabpanel" aria-labelledby="eom-dashboard-tab-overview">
          <section class="eom-networth-section" id="eom-networth">
            <div class="eom-networth-header">
              <div class="eom-networth-title">
                <div class="title">Trend majątku netto</div>
                <p class="tiny">Historia wartości portfela z podziałem na główne składniki. Kliknij punkt, aby zobaczyć szczegóły miesiąca.</p>
              </div>
              <div class="eom-networth-tabs" id="eom-networth-tabs">
                <button class="eom-networth-tab" type="button" data-range-tab="3m">3m</button>
                <button class="eom-networth-tab" type="button" data-range-tab="6m">6m</button>
                <button class="eom-networth-tab" type="button" data-range-tab="12m">12m</button>
                <button class="eom-networth-tab" type="button" data-range-tab="all">Wszystkie</button>
              </div>
            </div>
            <div class="eom-networth-chart-shell">
              <canvas id="eom-networth-chart"></canvas>
              <div id="eom-networth-empty" class="eom-networth-empty">Brak danych w tym zakresie — dodaj zapisy lub zmień filtry, aby zobaczyć trend majątku netto.</div>
            </div>
            <div id="eom-networth-month-card" class="eom-networth-month-card is-empty">Wybierz punkt na wykresie, aby podejrzeć szczegóły miesiąca.</div>
          </section>
        </section>

        <section class="eom-dashboard-panel" data-panel="performance" id="eom-dashboard-performance" role="tabpanel" aria-labelledby="eom-dashboard-tab-performance" hidden>
          <section class="eom-performance-matrix" id="eom-performance-matrix">
            <div class="eom-performance-column">
              <div class="eom-performance-head">
                <h4 class="title">🔥 Top Performers</h4>
                <p class="tiny muted">Największe wzrosty miesiąc do miesiąca. Kliknij kartę, aby przejść do szczegółów.</p>
              </div>
              <div class="eom-performance-list" data-zone="top"></div>
            </div>
            <div class="eom-performance-column">
              <div class="eom-performance-head">
                <h4 class="title">⚠️ Wymagają uwagi</h4>
                <p class="tiny muted">Największe spadki miesiąc do miesiąca — sprawdź, co ciągnie wynik w dół.</p>
              </div>
              <div class="eom-performance-list" data-zone="watch"></div>
            </div>
          </section>
        </section>

        <section class="eom-dashboard-panel" data-panel="accounts" id="eom-dashboard-accounts" role="tabpanel" aria-labelledby="eom-dashboard-tab-accounts" hidden>
          <div class="eom-panel" style="margin-top:0">
            <div class="row" style="align-items:flex-end;gap:12px">
              <div>
                <div class="title" style="margin-bottom:4px">Rejestr sald</div>
                <p class="tiny">Dodaj konta i uzupełnij ich stany na koniec miesiąca. Dane są przechowywane lokalnie w przeglądarce.</p>
              </div>
            </div>
              <form id="acct-form" class="grid g-3" style="gap:8px;margin:12px 0">
                <input name="name" placeholder="Dodaj konto (np. Oszczędności, Dług na karcie)" style="grid-column: span 2;"/>
                <button class="btn soft" type="submit">Dodaj konto</button>
              </form>
            <div class="eom-control-bar" id="eom-control-bar">
              <label class="filter-group">
                <span class="tiny">Typy kont</span>
                <select id="eom-account-type-filter" multiple size="4" style="min-width:200px"></select>
                <span class="tiny muted">Wybierz typy kont, które mają pozostać w widoku.</span>
              </label>
              <div class="filter-group">
                <label class="tiny" for="eom-date-from">Zakres miesięcy</label>
                <div class="row" style="gap:6px;align-items:center">
                  <input type="month" id="eom-date-from" />
                  <span class="tiny muted">→</span>
                  <input type="month" id="eom-date-to" />
                </div>
                <span class="tiny muted">Określ zakres do analizy trendów.</span>
              </div>
              <div class="filter-group">
                <span class="tiny">Widok danych</span>
                <div class="row" style="gap:6px;align-items:center">
                  <button class="btn soft" type="button" id="eom-pivot-toggle" data-active="0">Widok pivot</button>
                  <select id="eom-group-by" style="min-width:160px">
                    <option value="type">Grupuj wg typu</option>
                    <option value="status">Grupuj wg statusu</option>
                    <option value="none">Bez grupowania</option>
                  </select>
                </div>
                <span class="tiny muted">Przełącz się między tabelą edycyjną a widokiem analitycznym.</span>
              </div>
            </div>
            <div class="eom-account-toolbar" id="eom-account-toolbar">
              <div class="controls">
                <label class="tiny" for="eom-account-sort">Sortowanie
                  <select id="eom-account-sort">
                    <option value="name">Po nazwie A-Z</option>
                    <option value="balance">Po saldzie (najwyższe)</option>
                    <option value="change-up">Zmiana % (wzrost)</option>
                    <option value="change-down">Zmiana % (spadek)</option>
                  </select>
                </label>
                <div class="checkboxes" aria-label="Filtry kont">
                  <label><input type="checkbox" id="eom-filter-positive"> Pokaż tylko dodatnie</label>
                  <label><input type="checkbox" id="eom-filter-negative"> Pokaż tylko ujemne</label>
                  <label><input type="checkbox" id="eom-filter-hide-zero"> Ukryj zerowe</label>
                </div>
              </div>
              <div class="bulk-actions">
                <button class="btn soft" type="button" id="eom-expand-all">Rozwiń wszystkie</button>
                <button class="btn ghost" type="button" id="eom-collapse-all">Zwiń wszystkie</button>
              </div>
              <div class="count" id="eom-account-count">—</div>
            </div>
            <div id="eom-grid" class="eom-grid-shell"></div>
            <div id="eom-heatmap" class="eom-heatmap-shell"></div>
            <div class="row" style="margin-top:12px">
              <div class="muted">Suma sald (Majątek Netto): <b id="eom-total">0</b></div>
              <div class="row" style="gap:8px">
                <button class="btn ghost" type="button" id="eom-reset-inputs">Wyczyść pola</button>
                <button id="eom-save" class="btn" type="button">Zapisz salda</button>
              </div>
            </div>
          </div>
        </section>

        <section class="eom-dashboard-panel" data-panel="history" id="eom-dashboard-history" role="tabpanel" aria-labelledby="eom-dashboard-tab-history" hidden>
          <div class="eom-panel" style="margin-top:0">
            <div class="row" style="align-items:flex-start;gap:12px">
              <div>
                <div class="title" style="margin-bottom:4px">Historia sald i majątku netto</div>
                <p class="tiny">Analizuj zmiany w czasie, aby wychwycić trendy, rekordy i anomalie.</p>
              </div>
            </div>
            <div class="eom-history-controls">
              <label class="tiny">
                Pokaż zakres
                <select id="eom-history-range">
                  <option value="3">3 miesiące</option>
                  <option value="6">6 miesięcy</option>
                  <option value="12">12 miesięcy</option>
                  <option value="all">Wszystkie</option>
                </select>
              </label>
              <label class="tiny">
                Szukaj konta
                <input id="eom-history-search" type="search" placeholder="np. Oszczędności" />
              </label>
              <label class="tiny eom-history-checkbox">
                <input type="checkbox" id="eom-history-only-changes" /> Tylko ze zmianami
              </label>
              <button class="btn soft" type="button" id="eom-history-transpose" data-active="0">Transponuj widok</button>
              <button class="btn ghost" type="button" id="eom-history-export">Eksportuj do CSV</button>
            </div>
            <div class="eom-history-table-shell">
              <div class="eom-history-table-scroll">
                <table id="eom-accounts-history" class="table-modern eom-history-table">
                  <thead></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div id="eom-history-footer" class="eom-history-footer"></div>
            <div style="overflow-x:auto;margin-top:16px">
              <table id="eom-monthly-summary" class="table-modern table-sortable">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="eom-dashboard-panel" data-panel="comparison" id="eom-dashboard-comparison" role="tabpanel" aria-labelledby="eom-dashboard-tab-comparison" hidden>
          <section class="eom-mom-section" id="eom-mom" style="margin-top:0">
            <div class="row" style="align-items:flex-end;gap:12px">
              <div>
                <div class="title" style="margin:0">Porównanie miesiąc do miesiąca</div>
                <p class="tiny muted" style="margin:4px 0 0">Zobacz jak zmieniły się salda wszystkich kont między dwoma wybranymi miesiącami.</p>
              </div>
            </div>
            <div class="eom-mom-controls">
              <div class="control-group">
                <label for="eom-mom-month-a">Miesiąc A</label>
                <select id="eom-mom-month-a"></select>
              </div>
              <div class="control-group">
                <label for="eom-mom-month-b">Miesiąc B</label>
                <select id="eom-mom-month-b"></select>
              </div>
              <div class="eom-mom-actions">
                <button class="btn soft" type="button" id="eom-mom-swap">Zamień miejscami</button>
                <button class="btn" type="button" id="eom-mom-run">Porównaj</button>
              </div>
            </div>
            <div id="eom-mom-empty" class="eom-mom-empty" style="display:none"></div>
            <div id="eom-mom-content" class="eom-mom-content" style="display:none">
              <div class="eom-mom-summary" id="eom-mom-summary">
                <div class="eom-mom-summary-main">
                  <span class="label">Δ suma</span>
                  <span class="value neutral" id="eom-mom-summary-value">—</span>
                </div>
                <div class="eom-mom-summary-text" id="eom-mom-summary-text"></div>
                <div class="eom-mom-pills" id="eom-mom-pills"></div>
              </div>

              <section class="eom-mom-ranking">
                <div class="eom-mom-ranking-header">
                  <h4>Ranking zmian per konto</h4>
                  <div class="tiny muted" id="eom-mom-ranking-note"></div>
                </div>
                <div class="table-wrapper">
                  <table id="eom-mom-ranking-table" class="table-modern"></table>
                </div>
              </section>
              <section class="eom-mom-auto">
                <h4>Wnioski automatyczne</h4>
                <div id="eom-mom-auto-insights" class="eom-mom-auto-list"></div>
              </section>
            </div>
          </section>
        </section>
      </div>
    </section>

  <!-- Goals -->
    <section id="tab-goals" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Cele oszczędnościowe</h3>
      <form id="goal-form" class="grid g-4" style="margin-bottom:8px">
        <input required name="name" placeholder="Nazwa (np. Poduszka)" />
        <input required name="target" placeholder="Kwota celu" inputmode="decimal" />
        <label class="tiny" for="startdate">Początek oszczędzania</label>
        <label class="tiny" for="deadline">Termin końcowy</label>
        <input name="startdate" type="date" title="Data rozpoczęcia oszczędzania"/>
        <input name="deadline" type="date" title="Data końcowa"/>
        <button class="btn" type="submit" style="grid-column: 1 / -1;">Dodaj cel</button>
      </form>

      <div id="goal-summary" class="card" style="margin-top:16px; background: #f8fafc;"></div>

      <div id="goal-timeline-wrapper" class="card" style="margin-top:16px;">
        <h4 class="title">Oś czasu celów</h4>
        <div class="timeline-wrapper">
            <div id="timeline-labels" class="timeline-labels"></div>
            <div id="goal-timeline" class="timeline-goals"></div>
            <div id="timeline-axis" class="timeline-axis"></div>
        </div>
      </div>
      
      <div class="card" style="margin-top:16px;">
        <h4 class="title">Harmonogram Miesięcznych Wpłat na Cele</h4>
        <div style="overflow-x:auto;">
            <table id="goal-commitment-table"></table>
        </div>
      </div>

      <div id="goal-list" class="grid g-2" style="gap:10px; margin-top: 16px;"></div>

      <div class="card" style="margin-top:16px">
        <div class="title" id="alloc-form-title">Dodaj alokację na cel</div>
        <form id="alloc-form" class="grid g-3">
          <input type="hidden" name="allocId" />
          <select name="goalId"></select>
          <input name="date" type="date" />
          <input name="amount" placeholder="Kwota" inputmode="decimal" />
          <div style="grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 8px;">
            <button id="alloc-cancel-btn" type="button" class="btn ghost" style="display: none;">Anuluj</button>
            <button id="alloc-submit-btn" type="submit" class="btn">Dodaj alokację</button>
          </div>
        </form>
      </div>
      
      <div class="card" style="margin-top:16px">
        <h4 class="title">Historia ostatnich alokacji</h4>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cel</th>
                    <th>Kwota</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="alloc-history-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Analytics -->
    <section id="tab-analytics" class="card" style="margin-top:12px;display:none">
      <div class="row" style="align-items:center">
        <h3 class="title" style="margin-bottom:0">Centrum Analityczne</h3>
      </div>

      <div class="analytics-filter-card">
        <div class="row" style="align-items:flex-start;gap:12px">
          <div style="flex:1">
            <div class="title" style="margin:0;font-size:18px">Zakres miesięcy</div>
            <div id="analytics-month-summary" class="analytics-summary">Kliknij miesiące, aby ustawić dokładny okres analizy.</div>
          </div>
          <div class="analytics-filter-actions" id="analytics-month-quick">
            <button class="btn soft" data-range="current">Bieżący</button>
            <button class="btn soft" data-range="last3">Ostatnie 3</button>
            <button class="btn soft" data-range="last6">Ostatnie 6</button>
            <button class="btn soft" data-range="year">Bieżący rok</button>
            <button class="btn soft" data-range="all">Wszystkie</button>
          </div>
        </div>
        <div id="analytics-month-picker" class="analytics-month-picker"></div>
      </div>

      <div class="analytics-filter-card">
        <div class="row" style="align-items:flex-start;gap:12px">
          <div style="flex:1">
            <div class="title" style="margin:0;font-size:18px">Filtry kategorii</div>
            <div id="analytics-filter-summary" class="analytics-summary">Zaznacz kategorie, aby analizować je w szczegółach.</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <input id="analytics-category-search" placeholder="Szukaj kategorii" style="min-width:220px" />
            <div class="analytics-filter-actions">
              <button class="btn soft" id="analytics-select-all">Wszystkie</button>
              <button class="btn soft" id="analytics-select-none">Wyczyść</button>
              <button class="btn soft" id="analytics-select-expense">Tylko wydatki</button>
              <button class="btn soft" id="analytics-select-savings">Tylko oszczędności</button>
              <button class="btn soft" id="analytics-select-top5">Top 5 wg sumy</button>
            </div>
          </div>
        </div>
        <div id="analytics-category-filter-list" class="analytics-filter-grid"></div>
      </div>

      <div id="analytics-kpis" class="grid g-4" style="margin-top:12px"></div>

      <div class="grid g-2" style="margin-top:12px">
        <div class="card">
          <div class="title">Przychody vs Wydatki</div>
          <div class="hint">Porównanie całkowitych wpływów, wydatków oraz wydatków z wybranych kategorii.</div>
          <div class="chart-box"><canvas id="analytics-income-expense-chart"></canvas></div>
        </div>
        <div class="card">
          <div class="title">Struktura wybranych kategorii</div>
          <div class="hint">Wizualizacja udziałów kategorii w sumie wydatków objętych filtrem.</div>
          <div class="chart-box"><canvas id="analytics-category-chart"></canvas></div>
        </div>
      </div>

      <div class="grid g-2" style="margin-top:12px">
        <div class="card">
          <div class="title">Aktywność miesięczna (wybrane kategorie)</div>
          <div class="hint">Sprawdź, czy zmiany wynikają z większej liczby transakcji czy z wyższych kwot.</div>
          <div class="chart-box"><canvas id="analytics-monthly-activity-chart"></canvas></div>
        </div>
        <div class="card">
          <div class="title">Średnia i mediana transakcji</div>
          <div class="hint">Porównanie trendu średniej i mediany dla wybranych kategorii.</div>
          <div class="chart-box"><canvas id="analytics-avg-trend-chart"></canvas></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Top kategorie — suma, częstotliwość i średnia</div>
        <div class="hint">Łatwo ocenisz, które kategorie rosną przez większą liczbę transakcji, a które przez wyższe rachunki.</div>
        <div class="chart-box tall"><canvas id="analytics-category-leader-chart"></canvas></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Trendy najważniejszych kategorii</div>
        <div class="hint">Miesięczne wydatki w kluczowych kategoriach objętych filtrem.</div>
        <div class="chart-box tall"><canvas id="analytics-category-trend-chart"></canvas></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 class="title">Macierz kategorii × miesiąc</h4>
        <p class="tiny">W każdej komórce znajdziesz sumę, liczbę transakcji oraz średnią wartość. Kolor wskazuje odchylenie od średniej dla danej kategorii.</p>
        <div style="overflow-x:auto;">
          <table id="analytics-category-trends"></table>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="align-items:flex-end">
          <h4 class="title">Ranking kategorii (wybrane)</h4>
          <span class="tiny muted">Kliknij nagłówek, aby sortować po dowolnym KPI.</span>
        </div>
        <div style="overflow-x:auto;">
          <table id="analytics-category-summary" class="table-sortable"></table>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 class="title">Zmiany miesiąc do miesiąca</h4>
        <p class="tiny">Analiza czy wzrost wynika z liczby transakcji czy z ich wartości.</p>
        <div style="overflow-x:auto;">
          <table id="analytics-category-momentum" class="table-sortable"></table>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 class="title">Przegląd miesięczny (wybrane kategorie)</h4>
        <div style="overflow-x:auto;">
          <table id="analytics-monthly-breakdown"></table>
        </div>
      </div>

      <div class="card" style="margin-top:12px; position: relative;">
        <div class="row">
          <h4 class="title">Największe Pojedyncze Wydatki</h4>
          <span class="tiny muted">Lista respektuje aktualne filtry kategorii.</span>
        </div>
        <p class="tiny">Twoje 10 największych transakcji w wybranym okresie. To dobre miejsce do szukania oszczędności.</p>
        <table id="analytics-top-transactions"></table>
      </div>
    </section>

    <!-- MoM Comparison -->
    <section id="tab-mom" class="card" style="margin-top:12px;display:none">
      <div class="row" style="align-items:flex-start;justify-content:space-between;gap:12px">
        <div>
          <h3 class="title" style="margin-bottom:4px">Porównanie miesiąc do miesiąca</h3>
          <div class="muted" id="mom-info">Wybierz miesiące, aby zobaczyć zestawienie wydatków.</div>
          <div class="mom-summary" id="mom-summary" style="display:none"></div>
        </div>
        <div class="mom-controls">
          <label class="mom-control">Miesiąc A
            <select id="mom-month-a"></select>
          </label>
          <label class="mom-control">Miesiąc B
            <select id="mom-month-b"></select>
          </label>
          <label class="mom-control">Dzień miesiąca
            <input type="number" id="mom-day-input" min="1" max="31" />
          </label>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="align-items:flex-end;justify-content:space-between">
          <h4 class="title">Tempo wydatków</h4>
          <span class="tiny muted">Kliknij kategorię z tabeli, aby zobaczyć jej przebieg.</span>
        </div>
        <div class="chart-box wide">
          <canvas id="mom-chart"></canvas>
          <div class="chart-empty" id="mom-chart-empty" style="display:none">Brak danych do wyświetlenia.</div>
        </div>
        <p class="tiny muted" id="mom-chart-caption" style="margin-top:8px"></p>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="align-items:flex-end;justify-content:space-between">
          <h4 class="title">Dzienna różnica (A − B)</h4>
          <span class="tiny muted">Czerwone słupki oznaczają szybsze tempo w miesiącu A, zielone — wolniejsze.</span>
        </div>
        <div class="chart-box wide">
          <canvas id="mom-diff-chart"></canvas>
          <div class="chart-empty" id="mom-diff-empty" style="display:none">Brak danych do wyświetlenia.</div>
        </div>
        <p class="tiny muted" id="mom-diff-caption" style="margin-top:8px"></p>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="mom-table-header">
          <div class="mom-table-header-meta">
            <h4 class="title">Zestawienie kategorii</h4>
            <span class="tiny muted">Kwoty obejmują wydatki do wybranego dnia.</span>
          </div>
          <button class="btn soft mom-detail-button" id="mom-detail-toggle" type="button" disabled>
            <span class="icon">🔍</span>
            <span class="label">Szczegóły kategorii</span>
          </button>
        </div>
        <div style="overflow-x:auto;">
          <table id="mom-table" class="table-compact">
            <thead>
              <tr>
                <th>Kategoria</th>
                <th id="mom-col-a">Miesiąc A</th>
                <th id="mom-col-b">Miesiąc B</th>
                <th>Różnica</th>
                <th>Tempo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div id="mom-detail-backdrop" class="mom-detail-backdrop" hidden></div>
      <aside id="mom-detail-panel" class="mom-detail-panel" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="mom-detail-header">
          <div class="mom-detail-heading">
            <span class="mom-detail-eyebrow">Analiza kategorii</span>
            <h4 class="mom-detail-title" id="mom-detail-title">Szczegóły kategorii</h4>
            <div class="mom-detail-subtitle" id="mom-detail-subtitle">Wybierz kategorię z tabeli, aby zanurzyć się w transakcje.</div>
          </div>
          <div class="mom-detail-header-actions">
            <div class="mom-detail-sort" id="mom-detail-sort">
              <button type="button" class="is-active" data-mom-detail-sort="impact">Największy wpływ</button>
              <button type="button" data-mom-detail-sort="chron">Chronologicznie</button>
            </div>
            <button type="button" class="mom-detail-close" id="mom-detail-close" data-mom-detail-close aria-label="Zamknij szczegóły">✕</button>
          </div>
        </div>
        <div class="mom-detail-meta" id="mom-detail-meta"></div>
        <div class="mom-detail-body" id="mom-detail-body">
          <div class="mom-detail-empty">Wybierz kategorię z tabeli, aby zobaczyć dzienne wydatki w miesiącu A i B.</div>
        </div>
      </aside>
    </section>
        </main>
        <aside class="right-rail">
          <div class="kpi-compact" id="forecast-kpi">
            <span class="kpi-emoji">🔮</span>
            <div class="kpi-body">
              <span class="kpi-label">Prognozowane oszczędności</span>
              <span class="kpi-value" id="forecast-content">0</span>
              <span class="tiny muted" id="forecast-note">Przy obecnym tempie wydatków</span>
            </div>
          </div>
          <div class="kpi-compact" id="buffer-kpi">
            <span class="kpi-emoji">💰</span>
            <div class="kpi-body">
              <span class="kpi-label">Zapas/dług na dziś</span>
              <span class="kpi-value" id="buffer-content">0</span>
              <span class="tiny muted" id="buffer-note">Plan vs wydatki do dziś</span>
            </div>
          </div>
          <div class="kpi-compact" id="mom-diff-kpi">
            <span class="kpi-emoji">🆚</span>
            <div class="kpi-body">
              <span class="kpi-label">MoM bez stałych</span>
              <span class="kpi-value" id="dash-mom-diff">—</span>
              <span class="tiny muted" id="dash-mom-note">Porównanie dostępne dla bieżącego miesiąca</span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">💸</span>
            <div class="kpi-body">
              <span class="kpi-label">Pozostały budżet</span>
              <span class="kpi-value" id="dash-remaining">0</span>
              <span class="tiny muted">Na wydatki zmienne</span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">📉</span>
            <div class="kpi-body">
              <span class="kpi-label">Limit dzienny</span>
              <span class="kpi-value" id="dash-daily-budget">0</span>
              <span class="tiny muted">Trend: <span id="dash-daily-trend">—</span></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">📅</span>
            <div class="kpi-body">
              <span class="kpi-label">Wydane dziś</span>
              <span class="kpi-value" id="dash-today-spent">0</span>
              <span class="tiny muted">Status: <span id="dash-today-vs-budget">—</span></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">📊</span>
            <div class="kpi-body">
              <span class="kpi-label">Średnia dzienna</span>
              <span class="kpi-value" id="dash-avg-daily">0</span>
              <span class="tiny muted">Porównanie: <span id="dash-avg-trend">—</span></span>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    (function activateSidebarLink() {
      const currentPage = document.body.dataset.page;
      if (!currentPage) return;
      document.querySelectorAll('.sidebar__link[data-page]').forEach((link) => {
        if (link.dataset.page === currentPage) {
          link.classList.add('sidebar__link--active');
          link.setAttribute('aria-current', 'page');
        } else {
          link.classList.remove('sidebar__link--active');
          link.removeAttribute('aria-current');
        }
      });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // --- Storage & helpers ------------------------------------------------------
  const STORAGE_KEY='lifeos_budget_v4';

  function monthKey(d=new Date()){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
  function ymAdd(ym,delta){const d=new Date(ym+'-01'); d.setMonth(d.getMonth()+delta); return monthKey(d)}
  
  function fmt(n, c = 'PLN') {
    try {
        const numValue = Number(n || 0);
        const parts = numValue.toFixed(2).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "\u00A0");
        return `${parts.join(',')}\u00A0${c}`;
    } catch {
        return `${Number(n || 0).toFixed(2)}\u00A0${c}`;
    }
  }

  function escapeHtml(value){
    if(value === undefined || value === null) return '';
    return String(value).replace(/[&<>"']/g, ch => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":"&#39;"
    }[ch] || ch));
  }

  function num(s){
    if(typeof s==='number') return s;
    if(!s) return 0;
    const raw = String(s).replace(/\s|\u00A0/g,'');
    let normalized = raw;
    if(raw.includes(',') && raw.includes('.')) normalized = raw.replace(/\./g,'').replace(',','.');
    else normalized = raw.replace(',','.');
    normalized = normalized.replace(/[^0-9.\-]/g,'');
    const n = Number(normalized);
    return Number.isFinite(n) ? n : 0;
  }
  function daysInYm(ym){const [y,m]=ym.split('-').map(Number); return new Date(y,m,0).getDate()}
  function dateFromYmDay(ym,day){const d=Math.min(Math.max(1,Number(day)||1), daysInYm(ym)); return `${ym}-${String(d).padStart(2,'0')}`}

  function load(){try{const raw=localStorage.getItem(STORAGE_KEY);return raw?JSON.parse(raw):null}catch{return null}}
  function save(s){localStorage.setItem(STORAGE_KEY,JSON.stringify(s))}

  // --- State Migration & Definition --------------------------------------------
  function migrateState(st){
    if(!st || !st.modules) st={modules:{}};
    if(!st.currency) st.currency = 'PLN';
    if(!st.modules.budget) st.modules.budget={};
    const bud=st.modules.budget;
    if(!Array.isArray(bud.categories)) bud.categories=[];
    bud.categories = bud.categories.map(c=>{
      const id = c?.id || ('cat_'+Math.random().toString(36).slice(2));
      const name = (c?.name || 'Bez nazwy').toString();
      let type = c?.type; if(!['expense','income','saving'].includes(type)) type='expense';
      return {emoji:c?.emoji||'', budget:num(c?.budget)||0, id, name, type};
    });
    if(bud.categories.length===0){
      bud.categories.push(
        {id:'c_inc',name:'Wynagrodzenie',type:'income'},
        {id:'c_save',name:'Oszczędności',type:'saving', emoji:'🏦'},
        {id:'c_fixed',name:'Wydatki stałe',type:'expense',emoji:'💳'},
        {id:'c_food',name:'Jedzenie',type:'expense',emoji:'🍕'},
        {id:'c_transport',name:'Transport',type:'expense',emoji:'🚌'},
        {id:'c_misc',name:'Różne',type:'expense',emoji:'🛒'}
      );
    }
    const cf=bud.categories.find(c=>c.id==='c_fixed' || c.name==='Wydatki stałe');
    if(!cf) bud.categories.unshift({id:'c_fixed',name:'Wydatki stałe',type:'expense',emoji:'💳'});
    else {cf.id='c_fixed'; cf.name='Wydatki stałe'; cf.type='expense'; cf.emoji=cf.emoji||'💳'}

    if(!Array.isArray(bud.accounts)) bud.accounts=[{id:'a_main',name:'Konto główne'}];
    if(!Array.isArray(bud.quickActions)) bud.quickActions=[];
    if(typeof bud.workingMonth!=='string' || !/^\d{4}-\d{2}$/.test(bud.workingMonth)) bud.workingMonth=monthKey();
    if(!bud.monthly) bud.monthly={};
    if(!Array.isArray(bud.transactions)) bud.transactions=[];
    if(!Array.isArray(bud.eom)) bud.eom=[];
    if(!Array.isArray(bud.goals)) bud.goals=[];
    bud.goals = bud.goals.map(g => ({...g, startDate: g.startDate || new Date().toISOString().slice(0,10)}));
    if(!Array.isArray(bud.goalAllocations)) bud.goalAllocations=[];
    if(typeof bud.createTxOnFixedPay!=='boolean') bud.createTxOnFixedPay=true;
    if(!Array.isArray(bud.recurringTemplates)) bud.recurringTemplates=[];
    if(!Array.isArray(bud.recurringLog)) bud.recurringLog=[];
    // NEW: fixed expense templates
    if(!Array.isArray(bud.fixedTemplates)) bud.fixedTemplates=[];

    return st;
  }

  function def(){
    return migrateState({
      version:4, currency:'PLN',
      modules:{budget:{
        categories:[
          {id:'c_inc',name:'Wynagrodzenie',type:'income'},
          {id:'c_save',name:'Oszczędności',type:'saving', emoji:'🏦'},
          {id:'c_fixed',name:'Wydatki stałe',type:'expense',emoji:'💳'},
          {id:'c_food',name:'Jedzenie',type:'expense',emoji:'🍕'},
          {id:'c_transport',name:'Transport',type:'expense',emoji:'🚌'},
          {id:'c_misc',name:'Różne',type:'expense',emoji:'🛒'}
        ],
        accounts:[{id:'a_main',name:'Konto główne'},{id:'a_sav',name:'Oszczędności'}],
        quickActions:[],
        monthly:{},transactions:[],eom:[],goals:[],goalAllocations:[],
        workingMonth:monthKey(),
        createTxOnFixedPay:true,
        recurringTemplates:[],recurringLog:[],
        fixedTemplates:[]
      }}
    });
  }

  let state = migrateState(load()) || def();
  const b=()=>state.modules.budget;

  // --- Core Helpers ----------------------------------------------------------------
  function ensureMonth(ym){if(!b().monthly[ym]) b().monthly[ym]={ incomes:[], fixed:[] }}
  function setDefaultDate(){const i=document.querySelector('#var-form input[name="date"]'); if(i && !i.value){i.value=new Date().toISOString().slice(0,10)}}
  const catsById=()=>Object.fromEntries((b().categories||[]).map(c=>[c.id,c]));
  function catType(id){const c=catsById()[id];return c?c.type:undefined}
  function signFor(catId, amt){const t=catType(catId); return t==='expense'?-Math.abs(amt):Math.abs(amt)}
  function txTotalSigned(tx){
    if(tx.splits?.length){return tx.splits.reduce((s,sp)=>s+signFor(sp.categoryId,num(sp.amount)),0)}
    return num(tx.amount)
  }
  function entriesForMonth(ym){
    const out=[];
    for(const t of (b().transactions||[])){
      if(!String(t.date||'').startsWith(ym)) continue;
      if(t.splits?.length){
        for(const s of t.splits){
          out.push({date:t.date,categoryId:s.categoryId,accountId:t.accountId,amount:signFor(s.categoryId,num(s.amount)),parentId:t.id,note:t.note});
        }
      }else{
        out.push({date:t.date,categoryId:t.categoryId,accountId:t.accountId,amount:num(t.amount),parentId:t.id,note:t.note});
      }
    }
    return out;
  }

  // --- UI glue ----------------------------------------------------------------
  function bindMoneyInputs(root=document){
    root.querySelectorAll('input[inputmode="decimal"]').forEach(inp=>{
      if(inp.dataset.moneyBound) return;
      inp.dataset.moneyBound='1';
      inp.addEventListener('input', e=>{e.target.value=e.target.value.replace(/\u00A0/g,' ').replace(/[^\d.,\-\s]/g,'')});
      inp.addEventListener('blur', e=>{const v=num(e.target.value); e.target.value=v===0?'':String(v).replace('.',',')});
    });
  }
  const tabs=document.querySelectorAll('.tab');
  const sections={dashboard:tab('dashboard'),overview:tab('overview'),incomes:tab('incomes'),fixed:tab('fixed'),variable:tab('variable'),categories:tab('categories'),eom:tab('eom'),goals:tab('goals'),analytics:tab('analytics'),mom:tab('mom')};
  const varCard=document.getElementById('var-transactions-card');
  const varSlots={dashboard:document.getElementById('var-table-dashboard-slot'),variable:document.getElementById('var-table-variable-slot')};
  function placeVarCard(target){
    if(!varCard) return;
    const slot=varSlots[target];
    if(slot && varCard.parentElement!==slot){
      slot.appendChild(varCard);
    }
  }
  placeVarCard('dashboard');
  function tab(id){return document.getElementById('tab-'+id)}
  for(const t of tabs){
    t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      Object.values(sections).forEach(s=>s.style.display='none'); sections[t.dataset.tab].style.display='block';
      if(t.dataset.tab==='variable'){placeVarCard('variable'); setDefaultDate()}
      else if(t.dataset.tab==='dashboard'){placeVarCard('dashboard')}
      if(t.dataset.tab==='analytics') renderAnalytics(); // Render analytics when tab is clicked
      if(t.dataset.tab==='eom') renderEOMHistory(); // Render history when tab is clicked
      if(t.dataset.tab==='mom') renderMomComparison();
      bindMoneyInputs();
    });
  }
  document.getElementById('prevMonthBtn').onclick=()=>{b().workingMonth=ymAdd(b().workingMonth,-1);save(state);renderAll()};
  document.getElementById('nextMonthBtn').onclick=()=>{b().workingMonth=ymAdd(b().workingMonth,1);save(state);renderAll()};
  document.getElementById('exportBtn').onclick=()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`budzet_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove()},0);
  };
  document.getElementById('importBtn').onclick=()=>document.getElementById('importFile').click();
  document.getElementById('importFile').addEventListener('change', async (e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    try{
      const text=await file.text(); const json=JSON.parse(text);
      const migrated=migrateState(json);
      if(!migrated?.modules?.budget){alert('Plik nie wygląda na poprawny eksport.'); return;}
      if(!confirm('Czy na pewno chcesz nadpisać obecne dane danymi z pliku?')) return;
      state=migrated; save(state); location.reload();
    }catch(err){console.error(err); alert('Błąd podczas importu pliku.')}
  });

  // --- Quick actions ----------------------------------------------------------
  function renderQuickActions(){
    const grid=document.getElementById('qa-grid'); grid.innerHTML='';
    for(const qa of (b().quickActions||[])){
      const cat=catsById()[qa.categoryId];
      const btn=document.createElement('div'); btn.className='quick-btn';
      btn.innerHTML=`<div>${qa.emoji||'⚡'} ${qa.label}</div><div class="muted">${cat?.type==='expense'?'Wydatek': cat?.type==='saving'?'Oszczędność':'Wpływ'}</div>`;
      btn.onclick=()=>quickActionRun(qa.id); grid.appendChild(btn);
    }
    fillQaEditorSelects(); renderQuickActionsEditorRows();
  }
  function quickActionRun(id){
    const qa=(b().quickActions||[]).find(x=>x.id===id); if(!qa){alert('Nie znaleziono akcji');return;}
    const amtStr=prompt('Podaj kwotę:', qa.defaultAmount ?? ''); if(amtStr===null) return;
    const amountRaw=num(amtStr);
    const note=prompt('Notatka (opcjonalnie):', qa.defaultNote ?? '')||'';
    const signed = signFor(qa.categoryId, amountRaw);
    const date=new Date().toISOString().slice(0,10);
    b().transactions.unshift({id:`tx_${Math.random().toString(36).slice(2)}`,date,amount:signed,categoryId:qa.categoryId,accountId:qa.accountId||b().accounts[0]?.id||'a_main',note});
    save(state); renderAll();
  }
  function fillQaEditorSelects(){
    const editor=document.getElementById('qa-editor');
    const catSel=editor.querySelector('select[name="categoryId"]'); if(catSel){catSel.innerHTML=''; for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}}
    const accSel=editor.querySelector('select[name="accountId"]'); if(accSel){accSel.innerHTML=''; for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id))}}
  }
  document.getElementById('qa-edit-toggle').onclick=()=>{const ed=document.getElementById('qa-editor'); ed.style.display = ed.style.display==='none' ? 'block' : 'none';};
  document.getElementById('qa-add-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const qa={id:'qa_'+Math.random().toString(36).slice(2),label:String(f.get('label')||''),emoji:String(f.get('emoji')||''),categoryId:String(f.get('categoryId')),accountId:String(f.get('accountId')),defaultAmount:String(f.get('defaultAmount')||''),defaultNote:String(f.get('defaultNote')||'')};
    b().quickActions.push(qa); save(state); e.target.reset(); renderQuickActions(); bindMoneyInputs(document.getElementById('qa-editor'));
  }
  function renderQuickActionsEditorRows(){
    const tbody=document.getElementById('qa-rows'); tbody.innerHTML='';
    for(const qa of (b().quickActions||[])){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input value="${qa.emoji||''}" data-k="emoji" /></td>
        <td><input value="${qa.label||''}" data-k="label" /></td>
        <td><select data-k="categoryId"></select></td>
        <td><select data-k="accountId"></select></td>
        <td><input inputmode="decimal" value="${qa.defaultAmount||''}" data-k="defaultAmount" /></td>
        <td><input value="${qa.defaultNote||''}" data-k="defaultNote" /></td>
        <td class="row" style="gap:6px">
          <button class="btn soft" data-act="save">Zapisz</button>
          <button class="btn danger" data-act="del">X</button>
        </td>`;
      const catSel=tr.querySelector('select[data-k="categoryId"]');
      const accSel=tr.querySelector('select[data-k="accountId"]');
      for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id, false, c.id===qa.categoryId))}
      for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id, false, a.id===qa.accountId))}
      tr.querySelector('[data-act="save"]').onclick=()=>{
        qa.emoji=tr.querySelector('[data-k="emoji"]').value;
        qa.label=tr.querySelector('[data-k="label"]').value;
        qa.categoryId=tr.querySelector('[data-k="categoryId"]').value;
        qa.accountId=tr.querySelector('[data-k="accountId"]').value;
        qa.defaultAmount=tr.querySelector('[data-k="defaultAmount"]').value;
        qa.defaultNote=tr.querySelector('[data-k="defaultNote"]').value;
        save(state); renderQuickActions();
      };
      tr.querySelector('[data-act="del"]').onclick=()=>{ if(!confirm('Usunąć szybką akcję?')) return; b().quickActions=b().quickActions.filter(x=>x.id!==qa.id); save(state); renderQuickActions(); };
      tbody.appendChild(tr);
    }
    bindMoneyInputs(document.getElementById('qa-editor'));
  }
  
  // --- NEW: Fixed Expenses Templates & Suggestions ---------------------------------
  function fixedExistsForTpl(ym, tplId){ensureMonth(ym); return b().monthly[ym].fixed.some(f=>f.tplId===tplId)}

  function applyFixedTemplate(tpl, ym){
    ensureMonth(ym);
    if(fixedExistsForTpl(ym, tpl.id)) return;
    b().monthly[ym].fixed.push({
      id:`fix_${Math.random().toString(36).slice(2)}`,
      tplId: tpl.id, title: tpl.title, amount: num(tpl.amount),
      due: dateFromYmDay(ym, tpl.day), paid:false, categoryId:'c_fixed'
    });
  }

  function renderFixedSuggestions(){
    const ym=b().workingMonth;
    const box=document.getElementById('fix-suggestions-box');
    const list=document.getElementById('fix-suggestions-list');
    
    const candidates=(b().fixedTemplates||[]).filter(t=>!fixedExistsForTpl(ym,t.id));
    if(candidates.length === 0) {
      box.style.display='none';
      return;
    }

    box.style.display='block'; list.innerHTML='';
    for(const t of candidates){
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="row">
          <div><b>${t.title}</b> <span class="muted">(dzień ${t.day})</span></div>
          <b>${fmt(num(t.amount),state.currency)}</b>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="hint">Termin w tym miesiącu: ${dateFromYmDay(ym,t.day)}</div>
          <button class="btn soft" data-act="add">Dodaj</button>
        </div>`;
      card.querySelector('[data-act="add"]').onclick=()=>{applyFixedTemplate(t,ym); save(state); renderAll()};
      list.appendChild(card);
    }
    document.getElementById('fix-apply-all-btn').onclick=()=>{
      for(const t of candidates) applyFixedTemplate(t,ym);
      save(state); renderAll();
    };
  }
  
  function renderFixedTemplatesManager(){
    const form = document.getElementById('fix-template-form');
    form.onsubmit = e => {
      e.preventDefault();
      const f = new FormData(form);
      const tpl = {
        id:'ftpl_'+Math.random().toString(36).slice(2),
        title: String(f.get('title')||'').trim(),
        amount: num(f.get('amount')),
        day: Number(f.get('day'))
      };
      if(!tpl.title || !tpl.amount || !tpl.day) {alert('Uzupełnij wszystkie pola szablonu.'); return;}
      b().fixedTemplates.push(tpl);
      save(state); form.reset(); renderFixedTemplatesManager(); renderFixedSuggestions();
    }

    const tbody = document.getElementById('fix-templates-tbody'); tbody.innerHTML = '';
    for(const t of (b().fixedTemplates||[])) {
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${t.title}</td>
        <td>${fmt(num(t.amount),state.currency)}</td>
        <td>${t.day}</td>
        <td><button class="btn danger" data-act="del">Usuń</button></td>`;
      tr.querySelector('[data-act="del"]').onclick=()=>{
        if(!confirm(`Czy na pewno usunąć szablon "${t.title}"?`)) return;
        b().fixedTemplates = b().fixedTemplates.filter(x => x.id !== t.id);
        save(state); renderFixedTemplatesManager(); renderFixedSuggestions();
      };
      tbody.appendChild(tr);
    }
    bindMoneyInputs(form);
  }

  // --- Daily calculations (spending + savings) --------------------------------
  function getDailySpending(ym){
    const daily={};
    const entries=entriesForMonth(ym);
    for(const e of entries){
      const c=catsById()[e.categoryId];
      if(!c || !((c.type==='expense' && c.id!=='c_fixed') || c.type==='saving')) continue;
      const day=parseInt(e.date.slice(-2));
      daily[day]=(daily[day]||0)+Math.abs(e.amount);
    }
    return daily;
  }
  function getDaysRemaining(ym){
    const today=new Date(); const currentYm=monthKey(today);
    if(ym < currentYm) return 0; // Past month
    if(ym > currentYm) return daysInYm(ym); // Future month
    // Current month
    const daysInMonth = daysInYm(ym);
    return Math.max(0, daysInMonth - today.getDate());
  }

  // --- Dashboard --------------------------------------------------------------
  function renderDashboard(){
    const ym=b().workingMonth; ensureMonth(ym);
    const incSum=b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
    const fixSum=b().monthly[ym].fixed.reduce((s,x)=>s+num(x.amount),0);
    const days=daysInYm(ym);
    const dailyBudget=Math.max(0,(incSum-fixSum)/days);

      const entries=entriesForMonth(ym);
      const cb=catsById();
    
    const variableSpent = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return (c?.type === 'expense' && c.id !== 'c_fixed') ? s + Math.abs(e.amount) : s;
    }, 0);
    const savingsTransfers = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return c?.type === 'saving' ? s + Math.abs(e.amount) : s;
    }, 0);
    const remain = incSum - fixSum - variableSpent - savingsTransfers;

    document.getElementById('dash-remaining').textContent=fmt(remain, state.currency);
    document.getElementById('dash-daily-budget').textContent=fmt(dailyBudget, state.currency);

    const todayKey=new Date().toISOString().slice(0,10);
    const todaySpent=entries.filter(e=>e.date===todayKey).reduce((s,e)=>{
      const c=cb[e.categoryId];
      return (!c || !((c.type==='expense' && c.id!=='c_fixed') || c.type==='saving')) ? s : s + Math.abs(e.amount);
    },0);
    document.getElementById('dash-today-spent').textContent=fmt(todaySpent, state.currency);
    document.getElementById('dash-today-vs-budget').textContent = todaySpent<=dailyBudget ? '✅ w limicie dziennym' : '⚠️ powyżej limitu';

    const daysElapsed = (ym === monthKey()) ? new Date().getDate() : (monthKey() > ym ? days : 0);
    const daily=getDailySpending(ym);
    const spentSoFar=Object.values(daily).reduce((a,b)=>a+b,0);
    const avgDaily = (daysElapsed > 0 ? (spentSoFar / daysElapsed) : 0);
    document.getElementById('dash-avg-daily').textContent=fmt(avgDaily, state.currency);
    document.getElementById('dash-avg-trend').textContent = avgDaily <= dailyBudget ? '👍 poniżej planu' : '👎 powyżej planu';

    // Heatmap
    const cal=document.getElementById('daily-spending-calendar'); cal.innerHTML='';
    for(let d=1; d<=days; d++){
      const val=daily[d]||0;
      const box=document.createElement('div');
      let bg='#edf2f7'; // default for no spending
      if (val > 0) bg = '#dcfce7'; // in budget
      if(val>dailyBudget*1.2) bg='#fee2e2'; else if(val>dailyBudget) bg='#ffedd5';
      box.className='heat-day'; box.style.background=bg; box.title=`${String(d).padStart(2,'0')}: ${fmt(val, state.currency)}`; box.textContent=String(d);
      cal.appendChild(box);
    }

    renderRecentSpendingTiles();

    // --- Forecast & Buffer Section (NEW) ---
    const daysLeft = getDaysRemaining(ym);
    const totalVariableBudget = incSum - fixSum;
    const projectedTotalVariableOutflow = spentSoFar + (daysLeft * avgDaily);
    const forecastedSavings = totalVariableBudget - projectedTotalVariableOutflow;
    
    const forecastEl = document.getElementById('forecast-content');
    const forecastNote = document.getElementById('forecast-note');
    forecastEl.textContent = fmt(forecastedSavings, state.currency);
    forecastEl.classList.remove('ok', 'bad');
    forecastEl.classList.add(forecastedSavings >= 0 ? 'ok' : 'bad');
    forecastNote.textContent = forecastedSavings >= 0
      ? 'Możliwa nadwyżka przy obecnym tempie'
      : 'Ryzyko przekroczenia budżetu zmiennego';

    const bufferEl = document.getElementById('buffer-content');
    const bufferNote = document.getElementById('buffer-note');
    bufferEl.classList.remove('ok', 'bad');
    if (ym === monthKey() && daysElapsed > 0 && daysElapsed <= days) {
      const dayOfMonth = new Date().getDate();
      const allowedToSpendUntilToday = dailyBudget * dayOfMonth;
      const spentUntilToday = Object.entries(daily)
        .filter(([day]) => parseInt(day) <= dayOfMonth)
        .reduce((sum, [, amount]) => sum + amount, 0);
      const buffer = allowedToSpendUntilToday - spentUntilToday;
      bufferEl.textContent = fmt(buffer, state.currency);
      bufferEl.classList.add(buffer >= 0 ? 'ok' : 'bad');
      bufferNote.textContent = `Plan: ${fmt(allowedToSpendUntilToday, state.currency)} | Wydano: ${fmt(spentUntilToday, state.currency)}`;
    } else {
      bufferEl.textContent = '—';
      bufferNote.textContent = 'Dostępne tylko dla bieżącego miesiąca';
    }

    const momDiffValueEl = document.getElementById('dash-mom-diff');
    const momDiffNoteEl = document.getElementById('dash-mom-note');
    if (momDiffValueEl && momDiffNoteEl) {
      momDiffValueEl.classList.remove('ok', 'bad');
      if (ym === monthKey() && daysElapsed > 0 && daysElapsed <= days) {
        const today = new Date();
        const dayOfMonth = today.getDate();
        const currentDayLimit = Math.min(dayOfMonth, days);
        const prevYm = ymAdd(ym, -1);
        const prevDayLimit = Math.min(currentDayLimit, daysInYm(prevYm));
        const sumVariableToDay = (targetYm, limit) => {
          if (!limit) return 0;
          return entriesForMonth(targetYm).reduce((acc, entry) => {
            const cat = cb[entry.categoryId];
            if (!cat || cat.type !== 'expense' || cat.id === 'c_fixed') return acc;
            const day = Number(entry.date.slice(8, 10));
            if (!Number.isFinite(day) || day > limit) return acc;
            return acc + Math.abs(entry.amount);
          }, 0);
        };
        const currentSpent = sumVariableToDay(ym, currentDayLimit);
        const previousSpent = sumVariableToDay(prevYm, prevDayLimit);
        const diff = currentSpent - previousSpent;
        const diffFormatted = fmt(diff, state.currency);
        momDiffValueEl.textContent = diff > 0 ? `+${diffFormatted}` : diffFormatted;
        if (diff > 0) {
          momDiffValueEl.classList.add('bad');
        } else if (diff < 0) {
          momDiffValueEl.classList.add('ok');
        }
        const currentDayLabel = String(currentDayLimit).padStart(2, '0');
        const prevDayLabel = String(prevDayLimit).padStart(2, '0');
        const dayNote = prevDayLimit === currentDayLimit ? currentDayLabel : `${currentDayLabel} / ${prevDayLabel}`;
        momDiffNoteEl.textContent = `${ym}: ${fmt(currentSpent, state.currency)} | ${prevYm}: ${fmt(previousSpent, state.currency)} (do dnia ${dayNote})`;
      } else {
        momDiffValueEl.textContent = '—';
        momDiffNoteEl.textContent = 'Dostępne tylko dla bieżącego miesiąca';
      }
    }

    renderDashboardCharts(ym, dailyBudget, avgDaily);
    renderQuickActions();
  }

  function currencyTicks(v) {
    try {
        const numValue = Math.round(Number(v || 0));
        const integerPart = String(numValue).replace(/\B(?=(\d{3})+(?!\d))/g, "\u00A0");
        return `${integerPart}\u00A0${state.currency || 'PLN'}`;
    } catch {
        return `${Math.round(Number(v || 0))}\u00A0${state.currency || 'PLN'}`;
    }
  }

  function renderRecentSpendingTiles(){
    const container=document.getElementById('recent-spending-calendar');
    if(!container) return;
    container.innerHTML='';
    const totalChip=document.getElementById('recent-seven-total');
    const today=new Date();
    today.setHours(0,0,0,0);
    const dayKeyFromDate=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const dayDates=[];
    for(let offset=6; offset>=0; offset--){
      const d=new Date(today);
      d.setDate(today.getDate()-offset);
      dayDates.push(d);
    }
    const months=[...new Set(dayDates.map(d=>monthKey(d)))];
    let allEntries=[];
    for(const ym of months){
      allEntries=allEntries.concat(entriesForMonth(ym));
    }
    const cb=catsById();
    const accountsById=Object.fromEntries((b().accounts||[]).map(acc=>[acc.id,acc]));
    const startKey=dayKeyFromDate(dayDates[0]);
    const endKey=dayKeyFromDate(dayDates[dayDates.length-1]);
    const filteredBase=[];
    for(const entry of allEntries){
      if(entry.date<startKey || entry.date>endKey) continue;
      const cat=cb[entry.categoryId];
      if(!cat || cat.type!=='expense' || cat.id==='c_fixed') continue;
      const amount=Math.abs(entry.amount);
      if(amount<=0) continue;
      filteredBase.push({entry, amount, cat});
    }
    const filtered=filteredBase.map((item, idx)=>({...item, idx}));
    const totalAmount=filtered.reduce((sum,item)=>sum+item.amount,0);
    if(totalChip){
      totalChip.textContent=filtered.length?`Łącznie: ${fmt(totalAmount, state.currency)}`:'Łącznie: —';
    }
    const topIdx=new Set(filtered.slice().sort((a,b)=>b.amount-a.amount).slice(0,5).map(item=>item.idx));
    const grouped=new Map();
    for(const item of filtered){
      if(!grouped.has(item.entry.date)) grouped.set(item.entry.date, []);
      grouped.get(item.entry.date).push(item);
    }
    const weekdayFmt=new Intl.DateTimeFormat('pl-PL',{weekday:'short'});
    const dateFmt=new Intl.DateTimeFormat('pl-PL',{day:'2-digit',month:'2-digit'});
    const tooltipDateFmt=new Intl.DateTimeFormat('pl-PL',{year:'numeric',month:'short',day:'2-digit'});
    for(const dateObj of dayDates){
      const key=dayKeyFromDate(dateObj);
      const tile=document.createElement('div');
      tile.className='recent-day';
      const header=document.createElement('div');
      header.className='recent-day-header';
      const weekdayEl=document.createElement('span');
      weekdayEl.className='recent-day-weekday';
      weekdayEl.textContent=weekdayFmt.format(dateObj).replace('.', '').toUpperCase();
      const dateEl=document.createElement('span');
      dateEl.className='recent-day-date';
      dateEl.textContent=dateFmt.format(dateObj);
      header.append(weekdayEl, dateEl);
      tile.appendChild(header);
      const dayItems=(grouped.get(key)||[]).sort((a,b)=>b.amount-a.amount);
      const dayTotal=dayItems.reduce((sum,item)=>sum+item.amount,0);
      const total=document.createElement('div');
      total.className='recent-day-total';
      const totalIcon=document.createElement('span');
      totalIcon.setAttribute('aria-hidden','true');
      totalIcon.textContent='💰';
      total.append(totalIcon, document.createTextNode(dayItems.length?fmt(dayTotal, state.currency):'—'));
      if(dayItems.length===0){
        tile.classList.add('recent-day-empty');
      }
      tile.appendChild(total);
      const body=document.createElement('div');
      body.className='recent-day-body';
      if(dayItems.length===0){
        const empty=document.createElement('div');
        empty.className='recent-empty';
        empty.textContent='brak ruchu';
        body.appendChild(empty);
      }else{
        const maxVisible=2;
        const extraRows=[];
        dayItems.forEach((item, idx)=>{
          const row=document.createElement('div');
          row.className='recent-entry';
          if(topIdx.has(item.idx)) row.classList.add('top-spend');
          if(idx>=maxVisible){
            row.classList.add('recent-entry-hidden');
            extraRows.push(row);
          }
          const emoji=item.cat?.emoji||'💸';
          const emojiEl=document.createElement('span');
          emojiEl.className='recent-entry-emoji';
          emojiEl.textContent=emoji;
          const textWrap=document.createElement('div');
          textWrap.className='recent-entry-text';
          const amountEl=document.createElement('span');
          amountEl.className='recent-entry-amount';
          amountEl.textContent=fmt(item.amount, state.currency);
          textWrap.appendChild(amountEl);
          const noteText=(item.entry.note||'').trim();
          if(noteText){
            const noteEl=document.createElement('span');
            noteEl.className='recent-entry-note';
            noteEl.textContent=noteText;
            textWrap.appendChild(noteEl);
          }
          const [yy,mm,dd]=item.entry.date.split('-').map(Number);
          const entryDate=new Date(yy, (mm||1)-1, dd||1);
          const tooltipParts=[
            [emoji, item.cat?.name||'Wydatek'].filter(Boolean).join(' '),
            `Kwota: ${fmt(item.amount, state.currency)}`,
            `Data: ${tooltipDateFmt.format(entryDate)}`,
            `Konto: ${accountsById[item.entry.accountId]?.name||'—'}`
          ];
          if(item.entry.note){
            tooltipParts.push(`Notatka: ${item.entry.note}`);
          }
          row.title=tooltipParts.join('\n');
          row.setAttribute('aria-label', tooltipParts.join(', '));
          row.append(emojiEl, textWrap);
          body.appendChild(row);
        });
        if(extraRows.length){
          const collapsedLabel=`+${extraRows.length}`;
          const toggle=document.createElement('button');
          toggle.type='button';
          toggle.className='recent-more';
          toggle.textContent=collapsedLabel;
          toggle.title='Pokaż więcej wydatków';
          toggle.setAttribute('aria-expanded','false');
          toggle.addEventListener('click',()=>{
            const expanded=tile.classList.toggle('expanded');
            extraRows.forEach(row=>row.classList.toggle('recent-entry-hidden', !expanded));
            toggle.textContent=expanded?'−':collapsedLabel;
            toggle.setAttribute('aria-expanded', expanded?'true':'false');
          });
          body.appendChild(toggle);
        }
      }
      tile.appendChild(body);
      container.appendChild(tile);
    }
  }

  function renderDashboardCharts(ym, dailyBudget, avgDaily) {
    const dailyCtx=document.getElementById('dailyLine').getContext('2d');
    const cumCtx=document.getElementById('cumulativeLine').getContext('2d');
    if(window.dashDaily) window.dashDaily.destroy();
    if(window.dashCum) window.dashCum.destroy();
    
    const daysInMonth=daysInYm(ym);
    const dailySpending=getDailySpending(ym);
    const labels=[]; const spendData=[]; const cumSpend=[]; const cumAllowed=[];
    let runningTotal=0;
    
    for(let d=1; d<=daysInMonth; d++){
      labels.push(d.toString());
      const dailyS=dailySpending[d]||0; 
      spendData.push(dailyS); 
      runningTotal+=dailyS; 
      cumSpend.push(runningTotal); 
      cumAllowed.push(d*dailyBudget);
    }
    
    const backgroundColors = [];
    const borderColors = [];
    for(const spending of spendData) {
        let color;
        if (spending === 0) {
            color = 'rgba(100, 116, 139, 0.5)'; // Muted
        } else if (spending > dailyBudget * 1.2) {
            color = 'rgba(190, 18, 60, 0.7)'; // Red
        } else if (spending > dailyBudget) {
            color = 'rgba(234, 88, 12, 0.7)'; // Orange
        } else {
            color = 'rgba(5, 150, 105, 0.7)'; // Green
        }
        backgroundColors.push(color);
        borderColors.push(color.replace(/0\.\d+\)/, '1)'));
    }
    const entries = entriesForMonth(ym);
    const cb = catsById();

    window.dashDaily = new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'Wydatki dzienne',
                    data: spendData,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                    order: 3
                },
                {
                    type: 'line',
                    label: 'Limit dzienny',
                    data: Array(daysInMonth).fill(dailyBudget),
                    borderColor: 'rgba(190, 18, 60, 0.7)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [6, 6],
                    tension: 0.1,
                    order: 1
                },
                {
                    type: 'line',
                    label: 'Średnia dzienna',
                    data: Array(daysInMonth).fill(avgDaily),
                    borderColor: 'rgba(234, 88, 12, 0.7)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    order: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: currencyTicks }
                },
                x: {
                    grid: { display: false }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${fmt(context.raw, state.currency)}`;
                        },
                        afterBody: function(tooltipItems) {
                            const dataIndex = tooltipItems[0].dataIndex;
                            const day = dataIndex + 1;
                            const dayString = `${ym}-${String(day).padStart(2, '0')}`;

                            const dayExpenses = entries
                                .filter(e => {
                                    const cat = cb[e.categoryId];
                                    return e.date === dayString && cat && (cat.type === 'expense' || cat.type === 'saving') && cat.id !== 'c_fixed';
                                })
                                .sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount));
                            
                            if (dayExpenses.length === 0) {
                                return [];
                            }

                            const top3 = dayExpenses.slice(0, 3);
                            const lines = top3.map(e => {
                                const cat = cb[e.categoryId];
                                return `  ${cat.emoji||'💸'} ${cat.name.slice(0,15)}: ${fmt(Math.abs(e.amount), '')}`;
                            });
                            
                            lines.unshift('');
                            lines.unshift('Największe wydatki:');
                            return lines;
                        }
                    }
                }
            }
        }
    });

    window.dashCum=new Chart(cumCtx,{type:'line',data:{labels,datasets:[{label:'Skumulowane wydatki',data:cumSpend,borderColor:'#be123c',backgroundColor:'rgba(190,18,60,0.08)',tension:0.3,fill:true},{label:'Skumulowany limit',data:cumAllowed,borderColor:'#059669',backgroundColor:'rgba(5,150,105,0.08)',tension:0.3,fill:true}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:currencyTicks}}}}});
  }

  // --- Overview ---------------------------------------------------------------
  function renderOverview(){
    const ym=b().workingMonth; ensureMonth(ym);
    document.getElementById('ov-month').textContent=ym;
    const cb=catsById();
    
    const incomes = b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
    
    const fixedAll = b().monthly[ym].fixed;
    const fixedPlanned = fixedAll.reduce((s,x)=>s+num(x.amount),0);
    const fixedPaid = fixedAll.filter(f => f.paid).reduce((s,x)=>s+num(x.amount),0);
    const fixedUnpaid = fixedPlanned - fixedPaid;

    const entries = entriesForMonth(ym);
    const varSpent = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return (c?.type === 'expense' && c.id !== 'c_fixed') ? s + Math.abs(e.amount) : s;
    }, 0);
    const savingsTransfers = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return c?.type === 'saving' ? s + Math.abs(e.amount) : s;
    }, 0);

    const remainingVariableBudget = incomes - fixedPlanned - varSpent - savingsTransfers;

    const days = daysInYm(ym);
    const daysElapsed = (ym === monthKey()) ? new Date().getDate() : (monthKey() > ym ? days : 0);
    const dailySpending = getDailySpending(ym);
    const spentSoFar = Object.values(dailySpending).reduce((a,b)=>a+b,0);
    const avgDaily = (daysElapsed > 0 ? (spentSoFar / daysElapsed) : 0);
    const daysLeft = getDaysRemaining(ym);
    const projectedTotalVariableOutflow = spentSoFar + (daysLeft * avgDaily);
    const forecastedSavings = (incomes - fixedPlanned) - projectedTotalVariableOutflow;
    const savingsRate = incomes > 0 ? (forecastedSavings / incomes) * 100 : 0;
    
    document.getElementById('ov-inc').textContent = fmt(incomes, state.currency);
    document.getElementById('ov-fixed-planned').textContent = fmt(fixedPlanned, state.currency);
    document.getElementById('ov-fixed-paid').textContent = fmt(fixedPaid, state.currency);
    document.getElementById('ov-fixed-unpaid').textContent = fmt(fixedUnpaid, state.currency);
    document.getElementById('ov-var-spent').textContent = fmt(varSpent, state.currency);
    document.getElementById('ov-savings').textContent = fmt(savingsTransfers, state.currency);
    document.getElementById('ov-remaining').textContent = fmt(remainingVariableBudget, state.currency);
    document.getElementById('stat-savings-rate').textContent = savingsRate.toFixed(0)+'%';
  }

  // --- Forms ------------------------------------------------------------------
  document.getElementById('inc-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target); const ym=b().workingMonth; ensureMonth(ym);
    b().monthly[ym].incomes.push({id:`inc_${Math.random().toString(36).slice(2)}`,amount:num(f.get('amount')),note:String(f.get('note')||'')});
    save(state); e.target.reset(); renderAll();
  };

  const fixForm=document.getElementById('fix-form');
  fixForm.onsubmit=(e)=>{e.preventDefault(); const f=new FormData(fixForm); const ym=b().workingMonth; ensureMonth(ym);
    b().monthly[ym].fixed.push({id:`fix_${Math.random().toString(36).slice(2)}`,title:String(f.get('title')),amount:num(f.get('amount')),due:f.get('due')||null,paid:false,categoryId:'c_fixed'});
    save(state); fixForm.reset(); renderAll()
  };
  document.getElementById('autoTx').onchange=(e)=>{b().createTxOnFixedPay=e.target.checked; save(state)};

  const varForm=document.getElementById('var-form');
  varForm.onsubmit=(e)=>{e.preventDefault(); const f=new FormData(varForm);
    const date=String(f.get('date')||new Date().toISOString().slice(0,10));
    const amount=num(f.get('amount')); const categoryId=String(f.get('categoryId')); const accountId=String(f.get('accountId')); const note=String(f.get('note')||'');
    const signed= signFor(categoryId, amount);
    b().transactions.unshift({id:`tx_${Math.random().toString(36).slice(2)}`,date,amount:signed,categoryId,accountId,note});
    save(state); varForm.reset(); setDefaultDate(); renderAll()
  };

  document.getElementById('cat-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const c={id:`cat_${Math.random().toString(36).slice(2)}`,name:String(f.get('name')),type:String(f.get('type')),emoji:String(f.get('emoji')||''),budget:num(f.get('budget'))||0};
    b().categories.push(c);
    save(state); e.target.reset(); renderAll();
  };

  document.getElementById('goal-form').onsubmit=(e)=>{e.preventDefault(); const f=new FormData(e.target);
    const startDate = String(f.get('startdate') || new Date().toISOString().slice(0,10));
    b().goals.push({id:`goal_${Math.random().toString(36).slice(2)}`,name:String(f.get('name')),target:num(f.get('target')),deadline:String(f.get('deadline')||'')||undefined, startDate});
    save(state); e.target.reset(); renderGoals()
  };
  
  const allocForm = document.getElementById('alloc-form');
  const allocCancelBtn = document.getElementById('alloc-cancel-btn');

  allocForm.onsubmit = (e) => {
    e.preventDefault();
    const f = new FormData(allocForm);
    const allocId = f.get('allocId');
    const goalId = String(f.get('goalId'));
    const date = String(f.get('date') || new Date().toISOString().slice(0, 10));
    const amount = num(f.get('amount'));

    if (!goalId || !amount) {
        alert('Wybierz cel i podaj kwotę.');
        return;
    }

    if (allocId) {
        // Edit mode
        const index = b().goalAllocations.findIndex(a => a.id === allocId);
        if (index > -1) {
            b().goalAllocations[index] = { ...b().goalAllocations[index], goalId, date, amount, ym: date.slice(0,7) };
        }
    } else {
        // Add mode
        b().goalAllocations.unshift({ id: `alloc_${Math.random().toString(36).slice(2)}`, goalId, ym: date.slice(0, 7), date, amount });
    }
    
    save(state);
    resetAllocForm();
    renderGoals();
  };

  allocCancelBtn.onclick = resetAllocForm;

  function renderGoals(){
    const list=document.getElementById('goal-list');
    const summary=document.getElementById('goal-summary');
    const timelineWrapper=document.getElementById('goal-timeline-wrapper');
    const commitmentWrapper=document.getElementById('goal-commitment-table')?.parentElement?.parentElement;
    if(list) list.innerHTML='';
    if(summary) summary.innerHTML='';

    const goals=b().goals||[];
    const allocations=b().goalAllocations||[];
    const totalAllocatedByGoal=allocations.reduce((m,a)=>{m[a.goalId]=(m[a.goalId]||0)+num(a.amount);return m;},{});

    if(goals.length===0){
      if(list) list.innerHTML='<p class="muted" style="text-align:center;">Brak zdefiniowanych celów. Użyj formularza powyżej, aby dodać swój pierwszy cel!</p>';
      if(timelineWrapper) timelineWrapper.style.display='none';
      if(commitmentWrapper) commitmentWrapper.style.display='none';
      if(summary) summary.style.display='none';
      return;
    }

    if(timelineWrapper) timelineWrapper.style.display='block';
    if(commitmentWrapper) commitmentWrapper.style.display='block';
    if(summary) summary.style.display='block';

    let totalTarget=0;
    let totalCollected=0;

    for(const g of goals){
      const collected=totalAllocatedByGoal[g.id]||0;
      totalTarget+=num(g.target);
      totalCollected+=collected;
      const pct=g.target>0?Math.min(100,(collected/g.target)*100):0;

      let monthlyNeeded='';
      if(g.deadline && g.startDate){
        const startDate=new Date(g.startDate);
        const deadlineDate=new Date(g.deadline);
        if(deadlineDate>startDate){
          const monthsLeft=Math.max(1,(deadlineDate.getFullYear()-startDate.getFullYear())*12+(deadlineDate.getMonth()-startDate.getMonth())+1);
          const needed=Math.max(0,g.target-collected);
          const monthly=needed/monthsLeft;
          monthlyNeeded=`<div class="muted" style="font-size:12px">Sugerowana wpłata miesięczna: ${fmt(monthly,state.currency)}</div>`;
        }
      }

      const card=document.createElement('div');
      card.className='card';
      card.id=`goal-card-${g.id}`;
      card.innerHTML=`
        <div data-view="display">
          <div class="row">
            <div><b>${g.name}</b> <span class="muted">${g.startDate ? `${g.startDate} → ` : ''}${g.deadline || ''}</span></div>
            <div>${fmt(collected,state.currency)} / ${fmt(g.target,state.currency)}</div>
          </div>
          <div class="progress ${pct>=100?'good':pct>=75?'warn':''}" style="margin-top:6px"><i style="width:${pct}%"></i></div>
          <div class="muted" style="font-size:12px;margin-top:4px">Postęp: ${pct.toFixed(0)}%</div>
          ${monthlyNeeded}
          <div class="row" style="margin-top:8px; justify-content: flex-end; gap:8px;">
            <button class="btn soft" data-act="edit">Edytuj</button>
            <button class="btn danger" data-act="del">Usuń</button>
          </div>
        </div>`;

      card.querySelector('[data-act="edit"]').onclick=()=>startEditGoal(g.id);
      card.querySelector('[data-act="del"]').onclick=()=>{
        if(!confirm('Usunąć cel (razem z alokacjami)?')) return;
        state.modules.budget.goals=(b().goals||[]).filter(x=>x.id!==g.id);
        state.modules.budget.goalAllocations=(b().goalAllocations||[]).filter(a=>a.goalId!==g.id);
        save(state);
        renderGoals();
      };
      list?.appendChild(card);
    }

    const totalProgressPct=totalTarget>0?(totalCollected/totalTarget)*100:0;
    if(summary){
      summary.innerHTML=`
        <div class="row">
          <div class="stat-card" style="flex:1;"><div class="muted">Łącznie do zebrania</div><div class="big-number">${fmt(totalTarget,state.currency)}</div></div>
          <div class="stat-card" style="flex:1;"><div class="muted">Zebrano do tej pory</div><div class="big-number">${fmt(totalCollected,state.currency)}</div></div>
        </div>
        <div style="margin-top:8px;">
          <div class="muted">Całkowity postęp</div>
          <div class="progress ${totalProgressPct>=100?'good':totalProgressPct>=75?'warn':''}" style="margin-top:4px;height:12px;"><i style="width:${totalProgressPct}%"></i></div>
          <div class="muted" style="font-size:12px;margin-top:4px">${totalProgressPct.toFixed(1)}%</div>
        </div>
      `;
    }

    renderGoalsTimeline();
    renderAllocSelect();
    renderAllocationsHistory();
    setDefaultDateForAlloc();
  }

  function startEditGoal(id){
    const goal=(b().goals||[]).find(g=>g.id===id);
    if(!goal) return;
    const card=document.getElementById(`goal-card-${id}`);
    if(!card) return;
    card.innerHTML=`
      <div data-view="edit" class="grid g-4">
        <input name="name" value="${goal.name}" placeholder="Nazwa celu" style="grid-column: 1 / 3;"/>
        <input name="target" value="${String(goal.target).replace('.',',')}" placeholder="Kwota" inputmode="decimal" style="grid-column: 3 / 5;"/>
        <label class="tiny" style="grid-column: 1 / 3;">Początek oszczędzania<input name="startdate" type="date" value="${goal.startDate||''}" /></label>
        <label class="tiny" style="grid-column: 3 / 5;">Termin końcowy<input name="deadline" type="date" value="${goal.deadline||''}" /></label>
        <div class="row" style="grid-column: 1 / -1; justify-content: flex-end; gap:8px;">
          <button class="btn ghost" data-act="cancel">Anuluj</button>
          <button class="btn" data-act="save">Zapisz</button>
        </div>
      </div>`;
    bindMoneyInputs(card);
    card.querySelector('[data-act="save"]').onclick=()=>{
      goal.name=card.querySelector('[name="name"]').value;
      goal.target=num(card.querySelector('[name="target"]').value);
      goal.startDate=card.querySelector('[name="startdate"]').value||new Date().toISOString().slice(0,10);
      goal.deadline=card.querySelector('[name="deadline"]').value||undefined;
      save(state);
      renderGoals();
    };
    card.querySelector('[data-act="cancel"]').onclick=()=>renderGoals();
  }

  function renderGoalsTimeline(){
    const timeline=document.getElementById('goal-timeline');
    const axis=document.getElementById('timeline-axis');
    const labelsDiv=document.getElementById('timeline-labels');
    if(timeline) timeline.innerHTML='';
    if(axis) axis.innerHTML='';
    if(labelsDiv) labelsDiv.innerHTML='';

    const goalsWithDeadline=(b().goals||[]).filter(g=>g.deadline && g.startDate).sort((a,b)=>new Date(a.deadline)-new Date(b.deadline));
    if(goalsWithDeadline.length===0) return;

    const earliestStartDate=new Date(Math.min(...goalsWithDeadline.map(g=>new Date(g.startDate))));
    const furthestDeadline=new Date(Math.max(...goalsWithDeadline.map(g=>new Date(g.deadline))));
    const totalDurationDays=(furthestDeadline-earliestStartDate)/(1000*60*60*24);
    if(totalDurationDays<=0) return;

    const totalAllocatedByGoal=(b().goalAllocations||[]).reduce((m,a)=>{m[a.goalId]=(m[a.goalId]||0)+num(a.amount);return m;},{});

    let topOffset=0;
    for(const g of goalsWithDeadline){
      const startDate=new Date(g.startDate);
      const deadline=new Date(g.deadline);
      const duration=(deadline-startDate)/(1000*60*60*24);
      const left=((startDate-earliestStartDate)/(1000*60*60*24)/totalDurationDays)*100;
      const width=(duration/totalDurationDays)*100;
      const collected=totalAllocatedByGoal[g.id]||0;
      const pct=g.target>0?Math.min(100,(collected/g.target)*100):0;
      const bar=document.createElement('div');
      bar.className='timeline-bar';
      bar.style.top=`${topOffset}px`;
      bar.style.left=`${left}%`;
      bar.style.width=`${width}%`;
      bar.style.background=`linear-gradient(90deg, #3b82f6 ${pct}%, #93c5fd ${pct}%)`;
      bar.title=`${g.name}: ${pct.toFixed(0)}% zrealizowano (${fmt(collected)} / ${fmt(g.target)})`;
      bar.innerHTML=`<span class="bar-label">${g.name}</span> <span class="bar-progress">${pct.toFixed(0)}%</span>`;
      timeline?.appendChild(bar);
      topOffset+=30;
    }
    if(timeline) timeline.style.height=`${topOffset}px`;

    const monthlyCommitments={};
    goalsWithDeadline.forEach(g=>{
      const collected=totalAllocatedByGoal[g.id]||0;
      const needed=Math.max(0,num(g.target)-collected);
      const startDate=new Date(g.startDate);
      const deadlineDate=new Date(g.deadline);
      if(deadlineDate>startDate){
        const monthsLeft=Math.max(1,(deadlineDate.getFullYear()-startDate.getFullYear())*12+(deadlineDate.getMonth()-startDate.getMonth())+1);
        const monthlyAmount=needed/monthsLeft;
        for(let i=0;i<monthsLeft;i++){
          const targetMonth=ymAdd(monthKey(startDate),i);
          if(!monthlyCommitments[targetMonth]) monthlyCommitments[targetMonth]={};
          monthlyCommitments[targetMonth][g.id]=monthlyAmount;
        }
      }
    });

    const axisMonths=[];
    const iter=new Date(earliestStartDate.getFullYear(),earliestStartDate.getMonth(),1);
    while(iter<=furthestDeadline){
      axisMonths.push(new Date(iter));
      iter.setMonth(iter.getMonth()+1);
    }

    if(axis){
      axis.innerHTML=axisMonths.map(month=>{
        const monthStart=new Date(month.getFullYear(),month.getMonth(),1);
        const left=((monthStart-earliestStartDate)/(1000*60*60*24)/totalDurationDays)*100;
        if(left<0||left>100) return '';
        return `<div style="position:absolute; left: ${left}%; transform: translateX(-50%);">${month.toLocaleString('pl-PL',{month:'short',year:'numeric'})}</div>`;
      }).join('');
    }

    if(labelsDiv){
      labelsDiv.innerHTML=axisMonths.map(month=>{
        const ym=monthKey(month);
        const monthMid=new Date(month.getFullYear(),month.getMonth(),15);
        const left=((monthMid-earliestStartDate)/(1000*60*60*24)/totalDurationDays)*100;
        const totalForMonth=Object.values(monthlyCommitments[ym]||{}).reduce((s,a)=>s+a,0);
        if(left<0||left>100||totalForMonth===0) return '';
        return `<div class="timeline-label" style="left: ${left}%;">${fmt(totalForMonth,state.currency)}</div>`;
      }).join('');
    }

    renderGoalCommitmentTable(monthlyCommitments,goalsWithDeadline);
  }

  function renderGoalCommitmentTable(monthlyCommitments,goals){
    const table=document.getElementById('goal-commitment-table');
    if(!table) return;
    if(goals.length===0){ table.innerHTML=''; return; }
    let header='<thead><tr><th>Miesiąc</th>';
    goals.forEach(g=>{header+=`<th>${g.name}</th>`;});
    header+='<th>Suma miesięczna</th></tr></thead>';
    const months=Object.keys(monthlyCommitments).sort();
    let body='<tbody>';
    months.forEach(ym=>{
      let monthlyTotal=0;
      body+=`<tr><td><b>${ym}</b></td>`;
      goals.forEach(g=>{
        const amount=monthlyCommitments[ym]?.[g.id]||0;
        if(amount>0){
          body+=`<td>${fmt(amount,state.currency)}</td>`;
          monthlyTotal+=amount;
        }else{
          body+='<td class="muted">—</td>';
        }
      });
      body+=`<td><b>${fmt(monthlyTotal,state.currency)}</b></td></tr>`;
    });
    body+='</tbody>';
    table.innerHTML=header+body;
  }

  function renderAllocationsHistory(){
    const tbody=document.getElementById('alloc-history-tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    const allocations=(b().goalAllocations||[]).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,15);
    const goalsById=Object.fromEntries((b().goals||[]).map(g=>[g.id,g]));
    if(allocations.length===0){
      tbody.innerHTML='<tr><td colspan="4" class="muted" style="text-align:center;">Brak historii alokacji.</td></tr>';
      return;
    }
    for(const alloc of allocations){
      const goal=goalsById[alloc.goalId];
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${alloc.date}</td>
        <td>${goal ? goal.name : '<em>Usunięty cel</em>'}</td>
        <td>${fmt(alloc.amount,state.currency)}</td>
        <td class="row" style="justify-content:flex-end; gap:8px;">
          <button class="btn soft" data-edit-id="${alloc.id}">Edytuj</button>
          <button class="btn danger" data-del-id="${alloc.id}">Usuń</button>
        </td>`;
      tr.querySelector('[data-edit-id]').onclick=()=>startEditAllocation(alloc.id);
      tr.querySelector('[data-del-id]').onclick=()=>{
        if(!confirm('Czy na pewno usunąć tę alokację?')) return;
        state.modules.budget.goalAllocations=(b().goalAllocations||[]).filter(a=>a.id!==alloc.id);
        save(state);
        renderGoals();
      };
      tbody.appendChild(tr);
    }
  }

  function startEditAllocation(allocId){
    const alloc=(b().goalAllocations||[]).find(a=>a.id===allocId);
    if(!alloc) return;
    const form=document.getElementById('alloc-form');
    if(!form) return;
    const idField=form.querySelector('[name="allocId"]');
    if(idField) idField.value=alloc.id;
    const goalSel=form.querySelector('[name="goalId"]');
    if(goalSel) goalSel.value=alloc.goalId;
    const dateField=form.querySelector('[name="date"]');
    if(dateField) dateField.value=alloc.date;
    const amountField=form.querySelector('[name="amount"]');
    if(amountField) amountField.value=String(alloc.amount).replace('.',',');
    const title=document.getElementById('alloc-form-title');
    if(title) title.textContent='Edytuj alokację';
    const submit=document.getElementById('alloc-submit-btn');
    if(submit) submit.textContent='Zapisz zmiany';
    const cancel=document.getElementById('alloc-cancel-btn');
    if(cancel) cancel.style.display='inline-flex';
  }

  function resetAllocForm(){
    const form=document.getElementById('alloc-form');
    form.reset();
    const idField=form.querySelector('[name="allocId"]');
    if(idField) idField.value='';
    const title=document.getElementById('alloc-form-title');
    if(title) title.textContent='Dodaj alokację na cel';
    const submit=document.getElementById('alloc-submit-btn');
    if(submit) submit.textContent='Dodaj alokację';
    const cancel=document.getElementById('alloc-cancel-btn');
    if(cancel) cancel.style.display='none';
    setDefaultDateForAlloc();
  }


  document.getElementById('acct-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target); const name=String(f.get('name')||'').trim(); if(!name) return;
    const id='a_'+Math.random().toString(36).slice(2);
    b().accounts.push({id,name}); save(state); e.target.reset(); renderAll();
  };

  // --- Variable list + split editor + filter ---------------------------------
  function renderVariable(){
    const ym=b().workingMonth; document.getElementById('var-month').textContent=ym;
    renderRecurringSuggestions();

    const tbody=document.getElementById('var-rows');tbody.innerHTML='';
    const cb=catsById();
    const accById=Object.fromEntries((b().accounts||[]).map(a=>[a.id,a]));
    let txMonth=(b().transactions||[]).filter(t=>String(t.date).startsWith(ym));

    const filterSel=document.getElementById('var-filter-cat');
    const currentValue=filterSel.value;
    if(currentValue){
      txMonth = txMonth.filter(t=>{
        if(t.splits?.length) return t.splits.some(s=>s.categoryId===currentValue);
        return t.categoryId===currentValue;
      });
    }

    const entries=entriesForMonth(ym);
    const varSum=entries.reduce((s,e)=>{const c=cb[e.categoryId]; return (!c||c.type!=='expense' || c.id ==='c_fixed')?s:s+Math.abs(e.amount)},0);
    document.getElementById('var-sum').textContent = fmt(varSum, state.currency);

    for(const t of txMonth){
      const catMain = t.splits?.length ? null : cb[t.categoryId];
      const isExpense = t.splits?.length ? t.splits.some(s=>cb[s.categoryId]?.type==='expense') : (catMain?.type==='expense');
      const total = txTotalSigned(t);
      const catLabel = t.splits?.length ? `Split (${t.splits.length})` : ((catMain?.emoji||'')+' '+(catMain?.name||'—'));
      const tr=document.createElement('tr'); tr.setAttribute('data-id', t.id);
      tr.innerHTML=`<td>${t.date}</td><td>${catLabel}</td><td>${accById[t.accountId]?.name||'—'}</td><td class="${total<0 ? 'bad' : 'ok'}">${fmt(total,state.currency)}</td><td>${t.note||''}</td>
        <td class="row" style="gap:6px; justify-content:flex-end"><button class="btn soft" data-act="edit">Edytuj</button><button class="btn soft" data-act="copy">Kopiuj</button><button class="btn danger" data-act="del">X</button></td>`;
      tr.querySelector('[data-act="del"]').onclick=()=>{ if(!confirm('Usunąć tę transakcję?')) return; b().transactions=b().transactions.filter(x=>x.id!==t.id); save(state); renderAll() };
      tr.querySelector('[data-act="copy"]').onclick=()=>{ const today=new Date().toISOString().slice(0,10); const n=JSON.parse(JSON.stringify(t)); n.id=`tx_${Math.random().toString(36).slice(2)}`; n.date=today; b().transactions.unshift(n); save(state); alert('Skopiowano na dziś.'); renderAll(); };
      tr.querySelector('[data-act="edit"]').onclick=()=>startEditTx(t);
      tbody.appendChild(tr);
    }

    filterSel.innerHTML='<option value="">Wszystkie kategorie</option>';
    for(const c of (b().categories||[])){filterSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}
    filterSel.value=currentValue; filterSel.onchange=renderVariable;

    const varCat=document.querySelector('#var-form select[name="categoryId"]'); if(varCat){varCat.innerHTML=''; for(const c of (b().categories||[])){varCat.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}}
    const accSel=document.querySelector('#var-form select[name="accountId"]'); if(accSel){accSel.innerHTML=''; for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id))}}
    setDefaultDate(); bindMoneyInputs(tbody);
  }

  function startEditTx(t){
    const row = document.querySelector(`#var-rows tr[data-id="${t.id}"]`); if(!row) return;
    const accs=b().accounts; const isSplit = !!(t.splits && t.splits.length);
    row.innerHTML=`
      <td><input type="date" value="${t.date}" data-k="date"/></td>
      <td colspan="1">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><label style="display:flex;align-items:center;gap:6px"><input type="checkbox" data-k="isSplit" ${isSplit?'checked':''}/> Split</label></div>
        <div data-mode="single" ${isSplit?'style="display:none"':''}><select data-k="categoryId"></select></div>
        <div data-mode="split" class="split-box" ${isSplit?'':'style="display:none"'}><table style="width:100%"><thead><tr><th>Kategoria</th><th>Kwota</th><th></th></tr></thead><tbody class="tx-split-rows"></tbody></table><div style="margin-top:6px"><button class="btn soft" type="button" data-act="split-add">+ wiersz</button></div></div>
      </td>
      <td><select data-k="accountId"></select></td>
      <td><div data-mode="single" ${isSplit?'style="display:none"':''}><input inputmode="decimal" value="${String(Math.abs(t.amount||0)).replace('.',',')}" data-k="amount"/></div><div data-mode="split" ${isSplit?'':'style="display:none"'} class="tiny">Kwoty w split wpisuj jako dodatnie.</div></td>
      <td><input value="${t.note||''}" data-k="note"/></td>
      <td class="row" style="gap:6px"><button class="btn" data-act="save">Zapisz</button><button class="btn ghost" data-act="cancel">Anuluj</button></td>`;
    const cb=catsById();
    const catSel=row.querySelector('select[data-k="categoryId"]'); for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id,false,c.id===t.categoryId))}
    const accSel=row.querySelector('select[data-k="accountId"]'); for(const a of (accs||[])){accSel.add(new Option(a.name,a.id,false,a.id===t.accountId))}
    const tbody=row.querySelector('.tx-split-rows');
    function addSplitRow(sp){const tr=document.createElement('tr'); tr.className='split-row'; tr.innerHTML=`<td><select class="sp-cat"></select></td><td><input class="sp-amt" inputmode="decimal" value="${sp?String(sp.amount).replace('.',','):''}" /></td><td><button class="btn danger" type="button">X</button></td>`; const sel=tr.querySelector('.sp-cat'); for(const c of (b().categories||[])){sel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id,false, sp?sp.categoryId===c.id:false))} tr.querySelector('button').onclick=()=>{tr.remove()}; tbody.appendChild(tr); bindMoneyInputs(tr);}
    if(t.splits?.length){for(const s of t.splits) addSplitRow(s)} else { addSplitRow(); }
    row.querySelector('[data-k="isSplit"]').onchange=()=>{const on = row.querySelector('[data-k="isSplit"]').checked; row.querySelectorAll('[data-mode="single"]').forEach(el=>el.style.display= on?'none':'block'); row.querySelectorAll('[data-mode="split"]').forEach(el=>el.style.display= on?'block':'none');};
    row.querySelector('[data-act="split-add"]').onclick=()=>addSplitRow();
    bindMoneyInputs(row);
    row.querySelector('[data-act="save"]').onclick=()=>{
      const date=row.querySelector('[data-k="date"]').value || t.date;
      const accountId=row.querySelector('[data-k="accountId"]').value;
      const note=row.querySelector('[data-k="note"]').value;
      const useSplit=row.querySelector('[data-k="isSplit"]').checked;
      const idx=b().transactions.findIndex(x=>x.id===t.id); if(idx === -1) return;
      
      if(useSplit){
        const rows=Array.from(row.querySelectorAll('.split-row')); if(rows.length===0){alert('Dodaj przynajmniej jeden wiersz split.'); return;}
        const splits=[]; for(const r of rows){const cat=r.querySelector('.sp-cat').value; const amt=num(r.querySelector('.sp-amt').value); if(!cat || amt <= 0){alert('Uzupełnij kategorię i kwotę > 0 w każdym wierszu split.'); return;} splits.push({categoryId:cat, amount:amt});}
        const total=splits.reduce((s,sp)=>s+signFor(sp.categoryId,num(sp.amount)),0);
        const firstCat=splits[0].categoryId;
        b().transactions[idx]={...b().transactions[idx],date,accountId,note,categoryId:firstCat,amount:total,splits};
      }else{
        const categoryId=row.querySelector('[data-k="categoryId"]').value;
        const amountRaw=num(row.querySelector('[data-k="amount"]').value);
        const signed= signFor(categoryId, amountRaw);
        b().transactions[idx]={...b().transactions[idx],date,categoryId,accountId,amount:signed,note,splits:[]};
      }
      save(state); renderAll();
    };
    row.querySelector('[data-act="cancel"]').onclick=()=>renderVariable();
  }

  // --- Categories -------------------------------------------------------------
  function renderCategories(){
    const tbody=document.getElementById('cat-rows');tbody.innerHTML='';
    const emptyInfo=document.getElementById('cat-empty');
    const ym=b().workingMonth; const cats=b().categories||[];
    emptyInfo.style.display = cats.length===0 ? 'block' : 'none';

    const entries=entriesForMonth(ym);
    const spending={};
    for(const e of entries){
      const catId=e.categoryId; const c=cats.find(c=>c.id===catId);
      if(c && c.type==='expense'){spending[catId]=(spending[catId]||0)+Math.abs(e.amount)}
    }
    for(const c of cats){
      const spent=spending[c.id]||0; const budget=num(c.budget); let status='—';
      if(c.type==='expense' && budget>0){
        const pct=(spent/budget)*100;
        if(pct>100) status=`<span class="bad">${pct.toFixed(0)}% (przekroczenie)</span>`;
        else if(pct>80) status=`<span class="warn">${pct.toFixed(0)}%</span>`;
        else status=`<span class="ok">${pct.toFixed(0)}%</span>`;
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.emoji||''}</td><td>${c.name}</td><td>${c.type}</td><td>${budget>0?fmt(budget,state.currency):'—'}</td><td>${fmt(spent,state.currency)}</td><td>${status}</td><td><button class="btn danger">Usuń</button></td>`;
      tr.querySelector('.btn').onclick=()=>{
        if(c.id==='c_fixed'){alert('Nie można usunąć kategorii „Wydatki stałe”.'); return;}
        if(!confirm('Usunąć kategorię?')) return;
        b().categories=b().categories.filter(x=>x.id!==c.id && x.id!=='c_fixed'); save(state); renderAll()
      };
      tbody.appendChild(tr);
    }
  }

  // --- EOM --------------------------------------------------------------------
  function destroyEomChart(key){
    if(eomCharts[key]){
      eomCharts[key].destroy();
      delete eomCharts[key];
    }
  }

  function sumBalances(map){
    return Object.values(map || {}).reduce((sum, val) => sum + (Number(val) || 0), 0);
  }

  const MONTH_NAMES_PL=['styczeń','luty','marzec','kwiecień','maj','czerwiec','lipiec','sierpień','wrzesień','październik','listopad','grudzień'];

  function formatMonthLabel(ym){
    if(!ym || typeof ym!=='string') return ym || '—';
    const parts=ym.split('-');
    if(parts.length!==2) return ym;
    const [year,month]=parts;
    const idx=Number(month)-1;
    const name=MONTH_NAMES_PL[idx] || month;
    return `${name} ${year}`;
  }

  function buildEomContext(){
    const accounts = b().accounts || [];
    const entries = (b().eom || []).map(entry => ({
      ym: String(entry.ym),
      accountId: entry.accountId,
      balance: num(entry.balance)
    })).filter(entry => entry.ym && entry.accountId);

    const monthBalances = {};
    const accountHistory = {};

    for(const entry of entries){
      if(!monthBalances[entry.ym]) monthBalances[entry.ym] = {};
      monthBalances[entry.ym][entry.accountId] = entry.balance;
      if(!accountHistory[entry.accountId]) accountHistory[entry.accountId] = [];
      accountHistory[entry.accountId].push({ ym: entry.ym, balance: entry.balance });
    }

    Object.values(accountHistory).forEach(hist => hist.sort((a,b) => a.ym.localeCompare(b.ym)));

    const months = Object.keys(monthBalances).sort();
    const workingYm = b().workingMonth;
    const workingBalances = monthBalances[workingYm] || {};
    const hasWorking = Object.keys(workingBalances).length > 0;
    const latestMonth = months.length ? months[months.length - 1] : null;
    const focusMonth = hasWorking ? workingYm : latestMonth;
    const focusPrevMonth = focusMonth ? months.filter(m => m < focusMonth).pop() || null : null;
    const focusBalances = focusMonth ? (monthBalances[focusMonth] || {}) : {};
    const focusPrevBalances = focusPrevMonth ? (monthBalances[focusPrevMonth] || {}) : {};
    const netWorthByMonth = months.map(ym => ({ ym, total: sumBalances(monthBalances[ym]) }));

    return {
      accounts,
      accountHistory,
      monthBalances,
      months,
      workingYm,
      workingBalances,
      hasWorking,
      latestMonth,
      focusMonth,
      focusPrevMonth,
      focusBalances,
      focusPrevBalances,
      netWorthByMonth
    };
  }

  const EOM_SCENARIOS = {
    actual:{ label:'Realny', description:'Bez dodatkowych założeń.' },
    optimistic:{ label:'Optymistyczny', description:'Aktywa +5%, zobowiązania -5%.' },
    stress:{ label:'Stresowy', description:'Aktywa -8%, zobowiązania +12%.' }
  };

  function capitalizeFirst(text){
    if(!text) return '';
    return text.charAt(0).toUpperCase() + text.slice(1);
  }

  function inferAccountType(acc){
    if(acc?.kind) return acc.kind;
    if(acc?.type) return acc.type;
    const name = (acc?.name || '').toLowerCase();
    if(/oszcz|saver|lokata|konto oszcz/.test(name)) return 'oszczędności';
    if(/inwest|broker|etf|akcje/.test(name)) return 'inwestycje';
    if(/karta|credit|zadłuż|dług|loan|kredyt/.test(name)) return 'zadłużenie';
    if(/gotówk|cash|portfel/.test(name)) return 'gotówka';
    if(/emeryt|ike|ikze/.test(name)) return 'emerytura';
    return 'inne';
  }

  function eomAccountStatus(balance){
    if(balance === null || balance === undefined) return 'neutralne';
    return balance >= 0 ? 'aktywa' : 'zobowiązania';
  }

  function scenarioMultiplier(scenario, balance){
    switch(scenario){
      case 'optimistic':
        return balance >= 0 ? 1.05 : 0.95;
      case 'stress':
        return balance >= 0 ? 0.92 : 1.12;
      default:
        return 1;
    }
  }

  function applyScenarioToValue(value, scenario){
    if(value === null || value === undefined) return value === null ? null : undefined;
    const mult = scenarioMultiplier(scenario, value);
    const adjusted = Number((value * mult).toFixed(2));
    return adjusted;
  }

  function normalizeYmRange(range){
    if(!range) return { from:null, to:null };
    const from = range.from && /^\d{4}-\d{2}$/.test(range.from) ? range.from : null;
    const to = range.to && /^\d{4}-\d{2}$/.test(range.to) ? range.to : null;
    if(from && to && from > to){
      return { from: to, to: from };
    }
    return { from, to };
  }

  function getMonthsWithinRange(months, range){
    const { from, to } = normalizeYmRange(range || {});
    return months.filter(ym => {
      if(from && ym < from) return false;
      if(to && ym > to) return false;
      return true;
    });
  }

  function buildSparklinePoints(history, months){
    if(!history || !history.length) return [];
    const set = new Set(months);
    const filtered = history.filter(item => set.size === 0 || set.has(item.ym));
    return filtered.map(item => ({ ym:item.ym, value:item.balance }));
  }

  function renderSparkline(canvas, points, options={}){
    if(!canvas || !points.length){
      if(canvas){
        const ctx2d = canvas.getContext('2d');
        if(ctx2d){
          const width = canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);
          const height = canvas.height = canvas.clientHeight * (window.devicePixelRatio || 1);
          ctx2d.clearRect(0,0,width,height);
        }
      }
      return;
    }
    const ctx2d = canvas.getContext('2d');
    const width = canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);
    const height = canvas.height = canvas.clientHeight * (window.devicePixelRatio || 1);
    ctx2d.clearRect(0,0,width,height);
    const values = points.map(p => p.value);
    const min = Math.min(...values);
    const max = Math.max(...values);
    const range = max - min || 1;
    const step = width / Math.max(points.length - 1, 1);
    const color = options.color || '#2563eb';
    const fill = options.fill !== undefined ? options.fill : 'rgba(37, 99, 235, 0.18)';
    const lineWidth = (options.lineWidth ?? 2) * (window.devicePixelRatio || 1);
    ctx2d.lineWidth = lineWidth;
    ctx2d.strokeStyle = color;
    ctx2d.beginPath();
    points.forEach((pt, idx) => {
      const x = idx * step;
      const y = height - ((pt.value - min) / range) * height;
      if(idx === 0) ctx2d.moveTo(x, y);
      else ctx2d.lineTo(x, y);
    });
    ctx2d.stroke();
    if(fill){
      ctx2d.fillStyle = fill;
      ctx2d.lineTo(width, height);
      ctx2d.lineTo(0, height);
      ctx2d.closePath();
      ctx2d.fill();
    }
  }

  function monthsForSparkline(ctx, range){
    const months = getMonthsWithinRange(ctx.months, range);
    return months.length ? months : ctx.months.slice(-6);
  }

  function renderEomInteractiveGrid(ctx, rows, options={}){
    const container = document.getElementById('eom-grid');
    if(!container) return { inputs:[], refreshSparklines:()=>{} };
    container.innerHTML = '';
    container.className = 'eom-grid-shell';

    const totalAccounts = (ctx.accounts || []).length;
    const countEl = document.getElementById('eom-account-count');
    if(countEl){
      const visible = rows.length;
      countEl.textContent = totalAccounts
        ? `Pokazujesz ${visible} z ${totalAccounts} kont`
        : `Pokazujesz ${visible} kont`;
    }

    if(!rows.length){
      container.innerHTML = '<div class="eom-grid-empty">Brak kont spełniających kryteria. Dodaj nowe konto lub zmień filtry.</div>';
      return { inputs:[], refreshSparklines:()=>{} };
    }

    const sortKey = eomUiState.accountSort || 'balance';
    const sortedRows = [...rows];
    sortedRows.sort((a,b) => {
      switch(sortKey){
        case 'name':
          return a.acc.name.localeCompare(b.acc.name, 'pl', { sensitivity:'base' });
        case 'change-up':
          return ((b.deltaPct ?? -Infinity) - (a.deltaPct ?? -Infinity));
        case 'change-down':
          return ((a.deltaPct ?? Infinity) - (b.deltaPct ?? Infinity));
        case 'balance':
        default:
          return ((b.adjustedCurrent ?? b.currentValue ?? 0) - (a.adjustedCurrent ?? a.currentValue ?? 0));
      }
    });

    const expandedSet = new Set(Array.isArray(eomUiState.expandedAccounts) ? eomUiState.expandedAccounts : []);
    const focusId = options.focusedAccountId || null;

    const prioritySet = (() => {
      const ranked = [...sortedRows]
        .filter(row => Number.isFinite(row.deltaAdjusted) && Math.abs(row.deltaAdjusted || 0) >= 0.005)
        .sort((a,b) => Math.abs((b.deltaAdjusted ?? 0)) - Math.abs((a.deltaAdjusted ?? 0)));
      return new Set(ranked.slice(0, Math.min(3, ranked.length)).map(row => row.acc.id));
    })();

    const accordion = document.createElement('div');
    accordion.className = 'eom-account-accordion';
    container.appendChild(accordion);

    const inputs = [];
    const sparkTargets = [];

    sortedRows.forEach(row => {
      const isExpanded = expandedSet.has(row.acc.id);
      const card = document.createElement('article');
      card.className = 'eom-account-item';
      if(prioritySet.has(row.acc.id)) card.classList.add('is-priority');
      if(Number.isFinite(row.adjustedCurrent) && row.adjustedCurrent < 0) card.classList.add('is-debt');
      if(row.isDormant) card.classList.add('is-dormant');
      if(focusId && focusId === row.acc.id) card.classList.add('is-focused');
      if(isExpanded) card.classList.add('is-expanded');
      card.dataset.accountId = row.acc.id;
      card.title = `${row.acc.name}: ${row.displayBalance}${row.deltaDisplay && row.deltaDisplay !== '—' ? ` | Δ ${row.deltaDisplay}` : ''}`;

      const trendTone = row.trendDirection === 'up' ? 'up' : row.trendDirection === 'down' ? 'down' : 'flat';
      const deltaTone = row.trendDirection === 'up' ? 'positive' : row.trendDirection === 'down' ? 'negative' : 'neutral';
      const deltaText = row.deltaPctDisplay && row.deltaPctDisplay !== '—'
        ? `${row.deltaDisplay} <span class="tiny muted">(${row.deltaPctDisplay})</span>`
        : row.deltaDisplay;

      const headerBtn = document.createElement('button');
      headerBtn.type = 'button';
      headerBtn.className = 'eom-account-header';
      headerBtn.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
      headerBtn.innerHTML = `
        <div class="eom-account-title">
          <strong>${row.acc.name}</strong>
          <span>${row.subtitle}</span>
        </div>
        <div class="eom-account-balance" data-balance="${row.acc.id}">${row.displayBalance}</div>
        <div class="eom-account-trend ${trendTone}" data-delta="${row.acc.id}" data-role="header">
          <span class="arrow ${trendTone}">${row.trendArrow}</span>
          <span>${deltaText}</span>
        </div>
        <span class="eom-account-toggle-icon">${isExpanded ? '▲' : '▼'}</span>
      `;
      card.appendChild(headerBtn);

      const body = document.createElement('div');
      body.className = 'eom-account-body';
      const recordDisplay = row.recordEntry ? fmt(row.recordEntry.value, state.currency) : '—';
      const recordDate = row.recordEntry?.ym || '—';
      const minDisplay = row.minEntry ? fmt(row.minEntry.value, state.currency) : '—';
      const minDate = row.minEntry?.ym || '—';
      const avgDisplay = row.averageSix !== null && row.averageSix !== undefined ? fmt(row.averageSix, state.currency) : '—';
      const rangeHint = row.sparklinePoints.length
        ? `Zakres danych: ${row.sparklinePoints[0].ym} → ${row.sparklinePoints[row.sparklinePoints.length - 1].ym}`
        : 'Brak danych historycznych w wybranym zakresie.';
      body.innerHTML = `
        <div class="eom-account-body-inner">
          <div>
            <div class="eom-account-spark-large">
              <canvas data-big-spark="${row.acc.id}"></canvas>
            </div>
            <div class="tiny muted">${rangeHint}</div>
            <div class="eom-account-stats">
              <div><span>Rekord</span><strong>${recordDisplay}</strong><span>${recordDate}</span></div>
              <div><span>Najniższa</span><strong>${minDisplay}</strong><span>${minDate}</span></div>
              <div><span>Średnia (6M)</span><strong>${avgDisplay}</strong><span>${row.sparklinePoints.length >= 6 ? 'Ostatnie 6 miesięcy' : 'Wszystkie dostępne'}</span></div>
            </div>
          </div>
          <div>
            <div class="eom-account-change">
              <div class="delta ${deltaTone}" data-delta="${row.acc.id}" data-role="detail">${row.deltaDisplay}${row.deltaPctDisplay && row.deltaPctDisplay !== '—' ? ` (${row.deltaPctDisplay})` : ''}</div>
              <div class="tiny muted">Poprzedni miesiąc: ${row.previousDisplay}</div>
              <p class="tiny">${row.trendDescription}</p>
            </div>
            <div class="eom-account-actions">
              <label class="tiny" for="eom-input-${row.acc.id}">Aktualizuj saldo</label>
              <input id="eom-input-${row.acc.id}" inputmode="decimal" data-id="${row.acc.id}" value="${row.currentInput}" placeholder="0,00" />
              <button class="btn ghost" type="button" data-drill="${row.acc.id}">Historia</button>
              <button class="btn danger" type="button" data-del="${row.acc.id}">Usuń</button>
            </div>
          </div>
        </div>
      `;
      card.appendChild(body);
      accordion.appendChild(card);

      const input = body.querySelector('input[data-id]');
      if(input) inputs.push(input);
      const sparkCanvas = body.querySelector('canvas[data-big-spark]');
      if(sparkCanvas){
        sparkTargets.push({ canvas: sparkCanvas, row });
      }

      if(isExpanded){
        requestAnimationFrame(() => {
          body.style.maxHeight = `${body.scrollHeight}px`;
        });
      } else {
        body.style.maxHeight = '0px';
      }
    });

    if(!accordion.dataset.bound){
      accordion.dataset.bound = '1';
      accordion.addEventListener('click', event => {
        const header = event.target.closest('.eom-account-header');
        if(!header || !accordion.contains(header)) return;
        const card = header.closest('.eom-account-item');
        if(!card) return;
        const body = card.querySelector('.eom-account-body');
        const accountId = card.dataset.accountId;
        const isExpanded = card.classList.toggle('is-expanded');
        header.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
        const icon = header.querySelector('.eom-account-toggle-icon');
        if(icon) icon.textContent = isExpanded ? '▲' : '▼';
        const nextSet = new Set(Array.isArray(eomUiState.expandedAccounts) ? eomUiState.expandedAccounts : []);
        if(isExpanded) nextSet.add(accountId); else nextSet.delete(accountId);
        eomUiState.expandedAccounts = Array.from(nextSet);
        if(body){
          if(isExpanded){
            body.style.maxHeight = `${body.scrollHeight}px`;
          } else {
            body.style.maxHeight = '0px';
          }
        }
      });
    }

    return {
      inputs,
      refreshSparklines(){
        sparkTargets.forEach(target => {
          const color = target.row?.sparkColor || '#2563eb';
          const points = target.row?.sparklinePoints || [];
          renderSparkline(target.canvas, points, { color, fill: withAlpha(color, 0.16) });
        });
      }
    };
  }

  function renderEomPivotTable(ctx, rows, months, scenario='actual'){
    const container = document.getElementById('eom-grid');
    if(!container) return { inputs:[], refreshSparklines:()=>{} };
    container.innerHTML = '';
    const countEl = document.getElementById('eom-account-count');
    if(countEl){
      const totalAccounts = (ctx.accounts || []).length;
      const visible = rows.length;
      countEl.textContent = totalAccounts
        ? `Pokazujesz ${visible} z ${totalAccounts} kont`
        : `Pokazujesz ${visible} kont`;
    }
    if(!rows.length){
      container.innerHTML = '<div class="eom-grid-empty">Brak danych do zbudowania tabeli przestawnej.</div>';
      return { inputs:[], refreshSparklines:()=>{} };
    }
    const table = document.createElement('table');
    table.className = 'eom-pivot-table';
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');
    table.appendChild(thead);
    table.appendChild(tbody);
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = '<th>Konto</th>' + months.map(m => `<th>${m}</th>`).join('') + '<th>Mediana</th><th>Rekord</th>';
    thead.appendChild(headerRow);
    const medians = [];
    rows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.acc.name}</td>` + months.map(m => {
        const entry = row.history.find(item => item.ym === m);
        const adjusted = entry ? applyScenarioToValue(entry.balance, scenario) : null;
        return `<td>${adjusted === null ? '<span class="muted">—</span>' : fmt(adjusted, state.currency)}</td>`;
      }).join('');
      const values = row.history
        .filter(item => months.includes(item.ym))
        .map(item => applyScenarioToValue(item.balance, scenario))
        .filter(val => typeof val === 'number');
      values.sort((a,b)=>a-b);
      const median = values.length ? values[Math.floor(values.length/2)] : null;
      const record = values.length ? (row.deltaAdjusted >= 0 ? Math.max(...values) : Math.min(...values)) : null;
      tr.innerHTML += `<td>${median === null ? '<span class="muted">—</span>' : fmt(median, state.currency)}</td>`;
      tr.innerHTML += `<td>${record === null ? '<span class="muted">—</span>' : fmt(record, state.currency)}</td>`;
      tbody.appendChild(tr);
      medians.push({ account: row.acc, median, record });
    });
    container.appendChild(table);
    return { inputs:[], refreshSparklines:()=>{} };
  }

  function renderEomHeatmap(ctx, rows, months, scenario='actual'){
    const container = document.getElementById('eom-heatmap');
    if(!container) return;
    container.innerHTML = '';
    if(!rows.length || !months.length){
      container.innerHTML = '<div class="muted tiny">Heatmapa pojawi się, gdy zapiszesz co najmniej dwa miesiące danych.</div>';
      return;
    }
    const grid = document.createElement('div');
    grid.className = 'eom-heatmap-grid';
    const flat = [];
    rows.forEach(row => {
      months.forEach(m => {
        const entry = row.history.find(item => item.ym === m);
        if(entry){
          const adjusted = applyScenarioToValue(entry.balance, scenario) ?? 0;
          flat.push(Math.abs(adjusted));
        }
      });
    });
    const max = flat.length ? Math.max(...flat) : 0;
    rows.forEach(row => {
      const cell = document.createElement('div');
      cell.className = 'eom-heatmap-cell';
      cell.innerHTML = `<strong>${row.acc.name}</strong>`;
      months.forEach(m => {
        const entry = row.history.find(item => item.ym === m);
        const val = entry ? applyScenarioToValue(entry.balance, scenario) : null;
        const pct = max ? Math.abs(val || 0)/max : 0;
        const color = val === null ? 'transparent' : `rgba(59, 130, 246, ${0.15 + pct*0.6})`;
        const badge = document.createElement('div');
        badge.style.background = color;
        badge.style.borderRadius = '8px';
        badge.style.padding = '4px 6px';
        badge.style.fontVariantNumeric = 'tabular-nums';
        badge.innerHTML = val === null ? '<span class="muted">—</span>' : fmt(val, state.currency);
        badge.title = `${row.acc.name} — ${m}`;
        cell.appendChild(badge);
      });
      grid.appendChild(cell);
    });
    const scale = document.createElement('div');
    scale.className = 'eom-heatmap-scale';
    scale.innerHTML = '<span></span><span></span><span></span><span></span><span></span> Intensywność zmian';
    container.appendChild(grid);
    container.appendChild(scale);
  }

  function entryForMonth(history, ym){
    if(!history) return null;
    return history.find(item => item.ym === ym) || null;
  }

  function lastEntryBefore(history, ym){
    if(!history) return null;
    let prev = null;
    for(const item of history){
      if(item.ym < ym){
        prev = item;
      } else if(item.ym >= ym){
        break;
      }
    }
    return prev;
  }

  function computeAccountStatsForMonth(ctx, targetMonth, options={}){
    if(!targetMonth) return [];
    const { accounts, accountHistory } = ctx;
    const scenario = options.scenario || 'actual';
    const allowedTypes = Array.isArray(options.accountTypes) && options.accountTypes.length ? options.accountTypes : null;
    return accounts.map(acc => {
      const type = inferAccountType(acc);
      if(allowedTypes && !allowedTypes.includes(type)) return null;
      const history = accountHistory[acc.id] || [];
      const historyUpTo = history.filter(item => item.ym <= targetMonth);
      if(historyUpTo.length === 0) return null;
      const currentEntry = entryForMonth(history, targetMonth);
      const prevEntry = lastEntryBefore(history, targetMonth);
      const baseCurrent = currentEntry ? currentEntry.balance : null;
      const basePrevious = prevEntry ? prevEntry.balance : null;
      const current = baseCurrent === null ? null : applyScenarioToValue(baseCurrent, scenario);
      const previous = basePrevious === null ? null : applyScenarioToValue(basePrevious, scenario);
      const hasAny = current !== null || previous !== null;
      const delta = hasAny ? ((current ?? 0) - (previous ?? 0)) : null;
      const deltaPct = previous && previous !== 0 ? (delta / Math.abs(previous)) * 100 : null;
      const lastThree = historyUpTo.slice(-3).map(item => applyScenarioToValue(item.balance, scenario));
      const avg3 = lastThree.length ? lastThree.reduce((sum, val) => sum + val, 0) / lastThree.length : null;
      const trendVsAvg = current !== null && avg3 !== null ? current - avg3 : null;
      const maxEntry = historyUpTo.reduce((max, item) => !max || item.balance > max.balance ? item : max, null);
      const minEntry = historyUpTo.reduce((min, item) => !min || item.balance < min.balance ? item : min, null);
      return {
        account: acc,
        type,
        status: eomAccountStatus(current ?? previous ?? 0),
        current,
        currentYm: currentEntry?.ym || targetMonth,
        previous,
        previousYm: prevEntry?.ym || null,
        delta,
        deltaPct,
        avg3,
        trendVsAvg,
        maxEntry,
        minEntry,
        baseCurrent,
        basePrevious,
        scenario,
        history
      };
    }).filter(Boolean);
  }

  function computeMonthlySummary(ctx, options={}){
    const { months, monthBalances, accounts, accountHistory } = ctx;
    const scenario = options.scenario || 'actual';
    const typeFilter = new Set(Array.isArray(options.accountTypes) ? options.accountTypes : []);
    const relevantAccounts = accounts.filter(acc => typeFilter.size === 0 || typeFilter.has(inferAccountType(acc)));
    return months.map(ym => {
      const balances = monthBalances[ym] || {};
      const prevMonth = months.filter(m => m < ym).pop() || null;
      const prevBalances = prevMonth ? (monthBalances[prevMonth] || {}) : {};
      let positive = 0;
      let negative = 0;
      let prevPositive = 0;
      let prevNegative = 0;
      for(const acc of relevantAccounts){
        const currentVal = balances[acc.id];
        const prevVal = prevBalances[acc.id];
        if(currentVal !== undefined){
          const adjusted = applyScenarioToValue(currentVal, scenario) ?? 0;
          if(adjusted >= 0) positive += adjusted; else negative += adjusted;
        }
        if(prevVal !== undefined){
          const adjustedPrev = applyScenarioToValue(prevVal, scenario) ?? 0;
          if(adjustedPrev >= 0) prevPositive += adjustedPrev; else prevNegative += adjustedPrev;
        }
      }
      const netWorth = positive + negative;
      const prevNetWorth = prevMonth !== null ? (prevPositive + prevNegative) : null;
      const delta = prevNetWorth !== null ? netWorth - prevNetWorth : null;
      const base = positive + Math.abs(negative);
      const debtShare = base ? (Math.abs(negative) / base) * 100 : 0;
      let best = null;
      let worst = null;
      for(const acc of relevantAccounts){
        const history = accountHistory[acc.id] || [];
        if(history.length === 0) continue;
        const currentRaw = entryForMonth(history, ym)?.balance ?? null;
        const prevEntry = lastEntryBefore(history, ym);
        if(currentRaw === null && !prevEntry) continue;
        const current = currentRaw === null ? null : applyScenarioToValue(currentRaw, scenario);
        const prevVal = prevEntry?.balance ?? null;
        const previous = prevVal === null ? null : applyScenarioToValue(prevVal, scenario);
        const deltaAcc = (current ?? 0) - (previous ?? 0);
        if(!best || deltaAcc > best.delta) best = { account: acc, delta: deltaAcc };
        if(!worst || deltaAcc < worst.delta) worst = { account: acc, delta: deltaAcc };
      }
      return { ym, netWorth, delta, positive, negative, debtShare, best, worst };
    });
  }

  function renderDeltaBadge(delta){
    if(delta === null || delta === undefined) return '<span class="delta-neutral">—</span>';
    if(Math.abs(delta) < 0.005) return '<span class="delta-neutral">—</span>';
    const cls = delta > 0 ? 'delta-up' : 'delta-down';
    const sign = delta > 0 ? '+' : '';
    return `<span class="${cls}">${sign}${fmt(delta, state.currency)}</span>`;
  }

  function renderEomKpis(ctx, accountStats){
    const container = document.getElementById('eom-kpis');
    if(!container) return;
    container.innerHTML = '';
    if(!ctx.months.length){
      container.innerHTML = `<div class="muted" style="grid-column:1 / -1;text-align:center;padding:18px;">Dodaj pierwsze salda, aby zobaczyć wskaźniki.</div>`;
      renderEomInsights(ctx, []);
      return;
    }

    const scenario = eomUiState.scenario || 'actual';
    const typeFilter = new Set(eomUiState.accountTypes || []);
    const relevantAccounts = ctx.accounts.filter(acc => typeFilter.size === 0 || typeFilter.has(inferAccountType(acc)));
    if(!relevantAccounts.length){
      container.innerHTML = `<div class="muted" style="grid-column:1 / -1;text-align:center;padding:18px;">Brak kont spełniających filtry — zmień wybór typów kont.</div>`;
      renderEomInsights(ctx, []);
      return;
    }

    const netWorthForMonth = (ym) => {
      if(!ym) return 0;
      const balances = ctx.monthBalances[ym] || {};
      return relevantAccounts.reduce((sum, acc) => {
        const value = balances[acc.id];
        if(value === undefined) return sum;
        const adjusted = applyScenarioToValue(value, scenario);
        return sum + (typeof adjusted === 'number' ? adjusted : 0);
      }, 0);
    };

    const focusMonth = ctx.focusMonth;
    const focusPrevMonth = ctx.focusPrevMonth;
    const netWorth = netWorthForMonth(focusMonth);
    const prevNetWorth = focusPrevMonth ? netWorthForMonth(focusPrevMonth) : null;
    const delta = prevNetWorth !== null ? netWorth - prevNetWorth : null;
    const hasDelta = delta !== null && Math.abs(delta) >= 0.005;
    const deltaPct = hasDelta && prevNetWorth !== 0 ? (delta / (prevNetWorth || 1)) * 100 : null;
    const deltaClass = !hasDelta ? 'neutral' : (delta > 0 ? 'positive' : 'negative');

    const focusLabel = focusMonth
      ? (focusMonth === ctx.workingYm ? `Dane z ${focusMonth}` : `Ostatni zapis: ${focusMonth}`)
      : 'Brak zapisów';

    const balanceBreakdown = relevantAccounts.reduce((acc, account) => {
      const value = ctx.focusBalances[account.id];
      if(value === undefined) return acc;
      const adjusted = applyScenarioToValue(value, scenario);
      if(typeof adjusted !== 'number') return acc;
      if(adjusted >= 0) acc.assets += adjusted; else acc.debt += adjusted;
      return acc;
    }, { assets:0, debt:0 });
    const prevBreakdown = focusPrevMonth ? relevantAccounts.reduce((acc, account) => {
      const value = ctx.focusPrevBalances[account.id];
      if(value === undefined) return acc;
      const adjusted = applyScenarioToValue(value, scenario);
      if(typeof adjusted !== 'number') return acc;
      if(adjusted >= 0) acc.assets += adjusted; else acc.debt += adjusted;
      return acc;
    }, { assets:0, debt:0 }) : null;
    const debtTotal = Math.abs(balanceBreakdown.debt);
    const base = balanceBreakdown.assets + debtTotal;
    const debtShare = base ? (debtTotal / base) * 100 : 0;
    const prevDebtTotal = prevBreakdown ? Math.abs(prevBreakdown.debt) : null;
    const debtDelta = prevDebtTotal !== null ? debtTotal - prevDebtTotal : null;
    const debtDeltaClass = debtDelta === null ? 'neutral' : (debtDelta > 0 ? 'negative' : (debtDelta < 0 ? 'positive' : 'neutral'));

    const record = ctx.months.reduce((best, ym) => {
      const total = netWorthForMonth(ym);
      if(!Number.isFinite(total)) return best;
      if(!best || total > best.total) return { ym, total };
      return best;
    }, null);
    const recordGap = record ? netWorth - record.total : null;
    const recordTrendClass = recordGap === null ? 'neutral' : (recordGap >= 0 ? 'positive' : 'negative');

    const bestAccount = accountStats.filter(row => Number.isFinite(row.delta)).sort((a,b) => (b.delta || 0) - (a.delta || 0))[0];
    const worstAccount = accountStats.filter(row => Number.isFinite(row.delta)).sort((a,b) => (a.delta || 0) - (b.delta || 0))[0];
    const growthInsight = bestAccount && Math.abs(bestAccount.delta || 0) >= 0.005
      ? { text: `Najszybszy wzrost: ${bestAccount.account.name} ${bestAccount.delta > 0 ? '+' : ''}${fmt(bestAccount.delta, state.currency)}`, className: 'positive', icon: '🚀' }
      : null;
    const dragInsight = worstAccount && Math.abs(worstAccount.delta || 0) >= 0.005
      ? { text: `Największy spadek: ${worstAccount.account.name} ${worstAccount.delta > 0 ? '+' : ''}${fmt(worstAccount.delta, state.currency)}`, className: worstAccount.delta < 0 ? 'negative' : 'neutral', icon: '📉' }
      : null;
    const debtShareInsight = debtTotal
      ? { text: `Zadłużenie to ${debtShare.toFixed(1)}% portfela`, className: debtShare > 35 ? 'negative' : 'neutral', icon: debtShare > 35 ? '⚠️' : 'ℹ️' }
      : null;
    const insights = [];
    if(growthInsight) insights.push(growthInsight);
    if(debtShareInsight) insights.push(debtShareInsight);
    if(insights.length < 2 && dragInsight) insights.push(dragInsight);
    if(insights.length === 0 && record){
      insights.push({ text: `Rekord: ${record.ym} ${fmt(record.total, state.currency)}`, className: 'positive', icon: '🏆' });
    }

    const cards = [
      {
        id: 'net-worth',
        target: 'eom-networth-chart',
        primary: true,
        icon: '💼',
        label: 'Majątek netto',
        value: fmt(netWorth, state.currency),
        trend: hasDelta ? { className: deltaClass, text: `${delta > 0 ? '▲' : '▼'} ${fmt(Math.abs(delta), state.currency)}${deltaPct !== null ? ` (${delta > 0 ? '+' : ''}${deltaPct.toFixed(1)}%)` : ''}` } : { className: 'neutral', text: 'Stabilnie m/m' },
        meta: [ `${focusLabel}` ]
      },
      {
        id: 'mom-change',
        target: 'eom-mom',
        primary: false,
        icon: '📈',
        label: 'Zmiana m/m',
        value: hasDelta ? `${delta > 0 ? '+' : ''}${fmt(delta, state.currency)}` : '—',
        trend: hasDelta ? { className: deltaClass, text: `${deltaPct !== null ? `${deltaPct > 0 ? '+' : ''}${deltaPct.toFixed(1)}%` : 'vs poprzedni miesiąc'}` } : { className: 'neutral', text: 'Brak danych historycznych' },
        meta: [ prevNetWorth !== null ? `Poprzedni miesiąc: ${fmt(prevNetWorth, state.currency)}` : 'Czekamy na pierwszy zapis', focusPrevMonth ? `Porównanie z ${focusPrevMonth}` : '' ].filter(Boolean)
      },
      {
        id: 'net-record',
        target: 'eom-accounts-history',
        primary: false,
        icon: '🏆',
        label: 'Rekord historyczny',
        value: record ? fmt(record.total, state.currency) : '—',
        trend: record ? (Math.abs(recordGap || 0) < 0.005
          ? { className: 'positive', text: 'Nowy rekord w tym miesiącu' }
          : { className: recordTrendClass, text: `${recordGap > 0 ? 'Rekord pobity' : 'Do rekordu brakuje'} ${fmt(Math.abs(recordGap), state.currency)}` }
        ) : { className: 'neutral', text: 'Brak historii' },
        meta: [ record ? `Ustanowiony: ${record.ym}` : 'Dodaj więcej miesięcy', record && focusMonth && record.ym !== focusMonth ? `Obecnie: ${fmt(netWorth, state.currency)}` : '' ].filter(Boolean)
      },
      {
        id: 'net-debt',
        target: 'eom-grid',
        primary: false,
        icon: '💳',
        label: 'Zadłużenie',
        value: debtTotal ? `-${fmt(debtTotal, state.currency)}` : '—',
        trend: debtDelta !== null
          ? { className: debtDeltaClass, text: `${debtDelta > 0 ? '▲' : debtDelta < 0 ? '▼' : '●'} ${debtDelta > 0 ? '+' : ''}${fmt(debtDelta, state.currency)}` }
          : { className: 'neutral', text: 'Brak danych historycznych' },
        meta: [ `Stanowi ${debtShare.toFixed(1)}% portfela`, balanceBreakdown.assets ? `Aktywa: ${fmt(balanceBreakdown.assets, state.currency)}` : '' ].filter(Boolean)
      }
    ];

    renderEomInsights(ctx, insights);

    container.innerHTML = cards.map((card, idx) => {
      const trendHtml = card.trend ? `<div class="eom-kpi-trend ${card.trend.className}">${card.trend.text}</div>` : '';
      const metaHtml = card.meta && card.meta.length ? `<div class="eom-kpi-meta">${card.meta.map(line => `<span>${line}</span>`).join('')}</div>` : '';
      return `
        <article class="eom-kpi-card${card.primary ? ' primary' : ''}" data-target="${card.target}" style="--eom-delay:${idx * 80}ms">
          <div class="eom-kpi-icon">${card.icon}</div>
          <span class="eom-kpi-label">${card.label}</span>
          <span class="eom-kpi-value">${card.value}</span>
          ${trendHtml}
          ${metaHtml}
        </article>
      `;
    }).join('');

    requestAnimationFrame(() => {
      container.querySelectorAll('.eom-kpi-card').forEach(card => {
        card.classList.add('is-visible');
        const target = card.getAttribute('data-target');
        if(target && !card.dataset.bound){
          card.dataset.bound = '1';
          card.addEventListener('click', () => {
            const el = document.getElementById(target);
            if(el){
              const panel = el.closest('.eom-dashboard-panel');
              if(panel && panel.dataset.panel){
                updateEomDashboardView(panel.dataset.panel);
              }
              requestAnimationFrame(() => {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
            }
          });
        }
      });
    });
  }

  function renderEomInsights(ctx, insightItems){
    const container = document.getElementById('eom-insights');
    if(!container) return;
    const items = Array.isArray(insightItems)
      ? insightItems.filter(item => item && typeof item.text === 'string' && item.text.trim().length)
      : [];
    if(!ctx.months.length || !items.length){
      container.innerHTML = '';
      return;
    }
    container.innerHTML = items.slice(0, 2).map(item => {
      const cls = item.className === 'negative' ? 'eom-insight-pill negative' : 'eom-insight-pill';
      const icon = item.icon ? `${item.icon} ` : '';
      return `<span class="${cls}">${icon}${item.text}</span>`;
    }).join('');
  }

  function renderEomHistoryTable(ctx, monthsToShow, options={}){
    const table = document.getElementById('eom-accounts-history');
    const footer = document.getElementById('eom-history-footer');
    const scrollShell = document.querySelector('.eom-history-table-scroll');
    const exportBtn = document.getElementById('eom-history-export');
    eomHistoryExportCache = null;
    if(!table) return;
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if(thead) thead.innerHTML = '';
    if(tbody) tbody.innerHTML = '';
    if(footer) footer.innerHTML = '';
    if(scrollShell) scrollShell.scrollTop = 0;
    if(exportBtn) exportBtn.disabled = true;

    const scenario = options.scenario || 'actual';
    const typeFilter = new Set(Array.isArray(options.accountTypes) ? options.accountTypes : []);
    let accounts = ctx.accounts
      .filter(acc => typeFilter.size === 0 || typeFilter.has(inferAccountType(acc)))
      .sort((a, b) => a.name.localeCompare(b.name, 'pl', { sensitivity: 'base' }));
    const searchTerm = (options.search || '').trim().toLowerCase();
    if(searchTerm){
      accounts = accounts.filter(acc => acc.name.toLowerCase().includes(searchTerm));
    }

    const emptyRow = '<tr><td class="muted" style="text-align:center;padding:16px;">Brak danych historycznych do wyświetlenia.</td></tr>';
    if(!monthsToShow.length){
      if(tbody) tbody.innerHTML = emptyRow;
      if(footer) footer.innerHTML = '<span class="muted">Brak danych historycznych. Dodaj transakcje, aby rozpocząć analizę.</span>';
      return;
    }

    if(!accounts.length){
      if(tbody) tbody.innerHTML = '<tr><td class="muted" style="text-align:center;padding:16px;">Brak kont spełniających bieżące filtry lub wyszukiwanie.</td></tr>';
      if(footer) footer.innerHTML = '<span class="muted">Dostosuj filtry, aby zobaczyć dane historyczne.</span>';
      return;
    }

    const chronologicalMonths = [...monthsToShow].sort((a, b) => a.localeCompare(b));
    const initialAccountIds = accounts.map(acc => acc.id);
    let monthRecords = buildHistoryMonthRecords(ctx, chronologicalMonths, initialAccountIds, scenario);
    let accountSummaries = computeHistoryAccountSummaries(monthRecords, initialAccountIds);

    if(options.onlyChanges){
      accounts = accounts.filter(acc => accountSummaries[acc.id]?.hasChange);
    }

    if(!accounts.length){
      if(tbody) tbody.innerHTML = '<tr><td class="muted" style="text-align:center;padding:16px;">Żadne konto nie wykazuje zmian w wybranym zakresie.</td></tr>';
      if(footer) footer.innerHTML = '<span class="muted">Zmień filtr lub zakres, by zobaczyć ruchy na kontach.</span>';
      return;
    }

    const accountIds = accounts.map(acc => acc.id);
    monthRecords = buildHistoryMonthRecords(ctx, chronologicalMonths, accountIds, scenario);
    accountSummaries = computeHistoryAccountSummaries(monthRecords, accountIds);
    const netWorthAverage = computeNetWorthAverage(monthRecords);
    const totalMonths = Number.isFinite(options.totalMonths) ? options.totalMonths : ctx.months.length;
    const sortState = normalizeHistorySort(options.sort, options.transpose);

    if(!table.dataset.historySortBound){
      table.dataset.historySortBound = '1';
      table.addEventListener('click', event => {
        const button = event.target.closest('button[data-sort-key]');
        if(!button) return;
        const key = button.dataset.sortKey;
        if(!key) return;
        const transposeMode = !!eomUiState.historyTranspose;
        const prev = eomUiState.historySort || { key: transposeMode ? 'name' : 'ym', dir: transposeMode ? 'asc' : 'desc' };
        let dir = 'desc';
        if(prev.key === key){
          dir = prev.dir === 'asc' ? 'desc' : 'asc';
        } else if(key === 'name' || key === 'avg'){ dir = 'asc'; }
        else if(key === 'ym'){ dir = 'desc'; }
        else { dir = 'desc'; }
        eomUiState.historySort = { key, dir };
        saveEomUiState();
        renderEOMHistory();
      });
    }

    if(options.transpose){
      renderHistoryTableTransposed({
        thead,
        tbody,
        accounts,
        accountSummaries,
        monthRecords,
        sortState,
        netWorthAverage,
        chronologicalMonths
      });
    } else {
      renderHistoryTableStandard({
        thead,
        tbody,
        accounts,
        accountSummaries,
        monthRecords,
        sortState,
        netWorthAverage
      });
    }

    updateHistoryFooter(footer, monthRecords, netWorthAverage, totalMonths, accounts.length);
    if(exportBtn && eomHistoryExportCache && Array.isArray(eomHistoryExportCache.rows) && eomHistoryExportCache.rows.length){
      exportBtn.disabled = false;
    }
  }

  function normalizeHistorySort(sort, transpose){
    const fallback = transpose ? { key:'name', dir:'asc' } : { key:'ym', dir:'desc' };
    if(!sort || !sort.key) return { ...fallback };
    const dir = sort.dir === 'asc' ? 'asc' : 'desc';
    if(transpose){
      if(sort.key === 'name' || sort.key === 'avg' || sort.key === 'lastChange' || (typeof sort.key === 'string' && sort.key.startsWith('month:'))){
        return { key: sort.key, dir };
      }
      return { ...fallback };
    }
    if(sort.key === 'ym' || sort.key === 'netWorth' || sort.key === 'delta' || (typeof sort.key === 'string' && sort.key.startsWith('acc:'))){
      return { key: sort.key, dir };
    }
    return { ...fallback };
  }

  function buildHistoryMonthRecords(ctx, months, accountIds, scenario){
    return months.map((ym, idx) => {
      const balances = ctx.monthBalances[ym] || {};
      const prevYm = idx > 0 ? months[idx - 1] : null;
      const prevBalances = prevYm ? (ctx.monthBalances[prevYm] || {}) : null;
      const perAccount = {};
      let netWorth = 0;
      let prevNetWorth = prevYm ? 0 : null;
      for(const id of accountIds){
        const currentRaw = balances[id];
        const current = currentRaw === undefined ? null : applyScenarioToValue(currentRaw, scenario);
        const prevRaw = prevBalances ? prevBalances[id] : undefined;
        const previous = prevRaw === undefined || prevRaw === null ? null : applyScenarioToValue(prevRaw, scenario);
        let change = current !== null && previous !== null ? current - previous : null;
        if(change !== null && Math.abs(change) < 0.005) change = 0;
        const pct = change !== null && previous !== null && previous !== 0 ? (change / Math.abs(previous)) * 100 : null;
        perAccount[id] = { value: current, prev: previous, change, pct };
        if(typeof current === 'number') netWorth += current;
        if(prevYm && typeof previous === 'number') prevNetWorth += previous;
      }
      const delta = prevYm ? netWorth - (prevNetWorth ?? 0) : null;
      return { ym, perAccount, netWorth, prevNetWorth: prevYm ? prevNetWorth : null, delta };
    });
  }

  function computeHistoryAccountSummaries(records, accountIds){
    const summaries = {};
    for(const id of accountIds){
      let sum = 0;
      let count = 0;
      let hasChange = false;
      for(const record of records){
        const info = record.perAccount[id];
        if(!info) continue;
        if(typeof info.value === 'number'){ sum += info.value; count += 1; }
        if(info.change !== null && info.change !== undefined && Math.abs(info.change) >= 0.005){
          hasChange = true;
        }
      }
      summaries[id] = { avg: count ? sum / count : null, hasChange };
    }
    return summaries;
  }

  function computeNetWorthAverage(records){
    const values = records
      .map(record => typeof record.netWorth === 'number' ? record.netWorth : null)
      .filter(value => value !== null && !Number.isNaN(value));
    if(!values.length) return null;
    return values.reduce((sum, value) => sum + value, 0) / values.length;
  }

  function renderHistoryTableStandard({ thead, tbody, accounts, accountSummaries, monthRecords, sortState, netWorthAverage }){
    if(!thead || !tbody) return;
    const headerRow = document.createElement('tr');
    headerRow.appendChild(createHistoryHeaderCell('ym', 'Miesiąc', sortState));
    accounts.forEach(acc => {
      headerRow.appendChild(createHistoryHeaderCell(`acc:${acc.id}`, acc.name, sortState));
    });
    headerRow.appendChild(createHistoryHeaderCell('netWorth', 'Majątek netto', sortState));
    headerRow.appendChild(createHistoryHeaderCell('delta', 'Zmiana m/m', sortState));
    thead.appendChild(headerRow);

    const records = sortHistoryRecords([...monthRecords], sortState);
    const positiveColor = cssVar('--green', '#22c55e');
    const negativeColor = cssVar('--red', '#ef4444');
    const exportHeaders = ['Miesiąc', ...accounts.map(acc => acc.name), 'Majątek netto', 'Zmiana m/m'];
    const exportRows = [];

    records.forEach(record => {
      const tr = document.createElement('tr');
      const monthTd = document.createElement('td');
      monthTd.innerHTML = `<div class="eom-history-value">${formatMonthLabel(record.ym)}</div><div class="tiny muted">${record.ym}</div>`;
      monthTd.dataset.value = record.ym;
      tr.appendChild(monthTd);

      accounts.forEach(acc => {
        const summary = accountSummaries[acc.id] || {};
        const info = record.perAccount[acc.id] || { value:null, change:null, prev:null, pct:null };
        const td = createHistoryValueCell(info, summary.avg, positiveColor, negativeColor, false);
        tr.appendChild(td);
      });

      const netInfo = {
        value: record.netWorth,
        change: record.delta,
        prev: record.prevNetWorth,
        pct: record.prevNetWorth ? (record.delta / Math.abs(record.prevNetWorth)) * 100 : null
      };
      const netTd = createHistoryValueCell(netInfo, netWorthAverage, positiveColor, negativeColor, true);
      netTd.classList.add('networth');
      tr.appendChild(netTd);

      const deltaTd = document.createElement('td');
      deltaTd.className = 'delta';
      if(record.delta === null || Number.isNaN(record.delta)){
        deltaTd.innerHTML = '<span class="muted">—</span>';
      } else {
        deltaTd.innerHTML = renderDeltaBadge(record.delta);
        const pct = record.prevNetWorth ? (record.delta / Math.abs(record.prevNetWorth)) * 100 : null;
        if(pct !== null && Number.isFinite(pct)){
          deltaTd.title = `Zmiana m/m: ${record.delta >= 0 ? '+' : ''}${fmt(record.delta, state.currency)} (${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%)`;
        }
      }
      deltaTd.dataset.value = record.delta ?? '';
      tr.appendChild(deltaTd);

      tbody.appendChild(tr);

      exportRows.push([
        formatMonthLabel(record.ym),
        ...accounts.map(acc => formatHistoryExportValue(record.perAccount[acc.id]?.value)),
        formatHistoryExportValue(record.netWorth),
        formatHistoryExportDelta(record.delta)
      ]);
    });

    eomHistoryExportCache = {
      headers: exportHeaders,
      rows: exportRows,
      filename: `historia_${new Date().toISOString().slice(0,10)}.csv`
    };
  }

  function renderHistoryTableTransposed({ thead, tbody, accounts, accountSummaries, monthRecords, sortState, netWorthAverage, chronologicalMonths }){
    if(!thead || !tbody) return;
    const headerRow = document.createElement('tr');
    headerRow.appendChild(createHistoryHeaderCell('name', 'Konto', sortState));
    chronologicalMonths.forEach(ym => {
      headerRow.appendChild(createHistoryHeaderCell(`month:${ym}`, formatMonthLabel(ym), sortState));
    });
    headerRow.appendChild(createHistoryHeaderCell('avg', 'Średnia', sortState));
    headerRow.appendChild(createHistoryHeaderCell('lastChange', 'Zmiana m/m', sortState));
    thead.appendChild(headerRow);

    const positiveColor = cssVar('--green', '#22c55e');
    const negativeColor = cssVar('--red', '#ef4444');

    const rows = accounts.map(acc => {
      const values = chronologicalMonths.map((ym, idx) => monthRecords[idx].perAccount[acc.id] || { value:null, change:null, prev:null, pct:null });
      const lastInfo = values[values.length - 1] || { change:null, prev:null, pct:null };
      return {
        key: `acc:${acc.id}`,
        label: acc.name,
        values,
        average: accountSummaries[acc.id]?.avg ?? null,
        lastChange: lastInfo.change,
        lastPrev: lastInfo.prev,
        lastPct: lastInfo.pct,
        isNetWorth: false
      };
    });

    const netValues = chronologicalMonths.map((ym, idx) => {
      const record = monthRecords[idx];
      return {
        value: record.netWorth,
        change: record.delta,
        prev: record.prevNetWorth,
        pct: record.prevNetWorth ? (record.delta / Math.abs(record.prevNetWorth)) * 100 : null
      };
    });
    const netLast = netValues[netValues.length - 1] || { change:null, prev:null, pct:null };
    rows.push({
      key: 'networth',
      label: 'Majątek netto',
      values: netValues,
      average: netWorthAverage,
      lastChange: netLast.change,
      lastPrev: netLast.prev,
      lastPct: netLast.pct,
      isNetWorth: true
    });

    const sortedRows = sortHistoryTransposedRows(rows, sortState, chronologicalMonths);
    const exportHeaders = ['Konto', ...chronologicalMonths.map(formatMonthLabel), 'Średnia', 'Zmiana m/m'];
    const exportRows = [];

    sortedRows.forEach(row => {
      const tr = document.createElement('tr');
      const nameTd = document.createElement('td');
      nameTd.innerHTML = `<div class="eom-history-value">${row.label}</div>`;
      tr.appendChild(nameTd);

      row.values.forEach(valueInfo => {
        const td = createHistoryValueCell(valueInfo, row.isNetWorth ? netWorthAverage : row.average, positiveColor, negativeColor, row.isNetWorth);
        tr.appendChild(td);
      });

      const avgTd = document.createElement('td');
      avgTd.className = 'networth';
      if(row.average === null || Number.isNaN(row.average)){
        avgTd.innerHTML = '<span class="muted">—</span>';
      } else {
        avgTd.innerHTML = `<span class="eom-history-value">${fmt(row.average, state.currency)}</span>`;
      }
      tr.appendChild(avgTd);

      const lastTd = document.createElement('td');
      lastTd.className = 'delta';
      if(row.lastChange === null || row.lastChange === undefined || Number.isNaN(row.lastChange)){
        lastTd.innerHTML = '<span class="muted">—</span>';
      } else {
        lastTd.innerHTML = renderDeltaBadge(row.lastChange);
        if(row.lastPrev !== null && row.lastPrev !== undefined){
          const pct = row.lastPct !== null && row.lastPct !== undefined && Number.isFinite(row.lastPct)
            ? `${row.lastChange >= 0 ? '+' : ''}${row.lastPct.toFixed(1)}%`
            : '—';
          lastTd.title = `Zmiana vs poprzedni miesiąc: ${row.lastChange >= 0 ? '+' : ''}${fmt(row.lastChange, state.currency)} (${pct})`;
        }
      }
      tr.appendChild(lastTd);

      if(row.isNetWorth) tr.classList.add('networth-row');
      tbody.appendChild(tr);

      exportRows.push([
        row.label,
        ...row.values.map(valueInfo => formatHistoryExportValue(valueInfo?.value)),
        formatHistoryExportValue(row.average),
        formatHistoryExportDelta(row.lastChange)
      ]);
    });

    eomHistoryExportCache = {
      headers: exportHeaders,
      rows: exportRows,
      filename: `historia_${new Date().toISOString().slice(0,10)}.csv`
    };
  }

  function createHistoryHeaderCell(key, label, sortState){
    const th = document.createElement('th');
    const button = document.createElement('button');
    button.type = 'button';
    button.textContent = label;
    button.dataset.sortKey = key;
    if(sortState.key === key){
      button.dataset.sortDir = sortState.dir === 'asc' ? '▲' : '▼';
    }
    th.appendChild(button);
    return th;
  }

  function sortHistoryRecords(records, sortState){
    const dir = sortState.dir === 'asc' ? 1 : -1;
    const key = sortState.key;
    return records.sort((a, b) => {
      if(key === 'ym') return a.ym.localeCompare(b.ym) * dir;
      if(key === 'netWorth') return compareNumericValues(a.netWorth, b.netWorth, dir);
      if(key === 'delta') return compareNumericValues(a.delta, b.delta, dir);
      if(typeof key === 'string' && key.startsWith('acc:')){
        const id = key.slice(4);
        return compareNumericValues(a.perAccount[id]?.value, b.perAccount[id]?.value, dir);
      }
      return 0;
    });
  }

  function sortHistoryTransposedRows(rows, sortState, months){
    const dir = sortState.dir === 'asc' ? 1 : -1;
    const key = sortState.key;
    return rows.sort((a, b) => {
      if(a.isNetWorth && !b.isNetWorth) return 1;
      if(!a.isNetWorth && b.isNetWorth) return -1;
      if(key === 'name') return a.label.localeCompare(b.label, 'pl', { sensitivity: 'base' }) * dir;
      if(key === 'avg') return compareNumericValues(a.average, b.average, dir);
      if(key === 'lastChange') return compareNumericValues(a.lastChange, b.lastChange, dir);
      if(typeof key === 'string' && key.startsWith('month:')){
        const ym = key.slice(6);
        const idx = months.indexOf(ym);
        if(idx === -1) return 0;
        return compareNumericValues(a.values[idx]?.value, b.values[idx]?.value, dir);
      }
      return 0;
    });
  }

  function compareNumericValues(a, b, dir){
    const aValid = typeof a === 'number' && !Number.isNaN(a);
    const bValid = typeof b === 'number' && !Number.isNaN(b);
    if(!aValid && !bValid) return 0;
    if(!aValid) return 1 * dir;
    if(!bValid) return -1 * dir;
    if(a === b) return 0;
    return a > b ? dir : -dir;
  }

  function createHistoryValueCell(info, average, positiveColor, negativeColor, isNetWorth){
    const td = document.createElement('td');
    const value = info && typeof info.value === 'number' ? info.value : null;
    if(value === null){
      td.innerHTML = '<span class="muted">—</span>';
      return td;
    }
    const span = document.createElement('span');
    span.className = 'eom-history-value';
    span.textContent = fmt(value, state.currency);
    td.appendChild(span);
    td.dataset.value = value;

    if(info && info.change !== null && info.change !== undefined){
      const change = info.change || 0;
      const arrow = document.createElement('span');
      let tone = 'neutral';
      if(change > 0) tone = 'positive';
      if(change < 0) tone = 'negative';
      arrow.className = `eom-history-arrow ${tone}`;
      arrow.textContent = change > 0 ? '△' : change < 0 ? '▽' : '→';
      td.appendChild(arrow);
      if(info.prev !== null && info.prev !== undefined){
        const pct = info.pct !== null && info.pct !== undefined && Number.isFinite(info.pct)
          ? `${change >= 0 ? '+' : ''}${info.pct.toFixed(1)}%`
          : '—';
        td.title = `Zmiana vs poprzedni miesiąc: ${change >= 0 ? '+' : ''}${fmt(change, state.currency)} (${pct})`;
      }
    }

    applyHistoryHeat(td, value, average, positiveColor, negativeColor);
    if(isNetWorth) td.classList.add('networth');
    return td;
  }

  function applyHistoryHeat(cell, value, average, positiveColor, negativeColor){
    if(value === null || average === null || average === undefined || Number.isNaN(value) || Number.isNaN(average)) return;
    const diff = value - average;
    if(Math.abs(diff) < 0.005) return;
    const tone = diff > 0 ? 'positive' : 'negative';
    const ratio = Math.min(1.5, Math.abs(diff) / Math.max(Math.abs(average), 1));
    const alpha = 0.12 + ratio * 0.25;
    const color = tone === 'positive' ? colorWithAlpha(positiveColor, alpha) : colorWithAlpha(negativeColor, alpha);
    cell.style.background = color;
    cell.classList.add(tone);
  }

  function formatHistoryExportValue(value){
    if(value === null || value === undefined || Number.isNaN(value)) return '';
    return fmt(value, state.currency);
  }

  function formatHistoryExportDelta(delta){
    if(delta === null || delta === undefined || Number.isNaN(delta)) return '';
    return `${delta >= 0 ? '+' : ''}${fmt(delta, state.currency)}`;
  }

  function updateHistoryFooter(container, records, netWorthAverage, totalMonths, accountCount){
    if(!container){
      return;
    }
    if(!records.length){
      container.innerHTML = '<span class="muted">Brak danych do podsumowania.</span>';
      return;
    }
    const first = records[0];
    const last = records[records.length - 1];
    const change = (typeof first.netWorth === 'number' && typeof last.netWorth === 'number') ? last.netWorth - first.netWorth : null;
    const pct = change !== null && first.netWorth ? (change / Math.abs(first.netWorth)) * 100 : null;
    const trendSymbol = change === null ? '→' : change > 0 ? '↗' : change < 0 ? '↘' : '→';
    const avgDisplay = netWorthAverage === null ? '—' : fmt(netWorthAverage, state.currency);
    const changeDisplay = change === null ? '—' : `${change >= 0 ? '+' : ''}${fmt(change, state.currency)}${pct !== null && Number.isFinite(pct) ? ` (${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%)` : ''}`;
    const rangeDisplay = `${formatMonthLabel(first.ym)} → ${formatMonthLabel(last.ym)}`;
    container.innerHTML = `
      <div>
        <div class="muted">Średni majątek netto</div>
        <strong>${avgDisplay}</strong>
      </div>
      <div>
        <div class="muted">Trend ogólny</div>
        <strong>${trendSymbol} ${changeDisplay}</strong>
      </div>
      <div>
        <div class="muted">Zakres danych</div>
        <span>${rangeDisplay}</span>
      </div>
      <div>
        <div class="muted">Widoczność</div>
        <span>Pokazujesz ${records.length} z ${totalMonths} miesięcy · ${accountCount} kont</span>
      </div>
    `;
  }

  function exportEomHistoryCsv(){
    if(!eomHistoryExportCache || !Array.isArray(eomHistoryExportCache.rows) || !eomHistoryExportCache.rows.length){
      return;
    }
    const headers = eomHistoryExportCache.headers || [];
    const rows = eomHistoryExportCache.rows || [];
    const lines = [headers.map(csvEscape).join(';'), ...rows.map(row => row.map(csvEscape).join(';'))];
    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = eomHistoryExportCache.filename || 'eom-history.csv';
    document.body.appendChild(a);
    a.click();
    requestAnimationFrame(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  function csvEscape(value){
    if(value === null || value === undefined) return '';
    const str = String(value).replace(/\r?\n|\r/g, ' ').replace(/"/g, '""');
    if(/[";,]/.test(str)){
      return `"${str}"`;
    }
    return str;
  }

  function renderEomPerformanceMatrix(ctx, accountStats){
    const container = document.getElementById('eom-performance-matrix');
    if(!container) return;
    const topZone = container.querySelector('[data-zone="top"]');
    const watchZone = container.querySelector('[data-zone="watch"]');
    if(!topZone || !watchZone) return;

    topZone.innerHTML = '';
    watchZone.innerHTML = '';

    if(!ctx.months.length){
      topZone.innerHTML = '<div class="eom-performance-empty">Dodaj pierwsze salda, aby zobaczyć ranking kont.</div>';
      watchZone.innerHTML = '<div class="eom-performance-empty">✅ Wszystko pod kontrolą</div>';
      return;
    }

    const scenario = eomUiState.scenario || 'actual';
    const topAccounts = accountStats
      .filter(stat => Number.isFinite(stat.delta) && stat.delta > 0)
      .sort((a,b) => (b.delta || 0) - (a.delta || 0))
      .slice(0, 5);

    if(!topAccounts.length){
      topZone.innerHTML = '<div class="eom-performance-empty">Wszystkie konta stabilne</div>';
    } else {
      topAccounts.forEach(stat => {
        const card = buildEomAccountPerformanceCard(ctx, stat, { tone: 'positive', scenario });
        topZone.appendChild(card);
      });
    }

    const watchCandidates = accountStats
      .filter(stat => Number.isFinite(stat.delta) && stat.delta < 0)
      .map(stat => ({
        stat,
        magnitude: Math.abs(stat.delta ?? 0),
        pct: Math.abs(stat.deltaPct ?? 0),
        alert: detectEomAccountAlert(stat, scenario)
      }))
      .sort((a,b) => {
        if(a.magnitude !== b.magnitude) return b.magnitude - a.magnitude;
        if(a.pct !== b.pct) return b.pct - a.pct;
        return a.stat.account.name.localeCompare(b.stat.account.name, 'pl', { sensitivity:'base' });
      });

    const watchList = watchCandidates.slice(0, 5);
    if(!watchList.length){
      watchZone.innerHTML = '<div class="eom-performance-empty">✅ Wszystko pod kontrolą</div>';
    } else {
      watchList.forEach(item => {
        const card = buildEomAccountPerformanceCard(ctx, item.stat, { tone: 'negative', scenario, alert: item.alert });
        watchZone.appendChild(card);
      });
    }

    requestAnimationFrame(() => {
      container.querySelectorAll('canvas[data-spark]').forEach(canvas => {
        const raw = canvas.dataset.values || '';
        const values = raw ? raw.split(',').map(Number).filter(val => Number.isFinite(val)) : [];
        const color = canvas.dataset.color || 'var(--accent)';
        drawMiniSparkline(canvas, values, { color });
      });
    });
  }

  function renderEomComparison(ctx){
    const section = document.getElementById('eom-mom');
    if(!section) return;
    const selectA = document.getElementById('eom-mom-month-a');
    const selectB = document.getElementById('eom-mom-month-b');
    const swapBtn = document.getElementById('eom-mom-swap');
    const runBtn = document.getElementById('eom-mom-run');
    const emptyEl = document.getElementById('eom-mom-empty');
    const content = document.getElementById('eom-mom-content');
    const summaryValue = document.getElementById('eom-mom-summary-value');
    const summaryText = document.getElementById('eom-mom-summary-text');
    const pillsContainer = document.getElementById('eom-mom-pills');
    const rankingTable = document.getElementById('eom-mom-ranking-table');
    const rankingNote = document.getElementById('eom-mom-ranking-note');
    const autoList = document.getElementById('eom-mom-auto-insights');

    if(content && !content.dataset.bound){
      content.dataset.bound = '1';
      content.addEventListener('click', (event) => {
        const trigger = event.target.closest('[data-account-id]');
        if(trigger){
          const accId = trigger.dataset.accountId;
          if(accId){
            eomUiState.focusedAccountId = accId;
            eomUiState.dashboardView = 'accounts';
            saveEomUiState();
            renderEOM();
            const detail = document.getElementById('eom-grid');
            if(detail){
              requestAnimationFrame(() => {
                detail.scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
            }
          }
        }
      });
    }

    const months = Array.from(new Set([...(ctx.months || []), ctx.workingYm].filter(Boolean))).sort();
    const monthsDesc = [...months].sort((a,b) => b.localeCompare(a));

    const ensureMonth = (key, fallbackIndex) => {
      if(!months.length) return null;
      if(key && months.includes(key)) return key;
      if(typeof fallbackIndex === 'number' && months[fallbackIndex]) return months[fallbackIndex];
      return months[months.length - 1];
    };

    if(!eomUiState.compareMonthA || !months.includes(eomUiState.compareMonthA)){
      const workingIdx = months.indexOf(ctx.workingYm);
      eomUiState.compareMonthA = ensureMonth(ctx.workingYm, workingIdx >= 0 ? workingIdx : months.length - 1);
    }
    if(!eomUiState.compareMonthB || !months.includes(eomUiState.compareMonthB) || eomUiState.compareMonthB === eomUiState.compareMonthA){
      const idxA = months.indexOf(eomUiState.compareMonthA);
      const prev = idxA > 0 ? months[idxA - 1] : months.find(ym => ym !== eomUiState.compareMonthA) || null;
      eomUiState.compareMonthB = prev;
    }

    const populateSelect = (select, value) => {
      if(!select) return;
      select.innerHTML = monthsDesc.map(ym => `<option value="${ym}">${formatMonthLabel(ym)}</option>`).join('');
      select.value = value && months.includes(value) ? value : '';
      if(!select.value && monthsDesc.length){
        select.value = monthsDesc[0];
      }
    };

    populateSelect(selectA, eomUiState.compareMonthA);
    populateSelect(selectB, eomUiState.compareMonthB);

    if(selectA && !selectA.dataset.bound){
      selectA.dataset.bound = '1';
      selectA.addEventListener('change', (e) => {
        eomUiState.compareMonthA = e.target.value || null;
        saveEomUiState();
        renderEOM();
      });
    }
    if(selectB && !selectB.dataset.bound){
      selectB.dataset.bound = '1';
      selectB.addEventListener('change', (e) => {
        eomUiState.compareMonthB = e.target.value || null;
        saveEomUiState();
        renderEOM();
      });
    }
    if(swapBtn && !swapBtn.dataset.bound){
      swapBtn.dataset.bound = '1';
      swapBtn.addEventListener('click', () => {
        const nextA = eomUiState.compareMonthB;
        const nextB = eomUiState.compareMonthA;
        eomUiState.compareMonthA = nextA;
        eomUiState.compareMonthB = nextB;
        saveEomUiState();
        renderEOM();
      });
    }
    if(runBtn && !runBtn.dataset.bound){
      runBtn.dataset.bound = '1';
      runBtn.addEventListener('click', () => {
        renderEOM();
      });
    }

    const monthA = eomUiState.compareMonthA && months.includes(eomUiState.compareMonthA)
      ? eomUiState.compareMonthA
      : null;
    const monthB = eomUiState.compareMonthB && months.includes(eomUiState.compareMonthB)
      ? eomUiState.compareMonthB
      : null;

    const showEmpty = (message) => {
      if(emptyEl){
        emptyEl.textContent = message;
        emptyEl.style.display = 'block';
      }
      if(content) content.style.display = 'none';
      if(pillsContainer) pillsContainer.innerHTML = '';
      if(summaryText) summaryText.textContent = '';
      if(summaryValue){
        summaryValue.textContent = '—';
        summaryValue.className = 'value neutral';
      }
      if(rankingTable) rankingTable.innerHTML = '';
      if(rankingNote) rankingNote.textContent = '';
      if(autoList) autoList.innerHTML = '';
    };

    const hideEmpty = () => {
      if(emptyEl) emptyEl.style.display = 'none';
      if(content) content.style.display = 'flex';
    };

    if(!months.length){
      showEmpty('Dodaj co najmniej dwa zapisy, aby skorzystać z porównania.');
      return;
    }

    if(!monthA || !monthB){
      showEmpty('Wybierz dwa miesiące do porównania.');
      return;
    }

    if(monthA === monthB){
      showEmpty('Wybierz różne miesiące, aby zobaczyć porównanie.');
      return;
    }

    hideEmpty();

    const balancesA = ctx.monthBalances[monthA] || {};
    const balancesB = ctx.monthBalances[monthB] || {};
    const accountMap = new Map((ctx.accounts || []).map(acc => [acc.id, acc]));

    const hasOwn = (obj, key) => Object.prototype.hasOwnProperty.call(obj || {}, key);
    const formatSigned = (value) => {
      if(value === null || value === undefined) return '—';
      if(Math.abs(value) < 0.0005) return fmt(0, state.currency);
      const formatted = fmt(Math.abs(value), state.currency);
      if(value > 0) return `+${formatted}`;
      if(value < 0) return `-${formatted}`;
      return formatted;
    };
    const formatPercent = (value) => {
      if(value === null || value === undefined || Number.isNaN(value)) return '—';
      if(Math.abs(value) < 0.0005) return '0.0%';
      return `${value > 0 ? '+' : ''}${value.toFixed(1)}%`;
    };
    const describeMonths = (count) => {
      if(!Number.isFinite(count) || count <= 0) return '0 miesięcy';
      if(count === 1) return '1 miesiąc';
      if(count >= 2 && count <= 4) return `${count} miesiące`;
      return `${count} miesięcy`;
    };
    const sumBalances = (balances) => {
      return Object.values(balances || {}).reduce((sum, value) => {
        const num = Number(value);
        if(Number.isFinite(num)) return sum + num;
        return sum;
      }, 0);
    };

    const allIds = new Set([...Object.keys(balancesA || {}), ...Object.keys(balancesB || {})]);
    const rows = [];
    allIds.forEach(id => {
      const hasA = hasOwn(balancesA, id);
      const hasB = hasOwn(balancesB, id);
      if(!hasA && !hasB) return;
      const valueA = hasA ? Number(balancesA[id]) : null;
      const valueB = hasB ? Number(balancesB[id]) : null;
      const delta = (valueA ?? 0) - (valueB ?? 0);
      const baseForPct = hasB && valueB !== 0
        ? Math.abs(valueB)
        : (hasA && valueA !== 0 ? Math.abs(valueA) : null);
      const deltaPct = baseForPct ? (delta / baseForPct) * 100 : null;
      let tone = 'neutral';
      if(Math.abs(delta) < 0.005){
        tone = 'neutral';
      } else if(deltaPct !== null && Math.abs(deltaPct) < 1){
        tone = 'neutral';
      } else if(delta > 0){
        tone = 'positive';
      } else if(delta < 0){
        tone = 'negative';
      }
      const status = hasA && !hasB ? 'new' : (!hasA && hasB ? 'closed' : 'existing');
      if(status !== 'existing'){
        tone = delta > 0 ? 'positive' : delta < 0 ? 'negative' : 'neutral';
      }
      const account = accountMap.get(id) || { id, name:`Konto ${id.slice(-4)}` };
      rows.push({
        account,
        id,
        hasA,
        hasB,
        valueA: hasA ? valueA : null,
        valueB: hasB ? valueB : null,
        delta,
        deltaPct,
        tone,
        status
      });
    });

    const totalA = sumBalances(balancesA);
    const totalB = sumBalances(balancesB);
    const totalDelta = totalA - totalB;
    const totalPct = totalB ? (totalDelta / Math.abs(totalB)) * 100 : (totalA ? null : 0);
    const totalTone = totalDelta > 0 ? 'positive' : totalDelta < 0 ? 'negative' : 'neutral';

    const toIndex = (ym) => {
      if(!ym) return null;
      const [y, m] = ym.split('-').map(Number);
      if(!Number.isFinite(y) || !Number.isFinite(m)) return null;
      return y * 12 + (m || 0);
    };
    const idxA = toIndex(monthA);
    const idxB = toIndex(monthB);
    const spanMonths = (idxA !== null && idxB !== null) ? Math.max(1, Math.abs(idxA - idxB)) : null;
    const avgPerMonth = spanMonths ? totalDelta / spanMonths : null;

    if(summaryValue){
      summaryValue.textContent = formatSigned(totalDelta);
      summaryValue.className = `value ${totalTone}`;
    }
    if(summaryText){
      const pctText = Number.isFinite(totalPct) ? formatPercent(totalPct) : null;
      let message = '';
      if(Math.abs(totalDelta) < 0.005){
        message = `Saldo w miesiącu ${formatMonthLabel(monthA)} jest na tym samym poziomie co w ${formatMonthLabel(monthB)}.`;
      } else {
        const directionWord = totalDelta > 0 ? 'WYŻSZE' : 'NIŻSZE';
        const pctPart = pctText ? ` (${pctText})` : '';
        message = `Saldo w miesiącu ${formatMonthLabel(monthA)} jest o ${formatSigned(totalDelta)}${pctPart} ${directionWord} niż w ${formatMonthLabel(monthB)}.`;
      }
      if(spanMonths && spanMonths > 0){
        message += ` Okres między zapisami: ${describeMonths(spanMonths)}.`;
      }
      if(avgPerMonth !== null){
        message += ` Średnio na miesiąc: ${formatSigned(avgPerMonth)}.`;
      }
      summaryText.textContent = message;
    }
    const rowsByMagnitude = [...rows].sort((a,b) => Math.abs((b.delta ?? 0)) - Math.abs((a.delta ?? 0)));
    const topIncrease = rows.filter(row => (row.delta ?? 0) > 0.005).sort((a,b) => (b.delta ?? 0) - (a.delta ?? 0))[0] || null;
    const topDecrease = rows.filter(row => (row.delta ?? 0) < -0.005).sort((a,b) => (a.delta ?? 0) - (b.delta ?? 0))[0] || null;
    const newAccounts = rows.filter(row => row.status === 'new');
    const closedAccounts = rows.filter(row => row.status === 'closed');
    const totalMagnitude = rows.reduce((sum, item) => sum + Math.abs(item.delta ?? 0), 0);
    const topThree = rowsByMagnitude.slice(0, 3);
    const topShare = totalMagnitude > 0 ? (topThree.reduce((sum, item) => sum + Math.abs(item.delta ?? 0), 0) / totalMagnitude) * 100 : 0;

    const insightPills = [];
    if(topIncrease){
      insightPills.push({ label: `Największy wzrost: ${topIncrease.account.name} ${formatSigned(topIncrease.delta)}`, tone: 'positive', accountId: topIncrease.account.id });
    }
    if(topDecrease){
      insightPills.push({ label: `Największy spadek: ${topDecrease.account.name} ${formatSigned(topDecrease.delta)}`, tone: 'negative', accountId: topDecrease.account.id });
    }
    if(topThree.length && totalMagnitude > 0){
      insightPills.push({ label: `TOP 3 odpowiadają za ${topShare.toFixed(1)}% zmiany`, tone: 'info' });
    }
    if(pillsContainer){
      pillsContainer.innerHTML = insightPills.length
        ? insightPills.map(pill => {
            const attrs = pill.accountId ? ` data-account-id="${pill.accountId}"` : '';
            return `<button type="button" class="insight-pill ${pill.tone}"${attrs}>${pill.label}</button>`;
          }).join('')
        : '<span class="tiny muted">Brak wyróżnionych zmian.</span>';
    }

    const maxMagnitude = rows.reduce((max, row) => Math.max(max, Math.abs(row.delta ?? 0)), 0) || 1;
    const biggestChange = rows.reduce((best, item) => {
      const magnitude = Math.abs(item.delta ?? 0);
      if(!best || magnitude > Math.abs(best.delta ?? 0)) return item;
      return best;
    }, null);
    if(biggestChange && Math.abs(biggestChange.delta || 0) >= 0.005){
      biggestChange.isBiggest = true;
    }

    if(rankingTable){
      if(!rows.length){
        rankingTable.innerHTML = '<tbody><tr><td class="muted" style="text-align:center;padding:12px;">Brak danych do rankingu.</td></tr></tbody>';
      } else {
        const head = `<thead><tr><th>Konto</th><th>${formatMonthLabel(monthA)}</th><th>${formatMonthLabel(monthB)}</th><th>Δ PLN</th><th>Δ %</th></tr></thead>`;
        const body = rowsByMagnitude.map(row => {
          const tone = row.delta > 0 ? 'positive' : row.delta < 0 ? 'negative' : 'neutral';
          const progress = Math.min(1, Math.abs(row.delta ?? 0) / maxMagnitude);
          const deltaBar = `<div class=\"eom-mom-change-bar ${tone}\" style=\"--delta-progress:${progress.toFixed(3)}\"><span>${formatSigned(row.delta)}</span></div>`;
          const statusNote = row.status === 'new'
            ? `<div class=\"tiny muted\">Nowe w ${formatMonthLabel(monthA)}</div>`
            : row.status === 'closed'
              ? `<div class=\"tiny muted\">Zamknięte po ${formatMonthLabel(monthB)}</div>`
              : '';
          const biggest = row.isBiggest ? '<div class="tiny muted">Największa zmiana</div>' : '';
          const valueA = row.hasA ? fmt(row.valueA, state.currency) : '<span class="muted">—</span>';
          const valueB = row.hasB ? fmt(row.valueB, state.currency) : '<span class="muted">—</span>';
          const deltaPctCell = row.deltaPct !== null ? formatPercent(row.deltaPct) : '—';
          return `
            <tr data-account-id="${row.account.id}">
              <td><div>${row.account.name}</div>${statusNote}</td>
              <td>${valueA}</td>
              <td>${valueB}</td>
              <td>${deltaBar}${biggest}</td>
              <td>${deltaPctCell}</td>
            </tr>
          `;
        }).join('');
        rankingTable.innerHTML = head + `<tbody>${body}</tbody>`;
      }
    }
    if(rankingNote){
      rankingNote.textContent = rows.length
        ? `Pokazujesz ${rows.length} kont (nowe: ${newAccounts.length}, zamknięte: ${closedAccounts.length}).`
        : '';
    }

    const netSeries = (ctx.netWorthByMonth || [])
      .filter(item => Number.isFinite(item.total))
      .sort((a,b) => a.ym.localeCompare(b.ym));
    const netDiffs = [];
    for(let i=1;i<netSeries.length;i++){
      netDiffs.push(netSeries[i].total - netSeries[i-1].total);
    }
    const historicalAvg = netDiffs.length ? netDiffs.reduce((sum,val)=>sum+val,0) / netDiffs.length : null;
    const last3 = netDiffs.slice(-3);
    const last3Avg = last3.length ? last3.reduce((sum,val)=>sum+val,0) / last3.length : null;
    const vsHistorical = (avgPerMonth !== null && historicalAvg !== null)
      ? avgPerMonth - historicalAvg
      : null;

    const autoInsights = [];
    const totalPctText = Number.isFinite(totalPct) ? formatPercent(totalPct) : null;
    autoInsights.push({
      icon: totalDelta > 0 ? '📈' : totalDelta < 0 ? '📉' : '🟰',
      title: totalDelta === 0 ? 'Portfel bez zmian' : `Całkowita zmiana ${formatSigned(totalDelta)}`,
      description: totalDelta === 0
        ? `Saldo w ${formatMonthLabel(monthA)} jest takie samo jak w ${formatMonthLabel(monthB)}.`
        : `Portfel jest ${totalDelta > 0 ? 'wyższy' : 'niższy'} o ${formatSigned(totalDelta)}${totalPctText ? ` (${totalPctText})` : ''} względem ${formatMonthLabel(monthB)}.`,
      severity: totalDelta > 0 ? 'success' : totalDelta < 0 ? 'danger' : 'info'
    });
    if(topIncrease){
      autoInsights.push({
        icon: '⭐',
        title: `Największy wzrost: ${topIncrease.account.name}`,
        description: `${formatSigned(topIncrease.delta)} vs ${formatMonthLabel(monthB)}.`,
        severity: 'success',
        accountId: topIncrease.account.id
      });
    }
    if(topDecrease){
      autoInsights.push({
        icon: '⚠️',
        title: `Największy spadek: ${topDecrease.account.name}`,
        description: `${formatSigned(topDecrease.delta)} vs ${formatMonthLabel(monthB)}.`,
        severity: 'danger',
        accountId: topDecrease.account.id
      });
    }
    if(topThree.length && totalMagnitude > 0){
      autoInsights.push({
        icon: '📊',
        title: 'Największe kontrybutory zmiany',
        description: `${topThree.map(row => row.account.name).join(', ')} odpowiada za ${topShare.toFixed(1)}% całkowitej zmiany.`,
        severity: 'info'
      });
    }
    if(newAccounts.length){
      autoInsights.push({
        icon: '🆕',
        title: 'Nowe konta w miesiącu A',
        description: newAccounts.map(row => row.account.name).slice(0, 4).join(', '),
        severity: 'info'
      });
    }
    if(closedAccounts.length){
      autoInsights.push({
        icon: '📁',
        title: 'Zamknięte od miesiąca B',
        description: closedAccounts.map(row => row.account.name).slice(0, 4).join(', '),
        severity: 'warning'
      });
    }
    if(avgPerMonth !== null){
      autoInsights.push({
        icon: '⏱️',
        title: 'Średnio miesięczna zmiana',
        description: `Tempo wynosi ${formatSigned(avgPerMonth)} na ${spanMonths ? describeMonths(spanMonths) : 'wybrany okres'}.`,
        severity: avgPerMonth > 0 ? 'success' : avgPerMonth < 0 ? 'danger' : 'info'
      });
    }
    if(last3Avg !== null){
      autoInsights.push({
        icon: '📅',
        title: 'Ostatnie 3 miesiące',
        description: `Średnio ${formatSigned(last3Avg)} na miesiąc w ostatnich 3 zapisach.`,
        severity: last3Avg > 0 ? 'success' : last3Avg < 0 ? 'danger' : 'info'
      });
    }
    if(vsHistorical !== null){
      autoInsights.push({
        icon: '📐',
        title: 'Porównanie do historii',
        description: `Tempo jest ${vsHistorical > 0 ? 'wyższe' : 'niższe'} o ${formatSigned(vsHistorical)} względem średniej historycznej ${historicalAvg !== null ? formatSigned(historicalAvg) : '—'}.`,
        severity: vsHistorical > 0 ? 'success' : vsHistorical < 0 ? 'warning' : 'info'
      });
    }

    if(autoList){
      const finalAuto = autoInsights.slice(0, 8);
      autoList.innerHTML = finalAuto.length
        ? finalAuto.map(item => {
            const attrs = item.accountId ? ` data-account-id="${item.accountId}"` : '';
            return `
              <div class="eom-mom-auto-card ${item.severity}"${attrs}>
                <div class="title"><span>${item.icon}</span><span>${item.title}</span></div>
                <div class="description">${item.description}</div>
              </div>
            `;
          }).join('')
        : '<div class="muted" style="padding:12px;text-align:center;">Brak dodatkowych wniosków dla wybranych miesięcy.</div>';
    }

    const applyFocusedAccount = () => {
      if(!content) return;
      const focusId = eomUiState.focusedAccountId;
      content.querySelectorAll('[data-account-id]').forEach(el => {
        if(focusId && el.dataset.accountId === focusId){
          el.classList.add('is-highlighted');
        } else {
          el.classList.remove('is-highlighted');
        }
      });
    };

    applyFocusedAccount();
  }

  function updateEomDashboardView(view){
    const panels = Array.from(document.querySelectorAll('.eom-dashboard-panel'));
    if(!panels.length) return;
    let desired = view || 'overview';
    if(!panels.some(panel => panel.dataset.panel === desired)){
      desired = panels[0].dataset.panel || 'overview';
    }
    const nav = document.getElementById('eom-dashboard-nav');
    panels.forEach(panel => {
      const match = panel.dataset.panel === desired;
      panel.classList.toggle('is-active', match);
      if(match){
        panel.removeAttribute('hidden');
      } else {
        panel.setAttribute('hidden', '');
      }
    });
    if(nav){
      nav.querySelectorAll('[data-panel]').forEach(btn => {
        const match = btn.dataset.panel === desired;
        btn.classList.toggle('is-active', match);
        if(btn.getAttribute('role') === 'tab'){
          btn.setAttribute('aria-selected', match ? 'true' : 'false');
          btn.setAttribute('tabindex', match ? '0' : '-1');
        }
      });
    }
    if(eomUiState.dashboardView !== desired){
      eomUiState.dashboardView = desired;
      saveEomUiState();
    }
  }

  function buildEomAccountPerformanceCard(ctx, stat, options={}){
    const tone = options.tone === 'negative' ? 'negative' : 'positive';
    const scenario = options.scenario || stat.scenario || 'actual';
    const alertText = options.alert || detectEomAccountAlert(stat, scenario);

    const card = document.createElement('button');
    card.type = 'button';
    card.className = `eom-account-card ${tone}`;
    if(eomUiState.focusedAccountId === stat.account.id){
      card.classList.add('is-focused');
    }
    card.dataset.accountId = stat.account.id;

    const deltaLabel = Number.isFinite(stat.delta)
      ? `${stat.delta >= 0 ? '+' : ''}${fmt(stat.delta, state.currency)}`
      : '—';
    const pctLabel = Number.isFinite(stat.deltaPct)
      ? `${stat.deltaPct >= 0 ? '+' : ''}${stat.deltaPct.toFixed(1)}%`
      : '—';
    const currentLabel = Number.isFinite(stat.current)
      ? fmt(stat.current, state.currency)
      : (Number.isFinite(stat.previous) ? fmt(stat.previous, state.currency) : '—');
    const previousLabel = Number.isFinite(stat.previous)
      ? fmt(stat.previous, state.currency)
      : '—';
    const monthLabel = stat.currentYm || stat.previousYm || ctx.focusMonth || '';

    const header = document.createElement('div');
    header.className = 'eom-account-card-header';
    const nameEl = document.createElement('span');
    nameEl.className = 'eom-account-name';
    nameEl.textContent = stat.account.name;
    header.appendChild(nameEl);
    const deltaEl = document.createElement('span');
    const deltaClass = tone === 'negative'
      ? (Number.isFinite(stat.delta) && stat.delta < 0 ? 'negative' : 'attention')
      : (Number.isFinite(stat.delta) && stat.delta < 0 ? 'negative' : 'positive');
    deltaEl.className = `eom-account-delta ${deltaClass}`;
    deltaEl.textContent = deltaLabel;
    header.appendChild(deltaEl);
    card.appendChild(header);

    const meta = document.createElement('div');
    meta.className = 'eom-account-meta';
    const pctEl = document.createElement('span');
    pctEl.textContent = pctLabel;
    meta.appendChild(pctEl);
    const balanceEl = document.createElement('span');
    balanceEl.className = 'tiny muted';
    balanceEl.textContent = `Saldo: ${currentLabel}${monthLabel ? ` (${monthLabel})` : ''}`;
    meta.appendChild(balanceEl);
    card.appendChild(meta);

    if(alertText){
      const badge = document.createElement('span');
      badge.className = 'eom-account-alert';
      badge.textContent = alertText;
      card.appendChild(badge);
    }

    const sparkWrap = document.createElement('div');
    sparkWrap.className = 'eom-account-spark';
    const canvas = document.createElement('canvas');
    canvas.dataset.spark = stat.account.id;
    let values = (stat.history || [])
      .slice(-6)
      .map(item => {
        const adjusted = applyScenarioToValue(item.balance, scenario);
        return typeof adjusted === 'number' && Number.isFinite(adjusted) ? adjusted : null;
      })
      .filter(val => val !== null);
    if(!values.length){
      const fallback = Number.isFinite(stat.current)
        ? stat.current
        : (Number.isFinite(stat.previous) ? stat.previous : 0);
      values = [fallback, fallback];
    } else if(values.length === 1){
      values = [values[0], values[0]];
    }
    canvas.dataset.values = values.map(val => Number(val.toFixed(2))).join(',');
    canvas.dataset.color = tone === 'negative' ? 'var(--red)' : 'var(--green)';
    sparkWrap.appendChild(canvas);
    card.appendChild(sparkWrap);

    card.title = [
      `Konto: ${stat.account.name}`,
      `Aktualne saldo: ${currentLabel}${monthLabel ? ` (${monthLabel})` : ''}`,
      `Poprzednio: ${previousLabel}${stat.previousYm ? ` (${stat.previousYm})` : ''}`,
      `Zmiana m/m: ${deltaLabel}${pctLabel !== '—' ? ` (${pctLabel})` : ''}`
    ].join('\n');

    card.addEventListener('click', () => {
      eomUiState.focusedAccountId = stat.account.id;
      eomUiState.dashboardView = 'accounts';
      saveEomUiState();
      renderEOM();
      const target = document.getElementById('eom-grid');
      if(target){
        requestAnimationFrame(() => {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      }
    });

    return card;
  }

  function detectEomAccountAlert(stat, scenario){
    const history = stat.history || [];
    let worseningDebt = 0;
    for(let i = Math.max(1, history.length - 3); i < history.length; i++){
      const prevEntry = history[i - 1];
      const currentEntry = history[i];
      const prevVal = prevEntry ? applyScenarioToValue(prevEntry.balance, scenario) : null;
      const currVal = currentEntry ? applyScenarioToValue(currentEntry.balance, scenario) : null;
      if(typeof prevVal === 'number' && typeof currVal === 'number' && prevVal < 0 && currVal < 0 && currVal < prevVal){
        worseningDebt += 1;
      } else {
        worseningDebt = 0;
      }
    }
    if(worseningDebt >= 3){
      return 'Dług rośnie 3 mies.';
    }
    if(stat.deltaPct !== null && Math.abs(stat.deltaPct) >= 50){
      return stat.deltaPct > 0 ? 'Skok >50%' : 'Spadek >50%';
    }
    return null;
  }

  function drawMiniSparkline(canvas, values, options={}){
    if(!canvas) return;
    const ctx2d = canvas.getContext('2d');
    if(!ctx2d) return;
    const width = canvas.clientWidth || 120;
    const height = canvas.clientHeight || 30;
    const ratio = typeof window !== 'undefined' ? (window.devicePixelRatio || 1) : 1;
    canvas.width = width * ratio;
    canvas.height = height * ratio;
    ctx2d.setTransform(ratio, 0, 0, ratio, 0, 0);
    ctx2d.clearRect(0, 0, width, height);

    if(!values.length){
      ctx2d.strokeStyle = 'rgba(148, 163, 184, 0.45)';
      ctx2d.lineWidth = 1.5;
      ctx2d.beginPath();
      ctx2d.moveTo(0, height / 2);
      ctx2d.lineTo(width, height / 2);
      ctx2d.stroke();
      return;
    }

    const min = Math.min(...values);
    const max = Math.max(...values);
    const range = max - min || 1;
    const step = values.length > 1 ? width / (values.length - 1) : width;

    ctx2d.lineWidth = 2;
    ctx2d.lineJoin = 'round';
    ctx2d.lineCap = 'round';
    ctx2d.strokeStyle = options.color || 'var(--accent)';
    ctx2d.beginPath();
    values.forEach((val, idx) => {
      const ratioY = range === 0 ? 0.5 : (val - min) / range;
      const x = idx * step;
      const y = height - ratioY * (height - 6) - 3;
      if(idx === 0) ctx2d.moveTo(x, y); else ctx2d.lineTo(x, y);
    });
    ctx2d.stroke();

    ctx2d.fillStyle = options.pointColor || ctx2d.strokeStyle;
    values.forEach((val, idx) => {
      const ratioY = range === 0 ? 0.5 : (val - min) / range;
      const x = idx * step;
      const y = height - ratioY * (height - 6) - 3;
      ctx2d.beginPath();
      ctx2d.arc(x, y, 2.5, 0, Math.PI * 2);
      ctx2d.fill();
    });
  }

  function renderEomMonthlySummary(summaryRows, options={}){
    const table = document.getElementById('eom-monthly-summary');
    if(!table) return;
    const scenarioKey = options.scenario || 'actual';
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if(thead) thead.innerHTML = '';
    if(tbody) tbody.innerHTML = '';
    if(!summaryRows.length){
      if(tbody) tbody.innerHTML = `<tr><td colspan="8" class="muted" style="text-align:center;padding:16px;">Brak danych historycznych do zestawienia.</td></tr>`;
      return;
    }
    if(!thead || !tbody) return;
    const sortState = eomUiState.monthlySort;
    const cols = [
      { label:'Miesiąc', key:'ym' },
      { label:'Majątek netto', key:'netWorth' },
      { label:'Zmiana m/m', key:'delta' },
      { label:'Największy wzrost', key:'best' },
      { label:'Największy spadek', key:'worst' },
      { label:'Saldo dodatnie', key:'positive' },
      { label:'Saldo ujemne', key:'negative' },
      { label:'Udział długu', key:'debtShare' }
    ];
    thead.innerHTML = '<tr>' + cols.map(col => {
      const active = sortState.field === col.key;
      const indicator = active ? `<span class="sort-indicator">${sortState.dir === 'asc' ? '▲' : '▼'}</span>` : '';
      return `<th data-sort="${col.key}">${col.label}${indicator}</th>`;
    }).join('') + '</tr>';

    const rows = [...summaryRows];
    rows.sort((a,b) => {
      const dir = sortState.dir === 'asc' ? 1 : -1;
      const key = sortState.field;
      if(key === 'ym') return a.ym.localeCompare(b.ym) * dir;
      if(key === 'best'){
        const av = a.best ? a.best.delta : -Infinity;
        const bv = b.best ? b.best.delta : -Infinity;
        if(av === bv) return a.ym.localeCompare(b.ym) * dir;
        return (av - bv) * dir;
      }
      if(key === 'worst'){
        const av = a.worst ? a.worst.delta : Infinity;
        const bv = b.worst ? b.worst.delta : Infinity;
        if(av === bv) return a.ym.localeCompare(b.ym) * dir;
        return (av - bv) * dir;
      }
      const av = Number(a[key] ?? 0);
      const bv = Number(b[key] ?? 0);
      if(av === bv) return a.ym.localeCompare(b.ym) * dir;
      return (av - bv) * dir;
    });

    tbody.innerHTML = rows.map(row => {
      const deltaHtml = row.delta === null ? '<span class="muted">—</span>' : renderDeltaBadge(row.delta);
      const bestHtml = row.best
        ? `<div>${row.best.account.name}</div><div class="tiny ok">${row.best.delta > 0 ? '+' : ''}${fmt(row.best.delta, state.currency)}</div>`
        : '<span class="muted">—</span>';
      const worstHtml = row.worst
        ? `<div>${row.worst.account.name}</div><div class="tiny bad">${row.worst.delta > 0 ? '+' : ''}${fmt(row.worst.delta, state.currency)}</div>`
        : '<span class="muted">—</span>';
      return `<tr><td><b>${row.ym}</b></td><td>${fmt(row.netWorth, state.currency)}</td><td>${deltaHtml}</td><td>${bestHtml}</td><td>${worstHtml}</td><td>${fmt(row.positive, state.currency)}</td><td>${fmt(Math.abs(row.negative), state.currency)}</td><td>${row.debtShare.toFixed(1)}%</td></tr>`;
    }).join('');

    thead.querySelectorAll('th[data-sort]').forEach(th => {
      const key = th.dataset.sort;
      th.onclick = () => {
        if(eomUiState.monthlySort.field === key){
          eomUiState.monthlySort.dir = eomUiState.monthlySort.dir === 'asc' ? 'desc' : 'asc';
        } else {
          eomUiState.monthlySort.field = key;
          eomUiState.monthlySort.dir = key === 'ym' ? 'desc' : 'desc';
        }
        renderEOMHistory();
      };
    });
  }

  function cssVar(name, fallback=''){
    try{
      const value = getComputedStyle(document.documentElement).getPropertyValue(name);
      return value ? value.trim() : fallback;
    }catch(err){
      return fallback;
    }
  }

  function colorWithAlpha(color, alpha){
    if(color === undefined || color === null){
      return `rgba(37,99,235,${alpha})`;
    }
    const value = String(color).trim();
    if(value.startsWith('#')) return withAlpha(value, alpha);
    if(value.startsWith('rgba')){
      const parts = value.replace(/rgba\(|\)/g,'').split(',').map(p=>p.trim()).slice(0,3);
      if(parts.length===3) return `rgba(${parts[0]},${parts[1]},${parts[2]},${alpha})`;
      return value;
    }
    if(value.startsWith('rgb')){
      const parts = value.replace(/rgb\(|\)/g,'').split(',').map(p=>p.trim()).slice(0,3);
      if(parts.length===3) return `rgba(${parts[0]},${parts[1]},${parts[2]},${alpha})`;
      return value;
    }
    if(value.startsWith('hsl') && value.includes('/')){
      return value.replace(/\/[^)]+\)/, `/ ${alpha})`);
    }
    if(value.startsWith('hsl')){
      return `${value.replace(/\)$/, '')} / ${alpha})`;
    }
    return value;
  }

  function updateNetWorthRangeTabs(activeRange){
    const tabs = document.querySelectorAll('[data-range-tab]');
    tabs.forEach(tab => {
      const value = tab.dataset.rangeTab;
      tab.classList.toggle('is-active', value === activeRange);
      if(!tab.dataset.bound){
        tab.dataset.bound = '1';
        tab.addEventListener('click', () => {
          const next = tab.dataset.rangeTab;
          if(!next || next === eomUiState.netWorthRange) return;
          eomUiState.netWorthRange = next;
          saveEomUiState();
          renderEOMHistory();
        });
      }
    });
  }

  function renderNetWorthMonthCard(detail){
    const container = document.getElementById('eom-networth-month-card');
    if(!container) return;
    if(!detail){
      container.classList.add('is-empty');
      container.innerHTML = 'Brak danych dla tego zakresu. Dodaj zapisy lub zmodyfikuj filtry, aby zobaczyć szczegóły.';
      return;
    }
    container.classList.remove('is-empty');
    const deltaClass = detail.delta === null ? 'neutral' : detail.delta > 0 ? 'positive' : detail.delta < 0 ? 'negative' : 'neutral';
    const deltaText = detail.delta === null
      ? 'Brak danych porównawczych'
      : `${detail.delta > 0 ? '+' : ''}${fmt(detail.delta, state.currency)}${detail.deltaPct !== null ? ` (${detail.deltaPct > 0 ? '+' : ''}${detail.deltaPct.toFixed(1)}%)` : ''}`;
    const prevLine = detail.prevMonth ? `<span class="muted">vs ${detail.prevMonth}</span>` : '';
    const holdingsHtml = detail.topHoldings.length
      ? detail.topHoldings.map(item => `<li${item.value < 0 ? ' class="negative"' : ''}><span>${item.account.name}${item.share ? ` <span class="tiny muted">${item.share.toFixed(1)}%</span>` : ''}</span><span>${fmt(item.value, state.currency)}</span></li>`).join('')
      : '<li class="muted">Brak danych o kontach</li>';
    const moversHtml = detail.topMovers.length
      ? detail.topMovers.map(item => `<li class="${item.delta >= 0 ? 'positive' : 'negative'}"><span>${item.account.name}</span><span>${item.delta >= 0 ? '+' : ''}${fmt(item.delta, state.currency)}</span></li>`).join('')
      : '<li class="muted">Brak znaczących zmian m/m</li>';
    container.innerHTML = `
      <div class="eom-networth-card-header">
        <span>Okres</span>
        <span class="eom-networth-card-month">${detail.ym}</span>
      </div>
      <div class="eom-networth-card-total">${fmt(detail.total, state.currency)}</div>
      <div class="eom-networth-card-delta ${deltaClass}">
        <span>${deltaText}</span>
        ${prevLine}
      </div>
      <div class="eom-networth-card-split">
        <span>Aktywa: <strong>${fmt(detail.assets, state.currency)}</strong></span>
        <span>Długi: <strong>${fmt(Math.abs(detail.debt), state.currency)}</strong> (${detail.debtShare.toFixed(1)}%)</span>
      </div>
      <div class="eom-networth-card-list">
        <span>Największe składniki</span>
        <ul>${holdingsHtml}</ul>
      </div>
      <div class="eom-networth-card-list">
        <span>Najmocniejsze ruchy m/m</span>
        <ul>${moversHtml}</ul>
      </div>
    `;
  }

  function updateNetWorthHighlight(chart, focusMonth){
    if(!chart) return;
    const dataset = chart.data?.datasets?.[0];
    if(!dataset) return;
    const details = chart.__details || [];
    const accent = cssVar('--accent','#2563eb');
    const ink = cssVar('--ink','#0f172a');
    const green = cssVar('--green','#22c55e');
    const red = cssVar('--red','#ef4444');
    dataset.pointRadius = details.map(detail => {
      const base = detail.isMax || detail.isMin ? 6 : 4;
      return detail.ym === focusMonth ? Math.max(base, 7) : base;
    });
    dataset.pointHoverRadius = dataset.pointRadius.map(r => r + 2);
    dataset.pointBackgroundColor = details.map(detail => {
      if(detail.ym === focusMonth) return accent || '#2563eb';
      if(detail.isMax) return green || '#22c55e';
      if(detail.isMin) return red || '#ef4444';
      return ink || '#0f172a';
    });
    dataset.pointBorderColor = details.map(detail => {
      if(detail.ym === focusMonth) return colorWithAlpha(accent || '#2563eb', 0.75);
      if(detail.isMax) return colorWithAlpha(green || '#22c55e', 0.45);
      if(detail.isMin) return colorWithAlpha(red || '#ef4444', 0.45);
      return colorWithAlpha(accent || '#2563eb', 0.25);
    });
    dataset.pointBorderWidth = details.map(detail => detail.ym === focusMonth ? 3 : (detail.isMax || detail.isMin ? 2 : 1.5));
    chart.update('none');
  }

  function setNetWorthFocus(month, chart, persist=true){
    if(!chart){
      renderNetWorthMonthCard(null);
      return;
    }
    const details = chart.__details || [];
    const detail = details.find(item => item.ym === month) || details[details.length - 1] || null;
    eomUiState.netWorthFocusMonth = detail ? detail.ym : null;
    if(persist) saveEomUiState();
    updateNetWorthHighlight(chart, eomUiState.netWorthFocusMonth);
    renderNetWorthMonthCard(detail);
  }

  function renderEomNetWorthChart(ctx, options={}){
    const canvas = document.getElementById('eom-networth-chart');
    const emptyState = document.getElementById('eom-networth-empty');
    updateNetWorthRangeTabs(eomUiState.netWorthRange || '6m');
    if(!canvas){
      destroyEomChart('netWorth');
      renderNetWorthMonthCard(null);
      return;
    }
    destroyEomChart('netWorth');
    const scenario = options.scenario || 'actual';
    const typeFilter = new Set(Array.isArray(options.accountTypes) ? options.accountTypes : []);
    const relevantAccounts = ctx.accounts.filter(acc => typeFilter.size === 0 || typeFilter.has(inferAccountType(acc)));
    const baseMonths = getMonthsWithinRange(ctx.months, eomUiState.dateRange);
    const months = baseMonths.length ? baseMonths : ctx.months;
    const rangeKey = eomUiState.netWorthRange || '6m';
    let labels = months.slice();
    if(rangeKey !== 'all'){
      const limit = Number(rangeKey.replace('m','')) || 6;
      labels = labels.slice(-limit);
    }
    if(!labels.length || !relevantAccounts.length){
      if(emptyState) emptyState.classList.add('is-visible');
      renderNetWorthMonthCard(null);
      return;
    }
    if(emptyState) emptyState.classList.remove('is-visible');

    const netWorthForMonth = (ym) => {
      if(!ym) return null;
      const balances = ctx.monthBalances[ym] || {};
      let sum = 0;
      let hasAny = false;
      for(const acc of relevantAccounts){
        const value = balances[acc.id];
        if(value === undefined) continue;
        const adjusted = applyScenarioToValue(value, scenario);
        if(typeof adjusted !== 'number' || Number.isNaN(adjusted)) continue;
        sum += adjusted;
        hasAny = true;
      }
      if(!hasAny) return null;
      return Number(sum.toFixed(2));
    };

    const details = labels.map(ym => {
      const total = netWorthForMonth(ym);
      if(total === null) return null;
      const prevMonth = ctx.months.filter(m => m < ym).pop() || null;
      const prevTotal = prevMonth ? netWorthForMonth(prevMonth) : null;
      const delta = prevTotal !== null && prevTotal !== undefined ? Number((total - prevTotal).toFixed(2)) : null;
      const deltaPct = delta !== null && prevTotal ? (delta / Math.abs(prevTotal)) * 100 : null;
      const breakdown = [];
      let assets = 0;
      let debt = 0;
      const balances = ctx.monthBalances[ym] || {};
      const prevBalances = prevMonth ? (ctx.monthBalances[prevMonth] || {}) : {};
      for(const acc of relevantAccounts){
        const raw = balances[acc.id];
        if(raw === undefined) continue;
        const value = applyScenarioToValue(raw, scenario);
        if(typeof value !== 'number' || Number.isNaN(value)) continue;
        const prevRaw = prevBalances[acc.id];
        const prevVal = prevRaw === undefined ? null : applyScenarioToValue(prevRaw, scenario);
        const deltaAcc = prevVal === null || prevVal === undefined ? value : Number((value - prevVal).toFixed(2));
        if(value >= 0) assets += value; else debt += value;
        breakdown.push({ account: acc, value, delta: deltaAcc, previous: prevVal });
      }
      const shareBase = assets + Math.abs(debt);
      const topHoldings = breakdown.length
        ? [...breakdown].sort((a,b) => Math.abs(b.value) - Math.abs(a.value)).slice(0,3).map(item => ({
            account:item.account,
            value:item.value,
            share: shareBase ? (Math.abs(item.value) / shareBase) * 100 : 0
          }))
        : [];
      const movers = breakdown.filter(item => item.delta !== null && item.delta !== undefined && Math.abs(item.delta) >= 0.005);
      const topMovers = movers.length
        ? [...movers].sort((a,b) => Math.abs(b.delta) - Math.abs(a.delta)).slice(0,3)
        : [];
      const debtShare = shareBase ? (Math.abs(debt) / shareBase) * 100 : 0;
      return {
        ym,
        total,
        prevMonth,
        delta,
        deltaPct,
        assets: Number(assets.toFixed(2)),
        debt: Number(debt.toFixed(2)),
        debtShare,
        topHoldings,
        topMovers,
        breakdown
      };
    }).filter(Boolean);

    if(!details.length){
      renderNetWorthMonthCard(null);
      return;
    }

    const maxDetail = details.reduce((best, item) => (!best || item.total > best.total) ? item : best, null);
    const minDetail = details.reduce((worst, item) => (!worst || item.total < worst.total) ? item : worst, null);
    details.forEach(detail => {
      detail.isMax = !!(maxDetail && detail.ym === maxDetail.ym);
      detail.isMin = !!(minDetail && detail.ym === minDetail.ym);
      const holdings = detail.topHoldings.length
        ? detail.topHoldings
        : [...detail.breakdown].sort((a,b) => Math.abs(b.value) - Math.abs(a.value)).slice(0,3).map(item => ({ account:item.account, value:item.value, share:0 }));
      detail.tooltipHoldings = holdings.map(item => ({ account:item.account, value:item.value, share:item.share ?? 0 }));
    });

    const accent = cssVar('--accent','#2563eb');
    const ink = cssVar('--ink','#0f172a');
    const green = cssVar('--green','#22c55e');
    const red = cssVar('--red','#ef4444');
    const datasetColor = accent || '#2563eb';
    const data = details.map(detail => detail.total);
    const ctx2d = canvas.getContext('2d');

    eomCharts.netWorth = new Chart(ctx2d, {
      type:'line',
      data:{
        labels: details.map(detail => detail.ym),
        datasets:[{
          label:`Majątek netto (${EOM_SCENARIOS[scenario]?.label || 'Realny'})`,
          data,
          tension:0.35,
          borderWidth:2.5,
          borderColor: datasetColor,
          fill:true,
          pointHitRadius:14,
          pointHoverBorderWidth:3,
          pointRadius: details.map(detail => detail.isMax || detail.isMin ? 6 : 4),
          pointHoverRadius: details.map(detail => detail.isMax || detail.isMin ? 7 : 6),
          pointBackgroundColor: details.map(detail => detail.isMax ? (green || '#22c55e') : detail.isMin ? (red || '#ef4444') : (ink || '#0f172a')),
          pointBorderColor: details.map(detail => colorWithAlpha(datasetColor, detail.isMax || detail.isMin ? 0.45 : 0.25)),
          pointBorderWidth: details.map(detail => detail.isMax || detail.isMin ? 2 : 1.5),
          backgroundColor: (ctxGradient) => {
            const chartArea = ctxGradient.chart.chartArea;
            if(!chartArea){
              return colorWithAlpha(datasetColor, 0.16);
            }
            const gradient = ctxGradient.chart.ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
            gradient.addColorStop(0, colorWithAlpha(datasetColor, 0.28));
            gradient.addColorStop(1, colorWithAlpha(datasetColor, 0));
            return gradient;
          }
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        plugins:{
          legend:{ display:false },
          tooltip:{
            displayColors:false,
            callbacks:{
              title: items => items[0]?.label ? `Miesiąc ${items[0].label}` : '',
              label: context => `${fmt(context.parsed.y, state.currency)}`,
              afterBody: items => {
                if(!items.length) return [];
                const detail = details[items[0].dataIndex];
                if(!detail || !detail.tooltipHoldings.length) return [];
                const lines = detail.tooltipHoldings.map(item => ` ${item.account.name}: ${fmt(item.value, state.currency)}${item.share ? ` (${item.share.toFixed(1)}%)` : ''}`);
                return ['Top konta:'].concat(lines);
              },
              footer: items => {
                if(!items.length) return '';
                const detail = details[items[0].dataIndex];
                if(!detail || detail.delta === null) return '';
                const sign = detail.delta > 0 ? '+' : '';
                const pct = detail.deltaPct !== null ? ` (${detail.deltaPct > 0 ? '+' : ''}${detail.deltaPct.toFixed(1)}%)` : '';
                return `Δ m/m: ${sign}${fmt(detail.delta, state.currency)}${pct}`;
              }
            }
          }
        },
        layout:{ padding:{ top:8, right:12, bottom:8, left:12 } },
        scales:{
          x:{
            grid:{ display:false },
            ticks:{ maxRotation:0 }
          },
          y:{
            ticks:{ callback: currencyTicks },
            grid:{ drawBorder:false, color: colorWithAlpha(ink || '#0f172a', 0.08) }
          }
        },
        onHover:(evt, elements)=>{
          const target = evt?.native?.target;
          if(target){
            target.style.cursor = elements.length ? 'pointer' : 'default';
          }
        },
        onClick:(evt)=>{
          const chart = eomCharts.netWorth;
          if(!chart) return;
          const elements = chart.getElementsAtEventForMode(evt,'nearest',{ intersect:false },true);
          if(!elements.length) return;
          const idx = elements[0].index;
          const detail = details[idx];
          if(detail){
            setNetWorthFocus(detail.ym, chart, true);
          }
        }
      }
    });

    eomCharts.netWorth.__details = details;
    const focusCandidate = eomUiState.netWorthFocusMonth && details.some(detail => detail.ym === eomUiState.netWorthFocusMonth)
      ? eomUiState.netWorthFocusMonth
      : details[details.length - 1].ym;
    setNetWorthFocus(focusCandidate, eomCharts.netWorth, false);

    if(!canvas.dataset.networthBound){
      canvas.dataset.networthBound = '1';
      canvas.addEventListener('dblclick', evt => {
        const chart = eomCharts.netWorth;
        if(!chart) return;
        const elements = chart.getElementsAtEventForMode(evt,'nearest',{ intersect:false },true);
        if(!elements.length){
          eomUiState.dateRange = { from:null, to:null };
          renderEOM();
          renderEOMHistory();
          return;
        }
        const idx = elements[0].index;
        const labels = chart.data.labels || [];
        if(!labels.length) return;
        const start = Math.max(0, idx - 1);
        const end = Math.min(labels.length - 1, idx + 1);
        eomUiState.dateRange = { from: labels[start], to: labels[end] };
        renderEOM();
        renderEOMHistory();
      });
    }
  }

  function renderEOM(){
    const ctx = buildEomContext();
    const ym = ctx.workingYm;
    const prompt = document.getElementById('eom-prompt');
    if(prompt){
      const lastInfo = ctx.hasWorking
        ? 'Masz już zapisane salda dla tego miesiąca — możesz je zaktualizować.'
        : ctx.latestMonth ? `Ostatnio zapisano dane dla ${ctx.latestMonth}.` : 'To będzie Twój pierwszy zapis sald.';
      prompt.innerHTML = `Wprowadź salda swoich kont na koniec miesiąca <b>${ym}</b>. <span class="muted">${lastInfo}</span>`;
    }
    const badge = document.getElementById('eom-active-month');
    if(badge) badge.textContent = ym;

    const dashboardNav = document.getElementById('eom-dashboard-nav');
    if(dashboardNav){
      if(!dashboardNav.dataset.bound){
        dashboardNav.dataset.bound = '1';
        dashboardNav.addEventListener('click', (event) => {
          const btn = event.target.closest('[data-panel]');
          if(!btn) return;
          const next = btn.dataset.panel;
          if(!next) return;
          updateEomDashboardView(next);
        });
      }
      updateEomDashboardView(eomUiState.dashboardView || 'overview');
    }

    renderEomComparison(ctx);

    const sortSelect = document.getElementById('eom-account-sort');
    if(sortSelect){
      sortSelect.value = eomUiState.accountSort || 'balance';
      if(!sortSelect.dataset.bound){
        sortSelect.dataset.bound = '1';
        sortSelect.addEventListener('change', () => {
          eomUiState.accountSort = sortSelect.value;
          renderEOM();
        });
      }
    }

    const positiveBox = document.getElementById('eom-filter-positive');
    const negativeBox = document.getElementById('eom-filter-negative');
    const hideZeroBox = document.getElementById('eom-filter-hide-zero');
    if(positiveBox){
      positiveBox.checked = !!eomUiState.filterPositiveOnly;
      if(!positiveBox.dataset.bound){
        positiveBox.dataset.bound = '1';
        positiveBox.addEventListener('change', () => {
          eomUiState.filterPositiveOnly = positiveBox.checked;
          renderEOM();
        });
      }
    }
    if(negativeBox){
      negativeBox.checked = !!eomUiState.filterNegativeOnly;
      if(!negativeBox.dataset.bound){
        negativeBox.dataset.bound = '1';
        negativeBox.addEventListener('change', () => {
          eomUiState.filterNegativeOnly = negativeBox.checked;
          renderEOM();
        });
      }
    }
    if(hideZeroBox){
      hideZeroBox.checked = !!eomUiState.hideZeroAccounts;
      if(!hideZeroBox.dataset.bound){
        hideZeroBox.dataset.bound = '1';
        hideZeroBox.addEventListener('change', () => {
          eomUiState.hideZeroAccounts = hideZeroBox.checked;
          renderEOM();
        });
      }
    }

    const expandAllBtn = document.getElementById('eom-expand-all');
    if(expandAllBtn && !expandAllBtn.dataset.bound){
      expandAllBtn.dataset.bound = '1';
      expandAllBtn.addEventListener('click', () => {
        const cards = Array.from(document.querySelectorAll('#eom-grid .eom-account-item'));
        eomUiState.expandedAccounts = cards.map(card => card.dataset.accountId).filter(Boolean);
        renderEOM();
      });
    }
    const collapseAllBtn = document.getElementById('eom-collapse-all');
    if(collapseAllBtn && !collapseAllBtn.dataset.bound){
      collapseAllBtn.dataset.bound = '1';
      collapseAllBtn.addEventListener('click', () => {
        eomUiState.expandedAccounts = [];
        renderEOM();
      });
    }

    const typeSelect = document.getElementById('eom-account-type-filter');
    if(typeSelect){
      const types = [...new Set((ctx.accounts || []).map(inferAccountType))].sort((a,b) => a.localeCompare(b, 'pl', { sensitivity:'base' }));
      const selected = new Set(eomUiState.accountTypes || []);
      typeSelect.innerHTML = '';
      types.forEach(type => typeSelect.add(new Option(capitalizeFirst(type), type, false, selected.has(type))));
      if(!typeSelect.dataset.bound){
        typeSelect.dataset.bound = '1';
        typeSelect.addEventListener('change', () => {
          eomUiState.accountTypes = Array.from(typeSelect.selectedOptions).map(opt => opt.value);
          renderEOM();
          renderEOMHistory();
        });
      }
    }

    const fromInput = document.getElementById('eom-date-from');
    if(fromInput){
      fromInput.value = eomUiState.dateRange.from || '';
      if(!fromInput.dataset.bound){
        fromInput.dataset.bound = '1';
        fromInput.addEventListener('change', () => {
          eomUiState.dateRange.from = fromInput.value || null;
          renderEOM();
          renderEOMHistory();
        });
      }
    }
    const toInput = document.getElementById('eom-date-to');
    if(toInput){
      toInput.value = eomUiState.dateRange.to || '';
      if(!toInput.dataset.bound){
        toInput.dataset.bound = '1';
        toInput.addEventListener('change', () => {
          eomUiState.dateRange.to = toInput.value || null;
          renderEOM();
          renderEOMHistory();
        });
      }
    }

    const pivotToggle = document.getElementById('eom-pivot-toggle');
    if(pivotToggle){
      pivotToggle.dataset.active = eomUiState.pivotMode ? '1' : '0';
      pivotToggle.textContent = eomUiState.pivotMode ? 'Widok edycyjny' : 'Widok pivot';
      if(!pivotToggle.dataset.bound){
        pivotToggle.dataset.bound = '1';
        pivotToggle.addEventListener('click', () => {
          eomUiState.pivotMode = !eomUiState.pivotMode;
          renderEOM();
        });
      }
    }

    const groupSel = document.getElementById('eom-group-by');
    if(groupSel){
      groupSel.value = eomUiState.groupBy;
      if(!groupSel.dataset.bound){
        groupSel.dataset.bound = '1';
        groupSel.addEventListener('change', () => {
          eomUiState.groupBy = groupSel.value;
          renderEOM();
        });
      }
    }

    const sparkMonths = monthsForSparkline(ctx, eomUiState.dateRange);
    const selectedTypes = new Set(eomUiState.accountTypes || []);
    const wantsPositiveOnly = !!eomUiState.filterPositiveOnly;
    const wantsNegativeOnly = !!eomUiState.filterNegativeOnly;
    const hideZeroAccounts = !!eomUiState.hideZeroAccounts;
    const threshold = 0.005;

    const rows = ctx.accounts.map(acc => {
      const type = inferAccountType(acc);
      if(selectedTypes.size && !selectedTypes.has(type)) return null;
      const history = ctx.accountHistory[acc.id] || [];
      const currentEntry = entryForMonth(history, ym);
      const prevEntry = lastEntryBefore(history, ym);
      const referenceValue = currentEntry ? currentEntry.balance : (prevEntry ? prevEntry.balance : 0);
      const isZero = Math.abs(referenceValue || 0) < threshold;
      if(wantsPositiveOnly && !wantsNegativeOnly && referenceValue <= 0) return null;
      if(!wantsPositiveOnly && wantsNegativeOnly && referenceValue >= 0) return null;
      if(wantsPositiveOnly && wantsNegativeOnly && isZero) return null;
      if(hideZeroAccounts && isZero) return null;
      const currentValue = currentEntry ? currentEntry.balance : null;
      const previousValue = prevEntry ? prevEntry.balance : null;
      const scenarioCurrent = currentValue === null ? null : applyScenarioToValue(currentValue, eomUiState.scenario);
      const scenarioPrevious = previousValue === null ? null : applyScenarioToValue(previousValue, eomUiState.scenario);
      const deltaAdjusted = (scenarioCurrent !== null || scenarioPrevious !== null) ? ((scenarioCurrent ?? 0) - (scenarioPrevious ?? 0)) : null;
      const deltaPct = scenarioPrevious && scenarioPrevious !== 0 ? (deltaAdjusted / Math.abs(scenarioPrevious)) * 100 : null;
      const sparklinePoints = buildSparklinePoints(history, sparkMonths).map(pt => ({ ym: pt.ym, value: applyScenarioToValue(pt.value, eomUiState.scenario) ?? 0 }));
      const adjustedHistory = history.map(item => {
        const value = applyScenarioToValue(item.balance, eomUiState.scenario);
        return { ym: item.ym, value: typeof value === 'number' ? value : null };
      }).filter(item => item.value !== null);
      const lastSix = adjustedHistory.slice(-6);
      const avgSix = lastSix.length ? lastSix.reduce((sum, item) => sum + item.value, 0) / lastSix.length : null;
      const recordEntry = adjustedHistory.reduce((best, item) => (!best || item.value > best.value ? item : best), null);
      const minEntry = adjustedHistory.reduce((worst, item) => (!worst || item.value < worst.value ? item : worst), null);
      let streakDir = null;
      let streakCount = 0;
      for(let i = adjustedHistory.length - 1; i > 0; i--){
        const curr = adjustedHistory[i]?.value;
        const prev = adjustedHistory[i-1]?.value;
        if(typeof curr !== 'number' || typeof prev !== 'number') continue;
        const diff = curr - prev;
        const dir = diff > threshold ? 'up' : diff < -threshold ? 'down' : 'flat';
        if(dir === 'flat'){
          if(streakDir === null) continue;
          else break;
        }
        if(streakDir === null){
          streakDir = dir;
          streakCount = 1;
        } else if(streakDir === dir){
          streakCount += 1;
        } else {
          break;
        }
      }
      let trendDescription = 'Wahania bez wyraźnego trendu';
      if(streakDir === 'up' && streakCount >= 2){
        trendDescription = `Rośnie ${streakCount + 1} miesiąc z rzędu`;
      } else if(streakDir === 'down' && streakCount >= 2){
        trendDescription = `Spada ${streakCount + 1} miesiąc z rzędu`;
      } else if(streakDir === 'up'){
        trendDescription = 'Lekki wzrost w tym miesiącu';
      } else if(streakDir === 'down'){
        trendDescription = 'Lekki spadek w tym miesiącu';
      } else if(Math.abs(deltaAdjusted || 0) < threshold){
        trendDescription = 'Stabilne w ostatnim miesiącu';
      }
      const trendDirection = deltaAdjusted === null ? 'flat' : (deltaAdjusted > threshold ? 'up' : deltaAdjusted < -threshold ? 'down' : 'flat');
      const trendArrow = trendDirection === 'up' ? '↗' : trendDirection === 'down' ? '↘' : '→';
      const deltaDisplay = deltaAdjusted === null ? '—' : `${deltaAdjusted > 0 ? '+' : '−'}${fmt(Math.abs(deltaAdjusted), state.currency)}`;
      const pctDisplay = deltaPct !== null ? `${deltaPct > 0 ? '+' : ''}${deltaPct.toFixed(1)}%` : '—';
      const scenarioBalance = scenarioCurrent !== null ? fmt(scenarioCurrent, state.currency) : (currentValue !== null ? fmt(currentValue, state.currency) : '—');
      const previousDisplay = scenarioPrevious !== null ? fmt(scenarioPrevious, state.currency) : (previousValue !== null ? fmt(previousValue, state.currency) : '—');
      const dormant = history.length >= 3 ? history.slice(-3).every(item => {
        const val = applyScenarioToValue(item.balance, eomUiState.scenario);
        return Math.abs((typeof val === 'number' ? val : 0)) < threshold;
      }) : false;
      const subtitleParts = [capitalizeFirst(type), capitalizeFirst(eomAccountStatus(referenceValue))];
      const subtitle = subtitleParts.filter(Boolean).join(' · ');
      const sparkColor = trendDirection === 'down' ? '#dc2626' : trendDirection === 'up' ? '#16a34a' : '#64748b';
      let deltaLabel = deltaAdjusted === null ? '<span class=\"muted\">—</span>' : renderDeltaBadge(deltaAdjusted);
      const prevBits = [];
      if(previousValue === null){
        prevBits.push('<span class=\"muted\">Brak danych</span>');
      } else {
        prevBits.push(`<strong>${fmt(previousValue, state.currency)}</strong>`);
        if(prevEntry?.ym){
          prevBits.push(`<span class=\"tiny muted\">${prevEntry.ym}</span>`);
        }
      }
      let groupKey = 'Wszystkie konta';
      if(eomUiState.groupBy === 'type') groupKey = `Typ: ${capitalizeFirst(type)}`;
      if(eomUiState.groupBy === 'status') groupKey = `Status: ${capitalizeFirst(eomAccountStatus(referenceValue))}`;
      return {
        acc,
        typeLabel: capitalizeFirst(type),
        statusLabel: capitalizeFirst(eomAccountStatus(referenceValue)),
        previousLabel: prevBits.join('<br>'),
        currentInput: currentValue === null ? '' : String(currentValue).replace('.',','),
        currentValue,
        adjustedCurrent: scenarioCurrent,
        adjustedPrevious: scenarioPrevious,
        previousAdjusted: scenarioPrevious,
        deltaAdjusted,
        deltaPct,
        deltaLabel,
        deltaDisplay,
        deltaPctDisplay: pctDisplay,
        trendArrow,
        trendDirection,
        trendDescription,
        displayBalance: scenarioBalance,
        previousDisplay,
        averageSix: avgSix,
        recordEntry,
        minEntry,
        sparkColor,
        isDormant: dormant,
        subtitle,
        sparklinePoints,
        history,
        groupKey
      };
    }).filter(Boolean);

    if(eomUiState.focusedAccountId && !rows.some(row => row.acc.id === eomUiState.focusedAccountId)){
      eomUiState.focusedAccountId = null;
    }

    const gridResult = eomUiState.pivotMode
      ? renderEomPivotTable(ctx, rows, sparkMonths, eomUiState.scenario)
      : renderEomInteractiveGrid(ctx, rows, { focusedAccountId: eomUiState.focusedAccountId, scenario: eomUiState.scenario });

    renderEomHeatmap(ctx, rows, sparkMonths, eomUiState.scenario);

    const gridContainer = document.getElementById('eom-grid');
    const totalEl = document.getElementById('eom-total');
    const updateTotal = () => {
      if(!gridContainer || !totalEl) return;
      const inputs = Array.from(gridContainer.querySelectorAll('input[data-id]'));
      const scenarioKey = eomUiState.scenario || 'actual';
      if(!inputs.length){
        const base = rows.reduce((sum, row) => sum + (row.currentValue ?? 0), 0);
        const scenarioTotal = rows.reduce((sum, row) => {
          if(row.currentValue === null || row.currentValue === undefined) return sum;
          const adjusted = applyScenarioToValue(row.currentValue, scenarioKey) ?? 0;
          return sum + adjusted;
        }, 0);
        totalEl.innerHTML = `${fmt(base, state.currency)}${scenarioKey !== 'actual' ? ` <span class="tiny muted">(${fmt(scenarioTotal, state.currency)} ${EOM_SCENARIOS[scenarioKey]?.label || ''})</span>` : ''}`;
        return;
      }
      let scenarioTotal = 0;
      const total = inputs.reduce((sum, input) => {
        if(input.value.trim() === '') return sum;
        const raw = num(input.value) || 0;
        scenarioTotal += applyScenarioToValue(raw, scenarioKey) ?? 0;
        return sum + raw;
      }, 0);
      totalEl.innerHTML = `${fmt(total, state.currency)}${scenarioKey !== 'actual' ? ` <span class="tiny muted">(${fmt(scenarioTotal, state.currency)} ${EOM_SCENARIOS[scenarioKey]?.label || ''})</span>` : ''}`;
    };

    if(!eomUiState.pivotMode){
      bindMoneyInputs(gridContainer);
      const rowMap = new Map(rows.map(row => [row.acc.id, row]));
      gridResult.inputs.forEach(input => {
        const accountId = input.dataset.id;
        const row = rowMap.get(accountId);
        const deltaNodes = gridContainer.querySelectorAll(`[data-delta="${accountId}"]`);
        const balanceNode = gridContainer.querySelector(`[data-balance="${accountId}"]`);
        const updateRow = () => {
          const raw = input.value.trim() === '' ? null : num(input.value);
          const scenarioValue = raw === null ? null : applyScenarioToValue(raw, eomUiState.scenario);
          row.currentValue = raw;
          row.adjustedCurrent = scenarioValue;

          const prevAdjusted = row.adjustedPrevious ?? row.previousAdjusted ?? null;
          const hasAny = !(scenarioValue === null && prevAdjusted === null);
          const deltaVal = hasAny ? ((scenarioValue ?? 0) - (prevAdjusted ?? 0)) : null;
          const pctVal = prevAdjusted && prevAdjusted !== 0 ? (deltaVal / Math.abs(prevAdjusted)) * 100 : null;
          row.deltaAdjusted = deltaVal;
          row.deltaPct = pctVal;

          const threshold = 0.005;
          const direction = deltaVal === null ? 'flat' : (deltaVal > threshold ? 'up' : deltaVal < -threshold ? 'down' : 'flat');
          const arrow = direction === 'up' ? '↗' : direction === 'down' ? '↘' : '→';
          const deltaDisplay = deltaVal === null ? '—' : `${deltaVal > 0 ? '+' : '−'}${fmt(Math.abs(deltaVal), state.currency)}`;
          const pctDisplay = pctVal !== null ? `${pctVal > 0 ? '+' : ''}${pctVal.toFixed(1)}%` : '—';
          row.trendDirection = direction;
          row.trendArrow = arrow;
          row.deltaDisplay = deltaDisplay;
          row.deltaPctDisplay = pctDisplay;
          row.sparkColor = direction === 'down' ? '#dc2626' : direction === 'up' ? '#16a34a' : '#64748b';

          if(balanceNode){
            const balanceText = scenarioValue !== null ? fmt(scenarioValue, state.currency) : (raw !== null ? fmt(raw, state.currency) : '—');
            balanceNode.textContent = balanceText;
            row.displayBalance = balanceText;
          }

          const cardEl = input.closest('.eom-account-item');
          if(cardEl){
            cardEl.title = `${row.acc.name}: ${row.displayBalance}${row.deltaDisplay && row.deltaDisplay !== '—' ? ` | Δ ${row.deltaDisplay}` : ''}`;
          }

          if(deltaNodes.length){
            deltaNodes.forEach(node => {
              const role = node.dataset.role || '';
              if(role === 'header'){
                const tone = direction === 'up' ? 'up' : direction === 'down' ? 'down' : 'flat';
                node.classList.remove('up','down','flat');
                node.classList.add(tone);
                const headerHtml = pctDisplay !== '—'
                  ? `<span class="arrow ${tone}">${arrow}</span><span>${deltaDisplay} <span class="tiny muted">(${pctDisplay})</span></span>`
                  : `<span class="arrow ${tone}">${arrow}</span><span>${deltaDisplay}</span>`;
                node.innerHTML = headerHtml;
              } else if(role === 'detail'){
                const tone = direction === 'up' ? 'positive' : direction === 'down' ? 'negative' : 'neutral';
                node.classList.remove('positive','negative','neutral');
                node.classList.add(tone);
                node.textContent = pctDisplay !== '—' ? `${deltaDisplay} (${pctDisplay})` : deltaDisplay;
              } else {
                node.textContent = deltaDisplay;
              }
            });
          }

          const sparkPoint = row.sparklinePoints?.find(pt => pt.ym === ym);
          if(sparkPoint){
            sparkPoint.value = scenarioValue ?? 0;
          }

          updateTotal();
          if(typeof gridResult.refreshSparklines === 'function'){
            gridResult.refreshSparklines();
          }
        };
        input.addEventListener('input', updateRow);
        updateRow();
      });
      if(typeof gridResult.refreshSparklines === 'function'){
        gridResult.refreshSparklines();
      }
    } else {
      updateTotal();
    }

    if(!eomUiState.pivotMode){
      gridContainer.querySelectorAll('button[data-del]').forEach(btn => {
        btn.onclick = () => {
          const accountId = btn.dataset.del;
          const used = (b().transactions || []).some(t => t.accountId === accountId);
          if(used){ alert('Nie można usunąć: konto ma powiązane transakcje.'); return; }
          if(!confirm('Usunąć konto i powiązane salda EOM?')) return;
          state.modules.budget.accounts = (b().accounts || []).filter(x => x.id !== accountId);
          state.modules.budget.eom = (b().eom || []).filter(e => e.accountId !== accountId);
          save(state);
          renderAll();
        };
      });
      gridContainer.querySelectorAll('button[data-drill]').forEach(btn => {
        btn.onclick = () => {
          eomUiState.focusedAccountId = btn.dataset.drill;
          renderEOMHistory();
        };
      });
    }

    updateTotal();

    const saveBtn = document.getElementById('eom-save');
    if(saveBtn){
      saveBtn.onclick = () => {
        if(eomUiState.pivotMode){
          alert('Widok pivot służy do analizy. Wróć do widoku edycyjnego, aby zapisać zmiany.');
          return;
        }
        const inputs = Array.from(gridContainer.querySelectorAll('input[data-id]'));
        const updateIds = new Set(inputs.map(inp => inp.dataset.id));
        const retained = (b().eom || []).filter(entry => !(entry.ym === ym && updateIds.has(entry.accountId)));
        for(const inp of inputs){
          const raw = inp.value.trim();
          if(!raw) continue;
          const bal = num(raw) || 0;
          retained.push({ ym, accountId: inp.dataset.id, balance: bal });
        }
        state.modules.budget.eom = retained;
        save(state);
        renderEOM();
        renderEOMHistory();
      };
    }

    const copyBtn = document.getElementById('eom-copy-last');
    if(copyBtn){
      copyBtn.onclick = () => {
        if(eomUiState.pivotMode){
          alert('Kopiowanie dostępne jest w widoku edycyjnym.');
          return;
        }
        for(const row of rows){
          const history = ctx.accountHistory[row.acc.id] || [];
          const source = lastEntryBefore(history, ym) || history[history.length - 1];
          if(!source) continue;
          const input = gridContainer.querySelector(`input[data-id="${row.acc.id}"]`);
          if(input){
            input.value = String(source.balance).replace('.',',');
            input.dispatchEvent(new Event('input', { bubbles:true }));
          }
        }
      };
    }

    const resetBtn = document.getElementById('eom-reset-inputs');
    if(resetBtn){
      resetBtn.onclick = () => {
        if(eomUiState.pivotMode){
          alert('Wyczyszczanie pól dostępne jest po wyłączeniu widoku pivot.');
          return;
        }
        gridContainer.querySelectorAll('input[data-id]').forEach(inp => {
          inp.value = '';
          inp.dispatchEvent(new Event('input', { bubbles:true }));
        });
      };
    }

    renderEOMHistory();
  }

  function renderEOMHistory(){
    const ctx = buildEomContext();
    const rangeSelect = document.getElementById('eom-history-range');
    const transposeBtn = document.getElementById('eom-history-transpose');
    const searchInput = document.getElementById('eom-history-search');
    const onlyChangesBox = document.getElementById('eom-history-only-changes');
    const exportBtn = document.getElementById('eom-history-export');

    if(rangeSelect){
      const desired = eomUiState.historyRange || '6';
      if(rangeSelect.value !== desired) rangeSelect.value = desired;
      if(!rangeSelect.dataset.bound){
        rangeSelect.dataset.bound = '1';
        rangeSelect.addEventListener('change', event => {
          eomUiState.historyRange = event.target.value || '6';
          saveEomUiState();
          renderEOMHistory();
        });
      }
    }

    if(searchInput){
      searchInput.value = eomUiState.historySearch || '';
      if(!searchInput.dataset.bound){
        searchInput.dataset.bound = '1';
        searchInput.addEventListener('input', event => {
          eomUiState.historySearch = event.target.value || '';
          saveEomUiState();
          renderEOMHistory();
        });
      }
    }

    if(onlyChangesBox){
      onlyChangesBox.checked = !!eomUiState.historyOnlyChanges;
      if(!onlyChangesBox.dataset.bound){
        onlyChangesBox.dataset.bound = '1';
        onlyChangesBox.addEventListener('change', event => {
          eomUiState.historyOnlyChanges = !!event.target.checked;
          saveEomUiState();
          renderEOMHistory();
        });
      }
    }

    if(transposeBtn){
      transposeBtn.dataset.active = eomUiState.historyTranspose ? '1' : '0';
      transposeBtn.textContent = eomUiState.historyTranspose ? 'Widok standardowy' : 'Transponuj widok';
      if(!transposeBtn.dataset.bound){
        transposeBtn.dataset.bound = '1';
        transposeBtn.addEventListener('click', () => {
          eomUiState.historyTranspose = !eomUiState.historyTranspose;
          if(eomUiState.historyTranspose && eomUiState.historySort?.key === 'ym'){
            eomUiState.historySort = { key:'name', dir:'asc' };
          }
          saveEomUiState();
          renderEOMHistory();
        });
      }
    }

    if(exportBtn && !exportBtn.dataset.bound){
      exportBtn.dataset.bound = '1';
      exportBtn.addEventListener('click', exportEomHistoryCsv);
    }

    const months = ctx.months;
    const rangeMonths = getMonthsWithinRange(months, eomUiState.dateRange);
    const baseMonths = rangeMonths.length ? rangeMonths : months;
    const limitValue = eomUiState.historyRange || '6';
    const monthsToShow = !baseMonths.length
      ? []
      : (limitValue === 'all' ? baseMonths : baseMonths.slice(-Number(limitValue || 6)));

    if(!baseMonths.length){
      renderEomKpis(ctx, []);
      renderEomPerformanceMatrix(ctx, []);
      renderEomHistoryTable(ctx, [], { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
      renderEomMonthlySummary([]);
      renderEomNetWorthChart(ctx, { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
      return;
    }

    const focusCandidate = ctx.focusMonth || ctx.latestMonth || baseMonths[baseMonths.length - 1];
    const focusTarget = baseMonths.includes(focusCandidate) ? focusCandidate : (baseMonths[baseMonths.length - 1]);
    const accountStats = computeAccountStatsForMonth(ctx, focusTarget, { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
    const monthlySummary = computeMonthlySummary(ctx, { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });

    renderEomKpis(ctx, accountStats);
    renderEomPerformanceMatrix(ctx, accountStats);
    renderEomHistoryTable(ctx, monthsToShow, {
      scenario: eomUiState.scenario,
      accountTypes: eomUiState.accountTypes,
      transpose: eomUiState.historyTranspose,
      search: eomUiState.historySearch,
      onlyChanges: eomUiState.historyOnlyChanges,
      sort: eomUiState.historySort,
      totalMonths: baseMonths.length
    });
    renderEomMonthlySummary(monthlySummary.filter(row => monthsToShow.includes(row.ym)), { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
    renderEomNetWorthChart(ctx, { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
  }

  const DAY_MS = 1000*60*60*24;

  function setDefaultDateForAlloc() {
    const dateInput = document.querySelector('#alloc-form input[name="date"]');
    if (dateInput && !dateInput.value) {
        dateInput.value = new Date().toISOString().slice(0, 10);
    }
  }

  function renderAllocSelect(){
    const sel=document.querySelector('#alloc-form select[name="goalId"]'); if(!sel) return;
    sel.innerHTML=''; for(const g of (b().goals||[])){ sel.add(new Option(g.name,g.id)); }
  }

  // --- Analytics Helpers ---
  const ANALYTICS_STATE_KEY='lifeos_budget_filters_v1';
  let analyticsUiState = loadAnalyticsUiState();
  const analyticsCharts={};
  const eomCharts={};
  let eomHistoryExportCache=null;
  const EOM_UI_STATE_KEY='lifeos_budget_eom_ui_v1';
  const DEFAULT_EOM_UI_STATE={
    accountTypes:[],
    dateRange:{ from:null, to:null },
    scenario:'actual',
    groupBy:'type',
    pivotMode:false,
    focusedAccountId:null,
    monthlySort:{field:'ym',dir:'desc'},
    netWorthRange:'6m',
    netWorthFocusMonth:null,
    accountSort:'balance',
    filterPositiveOnly:false,
    filterNegativeOnly:false,
    hideZeroAccounts:false,
    expandedAccounts:[],
    dashboardView:'overview',
    compareMonthA:null,
    compareMonthB:null,
    historyRange:'6',
    historyTranspose:false,
    historySearch:'',
    historyOnlyChanges:false,
    historySort:{ key:'ym', dir:'desc' }
  };

  function loadEomUiState(){
    try{
      const raw=localStorage.getItem(EOM_UI_STATE_KEY);
      if(!raw) return {};
      const parsed=JSON.parse(raw);
      if(!parsed || typeof parsed!=='object') return {};
      return parsed;
    }catch(err){
      console.warn('Nie można odczytać ustawień EOM',err);
      return {};
    }
  }

  function saveEomUiState(){
    try{
      const payload={
        netWorthRange:eomUiState.netWorthRange,
        netWorthFocusMonth:eomUiState.netWorthFocusMonth,
        compareMonthA:eomUiState.compareMonthA,
        compareMonthB:eomUiState.compareMonthB,
        historyRange:eomUiState.historyRange,
        historyTranspose:eomUiState.historyTranspose,
        historySearch:eomUiState.historySearch,
        historyOnlyChanges:eomUiState.historyOnlyChanges,
        historySort:eomUiState.historySort,
        dashboardView:eomUiState.dashboardView
      };
      localStorage.setItem(EOM_UI_STATE_KEY,JSON.stringify(payload));
    }catch(err){
      console.warn('Nie można zapisać ustawień EOM',err);
    }
  }

  let eomUiState={...DEFAULT_EOM_UI_STATE,...loadEomUiState()};
  eomUiState.scenario='actual';
  if(!eomUiState.dateRange){
    eomUiState.dateRange={ from:null, to:null };
  }else{
    eomUiState.dateRange=normalizeYmRange(eomUiState.dateRange);
  }
  const ANALYTICS_COLORS=['#0ea5e9','#ef4444','#16a34a','#f97316','#8b5cf6','#14b8a6','#facc15','#6366f1','#0f172a'];

  function loadAnalyticsUiState(){
    try{
      const raw=localStorage.getItem(ANALYTICS_STATE_KEY);
      if(!raw) return {selectedCategoryIds:[],sortField:'total',sortDir:'desc',searchTerm:'',selectedMonths:null};
      const parsed=JSON.parse(raw);
      return {
        selectedCategoryIds:Array.isArray(parsed?.selectedCategoryIds)?parsed.selectedCategoryIds:[],
        sortField:typeof parsed?.sortField==='string'?parsed.sortField:'total',
        sortDir:parsed?.sortDir==='asc'?'asc':'desc',
        searchTerm:typeof parsed?.searchTerm==='string'?parsed.searchTerm:'',
        selectedMonths:Array.isArray(parsed?.selectedMonths)?parsed.selectedMonths:null
      };
    }catch(err){
      console.warn('Nie można odczytać ustawień analityki',err);
      return {selectedCategoryIds:[],sortField:'total',sortDir:'desc',searchTerm:'',selectedMonths:null};
    }
  }
  function saveAnalyticsUiState(){
    try{localStorage.setItem(ANALYTICS_STATE_KEY,JSON.stringify(analyticsUiState));}catch(err){console.warn('Nie można zapisać ustawień analityki',err);}
  }
  function analyticsExpenseCategories(){
    return (b().categories||[]).filter(c=>c.type==='expense'||c.type==='saving');
  }
  function getActiveAnalyticsCategoryIds(expenseCats=analyticsExpenseCategories()){
    const valid=(analyticsUiState?.selectedCategoryIds||[]).filter(id=>expenseCats.some(c=>c.id===id));
    return valid.length?valid:expenseCats.map(c=>c.id);
  }
  function setAnalyticsSelectedCategories(ids){
    analyticsUiState.selectedCategoryIds=Array.from(new Set(ids));
    saveAnalyticsUiState();
  }
  function setAnalyticsSelectedMonths(months){
    const unique=Array.from(new Set(Array.isArray(months)?months:[])).sort();
    analyticsUiState.selectedMonths=unique;
    saveAnalyticsUiState();
  }
  function getAnalyticsAvailableMonths(){
    const months=new Set();
    (b().transactions||[]).forEach(t=>{if(t?.date) months.add(t.date.slice(0,7));});
    if(b().monthly){
      Object.keys(b().monthly).forEach(ym=>months.add(ym));
    }
    return Array.from(months).sort();
  }
  function defaultAnalyticsMonths(allMonths){
    if(!allMonths.length) return [];
    const current=b().workingMonth;
    if(current && allMonths.includes(current)) return [current];
    return [allMonths[allMonths.length-1]];
  }
  function getAnalyticsSelectedMonths(allMonths){
    const currentRaw=Array.isArray(analyticsUiState.selectedMonths)?analyticsUiState.selectedMonths:[];
    const currentSorted=[...currentRaw].sort();
    let valid=currentRaw.filter(m=>allMonths.includes(m));
    if(valid.length===0 && allMonths.length>0){
      valid=defaultAnalyticsMonths(allMonths);
    }
    const normalized=Array.from(new Set(valid)).sort();
    const changed=normalized.length!==currentSorted.length || normalized.some((m,i)=>m!==currentSorted[i]);
    if(changed){
      analyticsUiState.selectedMonths=normalized;
      saveAnalyticsUiState();
    }
    return normalized;
  }
  function ensureAnalyticsSortDefaults(){
    if(!analyticsUiState.sortField) analyticsUiState.sortField='total';
    if(!['asc','desc'].includes(analyticsUiState.sortDir)) analyticsUiState.sortDir='desc';
  }
  function destroyAnalyticsChart(key){
    if(analyticsCharts[key]){analyticsCharts[key].destroy(); delete analyticsCharts[key];}
  }
  function calcMedian(values){
    if(!values||!values.length) return 0;
    const sorted=[...values].sort((a,b)=>a-b);
    const mid=Math.floor(sorted.length/2);
    return sorted.length%2?sorted[mid]:(sorted[mid-1]+sorted[mid])/2;
  }
  function formatTrend(amount, percent, type){
    if(!amount && !percent) return '<span class="delta-neutral">—</span>';
    const isPositive=amount>0;
    const good=type==='saving';
    const cls=isPositive?(good?'delta-up':'delta-down'):(good?'delta-down':'delta-up');
    const arrow=isPositive?'▲':'▼';
    const pctText=percent?` (${percent>0?'+':''}${percent.toFixed(1)}%)`:'';
    return `<span class="${cls}">${arrow} ${fmt(amount, state.currency)}${pctText}</span>`;
  }
  function formatCountTrend(delta, prevCount, type){
    if(!delta) return '<span class="delta-neutral">—</span>';
    const isPositive=delta>0;
    const good=type==='saving';
    const cls=isPositive?(good?'delta-up':'delta-down'):(good?'delta-down':'delta-up');
    const arrow=isPositive?'▲':'▼';
    const pct=prevCount?Math.abs(delta/prevCount)*100:0;
    const pctText=pct?` (${delta>0?'+':''}${pct.toFixed(0)}%)`:'';
    return `<span class="${cls}">${arrow} ${delta>0?'+':''}${delta}${pctText}</span>`;
  }
  function heatColor(ratio){
    if(!Number.isFinite(ratio)||ratio===0) return 'transparent';
    if(ratio>=1.5) return '#fee2e2';
    if(ratio>=1.15) return '#ffedd5';
    if(ratio>=0.9) return '#f8fafc';
    if(ratio>=0.65) return '#dcfce7';
    return '#dbeafe';
  }
  function withAlpha(hex,alpha){
    const raw=(hex||'').replace('#','');
    if(raw.length!==6){return hex;}
    const r=parseInt(raw.slice(0,2),16);
    const g=parseInt(raw.slice(2,4),16);
    const b=parseInt(raw.slice(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }
  function getVisibleTotal(chart) {
    if (!chart || !chart.getDatasetMeta) return 0;
    const meta = chart.getDatasetMeta(0);
    if (!meta || !meta.data) return 0;
    let visibleTotal = 0;
    for (let i = 0; i < meta.data.length; i++) {
        if (chart.getDataVisibility(i)) {
            visibleTotal += chart.data.datasets[0].data[i];
        }
    }
    return visibleTotal;
  }

  // --- Analytics --------------------------------------------------------------
  function renderAnalyticsMonthPicker(allMonths, selectedMonths){
    const container=document.getElementById('analytics-month-picker');
    const summary=document.getElementById('analytics-month-summary');
    const quick=document.getElementById('analytics-month-quick');
    if(!container) return;

    container.innerHTML='';

    if(!allMonths.length){
      if(summary){
        summary.textContent='Brak danych historycznych. Dodaj transakcje lub przychody, aby rozpocząć analizę.';
      }
      if(quick){ quick.style.display='none'; }
      return;
    }

    if(quick){ quick.style.display='flex'; }

    const selectedSet=new Set(selectedMonths);
    const monthsForDisplay=[...allMonths].sort().reverse();
    monthsForDisplay.forEach(ym=>{
      const chip=document.createElement('button');
      chip.type='button';
      chip.className='analytics-month-chip'+(selectedSet.has(ym)?' active':'');
      chip.textContent=ym;
      chip.onclick=()=>{
        const current=getAnalyticsSelectedMonths(allMonths);
        const next=new Set(current);
        if(next.has(ym)){
          if(next.size===1) return;
          next.delete(ym);
        }else{
          next.add(ym);
        }
        setAnalyticsSelectedMonths(Array.from(next));
        renderAnalytics();
      };
      container.appendChild(chip);
    });

    if(summary){
      if(selectedMonths.length<=1){
        const ym=selectedMonths[0]||'—';
        summary.textContent=`Wybrany miesiąc: ${ym}. Dodaj kolejne, aby zobaczyć porównania.`;
      }else{
        const first=selectedMonths[0];
        const last=selectedMonths[selectedMonths.length-1];
        const prev=selectedMonths[selectedMonths.length-2];
        summary.textContent=`Wybrane miesiące: ${selectedMonths.length} (${first} → ${last}). Porównania MoM: ${last} vs ${prev}.`;
      }
    }

    if(quick){
      quick.querySelectorAll('button[data-range]').forEach(btn=>{
        btn.onclick=()=>{
          const range=btn.dataset.range;
          let selection=[];
          switch(range){
            case 'current':{
              const current=b().workingMonth;
              if(current && allMonths.includes(current)) selection=[current];
              else selection=defaultAnalyticsMonths(allMonths);
              break;
            }
            case 'last3':
              selection=allMonths.slice(-3);
              break;
            case 'last6':
              selection=allMonths.slice(-6);
              break;
            case 'year':{
              const workingYear=(b().workingMonth||'').slice(0,4);
              if(workingYear){ selection=allMonths.filter(m=>m.startsWith(workingYear)); }
              if(!selection.length){
                const nowYear=String(new Date().getFullYear());
                selection=allMonths.filter(m=>m.startsWith(nowYear));
              }
              if(!selection.length){ selection=allMonths.slice(-12); }
              break;
            }
            case 'all':
              selection=[...allMonths];
              break;
            default:
              selection=defaultAnalyticsMonths(allMonths);
          }
          if(!selection.length){ selection=defaultAnalyticsMonths(allMonths); }
          setAnalyticsSelectedMonths(selection);
          renderAnalytics();
        };
      });
    }
  }

  function renderAnalyticsFilterPanel(expenseCats, categoryStats, totalExpense) {
    const list = document.getElementById('analytics-category-filter-list');
    const searchInput = document.getElementById('analytics-category-search');
    const summary = document.getElementById('analytics-filter-summary');
    if(!list || !searchInput || !summary) return;

    const selectedIds = getActiveAnalyticsCategoryIds(expenseCats);
    const searchTerm = (analyticsUiState.searchTerm||'').toLowerCase();
    searchInput.value = analyticsUiState.searchTerm || '';

    const buttons = {
      all: document.getElementById('analytics-select-all'),
      none: document.getElementById('analytics-select-none'),
      expense: document.getElementById('analytics-select-expense'),
      savings: document.getElementById('analytics-select-savings'),
      top5: document.getElementById('analytics-select-top5')
    };

    if(buttons.all){
      buttons.all.onclick=()=>{setAnalyticsSelectedCategories(expenseCats.map(c=>c.id)); renderAnalytics();};
    }
    if(buttons.none){
      buttons.none.onclick=()=>{setAnalyticsSelectedCategories([]); renderAnalytics();};
    }
    if(buttons.expense){
      buttons.expense.onclick=()=>{setAnalyticsSelectedCategories(expenseCats.filter(c=>c.type==='expense').map(c=>c.id)); renderAnalytics();};
    }
    if(buttons.savings){
      buttons.savings.onclick=()=>{setAnalyticsSelectedCategories(expenseCats.filter(c=>c.type==='saving').map(c=>c.id)); renderAnalytics();};
    }
    if(buttons.top5){
      buttons.top5.onclick=()=>{
        const sorted=[...expenseCats].sort((a,b)=>{
          const at=categoryStats[a.id]?.total||0;
          const bt=categoryStats[b.id]?.total||0;
          return bt-at;
        });
        setAnalyticsSelectedCategories(sorted.slice(0,5).map(c=>c.id));
        renderAnalytics();
      };
    }

    searchInput.oninput = (e)=>{
      analyticsUiState.searchTerm = e.target.value;
      saveAnalyticsUiState();
      renderAnalyticsFilterPanel(expenseCats, categoryStats, totalExpense);
    };

    const sortedCats=[...expenseCats].sort((a,b)=>{
      const at=categoryStats[a.id]?.total||0;
      const bt=categoryStats[b.id]?.total||0;
      return bt-at;
    });

    list.innerHTML='';
    for(const cat of sortedCats){
      const label=`${cat.emoji||''} ${cat.name}`.trim();
      if(searchTerm && !label.toLowerCase().includes(searchTerm)) continue;
      const wrapper=document.createElement('label');
      wrapper.className='analytics-filter-grid-label'+(selectedIds.includes(cat.id)?' active':'');
      wrapper.classList.add('tiny');
      wrapper.innerHTML=`<input type="checkbox" class="analytics-cat-filter-cb" value="${cat.id}" ${selectedIds.includes(cat.id)?'checked':''}> <span>${cat.emoji||''} ${cat.name}</span><span class="tiny muted" style="justify-content:flex-end;">${fmt(categoryStats[cat.id]?.total||0, state.currency)}</span>`;
      const checkbox=wrapper.querySelector('input');
      checkbox.onchange=()=>{
        const next=new Set(selectedIds);
        if(checkbox.checked) next.add(cat.id); else next.delete(cat.id);
        setAnalyticsSelectedCategories(Array.from(next));
        renderAnalytics();
      };
      list.appendChild(wrapper);
    }

    const selectedTotalAmount = selectedIds.reduce((s,id)=>s+(categoryStats[id]?.total||0),0);
    const share = totalExpense>0 ? (selectedTotalAmount/totalExpense)*100 : 0;
    const other = totalExpense - selectedTotalAmount;
    summary.textContent = `Wybrane ${selectedIds.length} z ${expenseCats.length} kategorii • ${fmt(selectedTotalAmount, state.currency)} (${share.toFixed(1)}% wydatków) • Pozostałe: ${fmt(other, state.currency)}`;
  }

  function renderAnalyticsKpis(ctx) {
    const container = document.getElementById('analytics-kpis');
    if(!container) return;
    const {
      totalIncome,
      totalExpenseAll,
      netChange,
      avgSavingsRate,
      totalSelectedExpense,
      totalSelectedCount,
      selectedAvg,
      selectedMedian,
      selectedShare,
      monthsCount,
      lastMonthSummary,
      prevMonthSummary,
      lastVsPrevAmount,
      lastVsPrevPercent,
      lastCountDelta,
      avgDelta,
      avgDeltaPct,
      selectedMood,
      largestCategory,
      selectedTypeTotals
    } = ctx;

    const avgPerMonth = monthsCount ? totalSelectedExpense / monthsCount : 0;
    const countPerMonth = monthsCount ? totalSelectedCount / monthsCount : 0;
    const largestName = largestCategory ? `${largestCategory.category?.emoji||''} ${largestCategory.category?.name||'—'}`.trim() : '—';
    const largestShare = largestCategory && totalSelectedExpense > 0 ? (largestCategory.total / totalSelectedExpense) * 100 : 0;
    const largestAvg = largestCategory && largestCategory.count ? largestCategory.total / largestCategory.count : 0;
    const totalSelectedStructure = (selectedTypeTotals?.expense || 0) + (selectedTypeTotals?.saving || 0);
    const savingsShare = totalSelectedStructure > 0 ? (selectedTypeTotals.saving / totalSelectedStructure) * 100 : 0;
    const expenseShare = totalSelectedStructure > 0 ? (selectedTypeTotals.expense / totalSelectedStructure) * 100 : 0;

    let html = `
      <div class="stat-card"><div class="muted">Całkowity przychód</div><div class="big-number ok">${fmt(totalIncome, state.currency)}</div><div class="trend">Śr. ${fmt(totalIncome / (monthsCount || 1), state.currency)} / miesiąc</div></div>
      <div class="stat-card"><div class="muted">Całkowite wydatki</div><div class="big-number bad">${fmt(totalExpenseAll, state.currency)}</div><div class="trend">Śr. ${fmt(totalExpenseAll / (monthsCount || 1), state.currency)} / miesiąc</div></div>
      <div class="stat-card"><div class="muted">Bilans (Netto)</div><div class="big-number ${netChange >= 0 ? 'ok' : 'bad'}">${fmt(netChange, state.currency)}</div><div class="trend">Stopa oszczędności: ${avgSavingsRate.toFixed(1)}%</div></div>
      <div class="stat-card"><div class="muted">Wydatki (wybrane)</div><div class="big-number ${selectedMood === 'saving' ? 'ok' : 'bad'}">${fmt(totalSelectedExpense, state.currency)}</div><div class="trend">Śr. ${fmt(avgPerMonth, state.currency)} / mies.</div></div>
      <div class="stat-card"><div class="muted">Transakcji (wybrane)</div><div class="big-number">${totalSelectedCount}</div><div class="trend">~${countPerMonth.toFixed(1)} / miesiąc</div></div>
      <div class="stat-card"><div class="muted">Średnia vs mediana</div><div class="big-number">${fmt(selectedAvg, state.currency)}</div><div class="trend">Mediana: ${fmt(selectedMedian, state.currency)}</div></div>
      <div class="stat-card"><div class="muted">Udział wybranych</div><div class="big-number">${selectedShare.toFixed(1)}%</div><div class="trend">Pozostałe: ${fmt(totalExpenseAll - totalSelectedExpense, state.currency)}</div></div>
      <div class="stat-card"><div class="muted">Dynamika ${lastMonthSummary?.ym || ''}</div><div class="big-number">${fmt(lastMonthSummary?.selectedTotal || 0, state.currency)}</div><div class="trend">Suma: ${formatTrend(lastVsPrevAmount, lastVsPrevPercent, selectedMood)}<br>Liczba: ${formatCountTrend(lastCountDelta, prevMonthSummary?.selectedCount || 0, selectedMood)}<br>Średnia: ${formatTrend(avgDelta, avgDeltaPct, selectedMood)}</div></div>
      <div class="stat-card"><div class="muted">Top kategoria</div><div class="big-number">${largestName}</div><div class="trend">${largestCategory ? `${fmt(largestCategory.total, state.currency)} (${largestShare.toFixed(1)}%) • ${largestCategory.count} × ${fmt(largestAvg, state.currency)}` : 'Brak danych'}</div></div>
    `;

    if(totalSelectedStructure > 0){
      html += `<div class="stat-card"><div class="muted">Struktura wybranych</div><div class="big-number">${fmt(totalSelectedExpense, state.currency)}</div><div class="trend"><span class="insight-pill">Wydatki: ${expenseShare.toFixed(1)}%</span><span class="insight-pill">Oszczędności: ${savingsShare.toFixed(1)}%</span></div></div>`;
    }

    container.innerHTML = html;
  }

  function renderAnalytics(){
    const allMonths=getAnalyticsAvailableMonths();
    const selectedMonths=getAnalyticsSelectedMonths(allMonths);
    renderAnalyticsMonthPicker(allMonths, selectedMonths);

    ensureAnalyticsSortDefaults();
    const expenseCats=analyticsExpenseCategories();

    if(selectedMonths.length===0){
      const emptyStats={};
      for(const cat of expenseCats){
        emptyStats[cat.id]={
          category:cat,
          total:0,
          count:0,
          values:[],
          months:{},
          max:{amount:0,date:''},
          min:{amount:0,date:''}
        };
      }
      renderAnalyticsFilterPanel(expenseCats, emptyStats, 0);
      const message=allMonths.length? 'Wybierz miesiące, aby zobaczyć analizy.' : 'Brak danych historycznych do analizy.';
      const kpiBox=document.getElementById('analytics-kpis');
      if(kpiBox){kpiBox.innerHTML=`<p class='muted' style='grid-column:1 / -1; text-align:center;'>${message}</p>`;}
      const placeholder=`<tbody><tr><td class='muted' style='text-align:center;'>${message}</td></tr></tbody>`;
      ['analytics-category-summary','analytics-category-momentum','analytics-monthly-breakdown','analytics-top-transactions'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.innerHTML=placeholder;
      });
      const matrix=document.getElementById('analytics-category-trends');
      if(matrix) matrix.innerHTML=placeholder;
      ['incomeExpense','categoryShare','monthlyActivity','avgTrend','categoryLeader','categoryTrend'].forEach(key=>destroyAnalyticsChart(key));
      return;
    }

    const monthsToAnalyze=selectedMonths;
    const monthsSet=new Set(monthsToAnalyze);
    const selectedCatIds=getActiveAnalyticsCategoryIds(expenseCats);
    const selectedCatSet=new Set(selectedCatIds);
    const catsMap=catsById();

    const allEntriesInPeriod=b().transactions.filter(t=>monthsSet.has(t.date.slice(0,7)));

    const categoryStats={};
    const monthlySummaries=[];
    let totalIncome=0;
    let totalExpenseAll=0;
    let totalSelectedExpense=0;
    let totalSelectedCount=0;
    let totalEntriesAll=0;
    const selectedAmounts=[];

    monthsToAnalyze.forEach(ym=>{
      ensureMonth(ym);
      const monthIncome=b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
      totalIncome+=monthIncome;

      const monthEntries=entriesForMonth(ym);
      let monthExpense=0;
      let monthSelectedTotal=0;
      let monthSelectedCount=0;
      const monthSelectedValues=[];
      const byCategory={};

      monthEntries.forEach(e=>{
        const cat=catsMap[e.categoryId];
        if(!cat || (cat.type!=='expense' && cat.type!=='saving')) return;
        const amount=Math.abs(e.amount);
        monthExpense+=amount;
        totalExpenseAll+=amount;
        totalEntriesAll+=1;

        let stat=categoryStats[cat.id];
        if(!stat){
          stat=categoryStats[cat.id]={
            category:cat,
            total:0,
            count:0,
            values:[],
            months:{},
            max:{amount:0,date:''},
            min:{amount:Infinity,date:''}
          };
        }
        stat.total+=amount;
        stat.count+=1;
        stat.values.push(amount);
        if(!stat.months[ym]) stat.months[ym]={total:0,count:0,values:[]};
        stat.months[ym].total+=amount;
        stat.months[ym].count+=1;
        stat.months[ym].values.push(amount);
        if(amount>stat.max.amount) stat.max={amount,date:e.date};
        if(amount<stat.min.amount) stat.min={amount,date:e.date};

        if(!byCategory[cat.id]) byCategory[cat.id]={total:0,count:0,values:[]};
        byCategory[cat.id].total+=amount;
        byCategory[cat.id].count+=1;
        byCategory[cat.id].values.push(amount);

        if(selectedCatSet.has(cat.id)){
          monthSelectedTotal+=amount;
          monthSelectedCount+=1;
          totalSelectedExpense+=amount;
          totalSelectedCount+=1;
          selectedAmounts.push(amount);
          monthSelectedValues.push(amount);
        }
      });

      monthlySummaries.push({
        ym,
        incomes:monthIncome,
        expenses:monthExpense,
        selectedTotal:monthSelectedTotal,
        selectedCount:monthSelectedCount,
        selectedAvg:monthSelectedCount ? monthSelectedTotal/monthSelectedCount : 0,
        selectedMedian:calcMedian(monthSelectedValues),
        byCategory
      });
    });

    expenseCats.forEach(cat=>{
      if(!categoryStats[cat.id]){
        categoryStats[cat.id]={
          category:cat,
          total:0,
          count:0,
          values:[],
          months:{},
          max:{amount:0,date:''},
          min:{amount:0,date:''}
        };
      }else if(categoryStats[cat.id].min.amount===Infinity){
        categoryStats[cat.id].min={amount:0,date:''};
      }
    });

    const monthsCount=monthsToAnalyze.length;
    const netChange=totalIncome-totalExpenseAll;
    const avgSavingsRate=totalIncome>0?(netChange/totalIncome)*100:0;
    const selectedAvg=totalSelectedCount?totalSelectedExpense/totalSelectedCount:0;
    const selectedMedian=calcMedian(selectedAmounts);
    const selectedShare=totalExpenseAll>0?(totalSelectedExpense/totalExpenseAll)*100:0;
    const lastMonthSummary=monthlySummaries[monthlySummaries.length-1];
    const prevMonthSummary=monthlySummaries.length>=2?monthlySummaries[monthlySummaries.length-2]:null;
    const lastVsPrevAmount=prevMonthSummary?lastMonthSummary.selectedTotal-prevMonthSummary.selectedTotal:0;
    const lastVsPrevPercent=(prevMonthSummary && prevMonthSummary.selectedTotal>0)
      ?(lastVsPrevAmount/prevMonthSummary.selectedTotal)*100
      :0;
    const lastCountDelta=prevMonthSummary?lastMonthSummary.selectedCount-prevMonthSummary.selectedCount:0;
    const lastAvg=lastMonthSummary.selectedCount?lastMonthSummary.selectedTotal/lastMonthSummary.selectedCount:0;
    const prevAvg=prevMonthSummary && prevMonthSummary.selectedCount?prevMonthSummary.selectedTotal/prevMonthSummary.selectedCount:0;
    const avgDelta=lastAvg-prevAvg;
    const avgDeltaPct=prevAvg?(avgDelta/prevAvg)*100:0;
    const selectedTypeTotals=selectedCatIds.reduce((acc,id)=>{
      const cat=categoryStats[id]?.category;
      if(!cat) return acc;
      acc[cat.type]=(acc[cat.type]||0)+(categoryStats[id]?.total||0);
      return acc;
    },{expense:0,saving:0});
    const selectedMood=selectedTypeTotals.saving>selectedTypeTotals.expense?'saving':'expense';
    const largestCategory=selectedCatIds
      .map(id=>categoryStats[id])
      .filter(Boolean)
      .sort((a,b)=>(b?.total||0)-(a?.total||0))[0]||null;

    const analyticsContext={
      months:monthsToAnalyze,
      monthlySummaries,
      categoryStats,
      selectedCatIds,
      totalSelectedExpense,
      totalSelectedCount,
      selectedAvg,
      selectedMedian,
      selectedShare,
      totalExpenseAll,
      totalIncome,
      netChange,
      avgSavingsRate,
      monthsCount,
      lastMonthSummary,
      prevMonthSummary,
      lastVsPrevAmount,
      lastVsPrevPercent,
      lastCountDelta,
      avgDelta,
      avgDeltaPct,
      selectedMood,
      largestCategory,
      allEntriesInPeriod,
      totalEntriesAll,
      selectedTypeTotals
    };

    renderAnalyticsFilterPanel(expenseCats, categoryStats, totalExpenseAll);

    renderAnalyticsKpis(analyticsContext);
    renderAnalyticsIncomeExpenseChart(monthlySummaries);
    renderAnalyticsCategoryChart(categoryStats, selectedCatIds);
    renderAnalyticsMonthlyActivityChart(monthlySummaries, analyticsContext);
    renderAnalyticsAverageTrendChart(monthlySummaries);
    renderAnalyticsCategoryLeaderChart(categoryStats, selectedCatIds);
    renderAnalyticsCategoryTrendChart(monthsToAnalyze, categoryStats, selectedCatIds);
    renderAnalyticsCategoryTrends(monthsToAnalyze, categoryStats, selectedCatIds);
    renderAnalyticsCategorySummary(analyticsContext);
    renderAnalyticsMomentumTable(analyticsContext);
    renderAnalyticsMonthlyBreakdown(analyticsContext);
    renderAnalyticsTopTransactions(analyticsContext);
  }
  function renderAnalyticsIncomeExpenseChart(monthlySummaries) {
    const canvas = document.getElementById('analytics-income-expense-chart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    destroyAnalyticsChart('incomeExpense');

    const labels = monthlySummaries.map(m => m.ym);
    const incomes = monthlySummaries.map(m => m.incomes);
    const expenses = monthlySummaries.map(m => m.expenses);
    const selected = monthlySummaries.map(m => m.selectedTotal);

    analyticsCharts.incomeExpense = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'Przychody', data: incomes, backgroundColor: 'rgba(5,150,105,0.7)', order: 2 },
                { label: 'Wydatki (wszystkie)', data: expenses, backgroundColor: 'rgba(190,18,60,0.6)', order: 1 },
                { type: 'line', label: 'Wydatki (wybrane)', data: selected, borderColor: '#0f172a', backgroundColor: 'rgba(15,23,42,0.12)', borderWidth: 2, tension: 0.3, fill: false, order: 0 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { callback: currencyTicks } }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: context => `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}`
                    }
                }
            }
        }
    });
  }

  function renderAnalyticsCategoryChart(categoryStats, selectedCatIds) {
      const canvas = document.getElementById('analytics-category-chart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      destroyAnalyticsChart('categoryShare');

      const stats = selectedCatIds.map(id => categoryStats[id]).filter(Boolean).sort((a,b) => (b?.total||0) - (a?.total||0));
      const labels = stats.map(stat => `${stat.category?.emoji||''} ${stat.category?.name||'—'}`.trim());
      const data = stats.map(stat => stat.total);

      analyticsCharts.categoryShare = new Chart(ctx,{
          type:'doughnut',
          data:{
              labels,
              datasets:[{
                  data,
                  backgroundColor: labels.map((_,i)=>ANALYTICS_COLORS[i % ANALYTICS_COLORS.length])
              }]
          },
          options:{
              responsive:true,
              maintainAspectRatio:false,
              plugins:{
                  tooltip:{
                      callbacks:{
                          label:function(context){
                              const chart=context.chart;
                              const visibleTotal=getVisibleTotal(chart);
                              const value=context.raw;
                              const percentage=visibleTotal>0?((value/visibleTotal)*100).toFixed(1)+'%':'0%';
                              return `${context.label}: ${fmt(value, state.currency)} (${percentage})`;
                          }
                      }
                  },
                  legend:{
                      position:'top',
                      labels:{
                          generateLabels:function(chart){
                              const data=chart.data;
                              if(data.labels.length && data.datasets.length){
                                  const visibleTotal=getVisibleTotal(chart);
                                  return data.labels.map((label,i)=>{
                                      const meta=chart.getDatasetMeta(0);
                                      const style=meta.controller.getStyle(i);
                                      const value=data.datasets[0].data[i];
                                      const hidden=!chart.getDataVisibility(i);
                                      const percentage=!hidden && visibleTotal>0?((value/visibleTotal)*100).toFixed(1)+'%':'0%';
                                      return {
                                          text:`${label} (${!hidden ? percentage : 'ukryte'})`,
                                          fillStyle:style.backgroundColor,
                                          strokeStyle:style.borderColor,
                                          lineWidth:style.borderWidth,
                                          hidden:hidden,
                                          index:i
                                      };
                                  });
                              }
                              return [];
                          }
                      }
                  }
              }
          }
      });
  }
  
  function renderAnalyticsMonthlyActivityChart(monthlySummaries, ctx) {
    const canvas = document.getElementById('analytics-monthly-activity-chart');
    if(!canvas) return;
    const chartCtx = canvas.getContext('2d');
    destroyAnalyticsChart('monthlyActivity');

    const labels = monthlySummaries.map(m => m.ym);
    const totals = monthlySummaries.map(m => m.selectedTotal);
    const counts = monthlySummaries.map(m => m.selectedCount);
    const averages = monthlySummaries.map(m => m.selectedAvg);
    const barColor = ctx?.selectedMood === 'saving' ? 'rgba(5,150,105,0.65)' : 'rgba(190,18,60,0.65)';

    analyticsCharts.monthlyActivity = new Chart(chartCtx, {
        data: {
            labels,
            datasets: [
                { type:'bar', label:'Suma wydatków (wybrane)', data: totals, backgroundColor: barColor, borderRadius:6, yAxisID:'y' },
                { type:'line', label:'Liczba transakcji', data: counts, borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,0.15)', borderWidth:2, tension:0.3, yAxisID:'y1', fill:false },
                { type:'line', label:'Średnia kwota', data: averages, borderColor:'#0f172a', backgroundColor:'rgba(15,23,42,0.1)', borderDash:[6,4], tension:0.3, yAxisID:'y' }
            ]
        },
        options: {
            responsive:true,
            maintainAspectRatio:false,
            scales: {
                y: { beginAtZero:true, ticks:{ callback: currencyTicks } },
                y1: { beginAtZero:true, position:'right', grid:{ drawOnChartArea:false }, ticks:{ precision:0 } }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: context => {
                            if(context.dataset.label === 'Liczba transakcji'){
                                return `${context.dataset.label}: ${context.parsed.y}`;
                            }
                            return `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}`;
                        }
                    }
                }
            }
        }
    });
  }

  function renderAnalyticsAverageTrendChart(monthlySummaries) {
    const canvas = document.getElementById('analytics-avg-trend-chart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    destroyAnalyticsChart('avgTrend');

    const labels = monthlySummaries.map(m => m.ym);
    const averages = monthlySummaries.map(m => m.selectedAvg);
    const medians = monthlySummaries.map(m => m.selectedMedian);

    analyticsCharts.avgTrend = new Chart(ctx, {
        type:'line',
        data:{
            labels,
            datasets:[
                { label:'Średnia kwota', data: averages, borderColor:'#0f172a', backgroundColor:'rgba(15,23,42,0.12)', borderWidth:2, tension:0.3, fill:false },
                { label:'Mediana', data: medians, borderColor:'#8b5cf6', backgroundColor:'rgba(139,92,246,0.15)', borderWidth:2, tension:0.3, fill:false }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{ y:{ beginAtZero:true, ticks:{ callback: currencyTicks } } },
            plugins:{ tooltip:{ callbacks:{ label: context => `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}` } } }
        }
    });
  }

  function renderAnalyticsCategoryLeaderChart(categoryStats, selectedCatIds) {
    const canvas = document.getElementById('analytics-category-leader-chart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    destroyAnalyticsChart('categoryLeader');

    const stats = selectedCatIds.map(id => categoryStats[id]).filter(Boolean).sort((a,b)=> (b?.total||0)-(a?.total||0)).slice(0,6);
    const labels = stats.map(stat => `${stat.category?.emoji||''} ${stat.category?.name||'—'}`.trim());
    const totals = stats.map(stat => stat.total);
    const counts = stats.map(stat => stat.count);
    const averages = stats.map(stat => stat.count ? stat.total / stat.count : 0);

    analyticsCharts.categoryLeader = new Chart(ctx,{
        data:{
            labels,
            datasets:[
                { type:'bar', label:'Suma', data: totals, backgroundColor:'rgba(190,18,60,0.6)', yAxisID:'y', borderRadius:6 },
                { type:'bar', label:'Liczba transakcji', data: counts, backgroundColor:'rgba(14,165,233,0.35)', yAxisID:'y1', borderRadius:6 },
                { type:'line', label:'Średnia kwota', data: averages, borderColor:'#0f172a', backgroundColor:'rgba(15,23,42,0.1)', yAxisID:'y', borderWidth:2, tension:0.3, fill:false }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{
                y:{ beginAtZero:true, ticks:{ callback: currencyTicks } },
                y1:{ beginAtZero:true, position:'right', grid:{ drawOnChartArea:false }, ticks:{ precision:0 } }
            },
            plugins:{
                tooltip:{
                    callbacks:{
                        label: context => context.dataset.label === 'Liczba transakcji'
                            ? `${context.dataset.label}: ${context.parsed.y}`
                            : `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}`
                    }
                }
            }
        }
    });
  }

  function renderAnalyticsCategoryTrendChart(months, categoryStats, selectedCatIds) {
    const canvas = document.getElementById('analytics-category-trend-chart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    destroyAnalyticsChart('categoryTrend');

    const stats = selectedCatIds.map(id => categoryStats[id]).filter(Boolean).sort((a,b)=> (b?.total||0)-(a?.total||0)).slice(0,5);
    const datasets = stats.map((stat,idx)=>({
        label: `${stat.category?.emoji||''} ${stat.category?.name||'—'}`.trim(),
        data: months.map(ym => stat.months[ym]?.total || 0),
        borderColor: ANALYTICS_COLORS[idx % ANALYTICS_COLORS.length],
        backgroundColor: withAlpha(ANALYTICS_COLORS[idx % ANALYTICS_COLORS.length], 0.18),
        tension: 0.3,
        fill: false,
        borderWidth: 2
    }));

    analyticsCharts.categoryTrend = new Chart(ctx,{
        type:'line',
        data:{ labels: months, datasets },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{ y:{ beginAtZero:true, ticks:{ callback: currencyTicks } } },
            plugins:{ tooltip:{ callbacks:{ label: context => `${context.dataset.label}: ${fmt(context.parsed.y, state.currency)}` } } }
        }
    });
  }

  function renderAnalyticsCategoryTrends(months, categoryStats, selectedCatIds) {
    const table = document.getElementById('analytics-category-trends');
    if(!table) return;
    const rows = selectedCatIds.map(id => categoryStats[id]).filter(Boolean);
    if(rows.length === 0){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="${months.length+1}">Brak danych dla wybranych kategorii.</td></tr></tbody>`;
        return;
    }

    let header = '<thead><tr><th>Kategoria</th>';
    months.forEach(ym => header += `<th>${ym}</th>`);
    header += '</tr></thead>';

    let body = '<tbody>';
    rows.forEach(stat => {
        const cat = stat.category;
        const avgPerMonth = stat.total / (months.length || 1);
        body += `<tr><td>${cat?.emoji||''} ${cat?.name||'—'}</td>`;
        months.forEach(ym => {
            const monthData = stat.months[ym] || { total:0, count:0, values:[] };
            const avg = monthData.count ? monthData.total / monthData.count : 0;
            const ratio = avgPerMonth ? monthData.total / avgPerMonth : 0;
            const bg = heatColor(ratio);
            if(monthData.total > 0){
                body += `<td style="background:${bg}">${fmt(monthData.total, state.currency)}<br><span class="tiny muted">${monthData.count} × ${fmt(avg, state.currency)}</span></td>`;
            } else {
                body += `<td style="background:${bg}"><span class="muted">—</span></td>`;
            }
        });
        body += '</tr>';
    });
    body += '</tbody>';

    table.innerHTML = header + body;
  }

  function renderAnalyticsCategorySummary(ctx) {
    const table = document.getElementById('analytics-category-summary');
    if(!table) return;
    const { categoryStats, selectedCatIds, totalSelectedExpense, selectedMood, lastMonthSummary, prevMonthSummary } = ctx;
    const rows = selectedCatIds.map(id => categoryStats[id]).filter(Boolean).map(stat => {
        const cat = stat.category;
        const label = `${cat?.emoji||''} ${cat?.name||'—'}`.trim();
        const avg = stat.count ? stat.total / stat.count : 0;
        const median = calcMedian(stat.values);
        const share = totalSelectedExpense > 0 ? (stat.total / totalSelectedExpense) * 100 : 0;
        const lastYm = lastMonthSummary?.ym;
        const prevYm = prevMonthSummary?.ym;
        const lastData = lastYm ? (stat.months[lastYm] || { total:0, count:0, values:[] }) : { total:0, count:0, values:[] };
        const prevData = prevYm ? (stat.months[prevYm] || { total:0, count:0, values:[] }) : null;
        const deltaAmount = prevData ? lastData.total - prevData.total : lastData.total;
        const deltaPercent = prevData && prevData.total > 0 ? (deltaAmount / prevData.total) * 100 : 0;
        const countDelta = prevData ? lastData.count - prevData.count : lastData.count;
        const avgLast = lastData.count ? lastData.total / lastData.count : 0;
        const avgPrev = prevData && prevData.count ? prevData.total / prevData.count : 0;
        const avgDelta = avgLast - avgPrev;
        const avgDeltaPercent = avgPrev ? (avgDelta / avgPrev) * 100 : 0;
        const maxAmount = stat.max?.amount || 0;
        const maxDate = stat.max?.date || '';
        return {
            label,
            total: stat.total,
            count: stat.count,
            avg,
            median,
            share,
            deltaAmount,
            deltaPercent,
            countDelta,
            prevCount: prevData?.count || 0,
            avgDelta,
            avgDeltaPercent,
            maxAmount,
            maxDate,
            type: cat?.type || selectedMood
        };
    });

    if(rows.length === 0){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="10">Brak danych dla wybranych kategorii.</td></tr></tbody>`;
        return;
    }

    ensureAnalyticsSortDefaults();
    const sortKey = analyticsUiState.sortField || 'total';
    const sortDir = analyticsUiState.sortDir === 'asc' ? 1 : -1;
    rows.sort((a,b) => {
        if(sortKey === 'label'){
            return a.label.localeCompare(b.label,'pl',{sensitivity:'base'}) * sortDir;
        }
        const av = Number(a[sortKey] || 0);
        const bv = Number(b[sortKey] || 0);
        if(av === bv){
            return a.label.localeCompare(b.label,'pl',{sensitivity:'base'});
        }
        return (av - bv) * sortDir;
    });

    const columns = [
        { label:'Kategoria', sortKey:'label', formatter: row => row.label },
        { label:`Suma (${state.currency})`, sortKey:'total', formatter: row => fmt(row.total, state.currency) },
        { label:'Liczba', sortKey:'count', formatter: row => row.count },
        { label:'Średnia', sortKey:'avg', formatter: row => fmt(row.avg, state.currency) },
        { label:'Mediana', sortKey:'median', formatter: row => fmt(row.median, state.currency) },
        { label:'Udział', sortKey:'share', formatter: row => `${row.share.toFixed(1)}%` },
        { label:'Zmiana m/m', sortKey:'deltaAmount', formatter: row => formatTrend(row.deltaAmount, row.deltaPercent, row.type) },
        { label:'Δ liczby', sortKey:'countDelta', formatter: row => formatCountTrend(row.countDelta, row.prevCount, row.type) },
        { label:'Δ średniej', sortKey:'avgDelta', formatter: row => formatTrend(row.avgDelta, row.avgDeltaPercent, row.type) },
        { label:'Największa transakcja', sortKey:'maxAmount', formatter: row => row.maxAmount ? `${fmt(row.maxAmount, state.currency)}${row.maxDate ? `<br><span class="tiny muted">${row.maxDate}</span>` : ''}` : '<span class="muted">—</span>' }
    ];

    let header = '<thead><tr>';
    columns.forEach(col => {
        const active = analyticsUiState.sortField === col.sortKey;
        const indicator = active ? `<span class="sort-indicator">${analyticsUiState.sortDir === 'asc' ? '▲' : '▼'}</span>` : '';
        header += `<th${col.sortKey ? ` data-sort="${col.sortKey}"` : ''}>${col.label}${indicator}</th>`;
    });
    header += '</tr></thead>';

    let body = '<tbody>';
    rows.forEach(row => {
        body += '<tr>' + columns.map(col => `<td>${col.formatter(row)}</td>`).join('') + '</tr>';
    });
    body += '</tbody>';

    table.innerHTML = header + body;

    table.querySelectorAll('th[data-sort]').forEach(th => {
        const key = th.dataset.sort;
        th.onclick = () => {
            if(analyticsUiState.sortField === key){
                analyticsUiState.sortDir = analyticsUiState.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                analyticsUiState.sortField = key;
                analyticsUiState.sortDir = key === 'label' ? 'asc' : 'desc';
            }
            saveAnalyticsUiState();
            renderAnalyticsCategorySummary(ctx);
        };
    });
  }

  function renderAnalyticsMomentumTable(ctx) {
    const table = document.getElementById('analytics-category-momentum');
    if(!table) return;
    const { categoryStats, selectedCatIds, lastMonthSummary, prevMonthSummary, selectedMood } = ctx;
    if(!lastMonthSummary){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="7">Wybierz okres obejmujący co najmniej jeden miesiąc.</td></tr></tbody>`;
        return;
    }

    const lastYm = lastMonthSummary.ym;
    const prevYm = prevMonthSummary?.ym;
    const rows = selectedCatIds.map(id => {
        const stat = categoryStats[id];
        if(!stat) return null;
        const cat = stat.category;
        const lastData = stat.months[lastYm] || { total:0, count:0, values:[] };
        const prevData = prevYm ? (stat.months[prevYm] || { total:0, count:0, values:[] }) : null;
        const avgLast = lastData.count ? lastData.total / lastData.count : 0;
        const avgPrev = prevData && prevData.count ? prevData.total / prevData.count : 0;
        const deltaAmount = prevData ? lastData.total - prevData.total : lastData.total;
        const deltaPercent = prevData && prevData.total > 0 ? (deltaAmount / prevData.total) * 100 : 0;
        const countDelta = prevData ? lastData.count - prevData.count : lastData.count;
        const avgDelta = avgLast - avgPrev;
        const avgDeltaPercent = avgPrev ? (avgDelta / avgPrev) * 100 : 0;
        const volumeChange = prevData && prevData.total > 0 ? Math.abs(deltaAmount / prevData.total) : (lastData.total ? 1 : 0);
        const countChange = prevData && prevData.count > 0 ? Math.abs(countDelta / prevData.count) : (countDelta ? 1 : 0);
        const avgChange = avgPrev ? Math.abs(avgDelta / avgPrev) : (avgLast ? 1 : 0);
        let comment = 'Stabilnie';
        if(!prevData || (prevData.total === 0 && prevData.count === 0)) {
            comment = deltaAmount > 0 ? 'Nowa aktywność' : 'Brak danych porównawczych';
        } else if(volumeChange < 0.05 && countChange < 0.05) {
            comment = 'Stabilnie';
        } else if(countChange > avgChange * 1.2) {
            comment = deltaAmount >= 0 ? 'Wzrost liczby transakcji' : 'Spadek liczby transakcji';
        } else if(avgChange > countChange * 1.2) {
            comment = deltaAmount >= 0 ? 'Wyższe kwoty' : 'Niższe kwoty';
        } else {
            comment = deltaAmount >= 0 ? 'Wzrost mieszany' : 'Spadek mieszany';
        }
        return { cat, lastData, prevData, avgLast, avgPrev, deltaAmount, deltaPercent, countDelta, avgDelta, avgDeltaPercent, type: cat?.type || selectedMood, comment };
    }).filter(Boolean);

    if(rows.length === 0){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="7">Brak danych do porównania.</td></tr></tbody>`;
        return;
    }

    let header = '<thead><tr><th>Kategoria</th><th>Ostatni miesiąc</th><th>Poprzedni miesiąc</th><th>Δ suma</th><th>Δ liczby</th><th>Δ średniej</th><th>Komentarz</th></tr></thead>';
    let body = '<tbody>';
    rows.forEach(row => {
        const cat = row.cat;
        const lastCell = `${fmt(row.lastData.total, state.currency)}<br><span class="tiny muted">${row.lastData.count} × ${fmt(row.avgLast, state.currency)}</span>`;
        let prevCell = '<span class="muted">—</span>';
        if(row.prevData){
            if(row.prevData.total > 0){
                prevCell = `${fmt(row.prevData.total, state.currency)}<br><span class="tiny muted">${row.prevData.count} × ${fmt(row.avgPrev, state.currency)}</span>`;
            } else {
                prevCell = '<span class="muted">—</span>';
            }
        }
        body += `<tr>
            <td>${cat?.emoji||''} ${cat?.name||'—'}</td>
            <td>${lastCell}</td>
            <td>${prevCell}</td>
            <td>${formatTrend(row.deltaAmount, row.deltaPercent, row.type)}</td>
            <td>${formatCountTrend(row.countDelta, row.prevData?.count || 0, row.type)}</td>
            <td>${formatTrend(row.avgDelta, row.avgDeltaPercent, row.type)}</td>
            <td>${row.comment}</td>
        </tr>`;
    });
    body += '</tbody>';
    table.innerHTML = header + body;
  }

  function renderAnalyticsMonthlyBreakdown(ctx) {
    const table = document.getElementById('analytics-monthly-breakdown');
    if(!table) return;
    const { monthlySummaries, selectedCatIds, categoryStats } = ctx;
    if(!monthlySummaries || monthlySummaries.length === 0){
        table.innerHTML = `<tbody><tr><td class="muted" style="text-align:center;" colspan="9">Brak danych do wyświetlenia.</td></tr></tbody>`;
        return;
    }

    let header = '<thead><tr><th>Miesiąc</th><th>Przychody</th><th>Wydatki (wszystkie)</th><th>Wybrane kategorie</th><th>Liczba transakcji</th><th>Średnia</th><th>Mediana</th><th>Top kategoria</th><th>Bilans</th></tr></thead>';
    let body = '<tbody>';
    monthlySummaries.forEach(summary => {
        const top = selectedCatIds.map(id => ({ id, total: summary.byCategory[id]?.total || 0, count: summary.byCategory[id]?.count || 0 })).sort((a,b)=>b.total - a.total)[0];
        let topCell = '<span class="muted">—</span>';
        if(top && top.total > 0){
            const stat = categoryStats[top.id];
            const cat = stat?.category;
            const share = summary.selectedTotal > 0 ? (top.total / summary.selectedTotal) * 100 : 0;
            topCell = `${cat?.emoji||''} ${cat?.name||'—'}<br><span class="tiny muted">${fmt(top.total, state.currency)} (${share.toFixed(1)}%)</span>`;
        }
        const net = summary.incomes - summary.expenses;
        body += `<tr>
            <td>${summary.ym}</td>
            <td>${fmt(summary.incomes, state.currency)}</td>
            <td>${fmt(summary.expenses, state.currency)}</td>
            <td>${fmt(summary.selectedTotal, state.currency)}</td>
            <td>${summary.selectedCount}</td>
            <td>${fmt(summary.selectedAvg || 0, state.currency)}</td>
            <td>${fmt(summary.selectedMedian || 0, state.currency)}</td>
            <td>${topCell}</td>
            <td class="${net >= 0 ? 'ok' : 'bad'}">${fmt(net, state.currency)}</td>
        </tr>`;
    });
    body += '</tbody>';
    table.innerHTML = header + body;
  }

  function renderAnalyticsTopTransactions(ctx) {
      const table = document.getElementById('analytics-top-transactions');
      if(!table) return;
      const tbody = document.createElement('tbody');
      table.innerHTML = `<thead><tr><th>Data</th><th>Kategoria</th><th>Kwota</th><th>Notatka</th></tr></thead>`;
      table.appendChild(tbody);

      const selectedSet = new Set(ctx.selectedCatIds);
      const catsMap = catsById();

      const flattened = [];
      (ctx.allEntriesInPeriod || []).forEach(tx => {
        const processEntry = (entry, categoryId, rawAmount, note) => {
            const cat = catsMap[categoryId];
            if(!cat || (cat.type !== 'expense' && cat.type !== 'saving')) return;
            if(selectedSet.size > 0 && !selectedSet.has(categoryId)) return;
            const amount = Math.abs(num(rawAmount));
            if(amount <= 0) return;
            flattened.push({ date: entry.date, categoryId, amount, note: note || '' });
        };

        if(tx.splits && tx.splits.length > 0) {
            tx.splits.forEach(split => processEntry(tx, split.categoryId, split.amount, tx.note));
        } else {
            processEntry(tx, tx.categoryId, tx.amount, tx.note);
        }
      });

      const top10 = flattened.sort((a,b) => b.amount - a.amount).slice(0, 10);

      if (top10.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center;">Brak wydatków w wybranych kategoriach w tym okresie.</td></tr>`;
          return;
      }

      tbody.innerHTML = top10.map(e => {
          const cat = catsMap[e.categoryId];
          const cls = cat?.type === 'saving' ? 'ok' : 'bad';
          return `
              <tr>
                  <td>${e.date}</td>
                  <td>${cat ? (cat.emoji||'') + ' ' + cat.name : '—'}</td>
                  <td class="${cls}">${fmt(e.amount, state.currency)}</td>
                  <td>${e.note || '—'}</td>
              </tr>
          `;
      }).join('');
  }

  // --- MoM comparison ----------------------------------------------------------
  const MOM_COLORS={a:'#0ea5e9',b:'#f97316'};
  const MOM_DIFF_COLORS={positive:'#ef4444',negative:'#22c55e',neutral:'#94a3b8'};
  const MOM_NO_FIXED_ID='__all_no_fixed';
  const MOM_NO_FIXED_LABEL='Wszystkie bez wydatków stałych';
  const MOM_FIXED_CATEGORY_ID='c_fixed';
  const momState={
    monthA:null,
    monthB:null,
    day:Math.min(31,Math.max(1,new Date().getDate())),
    selectedCategory:'__all'
  };
  let momChart=null;
  let momDiffChart=null;
  let momLastContext=null;

  function momPalette(){
    return {
      monthA: cssVar('--blue', MOM_COLORS.a),
      monthB: cssVar('--orange', MOM_COLORS.b),
      positive: cssVar('--red', MOM_DIFF_COLORS.positive),
      negative: cssVar('--green', MOM_DIFF_COLORS.negative),
      neutral: cssVar('--muted', MOM_DIFF_COLORS.neutral),
      ink: cssVar('--ink', '#0f172a')
    };
  }

  function destroyMomChart(){
    if(momChart){momChart.destroy(); momChart=null;}
  }

  function destroyMomDiffChart(){
    if(momDiffChart){momDiffChart.destroy(); momDiffChart=null;}
  }

  function ensureMomState(months){
    const sorted=[...months].sort();
    if(sorted.length===0){
      momState.monthA=null;
      momState.monthB=null;
      momState.selectedCategory='__all';
      return;
    }

    const workingMonth=b().workingMonth;
    if(!sorted.includes(momState.monthA)){
      if(workingMonth && sorted.includes(workingMonth)) momState.monthA=workingMonth;
      else momState.monthA=sorted[sorted.length-1];
    }

    if(!sorted.includes(momState.monthB)){
      const base=sorted.includes(momState.monthA)?momState.monthA:sorted[sorted.length-1];
      const desiredPrev=base?ymAdd(base,-1):null;
      if(desiredPrev && sorted.includes(desiredPrev)) momState.monthB=desiredPrev;
      else {
        const idx=sorted.indexOf(base);
        if(idx>0) momState.monthB=sorted[idx-1];
        else if(sorted.length>1) momState.monthB=sorted[sorted.length-2];
        else momState.monthB=base;
      }
    }

    const rawDay=Number(momState.day);
    if(!Number.isFinite(rawDay) || rawDay<1){
      momState.day=Math.min(31,Math.max(1,new Date().getDate()));
    }else{
      momState.day=Math.min(31,Math.max(1,Math.round(rawDay)));
    }
  }

  function getMomEffectiveDay(monthA,monthB,requested){
    const values=[];
    if(Number.isFinite(requested) && requested>0) values.push(requested);
    if(monthA) values.push(daysInYm(monthA));
    if(monthB) values.push(daysInYm(monthB));
    if(!values.length) return 1;
    return Math.min(...values);
  }

  function buildMomSeries(ym,categoryIds){
    const out={ym,days:0,series:{}};
    categoryIds.forEach(id=>{out.series[id]=[];});
    if(!ym) return out;
    const days=daysInYm(ym);
    out.days=days;
    categoryIds.forEach(id=>{out.series[id]=Array(days).fill(0);});
    const catSet=new Set(categoryIds);
    const entries=entriesForMonth(ym);
    for(const entry of entries){
      const cat=catsById()[entry.categoryId];
      if(!cat || cat.type!=='expense') continue;
      if(!catSet.has(entry.categoryId)) continue;
      const day=Math.min(days,Math.max(1,Number(entry.date.slice(-2))||1));
      const idx=day-1;
      const amount=Math.abs(entry.amount);
      out.series[entry.categoryId][idx]+=amount;
      if(out.series.__all) out.series.__all[idx]+=amount;
      if(out.series[MOM_NO_FIXED_ID] && entry.categoryId!==MOM_FIXED_CATEGORY_ID){
        out.series[MOM_NO_FIXED_ID][idx]+=amount;
      }
    }
    for(const id of categoryIds){
      const arr=out.series[id];
      for(let i=1;i<arr.length;i++){arr[i]+=arr[i-1];}
    }
    return out;
  }

  function momSeriesSlice(seriesData,catId,dayLimit){
    const arr=seriesData?.series?.[catId];
    if(!arr || !arr.length) return [];
    const limit=Math.min(dayLimit,arr.length);
    return arr.slice(0,limit);
  }

  function momSeriesValue(seriesData,catId,dayLimit){
    const arr=seriesData?.series?.[catId];
    if(!arr || !arr.length) return 0;
    const idx=Math.min(dayLimit,arr.length);
    if(idx<=0) return 0;
    return arr[idx-1];
  }

  function formatMomDiff(diff){
    if(!Number.isFinite(diff) || Math.abs(diff)<0.01) return '<span class="delta-neutral">—</span>';
    const cls=diff>0?'delta-down':'delta-up';
    const arrow=diff>0?'▲':'▼';
    return `<span class="${cls}">${arrow} ${fmt(Math.abs(diff), state.currency)}</span>`;
  }

  function formatMomPace(totalA,totalB){
    if(!Number.isFinite(totalA)) totalA=0;
    if(!Number.isFinite(totalB)) totalB=0;
    if(totalB<=0) return totalA>0?'<span class="delta-neutral">—</span>':'<span class="delta-neutral">—</span>';
    const pct=((totalA-totalB)/totalB)*100;
    if(!Number.isFinite(pct) || Math.abs(pct)<0.05) return '<span class="delta-neutral">—</span>';
    const cls=pct>0?'delta-down':'delta-up';
    const arrow=pct>0?'▲':'▼';
    return `<span class="${cls}">${arrow} ${Math.abs(pct).toFixed(1)}%</span>`;
  }

  function momCategoryLabel(cat){
    if(!cat) return '';
    if(cat.id==='__all') return 'Wszystkie kategorie';
    const prefix=cat.emoji?cat.emoji+' ':'';
    return `${prefix}${cat.name}`;
  }

  function updateMomActiveRows(tbody){
    if(!tbody) return;
    tbody.querySelectorAll('tr').forEach(row=>{
      row.classList.toggle('active',row.dataset.catId===momState.selectedCategory);
    });
  }

  let momDetailOpen=false;
  let momDetailSort='impact';
  let momDetailBound=false;
  let momDetailKeyBound=false;

  window.addEventListener('resize',()=>{
    if(momDetailOpen) positionMomDetailPanel();
  });
  window.addEventListener('scroll',()=>{
    if(momDetailOpen) positionMomDetailPanel();
  },{passive:true});

  function momDetailEligible(catId){
    return !!catId && catId!=='__all' && catId!==MOM_NO_FIXED_ID;
  }

  function ensureMomDetailBindings(){
    const button=document.getElementById('mom-detail-toggle');
    const panel=document.getElementById('mom-detail-panel');
    const backdrop=document.getElementById('mom-detail-backdrop');
    const closeBtn=document.getElementById('mom-detail-close');
    if(button && panel && backdrop && !momDetailBound){
      button.addEventListener('click',()=>{ if(!button.disabled) openMomDetail(); });
      if(closeBtn){ closeBtn.addEventListener('click',()=>closeMomDetail()); }
      backdrop.addEventListener('click',()=>closeMomDetail());
      momDetailBound=true;
    }
    const sortWrap=document.getElementById('mom-detail-sort');
    if(sortWrap && !sortWrap.dataset.bound){
      sortWrap.dataset.bound='1';
      sortWrap.querySelectorAll('button[data-mom-detail-sort]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const value=btn.dataset.momDetailSort||'impact';
          if(momDetailSort===value) return;
          momDetailSort=value;
          updateMomDetailSortButtons();
          if(momDetailOpen) renderMomDetail();
        });
      });
    }
    if(!momDetailKeyBound){
      document.addEventListener('keydown',evt=>{
        if(evt.key==='Escape' && momDetailOpen){
          closeMomDetail();
        }
      });
      momDetailKeyBound=true;
    }
  }

  function positionMomDetailPanel(){
    const panel=document.getElementById('mom-detail-panel');
    const section=document.getElementById('tab-mom');
    if(!panel || !section) return;
    const rect=section.getBoundingClientRect();
    const viewportWidth=window.innerWidth||document.documentElement.clientWidth||1024;
    const viewportHeight=window.innerHeight||document.documentElement.clientHeight||768;
    const left=Math.max(16, rect.left);
    const right=Math.max(16, viewportWidth-rect.right);
    let top=Math.max(24, rect.top);
    let bottom=Math.max(24, viewportHeight-rect.bottom);
    const minHeight=360;
    let available=viewportHeight-top-bottom;
    if(available<minHeight){
      const missing=minHeight-available;
      const reducibleBottom=Math.max(0, bottom-24);
      const reduceBottom=Math.min(reducibleBottom, missing);
      bottom-=reduceBottom;
      available=viewportHeight-top-bottom;
      if(available<minHeight){
        const remaining=minHeight-available;
        const reducibleTop=Math.max(0, top-24);
        const reduceTop=Math.min(reducibleTop, remaining);
        top-=reduceTop;
      }
    }
    panel.style.setProperty('--mom-panel-left', `${left}px`);
    panel.style.setProperty('--mom-panel-right', `${right}px`);
    panel.style.setProperty('--mom-panel-top', `${Math.max(16, top)}px`);
    panel.style.setProperty('--mom-panel-bottom', `${Math.max(16, bottom)}px`);
  }

  function openMomDetail(){
    const panel=document.getElementById('mom-detail-panel');
    const backdrop=document.getElementById('mom-detail-backdrop');
    if(!panel || !backdrop) return;
    momDetailOpen=true;
    positionMomDetailPanel();
    renderMomDetail();
    panel.classList.add('is-visible');
    panel.setAttribute('aria-hidden','false');
    backdrop.hidden=false;
    if(typeof requestAnimationFrame==='function') requestAnimationFrame(()=>backdrop.classList.add('is-visible'));
    else backdrop.classList.add('is-visible');
    const closeBtn=document.getElementById('mom-detail-close');
    if(closeBtn) closeBtn.focus({preventScroll:true});
  }

  function closeMomDetail(options={}){
    const {focusTrigger=true}=options;
    const panel=document.getElementById('mom-detail-panel');
    const backdrop=document.getElementById('mom-detail-backdrop');
    if(!panel || !backdrop) return;
    momDetailOpen=false;
    panel.classList.remove('is-visible');
    panel.setAttribute('aria-hidden','true');
    backdrop.classList.remove('is-visible');
    setTimeout(()=>{ if(!momDetailOpen) backdrop.hidden=true; }, 240);
    if(focusTrigger){
      const button=document.getElementById('mom-detail-toggle');
      if(button) button.focus({preventScroll:true});
    }
  }

  function updateMomDetailSortButtons(){
    document.querySelectorAll('[data-mom-detail-sort]').forEach(btn=>{
      const value=btn.dataset.momDetailSort||'impact';
      btn.classList.toggle('is-active', value===momDetailSort);
    });
  }

  function updateMomDetailTrigger(){
    ensureMomDetailBindings();
    const button=document.getElementById('mom-detail-toggle');
    if(!button){
      if(momDetailOpen) closeMomDetail({focusTrigger:false});
      return;
    }
    const labelEl=button.querySelector('.label');
    const context=momLastContext;
    const selected=context?.categories?.find(c=>c.id===momState.selectedCategory);
    const eligible=context && selected && momDetailEligible(selected.id);
    const enabled=Boolean(eligible && context?.monthA && context?.monthB);
    button.disabled=!enabled;
    button.classList.toggle('is-ready', enabled);
    const labelText=enabled ? `Detale: ${momCategoryLabel(selected)}` : 'Szczegóły kategorii';
    if(labelEl) labelEl.textContent=labelText;
    else button.textContent=labelText;
    if(enabled){
      button.title=`Pokaż transakcje dla ${momCategoryLabel(selected)} (${context.monthA} vs ${context.monthB})`;
    }else{
      button.title='Wybierz kategorię wydatków, aby zobaczyć szczegóły.';
    }
    if(!enabled && momDetailOpen){
      closeMomDetail({focusTrigger:false});
    }
  }

  function formatYmHuman(ym){
    if(!ym) return '';
    const parts=ym.split('-').map(Number);
    if(parts.length<2) return ym;
    const [year, month]=parts;
    if(!year || !month) return ym;
    const date=new Date(year, month-1, 1);
    if(Number.isNaN(date.getTime())) return ym;
    try{
      return date.toLocaleDateString('pl-PL',{month:'long',year:'numeric'});
    }catch(err){
      return ym;
    }
  }

  function formatWeekdayShort(iso){
    if(!iso) return '';
    const date=new Date(iso);
    if(Number.isNaN(date.getTime())) return '';
    try{
      return date.toLocaleDateString('pl-PL',{weekday:'short'});
    }catch(err){
      return '';
    }
  }

  function buildMomDetailData(monthA, monthB, categoryId, dayLimit){
    const limit=Math.max(1, Number(dayLimit)||1);
    const collect=ym=>{
      const map=new Map();
      if(!ym) return map;
      const entries=entriesForMonth(ym);
      for(const entry of entries){
        if(entry.categoryId!==categoryId) continue;
        const day=Number(entry.date.slice(-2));
        if(!Number.isFinite(day) || day<1 || day>limit) continue;
        if(!map.has(day)) map.set(day,[]);
        map.get(day).push(entry);
      }
      return map;
    };
    const mapA=collect(monthA);
    const mapB=collect(monthB);
    const daySet=new Set([...mapA.keys(), ...mapB.keys()]);
    const days=Array.from(daySet).sort((a,b)=>a-b).map(day=>{
      const entriesA=mapA.get(day)||[];
      const entriesB=mapB.get(day)||[];
      const totalA=entriesA.reduce((sum,entry)=>sum+Math.abs(entry.amount),0);
      const totalB=entriesB.reduce((sum,entry)=>sum+Math.abs(entry.amount),0);
      const padded=String(day).padStart(2,'0');
      return {
        day,
        label:padded,
        totalA,
        totalB,
        delta: totalA-totalB,
        entriesA,
        entriesB,
        isoA: monthA ? `${monthA}-${padded}` : null,
        isoB: monthB ? `${monthB}-${padded}` : null,
        cumulativeA: 0,
        cumulativeB: 0,
        cumulativeDelta: 0
      };
    });
    let runningA=0;
    let runningB=0;
    let crossoverDay=null;
    let ledFromStart=false;
    let everLed=false;
    let totalCountA=0;
    let totalCountB=0;
    days.forEach((row,idx)=>{
      totalCountA+=row.entriesA.length;
      totalCountB+=row.entriesB.length;
      runningA+=row.totalA;
      runningB+=row.totalB;
      row.cumulativeA=runningA;
      row.cumulativeB=runningB;
      row.cumulativeDelta=runningA-runningB;
      if(runningA>runningB){
        everLed=true;
        if(crossoverDay===null) crossoverDay=row.day;
        if(idx===0) ledFromStart=true;
      }
    });
    const totalA=runningA;
    const totalB=runningB;
    const avgA=totalCountA>0?totalA/totalCountA:0;
    const avgB=totalCountB>0?totalB/totalCountB:0;
    return {
      days,
      totalA,
      totalB,
      dayLimit:limit,
      countA:totalCountA,
      countB:totalCountB,
      avgA,
      avgB,
      crossoverDay,
      ledFromStart,
      everLed,
      finalDelta: totalA-totalB
    };
  }

  function renderMomDetailEntries(entries){
    if(!entries.length){
      return '<div class="mom-detail-month-empty">Brak wydatków</div>';
    }
    return entries.map(entry=>{
      const amount=fmt(Math.abs(entry.amount), state.currency);
      const note=entry.note ? escapeHtml(entry.note).replace(/\n/g,'<br />') : '<span class="muted">Brak notatki</span>';
      return `<div class="mom-detail-entry"><div class="mom-detail-entry-amount">${amount}</div><div class="mom-detail-entry-info"><div class="mom-detail-entry-note">${note}</div></div></div>`;
    }).join('');
  }

  function renderMomDetail(){
    if(!momDetailOpen) return;
    ensureMomDetailBindings();
    const titleEl=document.getElementById('mom-detail-title');
    const subtitleEl=document.getElementById('mom-detail-subtitle');
    const metaEl=document.getElementById('mom-detail-meta');
    const bodyEl=document.getElementById('mom-detail-body');
    if(!titleEl || !subtitleEl || !metaEl || !bodyEl) return;
    positionMomDetailPanel();
    updateMomDetailSortButtons();
    const context=momLastContext;
    if(!context){
      titleEl.textContent='Szczegóły kategorii';
      subtitleEl.textContent='Wybierz miesiące oraz kategorię, aby zobaczyć transakcje.';
      metaEl.innerHTML='';
      bodyEl.innerHTML='<div class="mom-detail-empty">Brak danych do analizy. Wybierz dwa miesiące do porównania.</div>';
      return;
    }
    const {categories,monthA,monthB,dayLimit}=context;
    const selected=categories.find(c=>c.id===momState.selectedCategory);
    if(!selected || !momDetailEligible(selected.id)){
      titleEl.textContent='Szczegóły kategorii';
      subtitleEl.textContent='Kliknij konkretną kategorię z tabeli, aby zobaczyć transakcje.';
      metaEl.innerHTML='';
      bodyEl.innerHTML='<div class="mom-detail-empty">Wybierz kategorię wydatków, aby wejść w szczegóły.</div>';
      return;
    }
    const titleLabel=momCategoryLabel(selected);
    titleEl.textContent=titleLabel;
    subtitleEl.textContent=`${formatYmHuman(monthA)} vs ${formatYmHuman(monthB)} • do dnia ${String(dayLimit).padStart(2,'0')}`;
    const detail=buildMomDetailData(monthA, monthB, selected.id, dayLimit);
    const totalDiff=detail.totalA-detail.totalB;
    const freqDiff=detail.countA-detail.countB;
    const avgDiff=detail.avgA-detail.avgB;
    const totalTileClass=['mom-detail-tile','highlight'];
    if(totalDiff>0) totalTileClass.push('positive');
    else if(totalDiff<0) totalTileClass.push('negative');
    const freqTileClass=['mom-detail-tile'];
    if(freqDiff>0) freqTileClass.push('positive');
    else if(freqDiff<0) freqTileClass.push('negative');
    const avgTileClass=['mom-detail-tile'];
    if(avgDiff>0) avgTileClass.push('positive');
    else if(avgDiff<0) avgTileClass.push('negative');
    const formatCountFull=value=>{
      if(!Number.isFinite(value) || value<=0) return '0';
      return String(value);
    };
    const renderPair=(labelA,valueA,labelB,valueB)=>`<span class="mom-detail-tile-pill">${labelA}</span><strong>${valueA}</strong><span class="mom-detail-tile-dot">•</span><span class="mom-detail-tile-pill">${labelB}</span><strong>${valueB}</strong>`;
    const totalNote=totalDiff>0
      ? `Miesiąc A przekracza miesiąc B o ${fmt(Math.abs(totalDiff), state.currency)}.`
      : totalDiff<0
        ? `Miesiąc A jest niższy o ${fmt(Math.abs(totalDiff), state.currency)} względem miesiąca B.`
        : (detail.totalA>0 || detail.totalB>0)
          ? 'Oba miesiące są na bardzo podobnym poziomie.'
          : 'Brak wydatków w wybranych miesiącach.';
    const hasTransactions=(detail.countA||0)+(detail.countB||0)>0;
    const freqNote=!hasTransactions
      ? 'Brak transakcji w porównywanych miesiącach.'
      : freqDiff>0
        ? `Więcej transakcji w miesiącu A (+${freqDiff}).`
        : freqDiff<0
          ? `Mniej transakcji w miesiącu A (−${Math.abs(freqDiff)}).`
          : 'Tyle samo transakcji w obu miesiącach.';
    const avgNote=!hasTransactions
      ? 'Średnie wartości pojawią się po pierwszych transakcjach.'
      : avgDiff>0
        ? `Średnia wartość transakcji w miesiącu A jest wyższa o ${fmt(Math.abs(avgDiff), state.currency)}.`
        : avgDiff<0
          ? `Średnia wartość transakcji w miesiącu A jest niższa o ${fmt(Math.abs(avgDiff), state.currency)}.`
          : 'Średnia wartość transakcji pozostaje na tym samym poziomie.';
    let crossoverHtml='';
    if(detail.everLed && detail.crossoverDay){
      const crossRatio=Math.max(0, Math.min(100, (detail.crossoverDay/detail.dayLimit)*100));
      const crossLabel=detail.ledFromStart?'Start prowadzenia':'Moment przekroczenia';
      const crossNote=detail.ledFromStart
        ? 'Wydatki miesiąca A były wyższe od pierwszego dnia.'
        : 'Po tym dniu wydatki miesiąca A utrzymywały się powyżej miesiąca B.';
      crossoverHtml=`<div class="mom-detail-cross positive"><div class="mom-detail-cross-header"><span class="mom-detail-cross-label">${crossLabel}</span><span class="mom-detail-cross-value">Dzień ${String(detail.crossoverDay).padStart(2,'0')}</span></div><div class="mom-detail-cross-bar"><span style="--mom-cross-position:${crossRatio}%"></span></div><p class="mom-detail-cross-note">${crossNote}</p></div>`;
    }else{
      const limitSafe=Number.isFinite(detail.dayLimit)?String(detail.dayLimit).padStart(2,'0'):'';
      const crossNote=limitSafe
        ? `Do dnia ${limitSafe} wydatki miesiąca A nie przekroczyły poziomu miesiąca B.`
        : 'Do wskazanego dnia wydatki miesiąca A nie przekroczyły poziomu miesiąca B.';
      crossoverHtml=`<div class="mom-detail-cross neutral"><div class="mom-detail-cross-header"><span class="mom-detail-cross-label">Moment przekroczenia</span><span class="mom-detail-cross-value">Nie wystąpił</span></div><div class="mom-detail-cross-bar"></div><p class="mom-detail-cross-note">${crossNote}</p></div>`;
    }
    const totalPair=renderPair('A', fmt(detail.totalA,state.currency), 'B', fmt(detail.totalB,state.currency));
    const countPair=renderPair('A', formatCountFull(detail.countA), 'B', formatCountFull(detail.countB));
    const avgPair=renderPair('A', hasTransactions?fmt(detail.avgA,state.currency):'—', 'B', hasTransactions?fmt(detail.avgB,state.currency):'—');
    metaEl.innerHTML=`<div class="mom-detail-meta-grid"><div class="${totalTileClass.join(' ')}"><span class="mom-detail-tile-label">Łączne wydatki</span><div class="mom-detail-tile-value">${totalPair}</div><p class="mom-detail-tile-note">${totalNote}</p></div><div class="${freqTileClass.join(' ')}"><span class="mom-detail-tile-label">Liczba transakcji</span><div class="mom-detail-tile-value">${countPair}</div><p class="mom-detail-tile-note">${freqNote}</p></div><div class="${avgTileClass.join(' ')}"><span class="mom-detail-tile-label">Średnia wartość</span><div class="mom-detail-tile-value">${avgPair}</div><p class="mom-detail-tile-note">${avgNote}</p></div></div>${crossoverHtml}`;
    if(detail.days.length===0){
      bodyEl.innerHTML='<div class="mom-detail-empty">Brak wydatków w tej kategorii w wybranych miesiącach do wskazanego dnia.</div>';
      return;
    }
    const maxImpact=detail.days.reduce((max,day)=>Math.max(max,Math.abs(day.delta)),0);
    const sortedDays=[...detail.days];
    if(momDetailSort==='impact'){
      sortedDays.sort((a,b)=>{
        const impactDiff=Math.abs(b.delta)-Math.abs(a.delta);
        if(Math.abs(impactDiff)>0.01) return impactDiff;
        if(b.totalA!==a.totalA) return b.totalA-a.totalA;
        if(b.totalB!==a.totalB) return b.totalB-a.totalB;
        return a.day-b.day;
      });
    }else{
      sortedDays.sort((a,b)=>a.day-b.day);
    }
    const palette=momPalette();
    const formatCount=count=>{
      if(!count) return 'Brak';
      if(count===1) return '1 trans.';
      return `${count} trans.`;
    };
    bodyEl.innerHTML=sortedDays.map((day,idx)=>{
      const toneClass=day.delta>0?'positive':day.delta<0?'negative':'neutral';
      const badgeTone=day.delta>0?'positive':day.delta<0?'negative':'neutral';
      const sampleIso=day.isoA || day.isoB;
      const weekday=formatWeekdayShort(sampleIso);
      const dayTitle=weekday?`Dzień ${day.label} • ${weekday}`:`Dzień ${day.label}`;
      const subTitle=`Suma dnia: A ${fmt(day.totalA,state.currency)} • B ${fmt(day.totalB,state.currency)}`;
      const cumulativeLine=`Narastająco: A ${fmt(day.cumulativeA,state.currency)} • B ${fmt(day.cumulativeB,state.currency)}`;
      const deltaValue=Math.abs(day.delta);
      let badgeText='Bez różnicy';
      if(day.delta>0) badgeText=`A +${fmt(deltaValue,state.currency)}`;
      else if(day.delta<0) badgeText=`B +${fmt(deltaValue,state.currency)}`;
      const countA=formatCount(day.entriesA.length);
      const countB=formatCount(day.entriesB.length);
      return `<div class="mom-detail-day ${toneClass}" data-mom-detail-day="${idx}"><div class="mom-detail-day-header"><div><div class="mom-detail-day-title">${dayTitle}</div><div class="mom-detail-day-subtitle">${subTitle}</div><div class="mom-detail-day-subline">${cumulativeLine}</div></div><div class="mom-detail-badge ${badgeTone}">${badgeText}</div></div><div class="mom-detail-columns"><div class="mom-detail-month"><div class="mom-detail-month-label"><span>Miesiąc A</span><span class="mom-detail-month-count">${countA}</span></div>${renderMomDetailEntries(day.entriesA)}</div><div class="mom-detail-month"><div class="mom-detail-month-label"><span>Miesiąc B</span><span class="mom-detail-month-count">${countB}</span></div>${renderMomDetailEntries(day.entriesB)}</div></div></div>`;
    }).join('');
    sortedDays.forEach((day,idx)=>{
      const el=bodyEl.querySelector(`[data-mom-detail-day="${idx}"]`);
      if(!el) return;
      const toneColor=day.delta>0?palette.positive:day.delta<0?palette.negative:palette.ink;
      const impact=maxImpact>0?Math.min(1,Math.abs(day.delta)/maxImpact):0;
      const background=day.delta===0?colorWithAlpha(palette.ink,0.08):colorWithAlpha(toneColor,0.18+0.32*impact);
      const border=day.delta===0?colorWithAlpha(palette.ink,0.18):colorWithAlpha(toneColor,0.45+0.25*impact);
      el.style.background=`linear-gradient(145deg, ${background}, rgba(255,255,255,0.95))`;
      el.style.borderColor=border;
    });
    bodyEl.scrollTop=0;
  }

  function renderMomComparison(){
    const section=document.getElementById('tab-mom');
    if(!section) return;
    const info=document.getElementById('mom-info');
    const summary=document.getElementById('mom-summary');
    const selectA=document.getElementById('mom-month-a');
    const selectB=document.getElementById('mom-month-b');
    const dayInput=document.getElementById('mom-day-input');
    const tableBody=document.querySelector('#mom-table tbody');
    const colA=document.getElementById('mom-col-a');
    const colB=document.getElementById('mom-col-b');
    const emptyChart=document.getElementById('mom-chart-empty');
    const chartCanvas=document.getElementById('mom-chart');
    const caption=document.getElementById('mom-chart-caption');
    const diffCanvas=document.getElementById('mom-diff-chart');
    const diffEmpty=document.getElementById('mom-diff-empty');
    const diffCaption=document.getElementById('mom-diff-caption');

    ensureMomDetailBindings();

    const months=getAnalyticsAvailableMonths();
    ensureMomState(months);

    if(selectA){
      selectA.innerHTML='';
      if(months.length===0){
        selectA.disabled=true;
        selectA.add(new Option('Brak danych',''));
      }else{
        selectA.disabled=false;
        months.forEach(m=>selectA.add(new Option(m,m,false,m===momState.monthA)));
      }
      selectA.onchange=e=>{momState.monthA=e.target.value||null; renderMomComparison();};
    }
    if(selectB){
      selectB.innerHTML='';
      if(months.length===0){
        selectB.disabled=true;
        selectB.add(new Option('Brak danych',''));
      }else{
        selectB.disabled=false;
        months.forEach(m=>selectB.add(new Option(m,m,false,m===momState.monthB)));
      }
      selectB.onchange=e=>{momState.monthB=e.target.value||null; renderMomComparison();};
    }
    if(dayInput){
      dayInput.disabled=months.length===0;
      dayInput.value=momState.day;
      dayInput.onchange=e=>{
        const raw=Number(e.target.value);
        if(!Number.isFinite(raw)){
          e.target.value=momState.day;
          return;
        }
        momState.day=Math.min(31,Math.max(1,Math.round(raw)));
        renderMomComparison();
      };
    }

    if(months.length===0){
      if(info) info.textContent='Brak danych do porównania. Dodaj transakcje, aby rozpocząć analizę.';
      if(summary){summary.style.display='none'; summary.textContent='';}
      if(colA) colA.textContent='Miesiąc A';
      if(colB) colB.textContent='Miesiąc B';
      if(tableBody) tableBody.innerHTML='<tr><td colspan="5" class="muted" style="text-align:center;">Brak danych do wyświetlenia.</td></tr>';
      momLastContext=null;
      destroyMomChart();
      destroyMomDiffChart();
      if(chartCanvas) chartCanvas.style.display='none';
      if(emptyChart) emptyChart.style.display='flex';
      if(caption) caption.textContent='';
      if(diffCanvas) diffCanvas.style.display='none';
      if(diffEmpty) diffEmpty.style.display='flex';
      if(diffCaption) diffCaption.textContent='';
      updateMomDetailTrigger();
      if(momDetailOpen) renderMomDetail();
      return;
    }

    const effectiveDay=getMomEffectiveDay(momState.monthA,momState.monthB,Number(momState.day));

    if(info) info.textContent='Porównuj tempo wydatków w dwóch miesiącach roku.';
    if(summary){
      const requested=Number(momState.day);
      summary.style.display='block';
      const base=`Porównanie do dnia ${String(effectiveDay).padStart(2,'0')}.`;
      summary.textContent = effectiveDay !== requested ? `${base} Dopasowano do liczby dni krótszego miesiąca.` : base;
    }
    if(colA) colA.textContent = momState.monthA ? `Miesiąc A (${momState.monthA})` : 'Miesiąc A';
    if(colB) colB.textContent = momState.monthB ? `Miesiąc B (${momState.monthB})` : 'Miesiąc B';

    const expenseCats=(b().categories||[]).filter(c=>c.type==='expense');
    const categories=[
      {id:'__all',name:'Wszystkie kategorie',emoji:'📊'},
      {id:MOM_NO_FIXED_ID,name:MOM_NO_FIXED_LABEL,emoji:'🧾'}
    ];
    for(const cat of expenseCats){
      categories.push({id:cat.id,name:cat.name,emoji:cat.emoji||''});
    }
    if(!categories.some(c=>c.id===momState.selectedCategory)){
      momState.selectedCategory='__all';
    }

    const catIds=categories.map(c=>c.id);
    const monthAData=buildMomSeries(momState.monthA,catIds);
    const monthBData=buildMomSeries(momState.monthB,catIds);

    const rows=categories.map(cat=>{
      const totalA=momSeriesValue(monthAData,cat.id,effectiveDay);
      const totalB=momSeriesValue(monthBData,cat.id,effectiveDay);
      return {cat,totalA,totalB,diff:totalA-totalB};
    });
    const overall=rows.shift();
    const others=rows.sort((a,b)=>b.totalA-a.totalA);
    const ordered=overall?[overall,...others]:others;

    if(tableBody){
      tableBody.innerHTML='';
      ordered.forEach(row=>{
        const tr=document.createElement('tr');
        tr.dataset.catId=row.cat.id;
        const label=momCategoryLabel(row.cat);
        tr.innerHTML=`<td>${label}</td><td>${fmt(row.totalA, state.currency)}</td><td>${fmt(row.totalB, state.currency)}</td><td>${formatMomDiff(row.diff)}</td><td>${formatMomPace(row.totalA,row.totalB)}</td>`;
        tr.addEventListener('click',()=>{
          momState.selectedCategory=row.cat.id;
          updateMomActiveRows(tableBody);
          updateMomChart();
          updateMomDetailTrigger();
          if(momDetailOpen) renderMomDetail();
        });
        tableBody.appendChild(tr);
      });
      updateMomActiveRows(tableBody);
    }

    momLastContext={categories,monthA:momState.monthA,monthB:momState.monthB,dayLimit:effectiveDay,monthAData,monthBData};
    updateMomDetailTrigger();
    updateMomChart();
    if(momDetailOpen) renderMomDetail();
  }

  function updateMomChart(){
    const canvas=document.getElementById('mom-chart');
    const empty=document.getElementById('mom-chart-empty');
    const caption=document.getElementById('mom-chart-caption');
    const diffCanvas=document.getElementById('mom-diff-chart');
    const diffEmpty=document.getElementById('mom-diff-empty');
    const diffCaption=document.getElementById('mom-diff-caption');
    if(!canvas || !diffCanvas){
      destroyMomChart();
      destroyMomDiffChart();
      return;
    }
    if(!momLastContext){
      destroyMomChart();
      destroyMomDiffChart();
      if(empty) empty.style.display='flex';
      canvas.style.display='none';
      if(caption) caption.textContent='';
      if(diffEmpty) diffEmpty.style.display='flex';
      diffCanvas.style.display='none';
      if(diffCaption) diffCaption.textContent='';
      updateMomDetailTrigger();
      if(momDetailOpen) renderMomDetail();
      return;
    }
    const {categories,monthA,monthB,dayLimit,monthAData,monthBData}=momLastContext;
    const selected=categories.find(c=>c.id===momState.selectedCategory)||categories[0];
    const seriesA=momSeriesSlice(monthAData,selected.id,dayLimit);
    const seriesB=momSeriesSlice(monthBData,selected.id,dayLimit);
    const maxLen=Math.max(seriesA.length,seriesB.length);
    if(maxLen===0){
      destroyMomChart();
      destroyMomDiffChart();
      if(empty) empty.style.display='flex';
      canvas.style.display='none';
      if(caption) caption.textContent='Brak danych dla wybranej kategorii.';
      if(diffEmpty) diffEmpty.style.display='flex';
      diffCanvas.style.display='none';
      if(diffCaption) diffCaption.textContent='';
      updateMomDetailTrigger();
      if(momDetailOpen) renderMomDetail();
      return;
    }
    const labels=Array.from({length:maxLen},(_,i)=>String(i+1).padStart(2,'0'));
    const diffSeries=labels.map((_,idx)=>{
      const valA=idx<seriesA.length?seriesA[idx]:null;
      const valB=idx<seriesB.length?seriesB[idx]:null;
      if(valA===null && valB===null) return null;
      const safeA=Number.isFinite(valA)?valA:0;
      const safeB=Number.isFinite(valB)?valB:0;
      return safeA-safeB;
    });
    canvas.style.display='block';
    diffCanvas.style.display='block';
    if(empty) empty.style.display='none';
    if(diffEmpty) diffEmpty.style.display='none';
    destroyMomChart();
    destroyMomDiffChart();
    const palette=momPalette();
    const toRgb=(value)=>{
      if(!value) return null;
      const raw=String(value).trim();
      const hexMatch=raw.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
      if(hexMatch){
        let hex=hexMatch[1];
        if(hex.length===3){
          hex=hex.split('').map(ch=>ch+ch).join('');
        }
        const int=parseInt(hex,16);
        return {
          r:(int>>16)&255,
          g:(int>>8)&255,
          b:int&255
        };
      }
      const rgbMatch=raw.match(/^rgba?\(([^)]+)\)$/i);
      if(rgbMatch){
        const parts=rgbMatch[1].split(',').map(part=>Number(part.trim())).filter(num=>Number.isFinite(num));
        if(parts.length>=3){
          return {r:parts[0],g:parts[1],b:parts[2]};
        }
      }
      return null;
    };
    const mixColor=(color,target,amount)=>{
      const base=toRgb(color);
      const mix=toRgb(target);
      if(!base||!mix) return color;
      const clamp=(v)=>Math.max(0,Math.min(255,Math.round(v)));
      const r=clamp(base.r+(mix.r-base.r)*amount);
      const g=clamp(base.g+(mix.g-base.g)*amount);
      const b=clamp(base.b+(mix.b-base.b)*amount);
      return `rgb(${r},${g},${b})`;
    };
    const createGradient=(ctx,color)=>{
      const area=ctx.chart.chartArea;
      if(!area){
        return colorWithAlpha(color,0.18);
      }
      const gradient=ctx.chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
      gradient.addColorStop(0, colorWithAlpha(color,0.28));
      gradient.addColorStop(1, colorWithAlpha(color,0));
      return gradient;
    };
    const lineDataset=(label,data,color)=>({
      label,
      data,
      tension:0.35,
      borderWidth:2.5,
      borderColor:color,
      fill:true,
      spanGaps:true,
      pointRadius:4,
      pointHoverRadius:6,
      pointHitRadius:14,
      pointHoverBorderWidth:3,
      pointBackgroundColor:colorWithAlpha(color,0.95),
      pointBorderColor:colorWithAlpha(color,0.35),
      pointBorderWidth:2,
      backgroundColor:(ctx)=>createGradient(ctx,color)
    });
    momChart=new Chart(canvas.getContext('2d'),{
      type:'line',
      data:{
        labels,
        datasets:[
          lineDataset(monthA||'Miesiąc A',seriesA,palette.monthA),
          lineDataset(monthB||'Miesiąc B',seriesB,palette.monthB)
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'nearest',intersect:false},
        layout:{padding:{top:8,right:12,bottom:8,left:12}},
        animations:{
          radius:{duration:300},
          tension:{duration:500,easing:'easeOutQuart'}
        },
        plugins:{
          legend:{
            display:true,
            labels:{
              usePointStyle:true,
              boxWidth:10,
              boxHeight:10,
              padding:16
            }
          },
          tooltip:{
            displayColors:false,
            mode:'nearest',
            intersect:false,
            callbacks:{
              title:items=>items[0]?`Dzień ${items[0].label}`:'',
              label:context=>`${context.dataset.label}: ${fmt(context.parsed.y,state.currency)}`,
              footer:items=>{
                if(items.length<2) return '';
                const diff=items[0].parsed.y-items[1].parsed.y;
                if(!Number.isFinite(diff)) return '';
                const sign=diff>0?'+':'';
                return `Δ A−B: ${sign}${fmt(diff,state.currency)}`;
              }
            }
          }
        },
        scales:{
          x:{
            title:{display:true,text:'Dzień miesiąca'},
            grid:{display:false},
            ticks:{maxRotation:0}
          },
          y:{
            beginAtZero:true,
            ticks:{callback:currencyTicks},
            grid:{drawBorder:false,color:colorWithAlpha(palette.ink,0.08)}
          }
        },
        onHover:(evt,elements)=>{
          const target=evt?.native?.target;
          if(target){
            target.style.cursor=elements.length?'pointer':'default';
          }
        }
      }
    });
    const diffDatasetColor=context=>{
      const value=context.raw;
      if(value===null||value===undefined) return 'transparent';
      if(value>0) return palette.positive;
      if(value<0) return palette.negative;
      return palette.neutral;
    };
    const buildBarGradient=(ctx,base)=>{
      if(base==='transparent') return base;
      const area=ctx.chart.chartArea;
      if(!area){
        return colorWithAlpha(base,0.48);
      }
      const chartCtx=ctx.chart.ctx;
      const gradient=chartCtx.createLinearGradient(0, area.bottom, 0, area.top);
      const highlight=mixColor(base,'#ffffff',0.22);
      const shadow=mixColor(base,palette.ink,0.35);
      const isPositive=(ctx.raw??0)>=0;
      if(isPositive){
        gradient.addColorStop(0, colorWithAlpha(shadow,0.55));
        gradient.addColorStop(0.55, colorWithAlpha(base,0.62));
        gradient.addColorStop(1, colorWithAlpha(highlight,0.85));
      }else{
        gradient.addColorStop(0, colorWithAlpha(highlight,0.85));
        gradient.addColorStop(0.45, colorWithAlpha(base,0.62));
        gradient.addColorStop(1, colorWithAlpha(shadow,0.55));
      }
      return gradient;
    };
    const resolveBorderColor=(base)=>{
      if(base==='transparent') return base;
      return mixColor(base,palette.ink,0.45);
    };
    const resolveHoverFill=(ctx,base)=>{
      if(base==='transparent') return base;
      const lift=mixColor(base,'#ffffff',0.32);
      return colorWithAlpha(lift,0.9);
    };
    momDiffChart=new Chart(diffCanvas.getContext('2d'),{
      type:'bar',
      data:{
        labels,
        datasets:[{
          label:'Różnica skumulowana (A − B)',
          data:diffSeries,
          backgroundColor:(ctx)=>{
            const base=diffDatasetColor(ctx);
            return buildBarGradient(ctx,base);
          },
          borderColor:(ctx)=>resolveBorderColor(diffDatasetColor(ctx)),
          hoverBorderColor:(ctx)=>diffDatasetColor(ctx),
          hoverBackgroundColor:(ctx)=>resolveHoverFill(ctx,diffDatasetColor(ctx)),
          borderWidth:1.5,
          borderRadius:(ctx)=>{
            const value=ctx.raw;
            if(value===null||value===undefined) return 0;
            const radius=6;
            if(value>=0){
              return {topLeft:radius,topRight:radius,bottomLeft:2,bottomRight:2};
            }
            return {topLeft:2,topRight:2,bottomLeft:radius,bottomRight:radius};
          },
          borderSkipped:false,
          barPercentage:0.58,
          categoryPercentage:0.78,
          maxBarThickness:26
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'nearest',intersect:false},
        layout:{padding:{top:8,right:12,bottom:8,left:12}},
        animations:{
          y:{duration:600,easing:'easeOutQuart'},
          x:{duration:400,easing:'easeOutQuad'}
        },
        plugins:{
          legend:{display:false},
          tooltip:{
            filter:item=>item.raw!==null && item.raw!==undefined,
            callbacks:{
              title:items=>items[0]?`Dzień ${items[0].label}`:'',
              label:context=>`${fmt(context.parsed.y,state.currency)} (A − B)`,
              afterLabel:context=>{
                const value=context.parsed.y;
                if(!Number.isFinite(value)) return '';
                if(value>0) return 'Miesiąc A wydaje szybciej.';
                if(value<0) return 'Miesiąc B wydaje szybciej.';
                return 'Tempo wydatków jest identyczne.';
              }
            }
          }
        },
        scales:{
          x:{
            title:{display:true,text:'Dzień miesiąca'},
            grid:{display:false},
            ticks:{maxRotation:0}
          },
          y:{
            beginAtZero:true,
            ticks:{callback:currencyTicks},
            grid:{drawBorder:false,color:colorWithAlpha(palette.ink,0.08)}
          }
        }
      }
    });
    if(caption){
      const label=momCategoryLabel(selected);
      caption.textContent=`Aktualnie porównywana kategoria: ${label}.`;
    }
    if(diffCaption){
      diffCaption.textContent='Wartości dodatnie wskazują, że miesiąc A wyprzedza miesiąc B (wydano więcej).';
    }
  }


  // --- Recurring templates (variable expenses) --------------------------------
  function scheduledDateFor(tpl, ym){
    const d=Math.min(Math.max(1, Number(tpl.day)||1), daysInYm(ym));
    return `${ym}-${String(d).padStart(2,'0')}`;
  }
  function isLogged(templateId, ym){
    return (b().recurringLog||[]).some(r=>r.templateId===templateId && r.ym===ym);
  }
  function renderRecurringSuggestions(){
    const ym=b().workingMonth;
    const box=document.getElementById('rec-suggestions');
    const list=document.getElementById('rec-sugg-list');
    const monthLabel=document.getElementById('rec-sugg-month');
    monthLabel.textContent=ym;

    const candidates=(b().recurringTemplates||[])
      .map(t=>({t, date:scheduledDateFor(t,ym)}))
      .filter(x=>!isLogged(x.t.id, ym));

    if(candidates.length===0){ box.style.display='none'; }
    else{
      box.style.display='block';
      list.innerHTML='';
      for(const {t,date} of candidates){
        const summary = t.splits?.length
          ? `Split (${t.splits.length} pozycji)`
          : `${fmt(signFor(t.categoryId, num(t.amount)), state.currency)} • ${(catsById()[t.categoryId]?.name)||'—'}`;
        const div=document.createElement('div'); div.className='card';
        div.innerHTML=`
          <div class="row">
            <div><b>${t.label}</b> <span class="muted">(${date})</span></div>
            <div class="muted">${summary}</div>
          </div>
          <div class="row" style="margin-top:6px">
            <div class="tiny">${t.note||''}</div>
            <div style="display:flex;gap:6px">
              <button class="btn soft" data-act="add-date">Dodaj (na ${date})</button>
              <button class="btn soft" data-act="add-today">Dodaj na dziś</button>
              <button class="btn danger" data-act="dismiss">Odrzuć</button>
            </div>
          </div>`;
        div.querySelector('[data-act="add-date"]').onclick=()=>applyTemplate(t,date);
        div.querySelector('[data-act="add-today"]').onclick=()=>applyTemplate(t,new Date().toISOString().slice(0,10));
        div.querySelector('[data-act="dismiss"]').onclick=()=>{b().recurringLog.push({templateId:t.id,ym,action:'dismissed'}); save(state); renderAll();};
        list.appendChild(div);
      }
    }
    document.getElementById('rec-manage-toggle').onclick=()=>{
      const m=document.getElementById('rec-manage');
      m.style.display = m.style.display==='none' ? 'block' : 'none';
      if(m.style.display==='block'){renderRecurringManage()}
    }
  }
  function applyTemplate(tpl,date){
    const txBase={id:`tx_${Math.random().toString(36).slice(2)}`,date,accountId:tpl.accountId||b().accounts[0]?.id||'a_main',note:tpl.note||tpl.label};
    if(tpl.splits?.length){
      const total=tpl.splits.reduce((s,sp)=>s+signFor(sp.categoryId,num(sp.amount)),0);
      b().transactions.unshift({...txBase,categoryId:tpl.splits[0].categoryId,amount:total,splits:tpl.splits.map(s=>({categoryId:s.categoryId,amount:num(s.amount)}))});
    }else{
      const signed=signFor(tpl.categoryId, num(t.amount));
      b().transactions.unshift({...txBase,categoryId:tpl.categoryId,amount:signed});
    }
    b().recurringLog.push({templateId:tpl.id,ym:date.slice(0,7),action:'added'});
    save(state); renderAll();
  }
  function renderRecurringManage(){
    const form=document.getElementById('rec-add-form');
    const catSel=form.querySelector('select[name="categoryId"]'); catSel.innerHTML=''; for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}
    const accSel=form.querySelector('select[name="accountId"]'); accSel.innerHTML=''; for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id))}
    const isSplit=form.querySelector('input[name="isSplit"]');
    const singleBox=form.querySelector('[data-mode="single"]');
    const splitBox=form.querySelector('[data-mode="split"]');
    isSplit.onchange=()=>{singleBox.style.display=isSplit.checked?'none':'grid'; splitBox.style.display=isSplit.checked?'block':'none'}
    const splitTbody=form.querySelector('.rec-split-rows');
    function addRow(sp){const tr=document.createElement('tr'); tr.className='rec-split-row'; tr.innerHTML=`<td><select class="sp-cat"></select></td><td><input class="sp-amt" inputmode="decimal" value="${sp?String(sp.amount).replace('.',','):''}" /></td><td><button class="btn danger" type="button">X</button></td>`; const sel=tr.querySelector('.sp-cat'); for(const c of (b().categories||[])){sel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id,false, sp?sp.categoryId===c.id:false))} tr.querySelector('button').onclick=()=>{tr.remove()}; splitTbody.appendChild(tr); bindMoneyInputs(tr);}
    document.getElementById('rec-split-add').onclick=()=>addRow();
    form.onsubmit=(e)=>{
      e.preventDefault();
      const f=new FormData(form);
      const label=String(f.get('label')); const day=Number(f.get('day'));
      const accountId=String(f.get('accountId')||b().accounts[0]?.id||'a_main'); const note=String(f.get('note')||'');
      if(isSplit.checked){
        const rows=Array.from(splitTbody.querySelectorAll('.rec-split-row')); if(rows.length===0){alert('Dodaj wiersze split.'); return;}
        const splits=[]; for(const r of rows){const cat=r.querySelector('.sp-cat').value; const amt=num(r.querySelector('.sp-amt').value); if(!cat || !amt){alert('Uzupełnij kategorię i kwotę w każdym wierszu.'); return;} splits.push({categoryId:cat, amount:amt});}
        b().recurringTemplates.push({id:'rt_'+Math.random().toString(36).slice(2),label,day,accountId,note,splits});
      }else{
        const categoryId=String(f.get('categoryId')); const amount=num(f.get('amount')); if(!categoryId || !amount){alert('Uzupełnij kategorię i kwotę.'); return;}
        b().recurringTemplates.push({id:'rt_'+Math.random().toString(36).slice(2),label,day,accountId,categoryId,amount,note});
      }
      save(state); form.reset(); splitTbody.innerHTML=''; singleBox.style.display='grid'; splitBox.style.display='none'; isSplit.checked=false; renderRecurringManage();
    };
    const tbody=document.getElementById('rec-rows'); tbody.innerHTML='';
    for(const t of (b().recurringTemplates||[])){
      const mode=t.splits?.length?'split':'single';
      const summary = t.splits?.length ? t.splits.map(s=>`${(catsById()[s.categoryId]?.name)||'—'}: ${fmt(num(s.amount),state.currency)}`).join(' | ') : `${fmt(signFor(t.categoryId,num(t.amount)),state.currency)} • ${(catsById()[t.categoryId]?.name)||'—'}`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.label}</td><td>${t.day}</td><td>${mode}</td><td>${summary||'—'}</td><td>${(b().accounts||[]).find(a=>a.id===t.accountId)?.name||'—'}</td><td>${t.note||''}</td><td><button class="btn danger">Usuń</button></td>`;
      tr.querySelector('.btn').onclick=()=>{ if(!confirm('Usunąć szablon cykliczny?')) return; b().recurringTemplates=(b().recurringTemplates||[]).filter(x=>x.id!==t.id); b().recurringLog=(b().recurringLog||[]).filter(x=>x.templateId!==t.id); save(state); renderRecurringManage(); };
      tbody.appendChild(tr);
    }
    bindMoneyInputs(form);
  }

  // --- Safe render orchestrator ----------------------------------------------
  function safeRender(fn, name){ try{ fn(); } catch(err){ console.error('Render error:', name, err); } }

  function renderIncomes(){
    const ym=b().workingMonth; ensureMonth(ym);
    document.getElementById('inc-month').textContent=ym;
    const tbody=document.getElementById('inc-rows');tbody.innerHTML='';
    const sum=b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
    document.getElementById('inc-sum').textContent=fmt(sum,state.currency);
    for(const r of b().monthly[ym].incomes){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmt(r.amount,state.currency)}</td><td>${r.note||''}</td><td><button data-id="${r.id}" class="btn danger">Usuń</button></td>`;
      tr.querySelector('button').onclick=()=>{ if(!confirm('Na pewno usunąć ten przychód?')) return; b().monthly[ym].incomes=b().monthly[ym].incomes.filter(x=>x.id!==r.id); save(state); renderAll(); };
      tbody.appendChild(tr);
    }
  }

  function renderFixed(){
    const ym=b().workingMonth; ensureMonth(ym);
    document.getElementById('fix-month').textContent=ym;
    
    // NEW: Render suggestions from templates
    renderFixedSuggestions();

    // NEW: Setup manager toggle button
    document.getElementById('fix-manage-templates-btn').onclick=()=>{
      const manager = document.getElementById('fix-templates-manager');
      manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
      if(manager.style.display === 'block') renderFixedTemplatesManager();
    };

    const tbody=document.getElementById('fix-rows');tbody.innerHTML='';
    let unpaidSum = 0;
    const fixedForMonth = b().monthly[ym].fixed.sort((a,b) => (a.due||'').localeCompare(b.due||''));

    for(const r of fixedForMonth){
      if (!r.paid) unpaidSum += num(r.amount);
      let daysToDue = '';
      if (r.due) {
        const dueDate = new Date(r.due); const today = new Date(); today.setHours(0,0,0,0);
        const diffDays = Math.ceil((dueDate - today) / (1000*60*60*24));
        if (diffDays < 0) daysToDue = `<span class="bad">${Math.abs(diffDays)} dni po terminie</span>`;
        else if (diffDays <= 3) daysToDue = `<span class="warn">${diffDays} dni</span>`;
        else if (diffDays <= 7) daysToDue = `<span class="ok">${diffDays} dni</span>`;
        else daysToDue = `${diffDays} dni`;
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><label style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" ${r.paid?'checked':''}/> ${r.paid?'✅ Opłacone':'⏳ Do zapłaty'}</label></td><td>${r.title}</td><td>${fmt(r.amount,state.currency)}</td><td>${r.due||'—'}</td><td>${daysToDue}</td><td><button class="btn danger">Usuń</button></td>`;
      tr.querySelector('input').onchange=()=>{
        r.paid=!r.paid;

        const existingTxIndex = b().transactions.findIndex(tx => tx.linkedFixedId === r.id);
        if (existingTxIndex > -1) {
            b().transactions.splice(existingTxIndex, 1);
        }

        if(r.paid && b().createTxOnFixedPay){
          const date = r.due && new Date(r.due) <= new Date() ? r.due : new Date().toISOString().slice(0,10);
          b().transactions.unshift({
            id:`tx_${Math.random().toString(36).slice(2)}`,
            date,
            amount:-Math.abs(r.amount),
            categoryId:'c_fixed',
            accountId:b().accounts[0]?.id||'a_main',
            note:`Stały: ${r.title}`,
            linkedFixedId: r.id
          });
        }
        save(state); renderAll()
      };
      tr.querySelector('.btn').onclick=()=>{ if(!confirm('Usunąć ten stały wydatek?')) return; b().monthly[ym].fixed=b().monthly[ym].fixed.filter(x=>x.id!==r.id); save(state); renderAll() };
      tbody.appendChild(tr);
    }
    document.getElementById('fix-unpaid-sum').textContent = fmt(unpaidSum, state.currency);
    document.getElementById('autoTx').checked = !!b().createTxOnFixedPay;
    document.getElementById('payAllFixed').onclick = ()=>{
      const unpaid = b().monthly[ym].fixed.filter(f=>!f.paid);
      if(unpaid.length === 0) { alert('Wszystkie stałe wydatki na ten miesiąc są już opłacane.'); return; }
      if(!confirm(`Czy na pewno chcesz opłacić ${unpaid.length} pozycji?`)) return;
      for(const item of unpaid) {
        item.paid=true;
        if(b().createTxOnFixedPay){
            const txExists = b().transactions.some(tx => tx.linkedFixedId === item.id);
            if (!txExists) {
                const date = item.due && new Date(item.due) <= new Date() ? item.due : new Date().toISOString().slice(0,10);
                b().transactions.unshift({
                    id:`tx_${Math.random().toString(36).slice(2)}`,
                    date,
                    amount:-Math.abs(item.amount),
                    categoryId:'c_fixed',
                    accountId:b().accounts[0]?.id||'a_main',
                    note:`Stały: ${item.title}`,
                    linkedFixedId: item.id
                });
            }
        }
      }
      save(state); renderAll();
    };
  }

  function renderGoalsAndEOM(){ safeRender(renderEOM,'EOM'); safeRender(renderGoals,'Goals'); }

  function renderAll(){
    const ym=b().workingMonth;
    document.getElementById('workingMonth').textContent=ym;
    safeRender(renderDashboard,'Dashboard');
    safeRender(renderOverview,'Overview');
    safeRender(renderIncomes,'Incomes');
    safeRender(renderFixed,'Fixed');
    safeRender(renderVariable,'Variable');
    safeRender(renderCategories,'Categories');
    safeRender(renderMomComparison,'MoM');
    safeRender(renderGoalsAndEOM,'Goals+EOM');
    bindMoneyInputs();
  }
  renderAll();
  </script>
</body>
</html>