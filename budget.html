<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS — Budżet (ulepszona wersja)</title>
  <link rel="stylesheet" href="styles.css">
    <style>
    .row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .budget-tabs {
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 8;
      padding: 8px 0;
      margin-bottom: 0;
    }

    .trend {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .progress {
      height: 8px;
      background: #e2e8f0;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress > i {
      display: block;
      height: 100%;
      background: var(--ink);
    }

    .progress.good > i { background: var(--green); }
    .progress.warn > i { background: var(--orange); }

    .chart-box {
      height: 240px;
      position: relative;
      display: grid;
      place-items: center;
    }

    /* --- Investment Module v2 ------------------------------------------------- */
    .inv-shell { max-width:1320px; margin:0 auto; padding:8px 10px 24px; display:flex; flex-direction:column; gap:18px; }
    .inv-dashboard { display:grid; grid-template-columns:repeat(auto-fit,minmax(175px,1fr)); gap:10px; }
    .inv-kpi-card { background:var(--surface); border:1px solid rgba(148,163,184,0.2); border-radius:14px; padding:14px 16px; display:flex; flex-direction:column; gap:4px; }
    .inv-kpi-card .inv-kpi-label { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.03em; }
    .inv-kpi-card .inv-kpi-value { font-size:20px; font-weight:700; color:var(--ink); line-height:1.2; }
    .inv-kpi-card .inv-kpi-sub { font-size:11px; color:var(--muted); }
    .inv-kpi-card.positive .inv-kpi-value { color:#16a34a; }
    .inv-kpi-card.negative .inv-kpi-value { color:#dc2626; }
    .inv-kpi-card.accent { background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%); border-color:transparent; }
    .inv-kpi-card.accent .inv-kpi-label { color:rgba(255,255,255,.75); }
    .inv-kpi-card.accent .inv-kpi-value { color:#fff; }
    .inv-kpi-card.accent .inv-kpi-sub { color:rgba(255,255,255,.65); }

    .inv-trade-tabs { display:inline-flex; gap:0; border-radius:10px; overflow:hidden; border:1px solid rgba(148,163,184,.3); }
    .inv-trade-tab { border:none; background:transparent; padding:8px 20px; font-weight:600; font-size:13px; cursor:pointer; color:var(--muted); transition:all .2s; }
    .inv-trade-tab.is-active { background:#2563eb; color:#fff; }
    .inv-trade-tab.sell-active { background:#dc2626; color:#fff; }
    .inv-trade-grid { display:flex; flex-wrap:wrap; align-items:flex-end; gap:12px; margin-top:10px; }
    .inv-trade-field { display:flex; flex-direction:column; gap:4px; min-width:130px; flex:0 1 auto; font-size:13px; font-weight:500; }
    .inv-trade-field.grow { flex:1 1 180px; }
    .inv-trade-field input, .inv-trade-field select { height:38px; }
    .inv-trade-footnote { font-size:12px; color:var(--muted); width:100%; margin-top:2px; }
    @media(max-width:720px){ .inv-trade-grid{flex-direction:column;align-items:stretch} }

    .inv-sell-info { background:rgba(148,163,184,.08); border:1px solid rgba(148,163,184,.2); border-radius:10px; padding:10px 14px; font-size:13px; color:var(--ink); width:100%; line-height:1.6; }
    .inv-sell-info .pos { color:#16a34a; font-weight:600; }
    .inv-sell-info .neg { color:#dc2626; font-weight:600; }

    .inv-price-input { width:90px; height:30px; font-size:12px; text-align:right; border:1px solid rgba(148,163,184,.3); border-radius:6px; padding:0 6px; }
    .inv-pnl-pos { color:#16a34a; font-weight:600; }
    .inv-pnl-neg { color:#dc2626; font-weight:600; }
    .inv-pnl-na { color:var(--muted); font-style:italic; }

    .inv-side-buy { display:inline-block; padding:2px 8px; border-radius:6px; font-size:11px; font-weight:700; background:rgba(34,197,94,.12); color:#16a34a; }
    .inv-side-sell { display:inline-block; padding:2px 8px; border-radius:6px; font-size:11px; font-weight:700; background:rgba(239,68,68,.12); color:#dc2626; }
    .inv-source-badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600; background:rgba(148,163,184,.12); color:var(--muted); }

    .inv-trade-filters { display:inline-flex; gap:4px; padding:3px; border-radius:8px; background:rgba(148,163,184,.1); }
    .inv-trade-filter { border:none; background:transparent; padding:5px 12px; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; color:var(--muted); transition:all .15s; }
    .inv-trade-filter.is-active { background:#fff; color:var(--ink); box-shadow:0 2px 8px rgba(0,0,0,.08); }

    .inv-analytics-nav { display:inline-flex; gap:6px; padding:4px; border-radius:12px; background:rgba(148,163,184,.14); flex-wrap:wrap; }
    .inv-analytics-btn { border:none; background:transparent; padding:8px 12px; border-radius:10px; font-weight:600; font-size:13px; color:var(--muted); cursor:pointer; transition:background-color .2s,color .2s,box-shadow .2s; }
    .inv-analytics-btn:hover, .inv-analytics-btn:focus-visible { background:rgba(255,255,255,.7); color:var(--ink); outline:none; }
    .inv-analytics-btn.is-active { background:#fff; color:var(--ink); box-shadow:0 10px 28px rgba(15,23,42,.12); }
    .inv-analytics-panels { display:grid; gap:20px; margin-top:10px; }
    .inv-analytics-panel { display:none; }
    .inv-analytics-panel.is-active { display:block; }
    .inv-allocation-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; align-items:stretch; }

    .inv-modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,.35); backdrop-filter:blur(2px); display:none; align-items:center; justify-content:center; z-index:60; }
    .inv-modal { position:fixed; inset:0; margin:auto; max-width:1100px; max-height:90vh; overflow-y:auto; width:min(1080px,96vw); background:var(--surface); border-radius:20px; padding:18px 20px 20px; box-shadow:0 20px 60px rgba(15,23,42,.2); z-index:65; }
    .inv-modal[hidden], .inv-modal-backdrop[hidden] { display:none; }
    .inv-modal-body { display:grid; gap:12px; }
    .inv-asset-toolbar { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .inv-asset-toolbar .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .inv-asset-table { width:100%; border-collapse:collapse; }
    .inv-asset-table th, .inv-asset-table td { padding:10px; text-align:left; vertical-align:middle; }
    .inv-asset-table input, .inv-asset-table select { width:100%; height:38px; }
    .inv-asset-table .muted { font-size:12px; }
    .inv-asset-empty { padding:8px 0 0; }

    .dot { width:10px; height:10px; border-radius:999px; display:inline-block; background:var(--muted); }

    .inv-holdings-accordion { display:grid; gap:10px; }
    .inv-holding-group { border:1px solid rgba(148,163,184,.3); border-radius:14px; overflow:hidden; background:rgba(248,250,252,.7); }
    .inv-holding-group summary { list-style:none; cursor:pointer; padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .inv-holding-group summary::-webkit-details-marker { display:none; }
    .inv-holding-meta { display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:12px; }
    .inv-holding-kpis { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .inv-holding-kpis .pill { background:#fff; border:1px solid rgba(148,163,184,.35); }
    .inv-holding-details { padding:0 14px 12px; }

    /* --- Investment Analytics Hub ------------------------------------------- */
    .inv-hub-snapshot-bar { display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:8px; }
    .inv-hub-snapshot-bar .btn { white-space:nowrap; }
    .inv-hub-snapshot-bar .inv-hub-last-snap { font-size:12px; color:var(--muted); }

    .inv-hub-kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(155px,1fr)); gap:10px; margin-bottom:14px; }
    .inv-hub-kpi { background:var(--surface); border:1px solid rgba(148,163,184,.2); border-radius:12px; padding:12px 14px; display:flex; flex-direction:column; gap:2px; }
    .inv-hub-kpi .kpi-label { font-size:10px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.04em; }
    .inv-hub-kpi .kpi-val { font-size:18px; font-weight:700; color:var(--ink); }
    .inv-hub-kpi .kpi-sub { font-size:11px; color:var(--muted); }
    .inv-hub-kpi.positive .kpi-val { color:#16a34a; }
    .inv-hub-kpi.negative .kpi-val { color:#dc2626; }
    .inv-hub-kpi.accent { background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%); border-color:transparent; }
    .inv-hub-kpi.accent .kpi-label { color:rgba(255,255,255,.7); }
    .inv-hub-kpi.accent .kpi-val { color:#fff; }
    .inv-hub-kpi.accent .kpi-sub { color:rgba(255,255,255,.6); }

    .inv-hub-charts { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .inv-hub-chart-card { background:var(--surface); border:1px solid rgba(148,163,184,.18); border-radius:14px; padding:14px 16px; }
    .inv-hub-chart-card h4 { margin:0 0 8px; font-size:13px; font-weight:700; color:var(--ink); }
    .inv-hub-chart-box { height:220px; position:relative; }
    @media(max-width:920px){ .inv-hub-charts { grid-template-columns:1fr; } }

    .inv-hub-structure { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:14px; }
    .inv-hub-structure-card { background:var(--surface); border:1px solid rgba(148,163,184,.18); border-radius:14px; padding:14px 16px; }
    .inv-hub-structure-card h4 { margin:0 0 8px; font-size:13px; font-weight:700; }
    @media(max-width:920px){ .inv-hub-structure { grid-template-columns:1fr; } }

    .inv-hub-calc { background:var(--surface); border:1px solid rgba(148,163,184,.18); border-radius:14px; padding:16px 18px; margin-top:14px; }
    .inv-hub-calc h4 { margin:0 0 12px; font-size:14px; font-weight:700; }
    .inv-hub-calc-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; align-items:end; }
    .inv-hub-calc-field { display:flex; flex-direction:column; gap:4px; font-size:13px; font-weight:500; }
    .inv-hub-calc-field input, .inv-hub-calc-field select { height:38px; }
    .inv-hub-calc-result { margin-top:14px; padding:14px; background:rgba(37,99,235,.06); border:1px solid rgba(37,99,235,.18); border-radius:12px; }
    .inv-hub-calc-result .big { font-size:22px; font-weight:800; color:#2563eb; }
    .inv-hub-calc-result .detail { font-size:12px; color:var(--muted); margin-top:4px; }
    .inv-hub-calc-chart-box { height:380px; margin-top:16px; position:relative; }

    .inv-hub-streak { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:8px; background:rgba(37,99,235,.08); font-size:12px; font-weight:600; color:#2563eb; }
    .inv-hub-table { width:100%; border-collapse:collapse; font-size:13px; }
    .inv-hub-table th { text-align:left; font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; padding:8px 10px; border-bottom:1px solid rgba(148,163,184,.2); }
    .inv-hub-table td { padding:8px 10px; border-bottom:1px solid rgba(148,163,184,.1); }
    .inv-hub-table tr:last-child td { border-bottom:none; }
    .inv-hub-empty { text-align:center; padding:30px 0; color:var(--muted); font-size:13px; }

    details.card > summary { list-style:none; }
    details.card > summary::-webkit-details-marker { display:none; }
    details.card > summary::after { content:''; display:inline-block; width:0; height:0; border-left:5px solid transparent; border-right:5px solid transparent; border-top:6px solid var(--muted); margin-left:8px; transition:transform .2s; }
    details.card[open] > summary::after { transform:rotate(180deg); }

    /* --- EOM v2 Redesign ----------------------------------------------- */
    .eom2-shell { max-width:1320px; margin:0 auto; padding:8px 0 24px; display:flex; flex-direction:column; gap:16px; }
    .eom2-kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; }
    .eom2-kpi { background:var(--surface); border:1px solid rgba(148,163,184,.2); border-radius:14px; padding:14px 16px; display:flex; flex-direction:column; gap:3px; }
    .eom2-kpi .kpi-label { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.03em; }
    .eom2-kpi .kpi-val { font-size:22px; font-weight:700; color:var(--ink); line-height:1.2; }
    .eom2-kpi .kpi-sub { font-size:11px; color:var(--muted); }
    .eom2-kpi.positive .kpi-val { color:#16a34a; }
    .eom2-kpi.negative .kpi-val { color:#dc2626; }
    .eom2-kpi.accent { background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%); border-color:transparent; }
    .eom2-kpi.accent .kpi-label { color:rgba(255,255,255,.7); }
    .eom2-kpi.accent .kpi-val { color:#fff; }
    .eom2-kpi.accent .kpi-sub { color:rgba(255,255,255,.6); }

    .eom2-charts-row { display:flex; gap:16px; flex-wrap:wrap; }
    .eom2-bottleneck-row { display:flex; gap:16px; flex-wrap:wrap; }
    .eom2-bottleneck-row > * { flex:1; min-width:260px; }
    @media(max-width:768px){ .eom2-charts-row, .eom2-bottleneck-row { flex-direction:column; } }

    .eom2-booking-group { margin-bottom:12px; }
    .eom2-booking-group-title { display:flex; justify-content:space-between; gap:10px; align-items:center; font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.04em; padding:6px 0 4px; border-bottom:1px solid rgba(148,163,184,.15); margin-bottom:6px; }
    .eom2-booking-group-summary { font-size:11px; font-weight:600; text-transform:none; letter-spacing:0; }
    .eom2-booking-group-summary.pos { color:#16a34a; }
    .eom2-booking-group-summary.neg { color:#dc2626; }
    .eom2-booking-row { display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid rgba(148,163,184,.08); }
    .eom2-booking-row:last-child { border-bottom:none; }
    .eom2-booking-name { flex:1; min-width:120px; font-size:13px; font-weight:500; }
    .eom2-booking-name .type-badge { font-size:10px; font-weight:600; padding:1px 6px; border-radius:4px; margin-left:6px; }
    .eom2-booking-prev { min-width:100px; text-align:right; font-size:12px; color:var(--muted); }
    .eom2-booking-input { width:130px; }
    .eom2-booking-input input { width:100%; height:34px; text-align:right; font-weight:600; }
    .eom2-booking-delta { min-width:90px; text-align:right; font-size:12px; font-weight:600; }
    .eom2-booking-delta.pos { color:#16a34a; }
    .eom2-booking-delta.neg { color:#dc2626; }
    .eom2-booking-actions { min-width:30px; text-align:center; }
    .eom2-booking-actions button { background:none; border:none; cursor:pointer; color:var(--muted); font-size:14px; padding:2px 4px; }
    .eom2-booking-actions button:hover { color:#dc2626; }

    .eom2-gainer-item { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(148,163,184,.08); font-size:13px; }
    .eom2-gainer-item:last-child { border-bottom:none; }
    .eom2-gainer-name { font-weight:500; }
    .eom2-gainer-delta { font-weight:700; }
    .eom2-gainer-delta.pos { color:#16a34a; }
    .eom2-gainer-delta.neg { color:#dc2626; }

    .eom-hero {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .eom-dashboard-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      margin: 16px 0 12px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(248, 250, 252, 0.7);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
    }

    .eom-dashboard-tab {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      flex: 1 1 160px;
      text-align: center;
      background: rgba(148, 163, 184, 0.12);
      color: var(--muted);
      cursor: pointer;
      transition: background-color .25s ease, color .25s ease, box-shadow .25s ease;
    }

    .eom-dashboard-tab:hover,
    .eom-dashboard-tab:focus-visible {
      outline: none;
      color: var(--ink);
      background: rgba(37, 99, 235, 0.16);
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.12);
    }

    .eom-dashboard-tab.is-active {
      background: linear-gradient(135deg, var(--accent), rgba(37, 99, 235, 0.85));
      color: #fff;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.28);
    }

    .eom-dashboard-panels {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .eom-dashboard-panel {
      display: none;
    }

    .eom-dashboard-panel.is-active {
      display: block;
      animation: eomPanelFade 0.35s ease;
    }

    @keyframes eomPanelFade {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .eom-networth-section {
      margin-top: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 20px;
      background: var(--surface);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .eom-networth-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
    }

    .eom-networth-title {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .eom-networth-title .title {
      margin: 0;
      font-size: 20px;
    }

    .eom-networth-tabs {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.12);
    }

    .eom-networth-tab {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      background: transparent;
      color: var(--ink);
      cursor: pointer;
      transition: background .2s ease, color .2s ease, transform .2s ease;
    }

    .eom-networth-tab:hover {
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent);
    }

    .eom-networth-tab.is-active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 10px 18px rgba(37, 99, 235, 0.22);
      transform: translateY(-1px);
    }

    .eom-networth-chart-shell {
      position: relative;
      height: 400px;
      width: 100%;
      border-radius: 18px;
      overflow: hidden;
      background: linear-gradient(145deg, rgba(226, 232, 240, 0.4), rgba(248, 250, 252, 0.8));
    }

    .eom-networth-chart-shell canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .eom-networth-empty {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px;
      color: var(--muted);
      font-size: 14px;
      background: linear-gradient(145deg, rgba(226, 232, 240, 0.55), rgba(248, 250, 252, 0.85));
    }

    .eom-networth-empty.is-visible {
      display: flex;
    }

    .eom-history-controls {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }

    .eom-history-controls label {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #eom-history-range {
      min-width: 160px;
    }

    #eom-history-search {
      min-width: 200px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .eom-history-checkbox {
      flex-direction: row !important;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .eom-history-checkbox input {
      transform: translateY(1px);
    }

    .eom-history-table-shell {
      margin-top: 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 16px;
      background: linear-gradient(145deg, rgba(226, 232, 240, 0.35), rgba(248, 250, 252, 0.75));
      position: relative;
    }

    .eom-history-table-scroll {
      max-height: 500px;
      overflow: auto;
      border-radius: inherit;
    }

    .eom-history-table {
      width: 100%;
      min-width: 720px;
      border-collapse: separate;
      border-spacing: 0;
    }

    .eom-history-table thead th {
      position: sticky;
      top: 0;
      background: rgba(248, 250, 252, 0.95);
      backdrop-filter: blur(6px);
      z-index: 5;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-weight: 700;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
    }

    .eom-history-table thead th button {
      background: none;
      border: none;
      padding: 8px 12px;
      width: 100%;
      text-align: left;
      font: inherit;
      color: inherit;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .eom-history-table th, .eom-history-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    .eom-history-table tbody tr:last-child td {
      border-bottom: none;
    }

    .eom-history-table td {
      position: relative;
      background-clip: padding-box;
      transition: background-color .2s ease, box-shadow .2s ease;
      font-variant-numeric: tabular-nums;
    }

    .eom-history-table td:hover {
      box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.18);
    }

    .eom-history-value {
      font-weight: 600;
      color: var(--ink);
    }

    .eom-history-arrow {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 11px;
      opacity: 0.7;
    }

    .eom-history-arrow.positive { color: var(--green); }
    .eom-history-arrow.negative { color: var(--red); }
    .eom-history-arrow.neutral { color: var(--muted); }

    .eom-history-table td.positive {
      color: var(--ink);
    }

    .eom-history-table td.negative {
      color: var(--ink);
    }

    .eom-history-table td.networth {
      font-weight: 700;
    }

    .eom-history-table td.delta {
      font-weight: 600;
    }

    .eom-history-table thead button[data-sort-dir]::after {
      content: attr(data-sort-dir);
      font-size: 10px;
      font-weight: 700;
      color: var(--accent);
    }

    .eom-history-footer {
      margin-top: 14px;
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(37, 99, 235, 0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
      color: var(--ink);
    }

    .eom-history-footer strong {
      font-size: 18px;
    }

    .eom-history-footer .muted {
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .eom-networth-month-card {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 16px;
      padding: 16px;
      background: rgba(248, 250, 252, 0.65);
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    .eom-networth-month-card:hover {
      border-color: rgba(37, 99, 235, 0.4);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
    }

    .eom-networth-month-card.is-empty {
      justify-content: center;
      align-items: center;
      text-align: center;
      color: var(--muted);
      min-height: 110px;
    }

    .eom-networth-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .eom-networth-card-month {
      font-size: 13px;
      color: var(--ink);
      letter-spacing: 0.04em;
    }

    .eom-networth-card-total {
      font-size: clamp(28px, 3.4vw, 36px);
      font-weight: 700;
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }

    .eom-mom-section {
      margin-top: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 18px;
      background: var(--surface);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .eom-mom-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      justify-content: space-between;
    }

    .eom-mom-controls .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 170px;
    }

    .eom-mom-controls label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .eom-mom-controls select {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 8px 12px;
      font-size: 14px;
      background: rgba(248, 250, 252, 0.75);
      color: var(--ink);
    }

    .eom-mom-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .eom-mom-content {
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    .eom-mom-summary {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(248, 250, 252, 0.95);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
    }

    .eom-mom-summary-main {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
    }

    .eom-mom-summary-main .label {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .eom-mom-summary-main .value {
      font-size: clamp(24px, 2.8vw, 34px);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .eom-mom-summary-main .value.positive { color: var(--green); }
    .eom-mom-summary-main .value.negative { color: var(--red); }
    .eom-mom-summary-main .value.neutral { color: var(--muted); }

    .eom-mom-summary-text {
      font-size: 13px;
      color: var(--ink);
      line-height: 1.45;
    }

    .eom-mom-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .eom-mom-ranking {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(248, 250, 252, 0.85);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .eom-mom-ranking-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .eom-mom-ranking-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
    }

    .eom-mom-ranking .table-wrapper {
      overflow-x: auto;
    }

    .eom-mom-ranking table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .eom-mom-ranking tbody tr {
      cursor: pointer;
      transition: background-color .2s ease;
    }

    .eom-mom-ranking tbody tr:hover,
    .eom-mom-ranking tbody tr.is-highlighted {
      background: rgba(37, 99, 235, 0.08);
    }

    .eom-mom-change-bar {
      position: relative;
      padding: 6px 10px;
      border-radius: 12px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      overflow: hidden;
    }

    .eom-mom-change-bar::before {
      content: '';
      position: absolute;
      inset: 0;
      transform-origin: left center;
      transform: scaleX(var(--delta-progress, 0));
      background: rgba(34, 197, 94, 0.18);
      z-index: 0;
      transition: transform .3s ease;
    }

    .eom-mom-change-bar.negative::before {
      background: rgba(239, 68, 68, 0.18);
      transform-origin: right center;
    }

    .eom-mom-change-bar span {
      position: relative;
      z-index: 1;
    }

    .eom-mom-change-bar.negative span { color: var(--red); }
    .eom-mom-change-bar.positive span { color: var(--green); }
    .eom-mom-change-bar.neutral span { color: var(--muted); }

    .eom-mom-auto {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(248, 250, 252, 0.85);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .eom-mom-auto h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
    }

    .eom-mom-auto-list {
      display: grid;
      gap: 12px;
    }

    .eom-mom-auto-card {
      border-radius: 14px;
      border-left: 4px solid rgba(148, 163, 184, 0.4);
      background: rgba(255, 255, 255, 0.75);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: box-shadow .2s ease, transform .2s ease;
    }

    .eom-mom-auto-card .title {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .eom-mom-auto-card .description {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
    }

    .eom-mom-auto-card.success { border-left-color: rgba(34, 197, 94, 0.65); }
    .eom-mom-auto-card.warning { border-left-color: rgba(249, 115, 22, 0.75); }
    .eom-mom-auto-card.danger { border-left-color: rgba(239, 68, 68, 0.75); }
    .eom-mom-auto-card.info { border-left-color: rgba(59, 130, 246, 0.7); }

    .insight-pill.positive { background: rgba(34, 197, 94, 0.16); color: #166534; border-color: rgba(34, 197, 94, 0.38); }
    .insight-pill.negative { background: rgba(239, 68, 68, 0.16); color: #991b1b; border-color: rgba(239, 68, 68, 0.38); }
    .insight-pill.info { background: rgba(59, 130, 246, 0.14); color: #1d4ed8; border-color: rgba(59, 130, 246, 0.32); }
    .insight-pill.warning { background: rgba(249, 115, 22, 0.16); color: #b45309; border-color: rgba(249, 115, 22, 0.32); }
    .insight-pill.is-highlighted { border-color: rgba(37, 99, 235, 0.6); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.18); }
    .eom-mom-auto-card.is-highlighted { box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12); transform: translateY(-1px); }

    .eom-mom-empty {
      text-align: center;
      padding: 28px 16px;
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      color: var(--muted);
      background: rgba(248, 250, 252, 0.7);
    }

    @media (max-width: 959px) {
      .eom-dashboard-nav {
        gap: 6px;
        padding: 10px;
      }

      .eom-dashboard-tab {
        flex: 1 1 calc(50% - 6px);
      }

      .eom-mom-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .eom-mom-actions {
        justify-content: flex-start;
      }

      .eom-mom-summary {
        position: static;
      }
    }

    

    .eom-networth-card-delta {
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-variant-numeric: tabular-nums;
    }

    .eom-networth-card-delta.positive { color: var(--green); }
    .eom-networth-card-delta.negative { color: var(--red); }
    .eom-networth-card-delta.neutral { color: var(--muted); }

    .eom-networth-card-split {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .eom-networth-card-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .eom-networth-card-list > span {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .eom-networth-card-list ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .eom-networth-card-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(148, 163, 184, 0.14);
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }

    .eom-networth-card-list li.positive {
      background: rgba(34, 197, 94, 0.14);
      color: #166534;
    }

    .eom-networth-card-list li.negative {
      background: rgba(239, 68, 68, 0.14);
      color: #991b1b;
    }

    .eom-networth-card-list li span:last-child {
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .eom-networth-section {
        padding: 16px;
        gap: 14px;
      }

      .eom-networth-chart-shell {
        height: 280px;
      }

      .eom-networth-month-card {
        padding: 14px;
      }
    }

    .eom-hero-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .eom-performance-matrix {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    .eom-performance-column {
      background: var(--card);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 18px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .eom-performance-head {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .eom-performance-head .title {
      font-size: 18px;
      margin: 0;
    }

    .eom-performance-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .eom-performance-empty {
      border: 1px dashed rgba(148, 163, 184, 0.5);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      background: rgba(241, 245, 249, 0.45);
    }

    .eom-account-card {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-left-width: 4px;
      padding: 14px 16px;
      text-align: left;
      background: var(--card);
      color: var(--ink);
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      font: inherit;
    }

    .eom-account-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      border-color: var(--accent);
    }

    .eom-account-card.positive {
      border-left-color: var(--green);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(240, 253, 244, 0.65));
    }

    .eom-account-card.negative {
      border-left-color: var(--red);
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.12), rgba(254, 242, 242, 0.7));
    }

    .eom-account-card.is-focused {
      border-color: var(--accent);
      box-shadow: 0 14px 28px rgba(37, 99, 235, 0.18);
    }

    .eom-account-card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
    }

    .eom-account-name {
      font-weight: 600;
      font-size: 15px;
    }

    .eom-account-delta {
      font-weight: 600;
      font-size: 14px;
      font-variant-numeric: tabular-nums;
    }

    .eom-account-delta.positive { color: var(--green); }
    .eom-account-delta.negative { color: var(--red); }
    .eom-account-delta.attention { color: var(--orange); }

    .eom-account-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .eom-account-alert {
      align-self: flex-start;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: rgba(248, 113, 113, 0.14);
      color: var(--red);
      font-weight: 600;
    }

    .eom-account-card.positive .eom-account-alert {
      background: rgba(16, 185, 129, 0.14);
      color: var(--green);
    }

    .eom-account-spark {
      display: flex;
      align-items: center;
    }

    .eom-account-spark canvas {
      width: 100%;
      height: 30px;
      display: block;
    }

    .eom-account-card:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.35);
    }

    @media (max-width: 900px) {
      .eom-performance-matrix {
        grid-template-columns: 1fr;
      }
    }

    .eom-kpi-card {
      position: relative;
      padding: 14px 16px;
      border-radius: 18px;
      background: var(--card);
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      opacity: 0;
      transform: translateY(12px);
    }

    .eom-kpi-card.is-visible {
      animation: eomFadeUp .55s ease forwards;
      animation-delay: var(--eom-delay, 0s);
    }

    .eom-kpi-card:hover {
      transform: translateY(-3px);
      border-color: var(--accent);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
    }

    .eom-kpi-card.primary {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(37, 99, 235, 0.85));
      border: none;
      color: #fff;
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.25);
    }

    .eom-kpi-card.primary:hover {
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.35);
    }

    .eom-kpi-label {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .eom-kpi-card.primary .eom-kpi-label {
      color: rgba(255, 255, 255, 0.68);
    }

    .eom-kpi-icon {
      font-size: 20px;
      line-height: 1;
    }

    .eom-kpi-value {
      font-size: clamp(24px, 2.6vw, 30px);
      font-weight: 700;
      color: inherit;
      font-variant-numeric: tabular-nums;
    }

    .eom-kpi-meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .eom-kpi-card.primary .eom-kpi-meta {
      color: rgba(255, 255, 255, 0.75);
    }

    .eom-kpi-trend {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .eom-kpi-trend.positive {
      color: var(--green);
      font-weight: 600;
    }

    .eom-kpi-trend.negative {
      color: var(--red);
      font-weight: 600;
    }

    .eom-kpi-trend.neutral {
      color: var(--muted);
    }

    .eom-kpi-card.primary .eom-kpi-trend.neutral {
      color: rgba(255, 255, 255, 0.75);
    }

    .eom-kpi-card.primary .eom-kpi-trend.positive {
      color: #bbf7d0;
    }

    .eom-kpi-card.primary .eom-kpi-trend.negative {
      color: #fecaca;
    }

    .eom-hero-insights {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .eom-insight-pill {
      background: rgba(37, 99, 235, 0.12);
      color: var(--ink);
      border: 1px solid rgba(37, 99, 235, 0.2);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .eom-insight-pill.negative {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.18);
    }

    @keyframes eomFadeUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chart-box.tall { height: 320px; }
    .chart-box.wide { height: 280px; }

    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .quick-actions .quick-btn {
      display: flex;
      flex-direction: column;
      gap: 2px;
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      text-align: center;
      transition: all .2s ease;
      background: var(--surface);
    }

    .quick-actions .quick-btn:hover {
      border-style: solid;
      border-color: var(--blue);
      background: #eff6ff;
    }

    .heat-day {
      width: 22px;
      height: 22px;
      border-radius: 4px;
      display: grid;
      place-items: center;
      font-size: 10px;
    }

    .heatmap-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recent-calendar-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .recent-calendar {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 8px;
    }

    .recent-day {
      background: var(--surface);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 14px;
      padding: 8px 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
      transition: border-color .2s ease, transform .2s ease;
    }

    .recent-day:hover {
      border-color: rgba(59, 130, 246, 0.35);
      transform: translateY(-1px);
    }

    .recent-day-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 4px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .recent-day-header span {
      display: block;
      line-height: 1.1;
    }

    .recent-day-weekday {
      font-size: 10px;
      font-weight: 600;
    }

    .recent-day-date {
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
      text-transform: none;
      letter-spacing: 0.02em;
    }

    .recent-day-total {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }

    .recent-day-body {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .recent-entry {
      display: flex;
      gap: 6px;
      align-items: flex-start;
      padding: 4px 6px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: rgba(148, 163, 184, 0.08);
      transition: border-color .2s ease, background .2s ease;
      font-size: 10px;
    }

    .recent-entry-emoji {
      width: 20px;
      height: 20px;
      display: grid;
      place-items: center;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      line-height: 1;
      flex-shrink: 0;
    }

    .recent-entry-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .eom-control-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      margin-top: 16px;
      padding: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 14px;
      background: var(--surface);
    }

    .eom-account-config {
      margin: 12px 0;
      padding: 12px 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 14px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .eom-account-config-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .eom-account-config table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .eom-account-config th,
    .eom-account-config td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      text-align: left;
    }

    .eom-account-config select {
      min-width: 190px;
    }

    .eom-control-bar .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 180px;
    }

    .eom-grid-shell {
      margin-top: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 16px;
      background: var(--surface);
      overflow: hidden;
    }

    .eom-account-toolbar {
      margin-top: 12px;
      padding: 12px 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 14px;
      background: var(--surface);
      display: flex;
      flex-wrap: wrap;
      gap: 12px 16px;
      align-items: center;
      justify-content: space-between;
    }

    .eom-account-toolbar .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 16px;
      align-items: center;
    }

    .eom-account-toolbar label.tiny {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }

    .eom-account-toolbar select,
    .eom-account-toolbar .checkboxes {
      font-size: 13px;
    }

    .eom-account-toolbar .checkboxes {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .eom-account-toolbar .checkboxes label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--ink);
      cursor: pointer;
    }

    .eom-account-toolbar .bulk-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .eom-account-toolbar .count {
      font-size: 12px;
      color: var(--muted);
      margin-left: auto;
    }

    .eom-account-accordion {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      max-height: unset;
      overflow: visible;
    }

    .eom-grid-empty {
      padding: 24px;
      text-align: center;
      font-size: 14px;
      color: var(--muted);
    }

    .eom-account-item {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 16px;
      background: var(--card);
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      position: relative;
    }

    .eom-account-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
    }

    .eom-account-item.is-priority {
      border-color: rgba(37, 99, 235, 0.45);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.18);
    }

    .eom-account-item.is-focused {
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.35);
    }

    .eom-account-item.is-debt {
      border-color: rgba(220, 38, 38, 0.45);
      background: linear-gradient(120deg, rgba(248, 113, 113, 0.08), rgba(248, 250, 252, 0.85));
    }

    .eom-account-item.is-dormant {
      opacity: 0.7;
    }

    .eom-account-header {
      width: 100%;
      border: none;
      background: none;
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(140px, auto) minmax(120px, auto) 28px;
      gap: 12px;
      align-items: center;
      padding: 14px 18px;
      cursor: pointer;
    }

    .eom-account-header:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .eom-account-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
      text-align: left;
      min-width: 0;
    }

    .eom-account-title strong {
      font-size: 16px;
      color: var(--ink);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .eom-account-title span {
      font-size: 12px;
      color: var(--muted);
    }

    .eom-account-balance {
      font-size: 18px;
      font-weight: 700;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .eom-account-trend {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .eom-account-trend .arrow.up { color: var(--green); }
    .eom-account-trend .arrow.down { color: var(--red); }
    .eom-account-trend .arrow.flat { color: var(--muted); }
    .eom-account-trend.up { color: var(--green); }
    .eom-account-trend.down { color: var(--red); }
    .eom-account-trend.flat { color: var(--muted); }

    .eom-account-toggle-icon {
      font-size: 18px;
      color: var(--muted);
      transition: transform .2s ease;
    }

    .eom-account-item.is-expanded .eom-account-toggle-icon {
      transform: rotate(180deg);
      color: var(--accent);
    }

    .eom-account-body {
      overflow: hidden;
      max-height: 0;
      transition: max-height .3s ease;
    }

    .eom-account-item.is-expanded .eom-account-body {
      max-height: 500px;
    }

    .eom-account-body-inner {
      padding: 0 18px 18px;
      display: grid;
      grid-template-columns: minmax(220px, 1.2fr) minmax(200px, 1fr);
      gap: 18px;
    }

    .eom-account-body-inner > div {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .eom-account-spark-large canvas {
      width: 100%;
      height: 60px;
    }

    .eom-account-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(226, 232, 240, 0.35);
    }

    .eom-account-stats div {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .eom-account-stats div strong {
      font-size: 14px;
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }

    .eom-account-change {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .eom-account-change .delta {
      font-size: 15px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .eom-account-change .delta.positive { color: var(--green); }
    .eom-account-change .delta.negative { color: var(--red); }
    .eom-account-change .delta.neutral { color: var(--muted); }

    .eom-account-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .eom-account-body-inner .tiny.muted {
      line-height: 1.2;
    }

    .eom-account-item .tooltip-target {
      position: relative;
    }

    @media (max-width: 960px) {
      .eom-account-header {
        grid-template-columns: minmax(0, 1fr) minmax(100px, auto) minmax(90px, auto) 24px;
      }
      .eom-account-body-inner {
        grid-template-columns: 1fr;
      }
      .eom-account-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      .eom-account-toolbar .count {
        margin-left: 0;
      }
    }

    @media (max-width: 640px) {
      .eom-account-toolbar {
        padding: 12px;
      }
      .eom-account-header {
        padding: 12px 14px;
      }
      .eom-account-balance {
        font-size: 16px;
      }
      .eom-account-item.is-expanded .eom-account-body {
        max-height: 620px;
      }
    }

    .eom-pivot-table {
      width: 100%;
      border-collapse: collapse;
    }

    .eom-pivot-table th,
    .eom-pivot-table td {
      border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 8px 10px;
      font-size: 12px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .eom-pivot-table th:first-child,
    .eom-pivot-table td:first-child {
      text-align: left;
    }

    .eom-heatmap-shell {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .eom-heatmap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }

    .eom-heatmap-cell {
      padding: 12px;
      border-radius: 12px;
      background: rgba(226, 232, 240, 0.45);
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .eom-heatmap-cell strong {
      font-size: 13px;
    }

    .eom-heatmap-scale {
      display: flex;
      gap: 4px;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }

    .eom-heatmap-scale span {
      width: 24px;
      height: 8px;
      border-radius: 4px;
      background: var(--line);
    }

    .eom-insight-alert {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.12);
      color: var(--blue);
      font-size: 12px;
    }

    table tr.focused {
      background: rgba(59, 130, 246, 0.12);
    }

    .recent-entry-amount {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      font-size: 11px;
      line-height: 1.2;
      color: var(--ink);
    }

    .recent-entry-note {
      font-size: 9px;
      color: var(--muted);
      line-height: 1.2;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .recent-entry.top-spend {
      border-color: rgba(248, 113, 113, 0.55);
      background: rgba(248, 113, 113, 0.12);
    }

    .recent-entry.top-spend .recent-entry-emoji {
      background: rgba(248, 113, 113, 0.18);
    }

    .recent-entry.top-spend .recent-entry-amount {
      color: #b91c1c;
    }

    .recent-entry-hidden {
      display: none;
    }

    .recent-more {
      border: none;
      background: transparent;
      color: var(--blue);
      font-size: 9px;
      font-weight: 600;
      padding: 0;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      align-self: flex-start;
    }

    .recent-more::after {
      content: '›';
      font-size: 10px;
      transition: transform .2s ease;
    }

    .recent-day.expanded .recent-more::after {
      transform: rotate(90deg);
    }

    .recent-empty {
      font-size: 9px;
      color: var(--muted);
      text-align: center;
      padding: 8px 0 4px;
    }

    .recent-day.recent-day-empty {
      border-style: dashed;
    }

    .recent-day.recent-day-empty .recent-day-total {
      color: var(--muted);
    }

    @media (max-width: 1100px) {
      .recent-calendar {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
    }

    .heatmap-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--surface);
      max-height: 120px;
      overflow-y: auto;
    }

    .heat-legend {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
      color: #64748b;
    }

    .table-compact thead th,
    .table-compact tbody td {
      padding: 6px 8px;
      font-size: 12px;
      line-height: 1.25;
    }

    .table-compact tbody tr:nth-child(even) {
      background: transparent;
    }

    .editor-section {
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
      background: var(--surface);
    }

    .qa-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .qa-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .split-box {
      border: 1px dashed var(--line);
      padding: 8px;
      border-radius: 10px;
      background: var(--surface);
    }

    .banner {
      background: #ecfeff;
      border: 1px solid #cffafe;
      border-radius: 12px;
      padding: 10px;
    }

    .hint { font-size: 12px; color: #64748b; }

    .timeline-wrapper { position: relative; padding-top: 40px; margin-top: 16px; }
    .timeline-labels { position: relative; height: 30px; margin-bottom: 5px; }
    .timeline-label { position: absolute; bottom: 0; transform: translateX(-50%); background: var(--bg); border: 1px solid var(--line); font-size: 11px; padding: 2px 6px; border-radius: 6px; white-space: nowrap; }
    .timeline-label::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid var(--line); }
    .timeline-axis { display: flex; justify-content: space-between; font-size: 10px; color: var(--muted); border-top: 1px solid var(--line); padding-top: 4px; }
    .timeline-goals { position: relative; margin-top: 10px; }
    .timeline-bar { position: absolute; height: 24px; background: linear-gradient(90deg, var(--blue) 0%, var(--blue) 100%); border-radius: 6px; overflow: hidden; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; color: white; font-size: 12px; white-space: nowrap; }
    .timeline-bar .bar-label { font-weight: 500; }
    .timeline-bar .bar-progress { opacity: 0.7; }

    .analytics-cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

    .analytics-filter-card {
      margin-top: 12px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: 0 1px 2px rgb(15 23 42 / 0.08);
    }

    .analytics-filter-grid {
      margin-top: 12px;
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .analytics-filter-grid label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s ease;
    }

    .analytics-filter-grid label.active {
      border-color: var(--blue);
      background: #eff6ff;
    }

    .analytics-filter-grid label span {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .analytics-filter-actions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .analytics-summary { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .analytics-month-picker { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .analytics-month-chip { padding: 6px 10px; border-radius: 10px; border: 1px solid var(--line); background: #fff; cursor: pointer; font-size: 12px; transition: all .2s ease; }
    .analytics-month-chip.active { background: #0f172a; color: #fff; border-color: #0f172a; }
    .analytics-month-chip:hover { border-color: var(--blue); }

    .table-sortable th { position: relative; white-space: nowrap; }
    .table-sortable th[data-sort] { cursor: pointer; }
    .table-sortable th .sort-indicator { font-size: 10px; margin-left: 4px; color: var(--muted); }

    .th-label { display: inline-flex; align-items: center; gap: 4px; }

    .delta-up { color: var(--green); font-weight: 600; }
    .delta-down { color: var(--red); font-weight: 600; }
    .delta-neutral { color: var(--muted); font-weight: 500; }

    /* Analytics V2 */
    .an-kpi-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:10px; margin-top:12px; }
    .an-kpi { background:var(--surface); border:1px solid rgba(148,163,184,.15); border-radius:14px; padding:14px 16px; }
    .an-kpi-label { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.03em; }
    .an-kpi-val { font-size:22px; font-weight:700; line-height:1.2; margin-top:2px; }
    .an-kpi-sub { font-size:11px; color:var(--muted); margin-top:2px; }
    .an-kpi.accent { background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%); border-color:transparent; }
    .an-kpi.accent .an-kpi-label { color:rgba(255,255,255,.7); }
    .an-kpi.accent .an-kpi-val { color:#fff; }
    .an-kpi.accent .an-kpi-sub { color:rgba(255,255,255,.6); }
    .an-kpi.green .an-kpi-val { color:#16a34a; }
    .an-kpi.red .an-kpi-val { color:#dc2626; }

    .an-cat-bar-row { display:flex; align-items:center; gap:10px; padding:6px 0; border-bottom:1px solid rgba(148,163,184,.08); }
    .an-cat-bar-row:last-child { border-bottom:none; }
    .an-cat-bar-label { width:140px; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:0; }
    .an-cat-bar-track { flex:1; height:22px; background:rgba(148,163,184,.08); border-radius:6px; position:relative; overflow:hidden; }
    .an-cat-bar-fill { height:100%; border-radius:6px; transition:width .4s ease; display:flex; align-items:center; justify-content:flex-end; padding-right:6px; }
    .an-cat-bar-fill span { font-size:10px; font-weight:700; color:#fff; white-space:nowrap; }
    .an-cat-bar-amount { width:100px; text-align:right; font-size:13px; font-weight:600; flex-shrink:0; }
    .an-cat-bar-delta { width:80px; text-align:right; font-size:11px; flex-shrink:0; }

    .an-deviation-row { display:flex; align-items:center; gap:10px; padding:7px 0; border-bottom:1px solid rgba(148,163,184,.08); }
    .an-deviation-row:last-child { border-bottom:none; }
    .an-deviation-label { width:140px; font-size:13px; flex-shrink:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .an-deviation-bar-wrap { flex:1; height:20px; position:relative; display:flex; align-items:center; }
    .an-deviation-bar { height:14px; border-radius:4px; position:absolute; transition:width .4s,left .4s; }
    .an-deviation-center { position:absolute; left:50%; width:1px; height:100%; background:var(--muted); opacity:.3; }
    .an-deviation-val { width:100px; text-align:right; font-size:12px; font-weight:600; flex-shrink:0; }

    .an-anomaly-item { padding:10px 12px; border-radius:10px; margin-bottom:6px; display:flex; align-items:flex-start; gap:10px; font-size:13px; }
    .an-anomaly-item.warn { background:rgba(249,115,22,.08); border-left:3px solid #f97316; }
    .an-anomaly-item.danger { background:rgba(239,68,68,.08); border-left:3px solid #ef4444; }
    .an-anomaly-item.info { background:rgba(59,130,246,.06); border-left:3px solid #3b82f6; }
    .an-anomaly-item.ok { background:rgba(34,197,94,.06); border-left:3px solid #22c55e; }
    .an-anomaly-icon { font-size:18px; flex-shrink:0; margin-top:1px; }
    .an-anomaly-text { flex:1; line-height:1.4; }
    .an-anomaly-text strong { font-weight:700; }

    .an-heatmap-grid { display:grid; gap:2px; }
    .an-heatmap-cell { border-radius:3px; aspect-ratio:1; min-width:14px; }
    .an-heatmap-month { margin-bottom:12px; }
    .an-heatmap-month-label { font-size:12px; font-weight:700; margin-bottom:4px; color:var(--ink); }
    .an-heatmap-legend { display:flex; align-items:center; gap:4px; margin-top:10px; font-size:11px; color:var(--muted); }
    .an-heatmap-legend-cell { width:14px; height:14px; border-radius:3px; }

    .an-streak-row { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid rgba(148,163,184,.08); }
    .an-streak-row:last-child { border-bottom:none; }
    .an-streak-label { width:160px; font-size:13px; flex-shrink:0; }
    .an-streak-dots { display:flex; gap:3px; flex:1; flex-wrap:wrap; }
    .an-streak-dot { width:18px; height:18px; border-radius:4px; font-size:9px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; }
    .an-streak-stat { width:80px; text-align:right; font-size:12px; font-weight:600; flex-shrink:0; }

    .an-recurring-item { padding:8px 12px; border-radius:10px; border:1px solid rgba(148,163,184,.12); margin-bottom:6px; display:flex; align-items:center; gap:10px; font-size:13px; }
    .an-recurring-amount { font-weight:700; font-size:14px; flex-shrink:0; }
    .an-recurring-detail { flex:1; }
    .an-recurring-freq { font-size:11px; color:var(--muted); }

    .insight-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 12px;
      background: var(--surface);
      margin-right: 6px;
      margin-top: 4px;
      cursor: pointer;
      transition: box-shadow .2s ease, transform .2s ease, border-color .2s ease;
    }

    .insight-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }

    .eom-panel {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
    }

    .eom-panel .title { font-size: 18px; margin: 0 0 6px 0; }

    .table-modern thead th {
      background: #f1f5f9;
      font-weight: 600;
      font-size: 13px;
      color: #475569;
      border-bottom: 1px solid var(--line);
    }

    .table-modern tbody tr:nth-child(even) { background: #f8fafc; }
    .table-modern td { vertical-align: top; }

    .kpi-card {
      background: #0f172a;
      color: #fff;
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 120px;
    }

    .kpi-card.light {
      background: var(--surface);
      color: var(--ink);
      border: 1px solid var(--line);
    }

    .kpi-card .label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.7; }
    .kpi-card .value { font-size: 26px; font-weight: 700; }
    .kpi-card .sub { font-size: 12px; opacity: 0.8; }

    .kpi-trend { font-size: 12px; font-weight: 600; }
    .kpi-trend.trend-up { color: var(--green); }
    .kpi-trend.trend-down { color: var(--red); }
    .kpi-trend.trend-flat { color: var(--muted); }

    .mom-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .mom-control {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .mom-control select,
    .mom-control input[type="number"] {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 13px;
      background: #fff;
      min-width: 140px;
    }

    #mom-table tbody tr {
      cursor: pointer;
      transition: background .2s ease;
    }

    #mom-table tbody tr:hover { background: rgba(59, 130, 246, 0.1); }
    #mom-table tbody tr.active { background: rgba(59, 130, 246, 0.16); }

    .mom-summary { font-size: 12px; color: var(--muted); margin-top: 6px; }

    .mom-table-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .mom-table-header-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mom-detail-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding-inline: 16px;
      transition: all .25s ease;
      background: rgba(148, 163, 184, 0.16);
      color: var(--ink);
    }

    .mom-detail-button .icon {
      font-size: 16px;
    }

    .mom-detail-button:is(:hover,:focus-visible) {
      outline: none;
      background: rgba(37, 99, 235, 0.18);
      color: var(--accent);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.18);
      transform: translateY(-1px);
    }

    .mom-detail-button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .mom-detail-button.is-ready {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.18), rgba(37, 99, 235, 0.05));
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.22);
    }

    .card.mom-detail-shell,
    .card.mom-detail-shell:hover,
    .card.mom-detail-shell:focus-within,
    .card.mom-detail-shell:active {
      transform: none;
    }

    body.mom-detail-open #tab-mom.card,
    body.mom-detail-open #tab-mom.card:hover {
      transform: none;
      transition: none;
    }

    .mom-detail-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.38);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease;
      will-change: opacity;
      z-index: 1000;
    }

    .mom-detail-backdrop.is-visible {
      opacity: 1;
      pointer-events: auto;
    }

    .mom-detail-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: auto;
      width: min(1100px, 68vw);
      background: var(--surface);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: -24px 0 60px rgba(15, 23, 42, 0.22);
      opacity: 0;
      transform: translateX(36px);
      pointer-events: none;
      transition: opacity .28s ease, transform .28s ease;
      will-change: transform, opacity;
      z-index: 1001;
      --mom-detail-gutter: clamp(24px, 4vw, 56px);
    }

    .mom-detail-panel.is-visible {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }

    @media (max-width: 960px) {
      .mom-detail-panel {
        width: 100%;
        border-radius: 0;
      }
    }

    body.mom-detail-open {
      overflow: hidden;
    }

    .mom-detail-header {
      position: sticky;
      top: 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      padding: 28px var(--mom-detail-gutter) 20px;
      background: rgba(248, 250, 252, 0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      transition: padding 0.2s ease, backdrop-filter 0.2s ease;
      z-index: 10;
    }

    .mom-detail-header.scrolled {
      padding: 16px var(--mom-detail-gutter) 12px;
      backdrop-filter: blur(16px);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }

    .mom-detail-header.scrolled .mom-detail-title {
      font-size: 16px;
    }

    .mom-detail-header.scrolled .mom-detail-subtitle {
      display: none;
    }

    .mom-detail-heading {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mom-detail-breadcrumb {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    .mom-detail-breadcrumb::after {
      content: '';
    }

    .mom-detail-eyebrow {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .mom-detail-title {
      margin: 0;
      font-size: 20px;
      color: var(--ink);
    }

    .mom-detail-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .mom-detail-close {
      border: none;
      background: rgba(15, 23, 42, 0.06);
      color: var(--ink);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease, color .2s ease;
    }

    .mom-detail-close:hover,
    .mom-detail-close:focus-visible {
      outline: none;
      background: rgba(37, 99, 235, 0.18);
      color: #1d4ed8;
      transform: translateY(-1px);
    }

    .mom-detail-toolbar {
      position: sticky;
      top: 72px;
      z-index: 2;
      padding: 12px var(--mom-detail-gutter);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: rgba(248, 250, 252, 0.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
    }

    .mom-detail-tabs {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 2px;
      -webkit-overflow-scrolling: touch;
    }

    .mom-detail-tabs::-webkit-scrollbar {
      display: none;
    }

    .mom-detail-tab {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: rgba(148, 163, 184, 0.16);
      color: var(--muted);
      cursor: pointer;
      transition: background-color .25s ease, color .25s ease, box-shadow .25s ease, transform .2s ease;
      white-space: nowrap;
    }

    .mom-detail-tab:hover,
    .mom-detail-tab:focus-visible {
      outline: none;
      color: var(--ink);
      background: rgba(37, 99, 235, 0.16);
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.18);
      transform: translateY(-1px);
    }

    .mom-detail-tab.is-active {
      background: linear-gradient(135deg, var(--accent), rgba(37, 99, 235, 0.9));
      color: #fff;
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.32);
      transform: translateY(-2px);
    }

    .mom-detail-sort {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.18);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.35);
    }

    .mom-detail-sort[hidden] {
      display: none !important;
    }

    .mom-detail-sort button {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      color: var(--muted);
      transition: background .2s ease, color .2s ease, transform .2s ease;
    }

    .mom-detail-sort button.is-active {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(37, 99, 235, 0.32));
      color: #1d4ed8;
      box-shadow: 0 10px 18px rgba(37, 99, 235, 0.18);
      transform: translateY(-1px);
    }

    .mom-detail-sort button:not(.is-active):hover {
      color: #1d4ed8;
      background: rgba(37, 99, 235, 0.12);
    }

    .mom-detail-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 18px 0 48px;
    }

    .mom-detail-meta,
    .mom-detail-body {
      padding: 0 var(--mom-detail-gutter);
    }

    .mom-detail-meta {
      margin-bottom: 28px;
    }

    .mom-detail-body {
      display: flex;
      flex-direction: column;
      gap: 40px;
    }

    .mom-detail-tabpanels {
      display: flex;
      flex-direction: column;
      gap: 40px;
    }

    .mom-detail-tabpanel {
      display: none;
      opacity: 0;
      transform: translateY(16px);
    }

    .mom-detail-tabpanel.is-active {
      display: flex;
      flex-direction: column;
      gap: 40px;
      opacity: 1;
      transform: translateY(0);
      animation: momDetailTabFade 0.35s ease;
      will-change: opacity, transform;
    }

    @keyframes momDetailTabFade {
      from {
        opacity: 0;
        transform: translateY(18px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .mom-detail-section {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .mom-detail-hero {
      min-height: 180px;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: linear-gradient(140deg, rgba(226, 232, 240, 0.65), rgba(248, 250, 252, 0.9));
      padding: 36px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 12px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .mom-detail-hero-label {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mom-detail-hero-value {
      font-size: clamp(36px, 6vw, 48px);
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .mom-detail-hero-value.positive {
      color: #16a34a;
    }

    .mom-detail-hero-value.negative {
      color: #dc2626;
    }

    .mom-detail-hero-value.neutral {
      color: var(--ink);
    }

    .mom-detail-hero-change {
      font-size: 18px;
      font-weight: 600;
    }

    .mom-detail-hero-change.positive {
      color: #16a34a;
    }

    .mom-detail-hero-change.negative {
      color: #dc2626;
    }

    .mom-detail-hero-change.neutral {
      color: var(--ink);
    }

    .mom-detail-hero-summary {
      margin: 0;
      max-width: 540px;
      font-size: 15px;
      color: var(--ink);
    }

    .mom-detail-insights-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .mom-detail-insight-card {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.24);
      background: linear-gradient(135deg, rgba(226, 232, 240, 0.55), rgba(248, 250, 252, 0.88));
      padding: 16px 18px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .mom-detail-insight-icon {
      font-size: 22px;
      line-height: 1;
    }

    .mom-detail-insight-text {
      font-size: 14px;
      color: var(--ink);
      line-height: 1.45;
    }

    .mom-detail-forecast-block {
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding: 4px 0 0;
    }

    .mom-detail-forecast-heading {
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mom-detail-forecast-note {
      font-size: 13px;
      color: var(--muted);
      margin: 0;
    }

    .mom-detail-compare-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .mom-detail-compare-card {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.24);
      background: rgba(248, 250, 252, 0.86);
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mom-detail-compare-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mom-detail-compare-values {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .mom-detail-compare-delta {
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--muted);
    }

    .mom-detail-compare-delta .mom-detail-metric-delta {
      font-size: 13px;
    }

    .mom-detail-forecast {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mom-detail-forecast-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    }

    .mom-detail-forecast-card {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: linear-gradient(160deg, rgba(248, 250, 252, 0.96), rgba(226, 232, 240, 0.72));
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }

    .mom-detail-forecast-card::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.18;
      background: radial-gradient(circle at top right, rgba(37, 99, 235, 0.45), transparent 55%);
    }

    .mom-detail-forecast-card.optimistic {
      border-color: rgba(22, 163, 74, 0.32);
    }

    .mom-detail-forecast-card.optimistic::after {
      background: radial-gradient(circle at top right, rgba(22, 163, 74, 0.45), transparent 55%);
    }

    .mom-detail-forecast-card.pessimistic {
      border-color: rgba(220, 38, 38, 0.32);
    }

    .mom-detail-forecast-card.pessimistic::after {
      background: radial-gradient(circle at top right, rgba(220, 38, 38, 0.46), transparent 55%);
    }

    .mom-detail-forecast-card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    .mom-detail-forecast-card-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--ink);
    }

    .mom-detail-forecast-card-note {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
    }

    .mom-detail-forecast-card-meta {
      margin-top: auto;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .mom-detail-forecast-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .mom-detail-forecast-metric {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
      border: 1px solid rgba(148, 163, 184, 0.24);
    }

    .mom-detail-forecast-chart {
      position: relative;
      height: clamp(220px, 36vh, 320px);
      border-radius: 18px;
      padding: 16px;
      background: linear-gradient(145deg, rgba(226, 232, 240, 0.4), rgba(248, 250, 252, 0.86));
      border: 1px solid rgba(148, 163, 184, 0.24);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }

    .mom-detail-forecast-alert {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.5;
      border: 1px solid rgba(220, 38, 38, 0.32);
      background: rgba(254, 226, 226, 0.72);
      color: #991b1b;
    }

    .mom-detail-forecast-alert strong {
      font-weight: 600;
    }

    .mom-detail-forecast-alert-icon {
      font-size: 16px;
      line-height: 1;
      margin-top: 2px;
    }

    .mom-detail-patterns-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .mom-detail-pattern-card {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 18px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: linear-gradient(160deg, rgba(248, 250, 252, 0.95), rgba(226, 232, 240, 0.7));
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .mom-detail-pattern-icon {
      font-size: 22px;
      line-height: 1;
    }

    .mom-detail-pattern-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--ink);
    }

    .mom-detail-pattern-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }

    .mom-detail-heatmap {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mom-detail-heatmap-scroll {
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .mom-detail-heatmap-grid {
      display: grid;
      grid-template-columns: minmax(112px, 0.9fr) repeat(7, minmax(88px, 1fr));
      gap: 8px;
      align-items: stretch;
      min-width: 100%;
    }

    .mom-detail-heatmap-head {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mom-detail-heatmap-corner {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .mom-detail-heatmap-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      white-space: nowrap;
    }

    .mom-detail-heatmap-cell {
      position: relative;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--surface);
      min-height: 82px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
      text-align: left;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      cursor: pointer;
      color: var(--ink);
    }

    .mom-detail-heatmap-cell::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 14px;
      background: var(--mom-heat-bg, var(--surface));
      opacity: 1;
      z-index: 0;
      transition: opacity .2s ease;
    }

    .mom-detail-heatmap-cell > * {
      position: relative;
      z-index: 1;
    }

    .mom-detail-heatmap-cell:hover,
    .mom-detail-heatmap-cell:focus-visible {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.14);
      border-color: var(--mom-heat-border, rgba(148, 163, 184, 0.35));
      outline: none;
    }

    .mom-detail-heatmap-cell.is-empty {
      cursor: default;
    }

    .mom-detail-heatmap-cell.is-empty:hover,
    .mom-detail-heatmap-cell.is-empty:focus-visible {
      transform: none;
      box-shadow: none;
    }

    .mom-detail-heatmap-cell.is-top {
      border-width: 2px;
      border-color: var(--mom-heat-border, rgba(37, 99, 235, 0.45));
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.18);
    }

    .mom-detail-heatmap-total {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .mom-detail-heatmap-count {
      font-size: 12px;
      color: var(--muted);
    }

    .mom-detail-heatmap-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .mom-detail-heatmap-metric {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.32);
      background: linear-gradient(135deg, rgba(226, 232, 240, 0.3), rgba(248, 250, 252, 0.86));
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mom-detail-heatmap-metric-eyebrow {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .mom-detail-heatmap-metric-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      margin: 0;
    }

    .mom-detail-heatmap-metric-value {
      font-size: 13px;
      color: var(--ink);
    }

    .mom-detail-heatmap-tooltip {
      position: fixed;
      z-index: 1002;
      background: rgba(255, 255, 255, 0.98);
      color: var(--ink);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.22);
      padding: 14px 16px;
      max-width: min(320px, calc(100vw - 32px));
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transform: translateY(6px);
      transition: opacity .16s ease, transform .16s ease;
    }

    .mom-detail-heatmap-tooltip.is-visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .mom-detail-heatmap-tooltip-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 12px;
    }

    .mom-detail-heatmap-tooltip-label {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .mom-detail-heatmap-tooltip-day {
      font-size: 15px;
      font-weight: 600;
      color: var(--ink);
      flex: 1;
    }

    .mom-detail-heatmap-tooltip-total {
      font-size: 14px;
      font-weight: 600;
    }

    .mom-detail-heatmap-tooltip-count {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }

    .mom-detail-heatmap-tooltip-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 260px;
      overflow: hidden;
    }

    .mom-detail-heatmap-tooltip-item {
      display: grid;
      grid-template-columns: minmax(68px, auto) minmax(72px, auto) 1fr;
      gap: 10px;
      font-size: 12px;
      color: var(--ink);
    }

    .mom-detail-heatmap-tooltip-item-note {
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .mom-detail-heatmap-tooltip-empty {
      font-size: 12px;
      color: var(--muted);
    }

    .mom-detail-heatmap-tooltip-more {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.02em;
    }

    .mom-detail-contrib-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mom-detail-contrib-filter {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: rgba(15, 23, 42, 0.7);
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
    }

    .mom-detail-contrib-filter-input {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.06);
      border: 1px solid rgba(15, 23, 42, 0.12);
    }

    .mom-detail-contrib-filter-input input {
      width: 72px;
      border: 0;
      background: transparent;
      color: rgba(15, 23, 42, 0.9);
      font-size: 13px;
      font-weight: 600;
      padding: 0;
      appearance: textfield;
    }

    .mom-detail-contrib-filter-input input::-webkit-inner-spin-button,
    .mom-detail-contrib-filter-input input::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .mom-detail-contrib-top {
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(255, 255, 255, 0.9);
      padding: 12px 16px;
    }

    .mom-detail-contrib-top > summary {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      color: rgba(15, 23, 42, 0.78);
      list-style: none;
    }

    .mom-detail-contrib-top > summary::-webkit-details-marker {
      display: none;
    }

    .mom-detail-contrib-count {
      font-size: 12px;
      font-weight: 500;
      color: rgba(15, 23, 42, 0.6);
    }

    .mom-detail-contrib-table-wrap {
      overflow-x: auto;
      margin-top: 12px;
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255, 255, 255, 0.92);
      box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.04);
    }

    .mom-detail-contrib-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 520px;
    }

    .mom-detail-contrib-table thead th {
      text-align: left;
      padding: 10px 16px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: rgba(15, 23, 42, 0.55);
      background: rgba(15, 23, 42, 0.04);
    }

    .mom-detail-contrib-table tbody td {
      padding: 12px 16px;
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      vertical-align: middle;
      font-size: 13px;
      color: rgba(15, 23, 42, 0.82);
    }

    .mom-detail-contrib-table tbody tr:first-child td {
      border-top: 0;
    }

    .mom-detail-contrib-table tbody tr:hover td,
    .mom-detail-contrib-table tbody tr:focus-within td {
      background: rgba(15, 23, 42, 0.03);
    }

    .mom-detail-contrib-date {
      font-weight: 600;
      white-space: nowrap;
    }

    .mom-detail-contrib-amount {
      font-weight: 600;
      color: rgba(15, 23, 42, 0.88);
    }

    .mom-detail-contrib-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      margin-right: 10px;
      font-size: 12px;
      font-weight: 700;
    }

    .mom-detail-contrib-badge.month-a {
      background: rgba(34, 197, 94, 0.14);
      color: rgb(22, 163, 74);
    }

    .mom-detail-contrib-badge.month-b {
      background: rgba(59, 130, 246, 0.14);
      color: rgb(37, 99, 235);
    }

    .mom-detail-contrib-note {
      color: rgba(15, 23, 42, 0.7);
      max-width: 320px;
      line-height: 1.35;
      word-break: break-word;
    }

    .mom-detail-contrib-note .muted {
      color: rgba(15, 23, 42, 0.45);
      font-style: italic;
    }

    .mom-detail-contrib-impact {
      font-weight: 700;
      white-space: nowrap;
    }

    .mom-detail-contrib-impact.positive {
      color: rgb(22, 163, 74);
    }

    .mom-detail-contrib-impact.negative {
      color: rgb(239, 68, 68);
    }

    .mom-detail-contrib-impact.neutral {
      color: rgba(15, 23, 42, 0.55);
    }

    .mom-detail-contrib-unique {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(244, 114, 182, 0.16);
      color: rgb(219, 39, 119);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mom-detail-contrib-toggle {
      align-self: flex-start;
      border: 1px solid rgba(15, 23, 42, 0.14);
      border-radius: 999px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.92);
      color: rgba(15, 23, 42, 0.82);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .mom-detail-contrib-toggle:hover,
    .mom-detail-contrib-toggle:focus-visible {
      background: rgba(15, 23, 42, 0.08);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
    }

    .mom-detail-contrib-toggle:disabled,
    .mom-detail-contrib-toggle[disabled] {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
    }

    .mom-detail-contrib-all[hidden] {
      display: none;
    }

    .mom-detail-contrib-empty {
      text-align: center;
      padding: 24px;
      color: rgba(15, 23, 42, 0.6);
      font-size: 14px;
      border: 1px dashed rgba(15, 23, 42, 0.2);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.7);
    }

    @media (max-width: 720px) {
      .mom-detail-heatmap-grid {
        grid-template-columns: minmax(96px, 0.8fr) repeat(7, minmax(72px, 1fr));
      }

      .mom-detail-heatmap-cell {
        min-height: 72px;
        padding: 10px;
      }
    }

    .mom-detail-waterfall-chart {
      position: relative;
      height: clamp(260px, 45vh, 360px);
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(226, 232, 240, 0.45), rgba(248, 250, 252, 0.9));
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 12px;
    }

    .mom-detail-waterfall-chart canvas {
      width: 100%;
      height: 100%;
    }

    .mom-detail-section-footnote {
      margin: -6px 0 0;
      font-size: 11px;
      color: var(--muted);
    }

    .mom-detail-section-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
      flex-wrap: wrap;
    }

    .mom-detail-section-title {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
      color: var(--ink);
    }

    .mom-detail-section-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }

    .mom-detail-kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      grid-auto-rows: minmax(100px, auto);
    }

    @media (max-width: 1100px) {
      .mom-detail-kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 620px) {
      .mom-detail-kpi-grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }

    .mom-detail-kpi-card {
      --mom-kpi-start: rgba(37, 99, 235, 0.12);
      --mom-kpi-stop: rgba(37, 99, 235, 0.32);
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 14px 16px;
      border-radius: 18px;
      background: linear-gradient(135deg, var(--mom-kpi-start), var(--mom-kpi-stop));
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.35), 0 16px 32px rgba(15, 23, 42, 0.12);
      min-height: unset;
    }

    .mom-detail-kpi-card .label {
      font-size: 10px;
      line-height: 1.3;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(15, 23, 42, 0.7);
    }

    .mom-detail-kpi-value {
      font-size: 24px;
      font-weight: 700;
      line-height: 1.2;
      color: var(--ink);
      margin: 0;
    }

    .mom-detail-kpi-trend {
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .mom-detail-kpi-card.month-a {
      --mom-kpi-start: rgba(14, 165, 233, 0.16);
      --mom-kpi-stop: rgba(14, 165, 233, 0.4);
      min-height: 100px;
    }

    .mom-detail-kpi-card.month-b {
      --mom-kpi-start: rgba(249, 115, 22, 0.16);
      --mom-kpi-stop: rgba(249, 115, 22, 0.4);
      min-height: 100px;
    }

    .mom-detail-kpi-card.positive {
      --mom-kpi-start: rgba(34, 197, 94, 0.14);
      --mom-kpi-stop: rgba(16, 185, 129, 0.38);
      min-height: 110px;
    }

    .mom-detail-kpi-card.negative {
      --mom-kpi-start: rgba(239, 68, 68, 0.16);
      --mom-kpi-stop: rgba(239, 68, 68, 0.42);
      min-height: 110px;
    }

    .mom-detail-kpi-card.neutral {
      --mom-kpi-start: rgba(148, 163, 184, 0.1);
      --mom-kpi-stop: rgba(148, 163, 184, 0.24);
      min-height: 110px;
    }

    .mom-detail-kpi-card.positive .mom-detail-kpi-value,
    .mom-detail-kpi-card.negative .mom-detail-kpi-value {
      font-size: 28px;
      font-weight: 800;
    }

    .mom-detail-kpi-trend.positive { color: #047857; }
    .mom-detail-kpi-trend.negative { color: #b91c1c; }
    .mom-detail-kpi-trend.neutral { color: var(--muted); }

    .mom-detail-metric-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, auto);
      gap: 16px 20px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: rgba(248, 250, 252, 0.76);
    }

    @media (max-width: 640px) {
      .mom-detail-metric-grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
        grid-template-rows: auto;
      }
    }

    .mom-detail-metric {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mom-detail-metric-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    .mom-detail-metric-values {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px 12px;
    }

    .mom-detail-metric-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.05);
      font-size: 11px;
      font-weight: 600;
      color: var(--ink);
    }

    .mom-detail-metric-chip span {
      font-weight: 700;
    }

    .mom-detail-metric-delta {
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
    }

    .mom-detail-advanced-grid {
      margin-top: 20px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .mom-detail-advanced-card {
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: 16px;
      background: rgba(248, 250, 252, 0.75);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.08);
    }

    .mom-detail-advanced-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-weight: 600;
      color: var(--ink);
    }

    .mom-detail-advanced-values {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .mom-detail-advanced-rows {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mom-detail-advanced-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mom-detail-advanced-row-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .mom-detail-advanced-row-values {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .mom-detail-advanced-empty {
      font-size: 12px;
      color: var(--muted);
    }

    .mom-detail-metric-help {
      position: relative;
      border: none;
      border-radius: 999px;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent);
      font-weight: 700;
      cursor: help;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .mom-detail-metric-help:hover,
    .mom-detail-metric-help:focus-visible {
      outline: none;
      transform: translateY(-1px);
      background: rgba(37, 99, 235, 0.18);
    }

    .mom-detail-metric-help::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%) translateY(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      background: rgba(15, 23, 42, 0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.32);
      width: max(220px, min(280px, 70vw));
      font-size: 12px;
      line-height: 1.4;
      text-align: left;
      z-index: 5;
      white-space: normal;
    }

    .mom-detail-metric-help:focus-visible::after,
    .mom-detail-metric-help:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .mom-detail-metric-help::before {
      content: '';
      position: absolute;
      bottom: calc(100% - 2px);
      left: 50%;
      transform: translateX(-50%);
      border-width: 6px;
      border-style: solid;
      border-color: rgba(15, 23, 42, 0.92) transparent transparent transparent;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .mom-detail-metric-help:focus-visible::before,
    .mom-detail-metric-help:hover::before {
      opacity: 1;
    }

    .mom-detail-boxplot {
      margin-top: 16px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.04);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .mom-detail-boxplot-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mom-detail-boxplot-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mom-detail-boxplot-label {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .mom-detail-boxplot-track {
      position: relative;
      height: 28px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.18);
      overflow: hidden;
    }

    .mom-detail-boxplot-whisker,
    .mom-detail-boxplot-box,
    .mom-detail-boxplot-median {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
    }

    .mom-detail-boxplot-whisker {
      height: 4px;
      background: rgba(15, 23, 42, 0.25);
      min-width: 4px;
      border-radius: 2px;
    }

    .mom-detail-boxplot-box {
      height: 14px;
      border-radius: 6px;
      min-width: 6px;
      border: 2px solid rgba(37, 99, 235, 0.45);
      background: rgba(37, 99, 235, 0.2);
    }

    .mom-detail-boxplot-row.month-b .mom-detail-boxplot-box {
      border-color: rgba(244, 114, 182, 0.55);
      background: rgba(244, 114, 182, 0.2);
    }

    .mom-detail-boxplot-median {
      width: 2px;
      height: 22px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 1px;
    }

    .mom-detail-boxplot-values {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .mom-detail-boxplot-scale {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.04em;
    }

    .mom-detail-boxplot-row.is-empty .mom-detail-boxplot-track {
      display: none;
    }

    .mom-detail-boxplot-row.is-empty .mom-detail-boxplot-values {
      color: var(--muted);
    }

    .mom-detail-metric-delta.positive { color: #047857; }
    .mom-detail-metric-delta.negative { color: #b91c1c; }
    .mom-detail-metric-delta.neutral { color: var(--muted); }

    .mom-detail-highlight {
      margin-top: 18px;
      padding: 16px 18px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: linear-gradient(120deg, rgba(37, 99, 235, 0.08), rgba(37, 99, 235, 0));
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mom-detail-highlight.neutral {
      background: linear-gradient(120deg, rgba(148, 163, 184, 0.1), rgba(148, 163, 184, 0));
    }

    .mom-detail-highlight-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--ink);
    }

    .mom-detail-highlight-note {
      font-size: 12px;
      color: var(--muted);
    }

    .mom-detail-calendar {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .mom-detail-calendar-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .mom-detail-calendar-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(226, 232, 240, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .mom-detail-calendar-pill::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .mom-detail-calendar-pill.month-a::before {
      background: rgba(37, 99, 235, 0.85);
    }

    .mom-detail-calendar-pill.month-b::before {
      background: rgba(16, 185, 129, 0.85);
    }

    .mom-detail-calendar-pill.delta::before {
      background: rgba(148, 163, 184, 0.7);
    }

    .mom-detail-calendar-pill.delta.positive::before {
      background: rgba(34, 197, 94, 0.75);
    }

    .mom-detail-calendar-pill.delta.negative::before {
      background: rgba(239, 68, 68, 0.75);
    }

    .mom-detail-calendar-pill.delta.neutral::before {
      background: rgba(148, 163, 184, 0.7);
    }

    .mom-detail-calendar-pill.delta.positive {
      color: #047857;
    }

    .mom-detail-calendar-pill.delta.negative {
      color: #b91c1c;
    }

    .mom-detail-calendar-heading,
    .mom-detail-daylist-heading {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 16px;
      flex-wrap: wrap;
    }

    .mom-detail-calendar-title,
    .mom-detail-daylist-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--ink);
    }

    .mom-detail-calendar-subtitle,
    .mom-detail-daylist-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .mom-detail-calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 12px;
    }

    .mom-detail-calendar-weekday {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
      text-align: center;
      padding: 2px 0;
    }

    .mom-detail-calendar-cell {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(248, 250, 252, 0.85);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 110px;
      position: relative;
    }

    .mom-detail-calendar-cell.is-empty {
      background: rgba(248, 250, 252, 0.4);
      border-style: dashed;
      min-height: 80px;
      opacity: 0.5;
    }

    .mom-detail-calendar-cell.placeholder {
      background: transparent;
      border: none;
      min-height: 0;
      padding: 0;
    }

    .mom-detail-calendar-cell.positive {
      border-color: rgba(239, 68, 68, 0.3);
      background: linear-gradient(150deg, rgba(239, 68, 68, 0.08), rgba(255, 255, 255, 0.92));
    }

    .mom-detail-calendar-cell.negative {
      border-color: rgba(34, 197, 94, 0.3);
      background: linear-gradient(150deg, rgba(34, 197, 94, 0.08), rgba(255, 255, 255, 0.92));
    }

    .mom-detail-calendar-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .mom-detail-calendar-day {
      font-weight: 600;
      color: var(--ink);
      font-size: 13px;
    }

    .mom-detail-calendar-delta {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 7px;
      border-radius: 999px;
      white-space: nowrap;
      background: rgba(148, 163, 184, 0.18);
      color: var(--ink);
    }

    .mom-detail-calendar-cell.positive .mom-detail-calendar-delta {
      background: rgba(239, 68, 68, 0.16);
      color: var(--red);
    }

    .mom-detail-calendar-cell.negative .mom-detail-calendar-delta {
      background: rgba(34, 197, 94, 0.16);
      color: var(--green);
    }

    .mom-detail-calendar-tracks {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mom-detail-calendar-track {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mom-detail-calendar-track-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .mom-detail-calendar-badge {
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--mom-badge-bg, rgba(148, 163, 184, 0.18));
      color: var(--mom-badge-color, var(--muted));
    }

    .mom-detail-calendar-amount {
      font-size: 12px;
      font-weight: 600;
      color: var(--ink);
    }

    .mom-detail-calendar-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mom-detail-calendar-entry {
      font-size: 11px;
      color: var(--ink);
      line-height: 1.3;
    }

    .mom-detail-calendar-entry .muted {
      color: var(--muted);
    }

    .mom-detail-calendar-entry strong {
      font-weight: 600;
      color: var(--ink);
      margin-right: 6px;
    }

    .mom-detail-calendar-note {
      display: inline;
    }

    .mom-detail-daylist {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 18px;
    }

    .mom-detail-daylist-panel {
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 18px;
      background: rgba(248, 250, 252, 0.72);
      padding: 12px 16px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    .mom-detail-daylist-panel > summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      list-style: none;
    }

    .mom-detail-daylist-panel > summary::-webkit-details-marker {
      display: none;
    }

    .mom-detail-daylist-panel > summary::after {
      content: '▼';
      font-size: 12px;
      color: var(--muted);
    }

    .mom-detail-daylist-panel[open] {
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
      border-color: rgba(37, 99, 235, 0.28);
    }

    .mom-detail-daylist-panel[open] > summary {
      margin-bottom: 14px;
      color: #1d4ed8;
    }

    .mom-detail-daylist-panel[open] > summary::after {
      content: '▲';
      color: #1d4ed8;
    }

    .mom-detail-daylist-section {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .mom-detail-day {
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(248, 250, 252, 0.85);
    }

    .mom-detail-day.positive {
      border-left: 4px solid rgba(239, 68, 68, 0.5);
    }

    .mom-detail-day.negative {
      border-left: 4px solid rgba(34, 197, 94, 0.5);
    }

    .mom-detail-day-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }

    .mom-detail-day-title {
      font-weight: 600;
      color: var(--ink);
    }

    .mom-detail-day-subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-top: 1px;
    }

    .mom-detail-day-subline {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .mom-detail-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(148, 163, 184, 0.16);
      color: var(--ink);
      white-space: nowrap;
    }

    .mom-detail-badge.positive {
      background: rgba(239, 68, 68, 0.16);
      color: var(--red);
    }

    .mom-detail-badge.negative {
      background: rgba(34, 197, 94, 0.16);
      color: var(--green);
    }

    .mom-detail-columns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .mom-detail-month {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mom-detail-month-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .mom-detail-month-count {
      font-size: 10px;
      font-weight: 600;
      color: var(--ink);
      background: rgba(148, 163, 184, 0.16);
      padding: 2px 7px;
      border-radius: 999px;
    }

    .mom-detail-entry {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      border-radius: 12px;
      padding: 9px 11px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .mom-detail-entry-amount {
      font-weight: 600;
      color: var(--ink);
      white-space: nowrap;
      font-size: 13px;
    }

    .mom-detail-entry-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .mom-detail-entry-note {
      font-size: 12px;
      color: var(--ink);
      line-height: 1.35;
    }

    .mom-detail-entry-note .muted {
      color: var(--muted);
    }

    .mom-detail-month-empty {
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      font-size: 12px;
      text-align: center;
      color: var(--muted);
      background: rgba(248, 250, 252, 0.6);
    }

    .mom-detail-empty {
      padding: 24px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      grid-column: 1 / -1;
    }

    @media (max-width: 1280px) {
      .mom-detail-overview {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 900px) {
      .mom-detail-panel {
        border-radius: 18px;
      }

      .mom-detail-header {
        flex-direction: column;
        align-items: stretch;
        padding: 20px 20px 12px;
      }

      .mom-detail-meta {
        padding: 0 20px 20px;
      }

      .mom-detail-body {
        padding: 0 20px 24px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }

    @media (max-width: 720px) {
      .mom-detail-header {
        flex-direction: column;
        align-items: stretch;
      }

      .mom-detail-header-actions {
        justify-content: space-between;
      }

      .mom-detail-columns {
        grid-template-columns: 1fr;
      }

      .mom-detail-body {
        grid-template-columns: 1fr;
      }
    }


    .chart-empty {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>
<body data-page="budget">
  <div class="layout">
    <aside class="sidebar" aria-label="Główna nawigacja">
      <div class="sidebar__header">
        <span class="sidebar__emoji">🧭</span>
        <span class="sidebar__brand">LifeOS</span>
      </div>
      <nav class="sidebar__nav" aria-label="Sekcje LifeOS">
        <ul class="sidebar__list">
          <li class="sidebar__item">
            <a class="sidebar__link" href="index.html" data-page="dashboard">
              <span class="sidebar__icon">📊</span>
              <span class="sidebar__label">Dashboard</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="budget.html" data-page="budget">
              <span class="sidebar__icon">💰</span>
              <span class="sidebar__label">Budżet</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="tasks.html" data-page="tasks">
              <span class="sidebar__icon">✅</span>
              <span class="sidebar__label">Zadania</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="trainings.html" data-page="trainings">
              <span class="sidebar__icon">💪</span>
              <span class="sidebar__label">Progres</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="fuel.html" data-page="fuel">
              <span class="sidebar__icon">⛽</span>
              <span class="sidebar__label">Paliwo</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="loan.html" data-page="loan">
              <span class="sidebar__icon">🏦</span>
              <span class="sidebar__label">Kredyt</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="inventory.html" data-page="inventory">
              <span class="sidebar__icon">📦</span>
              <span class="sidebar__label">Magazyn</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="house.html" data-page="house">
              <span class="sidebar__icon">🏠</span>
              <span class="sidebar__label">Budowa</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar__footer">
        <strong>Twój cyfrowy dom</strong>
        Zarządzaj budżetem, zadaniami i celami w jednym miejscu.
      </div>
    </aside>

    <div class="main">
      <header class="page-header" role="banner">
        <div class="page-header__top">
          <span class="page-overline">Finanse</span>
          <h1 class="page-title">
            <span class="page-title__icon">💰</span>
            <span class="page-title__text">Budżet</span>
          </h1>
        </div>
        <div class="page-header__actions page-header__actions--spread" aria-label="Akcje strony">
          <div class="page-header__badges">
            <span class="badge">💾 Dane lokalne</span>
            <span class="badge">📈 Analiza offline</span>
          </div>
          <div class="toolbar budget-month-nav">
            <button class="btn soft" id="prevMonthBtn" title="Poprzedni miesiąc">←</button>
            <span class="pill" id="workingMonth">YYYY-MM</span>
            <button class="btn soft" id="nextMonthBtn" title="Następny miesiąc">→</button>
          </div>
          <div class="toolbar budget-io-actions">
            <button class="btn ghost" id="exportBtn">⬇️ Eksport JSON</button>
            <button class="btn ghost" id="importBtn">⬆️ Import JSON</button>
            <input type="file" id="importFile" accept="application/json" style="display:none" />
          </div>
        </div>
      </header>

      <div class="content">
        <main class="page-content content-main stack">
    <div class="tabs budget-tabs" style="margin-top:12px">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="overview">Przegląd</button>
      <button class="tab" data-tab="incomes">Przychody</button>
      <button class="tab" data-tab="fixed">Stałe wydatki</button>
      <button class="tab" data-tab="variable">Wydatki zmienne</button>
      <button class="tab" data-tab="investments">Inwestycje</button>
      <button class="tab" data-tab="categories">Kategorie</button>
      <button class="tab" data-tab="eom">Salda (EOM)</button>
      <button class="tab" data-tab="goals">Cele</button>
      <button class="tab" data-tab="analytics">Analityka</button>
      <button class="tab" data-tab="mom">Porównanie MoM</button>
    </div>

    <!-- Dashboard -->
    <section id="tab-dashboard" class="card" style="margin-top:12px">
      <h3 class="title">Dashboard finansowy</h3>
      <div class="grid-2" style="margin-top:12px">
        <div class="card">
          <div class="title">Wydatki dzień po dniu</div>
          <div class="chart-box"><canvas id="dailyLine"></canvas></div>
        </div>
        <div class="card">
          <div class="title">Skumulowane: limit vs wydatki</div>
          <div class="hint">Dwie linie: oczekiwane (np. 400 zł/dzień) vs faktyczne (wydatki + oszczędności)</div>
          <div class="chart-box"><canvas id="cumulativeLine"></canvas></div>
        </div>
      </div>

      <div class="card heatmap-card" style="margin-top:16px">
        <div class="title">Wydatki dzienne — heatmap</div>
        <div class="muted" style="margin-bottom:4px">Zielone = w budżecie, Pomarańczowe = przekroczenie, Czerwone = duże przekroczenie</div>
        <div id="daily-spending-calendar" class="heatmap-strip"></div>
        <div class="heat-legend">
          <span class="heat-day" style="background:#dcfce7"> </span> w normie
          <span class="heat-day" style="background:#ffedd5"> </span> lekko powyżej
          <span class="heat-day" style="background:#fee2e2"> </span> mocno powyżej
        </div>
      </div>

      <div class="card recent-calendar-card" style="margin-top:16px">
        <div class="row" style="justify-content:space-between;align-items:flex-start;gap:12px">
          <div>
            <div class="title">Ostatnie 7 dni — wydatki</div>
            <p class="muted tiny">Największe wydatki z ostatnich dni, posegregowane malejąco. Top 5 oznaczone na czerwono.</p>
          </div>
          <div class="chip" style="margin:0" id="recent-seven-total">Łącznie: —</div>
        </div>
        <div id="recent-spending-calendar" class="recent-calendar"></div>
      </div>

      <div id="var-table-dashboard-slot" style="display:none">
        <div id="var-transactions-card" class="card">
          <div class="row" style="justify-content:space-between;align-items:flex-end;gap:12px">
            <div>
              <div class="title">Transakcje w miesiącu</div>
              <p class="muted tiny">Monitoruj wszystkie wydatki zmienne w aktywnym okresie.</p>
            </div>
            <div class="chip" style="margin:0">
              Suma: <b id="var-sum">0</b>
            </div>
          </div>
          <div class="row" style="margin:12px 0;gap:8px;align-items:center;flex-wrap:wrap">
            <label class="tiny" style="display:flex;flex-direction:column;gap:6px">
              Filtr kategorii
              <select id="var-filter-cat"><option value="">Wszystkie kategorie</option></select>
            </label>
          </div>
          <div class="table-wrapper" style="max-height:320px;overflow:auto">
            <table class="table-compact">
              <thead><tr><th>Data</th><th>Kategoria</th><th>Konto</th><th>Kwota</th><th>Notatka</th><th></th></tr></thead>
              <tbody id="var-rows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="quick-actions" style="margin-top:12px">
        <div class="row">
          <div class="title">Szybkie akcje</div>
          <div class="row" style="gap:8px">
            <button id="qa-edit-toggle" class="btn ghost">⚙️ Edytuj szybkie akcje</button>
          </div>
        </div>
        <div id="qa-grid" class="grid g-4" style="margin-top:8px"></div>
        <div id="qa-editor" class="editor-section" style="display:none">
          <div class="title">Edycja szybkich akcji</div>
          <div class="tiny">Zapisuje się w pamięci przeglądarki (localStorage).</div>
          <form id="qa-add-form" class="grid g-4" style="margin-top:10px">
            <input name="label" placeholder="Nazwa (np. Jedzenie)" required />
            <input name="emoji" placeholder="Emoji (np. 🍕)" />
            <select name="categoryId" required></select>
            <select name="accountId" required></select>
            <input name="defaultAmount" placeholder="Domyślna kwota (zł)" inputmode="decimal" />
            <input name="defaultNote" placeholder="Domyślna notatka" />
            <button class="btn" type="submit" style="grid-column: 1 / -1;">Dodaj akcję</button>
          </form>
          <table style="margin-top:10px">
            <thead><tr><th>Emoji</th><th>Nazwa</th><th>Kategoria</th><th>Konto</th><th>Domyślna kwota</th><th>Notatka</th><th></th></tr></thead>
            <tbody id="qa-rows"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Overview -->
    <section id="tab-overview" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Przegląd miesiąca — <span id="ov-month">YYYY-MM</span></h3>
      <div class="grid g-4">
        <div class="stat-card"><div class="muted">Przychody</div><div class="big-number" id="ov-inc">0</div></div>
        <div class="stat-card"><div class="muted">Stałe zaplanowane</div><div class="big-number" id="ov-fixed-planned">0</div></div>
        <div class="stat-card"><div class="muted">Stałe zapłacone</div><div class="big-number ok" id="ov-fixed-paid">0</div></div>
        <div class="stat-card"><div class="muted">Stałe do zapłacenia</div><div class="big-number warn" id="ov-fixed-unpaid">0</div></div>
        <div class="stat-card"><div class="muted">Wydatki zmienne</div><div class="big-number bad" id="ov-var-spent">0</div></div>
        <div class="stat-card"><div class="muted">Oszczędności</div><div class="big-number" style="color:var(--blue)" id="ov-savings">0</div></div>
        <div class="stat-card"><div class="muted">Budżet zmienny do dyspozycji</div><div class="big-number" id="ov-remaining">0</div></div>
        <div class="stat-card"><div class="muted">Prognozowana stopa oszczędności</div><div class="big-number" id="stat-savings-rate">0%</div></div>
      </div>
    </section>

    <!-- Incomes -->
    <section id="tab-incomes" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Przychody — <span id="inc-month">YYYY-MM</span></h3>
      <form id="inc-form" class="grid g-3" style="margin-bottom:8px">
        <input required name="amount" placeholder="Kwota (zł)" inputmode="decimal" />
        <input name="note" placeholder="Notatka (np. pensja)" />
        <button class="btn" type="submit">Dodaj przychód</button>
      </form>
      <div class="muted" style="margin-bottom:4px">Suma: <b id="inc-sum">0</b></div>
      <table><thead><tr><th>Kwota</th><th>Notatka</th><th></th></tr></thead><tbody id="inc-rows"></tbody></table>
    </section>

    <!-- Fixed Expenses -->
    <section id="tab-fixed" class="card" style="margin-top:12px;display:none">
      <div class="row">
        <h3 class="title" style="margin: 0;">Stałe wydatki — <span id="fix-month">YYYY-MM</span></h3>
        <button id="fix-manage-templates-btn" class="btn ghost">⚙️ Zarządzaj szablonami</button>
      </div>
      
      <!-- NEW: Fixed expense templates manager -->
      <div id="fix-templates-manager" class="editor-section" style="margin-bottom:12px; display:none">
        <div class="title">Zarządzaj szablonami stałych wydatków</div>
        <p class="tiny">Zdefiniuj stałe opłaty (np. czynsz, abonamenty), a aplikacja będzie sugerować ich dodanie w każdym miesiącu.</p>
        <form id="fix-template-form" class="grid g-4" style="margin-top:8px">
          <input name="title" placeholder="Nazwa (np. Czynsz)" required />
          <input name="amount" placeholder="Kwota (zł)" inputmode="decimal" required />
          <input name="day" type="number" min="1" max="31" placeholder="Dzień płatności (1-31)" required />
          <button class="btn" type="submit">Dodaj szablon</button>
        </form>
        <table style="margin-top:10px">
          <thead><tr><th>Nazwa</th><th>Kwota</th><th>Dzień miesiąca</th><th></th></tr></thead>
          <tbody id="fix-templates-tbody"></tbody>
        </table>
      </div>

      <!-- NEW: Fixed expense suggestions -->
      <div id="fix-suggestions-box" class="card" style="margin-bottom: 12px; display: none; background: #f8fafc;">
        <div class="row">
          <div class="title">💡 Sugestie na ten miesiąc</div>
          <button id="fix-apply-all-btn" class="btn soft">Dodaj wszystkie</button>
        </div>
        <div id="fix-suggestions-list" class="grid g-3" style="margin-top:8px; gap:8px"></div>
      </div>

      <form id="fix-form" class="grid g-4" style="margin:8px 0">
        <input required name="title" placeholder="Tytuł (np. czynsz)" />
        <input required name="amount" placeholder="Kwota (zł)" inputmode="decimal" />
        <input name="due" type="date" />
        <input type="hidden" name="categoryId" value="c_fixed"/>
        <button class="btn" type="submit">Dodaj jednorazowo</button>
      </form>
      
      <div class="row" style="margin-bottom:12px">
        <label style="display:inline-flex;gap:8px;align-items:center">
          <input type="checkbox" id="autoTx" checked />Automatycznie dodaj transakcję po opłaceniu
        </label>
        <button class="btn soft" id="payAllFixed">Opłać wszystkie</button>
      </div>

      <table>
        <thead><tr><th>Status</th><th>Tytuł</th><th>Kwota</th><th>Termin</th><th>Dni do terminu</th><th></th></tr></thead>
        <tbody id="fix-rows"></tbody>
      </table>
      <div class="muted" style="margin-top:8px">Suma nieopłaconych: <b id="fix-unpaid-sum">0</b></div>
    </section>

    <!-- Variable -->
    <section id="tab-variable" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Wydatki zmienne — <span id="var-month">YYYY-MM</span></h3>

      <!-- Sugestie cykliczne -->
      <div id="rec-suggestions" class="card" style="margin-bottom:10px; display:none">
        <div class="row">
          <div class="title">🔁 Cykliczne — Sugestie na <span id="rec-sugg-month"></span></div>
          <button class="btn ghost" id="rec-manage-toggle">⚙️ Zarządzaj szablonami</button>
        </div>
        <div id="rec-sugg-list" class="grid" style="gap:8px"></div>
      </div>

      <!-- Zarządzanie szablonami (zmienne) -->
      <div id="rec-manage" class="editor-section" style="display:none">
        <div class="title">Szablony cykliczne</div>
        <div class="tiny">Miesięczny harmonogram (dzień 1–31). Obsługa splitu.</div>
        <form id="rec-add-form" class="grid g-4" style="margin-top:8px">
          <input name="label" placeholder="Nazwa (np. Abonament)" required />
          <input name="day" type="number" min="1" max="31" placeholder="Dzień miesiąca" required />
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" name="isSplit" /> Split</label><span></span>
          <div data-mode="single" class="grid g-4" style="grid-column:1/-1;gap:8px">
            <select name="categoryId"></select>
            <select name="accountId"></select>
            <input name="amount" placeholder="Kwota (zł)" inputmode="decimal" />
            <input name="note" placeholder="Notatka" />
          </div>
          <div data-mode="split" class="split-box" style="grid-column:1/-1;display:none">
            <table style="width:100%"><thead><tr><th>Kategoria</th><th>Kwota</th><th></th></tr></thead><tbody class="rec-split-rows"></tbody></table>
            <div style="margin-top:6px"><button class="btn soft" type="button" id="rec-split-add">+ wiersz</button></div>
          </div>
          <button class="btn" type="submit" style="grid-column:1/-1">Dodaj szablon</button>
        </form>
        <table style="margin-top:10px">
          <thead><tr><th>Nazwa</th><th>Dzień</th><th>Tryb</th><th>Podsumowanie</th><th>Konto</th><th>Notatka</th><th></th></tr></thead>
          <tbody id="rec-rows"></tbody>
        </table>
      </div>

      <!-- Dodawanie transakcji -->
      <form id="var-form" class="grid g-4" style="margin:10px 0">
        <input type="date" name="date" />
        <input required name="amount" placeholder="Kwota (zł)" inputmode="decimal" />
        <select name="categoryId"></select>
        <select name="accountId"></select>
        <input name="note" placeholder="Notatka" />
        <button class="btn" type="submit">Dodaj wydatek</button>
      </form>

      <div id="var-table-variable-slot" style="margin-top:12px"></div>

      <div class="insight-bubble" style="margin-top:12px">📊 Szczegółową tabelę transakcji znajdziesz poniżej lub w panelu „Dashboard finansowy”.</div>
    </section>

    <!-- Investments v2 -->
      <section id="tab-investments" style="display:none" class="stack">
        <div class="inv-shell">

          <div class="row" style="justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <div class="badge">Portfolio Tracker v2</div>
            <button class="btn ghost" type="button" id="inv-asset-modal-open">Zarządzaj aktywami</button>
          </div>

          <!-- Dashboard KPIs -->
          <div class="inv-dashboard" id="inv-dashboard">
            <div class="inv-kpi-card accent">
              <span class="inv-kpi-label">Kapitał z budżetu</span>
              <span class="inv-kpi-value" id="inv-kpi-capital">—</span>
              <span class="inv-kpi-sub" id="inv-kpi-capital-sub"></span>
            </div>
            <div class="inv-kpi-card">
              <span class="inv-kpi-label">Wartość portfela</span>
              <span class="inv-kpi-value" id="inv-kpi-value">—</span>
              <span class="inv-kpi-sub" id="inv-kpi-value-sub"></span>
            </div>
            <div class="inv-kpi-card" id="inv-kpi-unrealized-card">
              <span class="inv-kpi-label">Niezrealizowany P&amp;L</span>
              <span class="inv-kpi-value" id="inv-kpi-unrealized">—</span>
              <span class="inv-kpi-sub" id="inv-kpi-unrealized-sub">Uzupełnij ceny aktywów</span>
            </div>
            <div class="inv-kpi-card" id="inv-kpi-realized-card">
              <span class="inv-kpi-label">Zrealizowany P&amp;L</span>
              <span class="inv-kpi-value" id="inv-kpi-realized">—</span>
              <span class="inv-kpi-sub">Zysk/strata ze sprzedaży</span>
            </div>
            <div class="inv-kpi-card">
              <span class="inv-kpi-label">Pula reinwestycyjna</span>
              <span class="inv-kpi-value" id="inv-kpi-pool">—</span>
              <span class="inv-kpi-sub">Gotówka do reinwestycji</span>
            </div>
            <div class="inv-kpi-card" id="inv-kpi-roi-card">
              <span class="inv-kpi-label">Całkowity ROI</span>
              <span class="inv-kpi-value" id="inv-kpi-roi">—</span>
              <span class="inv-kpi-sub">Zwrot na kapitale z budżetu</span>
            </div>
          </div>

          <!-- Trade Form (Buy / Sell) -->
          <div class="card stack">
            <div class="row" style="justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
              <div class="inv-trade-tabs">
                <button type="button" class="inv-trade-tab is-active" data-trade-mode="buy">Kup</button>
                <button type="button" class="inv-trade-tab" data-trade-mode="sell">Sprzedaj</button>
              </div>
              <span class="badge ghost" id="inv-trade-badge">Automatyczne księgowanie</span>
            </div>
            <form id="inv-buy-form" class="inv-trade-grid">
              <label class="inv-trade-field grow">Aktywo<select name="assetId" required></select></label>
              <label class="inv-trade-field">Data<input type="date" name="date" required /></label>
              <label class="inv-trade-field">Kwota<input name="amount" inputmode="decimal" placeholder="0,00" required /></label>
              <label class="inv-trade-field">Ilość<input name="quantity" inputmode="decimal" placeholder="0" required /></label>
              <label class="inv-trade-field">Źródło<select name="fundSource"><option value="budget">Budżet domowy</option><option value="reinvest">Pula reinwestycyjna</option></select></label>
              <label class="inv-trade-field grow">Notatka<input name="note" placeholder="np. DCA, promo, HODL" /></label>
              <div class="inv-trade-footnote" id="inv-buy-footnote">Źródło: budżet — kwota zostanie zaksięgowana jako inwestycja.</div>
              <button class="btn" type="submit">Zapisz zakup</button>
            </form>
            <form id="inv-sell-form" class="inv-trade-grid" style="display:none">
              <label class="inv-trade-field grow">Aktywo<select name="assetId" required></select></label>
              <label class="inv-trade-field">Data<input type="date" name="date" required /></label>
              <label class="inv-trade-field">Ilość<div class="row" style="gap:4px;align-items:center"><input name="quantity" inputmode="decimal" placeholder="0" required style="flex:1" /><button type="button" id="inv-sell-all-btn" class="btn soft" style="height:38px;padding:0 10px;font-size:11px;white-space:nowrap">Wszystko</button></div></label>
              <label class="inv-trade-field">Cena za szt.<input name="pricePerUnit" inputmode="decimal" placeholder="0,00" required /></label>
              <label class="inv-trade-field">Przeznaczenie<select name="sellDestination"><option value="reinvest">Pula reinwestycyjna</option><option value="budget">Wypłata do budżetu</option></select></label>
              <label class="inv-trade-field grow">Notatka<input name="note" placeholder="np. Take profit, rebalancing" /></label>
              <div class="inv-sell-info" id="inv-sell-preview">Wybierz aktywo i wpisz ilość, aby zobaczyć podgląd transakcji.</div>
              <button class="btn" type="submit" style="background:#dc2626">Zapisz sprzedaż</button>
            </form>
          </div>

          <!-- Holdings Table -->
          <div class="card stack">
            <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
              <strong>Portfel — stan posiadania</strong>
              <div class="row" style="gap:8px">
                <button class="btn soft" type="button" id="inv-refresh-prices-btn">Odśwież aktualne ceny</button>
                <span class="tiny muted" id="inv-refresh-status">Kliknij cenę, aby zaktualizować wycenę</span>
              </div>
            </div>
            <div class="table-wrapper">
              <table class="modern-table" id="inv-holdings-table">
                <thead><tr><th>Aktywo</th><th>Grupa</th><th>Ilość</th><th>Śr. koszt</th><th>Akt. cena</th><th>Wartość</th><th>P&amp;L</th><th>Waga</th><th></th></tr></thead>
                <tbody></tbody>
                <tfoot id="inv-holdings-foot"></tfoot>
              </table>
            </div>
          </div>

          <!-- Group Summary -->
          <div class="card stack">
            <div class="row" style="justify-content:space-between;align-items:center">
              <strong>Podsumowanie grup</strong>
              <span class="tiny muted">Struktura kapitału wg grup</span>
            </div>
            <div class="table-wrapper">
              <table class="modern-table" id="inv-group-table">
                <thead><tr><th>Grupa</th><th>Baza kosztowa</th><th>Wartość</th><th>P&amp;L</th><th>Udział</th><th>Transakcje</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Trade History (collapsible) -->
          <details class="card stack" id="inv-trade-history-details">
            <summary class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;cursor:pointer;user-select:none">
              <strong>Historia transakcji <span class="muted" style="font-weight:400;font-size:12px" id="inv-trade-count-badge"></span></strong>
              <div class="inv-trade-filters">
                <button type="button" class="inv-trade-filter is-active" data-filter="all">Wszystkie</button>
                <button type="button" class="inv-trade-filter" data-filter="buy">Kupno</button>
                <button type="button" class="inv-trade-filter" data-filter="sell">Sprzedaż</button>
              </div>
            </summary>
            <div class="table-wrapper">
              <table class="modern-table" id="inv-trades-table">
                <thead><tr><th>Data</th><th>Typ</th><th>Aktywo</th><th>Ilość</th><th>Cena/szt.</th><th>Wartość</th><th>Źródło/Cel</th><th>P&amp;L</th><th>Notatka</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </details>

          <!-- Analytics -->
          <div class="card stack">
            <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
              <strong>Analityka</strong>
              <div class="inv-analytics-nav" role="tablist">
                <button type="button" class="inv-analytics-btn is-active" data-inv-panel-btn="hub" style="background:linear-gradient(135deg,#2563eb,#7c3aed);color:#fff;box-shadow:0 4px 16px rgba(37,99,235,.35)">Hub analityczny</button>
                <button type="button" class="inv-analytics-btn" data-inv-panel-btn="capital">Przepływy kapitału</button>
                <button type="button" class="inv-analytics-btn" data-inv-panel-btn="cumulative">Skumulowany kapitał</button>
                <button type="button" class="inv-analytics-btn" data-inv-panel-btn="allocation">Alokacja</button>
                <button type="button" class="inv-analytics-btn" data-inv-panel-btn="pnl">P&amp;L</button>
              </div>
            </div>
            <div class="inv-analytics-panels">
              <div class="inv-analytics-panel" data-panel="capital">
                <div class="chart-box"><canvas id="inv-capital-chart"></canvas><div class="chart-empty" id="inv-capital-empty" style="display:none">Brak danych</div></div>
              </div>
              <div class="inv-analytics-panel" data-panel="cumulative">
                <div class="chart-box"><canvas id="inv-cumulative-chart"></canvas><div class="chart-empty" id="inv-cumulative-empty" style="display:none">Dodaj transakcje</div></div>
              </div>
              <div class="inv-analytics-panel" data-panel="allocation">
                <div class="inv-allocation-grid">
                  <div class="card stack" style="box-shadow:none;border:1px solid rgba(148,163,184,.25)">
                    <strong>Struktura wg grup</strong>
                    <div class="chart-box" style="height:220px"><canvas id="inv-allocation-chart"></canvas><div class="chart-empty" id="inv-allocation-empty" style="display:none">Brak aktywów</div></div>
                  </div>
                  <div class="card stack" style="box-shadow:none;border:1px solid rgba(148,163,184,.25)">
                    <div class="row" style="justify-content:space-between;align-items:center">
                      <strong id="inv-allocation-detail-title">Szczegóły grupy</strong>
                      <span class="tiny muted" id="inv-allocation-detail-meta">Kliknij segment</span>
                    </div>
                    <div class="chart-box" style="height:220px"><canvas id="inv-allocation-detail-chart"></canvas><div class="chart-empty" id="inv-allocation-detail-empty" style="display:none">Kliknij grupę</div></div>
                  </div>
                </div>
              </div>
              <div class="inv-analytics-panel" data-panel="pnl">
                <div class="chart-box"><canvas id="inv-pnl-chart"></canvas><div class="chart-empty" id="inv-pnl-empty" style="display:none">Brak zrealizowanych zysków</div></div>
              </div>

              <!-- =============== HUB ANALITYCZNY =============== -->
              <div class="inv-analytics-panel is-active" data-panel="hub">

                <!-- Snapshot bar -->
                <div class="inv-hub-snapshot-bar">
                  <button class="btn" type="button" id="inv-hub-snap-btn">Zapisz dzisiejszy snapshot</button>
                  <span class="inv-hub-last-snap" id="inv-hub-last-snap"></span>
                  <span class="inv-hub-streak" id="inv-hub-streak" style="display:none"></span>
                </div>

                <!-- Summary KPIs -->
                <div class="inv-hub-kpis" id="inv-hub-kpis">
                  <div class="inv-hub-kpi accent">
                    <span class="kpi-label">Wartość portfela</span>
                    <span class="kpi-val" id="inv-hub-kpi-value">—</span>
                    <span class="kpi-sub" id="inv-hub-kpi-value-sub"></span>
                  </div>
                  <div class="inv-hub-kpi" id="inv-hub-kpi-roi-card">
                    <span class="kpi-label">ROI</span>
                    <span class="kpi-val" id="inv-hub-kpi-roi">—</span>
                    <span class="kpi-sub">Zwrot na kapitale</span>
                  </div>
                  <div class="inv-hub-kpi" id="inv-hub-kpi-pnl-card">
                    <span class="kpi-label">Łączny P&amp;L</span>
                    <span class="kpi-val" id="inv-hub-kpi-pnl">—</span>
                    <span class="kpi-sub" id="inv-hub-kpi-pnl-sub"></span>
                  </div>
                  <div class="inv-hub-kpi">
                    <span class="kpi-label">Zainwestowano łącznie</span>
                    <span class="kpi-val" id="inv-hub-kpi-invested">—</span>
                    <span class="kpi-sub" id="inv-hub-kpi-invested-sub"></span>
                  </div>
                  <div class="inv-hub-kpi">
                    <span class="kpi-label">Śr. tygodniowa wpłata</span>
                    <span class="kpi-val" id="inv-hub-kpi-weekly">—</span>
                    <span class="kpi-sub" id="inv-hub-kpi-weekly-sub"></span>
                  </div>
                  <div class="inv-hub-kpi">
                    <span class="kpi-label">Liczba snapshotów</span>
                    <span class="kpi-val" id="inv-hub-kpi-snaps">0</span>
                    <span class="kpi-sub">Twój dziennik inwestora</span>
                  </div>
                </div>

                <!-- Charts 2x2 -->
                <div class="inv-hub-charts">
                  <div class="inv-hub-chart-card">
                    <h4>ROI w czasie</h4>
                    <div class="inv-hub-chart-box"><canvas id="inv-hub-roi-chart"></canvas></div>
                  </div>
                  <div class="inv-hub-chart-card">
                    <h4>P&amp;L w czasie</h4>
                    <div class="inv-hub-chart-box"><canvas id="inv-hub-pnl-chart"></canvas></div>
                  </div>
                  <div class="inv-hub-chart-card">
                    <div class="row" style="justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px">
                      <h4 style="margin:0">Wpłaty</h4>
                      <div class="inv-trade-filters" style="margin:0">
                        <button type="button" class="inv-hub-dep-mode is-active" data-dep-mode="monthly">Miesięczne</button>
                        <button type="button" class="inv-hub-dep-mode" data-dep-mode="weekly">Tygodniowe</button>
                      </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                      <span class="muted" style="font-size:11px;white-space:nowrap">Ostatnie:</span>
                      <input type="range" id="inv-hub-dep-range" min="1" max="52" value="12" style="flex:1;accent-color:#2563eb" />
                      <span class="muted" style="font-size:11px;min-width:48px;text-align:right" id="inv-hub-dep-range-label">12</span>
                    </div>
                    <div class="inv-hub-chart-box"><canvas id="inv-hub-deposits-chart"></canvas></div>
                  </div>
                  <div class="inv-hub-chart-card">
                    <h4>Kapitał kumulatywny</h4>
                    <div class="inv-hub-chart-box"><canvas id="inv-hub-cumulative-chart"></canvas></div>
                  </div>
                </div>

                <!-- Top Holdings Chart (full width, bar sorted by PNL + ROI line) -->
                <div class="inv-hub-chart-card" style="margin-top:14px">
                  <h4>Ranking pozycji — P&amp;L + ROI</h4>
                  <div style="height:280px;position:relative"><canvas id="inv-hub-top-chart"></canvas></div>
                </div>

                <!-- Forecast Simulator (data-driven) -->
                <div class="inv-hub-calc" style="margin-top:14px">
                  <h4>Symulacja portfela — prognoza na bazie Twoich danych</h4>
                  <p class="muted" style="font-size:12px;margin:-6px 0 10px">Bazuje na realnych wpłatach z zamkniętych miesięcy. Ustaw stopę zwrotu, horyzont i mnożnik obecnego trendu wpłat, aby zobaczyć strukturę portfela (kapitał vs odsetki) dla konkretnego miesiąca.</p>
                  <div class="inv-hub-calc-grid">
                    <label class="inv-hub-calc-field">Roczna stopa zwrotu (%)<input type="text" id="inv-hub-calc-rate" inputmode="decimal" value="8" /></label>
                    <label class="inv-hub-calc-field">Horyzont (lata)<input type="number" id="inv-hub-calc-years" min="1" max="60" value="5" /></label>
                    <label class="inv-hub-calc-field">Tempo wpłat (mnożnik trendu)<input type="text" id="inv-hub-calc-multiplier" inputmode="decimal" value="1.5" /></label>
                    <label class="inv-hub-calc-field">Miesiąc podglądu<input type="month" id="inv-hub-calc-target-month" /></label>
                    <div><button class="btn" type="button" id="inv-hub-calc-btn">Przelicz scenariusze</button></div>
                  </div>
                  <div class="inv-hub-calc-result" id="inv-hub-calc-result" style="display:none"></div>
                  <div class="inv-hub-calc-chart-box"><canvas id="inv-hub-calc-chart"></canvas></div>
                </div>

                <!-- Snapshot history table -->
                <div class="inv-hub-structure-card" style="margin-top:14px">
                  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
                    <h4 style="margin:0">Historia snapshotów</h4>
                    <button class="btn ghost" type="button" id="inv-hub-snap-clear" style="font-size:11px">Wyczyść historię</button>
                  </div>
                  <div class="table-wrapper">
                    <table class="inv-hub-table" id="inv-hub-snap-table">
                      <thead><tr><th>Data</th><th>Wartość portfela</th><th>Zainwestowano</th><th>P&amp;L</th><th>ROI</th><th></th></tr></thead>
                      <tbody></tbody>
                    </table>
                  </div>
                  <div class="inv-hub-empty" id="inv-hub-snap-empty" style="display:none">Kliknij „Zapisz dzisiejszy snapshot", aby rozpocząć śledzenie.</div>
                </div>

              </div>
              <!-- =============== /HUB ANALITYCZNY =============== -->

            </div>
          </div>

        </div>

        <!-- Asset Manager Modal -->
        <div id="inv-asset-backdrop" class="inv-modal-backdrop" hidden></div>
        <aside id="inv-asset-modal" class="inv-modal" role="dialog" aria-modal="true" aria-hidden="true" hidden>
          <header class="row" style="justify-content:space-between;align-items:center;gap:12px">
            <div>
              <h3 class="title" style="margin:0">Zarządzanie aktywami</h3>
              <p class="tiny muted" style="margin-top:4px">Dodawaj, edytuj, usuwaj aktywa. Ustaw aktualne ceny rynkowe.</p>
            </div>
            <button class="btn ghost" type="button" id="inv-asset-modal-close">✕</button>
          </header>
          <div class="inv-modal-body" style="margin-top:12px">
            <div class="inv-asset-toolbar">
              <strong>Lista aktywów</strong>
              <div class="actions">
                <button class="btn soft" type="button" id="inv-asset-refresh-prices">Odśwież ceny</button>
                <button class="btn soft" type="button" id="inv-asset-add-group">Nowa grupa</button>
                <button class="btn soft" type="button" id="inv-asset-add-row">+ Dodaj</button>
                <button class="btn" type="button" id="inv-asset-save-all">Zapisz wszystkie</button>
                <button class="btn ghost" type="button" id="inv-asset-cancel">Zamknij</button>
              </div>
            </div>
            <div class="table-wrapper" style="margin-top:6px">
              <table class="modern-table inv-asset-table">
                <thead><tr><th>Aktywo</th><th>Grupa</th><th>Akt. cena</th><th>Źródło ceny</th><th>Symbol/ID API</th><th>Waluta</th><th>Transakcje</th><th></th></tr></thead>
                <tbody id="inv-asset-table-body"></tbody>
              </table>
            </div>
            <div id="inv-asset-empty" class="tiny muted inv-asset-empty">Brak aktywów — dodaj pierwszy.</div>
          </div>
        </aside>
      </section>
    <!-- Categories -->
    <section id="tab-categories" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Kategorie</h3>
      <form id="cat-form" class="grid g-4" style="margin-bottom:8px">
        <input required name="name" placeholder="Nazwa" />
        <select name="type">
          <option value="expense">Wydatek</option>
          <option value="income">Przychód</option>
          <option value="saving">Oszczędność</option>
        </select>
        <input name="emoji" placeholder="Emoji (np. 🍕)" />
        <input name="budget" placeholder="Budżet (zł)" inputmode="decimal" />
        <button class="btn" type="submit">Dodaj kategorię</button>
      </form>
      <div class="muted" id="cat-empty" style="display:none;margin-bottom:8px">Brak kategorii — dodaj pierwszą powyżej.</div>
      <table>
        <thead><tr><th>Emoji</th><th>Nazwa</th><th>Typ</th><th>Budżet</th><th>Wydano</th><th>Status</th><th></th></tr></thead>
        <tbody id="cat-rows"></tbody>
      </table>
    </section>

    <!-- EOM -->
    <section id="tab-eom" style="margin-top:12px;display:none">
      <div class="eom2-shell">

        <!-- Header -->
        <div class="row" style="justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <div class="badge">Majątek netto</div>
            <p class="tiny muted" style="margin-top:4px">Zamknięcie miesiąca — zaksięguj stan posiadania i śledź swój majątek.</p>
          </div>
          <div class="row" style="gap:8px;align-items:center">
            <select id="eom2-month-select" style="height:38px;min-width:150px;font-weight:600"></select>
            <button class="btn soft" type="button" id="eom2-copy-prev">Skopiuj poprzedni</button>
          </div>
        </div>

        <!-- KPIs -->
        <div class="eom2-kpis" id="eom2-kpis">
          <div class="eom2-kpi accent" id="eom2-kpi-nw-card">
            <span class="kpi-label">Majątek netto</span>
            <span class="kpi-val" id="eom2-kpi-nw">—</span>
            <span class="kpi-sub" id="eom2-kpi-nw-sub"></span>
          </div>
          <div class="eom2-kpi" id="eom2-kpi-change-card">
            <span class="kpi-label">Zmiana m/m</span>
            <span class="kpi-val" id="eom2-kpi-change">—</span>
            <span class="kpi-sub" id="eom2-kpi-change-sub"></span>
          </div>
          <div class="eom2-kpi">
            <span class="kpi-label">Aktywa</span>
            <span class="kpi-val" id="eom2-kpi-assets" style="color:#16a34a">—</span>
            <span class="kpi-sub" id="eom2-kpi-assets-sub"></span>
          </div>
          <div class="eom2-kpi">
            <span class="kpi-label">Zobowiązania</span>
            <span class="kpi-val" id="eom2-kpi-debt" style="color:#dc2626">—</span>
            <span class="kpi-sub" id="eom2-kpi-debt-sub"></span>
          </div>
        </div>

        <!-- Booking Grid -->
        <div class="card stack">
          <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
            <strong>Księgowanie sald <span class="muted" style="font-weight:400;font-size:12px" id="eom2-month-label"></span></strong>
            <div class="row" style="gap:8px">
              <span class="tiny muted" id="eom2-live-total"></span>
              <button class="btn" type="button" id="eom2-save">Zapisz salda</button>
            </div>
          </div>
          <div id="eom2-booking-grid"></div>
          <form id="eom2-add-account" class="row" style="gap:8px;margin-top:8px">
            <input name="name" placeholder="Nowe konto (np. Revolut, Karta kredytowa)" style="flex:1;height:38px" required />
            <select name="type" style="height:38px;min-width:140px">
              <option value="oszczędności">Oszczędności</option>
              <option value="inwestycje">Inwestycje</option>
              <option value="zadłużenie">Zadłużenie</option>
              <option value="gotówka">Gotówka</option>
              <option value="emerytura">Emerytura</option>
              <option value="inne">Inne</option>
            </select>
            <button class="btn soft" type="submit">Dodaj konto</button>
          </form>
        </div>

        <!-- Charts Row -->
        <div class="eom2-charts-row">
          <div class="card stack" style="flex:2;min-width:300px">
            <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
              <strong>Trend majątku netto</strong>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <select id="eom2-cat-filter" style="font-size:12px;padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--fg)">
                  <option value="all">Wszystkie kategorie</option>
                </select>
                <div class="inv-trade-filters" style="margin:0">
                  <button type="button" class="eom2-range-btn is-active" data-range="6">6m</button>
                  <button type="button" class="eom2-range-btn" data-range="12">12m</button>
                  <button type="button" class="eom2-range-btn" data-range="all">Wszystko</button>
                </div>
              </div>
            </div>
            <div style="height:340px;position:relative"><canvas id="eom2-nw-chart"></canvas></div>
          </div>
          <div class="card stack" style="flex:1;min-width:260px">
            <strong>Struktura majątku</strong>
            <div style="height:340px;position:relative"><canvas id="eom2-breakdown-chart"></canvas></div>
          </div>
        </div>

        <!-- Category Deep-Dive -->
        <div id="eom2-deepdive" class="card stack" style="display:none">
          <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
            <strong id="eom2-dd-title">Deep-dive: Kategoria</strong>
            <button type="button" class="btn soft" id="eom2-dd-close" style="font-size:12px;padding:4px 10px">Zamknij</button>
          </div>
          <!-- KPI row -->
          <div class="eom2-kpis" id="eom2-dd-kpis"></div>
          <!-- Chart -->
          <div style="height:360px;position:relative"><canvas id="eom2-dd-chart"></canvas></div>
          <!-- Account table -->
          <div class="table-wrapper">
            <table class="modern-table" id="eom2-dd-table">
              <thead id="eom2-dd-thead"></thead>
              <tbody id="eom2-dd-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Bottleneck Analysis -->
        <div class="eom2-bottleneck-row">
          <div class="card stack" style="flex:1">
            <strong style="color:#16a34a">Największe wzrosty</strong>
            <div id="eom2-top-gainers"></div>
          </div>
          <div class="card stack" style="flex:1">
            <strong style="color:#dc2626">Wymagają uwagi</strong>
            <div id="eom2-top-losers"></div>
          </div>
        </div>

        <!-- History (collapsible) -->
        <details class="card stack">
          <summary style="cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center">
            <strong>Historia sald <span class="muted" style="font-weight:400;font-size:12px" id="eom2-history-count"></span></strong>
          </summary>
          <div class="table-wrapper" style="margin-top:12px">
            <table class="modern-table" id="eom2-history-table">
              <thead id="eom2-history-thead"></thead>
              <tbody id="eom2-history-tbody"></tbody>
            </table>
          </div>
        </details>

      </div>
    </section>

  <!-- Goals -->
    <section id="tab-goals" class="card" style="margin-top:12px;display:none">
      <h3 class="title">Cele oszczędnościowe</h3>
      <form id="goal-form" class="grid g-4" style="margin-bottom:8px">
        <input required name="name" placeholder="Nazwa (np. Poduszka)" />
        <input required name="target" placeholder="Kwota celu" inputmode="decimal" />
        <label class="tiny" for="startdate">Początek oszczędzania</label>
        <label class="tiny" for="deadline">Termin końcowy</label>
        <input name="startdate" type="date" title="Data rozpoczęcia oszczędzania"/>
        <input name="deadline" type="date" title="Data końcowa"/>
        <button class="btn" type="submit" style="grid-column: 1 / -1;">Dodaj cel</button>
      </form>

      <div id="goal-summary" class="card" style="margin-top:16px; background: #f8fafc;"></div>

      <div id="goal-timeline-wrapper" class="card" style="margin-top:16px;">
        <h4 class="title">Oś czasu celów</h4>
        <div class="timeline-wrapper">
            <div id="timeline-labels" class="timeline-labels"></div>
            <div id="goal-timeline" class="timeline-goals"></div>
            <div id="timeline-axis" class="timeline-axis"></div>
        </div>
      </div>
      
      <div class="card" style="margin-top:16px;">
        <h4 class="title">Harmonogram Miesięcznych Wpłat na Cele</h4>
        <div style="overflow-x:auto;">
            <table id="goal-commitment-table"></table>
        </div>
      </div>

      <div id="goal-list" class="grid g-2" style="gap:10px; margin-top: 16px;"></div>

      <div class="card" style="margin-top:16px">
        <div class="title" id="alloc-form-title">Dodaj alokację na cel</div>
        <form id="alloc-form" class="grid g-3">
          <input type="hidden" name="allocId" />
          <select name="goalId"></select>
          <input name="date" type="date" />
          <input name="amount" placeholder="Kwota" inputmode="decimal" />
          <div style="grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 8px;">
            <button id="alloc-cancel-btn" type="button" class="btn ghost" style="display: none;">Anuluj</button>
            <button id="alloc-submit-btn" type="submit" class="btn">Dodaj alokację</button>
          </div>
        </form>
      </div>
      
      <div class="card" style="margin-top:16px">
        <h4 class="title">Historia ostatnich alokacji</h4>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cel</th>
                    <th>Kwota</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="alloc-history-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Analytics -->
    <section id="tab-analytics" class="card" style="margin-top:12px;display:none">

      <!-- Header -->
      <div class="row" style="align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <h3 class="title" style="margin-bottom:0">Centrum Analityczne</h3>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <select id="an-view-mode" style="font-size:12px;padding:4px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--fg)">
            <option value="dashboard">Dashboard</option>
            <option value="categories">Kategorie</option>
            <option value="habits">Nawyki</option>
          </select>
        </div>
      </div>

      <!-- Month Range -->
      <div class="analytics-filter-card">
        <div class="row" style="align-items:flex-start;gap:12px">
          <div style="flex:1">
            <div class="title" style="margin:0;font-size:16px">Zakres analizy</div>
            <div id="an-month-summary" class="analytics-summary"></div>
          </div>
          <div class="analytics-filter-actions" id="an-month-quick">
            <button class="btn soft" data-range="current">Bieżący</button>
            <button class="btn soft" data-range="last3">3 mies.</button>
            <button class="btn soft" data-range="last6">6 mies.</button>
            <button class="btn soft" data-range="year">Rok</button>
            <button class="btn soft" data-range="all">Wszystko</button>
          </div>
        </div>
        <div id="an-month-picker" class="analytics-month-picker"></div>
      </div>

      <!-- Category filter (compact) -->
      <div class="analytics-filter-card" id="an-cat-filter-card">
        <div class="row" style="align-items:center;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <div class="title" style="margin:0;font-size:16px">Filtry kategorii</div>
            <div id="an-filter-summary" class="analytics-summary"></div>
          </div>
          <input id="an-cat-search" placeholder="Szukaj..." style="min-width:180px;font-size:12px" />
          <div class="analytics-filter-actions" style="margin:0">
            <button class="btn soft" id="an-sel-all">Wszystkie</button>
            <button class="btn soft" id="an-sel-none">Wyczyść</button>
            <button class="btn soft" id="an-sel-expense">Wydatki</button>
            <button class="btn soft" id="an-sel-savings">Oszcz.</button>
            <button class="btn soft" id="an-sel-top5">Top 5</button>
          </div>
        </div>
        <div id="an-cat-filter-list" class="analytics-filter-grid"></div>
      </div>

      <!-- ========================= DASHBOARD VIEW ========================= -->
      <div id="an-view-dashboard">

        <!-- Hero KPIs -->
        <div class="an-kpi-grid" id="an-kpis"></div>

        <!-- Spending Pulse: income vs expense line chart -->
        <div class="card" style="margin-top:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <div class="title" style="margin:0">Puls finansowy</div>
              <div class="hint">Przychody, wydatki i oszczędności w czasie.</div>
            </div>
          </div>
          <div style="height:300px;position:relative"><canvas id="an-pulse-chart"></canvas></div>
        </div>

        <!-- Row: Category breakdown + doughnut -->
        <div class="grid g-2" style="margin-top:12px">
          <div class="card">
            <div class="title">Wydatki wg kategorii</div>
            <div class="hint">Top kategorie w wybranym okresie — kwota i zmiana vs poprzedni okres.</div>
            <div id="an-cat-bars" style="margin-top:8px"></div>
          </div>
          <div class="card">
            <div class="title">Struktura wydatków</div>
            <div class="hint">Udział procentowy każdej kategorii.</div>
            <div style="height:280px;position:relative"><canvas id="an-cat-doughnut"></canvas></div>
          </div>
        </div>

        <!-- Spending Deviation -->
        <div class="card" style="margin-top:12px">
          <div class="title">Odchylenia od normy</div>
          <div class="hint">Które kategorie odchylają się od Twojej średniej historycznej? Wykrywa niebezpieczne trendy.</div>
          <div id="an-deviation-bars" style="margin-top:8px"></div>
        </div>

        <!-- Anomaly detector -->
        <div class="card" style="margin-top:12px">
          <div class="row" style="align-items:center;gap:8px">
            <div class="title" style="margin:0">Wykrywanie anomalii</div>
          </div>
          <div class="hint">Automatyczne wykrywanie nietypowych wydatków i trendów.</div>
          <div id="an-anomalies" style="margin-top:8px"></div>
        </div>

        <!-- Monthly breakdown table -->
        <div class="card" style="margin-top:12px">
          <h4 class="title">Podsumowanie miesięczne</h4>
          <div style="overflow-x:auto">
            <table id="an-monthly-table" class="modern-table"></table>
          </div>
        </div>

        <!-- Top transactions -->
        <details class="card" style="margin-top:12px">
          <summary style="cursor:pointer;user-select:none"><strong>Największe transakcje</strong> <span class="muted" style="font-size:12px">Top 15 w okresie</span></summary>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="an-top-tx" class="modern-table"></table>
          </div>
        </details>
      </div>

      <!-- ========================= CATEGORIES VIEW ========================= -->
      <div id="an-view-categories" style="display:none">

        <!-- Category trend chart -->
        <div class="card" style="margin-top:12px">
          <div class="title">Trendy kategorii</div>
          <div class="hint">Porównanie wydatków w poszczególnych kategoriach w czasie.</div>
          <div style="height:340px;position:relative"><canvas id="an-cat-trend-chart"></canvas></div>
        </div>

        <!-- Ranking table -->
        <div class="card" style="margin-top:12px">
          <div class="row" style="align-items:flex-end;gap:8px">
            <h4 class="title" style="margin:0">Ranking kategorii</h4>
            <span class="muted" style="font-size:11px">Kliknij nagłówek aby sortować</span>
          </div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="an-cat-ranking" class="modern-table table-sortable"></table>
          </div>
        </div>

        <!-- Heatmap matrix -->
        <div class="card" style="margin-top:12px">
          <h4 class="title">Macierz kategorii × miesiąc</h4>
          <div class="hint">Kolor = odchylenie od średniej. Cieplejszy = powyżej, chłodniejszy = poniżej.</div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="an-cat-matrix" class="modern-table"></table>
          </div>
        </div>

        <!-- Momentum -->
        <div class="card" style="margin-top:12px">
          <h4 class="title">Dynamika miesiąc do miesiąca</h4>
          <div class="hint">Czy zmiany wynikają z liczby transakcji czy z wyższych kwot?</div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="an-momentum" class="modern-table"></table>
          </div>
        </div>

        <!-- Category deep-dive panel -->
        <div id="an-cat-deepdive" class="card" style="margin-top:12px;display:none">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong id="an-dd-title">Deep-dive</strong>
            <button class="btn soft" id="an-dd-close" style="font-size:12px;padding:4px 10px">Zamknij</button>
          </div>
          <div class="an-kpi-grid" id="an-dd-kpis" style="margin-top:8px"></div>
          <div style="height:300px;position:relative;margin-top:8px"><canvas id="an-dd-chart"></canvas></div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="an-dd-table" class="modern-table"></table>
          </div>
        </div>
      </div>

      <!-- ========================= HABITS VIEW ========================= -->
      <div id="an-view-habits" style="display:none">

        <!-- Spending consistency heatmap -->
        <div class="card" style="margin-top:12px">
          <div class="title">Mapa wydatków</div>
          <div class="hint">Jak równomiernie wydajesz w ciągu miesiąca? Ciemniejszy = więcej wydatków danego dnia.</div>
          <div id="an-heatmap" style="margin-top:8px;overflow-x:auto"></div>
        </div>

        <!-- Spending streaks -->
        <div class="card" style="margin-top:12px">
          <div class="title">Budżetowe serie</div>
          <div class="hint">Ile kolejnych miesięcy udało się zmieścić w budżecie?</div>
          <div id="an-streaks" style="margin-top:8px"></div>
        </div>

        <!-- Daily average by day of week -->
        <div class="card" style="margin-top:12px">
          <div class="title">Wydatki wg dnia tygodnia</div>
          <div class="hint">Który dzień tygodnia jest najdroższy?</div>
          <div style="height:260px;position:relative"><canvas id="an-dow-chart"></canvas></div>
        </div>

        <!-- Recurring detection -->
        <div class="card" style="margin-top:12px">
          <div class="title">Wykryte wzorce powtarzalne</div>
          <div class="hint">Transakcje o podobnej kwocie pojawiające się regularnie.</div>
          <div id="an-recurring" style="margin-top:8px"></div>
        </div>
      </div>

    </section>

    <!-- MoM Comparison -->
    <section id="tab-mom" class="card" style="margin-top:12px;display:none">
      <div class="row" style="align-items:flex-start;justify-content:space-between;gap:12px">
        <div>
          <h3 class="title" style="margin-bottom:4px">Porównanie miesiąc do miesiąca</h3>
          <div class="muted" id="mom-info">Wybierz miesiące, aby zobaczyć zestawienie wydatków.</div>
          <div class="mom-summary" id="mom-summary" style="display:none"></div>
        </div>
        <div class="mom-controls">
          <label class="mom-control">Miesiąc A
            <select id="mom-month-a"></select>
          </label>
          <label class="mom-control">Miesiąc B
            <select id="mom-month-b"></select>
          </label>
          <label class="mom-control">Dzień miesiąca
            <input type="number" id="mom-day-input" min="1" max="31" />
          </label>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="align-items:flex-end;justify-content:space-between">
          <h4 class="title">Tempo wydatków</h4>
          <span class="tiny muted">Kliknij kategorię z tabeli, aby zobaczyć jej przebieg.</span>
        </div>
        <div class="chart-box wide">
          <canvas id="mom-chart"></canvas>
          <div class="chart-empty" id="mom-chart-empty" style="display:none">Brak danych do wyświetlenia.</div>
        </div>
        <p class="tiny muted" id="mom-chart-caption" style="margin-top:8px"></p>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="align-items:flex-end;justify-content:space-between">
          <h4 class="title">Dzienna różnica (A − B)</h4>
          <span class="tiny muted">Czerwone słupki oznaczają szybsze tempo w miesiącu A, zielone — wolniejsze.</span>
        </div>
        <div class="chart-box wide">
          <canvas id="mom-diff-chart"></canvas>
          <div class="chart-empty" id="mom-diff-empty" style="display:none">Brak danych do wyświetlenia.</div>
        </div>
        <p class="tiny muted" id="mom-diff-caption" style="margin-top:8px"></p>
      </div>
      <div class="card mom-detail-shell" style="margin-top:12px">
        <div class="mom-table-header">
          <div class="mom-table-header-meta">
            <h4 class="title">Zestawienie kategorii</h4>
            <span class="tiny muted">Kwoty obejmują wydatki do wybranego dnia.</span>
          </div>
          <button class="btn soft mom-detail-button" id="mom-detail-toggle" type="button" disabled>
            <span class="icon">🔍</span>
            <span class="label">Szczegóły kategorii</span>
          </button>
        </div>
        <div style="overflow-x:auto;">
          <table id="mom-table" class="table-compact">
            <thead>
              <tr>
                <th>Kategoria</th>
                <th id="mom-col-a">Miesiąc A</th>
                <th id="mom-col-b">Miesiąc B</th>
                <th>Różnica</th>
                <th>Tempo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div id="mom-detail-backdrop" class="mom-detail-backdrop" hidden></div>
      <aside id="mom-detail-panel" class="mom-detail-panel" role="dialog" aria-modal="true" aria-hidden="true">
        <header class="mom-detail-header">
          <div class="mom-detail-heading">
            <div class="mom-detail-breadcrumb" id="mom-detail-breadcrumb">Porównanie MoM</div>
            <span class="mom-detail-eyebrow">Analiza kategorii</span>
            <h4 class="mom-detail-title" id="mom-detail-title">Szczegóły kategorii</h4>
            <div class="mom-detail-subtitle" id="mom-detail-subtitle">Wybierz kategorię z tabeli, aby zanurzyć się w transakcje.</div>
          </div>
          <button type="button" class="mom-detail-close" id="mom-detail-close" data-mom-detail-close aria-label="Zamknij szczegóły">✕</button>
        </header>
        <div class="mom-detail-toolbar" id="mom-detail-toolbar" style="display:none">
          <div class="mom-detail-tabs" id="mom-detail-tabs" role="tablist" aria-label="Widoki analizy MoM">
            <button type="button" class="mom-detail-tab is-active" data-mom-detail-tab="overview" id="mom-detail-tab-overview" role="tab" aria-selected="true" aria-controls="mom-detail-panel-overview">Przegląd</button>
            <button type="button" class="mom-detail-tab" data-mom-detail-tab="calendar" id="mom-detail-tab-calendar" role="tab" aria-selected="false" aria-controls="mom-detail-panel-calendar" tabindex="-1">Kalendarz</button>
            <button type="button" class="mom-detail-tab" data-mom-detail-tab="patterns" id="mom-detail-tab-patterns" role="tab" aria-selected="false" aria-controls="mom-detail-panel-patterns" tabindex="-1">Wzorce</button>
            <button type="button" class="mom-detail-tab" data-mom-detail-tab="stats" id="mom-detail-tab-stats" role="tab" aria-selected="false" aria-controls="mom-detail-panel-stats" tabindex="-1">Statystyki</button>
            <button type="button" class="mom-detail-tab" data-mom-detail-tab="transactions" id="mom-detail-tab-transactions" role="tab" aria-selected="false" aria-controls="mom-detail-panel-transactions" tabindex="-1">Transakcje</button>
          </div>
          <div class="mom-detail-sort" id="mom-detail-sort" hidden>
            <button type="button" class="is-active" data-mom-detail-sort="impact">Największy wpływ</button>
            <button type="button" data-mom-detail-sort="chron">Chronologicznie</button>
          </div>
        </div>
        <div class="mom-detail-scroll">
          <div class="mom-detail-meta" id="mom-detail-meta"></div>
          <div class="mom-detail-body" id="mom-detail-body">
            <div class="mom-detail-empty">Wybierz kategorię z tabeli, aby zobaczyć dzienne wydatki w miesiącu A i B.</div>
          </div>
        </div>
      </aside>
    </section>
        </main>
        <aside class="right-rail">
          <div class="kpi-compact" id="forecast-kpi">
            <span class="kpi-emoji">🔮</span>
            <div class="kpi-body">
              <span class="kpi-label">Prognozowane oszczędności</span>
              <span class="kpi-value" id="forecast-content">0</span>
              <span class="tiny muted" id="forecast-note">Przy obecnym tempie wydatków</span>
            </div>
          </div>
          <div class="kpi-compact" id="buffer-kpi">
            <span class="kpi-emoji">💰</span>
            <div class="kpi-body">
              <span class="kpi-label">Zapas/dług na dziś</span>
              <span class="kpi-value" id="buffer-content">0</span>
              <span class="tiny muted" id="buffer-note">Plan vs wydatki do dziś</span>
            </div>
          </div>
          <div class="kpi-compact" id="mom-diff-kpi">
            <span class="kpi-emoji">🆚</span>
            <div class="kpi-body">
              <span class="kpi-label">MoM bez stałych</span>
              <span class="kpi-value" id="dash-mom-diff">—</span>
              <span class="tiny muted" id="dash-mom-note">Porównanie dostępne dla bieżącego miesiąca</span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">💸</span>
            <div class="kpi-body">
              <span class="kpi-label">Pozostały budżet</span>
              <span class="kpi-value" id="dash-remaining">0</span>
              <span class="tiny muted">Na wydatki zmienne</span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">📉</span>
            <div class="kpi-body">
              <span class="kpi-label">Limit dzienny</span>
              <span class="kpi-value" id="dash-daily-budget">0</span>
              <span class="tiny muted">Trend: <span id="dash-daily-trend">—</span></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">📅</span>
            <div class="kpi-body">
              <span class="kpi-label">Wydane dziś</span>
              <span class="kpi-value" id="dash-today-spent">0</span>
              <span class="tiny muted">Status: <span id="dash-today-vs-budget">—</span></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">📊</span>
            <div class="kpi-body">
              <span class="kpi-label">Średnia dzienna</span>
              <span class="kpi-value" id="dash-avg-daily">0</span>
              <span class="tiny muted">Porównanie: <span id="dash-avg-trend">—</span></span>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    (function activateSidebarLink() {
      const currentPage = document.body.dataset.page;
      if (!currentPage) return;
      document.querySelectorAll('.sidebar__link[data-page]').forEach((link) => {
        if (link.dataset.page === currentPage) {
          link.classList.add('sidebar__link--active');
          link.setAttribute('aria-current', 'page');
        } else {
          link.classList.remove('sidebar__link--active');
          link.removeAttribute('aria-current');
        }
      });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // --- Storage & helpers ------------------------------------------------------
  const STORAGE_KEY='lifeos_budget_v4';

  function monthKey(d=new Date()){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
  function ymAdd(ym,delta){const d=new Date(ym+'-01'); d.setMonth(d.getMonth()+delta); return monthKey(d)}
  
  function fmt(n, c = 'PLN') {
    try {
        const numValue = Number(n || 0);
        const parts = numValue.toFixed(2).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "\u00A0");
        return `${parts.join(',')}\u00A0${c}`;
    } catch {
        return `${Number(n || 0).toFixed(2)}\u00A0${c}`;
    }
  }

  function escapeHtml(value){
    if(value === undefined || value === null) return '';
    return String(value).replace(/[&<>"']/g, ch => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":"&#39;"
    }[ch] || ch));
  }

  function num(s){
    if(typeof s==='number') return s;
    if(!s) return 0;
    const raw = String(s).replace(/\s|\u00A0/g,'');
    let normalized = raw;
    if(raw.includes(',') && raw.includes('.')) normalized = raw.replace(/\./g,'').replace(',','.');
    else normalized = raw.replace(',','.');
    normalized = normalized.replace(/[^0-9.\-]/g,'');
    const n = Number(normalized);
    return Number.isFinite(n) ? n : 0;
  }
  function daysInYm(ym){const [y,m]=ym.split('-').map(Number); return new Date(y,m,0).getDate()}
  function dateFromYmDay(ym,day){const d=Math.min(Math.max(1,Number(day)||1), daysInYm(ym)); return `${ym}-${String(d).padStart(2,'0')}`}

  function load(){try{const raw=localStorage.getItem(STORAGE_KEY);return raw?JSON.parse(raw):null}catch{return null}}
  function save(s){localStorage.setItem(STORAGE_KEY,JSON.stringify(s))}

  // --- State Migration & Definition --------------------------------------------
  function migrateState(st){
    if(!st || !st.modules) st={modules:{}};
    if(!st.currency) st.currency = 'PLN';
    if(!st.modules.budget) st.modules.budget={};
    const bud=st.modules.budget;
    if(!Array.isArray(bud.categories)) bud.categories=[];
    bud.categories = bud.categories.map(c=>{
      const id = c?.id || ('cat_'+Math.random().toString(36).slice(2));
      const name = (c?.name || 'Bez nazwy').toString();
      let type = c?.type; if(!['expense','income','saving'].includes(type)) type='expense';
      return {emoji:c?.emoji||'', budget:num(c?.budget)||0, id, name, type};
    });
    if(bud.categories.length===0){
      bud.categories.push(
        {id:'c_inc',name:'Wynagrodzenie',type:'income'},
        {id:'c_save',name:'Oszczędności',type:'saving', emoji:'🏦'},
        {id:'c_fixed',name:'Wydatki stałe',type:'expense',emoji:'💳'},
        {id:'c_food',name:'Jedzenie',type:'expense',emoji:'🍕'},
        {id:'c_transport',name:'Transport',type:'expense',emoji:'🚌'},
        {id:'c_misc',name:'Różne',type:'expense',emoji:'🛒'}
      );
    }
    const cf=bud.categories.find(c=>c.id==='c_fixed' || c.name==='Wydatki stałe');
    if(!cf) bud.categories.unshift({id:'c_fixed',name:'Wydatki stałe',type:'expense',emoji:'💳'});
    else {cf.id='c_fixed'; cf.name='Wydatki stałe'; cf.type='expense'; cf.emoji=cf.emoji||'💳'}

    if(!Array.isArray(bud.accounts)) bud.accounts=[{id:'a_main',name:'Konto główne'}];
    if(!Array.isArray(bud.quickActions)) bud.quickActions=[];
    if(typeof bud.workingMonth!=='string' || !/^\d{4}-\d{2}$/.test(bud.workingMonth)) bud.workingMonth=monthKey();
    if(!bud.monthly) bud.monthly={};
    if(!Array.isArray(bud.transactions)) bud.transactions=[];
    if(!Array.isArray(bud.eom)) bud.eom=[];
    if(!Array.isArray(bud.goals)) bud.goals=[];
    bud.goals = bud.goals.map(g => ({...g, startDate: g.startDate || new Date().toISOString().slice(0,10)}));
    if(!Array.isArray(bud.goalAllocations)) bud.goalAllocations=[];
    if(typeof bud.createTxOnFixedPay!=='boolean') bud.createTxOnFixedPay=true;
    if(!Array.isArray(bud.recurringTemplates)) bud.recurringTemplates=[];
    if(!Array.isArray(bud.recurringLog)) bud.recurringLog=[];
    // NEW: fixed expense templates
    if(!Array.isArray(bud.fixedTemplates)) bud.fixedTemplates=[];
    if(!bud.investments) bud.investments={assets:[], trades:[], groups:[]};
    if(!Array.isArray(bud.investments.assets)) bud.investments.assets=[];
    if(!Array.isArray(bud.investments.trades)) bud.investments.trades=[];
    if(!Array.isArray(bud.investments.groups)) bud.investments.groups=[];
    for(const t of bud.investments.trades){
      if(!t.side) t.side='buy';
      if(t.side==='buy' && !t.fundSource) t.fundSource='budget';
    }
    for(const a of bud.investments.assets){
      if(a.currentPrice===undefined) a.currentPrice=null;
      if(a.priceDate===undefined) a.priceDate=null;
      if(typeof a.priceProvider!=='string') a.priceProvider='manual';
      if(typeof a.priceSymbol!=='string') a.priceSymbol='';
      if(typeof a.priceCurrency!=='string') a.priceCurrency='PLN';
    }

    return st;
  }

  function def(){
    return migrateState({
      version:4, currency:'PLN',
      modules:{budget:{
        categories:[
          {id:'c_inc',name:'Wynagrodzenie',type:'income'},
          {id:'c_save',name:'Oszczędności',type:'saving', emoji:'🏦'},
          {id:'c_fixed',name:'Wydatki stałe',type:'expense',emoji:'💳'},
          {id:'c_food',name:'Jedzenie',type:'expense',emoji:'🍕'},
          {id:'c_transport',name:'Transport',type:'expense',emoji:'🚌'},
          {id:'c_misc',name:'Różne',type:'expense',emoji:'🛒'}
        ],
        accounts:[{id:'a_main',name:'Konto główne'},{id:'a_sav',name:'Oszczędności'}],
        quickActions:[],
        monthly:{},transactions:[],eom:[],goals:[],goalAllocations:[],
        workingMonth:monthKey(),
        createTxOnFixedPay:true,
        recurringTemplates:[],recurringLog:[],
        fixedTemplates:[],
        investments:{assets:[], trades:[], groups:[]}
      }}
    });
  }

  let state = migrateState(load()) || def();
  const b=()=>state.modules.budget;

  // --- Core Helpers ----------------------------------------------------------------
  function ensureMonth(ym){if(!b().monthly[ym]) b().monthly[ym]={ incomes:[], fixed:[] }}
  function setDefaultDate(){const i=document.querySelector('#var-form input[name="date"]'); if(i && !i.value){i.value=new Date().toISOString().slice(0,10)}}
  const catsById=()=>Object.fromEntries((b().categories||[]).map(c=>[c.id,c]));
  function catType(id){const c=catsById()[id];return c?c.type:undefined}
  function signFor(catId, amt){const t=catType(catId); return t==='expense'?-Math.abs(amt):Math.abs(amt)}
  function txTotalSigned(tx){
    if(tx.splits?.length){return tx.splits.reduce((s,sp)=>s+signFor(sp.categoryId,num(sp.amount)),0)}
    return num(tx.amount)
  }
  function entriesForMonth(ym){
    const out=[];
    for(const t of (b().transactions||[])){
      if(!String(t.date||'').startsWith(ym)) continue;
      if(t.splits?.length){
        for(const s of t.splits){
          out.push({date:t.date,categoryId:s.categoryId,accountId:t.accountId,amount:signFor(s.categoryId,num(s.amount)),parentId:t.id,note:t.note});
        }
      }else{
        out.push({date:t.date,categoryId:t.categoryId,accountId:t.accountId,amount:num(t.amount),parentId:t.id,note:t.note});
      }
    }
    return out;
  }

  // --- UI glue ----------------------------------------------------------------
  function bindMoneyInputs(root=document){
    root.querySelectorAll('input[inputmode="decimal"]').forEach(inp=>{
      if(inp.dataset.moneyBound) return;
      inp.dataset.moneyBound='1';
      inp.addEventListener('input', e=>{e.target.value=e.target.value.replace(/\u00A0/g,' ').replace(/[^\d.,\-\s]/g,'')});
      inp.addEventListener('blur', e=>{const v=num(e.target.value); e.target.value=v===0?'':String(v).replace('.',',')});
    });
  }
  const tabs=document.querySelectorAll('.tab');
  const sections={dashboard:tab('dashboard'),overview:tab('overview'),incomes:tab('incomes'),fixed:tab('fixed'),variable:tab('variable'),investments:tab('investments'),categories:tab('categories'),eom:tab('eom'),goals:tab('goals'),analytics:tab('analytics'),mom:tab('mom')};
  const varCard=document.getElementById('var-transactions-card');
  const varSlots={dashboard:document.getElementById('var-table-dashboard-slot'),variable:document.getElementById('var-table-variable-slot')};
  function placeVarCard(target){
    if(!varCard) return;
    const slot=varSlots[target];
    if(slot && varCard.parentElement!==slot){
      slot.appendChild(varCard);
    }
  }
  placeVarCard('dashboard');
  function tab(id){return document.getElementById('tab-'+id)}
  for(const t of tabs){
    t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      Object.values(sections).forEach(s=>s.style.display='none'); sections[t.dataset.tab].style.display='block';
      if(t.dataset.tab==='variable'){placeVarCard('variable'); setDefaultDate()}
      else if(t.dataset.tab==='dashboard'){placeVarCard('dashboard')}
      if(t.dataset.tab==='analytics') renderAnalytics(); // Render analytics when tab is clicked
      if(t.dataset.tab==='eom'){ bindEomV2(); renderEomV2(); }
      if(t.dataset.tab==='mom') renderMomComparison();
      if(t.dataset.tab==='investments') renderInvestments();
      bindMoneyInputs();
    });
  }
  document.getElementById('prevMonthBtn').onclick=()=>{b().workingMonth=ymAdd(b().workingMonth,-1);save(state);renderAll()};
  document.getElementById('nextMonthBtn').onclick=()=>{b().workingMonth=ymAdd(b().workingMonth,1);save(state);renderAll()};
  document.getElementById('exportBtn').onclick=()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`budzet_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove()},0);
  };
  document.getElementById('importBtn').onclick=()=>document.getElementById('importFile').click();
  document.getElementById('importFile').addEventListener('change', async (e)=>{
    const file=e.target.files?.[0]; if(!file) return;
    try{
      const text=await file.text(); const json=JSON.parse(text);
      const migrated=migrateState(json);
      if(!migrated?.modules?.budget){alert('Plik nie wygląda na poprawny eksport.'); return;}
      if(!confirm('Czy na pewno chcesz nadpisać obecne dane danymi z pliku?')) return;
      state=migrated; save(state); location.reload();
    }catch(err){console.error(err); alert('Błąd podczas importu pliku.')}
  });

  // --- Quick actions ----------------------------------------------------------
  function renderQuickActions(){
    const grid=document.getElementById('qa-grid'); grid.innerHTML='';
    for(const qa of (b().quickActions||[])){
      const cat=catsById()[qa.categoryId];
      const btn=document.createElement('div'); btn.className='quick-btn';
      btn.innerHTML=`<div>${qa.emoji||'⚡'} ${qa.label}</div><div class="muted">${cat?.type==='expense'?'Wydatek': cat?.type==='saving'?'Oszczędność':'Wpływ'}</div>`;
      btn.onclick=()=>quickActionRun(qa.id); grid.appendChild(btn);
    }
    fillQaEditorSelects(); renderQuickActionsEditorRows();
  }
  function quickActionRun(id){
    const qa=(b().quickActions||[]).find(x=>x.id===id); if(!qa){alert('Nie znaleziono akcji');return;}
    const amtStr=prompt('Podaj kwotę:', qa.defaultAmount ?? ''); if(amtStr===null) return;
    const amountRaw=num(amtStr);
    const note=prompt('Notatka (opcjonalnie):', qa.defaultNote ?? '')||'';
    const signed = signFor(qa.categoryId, amountRaw);
    const date=new Date().toISOString().slice(0,10);
    b().transactions.unshift({id:`tx_${Math.random().toString(36).slice(2)}`,date,amount:signed,categoryId:qa.categoryId,accountId:qa.accountId||b().accounts[0]?.id||'a_main',note});
    save(state); renderAll();
  }
  function fillQaEditorSelects(){
    const editor=document.getElementById('qa-editor');
    const catSel=editor.querySelector('select[name="categoryId"]'); if(catSel){catSel.innerHTML=''; for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}}
    const accSel=editor.querySelector('select[name="accountId"]'); if(accSel){accSel.innerHTML=''; for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id))}}
  }
  document.getElementById('qa-edit-toggle').onclick=()=>{const ed=document.getElementById('qa-editor'); ed.style.display = ed.style.display==='none' ? 'block' : 'none';};
  document.getElementById('qa-add-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const qa={id:'qa_'+Math.random().toString(36).slice(2),label:String(f.get('label')||''),emoji:String(f.get('emoji')||''),categoryId:String(f.get('categoryId')),accountId:String(f.get('accountId')),defaultAmount:String(f.get('defaultAmount')||''),defaultNote:String(f.get('defaultNote')||'')};
    b().quickActions.push(qa); save(state); e.target.reset(); renderQuickActions(); bindMoneyInputs(document.getElementById('qa-editor'));
  }
  function renderQuickActionsEditorRows(){
    const tbody=document.getElementById('qa-rows'); tbody.innerHTML='';
    for(const qa of (b().quickActions||[])){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input value="${qa.emoji||''}" data-k="emoji" /></td>
        <td><input value="${qa.label||''}" data-k="label" /></td>
        <td><select data-k="categoryId"></select></td>
        <td><select data-k="accountId"></select></td>
        <td><input inputmode="decimal" value="${qa.defaultAmount||''}" data-k="defaultAmount" /></td>
        <td><input value="${qa.defaultNote||''}" data-k="defaultNote" /></td>
        <td class="row" style="gap:6px">
          <button class="btn soft" data-act="save">Zapisz</button>
          <button class="btn danger" data-act="del">X</button>
        </td>`;
      const catSel=tr.querySelector('select[data-k="categoryId"]');
      const accSel=tr.querySelector('select[data-k="accountId"]');
      for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id, false, c.id===qa.categoryId))}
      for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id, false, a.id===qa.accountId))}
      tr.querySelector('[data-act="save"]').onclick=()=>{
        qa.emoji=tr.querySelector('[data-k="emoji"]').value;
        qa.label=tr.querySelector('[data-k="label"]').value;
        qa.categoryId=tr.querySelector('[data-k="categoryId"]').value;
        qa.accountId=tr.querySelector('[data-k="accountId"]').value;
        qa.defaultAmount=tr.querySelector('[data-k="defaultAmount"]').value;
        qa.defaultNote=tr.querySelector('[data-k="defaultNote"]').value;
        save(state); renderQuickActions();
      };
      tr.querySelector('[data-act="del"]').onclick=()=>{ if(!confirm('Usunąć szybką akcję?')) return; b().quickActions=b().quickActions.filter(x=>x.id!==qa.id); save(state); renderQuickActions(); };
      tbody.appendChild(tr);
    }
    bindMoneyInputs(document.getElementById('qa-editor'));
  }
  
  // --- NEW: Fixed Expenses Templates & Suggestions ---------------------------------
  function fixedExistsForTpl(ym, tplId){ensureMonth(ym); return b().monthly[ym].fixed.some(f=>f.tplId===tplId)}

  function applyFixedTemplate(tpl, ym){
    ensureMonth(ym);
    if(fixedExistsForTpl(ym, tpl.id)) return;
    b().monthly[ym].fixed.push({
      id:`fix_${Math.random().toString(36).slice(2)}`,
      tplId: tpl.id, title: tpl.title, amount: num(tpl.amount),
      due: dateFromYmDay(ym, tpl.day), paid:false, categoryId:'c_fixed'
    });
  }

  function renderFixedSuggestions(){
    const ym=b().workingMonth;
    const box=document.getElementById('fix-suggestions-box');
    const list=document.getElementById('fix-suggestions-list');
    
    const candidates=(b().fixedTemplates||[]).filter(t=>!fixedExistsForTpl(ym,t.id));
    if(candidates.length === 0) {
      box.style.display='none';
      return;
    }

    box.style.display='block'; list.innerHTML='';
    for(const t of candidates){
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="row">
          <div><b>${t.title}</b> <span class="muted">(dzień ${t.day})</span></div>
          <b>${fmt(num(t.amount),state.currency)}</b>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="hint">Termin w tym miesiącu: ${dateFromYmDay(ym,t.day)}</div>
          <button class="btn soft" data-act="add">Dodaj</button>
        </div>`;
      card.querySelector('[data-act="add"]').onclick=()=>{applyFixedTemplate(t,ym); save(state); renderAll()};
      list.appendChild(card);
    }
    document.getElementById('fix-apply-all-btn').onclick=()=>{
      for(const t of candidates) applyFixedTemplate(t,ym);
      save(state); renderAll();
    };
  }
  
  function renderFixedTemplatesManager(){
    const form = document.getElementById('fix-template-form');
    form.onsubmit = e => {
      e.preventDefault();
      const f = new FormData(form);
      const tpl = {
        id:'ftpl_'+Math.random().toString(36).slice(2),
        title: String(f.get('title')||'').trim(),
        amount: num(f.get('amount')),
        day: Number(f.get('day'))
      };
      if(!tpl.title || !tpl.amount || !tpl.day) {alert('Uzupełnij wszystkie pola szablonu.'); return;}
      b().fixedTemplates.push(tpl);
      save(state); form.reset(); renderFixedTemplatesManager(); renderFixedSuggestions();
    }

    const tbody = document.getElementById('fix-templates-tbody'); tbody.innerHTML = '';
    for(const t of (b().fixedTemplates||[])) {
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${t.title}</td>
        <td>${fmt(num(t.amount),state.currency)}</td>
        <td>${t.day}</td>
        <td><button class="btn danger" data-act="del">Usuń</button></td>`;
      tr.querySelector('[data-act="del"]').onclick=()=>{
        if(!confirm(`Czy na pewno usunąć szablon "${t.title}"?`)) return;
        b().fixedTemplates = b().fixedTemplates.filter(x => x.id !== t.id);
        save(state); renderFixedTemplatesManager(); renderFixedSuggestions();
      };
      tbody.appendChild(tr);
    }
    bindMoneyInputs(form);
  }

  // --- Daily calculations (spending + savings) --------------------------------
  function getDailySpending(ym){
    const daily={};
    const entries=entriesForMonth(ym);
    for(const e of entries){
      const c=catsById()[e.categoryId];
      if(!c || !((c.type==='expense' && c.id!=='c_fixed') || c.type==='saving')) continue;
      const day=parseInt(e.date.slice(-2));
      daily[day]=(daily[day]||0)+Math.abs(e.amount);
    }
    return daily;
  }
  function getDaysRemaining(ym){
    const today=new Date(); const currentYm=monthKey(today);
    if(ym < currentYm) return 0; // Past month
    if(ym > currentYm) return daysInYm(ym); // Future month
    // Current month
    const daysInMonth = daysInYm(ym);
    return Math.max(0, daysInMonth - today.getDate());
  }

  // --- Dashboard --------------------------------------------------------------
  function renderDashboard(){
    const ym=b().workingMonth; ensureMonth(ym);
    const incSum=b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
    const fixSum=b().monthly[ym].fixed.reduce((s,x)=>s+num(x.amount),0);
    const days=daysInYm(ym);
    const dailyBudget=Math.max(0,(incSum-fixSum)/days);

      const entries=entriesForMonth(ym);
      const cb=catsById();
    
    const variableSpent = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return (c?.type === 'expense' && c.id !== 'c_fixed') ? s + Math.abs(e.amount) : s;
    }, 0);
    const savingsTransfers = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return c?.type === 'saving' ? s + Math.abs(e.amount) : s;
    }, 0);
    const remain = incSum - fixSum - variableSpent - savingsTransfers;

    document.getElementById('dash-remaining').textContent=fmt(remain, state.currency);
    document.getElementById('dash-daily-budget').textContent=fmt(dailyBudget, state.currency);

    const todayKey=new Date().toISOString().slice(0,10);
    const todaySpent=entries.filter(e=>e.date===todayKey).reduce((s,e)=>{
      const c=cb[e.categoryId];
      return (!c || !((c.type==='expense' && c.id!=='c_fixed') || c.type==='saving')) ? s : s + Math.abs(e.amount);
    },0);
    document.getElementById('dash-today-spent').textContent=fmt(todaySpent, state.currency);
    document.getElementById('dash-today-vs-budget').textContent = todaySpent<=dailyBudget ? '✅ w limicie dziennym' : '⚠️ powyżej limitu';

    const daysElapsed = (ym === monthKey()) ? new Date().getDate() : (monthKey() > ym ? days : 0);
    const daily=getDailySpending(ym);
    const spentSoFar=Object.values(daily).reduce((a,b)=>a+b,0);
    const avgDaily = (daysElapsed > 0 ? (spentSoFar / daysElapsed) : 0);
    document.getElementById('dash-avg-daily').textContent=fmt(avgDaily, state.currency);
    document.getElementById('dash-avg-trend').textContent = avgDaily <= dailyBudget ? '👍 poniżej planu' : '👎 powyżej planu';

    // Heatmap
    const cal=document.getElementById('daily-spending-calendar'); cal.innerHTML='';
    for(let d=1; d<=days; d++){
      const val=daily[d]||0;
      const box=document.createElement('div');
      let bg='#edf2f7'; // default for no spending
      if (val > 0) bg = '#dcfce7'; // in budget
      if(val>dailyBudget*1.2) bg='#fee2e2'; else if(val>dailyBudget) bg='#ffedd5';
      box.className='heat-day'; box.style.background=bg; box.title=`${String(d).padStart(2,'0')}: ${fmt(val, state.currency)}`; box.textContent=String(d);
      cal.appendChild(box);
    }

    renderRecentSpendingTiles();

    // --- Forecast & Buffer Section (NEW) ---
    const daysLeft = getDaysRemaining(ym);
    const totalVariableBudget = incSum - fixSum;
    const projectedTotalVariableOutflow = spentSoFar + (daysLeft * avgDaily);
    const forecastedSavings = totalVariableBudget - projectedTotalVariableOutflow;
    
    const forecastEl = document.getElementById('forecast-content');
    const forecastNote = document.getElementById('forecast-note');
    forecastEl.textContent = fmt(forecastedSavings, state.currency);
    forecastEl.classList.remove('ok', 'bad');
    forecastEl.classList.add(forecastedSavings >= 0 ? 'ok' : 'bad');
    forecastNote.textContent = forecastedSavings >= 0
      ? 'Możliwa nadwyżka przy obecnym tempie'
      : 'Ryzyko przekroczenia budżetu zmiennego';

    const bufferEl = document.getElementById('buffer-content');
    const bufferNote = document.getElementById('buffer-note');
    bufferEl.classList.remove('ok', 'bad');
    if (ym === monthKey() && daysElapsed > 0 && daysElapsed <= days) {
      const dayOfMonth = new Date().getDate();
      const allowedToSpendUntilToday = dailyBudget * dayOfMonth;
      const spentUntilToday = Object.entries(daily)
        .filter(([day]) => parseInt(day) <= dayOfMonth)
        .reduce((sum, [, amount]) => sum + amount, 0);
      const buffer = allowedToSpendUntilToday - spentUntilToday;
      bufferEl.textContent = fmt(buffer, state.currency);
      bufferEl.classList.add(buffer >= 0 ? 'ok' : 'bad');
      bufferNote.textContent = `Plan: ${fmt(allowedToSpendUntilToday, state.currency)} | Wydano: ${fmt(spentUntilToday, state.currency)}`;
    } else {
      bufferEl.textContent = '—';
      bufferNote.textContent = 'Dostępne tylko dla bieżącego miesiąca';
    }

    const momDiffValueEl = document.getElementById('dash-mom-diff');
    const momDiffNoteEl = document.getElementById('dash-mom-note');
    if (momDiffValueEl && momDiffNoteEl) {
      momDiffValueEl.classList.remove('ok', 'bad');
      if (ym === monthKey() && daysElapsed > 0 && daysElapsed <= days) {
        const today = new Date();
        const dayOfMonth = today.getDate();
        const currentDayLimit = Math.min(dayOfMonth, days);
        const prevYm = ymAdd(ym, -1);
        const prevDayLimit = Math.min(currentDayLimit, daysInYm(prevYm));
        const sumVariableToDay = (targetYm, limit) => {
          if (!limit) return 0;
          return entriesForMonth(targetYm).reduce((acc, entry) => {
            const cat = cb[entry.categoryId];
            if (!cat || cat.type !== 'expense' || cat.id === 'c_fixed') return acc;
            const day = Number(entry.date.slice(8, 10));
            if (!Number.isFinite(day) || day > limit) return acc;
            return acc + Math.abs(entry.amount);
          }, 0);
        };
        const currentSpent = sumVariableToDay(ym, currentDayLimit);
        const previousSpent = sumVariableToDay(prevYm, prevDayLimit);
        const diff = currentSpent - previousSpent;
        const diffFormatted = fmt(diff, state.currency);
        momDiffValueEl.textContent = diff > 0 ? `+${diffFormatted}` : diffFormatted;
        if (diff > 0) {
          momDiffValueEl.classList.add('bad');
        } else if (diff < 0) {
          momDiffValueEl.classList.add('ok');
        }
        const currentDayLabel = String(currentDayLimit).padStart(2, '0');
        const prevDayLabel = String(prevDayLimit).padStart(2, '0');
        const dayNote = prevDayLimit === currentDayLimit ? currentDayLabel : `${currentDayLabel} / ${prevDayLabel}`;
        momDiffNoteEl.textContent = `${ym}: ${fmt(currentSpent, state.currency)} | ${prevYm}: ${fmt(previousSpent, state.currency)} (do dnia ${dayNote})`;
      } else {
        momDiffValueEl.textContent = '—';
        momDiffNoteEl.textContent = 'Dostępne tylko dla bieżącego miesiąca';
      }
    }

    renderDashboardCharts(ym, dailyBudget, avgDaily);
    renderQuickActions();
  }

  function currencyTicks(v) {
    try {
        const numValue = Math.round(Number(v || 0));
        const integerPart = String(numValue).replace(/\B(?=(\d{3})+(?!\d))/g, "\u00A0");
        return `${integerPart}\u00A0${state.currency || 'PLN'}`;
    } catch {
        return `${Math.round(Number(v || 0))}\u00A0${state.currency || 'PLN'}`;
    }
  }

  function renderRecentSpendingTiles(){
    const container=document.getElementById('recent-spending-calendar');
    if(!container) return;
    container.innerHTML='';
    const totalChip=document.getElementById('recent-seven-total');
    const today=new Date();
    today.setHours(0,0,0,0);
    const dayKeyFromDate=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const dayDates=[];
    for(let offset=6; offset>=0; offset--){
      const d=new Date(today);
      d.setDate(today.getDate()-offset);
      dayDates.push(d);
    }
    const months=[...new Set(dayDates.map(d=>monthKey(d)))];
    let allEntries=[];
    for(const ym of months){
      allEntries=allEntries.concat(entriesForMonth(ym));
    }
    const cb=catsById();
    const accountsById=Object.fromEntries((b().accounts||[]).map(acc=>[acc.id,acc]));
    const startKey=dayKeyFromDate(dayDates[0]);
    const endKey=dayKeyFromDate(dayDates[dayDates.length-1]);
    const filteredBase=[];
    for(const entry of allEntries){
      if(entry.date<startKey || entry.date>endKey) continue;
      const cat=cb[entry.categoryId];
      if(!cat || cat.type!=='expense' || cat.id==='c_fixed') continue;
      const amount=Math.abs(entry.amount);
      if(amount<=0) continue;
      filteredBase.push({entry, amount, cat});
    }
    const filtered=filteredBase.map((item, idx)=>({...item, idx}));
    const totalAmount=filtered.reduce((sum,item)=>sum+item.amount,0);
    if(totalChip){
      totalChip.textContent=filtered.length?`Łącznie: ${fmt(totalAmount, state.currency)}`:'Łącznie: —';
    }
    const topIdx=new Set(filtered.slice().sort((a,b)=>b.amount-a.amount).slice(0,5).map(item=>item.idx));
    const grouped=new Map();
    for(const item of filtered){
      if(!grouped.has(item.entry.date)) grouped.set(item.entry.date, []);
      grouped.get(item.entry.date).push(item);
    }
    const weekdayFmt=new Intl.DateTimeFormat('pl-PL',{weekday:'short'});
    const dateFmt=new Intl.DateTimeFormat('pl-PL',{day:'2-digit',month:'2-digit'});
    const tooltipDateFmt=new Intl.DateTimeFormat('pl-PL',{year:'numeric',month:'short',day:'2-digit'});
    for(const dateObj of dayDates){
      const key=dayKeyFromDate(dateObj);
      const tile=document.createElement('div');
      tile.className='recent-day';
      const header=document.createElement('div');
      header.className='recent-day-header';
      const weekdayEl=document.createElement('span');
      weekdayEl.className='recent-day-weekday';
      weekdayEl.textContent=weekdayFmt.format(dateObj).replace('.', '').toUpperCase();
      const dateEl=document.createElement('span');
      dateEl.className='recent-day-date';
      dateEl.textContent=dateFmt.format(dateObj);
      header.append(weekdayEl, dateEl);
      tile.appendChild(header);
      const dayItems=(grouped.get(key)||[]).sort((a,b)=>b.amount-a.amount);
      const dayTotal=dayItems.reduce((sum,item)=>sum+item.amount,0);
      const total=document.createElement('div');
      total.className='recent-day-total';
      const totalIcon=document.createElement('span');
      totalIcon.setAttribute('aria-hidden','true');
      totalIcon.textContent='💰';
      total.append(totalIcon, document.createTextNode(dayItems.length?fmt(dayTotal, state.currency):'—'));
      if(dayItems.length===0){
        tile.classList.add('recent-day-empty');
      }
      tile.appendChild(total);
      const body=document.createElement('div');
      body.className='recent-day-body';
      if(dayItems.length===0){
        const empty=document.createElement('div');
        empty.className='recent-empty';
        empty.textContent='brak ruchu';
        body.appendChild(empty);
      }else{
        const maxVisible=2;
        const extraRows=[];
        dayItems.forEach((item, idx)=>{
          const row=document.createElement('div');
          row.className='recent-entry';
          if(topIdx.has(item.idx)) row.classList.add('top-spend');
          if(idx>=maxVisible){
            row.classList.add('recent-entry-hidden');
            extraRows.push(row);
          }
          const emoji=item.cat?.emoji||'💸';
          const emojiEl=document.createElement('span');
          emojiEl.className='recent-entry-emoji';
          emojiEl.textContent=emoji;
          const textWrap=document.createElement('div');
          textWrap.className='recent-entry-text';
          const amountEl=document.createElement('span');
          amountEl.className='recent-entry-amount';
          amountEl.textContent=fmt(item.amount, state.currency);
          textWrap.appendChild(amountEl);
          const noteText=(item.entry.note||'').trim();
          if(noteText){
            const noteEl=document.createElement('span');
            noteEl.className='recent-entry-note';
            noteEl.textContent=noteText;
            textWrap.appendChild(noteEl);
          }
          const [yy,mm,dd]=item.entry.date.split('-').map(Number);
          const entryDate=new Date(yy, (mm||1)-1, dd||1);
          const tooltipParts=[
            [emoji, item.cat?.name||'Wydatek'].filter(Boolean).join(' '),
            `Kwota: ${fmt(item.amount, state.currency)}`,
            `Data: ${tooltipDateFmt.format(entryDate)}`,
            `Konto: ${accountsById[item.entry.accountId]?.name||'—'}`
          ];
          if(item.entry.note){
            tooltipParts.push(`Notatka: ${item.entry.note}`);
          }
          row.title=tooltipParts.join('\n');
          row.setAttribute('aria-label', tooltipParts.join(', '));
          row.append(emojiEl, textWrap);
          body.appendChild(row);
        });
        if(extraRows.length){
          const collapsedLabel=`+${extraRows.length}`;
          const toggle=document.createElement('button');
          toggle.type='button';
          toggle.className='recent-more';
          toggle.textContent=collapsedLabel;
          toggle.title='Pokaż więcej wydatków';
          toggle.setAttribute('aria-expanded','false');
          toggle.addEventListener('click',()=>{
            const expanded=tile.classList.toggle('expanded');
            extraRows.forEach(row=>row.classList.toggle('recent-entry-hidden', !expanded));
            toggle.textContent=expanded?'−':collapsedLabel;
            toggle.setAttribute('aria-expanded', expanded?'true':'false');
          });
          body.appendChild(toggle);
        }
      }
      tile.appendChild(body);
      container.appendChild(tile);
    }
  }

  function renderDashboardCharts(ym, dailyBudget, avgDaily) {
    const dailyCtx=document.getElementById('dailyLine').getContext('2d');
    const cumCtx=document.getElementById('cumulativeLine').getContext('2d');
    if(window.dashDaily) window.dashDaily.destroy();
    if(window.dashCum) window.dashCum.destroy();
    
    const daysInMonth=daysInYm(ym);
    const dailySpending=getDailySpending(ym);
    const labels=[]; const spendData=[]; const cumSpend=[]; const cumAllowed=[];
    let runningTotal=0;
    
    for(let d=1; d<=daysInMonth; d++){
      labels.push(d.toString());
      const dailyS=dailySpending[d]||0; 
      spendData.push(dailyS); 
      runningTotal+=dailyS; 
      cumSpend.push(runningTotal); 
      cumAllowed.push(d*dailyBudget);
    }
    
    const backgroundColors = [];
    const borderColors = [];
    for(const spending of spendData) {
        let color;
        if (spending === 0) {
            color = 'rgba(100, 116, 139, 0.5)'; // Muted
        } else if (spending > dailyBudget * 1.2) {
            color = 'rgba(190, 18, 60, 0.7)'; // Red
        } else if (spending > dailyBudget) {
            color = 'rgba(234, 88, 12, 0.7)'; // Orange
        } else {
            color = 'rgba(5, 150, 105, 0.7)'; // Green
        }
        backgroundColors.push(color);
        borderColors.push(color.replace(/0\.\d+\)/, '1)'));
    }
    const entries = entriesForMonth(ym);
    const cb = catsById();

    window.dashDaily = new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'Wydatki dzienne',
                    data: spendData,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1,
                    order: 3
                },
                {
                    type: 'line',
                    label: 'Limit dzienny',
                    data: Array(daysInMonth).fill(dailyBudget),
                    borderColor: 'rgba(190, 18, 60, 0.7)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [6, 6],
                    tension: 0.1,
                    order: 1
                },
                {
                    type: 'line',
                    label: 'Średnia dzienna',
                    data: Array(daysInMonth).fill(avgDaily),
                    borderColor: 'rgba(234, 88, 12, 0.7)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    order: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: currencyTicks }
                },
                x: {
                    grid: { display: false }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${fmt(context.raw, state.currency)}`;
                        },
                        afterBody: function(tooltipItems) {
                            const dataIndex = tooltipItems[0].dataIndex;
                            const day = dataIndex + 1;
                            const dayString = `${ym}-${String(day).padStart(2, '0')}`;

                            const dayExpenses = entries
                                .filter(e => {
                                    const cat = cb[e.categoryId];
                                    return e.date === dayString && cat && (cat.type === 'expense' || cat.type === 'saving') && cat.id !== 'c_fixed';
                                })
                                .sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount));
                            
                            if (dayExpenses.length === 0) {
                                return [];
                            }

                            const top3 = dayExpenses.slice(0, 3);
                            const lines = top3.map(e => {
                                const cat = cb[e.categoryId];
                                return `  ${cat.emoji||'💸'} ${cat.name.slice(0,15)}: ${fmt(Math.abs(e.amount), '')}`;
                            });
                            
                            lines.unshift('');
                            lines.unshift('Największe wydatki:');
                            return lines;
                        }
                    }
                }
            }
        }
    });

    window.dashCum=new Chart(cumCtx,{type:'line',data:{labels,datasets:[{label:'Skumulowane wydatki',data:cumSpend,borderColor:'#be123c',backgroundColor:'rgba(190,18,60,0.08)',tension:0.3,fill:true},{label:'Skumulowany limit',data:cumAllowed,borderColor:'#059669',backgroundColor:'rgba(5,150,105,0.08)',tension:0.3,fill:true}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:currencyTicks}}}}});
  }

  // --- Overview ---------------------------------------------------------------
  function renderOverview(){
    const ym=b().workingMonth; ensureMonth(ym);
    document.getElementById('ov-month').textContent=ym;
    const cb=catsById();
    
    const incomes = b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
    
    const fixedAll = b().monthly[ym].fixed;
    const fixedPlanned = fixedAll.reduce((s,x)=>s+num(x.amount),0);
    const fixedPaid = fixedAll.filter(f => f.paid).reduce((s,x)=>s+num(x.amount),0);
    const fixedUnpaid = fixedPlanned - fixedPaid;

    const entries = entriesForMonth(ym);
    const varSpent = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return (c?.type === 'expense' && c.id !== 'c_fixed') ? s + Math.abs(e.amount) : s;
    }, 0);
    const savingsTransfers = entries.reduce((s, e) => {
        const c = cb[e.categoryId];
        return c?.type === 'saving' ? s + Math.abs(e.amount) : s;
    }, 0);

    const remainingVariableBudget = incomes - fixedPlanned - varSpent - savingsTransfers;

    const days = daysInYm(ym);
    const daysElapsed = (ym === monthKey()) ? new Date().getDate() : (monthKey() > ym ? days : 0);
    const dailySpending = getDailySpending(ym);
    const spentSoFar = Object.values(dailySpending).reduce((a,b)=>a+b,0);
    const avgDaily = (daysElapsed > 0 ? (spentSoFar / daysElapsed) : 0);
    const daysLeft = getDaysRemaining(ym);
    const projectedTotalVariableOutflow = spentSoFar + (daysLeft * avgDaily);
    const forecastedSavings = (incomes - fixedPlanned) - projectedTotalVariableOutflow;
    const savingsRate = incomes > 0 ? (forecastedSavings / incomes) * 100 : 0;
    
    document.getElementById('ov-inc').textContent = fmt(incomes, state.currency);
    document.getElementById('ov-fixed-planned').textContent = fmt(fixedPlanned, state.currency);
    document.getElementById('ov-fixed-paid').textContent = fmt(fixedPaid, state.currency);
    document.getElementById('ov-fixed-unpaid').textContent = fmt(fixedUnpaid, state.currency);
    document.getElementById('ov-var-spent').textContent = fmt(varSpent, state.currency);
    document.getElementById('ov-savings').textContent = fmt(savingsTransfers, state.currency);
    document.getElementById('ov-remaining').textContent = fmt(remainingVariableBudget, state.currency);
    document.getElementById('stat-savings-rate').textContent = savingsRate.toFixed(0)+'%';
  }

  // --- Forms ------------------------------------------------------------------
  document.getElementById('inc-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target); const ym=b().workingMonth; ensureMonth(ym);
    b().monthly[ym].incomes.push({id:`inc_${Math.random().toString(36).slice(2)}`,amount:num(f.get('amount')),note:String(f.get('note')||'')});
    save(state); e.target.reset(); renderAll();
  };

  const fixForm=document.getElementById('fix-form');
  fixForm.onsubmit=(e)=>{e.preventDefault(); const f=new FormData(fixForm); const ym=b().workingMonth; ensureMonth(ym);
    b().monthly[ym].fixed.push({id:`fix_${Math.random().toString(36).slice(2)}`,title:String(f.get('title')),amount:num(f.get('amount')),due:f.get('due')||null,paid:false,categoryId:'c_fixed'});
    save(state); fixForm.reset(); renderAll()
  };
  document.getElementById('autoTx').onchange=(e)=>{b().createTxOnFixedPay=e.target.checked; save(state)};

  const varForm=document.getElementById('var-form');
  varForm.onsubmit=(e)=>{e.preventDefault(); const f=new FormData(varForm);
    const date=String(f.get('date')||new Date().toISOString().slice(0,10));
    const amount=num(f.get('amount')); const categoryId=String(f.get('categoryId')); const accountId=String(f.get('accountId')); const note=String(f.get('note')||'');
    const signed= signFor(categoryId, amount);
    b().transactions.unshift({id:`tx_${Math.random().toString(36).slice(2)}`,date,amount:signed,categoryId,accountId,note});
    save(state); varForm.reset(); setDefaultDate(); renderAll()
  };

  document.getElementById('cat-form').onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const c={id:`cat_${Math.random().toString(36).slice(2)}`,name:String(f.get('name')),type:String(f.get('type')),emoji:String(f.get('emoji')||''),budget:num(f.get('budget'))||0};
    b().categories.push(c);
    save(state); e.target.reset(); renderAll();
  };

  document.getElementById('goal-form').onsubmit=(e)=>{e.preventDefault(); const f=new FormData(e.target);
    const startDate = String(f.get('startdate') || new Date().toISOString().slice(0,10));
    b().goals.push({id:`goal_${Math.random().toString(36).slice(2)}`,name:String(f.get('name')),target:num(f.get('target')),deadline:String(f.get('deadline')||'')||undefined, startDate});
    save(state); e.target.reset(); renderGoals()
  };
  
  const allocForm = document.getElementById('alloc-form');
  const allocCancelBtn = document.getElementById('alloc-cancel-btn');

  allocForm.onsubmit = (e) => {
    e.preventDefault();
    const f = new FormData(allocForm);
    const allocId = f.get('allocId');
    const goalId = String(f.get('goalId'));
    const date = String(f.get('date') || new Date().toISOString().slice(0, 10));
    const amount = num(f.get('amount'));

    if (!goalId || !amount) {
        alert('Wybierz cel i podaj kwotę.');
        return;
    }

    if (allocId) {
        // Edit mode
        const index = b().goalAllocations.findIndex(a => a.id === allocId);
        if (index > -1) {
            b().goalAllocations[index] = { ...b().goalAllocations[index], goalId, date, amount, ym: date.slice(0,7) };
        }
    } else {
        // Add mode
        b().goalAllocations.unshift({ id: `alloc_${Math.random().toString(36).slice(2)}`, goalId, ym: date.slice(0, 7), date, amount });
    }
    
    save(state);
    resetAllocForm();
    renderGoals();
  };

  allocCancelBtn.onclick = resetAllocForm;

  function renderGoals(){
    const list=document.getElementById('goal-list');
    const summary=document.getElementById('goal-summary');
    const timelineWrapper=document.getElementById('goal-timeline-wrapper');
    const commitmentWrapper=document.getElementById('goal-commitment-table')?.parentElement?.parentElement;
    if(list) list.innerHTML='';
    if(summary) summary.innerHTML='';

    const goals=b().goals||[];
    const allocations=b().goalAllocations||[];
    const totalAllocatedByGoal=allocations.reduce((m,a)=>{m[a.goalId]=(m[a.goalId]||0)+num(a.amount);return m;},{});

    if(goals.length===0){
      if(list) list.innerHTML='<p class="muted" style="text-align:center;">Brak zdefiniowanych celów. Użyj formularza powyżej, aby dodać swój pierwszy cel!</p>';
      if(timelineWrapper) timelineWrapper.style.display='none';
      if(commitmentWrapper) commitmentWrapper.style.display='none';
      if(summary) summary.style.display='none';
      return;
    }

    if(timelineWrapper) timelineWrapper.style.display='block';
    if(commitmentWrapper) commitmentWrapper.style.display='block';
    if(summary) summary.style.display='block';

    let totalTarget=0;
    let totalCollected=0;

    for(const g of goals){
      const collected=totalAllocatedByGoal[g.id]||0;
      totalTarget+=num(g.target);
      totalCollected+=collected;
      const pct=g.target>0?Math.min(100,(collected/g.target)*100):0;

      let monthlyNeeded='';
      if(g.deadline && g.startDate){
        const startDate=new Date(g.startDate);
        const deadlineDate=new Date(g.deadline);
        if(deadlineDate>startDate){
          const monthsLeft=Math.max(1,(deadlineDate.getFullYear()-startDate.getFullYear())*12+(deadlineDate.getMonth()-startDate.getMonth())+1);
          const needed=Math.max(0,g.target-collected);
          const monthly=needed/monthsLeft;
          monthlyNeeded=`<div class="muted" style="font-size:12px">Sugerowana wpłata miesięczna: ${fmt(monthly,state.currency)}</div>`;
        }
      }

      const card=document.createElement('div');
      card.className='card';
      card.id=`goal-card-${g.id}`;
      card.innerHTML=`
        <div data-view="display">
          <div class="row">
            <div><b>${g.name}</b> <span class="muted">${g.startDate ? `${g.startDate} → ` : ''}${g.deadline || ''}</span></div>
            <div>${fmt(collected,state.currency)} / ${fmt(g.target,state.currency)}</div>
          </div>
          <div class="progress ${pct>=100?'good':pct>=75?'warn':''}" style="margin-top:6px"><i style="width:${pct}%"></i></div>
          <div class="muted" style="font-size:12px;margin-top:4px">Postęp: ${pct.toFixed(0)}%</div>
          ${monthlyNeeded}
          <div class="row" style="margin-top:8px; justify-content: flex-end; gap:8px;">
            <button class="btn soft" data-act="edit">Edytuj</button>
            <button class="btn danger" data-act="del">Usuń</button>
          </div>
        </div>`;

      card.querySelector('[data-act="edit"]').onclick=()=>startEditGoal(g.id);
      card.querySelector('[data-act="del"]').onclick=()=>{
        if(!confirm('Usunąć cel (razem z alokacjami)?')) return;
        state.modules.budget.goals=(b().goals||[]).filter(x=>x.id!==g.id);
        state.modules.budget.goalAllocations=(b().goalAllocations||[]).filter(a=>a.goalId!==g.id);
        save(state);
        renderGoals();
      };
      list?.appendChild(card);
    }

    const totalProgressPct=totalTarget>0?(totalCollected/totalTarget)*100:0;
    if(summary){
      summary.innerHTML=`
        <div class="row">
          <div class="stat-card" style="flex:1;"><div class="muted">Łącznie do zebrania</div><div class="big-number">${fmt(totalTarget,state.currency)}</div></div>
          <div class="stat-card" style="flex:1;"><div class="muted">Zebrano do tej pory</div><div class="big-number">${fmt(totalCollected,state.currency)}</div></div>
        </div>
        <div style="margin-top:8px;">
          <div class="muted">Całkowity postęp</div>
          <div class="progress ${totalProgressPct>=100?'good':totalProgressPct>=75?'warn':''}" style="margin-top:4px;height:12px;"><i style="width:${totalProgressPct}%"></i></div>
          <div class="muted" style="font-size:12px;margin-top:4px">${totalProgressPct.toFixed(1)}%</div>
        </div>
      `;
    }

    renderGoalsTimeline();
    renderAllocSelect();
    renderAllocationsHistory();
    setDefaultDateForAlloc();
  }

  function startEditGoal(id){
    const goal=(b().goals||[]).find(g=>g.id===id);
    if(!goal) return;
    const card=document.getElementById(`goal-card-${id}`);
    if(!card) return;
    card.innerHTML=`
      <div data-view="edit" class="grid g-4">
        <input name="name" value="${goal.name}" placeholder="Nazwa celu" style="grid-column: 1 / 3;"/>
        <input name="target" value="${String(goal.target).replace('.',',')}" placeholder="Kwota" inputmode="decimal" style="grid-column: 3 / 5;"/>
        <label class="tiny" style="grid-column: 1 / 3;">Początek oszczędzania<input name="startdate" type="date" value="${goal.startDate||''}" /></label>
        <label class="tiny" style="grid-column: 3 / 5;">Termin końcowy<input name="deadline" type="date" value="${goal.deadline||''}" /></label>
        <div class="row" style="grid-column: 1 / -1; justify-content: flex-end; gap:8px;">
          <button class="btn ghost" data-act="cancel">Anuluj</button>
          <button class="btn" data-act="save">Zapisz</button>
        </div>
      </div>`;
    bindMoneyInputs(card);
    card.querySelector('[data-act="save"]').onclick=()=>{
      goal.name=card.querySelector('[name="name"]').value;
      goal.target=num(card.querySelector('[name="target"]').value);
      goal.startDate=card.querySelector('[name="startdate"]').value||new Date().toISOString().slice(0,10);
      goal.deadline=card.querySelector('[name="deadline"]').value||undefined;
      save(state);
      renderGoals();
    };
    card.querySelector('[data-act="cancel"]').onclick=()=>renderGoals();
  }

  function renderGoalsTimeline(){
    const timeline=document.getElementById('goal-timeline');
    const axis=document.getElementById('timeline-axis');
    const labelsDiv=document.getElementById('timeline-labels');
    if(timeline) timeline.innerHTML='';
    if(axis) axis.innerHTML='';
    if(labelsDiv) labelsDiv.innerHTML='';

    const goalsWithDeadline=(b().goals||[]).filter(g=>g.deadline && g.startDate).sort((a,b)=>new Date(a.deadline)-new Date(b.deadline));
    if(goalsWithDeadline.length===0) return;

    const earliestStartDate=new Date(Math.min(...goalsWithDeadline.map(g=>new Date(g.startDate))));
    const furthestDeadline=new Date(Math.max(...goalsWithDeadline.map(g=>new Date(g.deadline))));
    const totalDurationDays=(furthestDeadline-earliestStartDate)/(1000*60*60*24);
    if(totalDurationDays<=0) return;

    const totalAllocatedByGoal=(b().goalAllocations||[]).reduce((m,a)=>{m[a.goalId]=(m[a.goalId]||0)+num(a.amount);return m;},{});

    let topOffset=0;
    for(const g of goalsWithDeadline){
      const startDate=new Date(g.startDate);
      const deadline=new Date(g.deadline);
      const duration=(deadline-startDate)/(1000*60*60*24);
      const left=((startDate-earliestStartDate)/(1000*60*60*24)/totalDurationDays)*100;
      const width=(duration/totalDurationDays)*100;
      const collected=totalAllocatedByGoal[g.id]||0;
      const pct=g.target>0?Math.min(100,(collected/g.target)*100):0;
      const bar=document.createElement('div');
      bar.className='timeline-bar';
      bar.style.top=`${topOffset}px`;
      bar.style.left=`${left}%`;
      bar.style.width=`${width}%`;
      bar.style.background=`linear-gradient(90deg, #3b82f6 ${pct}%, #93c5fd ${pct}%)`;
      bar.title=`${g.name}: ${pct.toFixed(0)}% zrealizowano (${fmt(collected)} / ${fmt(g.target)})`;
      bar.innerHTML=`<span class="bar-label">${g.name}</span> <span class="bar-progress">${pct.toFixed(0)}%</span>`;
      timeline?.appendChild(bar);
      topOffset+=30;
    }
    if(timeline) timeline.style.height=`${topOffset}px`;

    const monthlyCommitments={};
    goalsWithDeadline.forEach(g=>{
      const collected=totalAllocatedByGoal[g.id]||0;
      const needed=Math.max(0,num(g.target)-collected);
      const startDate=new Date(g.startDate);
      const deadlineDate=new Date(g.deadline);
      if(deadlineDate>startDate){
        const monthsLeft=Math.max(1,(deadlineDate.getFullYear()-startDate.getFullYear())*12+(deadlineDate.getMonth()-startDate.getMonth())+1);
        const monthlyAmount=needed/monthsLeft;
        for(let i=0;i<monthsLeft;i++){
          const targetMonth=ymAdd(monthKey(startDate),i);
          if(!monthlyCommitments[targetMonth]) monthlyCommitments[targetMonth]={};
          monthlyCommitments[targetMonth][g.id]=monthlyAmount;
        }
      }
    });

    const axisMonths=[];
    const iter=new Date(earliestStartDate.getFullYear(),earliestStartDate.getMonth(),1);
    while(iter<=furthestDeadline){
      axisMonths.push(new Date(iter));
      iter.setMonth(iter.getMonth()+1);
    }

    if(axis){
      axis.innerHTML=axisMonths.map(month=>{
        const monthStart=new Date(month.getFullYear(),month.getMonth(),1);
        const left=((monthStart-earliestStartDate)/(1000*60*60*24)/totalDurationDays)*100;
        if(left<0||left>100) return '';
        return `<div style="position:absolute; left: ${left}%; transform: translateX(-50%);">${month.toLocaleString('pl-PL',{month:'short',year:'numeric'})}</div>`;
      }).join('');
    }

    if(labelsDiv){
      labelsDiv.innerHTML=axisMonths.map(month=>{
        const ym=monthKey(month);
        const monthMid=new Date(month.getFullYear(),month.getMonth(),15);
        const left=((monthMid-earliestStartDate)/(1000*60*60*24)/totalDurationDays)*100;
        const totalForMonth=Object.values(monthlyCommitments[ym]||{}).reduce((s,a)=>s+a,0);
        if(left<0||left>100||totalForMonth===0) return '';
        return `<div class="timeline-label" style="left: ${left}%;">${fmt(totalForMonth,state.currency)}</div>`;
      }).join('');
    }

    renderGoalCommitmentTable(monthlyCommitments,goalsWithDeadline);
  }

  function renderGoalCommitmentTable(monthlyCommitments,goals){
    const table=document.getElementById('goal-commitment-table');
    if(!table) return;
    if(goals.length===0){ table.innerHTML=''; return; }
    let header='<thead><tr><th>Miesiąc</th>';
    goals.forEach(g=>{header+=`<th>${g.name}</th>`;});
    header+='<th>Suma miesięczna</th></tr></thead>';
    const months=Object.keys(monthlyCommitments).sort();
    let body='<tbody>';
    months.forEach(ym=>{
      let monthlyTotal=0;
      body+=`<tr><td><b>${ym}</b></td>`;
      goals.forEach(g=>{
        const amount=monthlyCommitments[ym]?.[g.id]||0;
        if(amount>0){
          body+=`<td>${fmt(amount,state.currency)}</td>`;
          monthlyTotal+=amount;
        }else{
          body+='<td class="muted">—</td>';
        }
      });
      body+=`<td><b>${fmt(monthlyTotal,state.currency)}</b></td></tr>`;
    });
    body+='</tbody>';
    table.innerHTML=header+body;
  }

  function renderAllocationsHistory(){
    const tbody=document.getElementById('alloc-history-tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    const allocations=(b().goalAllocations||[]).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,15);
    const goalsById=Object.fromEntries((b().goals||[]).map(g=>[g.id,g]));
    if(allocations.length===0){
      tbody.innerHTML='<tr><td colspan="4" class="muted" style="text-align:center;">Brak historii alokacji.</td></tr>';
      return;
    }
    for(const alloc of allocations){
      const goal=goalsById[alloc.goalId];
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${alloc.date}</td>
        <td>${goal ? goal.name : '<em>Usunięty cel</em>'}</td>
        <td>${fmt(alloc.amount,state.currency)}</td>
        <td class="row" style="justify-content:flex-end; gap:8px;">
          <button class="btn soft" data-edit-id="${alloc.id}">Edytuj</button>
          <button class="btn danger" data-del-id="${alloc.id}">Usuń</button>
        </td>`;
      tr.querySelector('[data-edit-id]').onclick=()=>startEditAllocation(alloc.id);
      tr.querySelector('[data-del-id]').onclick=()=>{
        if(!confirm('Czy na pewno usunąć tę alokację?')) return;
        state.modules.budget.goalAllocations=(b().goalAllocations||[]).filter(a=>a.id!==alloc.id);
        save(state);
        renderGoals();
      };
      tbody.appendChild(tr);
    }
  }

  function startEditAllocation(allocId){
    const alloc=(b().goalAllocations||[]).find(a=>a.id===allocId);
    if(!alloc) return;
    const form=document.getElementById('alloc-form');
    if(!form) return;
    const idField=form.querySelector('[name="allocId"]');
    if(idField) idField.value=alloc.id;
    const goalSel=form.querySelector('[name="goalId"]');
    if(goalSel) goalSel.value=alloc.goalId;
    const dateField=form.querySelector('[name="date"]');
    if(dateField) dateField.value=alloc.date;
    const amountField=form.querySelector('[name="amount"]');
    if(amountField) amountField.value=String(alloc.amount).replace('.',',');
    const title=document.getElementById('alloc-form-title');
    if(title) title.textContent='Edytuj alokację';
    const submit=document.getElementById('alloc-submit-btn');
    if(submit) submit.textContent='Zapisz zmiany';
    const cancel=document.getElementById('alloc-cancel-btn');
    if(cancel) cancel.style.display='inline-flex';
  }

  function resetAllocForm(){
    const form=document.getElementById('alloc-form');
    form.reset();
    const idField=form.querySelector('[name="allocId"]');
    if(idField) idField.value='';
    const title=document.getElementById('alloc-form-title');
    if(title) title.textContent='Dodaj alokację na cel';
    const submit=document.getElementById('alloc-submit-btn');
    if(submit) submit.textContent='Dodaj alokację';
    const cancel=document.getElementById('alloc-cancel-btn');
    if(cancel) cancel.style.display='none';
    setDefaultDateForAlloc();
  }


  const _oldAcctForm=document.getElementById('acct-form');
  if(_oldAcctForm) _oldAcctForm.onsubmit=(e)=>{
    e.preventDefault();
    const f=new FormData(e.target); const name=String(f.get('name')||'').trim(); if(!name) return;
    const id='a_'+Math.random().toString(36).slice(2);
    b().accounts.push({id,name}); save(state); e.target.reset(); renderAll();
  };

  // --- Variable list + split editor + filter ---------------------------------
  function renderVariable(){
    const ym=b().workingMonth; document.getElementById('var-month').textContent=ym;
    renderRecurringSuggestions();

    const tbody=document.getElementById('var-rows');tbody.innerHTML='';
    const cb=catsById();
    const accById=Object.fromEntries((b().accounts||[]).map(a=>[a.id,a]));
    let txMonth=(b().transactions||[]).filter(t=>String(t.date).startsWith(ym));

    const filterSel=document.getElementById('var-filter-cat');
    const currentValue=filterSel.value;
    if(currentValue){
      txMonth = txMonth.filter(t=>{
        if(t.splits?.length) return t.splits.some(s=>s.categoryId===currentValue);
        return t.categoryId===currentValue;
      });
    }

    const entries=entriesForMonth(ym);
    const varSum=entries.reduce((s,e)=>{const c=cb[e.categoryId]; return (!c||c.type!=='expense' || c.id ==='c_fixed')?s:s+Math.abs(e.amount)},0);
    document.getElementById('var-sum').textContent = fmt(varSum, state.currency);

    for(const t of txMonth){
      const catMain = t.splits?.length ? null : cb[t.categoryId];
      const isExpense = t.splits?.length ? t.splits.some(s=>cb[s.categoryId]?.type==='expense') : (catMain?.type==='expense');
      const total = txTotalSigned(t);
      const catLabel = t.splits?.length ? `Split (${t.splits.length})` : ((catMain?.emoji||'')+' '+(catMain?.name||'—'));
      const tr=document.createElement('tr'); tr.setAttribute('data-id', t.id);
      tr.innerHTML=`<td>${t.date}</td><td>${catLabel}</td><td>${accById[t.accountId]?.name||'—'}</td><td class="${total<0 ? 'bad' : 'ok'}">${fmt(total,state.currency)}</td><td>${t.note||''}</td>
        <td class="row" style="gap:6px; justify-content:flex-end"><button class="btn soft" data-act="edit">Edytuj</button><button class="btn soft" data-act="copy">Kopiuj</button><button class="btn danger" data-act="del">X</button></td>`;
      tr.querySelector('[data-act="del"]').onclick=()=>{ if(!confirm('Usunąć tę transakcję?')) return; b().transactions=b().transactions.filter(x=>x.id!==t.id); save(state); renderAll() };
      tr.querySelector('[data-act="copy"]').onclick=()=>{ const today=new Date().toISOString().slice(0,10); const n=JSON.parse(JSON.stringify(t)); n.id=`tx_${Math.random().toString(36).slice(2)}`; n.date=today; b().transactions.unshift(n); save(state); alert('Skopiowano na dziś.'); renderAll(); };
      tr.querySelector('[data-act="edit"]').onclick=()=>startEditTx(t);
      tbody.appendChild(tr);
    }

    filterSel.innerHTML='<option value="">Wszystkie kategorie</option>';
    for(const c of (b().categories||[])){filterSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}
    filterSel.value=currentValue; filterSel.onchange=renderVariable;

    const varCat=document.querySelector('#var-form select[name="categoryId"]'); if(varCat){varCat.innerHTML=''; for(const c of (b().categories||[])){varCat.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}}
    const accSel=document.querySelector('#var-form select[name="accountId"]'); if(accSel){accSel.innerHTML=''; for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id))}}
    setDefaultDate(); bindMoneyInputs(tbody);
  }

  function startEditTx(t){
    const row = document.querySelector(`#var-rows tr[data-id="${t.id}"]`); if(!row) return;
    const accs=b().accounts; const isSplit = !!(t.splits && t.splits.length);
    row.innerHTML=`
      <td><input type="date" value="${t.date}" data-k="date"/></td>
      <td colspan="1">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><label style="display:flex;align-items:center;gap:6px"><input type="checkbox" data-k="isSplit" ${isSplit?'checked':''}/> Split</label></div>
        <div data-mode="single" ${isSplit?'style="display:none"':''}><select data-k="categoryId"></select></div>
        <div data-mode="split" class="split-box" ${isSplit?'':'style="display:none"'}><table style="width:100%"><thead><tr><th>Kategoria</th><th>Kwota</th><th></th></tr></thead><tbody class="tx-split-rows"></tbody></table><div style="margin-top:6px"><button class="btn soft" type="button" data-act="split-add">+ wiersz</button></div></div>
      </td>
      <td><select data-k="accountId"></select></td>
      <td><div data-mode="single" ${isSplit?'style="display:none"':''}><input inputmode="decimal" value="${String(Math.abs(t.amount||0)).replace('.',',')}" data-k="amount"/></div><div data-mode="split" ${isSplit?'':'style="display:none"'} class="tiny">Kwoty w split wpisuj jako dodatnie.</div></td>
      <td><input value="${t.note||''}" data-k="note"/></td>
      <td class="row" style="gap:6px"><button class="btn" data-act="save">Zapisz</button><button class="btn ghost" data-act="cancel">Anuluj</button></td>`;
    const cb=catsById();
    const catSel=row.querySelector('select[data-k="categoryId"]'); for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id,false,c.id===t.categoryId))}
    const accSel=row.querySelector('select[data-k="accountId"]'); for(const a of (accs||[])){accSel.add(new Option(a.name,a.id,false,a.id===t.accountId))}
    const tbody=row.querySelector('.tx-split-rows');
    function addSplitRow(sp){const tr=document.createElement('tr'); tr.className='split-row'; tr.innerHTML=`<td><select class="sp-cat"></select></td><td><input class="sp-amt" inputmode="decimal" value="${sp?String(sp.amount).replace('.',','):''}" /></td><td><button class="btn danger" type="button">X</button></td>`; const sel=tr.querySelector('.sp-cat'); for(const c of (b().categories||[])){sel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id,false, sp?sp.categoryId===c.id:false))} tr.querySelector('button').onclick=()=>{tr.remove()}; tbody.appendChild(tr); bindMoneyInputs(tr);}
    if(t.splits?.length){for(const s of t.splits) addSplitRow(s)} else { addSplitRow(); }
    row.querySelector('[data-k="isSplit"]').onchange=()=>{const on = row.querySelector('[data-k="isSplit"]').checked; row.querySelectorAll('[data-mode="single"]').forEach(el=>el.style.display= on?'none':'block'); row.querySelectorAll('[data-mode="split"]').forEach(el=>el.style.display= on?'block':'none');};
    row.querySelector('[data-act="split-add"]').onclick=()=>addSplitRow();
    bindMoneyInputs(row);
    row.querySelector('[data-act="save"]').onclick=()=>{
      const date=row.querySelector('[data-k="date"]').value || t.date;
      const accountId=row.querySelector('[data-k="accountId"]').value;
      const note=row.querySelector('[data-k="note"]').value;
      const useSplit=row.querySelector('[data-k="isSplit"]').checked;
      const idx=b().transactions.findIndex(x=>x.id===t.id); if(idx === -1) return;
      
      if(useSplit){
        const rows=Array.from(row.querySelectorAll('.split-row')); if(rows.length===0){alert('Dodaj przynajmniej jeden wiersz split.'); return;}
        const splits=[]; for(const r of rows){const cat=r.querySelector('.sp-cat').value; const amt=num(r.querySelector('.sp-amt').value); if(!cat || amt <= 0){alert('Uzupełnij kategorię i kwotę > 0 w każdym wierszu split.'); return;} splits.push({categoryId:cat, amount:amt});}
        const total=splits.reduce((s,sp)=>s+signFor(sp.categoryId,num(sp.amount)),0);
        const firstCat=splits[0].categoryId;
        b().transactions[idx]={...b().transactions[idx],date,accountId,note,categoryId:firstCat,amount:total,splits};
      }else{
        const categoryId=row.querySelector('[data-k="categoryId"]').value;
        const amountRaw=num(row.querySelector('[data-k="amount"]').value);
        const signed= signFor(categoryId, amountRaw);
        b().transactions[idx]={...b().transactions[idx],date,categoryId,accountId,amount:signed,note,splits:[]};
      }
      save(state); renderAll();
    };
    row.querySelector('[data-act="cancel"]').onclick=()=>renderVariable();
  }

  // --- Investments v2 ----------------------------------------------------------
  const invPalette=['#2563eb','#22c55e','#f59e0b','#0ea5e9','#8b5cf6','#ef4444','#ec4899','#14b8a6'];
  const invGroupOptions=['Akcje','Dywidenda','Krypto','Metal','Waluta','Inne'];
  let invCapitalChart=null, invCumulativeChart=null, invAllocationChart=null, invAllocationDetailChart=null, invPnlChart=null;
  let invSelectedAllocationGroup=null;
  let invModalBound=false;
  let invActivePanel='hub';
  let invTradeMode='buy';
  let invTradeFilter='all';

  const investments=()=>{
    if(!b().investments) b().investments={assets:[],trades:[],groups:[]};
    const inv=b().investments;
    if(!Array.isArray(inv.assets)) inv.assets=[];
    if(!Array.isArray(inv.trades)) inv.trades=[];
    if(!Array.isArray(inv.groups)) inv.groups=[];
    return inv;
  };

  // --- Groups ----------------------------------------------------------------
  const allInvestmentGroups=()=>{
    const data=investments();
    const derived=(data.assets||[]).map(a=>a.group||'Inne');
    return Array.from(new Set([...invGroupOptions,...(data.groups||[]),...derived])).sort((a,bb)=>a.localeCompare(bb));
  };

  const addInvestmentGroup=(name)=>{
    const g=(name||'').trim(); if(!g) return;
    const data=investments();
    if(!data.groups.includes(g)&&!invGroupOptions.includes(g)){data.groups.push(g);save(state);}
    return g;
  };

  const sortAssetsByGroupThenName=(assets)=>[...assets].sort((a,bb)=>{
    const gc=(a.group||'Inne').localeCompare(bb.group||'Inne');
    return gc!==0?gc:(a.name||'').localeCompare(bb.name||'');
  });

  function populateAssetGroupSelect(select,current){
    if(!select) return;
    const cv=current||select.value||'';
    select.innerHTML='';
    for(const opt of allInvestmentGroups()) select.add(new Option(opt,opt,false,opt===cv));
    select.add(new Option('+ Nowa grupa...','__new',false,false));
    select.onchange=()=>{
      if(select.value==='__new'){
        const nm=prompt('Podaj nazwe nowej grupy:');
        if(nm) populateAssetGroupSelect(select,addInvestmentGroup(nm)||cv);
        else populateAssetGroupSelect(select,cv||'Inne');
      }
    };
  }

  function ensureInvestmentCategory(){
    const existing=b().categories.find(c=>c.id==='c_invest'||c.name==='Inwestycje');
    if(existing){existing.name=existing.name||'Inwestycje';existing.type='saving';existing.emoji=existing.emoji||'📈';return existing.id;}
    const id='c_invest';
    b().categories.push({id,name:'Inwestycje',type:'saving',emoji:'📈',budget:0});
    return id;
  }

  // --- FIFO Holdings Engine --------------------------------------------------
  function computeHoldingsFIFO(){
    const data=investments();
    const map={};
    for(const a of data.assets){
      map[a.id]={id:a.id,name:a.name,group:a.group||'Inne',currentPrice:a.currentPrice||null,priceDate:a.priceDate||null,
        lots:[],qty:0,costBasis:0,avgCost:0,realizedPnl:0,invested:0,sellProceeds:0,tradeCount:0,lastDate:'',marketValue:null,unrealizedPnl:null};
    }
    const sorted=[...data.trades].sort((a,bb)=>String(a.date||'').localeCompare(String(bb.date||''))||(a.side==='buy'?-1:1));
    for(const t of sorted){
      const h=map[t.assetId]; if(!h) continue;
      h.tradeCount++;
      if(!h.lastDate||t.date>h.lastDate) h.lastDate=t.date;
      if(t.side==='sell'){
        let remaining=num(t.quantity), costForSell=0;
        while(remaining>0.000001&&h.lots.length>0){
          const lot=h.lots[0], take=Math.min(remaining,lot.qty);
          costForSell+=take*lot.costPerUnit;
          lot.qty-=take; remaining-=take;
          if(lot.qty<0.000001) h.lots.shift();
        }
        h.realizedPnl+=(num(t.amount)-costForSell);
        h.sellProceeds+=num(t.amount);
      } else {
        const qty=num(t.quantity), amt=num(t.amount);
        if(qty>0) h.lots.push({qty,costPerUnit:amt/qty,date:t.date});
        h.invested+=amt;
      }
    }
    for(const id of Object.keys(map)){
      const h=map[id];
      h.qty=h.lots.reduce((s,l)=>s+l.qty,0);
      h.costBasis=h.lots.reduce((s,l)=>s+l.qty*l.costPerUnit,0);
      h.avgCost=h.qty>0?h.costBasis/h.qty:0;
      h.marketValue=(h.currentPrice&&h.qty>0)?h.qty*h.currentPrice:null;
      h.unrealizedPnl=(h.marketValue!==null)?h.marketValue-h.costBasis:null;
    }
    return Object.values(map);
  }

  function computePortfolioStats(){
    const data=investments();
    const holdings=computeHoldingsFIFO();
    let capitalFromBudget=0, capitalReturned=0, reinvestPool=0;
    for(const t of data.trades){
      if(t.side==='sell'){
        if(t.sellDestination==='budget') capitalReturned+=num(t.amount);
        else reinvestPool+=num(t.amount);
      } else {
        if(t.fundSource==='reinvest') reinvestPool-=num(t.amount);
        else capitalFromBudget+=num(t.amount);
      }
    }
    const totalCostBasis=holdings.reduce((s,h)=>s+h.costBasis,0);
    const hasAnyPrice=holdings.some(h=>h.currentPrice&&h.qty>0);
    const totalMarketValue=holdings.reduce((s,h)=>s+(h.marketValue!==null?h.marketValue:h.costBasis),0);
    const totalRealizedPnl=holdings.reduce((s,h)=>s+h.realizedPnl,0);
    const totalUnrealizedPnl=hasAnyPrice?(totalMarketValue-totalCostBasis):null;
    const totalPnl=totalRealizedPnl+(totalUnrealizedPnl||0);
    const roi=capitalFromBudget>0?((totalPnl/capitalFromBudget)*100):0;
    return {holdings,capitalFromBudget,capitalReturned,netFromBudget:capitalFromBudget-capitalReturned,
      reinvestPool:Math.max(0,reinvestPool),totalCostBasis,totalMarketValue,hasAnyPrice,
      totalRealizedPnl,totalUnrealizedPnl,totalPnl,roi};
  }

  function computeSellCostBasis(assetId,sellQty){
    const data=investments();
    const trades=[...data.trades].filter(t=>t.assetId===assetId)
      .sort((a,bb)=>String(a.date||'').localeCompare(String(bb.date||'')));
    const lots=[];
    for(const t of trades){
      if(t.side==='sell'){
        let rem=num(t.quantity);
        while(rem>0.000001&&lots.length>0){
          const take=Math.min(rem,lots[0].qty); lots[0].qty-=take; rem-=take;
          if(lots[0].qty<0.000001) lots.shift();
        }
      } else {
        const q=num(t.quantity); if(q>0) lots.push({qty:q,costPerUnit:num(t.amount)/q});
      }
    }
    let remaining=sellQty, costBasis=0;
    const lc=lots.map(l=>({...l}));
    while(remaining>0.000001&&lc.length>0){
      const take=Math.min(remaining,lc[0].qty);
      costBasis+=take*lc[0].costPerUnit;
      lc[0].qty-=take; remaining-=take;
      if(lc[0].qty<0.000001) lc.shift();
    }
    const availableQty=lots.reduce((s,l)=>s+l.qty,0);
    return {costBasis,remaining,availableQty};
  }

  // --- Asset Select Fills ----------------------------------------------------
  function fillInvestmentAssetSelects(){
    const selects=[
      document.querySelector('#inv-buy-form select[name="assetId"]'),
      document.querySelector('#inv-sell-form select[name="assetId"]')
    ];
    for(const sel of selects){
      if(!sel) continue;
      const current=sel.value;
      sel.innerHTML='';
      const assetsList=sortAssetsByGroupThenName(investments().assets);
      if(assetsList.length===0) sel.add(new Option('Dodaj aktywo...','',true,true));
      for(const a of assetsList) sel.add(new Option(`${a.name} (${a.group||'Inne'})`,a.id,false,a.id===current));
      sel.value=current||sel.value;
    }
  }

  // --- Panel / Trade Mode Switching ------------------------------------------
  function setInvestmentPanel(panel){
    invActivePanel=panel;
    document.querySelectorAll('.inv-analytics-btn').forEach(btn=>{
      const isA=btn.dataset.invPanelBtn===panel;
      btn.classList.toggle('is-active',isA);
      btn.setAttribute('aria-selected',String(isA));
      // Preserve hub button gradient when not active, white bg when active
      if(btn.dataset.invPanelBtn==='hub'){
        if(isA){
          btn.style.background='linear-gradient(135deg,#2563eb,#7c3aed)';
          btn.style.color='#fff';
          btn.style.boxShadow='0 4px 16px rgba(37,99,235,.35)';
        } else {
          btn.style.background='linear-gradient(135deg,#2563eb,#7c3aed)';
          btn.style.color='#fff';
          btn.style.boxShadow='0 2px 8px rgba(37,99,235,.25)';
        }
      }
    });
    document.querySelectorAll('.inv-analytics-panel').forEach(p=>p.classList.toggle('is-active',p.dataset.panel===panel));
    if(panel==='hub') renderInvHub();
  }

  function bindInvestmentAnalyticsNav(){
    document.querySelectorAll('[data-inv-panel-btn]').forEach(btn=>{
      if(btn._bound) return; btn._bound=true;
      btn.onclick=()=>setInvestmentPanel(btn.dataset.invPanelBtn||'capital');
    });
    setInvestmentPanel(invActivePanel);
  }

  function setInvTradeMode(mode){
    invTradeMode=mode;
    const buyForm=document.getElementById('inv-buy-form');
    const sellForm=document.getElementById('inv-sell-form');
    const tabs=document.querySelectorAll('.inv-trade-tab');
    tabs.forEach(t=>{
      t.classList.remove('is-active','sell-active');
      if(t.dataset.tradeMode===mode){
        t.classList.add(mode==='sell'?'sell-active':'is-active');
      }
    });
    if(buyForm) buyForm.style.display=mode==='buy'?'flex':'none';
    if(sellForm) sellForm.style.display=mode==='sell'?'flex':'none';
    const badge=document.getElementById('inv-trade-badge');
    if(badge) badge.textContent=mode==='buy'?'Automatyczne księgowanie':'Sprzedaż aktywów';
  }

  function setInvTradeFilter(filter){
    invTradeFilter=filter;
    document.querySelectorAll('.inv-trade-filter').forEach(f=>f.classList.toggle('is-active',f.dataset.filter===filter));
    renderInvTradeHistory();
  }

  // --- Asset Manager ---------------------------------------------------------
  const invPriceProviders=[
    {value:'manual',label:'Ręcznie'},
    {value:'stooq',label:'Akcje/ETF (auto: Yahoo/Stooq)'},
    {value:'yahoo',label:'Yahoo (akcje/ETF)'},
    {value:'fmp',label:'FMP Stable (akcje USD→PLN)'},
    {value:'coingecko',label:'CoinGecko (krypto)'},
    {value:'nbp',label:'NBP (waluty)'}
  ];

  const INV_FMP_API_KEY='fu3KeB4obDGLv096Vp0hTiMxNnnhkv34';

  function invProviderHelp(provider){
    if(provider==='stooq'||provider==='yahoo') return 'np. MU, NVDA, MSFT, AMZN, INPST.AS, CSPX.AS | waluta: USD/EUR (nie PLN)';
    if(provider==='fmp') return 'np. MU, TSLA, AAPL (waluta kwotowania: USD/EUR, wynik zawsze w PLN)';
    if(provider==='coingecko') return 'np. bitcoin, ethereum';
    if(provider==='nbp') return 'np. USD, EUR';
    return 'Automatyczne odświeżanie wyłączone';
  }

  function createAssetRow(asset={},trades=[]){
    const tr=document.createElement('tr');
    tr.dataset.assetId=asset.id||'';
    const usage=trades.filter(t=>t.assetId===asset.id);
    const provider=String(asset.priceProvider||'manual');
    tr.innerHTML=`
      <td><input class="inv-asset-name" value="${escapeHtml(asset.name||'')}" placeholder="np. VOO, BTC, złoto" /></td>
      <td><select class="inv-asset-group"></select></td>
      <td><input class="inv-asset-price" type="text" inputmode="decimal" value="${asset.currentPrice||''}" placeholder="—" style="width:90px;height:34px;text-align:right" /></td>
      <td><select class="inv-asset-provider">${invPriceProviders.map(opt=>`<option value="${opt.value}" ${opt.value===provider?'selected':''}>${opt.label}</option>`).join('')}</select></td>
      <td><input class="inv-asset-symbol" value="${escapeHtml(asset.priceSymbol||'')}" placeholder="${escapeHtml(invProviderHelp(provider))}" /></td>
      <td><input class="inv-asset-currency" value="${escapeHtml(asset.priceCurrency||'PLN')}" placeholder="PLN" maxlength="8" style="text-transform:uppercase" /></td>
      <td><span class="muted">${usage.length||0}</span></td>
      <td class="row" style="gap:6px;justify-content:flex-end">
        <button class="btn soft" data-act="save">Zapisz</button>
        <button class="btn ghost" data-act="delete">Usuń</button>
      </td>`;
    populateAssetGroupSelect(tr.querySelector('.inv-asset-group'),asset.group||'Inne');
    const providerSel=tr.querySelector('.inv-asset-provider');
    const symbolInput=tr.querySelector('.inv-asset-symbol');
    const syncSymbolPlaceholder=()=>{
      if(!providerSel||!symbolInput) return;
      symbolInput.placeholder=invProviderHelp(providerSel.value);
    };
    if(providerSel){providerSel.addEventListener('change',syncSymbolPlaceholder);syncSymbolPlaceholder();}
    tr.querySelector('[data-act="save"]').onclick=()=>saveAssetRow(tr);
    tr.querySelector('[data-act="delete"]').onclick=()=>{
      const id=tr.dataset.assetId;
      if(!id){tr.remove();return;}
      if(confirm('Usunąć aktywo i wszystkie powiązane transakcje?')) deleteInvestmentAsset(id);
    };
    return tr;
  }

  function renderAssetManagerList(assets,trades){
    const tbody=document.getElementById('inv-asset-table-body');
    const empty=document.getElementById('inv-asset-empty');
    if(!tbody||!empty) return;
    tbody.innerHTML='';
    const sorted=sortAssetsByGroupThenName(assets);
    for(const asset of sorted) tbody.appendChild(createAssetRow(asset,trades));
    empty.style.display=sorted.length?'none':'block';
  }

  function saveAssetRow(row){
    const name=row.querySelector('.inv-asset-name')?.value.trim();
    const group=row.querySelector('.inv-asset-group')?.value||'Inne';
    const priceRaw=row.querySelector('.inv-asset-price')?.value;
    const price=priceRaw?num(priceRaw):null;
    const priceProvider=row.querySelector('.inv-asset-provider')?.value||'manual';
    const priceSymbol=(row.querySelector('.inv-asset-symbol')?.value||'').trim();
    const priceCurrency=(row.querySelector('.inv-asset-currency')?.value||'PLN').trim().toUpperCase()||'PLN';
    if(!name){alert('Podaj nazwę aktywa.');return;}
    const data=investments();
    const id=row.dataset.assetId;
    if(id){
      const ex=data.assets.find(a=>a.id===id);
      if(ex){
        ex.name=name;ex.group=group;ex.currentPrice=price;ex.priceDate=price?new Date().toISOString().slice(0,10):ex.priceDate;
        ex.priceProvider=priceProvider;ex.priceSymbol=priceSymbol;ex.priceCurrency=priceCurrency;
      }
    } else {
      const newId='inv_asset_'+Math.random().toString(36).slice(2);
      data.assets.push({id:newId,name,group,currentPrice:price,priceDate:price?new Date().toISOString().slice(0,10):null,priceProvider,priceSymbol,priceCurrency});
      row.dataset.assetId=newId;
    }
    save(state);renderInvestments();
  }

  function addBlankAssetRow(){
    const tbody=document.getElementById('inv-asset-table-body');
    const empty=document.getElementById('inv-asset-empty');
    if(!tbody) return;
    const row=createAssetRow({},[]);
    tbody.appendChild(row);
    if(empty) empty.style.display='none';
    row.querySelector('.inv-asset-name')?.focus();
  }

  function saveAllAssetRows(){
    const tbody=document.getElementById('inv-asset-table-body');
    if(!tbody) return;
    const data=investments(); let changed=false;
    for(const row of [...tbody.querySelectorAll('tr')]){
      const name=row.querySelector('.inv-asset-name')?.value.trim();
      const group=row.querySelector('.inv-asset-group')?.value||'Inne';
      const priceRaw=row.querySelector('.inv-asset-price')?.value;
      const price=priceRaw?num(priceRaw):null;
      const priceProvider=row.querySelector('.inv-asset-provider')?.value||'manual';
      const priceSymbol=(row.querySelector('.inv-asset-symbol')?.value||'').trim();
      const priceCurrency=(row.querySelector('.inv-asset-currency')?.value||'PLN').trim().toUpperCase()||'PLN';
      if(!name) continue;
      const id=row.dataset.assetId;
      if(id){
        const ex=data.assets.find(a=>a.id===id);
        if(ex){
          ex.name=name;ex.group=group;ex.currentPrice=price;ex.priceDate=price?new Date().toISOString().slice(0,10):ex.priceDate;
          ex.priceProvider=priceProvider;ex.priceSymbol=priceSymbol;ex.priceCurrency=priceCurrency;changed=true;
        }
      } else {
        const newId='inv_asset_'+Math.random().toString(36).slice(2);
        data.assets.push({id:newId,name,group,currentPrice:price,priceDate:price?new Date().toISOString().slice(0,10):null,priceProvider,priceSymbol,priceCurrency});
        row.dataset.assetId=newId;changed=true;
      }
    }
    if(changed){save(state);renderInvestments();}
  }


  function setInvPriceStatus(msg,isError=false){
    const status=document.getElementById('inv-refresh-status');
    if(!status) return;
    status.textContent=msg;
    status.style.color=isError?'#dc2626':'var(--muted)';
  }

  function invCorsCandidates(url){
    const customTpl=(localStorage.getItem('invCorsProxyTemplate')||'').trim();
    const out=[url];
    if(customTpl){
      if(customTpl.includes('{url}')) out.push(customTpl.replace('{url}',encodeURIComponent(url)));
      else out.push(`${customTpl}${encodeURIComponent(url)}`);
    }
    out.push(`https://corsproxy.io/?${encodeURIComponent(url)}`);
    out.push(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
    return [...new Set(out)];
  }

  async function fetchWithCorsFallback(url,options){
    let lastErr=null;
    for(const candidate of invCorsCandidates(url)){
      try{
        const res=await fetch(candidate,options);
        if(res.ok) return res;
        lastErr=new Error(`HTTP ${res.status}`);
      }catch(err){
        lastErr=err;
      }
    }
    throw lastErr||new Error('Błąd połączenia');
  }

  async function fetchStooqPrice(symbol){
    const raw=String(symbol||'').trim().toLowerCase();
    if(!raw) return null;
    const hasMarketSuffix=/\.[a-z]{2,4}$/.test(raw);
    const candidates=[raw];
    if(!hasMarketSuffix){
      candidates.push(`${raw}.us`,`${raw}.pl`,`${raw}.de`,`${raw}.as`);
    }
    const unique=[...new Set(candidates)];
    for(const sym of unique){
      const res=await fetchWithCorsFallback(`https://stooq.com/q/l/?s=${encodeURIComponent(sym)}&f=sd2t2ohlcvn&e=csv`);
      if(!res.ok) continue;
      const txt=await res.text();
      const lines=txt.trim().split(/\r?\n/);
      if(lines.length<2) continue;
      const cols=lines[1].split(',');
      const closeRaw=(cols[6]||'').trim();
      if(!closeRaw||closeRaw==='N/D'||closeRaw==='0') continue;
      const close=Number(closeRaw);
      if(Number.isFinite(close)&&close>0) return close;
    }
    return null;
  }

  async function fetchYahooPrice(symbol){
    const raw=String(symbol||'').trim().toUpperCase();
    if(!raw) return null;
    const hasMarketSuffix=/\.[A-Z]{2,4}$/.test(raw);
    const candidates=[raw];
    if(!hasMarketSuffix){
      candidates.push(`${raw}.US`,`${raw}.AS`,`${raw}.DE`,`${raw}.WA`,`${raw}.L`);
    }
    const symbols=[...new Set(candidates)].join(',');
    const res=await fetchWithCorsFallback(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols)}`);
    if(!res.ok) throw new Error('Błąd pobierania z Yahoo');
    const json=await res.json();
    const rows=json?.quoteResponse?.result||[];
    for(const row of rows){
      const val=Number(row?.regularMarketPrice);
      if(Number.isFinite(val)&&val>0) return val;
    }
    return null;
  }

  async function fetchCoinGeckoPrice(id,currency){
    const coinId=String(id||'').trim().toLowerCase();
    const vs=String(currency||'usd').trim().toLowerCase();
    if(!coinId) return null;
    const res=await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(coinId)}&vs_currencies=${encodeURIComponent(vs)}`);
    if(!res.ok) throw new Error('Błąd pobierania z CoinGecko');
    const json=await res.json();
    const val=Number(json?.[coinId]?.[vs]);
    return Number.isFinite(val)&&val>0?val:null;
  }

  async function fetchNbpFxPrice(code){
    const cc=String(code||'').trim().toUpperCase();
    if(!cc||cc==='PLN') return 1;
    const res=await fetch(`https://api.nbp.pl/api/exchangerates/rates/a/${encodeURIComponent(cc)}/?format=json`);
    if(!res.ok) throw new Error('Błąd pobierania z NBP');
    const json=await res.json();
    const mid=Number(json?.rates?.[0]?.mid);
    return Number.isFinite(mid)&&mid>0?mid:null;
  }

  const invFxToPlnCache={PLN:1};

  async function fetchFxRateToPln(code){
    const cc=String(code||'PLN').trim().toUpperCase();
    if(!cc||cc==='PLN') return 1;
    if(invFxToPlnCache[cc]) return invFxToPlnCache[cc];
    const rate=await fetchNbpFxPrice(cc);
    if(!rate||rate<=0) throw new Error(`Brak kursu ${cc}/PLN z NBP`);
    invFxToPlnCache[cc]=rate;
    return rate;
  }

  async function convertQuoteToPln(amount, quoteCurrency){
    const val=Number(amount);
    if(!Number.isFinite(val)||val<=0) return null;
    const cc=String(quoteCurrency||'PLN').trim().toUpperCase();
    const fx=await fetchFxRateToPln(cc);
    return val*fx;
  }

  async function fetchFmpStablePrice(symbol){
    const sym=String(symbol||'').trim().toUpperCase();
    if(!sym) return null;
    const apiKey=(localStorage.getItem('invFmpApiKey')||INV_FMP_API_KEY||'').trim();
    if(!apiKey) throw new Error('Brak klucza FMP API');
    const url=`https://financialmodelingprep.com/stable/profile?symbol=${encodeURIComponent(sym)}&apikey=${encodeURIComponent(apiKey)}`;
    const res=await fetchWithCorsFallback(url);
    if(!res.ok) throw new Error('Błąd pobierania z FMP Stable');
    const data=await res.json();
    if(!Array.isArray(data)||!data.length) throw new Error('Nie znaleziono symbolu w FMP');
    const price=Number(data[0]?.price);
    if(!Number.isFinite(price)||price<=0) throw new Error('FMP nie zwróciło ceny');
    const quoteCurrency=String(data[0]?.currency||'USD').trim().toUpperCase()||'USD';
    return {price, quoteCurrency, companyName:String(data[0]?.companyName||sym)};
  }

  function guessQuoteCurrencyFromSymbol(symbol){
    const sym=String(symbol||'').trim().toUpperCase();
    if(/\.(AS|DE|PA|MI|MC|BR|HE|VI|LS|IR)$/.test(sym)) return 'EUR';
    if(/\.(L)$/.test(sym)) return 'GBP';
    if(/\.(WA)$/.test(sym)) return 'PLN';
    return 'USD';
  }

  function resolveQuoteCurrency(asset, apiCurrency){
    const configured=String(asset?.priceCurrency||'').trim().toUpperCase();
    if(configured && configured!=='PLN') return configured;
    const fromApi=String(apiCurrency||'').trim().toUpperCase();
    if(fromApi && fromApi!=='PLN') return fromApi;
    return guessQuoteCurrencyFromSymbol(asset?.priceSymbol||'');
  }

  async function fetchAssetPrice(asset){
    const provider=String(asset.priceProvider||'manual');
    const symbol=String(asset.priceSymbol||'').trim();
    const currency=String(asset.priceCurrency||state.currency||'PLN').trim().toLowerCase();
    if(provider==='manual') return {price:null,skipped:true};
    if(!symbol) return {price:null,error:'Brak symbolu API'};
    try{
      if(provider==='stooq'){
        const quoteCurrency=resolveQuoteCurrency(asset);
        let rawPrice=null;
        try{rawPrice=await fetchYahooPrice(symbol);}catch(_err){rawPrice=null;}
        if(!(rawPrice&&rawPrice>0)) rawPrice=await fetchStooqPrice(symbol);
        if(rawPrice&&rawPrice>0){
          const pricePln=await convertQuoteToPln(rawPrice,quoteCurrency);
          return {price:pricePln,currency:'PLN'};
        }
        return {price:null,error:'Brak ceny dla symbolu (Yahoo/Stooq) lub brak poprawnej waluty kwotowania.'};
      }
      if(provider==='yahoo'){
        const quoteCurrency=resolveQuoteCurrency(asset);
        let rawPrice=null;
        try{rawPrice=await fetchYahooPrice(symbol);}catch(_err){rawPrice=null;}
        if(!(rawPrice&&rawPrice>0)) rawPrice=await fetchStooqPrice(symbol);
        if(rawPrice&&rawPrice>0){
          const pricePln=await convertQuoteToPln(rawPrice,quoteCurrency);
          return {price:pricePln,currency:'PLN'};
        }
        return {price:null,error:'Brak ceny dla symbolu (Yahoo/Stooq) lub brak poprawnej waluty kwotowania.'};
      }
      if(provider==='coingecko') return {price:await fetchCoinGeckoPrice(symbol,currency)};
      if(provider==='nbp') return {price:await fetchNbpFxPrice(symbol)};
      if(provider==='fmp'){
        const out=await fetchFmpStablePrice(symbol);
        const quoteCurrency=resolveQuoteCurrency(asset,out.quoteCurrency);
        const pricePln=await convertQuoteToPln(out.price,quoteCurrency);
        return {price:pricePln,currency:'PLN'};
      }
      return {price:null,error:'Nieznany provider'};
    }catch(err){
      return {price:null,error:err?.message||'Błąd pobierania'};
    }
  }

  async function refreshInvestmentPrices(){
    const data=investments();
    const assets=data.assets||[];
    const refreshBtn=document.getElementById('inv-refresh-prices-btn');
    const modalRefreshBtn=document.getElementById('inv-asset-refresh-prices');
    if(!assets.length){setInvPriceStatus('Brak aktywów do odświeżenia.');return;}
    if(refreshBtn) refreshBtn.disabled=true;
    if(modalRefreshBtn) modalRefreshBtn.disabled=true;
    setInvPriceStatus('Odświeżanie cen...');
    let updated=0,skipped=0,failed=0;
    const today=new Date().toISOString().slice(0,10);
    for(const asset of assets){
      const out=await fetchAssetPrice(asset);
      if(out.skipped){skipped++;continue;}
      if(out.price&&out.price>0){asset.currentPrice=out.price;asset.priceDate=today;updated++;}
      else failed++;
    }
    save(state);
    renderInvestments();
    if(refreshBtn) refreshBtn.disabled=false;
    if(modalRefreshBtn) modalRefreshBtn.disabled=false;
    const msg=`Odświeżono: ${updated}, pominięto: ${skipped}, błędy: ${failed}.`;
    setInvPriceStatus(msg,failed>0&&updated===0);
  }

  function toggleInvestmentModal(open){
    const backdrop=document.getElementById('inv-asset-backdrop');
    const modal=document.getElementById('inv-asset-modal');
    if(!backdrop||!modal) return;
    if(open){
      const data=investments();
      renderAssetManagerList(data.assets,data.trades);
      if(!data.assets.length) addBlankAssetRow();
      backdrop.hidden=false;modal.hidden=false;
      backdrop.style.display='flex';
      modal.setAttribute('aria-hidden','false');
    } else {
      backdrop.hidden=true;modal.hidden=true;
      backdrop.style.display='none';
      modal.setAttribute('aria-hidden','true');
    }
  }

  function bindInvestmentModal(){
    if(invModalBound) return; invModalBound=true;
    const openBtn=document.getElementById('inv-asset-modal-open');
    const closeBtn=document.getElementById('inv-asset-modal-close');
    const cancelBtn=document.getElementById('inv-asset-cancel');
    const backdrop=document.getElementById('inv-asset-backdrop');
    [openBtn].forEach(btn=>btn&&(btn.onclick=()=>toggleInvestmentModal(true)));
    [closeBtn,cancelBtn].forEach(btn=>btn&&(btn.onclick=()=>toggleInvestmentModal(false)));
    if(backdrop) backdrop.onclick=e=>{if(e.target===backdrop) toggleInvestmentModal(false);};
    document.addEventListener('keydown',e=>{if(e.key==='Escape') toggleInvestmentModal(false);});
  }

  // --- Trade CRUD ------------------------------------------------------------
  function deleteInvestmentTrade(tradeId){
    const data=investments();
    const trade=data.trades.find(t=>t.id===tradeId);
    if(!trade) return;
    if(trade.txId) b().transactions=b().transactions.filter(tx=>tx.id!==trade.txId);
    data.trades=data.trades.filter(t=>t.id!==tradeId);
    save(state);renderAll();
  }

  function deleteInvestmentAsset(assetId){
    const data=investments();
    const relatedTxIds=new Set(data.trades.filter(t=>t.assetId===assetId).map(t=>t.txId).filter(Boolean));
    b().transactions=b().transactions.filter(tx=>!relatedTxIds.has(tx.id));
    data.trades=data.trades.filter(t=>t.assetId!==assetId);
    data.assets=data.assets.filter(a=>a.id!==assetId);
    save(state);renderAll();
  }

  // --- Dashboard KPIs --------------------------------------------------------
  function renderInvDashboardKpis(stats){
    const el=id=>document.getElementById(id);
    const cur=state.currency;
    el('inv-kpi-capital').textContent=fmt(stats.capitalFromBudget,cur);
    el('inv-kpi-capital-sub').textContent=stats.capitalReturned>0?`Zwrot do budżetu: ${fmt(stats.capitalReturned,cur)} | Netto: ${fmt(stats.netFromBudget,cur)}`:`Cały kapitał w portfelu`;
    el('inv-kpi-value').textContent=stats.hasAnyPrice?fmt(stats.totalMarketValue,cur):fmt(stats.totalCostBasis,cur);
    el('inv-kpi-value-sub').textContent=stats.hasAnyPrice?`Baza kosztowa: ${fmt(stats.totalCostBasis,cur)}`:'Uzupełnij ceny, aby widzieć wartość rynkową';

    const unrCard=el('inv-kpi-unrealized-card');
    if(stats.totalUnrealizedPnl!==null){
      el('inv-kpi-unrealized').textContent=fmt(stats.totalUnrealizedPnl,cur);
      const pct=stats.totalCostBasis>0?((stats.totalUnrealizedPnl/stats.totalCostBasis)*100).toFixed(1):'0.0';
      el('inv-kpi-unrealized-sub').textContent=`${pct}% od bazy kosztowej`;
      unrCard.className='inv-kpi-card '+(stats.totalUnrealizedPnl>=0?'positive':'negative');
    } else {
      el('inv-kpi-unrealized').textContent='—';
      el('inv-kpi-unrealized-sub').textContent='Uzupełnij ceny aktywów';
      unrCard.className='inv-kpi-card';
    }

    const realCard=el('inv-kpi-realized-card');
    el('inv-kpi-realized').textContent=fmt(stats.totalRealizedPnl,cur);
    realCard.className='inv-kpi-card '+(stats.totalRealizedPnl>0?'positive':stats.totalRealizedPnl<0?'negative':'');

    el('inv-kpi-pool').textContent=fmt(stats.reinvestPool,cur);

    const roiCard=el('inv-kpi-roi-card');
    el('inv-kpi-roi').textContent=stats.capitalFromBudget>0?`${stats.roi.toFixed(1)}%`:'—';
    roiCard.className='inv-kpi-card '+(stats.roi>0?'positive':stats.roi<0?'negative':'');
  }

  // --- Holdings Table --------------------------------------------------------
  function renderInvHoldingsTable(holdings,stats){
    const tbody=document.querySelector('#inv-holdings-table tbody');
    const tfoot=document.getElementById('inv-holdings-foot');
    if(!tbody) return;
    tbody.innerHTML='';
    const active=holdings.filter(h=>h.qty>0.000001);
    if(!active.length){
      tbody.innerHTML='<tr><td colspan="9" class="muted" style="text-align:center">Brak otwartych pozycji</td></tr>';
      if(tfoot) tfoot.innerHTML='';
      return;
    }
    const totalValue=active.reduce((s,h)=>s+(h.marketValue!==null?h.marketValue:h.costBasis),0)||1;
    for(const h of active.sort((a,bb)=>(bb.marketValue||bb.costBasis)-(a.marketValue||a.costBasis))){
      const tr=document.createElement('tr');
      const val=h.marketValue!==null?h.marketValue:h.costBasis;
      const weight=((val/totalValue)*100).toFixed(1);
      let pnlHtml='<span class="inv-pnl-na">—</span>';
      if(h.unrealizedPnl!==null){
        const pct=h.costBasis>0?((h.unrealizedPnl/h.costBasis)*100).toFixed(1):'0.0';
        const cls=h.unrealizedPnl>=0?'inv-pnl-pos':'inv-pnl-neg';
        const sign=h.unrealizedPnl>=0?'+':'';
        pnlHtml=`<span class="${cls}">${sign}${fmt(h.unrealizedPnl,state.currency)}<br><small>${sign}${pct}%</small></span>`;
      }
      const priceDisplay=h.currentPrice?fmt(h.currentPrice,state.currency):'<span class="muted">ustaw</span>';
      tr.innerHTML=`<td><strong>${escapeHtml(h.name)}</strong></td><td>${escapeHtml(h.group)}</td><td>${h.qty.toFixed(4)}</td><td>${fmt(h.avgCost,state.currency)}</td><td class="inv-price-cell" data-asset-id="${h.id}" style="cursor:pointer" title="Kliknij, aby zmienić cenę">${priceDisplay}</td><td>${fmt(val,state.currency)}</td><td>${pnlHtml}</td><td>${weight}%</td><td><button class="btn ghost inv-sell-quick" data-sell-asset="${h.id}" data-sell-qty="${h.qty}" style="font-size:11px;padding:4px 8px">Sprzedaj</button></td>`;
      tr.querySelector('.inv-price-cell').onclick=function(){
        const cell=this;
        const aid=cell.dataset.assetId;
        const asset=investments().assets.find(a=>a.id===aid);
        if(!asset) return;
        const input=document.createElement('input');
        input.className='inv-price-input';
        input.value=asset.currentPrice||'';
        input.placeholder='0,00';
        input.inputMode='decimal';
        cell.innerHTML='';cell.appendChild(input);input.focus();
        const finish=()=>{
          const v=num(input.value);
          asset.currentPrice=v>0?v:null;
          asset.priceDate=v>0?new Date().toISOString().slice(0,10):null;
          save(state);renderInvestments();
        };
        input.onblur=finish;
        input.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();finish();}if(e.key==='Escape'){renderInvestments();}};
      };
      tr.querySelector('.inv-sell-quick').onclick=function(){
        const aid=this.dataset.sellAsset;
        const qty=this.dataset.sellQty;
        setInvTradeMode('sell');
        const sellForm=document.getElementById('inv-sell-form');
        if(sellForm){
          const sel=sellForm.querySelector('select[name="assetId"]');
          if(sel) sel.value=aid;
          const qtyInput=sellForm.querySelector('input[name="quantity"]');
          if(qtyInput) qtyInput.value=qty;
          updateSellPreview();
          sellForm.scrollIntoView({behavior:'smooth',block:'center'});
        }
      };
      tbody.appendChild(tr);
    }
    if(tfoot){
      const totalCost=active.reduce((s,h)=>s+h.costBasis,0);
      const totalMV=active.reduce((s,h)=>s+(h.marketValue!==null?h.marketValue:h.costBasis),0);
      const totalUPnl=stats.totalUnrealizedPnl;
      let pnlFoot='—';
      if(totalUPnl!==null){
        const cls=totalUPnl>=0?'inv-pnl-pos':'inv-pnl-neg';
        const sign=totalUPnl>=0?'+':'';
        pnlFoot=`<span class="${cls}">${sign}${fmt(totalUPnl,state.currency)}</span>`;
      }
      tfoot.innerHTML=`<tr style="font-weight:700;border-top:2px solid rgba(148,163,184,.3)"><td colspan="3">Razem</td><td>${fmt(totalCost,state.currency)}</td><td></td><td>${fmt(totalMV,state.currency)}</td><td>${pnlFoot}</td><td>100%</td><td></td></tr>`;
    }
  }

  // --- Group Summary ---------------------------------------------------------
  function renderInvGroupSummary(holdings,trades){
    const tbody=document.querySelector('#inv-group-table tbody');
    if(!tbody) return;
    const active=holdings.filter(h=>h.qty>0.000001||h.costBasis>0);
    if(!active.length){
      tbody.innerHTML='<tr><td colspan="6" class="muted" style="text-align:center">Brak danych</td></tr>';
      return;
    }
    tbody.innerHTML='';
    const groups=[...new Set(active.map(h=>h.group||'Inne'))];
    const totalMV=active.reduce((s,h)=>s+(h.marketValue!==null?h.marketValue:h.costBasis),0)||1;
    groups.sort((a,bb)=>{
      const va=active.filter(h=>h.group===a).reduce((s,h)=>s+(h.marketValue||h.costBasis),0);
      const vb=active.filter(h=>h.group===bb).reduce((s,h)=>s+(h.marketValue||h.costBasis),0);
      return vb-va;
    });
    for(const g of groups){
      const grp=active.filter(h=>h.group===g);
      const cost=grp.reduce((s,h)=>s+h.costBasis,0);
      const mv=grp.reduce((s,h)=>s+(h.marketValue!==null?h.marketValue:h.costBasis),0);
      const pnl=mv-cost;
      const hasPrice=grp.some(h=>h.marketValue!==null);
      const pct=((mv/totalMV)*100).toFixed(1);
      const tCount=trades.filter(t=>grp.some(h=>h.id===t.assetId)).length;
      let pnlHtml=hasPrice?`<span class="${pnl>=0?'inv-pnl-pos':'inv-pnl-neg'}">${pnl>=0?'+':''}${fmt(pnl,state.currency)}</span>`:'<span class="muted">—</span>';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><strong>${escapeHtml(g)}</strong></td><td>${fmt(cost,state.currency)}</td><td>${fmt(mv,state.currency)}</td><td>${pnlHtml}</td><td>${pct}%</td><td>${tCount}</td>`;
      tbody.appendChild(tr);
    }
  }

  // --- Trade History ---------------------------------------------------------
  function renderInvTradeHistory(){
    const data=investments();
    const tbody=document.querySelector('#inv-trades-table tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    const countBadge=document.getElementById('inv-trade-count-badge');
    if(countBadge) countBadge.textContent=`(${data.trades.length})`;
    let trades=[...data.trades].sort((a,bb)=>String(bb.date||'').localeCompare(String(a.date||'')));
    if(invTradeFilter==='buy') trades=trades.filter(t=>t.side!=='sell');
    if(invTradeFilter==='sell') trades=trades.filter(t=>t.side==='sell');
    if(!trades.length){
      tbody.innerHTML=`<tr><td colspan="10" class="muted" style="text-align:center">Brak transakcji${invTradeFilter!=='all'?' w tym filtrze':''}</td></tr>`;
      return;
    }
    for(const t of trades){
      const asset=data.assets.find(a=>a.id===t.assetId);
      const qty=num(t.quantity);
      const amt=num(t.amount);
      const pricePerUnit=qty>0?(amt/qty):0;
      const isSell=t.side==='sell';
      const sideBadge=isSell?'<span class="inv-side-sell">SELL</span>':'<span class="inv-side-buy">BUY</span>';
      let sourceBadge='';
      if(isSell){
        sourceBadge=t.sellDestination==='budget'?'<span class="inv-source-badge">→ Budżet</span>':'<span class="inv-source-badge">→ Reinwest.</span>';
      } else {
        sourceBadge=t.fundSource==='reinvest'?'<span class="inv-source-badge">Z reinwest.</span>':'<span class="inv-source-badge">Z budżetu</span>';
      }
      let pnlHtml='';
      if(isSell&&t.realizedPnl!==undefined){
        const rp=num(t.realizedPnl);
        const cls=rp>=0?'inv-pnl-pos':'inv-pnl-neg';
        pnlHtml=`<span class="${cls}">${rp>=0?'+':''}${fmt(rp,state.currency)}</span>`;
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.date||'—'}</td><td>${sideBadge}</td><td>${escapeHtml(asset?.name||'—')}</td><td>${qty}</td><td>${fmt(pricePerUnit,state.currency)}</td><td>${fmt(amt,state.currency)}</td><td>${sourceBadge}</td><td>${pnlHtml}</td><td>${escapeHtml(t.note||'')}</td><td><button class="btn ghost" data-act="del" style="font-size:12px">Usuń</button></td>`;
      tr.querySelector('[data-act="del"]').onclick=()=>{
        if(!confirm('Usunąć tę transakcję?')) return;
        deleteInvestmentTrade(t.id);
      };
      tbody.appendChild(tr);
    }
  }

  // --- Sell Preview ----------------------------------------------------------
  function updateSellPreview(){
    const form=document.getElementById('inv-sell-form');
    const preview=document.getElementById('inv-sell-preview');
    if(!form||!preview) return;
    const assetId=form.querySelector('select[name="assetId"]')?.value;
    const qty=num(form.querySelector('input[name="quantity"]')?.value);
    const ppu=num(form.querySelector('input[name="pricePerUnit"]')?.value);
    if(!assetId||qty<=0){
      preview.innerHTML='Wybierz aktywo i wpisz ilość, aby zobaczyć podgląd transakcji.';
      return;
    }
    const {costBasis,availableQty}=computeSellCostBasis(assetId,qty);
    const asset=investments().assets.find(a=>a.id===assetId);
    const cur=state.currency;
    if(qty>availableQty+0.000001){
      preview.innerHTML=`<strong>${escapeHtml(asset?.name||'')}</strong> — posiadasz <strong>${availableQty.toFixed(4)}</strong> szt. Nie możesz sprzedać ${qty.toFixed(4)}.`;
      return;
    }
    const proceeds=qty*ppu;
    const pnl=proceeds-costBasis;
    const pnlCls=pnl>=0?'pos':'neg';
    const pnlSign=pnl>=0?'+':'';
    let html=`<strong>${escapeHtml(asset?.name||'')}</strong> — sprzedaż ${qty.toFixed(4)} szt.<br>`;
    html+=`Posiadasz: <strong>${availableQty.toFixed(4)}</strong> szt. | Baza kosztowa (FIFO): <strong>${fmt(costBasis,cur)}</strong><br>`;
    if(ppu>0){
      html+=`Przychód: <strong>${fmt(proceeds,cur)}</strong> | Zysk/Strata: <span class="${pnlCls}"><strong>${pnlSign}${fmt(pnl,cur)}</strong></span>`;
    }
    preview.innerHTML=html;
  }

  // --- Charts ----------------------------------------------------------------
  function invMonthKey(dateStr){
    const d=new Date(dateStr||new Date());
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  }

  function renderInvCapitalChart(trades,assets){
    const canvas=document.getElementById('inv-capital-chart');
    const empty=document.getElementById('inv-capital-empty');
    if(invCapitalChart){invCapitalChart.destroy();invCapitalChart=null;}
    if(!canvas||!empty) return;
    if(!trades.length){empty.style.display='flex';canvas.style.display='none';return;}
    empty.style.display='none';canvas.style.display='block';
    const months=[...new Set(trades.map(t=>invMonthKey(t.date)))].sort();
    const buyBudget=months.map(m=>trades.filter(t=>invMonthKey(t.date)===m&&t.side!=='sell'&&t.fundSource!=='reinvest').reduce((s,t)=>s+num(t.amount),0));
    const buyReinvest=months.map(m=>trades.filter(t=>invMonthKey(t.date)===m&&t.side!=='sell'&&t.fundSource==='reinvest').reduce((s,t)=>s+num(t.amount),0));
    const sellBudget=months.map(m=>trades.filter(t=>invMonthKey(t.date)===m&&t.side==='sell'&&t.sellDestination==='budget').reduce((s,t)=>s+num(t.amount),0));
    const sellReinvest=months.map(m=>trades.filter(t=>invMonthKey(t.date)===m&&t.side==='sell'&&t.sellDestination!=='budget').reduce((s,t)=>s+num(t.amount),0));
    invCapitalChart=new Chart(canvas.getContext('2d'),{
      type:'bar',
      data:{labels:months,datasets:[
        {label:'Zakup (budżet)',data:buyBudget,backgroundColor:colorWithAlpha('#2563eb',.6),stack:'in'},
        {label:'Zakup (reinwest.)',data:buyReinvest,backgroundColor:colorWithAlpha('#8b5cf6',.6),stack:'in'},
        {label:'Sprzedaż → budżet',data:sellBudget.map(v=>-v),backgroundColor:colorWithAlpha('#22c55e',.6),stack:'out'},
        {label:'Sprzedaż → reinwest.',data:sellReinvest.map(v=>-v),backgroundColor:colorWithAlpha('#f59e0b',.6),stack:'out'}
      ]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${currencyTicks(Math.abs(ctx.parsed.y))}`}}},
        scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true,ticks:{callback:v=>currencyTicks(Math.abs(v))}}}
      }
    });
  }

  function renderInvCumulativeChart(trades,assets){
    const canvas=document.getElementById('inv-cumulative-chart');
    const empty=document.getElementById('inv-cumulative-empty');
    if(invCumulativeChart){invCumulativeChart.destroy();invCumulativeChart=null;}
    if(!canvas||!empty) return;
    const buyTrades=trades.filter(t=>t.side!=='sell');
    if(!buyTrades.length){empty.style.display='flex';canvas.style.display='none';return;}
    empty.style.display='none';canvas.style.display='block';
    const sorted=[...buyTrades].sort((a,bb)=>String(a.date||'').localeCompare(String(bb.date||'')));
    const dates=[...new Set(sorted.map(t=>t.date))];
    const groups=[...new Set(assets.map(a=>a.group||'Inne'))];
    if(!groups.length) groups.push('Inne');
    const datasets=groups.map((group,idx)=>{
      let running=0;
      const data=dates.map(date=>{
        running+=sorted.filter(t=>t.date===date&&(assets.find(a=>a.id===t.assetId)?.group||'Inne')===group).reduce((s,t)=>s+num(t.amount),0);
        return running;
      });
      const color=invPalette[idx%invPalette.length];
      return {label:group,data,borderColor:color,backgroundColor:colorWithAlpha(color,.15),fill:true,tension:.32,borderWidth:2};
    });
    invCumulativeChart=new Chart(canvas.getContext('2d'),{
      type:'line',data:{labels:dates,datasets},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${currencyTicks(ctx.parsed.y)}`}}},
        interaction:{mode:'index',intersect:false},
        scales:{x:{grid:{display:false}},y:{ticks:{callback:v=>currencyTicks(v)}}}
      }
    });
  }

  function renderInvAllocationDetail(holdings){
    const canvas=document.getElementById('inv-allocation-detail-chart');
    const empty=document.getElementById('inv-allocation-detail-empty');
    const title=document.getElementById('inv-allocation-detail-title');
    const meta=document.getElementById('inv-allocation-detail-meta');
    if(invAllocationDetailChart){invAllocationDetailChart.destroy();invAllocationDetailChart=null;}
    if(!canvas||!empty) return;
    if(!invSelectedAllocationGroup){
      empty.style.display='flex';canvas.style.display='none';
      if(title) title.textContent='Szczegóły grupy';
      if(meta) meta.textContent='Kliknij segment';
      return;
    }
    const subset=holdings.filter(h=>h.group===invSelectedAllocationGroup&&h.qty>0.000001);
    if(title) title.textContent=`Struktura — ${invSelectedAllocationGroup}`;
    if(meta) meta.textContent=subset.length?'Udział aktywów w grupie':'Brak aktywów';
    if(!subset.length){empty.style.display='flex';canvas.style.display='none';return;}
    empty.style.display='none';canvas.style.display='block';
    invAllocationDetailChart=new Chart(canvas.getContext('2d'),{
      type:'doughnut',
      data:{labels:subset.map(h=>h.name),datasets:[{data:subset.map(h=>h.marketValue||h.costBasis),backgroundColor:subset.map((_,i)=>colorWithAlpha(invPalette[i%invPalette.length],.8)),borderColor:'#fff',borderWidth:1}]},
      options:{plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${currencyTicks(ctx.parsed)}`}}}}
    });
  }

  function renderInvAllocations(holdings){
    const canvas=document.getElementById('inv-allocation-chart');
    const empty=document.getElementById('inv-allocation-empty');
    if(invAllocationChart){invAllocationChart.destroy();invAllocationChart=null;}
    if(!canvas||!empty) return;
    const active=holdings.filter(h=>h.qty>0.000001);
    if(!active.length){
      empty.style.display='flex';canvas.style.display='none';
      invSelectedAllocationGroup=null;renderInvAllocationDetail([]);return;
    }
    const groups=[...new Set(active.map(h=>h.group))];
    const totals=groups.map(g=>active.filter(h=>h.group===g).reduce((s,h)=>s+(h.marketValue||h.costBasis),0));
    const totalSum=totals.reduce((a,bb)=>a+bb,0);
    invSelectedAllocationGroup=invSelectedAllocationGroup&&groups.includes(invSelectedAllocationGroup)?invSelectedAllocationGroup:groups[0];
    empty.style.display='none';canvas.style.display='block';
    invAllocationChart=new Chart(canvas.getContext('2d'),{
      type:'doughnut',
      data:{labels:groups,datasets:[{data:totals,backgroundColor:groups.map((_,i)=>colorWithAlpha(invPalette[i%invPalette.length],.85)),borderColor:'#fff',borderWidth:1}]},
      options:{
        plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${currencyTicks(ctx.parsed)} (${totalSum?((ctx.parsed/totalSum)*100).toFixed(1):'0.0'}%)`}}},
        onClick:(evt,elements)=>{
          if(!elements.length) return;
          invSelectedAllocationGroup=groups[elements[0].index];
          renderInvAllocationDetail(active);
        }
      }
    });
    renderInvAllocationDetail(active);
  }

  function renderInvPnlChart(trades,assets){
    const canvas=document.getElementById('inv-pnl-chart');
    const empty=document.getElementById('inv-pnl-empty');
    if(invPnlChart){invPnlChart.destroy();invPnlChart=null;}
    if(!canvas||!empty) return;
    const sells=trades.filter(t=>t.side==='sell');
    if(!sells.length){empty.style.display='flex';canvas.style.display='none';return;}
    empty.style.display='none';canvas.style.display='block';
    const sorted=[...sells].sort((a,bb)=>String(a.date||'').localeCompare(String(bb.date||'')));
    const dates=sorted.map(t=>t.date);
    let cumPnl=0;
    const cumData=sorted.map(t=>{cumPnl+=num(t.realizedPnl||0);return cumPnl;});
    const perTrade=sorted.map(t=>num(t.realizedPnl||0));
    const barColors=perTrade.map(v=>v>=0?colorWithAlpha('#22c55e',.6):colorWithAlpha('#ef4444',.6));
    invPnlChart=new Chart(canvas.getContext('2d'),{
      type:'bar',
      data:{labels:dates,datasets:[
        {label:'P&L transakcji',data:perTrade,backgroundColor:barColors,borderRadius:4,order:2,yAxisID:'y'},
        {label:'Skumulowany P&L',data:cumData,type:'line',borderColor:'#2563eb',backgroundColor:colorWithAlpha('#2563eb',.1),fill:true,tension:.3,borderWidth:2,pointRadius:3,order:1,yAxisID:'y'}
      ]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${currencyTicks(ctx.parsed.y)}`}}},
        scales:{x:{grid:{display:false}},y:{ticks:{callback:v=>currencyTicks(v)}}}
      }
    });
  }

  // --- Investment Analytics Hub -----------------------------------------------
  const INV_HUB_SNAP_KEY='lifeos_inv_hub_snapshots';
  let invHubRoiChart=null, invHubPnlChart=null, invHubDepositsChart=null, invHubCumulativeChart=null, invHubCalcChart=null;
  let invHubBound=false;

  function invHubSnapshots(){
    try{ return JSON.parse(localStorage.getItem(INV_HUB_SNAP_KEY))||[]; }catch{ return []; }
  }
  function invHubSaveSnapshots(snaps){
    localStorage.setItem(INV_HUB_SNAP_KEY,JSON.stringify(snaps));
  }

  function invHubTakeSnapshot(){
    const stats=computePortfolioStats();
    const today=new Date().toISOString().slice(0,10);
    const snaps=invHubSnapshots();
    const existing=snaps.findIndex(s=>s.date===today);
    const snap={
      date:today,
      portfolioValue:stats.hasAnyPrice?stats.totalMarketValue:stats.totalCostBasis,
      capitalFromBudget:stats.capitalFromBudget,
      totalPnl:stats.totalPnl,
      unrealizedPnl:stats.totalUnrealizedPnl||0,
      realizedPnl:stats.totalRealizedPnl,
      roi:stats.roi,
      costBasis:stats.totalCostBasis
    };
    if(existing>=0) snaps[existing]=snap;
    else snaps.push(snap);
    snaps.sort((a,b)=>a.date.localeCompare(b.date));
    invHubSaveSnapshots(snaps);
    renderInvHub();
  }

  function invHubDeleteSnapshot(date){
    const snaps=invHubSnapshots().filter(s=>s.date!==date);
    invHubSaveSnapshots(snaps);
    renderInvHub();
  }

  function invHubComputeStreak(){
    const snaps=invHubSnapshots();
    if(!snaps.length) return 0;
    let streak=0;
    const today=new Date();
    for(let i=0;i<365;i++){
      const d=new Date(today);
      d.setDate(d.getDate()-i);
      const ds=d.toISOString().slice(0,10);
      if(snaps.some(s=>s.date===ds)) streak++;
      else break;
    }
    return streak;
  }

  function invHubWeekKey(dateStr){
    const d=new Date(dateStr);
    const jan1=new Date(d.getFullYear(),0,1);
    const week=Math.ceil(((d-jan1)/86400000+jan1.getDay()+1)/7);
    return `${d.getFullYear()}-W${String(week).padStart(2,'0')}`;
  }

  function invHubMonthKey(dateStr){
    return dateStr.slice(0,7);
  }

  function invHubComputeDeposits(){
    const trades=investments().trades;
    const buys=trades.filter(t=>t.side!=='sell'&&t.fundSource!=='reinvest');
    const weekly={}, monthly={};
    for(const t of buys){
      const wk=invHubWeekKey(t.date);
      const mk=invHubMonthKey(t.date);
      weekly[wk]=(weekly[wk]||0)+num(t.amount);
      monthly[mk]=(monthly[mk]||0)+num(t.amount);
    }
    return {weekly,monthly};
  }

  let invHubDepMode='monthly';
  let invHubTopChart=null;

  function renderInvHub(){
    const stats=computePortfolioStats();
    const snaps=invHubSnapshots();
    const cur=state.currency;
    const data=investments();

    // --- KPIs ---
    const el=id=>document.getElementById(id);
    const portfolioVal=stats.hasAnyPrice?stats.totalMarketValue:stats.totalCostBasis;
    el('inv-hub-kpi-value').textContent=fmt(portfolioVal,cur);
    el('inv-hub-kpi-value-sub').textContent=stats.hasAnyPrice?`Baza: ${fmt(stats.totalCostBasis,cur)}`:'Brak wycen rynkowych';

    el('inv-hub-kpi-roi').textContent=stats.capitalFromBudget>0?`${stats.roi.toFixed(2)}%`:'—';
    const roiCard=el('inv-hub-kpi-roi-card');
    if(roiCard) roiCard.className='inv-hub-kpi '+(stats.roi>0?'positive':stats.roi<0?'negative':'');

    el('inv-hub-kpi-pnl').textContent=fmt(stats.totalPnl,cur);
    el('inv-hub-kpi-pnl-sub').textContent=`Niezreal.: ${fmt(stats.totalUnrealizedPnl||0,cur)} | Zreal.: ${fmt(stats.totalRealizedPnl,cur)}`;
    const pnlCard=el('inv-hub-kpi-pnl-card');
    if(pnlCard) pnlCard.className='inv-hub-kpi '+(stats.totalPnl>0?'positive':stats.totalPnl<0?'negative':'');

    el('inv-hub-kpi-invested').textContent=fmt(stats.capitalFromBudget,cur);
    const totalBuys=data.trades.filter(t=>t.side!=='sell'&&t.fundSource!=='reinvest');
    el('inv-hub-kpi-invested-sub').textContent=`${totalBuys.length} transakcji zakupu`;

    // Average weekly deposit
    const deposits=invHubComputeDeposits();
    const weekKeys=Object.keys(deposits.weekly);
    const avgWeekly=weekKeys.length>0?weekKeys.reduce((s,k)=>s+deposits.weekly[k],0)/weekKeys.length:0;
    el('inv-hub-kpi-weekly').textContent=fmt(avgWeekly,cur);
    el('inv-hub-kpi-weekly-sub').textContent=weekKeys.length?`Z ${weekKeys.length} tygodni`:'Brak danych';

    el('inv-hub-kpi-snaps').textContent=String(snaps.length);

    // --- Streak ---
    const streak=invHubComputeStreak();
    const streakEl=el('inv-hub-streak');
    if(streakEl){
      if(streak>0){
        streakEl.style.display='inline-flex';
        streakEl.textContent=`Seria: ${streak} ${streak===1?'dzień':streak<5?'dni':'dni'} z rzędu`;
      } else {
        streakEl.style.display='none';
      }
    }

    // --- Last snapshot info ---
    const lastSnapEl=el('inv-hub-last-snap');
    if(lastSnapEl){
      if(snaps.length){
        const last=snaps[snaps.length-1];
        const today=new Date().toISOString().slice(0,10);
        lastSnapEl.textContent=last.date===today?`Dzisiejszy snapshot zapisany (${today})`:`Ostatni snapshot: ${last.date}`;
      } else {
        lastSnapEl.textContent='Brak snapshotów — zacznij śledzić swoje wyniki!';
      }
    }

    // --- ROI Chart ---
    if(invHubRoiChart){invHubRoiChart.destroy();invHubRoiChart=null;}
    const roiCanvas=el('inv-hub-roi-chart');
    if(roiCanvas&&snaps.length>0){
      invHubRoiChart=new Chart(roiCanvas.getContext('2d'),{
        type:'line',
        data:{
          labels:snaps.map(s=>s.date),
          datasets:[{
            label:'ROI %',data:snaps.map(s=>s.roi),
            borderColor:'#2563eb',backgroundColor:colorWithAlpha('#2563eb',.1),
            fill:true,tension:.3,borderWidth:2,pointRadius:3,pointBackgroundColor:'#2563eb'
          }]
        },
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`ROI: ${ctx.parsed.y.toFixed(2)}%`}}},
          scales:{x:{grid:{display:false},ticks:{maxTicksLimit:10,font:{size:10}}},y:{ticks:{callback:v=>v.toFixed(1)+'%'},grid:{color:'rgba(148,163,184,.12)'}}}
        }
      });
    }

    // --- PNL Chart ---
    if(invHubPnlChart){invHubPnlChart.destroy();invHubPnlChart=null;}
    const pnlCanvas=el('inv-hub-pnl-chart');
    if(pnlCanvas&&snaps.length>0){
      const pnlColors=snaps.map(s=>s.totalPnl>=0?colorWithAlpha('#22c55e',.7):colorWithAlpha('#ef4444',.7));
      invHubPnlChart=new Chart(pnlCanvas.getContext('2d'),{
        type:'bar',
        data:{
          labels:snaps.map(s=>s.date),
          datasets:[
            {label:'P&L',data:snaps.map(s=>s.totalPnl),backgroundColor:pnlColors,borderRadius:4},
            {label:'Wartość portfela',data:snaps.map(s=>s.portfolioValue),type:'line',borderColor:'#8b5cf6',backgroundColor:'transparent',borderWidth:2,pointRadius:2,yAxisID:'y2',tension:.3}
          ]
        },
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{position:'bottom',labels:{font:{size:11}}},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${currencyTicks(ctx.parsed.y)}`}}},
          scales:{
            x:{grid:{display:false},ticks:{maxTicksLimit:10,font:{size:10}}},
            y:{position:'left',ticks:{callback:v=>currencyTicks(v)},grid:{color:'rgba(148,163,184,.12)'}},
            y2:{position:'right',ticks:{callback:v=>currencyTicks(v)},grid:{display:false}}
          }
        }
      });
    }

    // --- Deposits Chart (weekly/monthly with slider) ---
    renderInvHubDeposits(deposits);

    // --- Cumulative Capital + PNL overlay ---
    if(invHubCumulativeChart){invHubCumulativeChart.destroy();invHubCumulativeChart=null;}
    const cumCanvas=el('inv-hub-cumulative-chart');
    if(cumCanvas){
      // Build date-keyed cumulative capital from buy trades
      const allTrades=[...data.trades].sort((a,b)=>String(a.date||'').localeCompare(String(b.date||'')));
      const buyTrades=allTrades.filter(t=>t.side!=='sell'&&t.fundSource!=='reinvest');
      if(buyTrades.length>0){
        // Collect all unique dates across buys and snapshots
        const dateSet=new Set(buyTrades.map(t=>t.date));
        snaps.forEach(s=>dateSet.add(s.date));
        const allDates=[...dateSet].sort();

        // Cumulative capital at each date
        let running=0;
        const cumByDate={};
        for(const t of buyTrades){
          running+=num(t.amount);
          cumByDate[t.date]=running;
        }
        // Fill forward
        let lastCum=0;
        const cumData=allDates.map(d=>{
          if(cumByDate[d]!==undefined) lastCum=cumByDate[d];
          return lastCum;
        });

        // PNL from snapshots keyed by date
        const pnlByDate={};
        snaps.forEach(s=>{pnlByDate[s.date]=s.portfolioValue;});
        // Portfolio value line - only show points where we have snapshot data
        const portfolioData=allDates.map(d=>pnlByDate[d]!==undefined?pnlByDate[d]:null);

        const datasets=[
          {label:'Zainwestowany kapitał',data:cumData,borderColor:'#059669',backgroundColor:colorWithAlpha('#059669',.1),fill:true,tension:.3,borderWidth:2,pointRadius:1},
          {label:'Wartość portfela (snapshoty)',data:portfolioData,borderColor:'#8b5cf6',backgroundColor:colorWithAlpha('#8b5cf6',.08),fill:true,tension:.3,borderWidth:2,pointRadius:3,pointBackgroundColor:'#8b5cf6',spanGaps:true}
        ];

        invHubCumulativeChart=new Chart(cumCanvas.getContext('2d'),{
          type:'line',
          data:{labels:allDates,datasets},
          options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{position:'bottom',labels:{font:{size:11}}},tooltip:{mode:'index',intersect:false,callbacks:{label:ctx=>ctx.parsed.y!==null?`${ctx.dataset.label}: ${currencyTicks(ctx.parsed.y)}`:null}}},
            interaction:{mode:'index',intersect:false},
            scales:{x:{grid:{display:false},ticks:{maxTicksLimit:12,font:{size:10}}},y:{ticks:{callback:v=>currencyTicks(v)},grid:{color:'rgba(148,163,184,.12)'}}}
          }
        });
      }
    }

    // --- Top Holdings Bar Chart (sorted by PNL, full width) ---
    if(invHubTopChart){invHubTopChart.destroy();invHubTopChart=null;}
    const topCanvas=el('inv-hub-top-chart');
    if(topCanvas){
      const active=stats.holdings.filter(h=>h.qty>0.000001);
      if(active.length>0){
        const sorted=[...active].sort((a,b)=>{
          const pnlA=a.marketValue!==null?(a.marketValue-a.costBasis):0;
          const pnlB=b.marketValue!==null?(b.marketValue-b.costBasis):0;
          return pnlB-pnlA;
        });
        const labels=sorted.map(h=>h.name);
        const pnlData=sorted.map(h=>h.marketValue!==null?(h.marketValue-h.costBasis):0);
        const roiData=sorted.map(h=>h.costBasis>0&&h.marketValue!==null?((h.marketValue-h.costBasis)/h.costBasis*100):0);
        const barColors=pnlData.map(v=>v>=0?colorWithAlpha('#22c55e',.7):colorWithAlpha('#ef4444',.7));

        invHubTopChart=new Chart(topCanvas.getContext('2d'),{
          type:'bar',
          data:{
            labels,
            datasets:[
              {label:'P&L',data:pnlData,backgroundColor:barColors,borderRadius:4,yAxisID:'y',order:2},
              {label:'ROI %',data:roiData,type:'line',borderColor:'#2563eb',backgroundColor:'transparent',borderWidth:2,pointRadius:3,pointBackgroundColor:'#2563eb',tension:.3,yAxisID:'y2',order:1}
            ]
          },
          options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{position:'bottom',labels:{font:{size:11}}},
              tooltip:{callbacks:{label:ctx=>{
                if(ctx.dataset.label==='ROI %') return `ROI: ${ctx.parsed.y.toFixed(1)}%`;
                return `P&L: ${currencyTicks(ctx.parsed.y)}`;
              }}}
            },
            scales:{
              x:{grid:{display:false},ticks:{font:{size:10},maxRotation:45}},
              y:{position:'left',ticks:{callback:v=>currencyTicks(v)},grid:{color:'rgba(148,163,184,.12)'}},
              y2:{position:'right',ticks:{callback:v=>v.toFixed(0)+'%'},grid:{display:false}}
            }
          }
        });
      }
    }

    // --- Forecast Simulator (data-driven) ---
    renderInvHubForecast(stats,deposits);

    // --- Snapshot History Table ---
    const snapTbody=document.querySelector('#inv-hub-snap-table tbody');
    const snapEmpty=el('inv-hub-snap-empty');
    if(snapTbody){
      snapTbody.innerHTML='';
      if(!snaps.length){
        if(snapEmpty) snapEmpty.style.display='block';
        document.getElementById('inv-hub-snap-table').style.display='none';
      } else {
        if(snapEmpty) snapEmpty.style.display='none';
        document.getElementById('inv-hub-snap-table').style.display='';
        const reversed=[...snaps].reverse();
        for(const s of reversed){
          const pnlCls=s.totalPnl>=0?'inv-pnl-pos':'inv-pnl-neg';
          const roiCls=s.roi>=0?'inv-pnl-pos':'inv-pnl-neg';
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${s.date}</td><td>${fmt(s.portfolioValue,cur)}</td><td>${fmt(s.capitalFromBudget,cur)}</td><td class="${pnlCls}">${s.totalPnl>=0?'+':''}${fmt(s.totalPnl,cur)}</td><td class="${roiCls}">${s.roi.toFixed(2)}%</td><td><button class="btn ghost" style="font-size:10px;padding:2px 6px" data-snap-del="${s.date}">Usuń</button></td>`;
          tr.querySelector('[data-snap-del]').onclick=()=>invHubDeleteSnapshot(s.date);
          snapTbody.appendChild(tr);
        }
      }
    }
  }

  // --- Deposits sub-chart with mode + range ---
  function renderInvHubDeposits(deposits){
    if(invHubDepositsChart){invHubDepositsChart.destroy();invHubDepositsChart=null;}
    const canvas=document.getElementById('inv-hub-deposits-chart');
    if(!canvas) return;
    const rangeInput=document.getElementById('inv-hub-dep-range');
    const rangeLabel=document.getElementById('inv-hub-dep-range-label');
    const limit=rangeInput?parseInt(rangeInput.value):12;
    const isWeekly=invHubDepMode==='weekly';
    const src=isWeekly?deposits.weekly:deposits.monthly;
    const allKeys=Object.keys(src).sort();
    const keys=allKeys.slice(-limit);
    const unit=isWeekly?'tyg.':'mies.';

    // Update range max and label
    if(rangeInput) rangeInput.max=String(Math.max(allKeys.length,1));
    if(rangeLabel) rangeLabel.textContent=`${limit} ${unit}`;

    if(!keys.length) return;
    const vals=keys.map(k=>src[k]||0);
    const avg=vals.reduce((s,v)=>s+v,0)/vals.length;

    invHubDepositsChart=new Chart(canvas.getContext('2d'),{
      type:'bar',
      data:{
        labels:keys,
        datasets:[
          {label:isWeekly?'Wpłaty tygodniowe':'Wpłaty miesięczne',data:vals,backgroundColor:colorWithAlpha('#2563eb',.6),borderRadius:4},
          {label:'Średnia',data:keys.map(()=>avg),type:'line',borderColor:colorWithAlpha('#f59e0b',.8),backgroundColor:'transparent',borderWidth:2,borderDash:[6,3],pointRadius:0,tension:0}
        ]
      },
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{size:11}}},tooltip:{callbacks:{label:ctx=>{
          if(ctx.dataset.label==='Średnia') return `Średnia: ${currencyTicks(ctx.parsed.y)}`;
          return `${ctx.dataset.label}: ${currencyTicks(ctx.parsed.y)}`;
        }}}},
        scales:{x:{grid:{display:false},ticks:{font:{size:10},maxRotation:45}},y:{ticks:{callback:v=>currencyTicks(v)},grid:{color:'rgba(148,163,184,.12)'}}}
      }
    });
  }

  // --- Forecast Simulator ---
  function renderInvHubForecast(stats,deposits){
    if(invHubCalcChart){invHubCalcChart.destroy();invHubCalcChart=null;}
    const el=id=>document.getElementById(id);
    const cur=state.currency;

    const rateInput=el('inv-hub-calc-rate');
    const yearsInput=el('inv-hub-calc-years');
    const multiplierInput=el('inv-hub-calc-multiplier');
    const targetMonthInput=el('inv-hub-calc-target-month');

    if(!rateInput?.value) rateInput.value='8';
    if(!yearsInput?.value) yearsInput.value='5';
    if(!multiplierInput?.value) multiplierInput.value='1.5';

    const rate=rateInput&&rateInput.value?num(rateInput.value):8;
    const years=yearsInput&&yearsInput.value?parseInt(yearsInput.value):5;
    const multiplier=multiplierInput&&multiplierInput.value?num(multiplierInput.value):1.5;
    if(years<=0||years>60||multiplier<=0) return;

    const monthKeys=Object.keys(deposits.monthly).sort();
    const now=new Date();
    const openMonth=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const closedMonths=monthKeys.filter(m=>m<openMonth);

    const trendMonths=closedMonths.slice(-6);
    const avgTrendMonthly=trendMonths.length?trendMonths.reduce((s,k)=>s+(deposits.monthly[k]||0),0)/trendMonths.length:0;

    const currentVal=stats.hasAnyPrice?stats.totalMarketValue:stats.totalCostBasis;
    const currentInvested=stats.capitalFromBudget;

    const monthsForward=years*12;
    const monthlyRate=rate/100/12;

    const startDate=new Date(now.getFullYear(),now.getMonth(),1);
    const labels=[];
    const forecastRows=[];

    let balance=currentVal;
    let totalCapital=currentInvested;
    for(let i=0;i<=monthsForward;i++){
      if(i>0){
        balance=balance*(1+monthlyRate)+(avgTrendMonthly*multiplier);
        totalCapital+=(avgTrendMonthly*multiplier);
      }
      const d=new Date(startDate.getFullYear(),startDate.getMonth()+i,1);
      const monthLabel=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      labels.push(monthLabel);
      forecastRows.push({
        monthLabel,
        value:balance,
        capital:totalCapital,
        interest:balance-totalCapital
      });
    }

    const final=forecastRows[forecastRows.length-1];

    if(targetMonthInput){
      if(!targetMonthInput.value||targetMonthInput.value<labels[0]||targetMonthInput.value>labels[labels.length-1]){
        const def=new Date(startDate.getFullYear(),startDate.getMonth()+Math.min(12,monthsForward),1);
        targetMonthInput.value=`${def.getFullYear()}-${String(def.getMonth()+1).padStart(2,'0')}`;
      }
      targetMonthInput.min=labels[0];
      targetMonthInput.max=labels[labels.length-1];
    }

    const targetMonth=targetMonthInput?.value;
    const targetRow=forecastRows.find(r=>r.monthLabel===targetMonth) || final;

    const resultEl=el('inv-hub-calc-result');
    if(resultEl){
      resultEl.style.display='block';
      const trendInfo=trendMonths.length
        ? `Trend z ${trendMonths.length} zamkniętych mies.: ${fmt(avgTrendMonthly,cur)}/mies.`
        : 'Brak zamkniętych miesięcy z wpłatami — tempo wpłat = 0.';
      resultEl.innerHTML=`
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px">
          <div style="padding:10px;border-radius:10px;background:${colorWithAlpha('#2563eb',.08)};border:1px solid ${colorWithAlpha('#2563eb',.2)}">
            <div style="font-size:11px;font-weight:700;color:#2563eb;text-transform:uppercase">Parametry symulacji</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px">${escapeHtml(trendInfo)}</div>
            <div style="font-size:11px;color:var(--muted)">Mnożnik wpłat: ${multiplier.toFixed(2)}x → ${fmt(avgTrendMonthly*multiplier,cur)}/mies.</div>
            <div style="font-size:11px;color:var(--muted)">Roczna stopa: ${rate.toFixed(2)}% | Horyzont: ${years} lat</div>
          </div>
          <div style="padding:10px;border-radius:10px;background:${colorWithAlpha('#059669',.08)};border:1px solid ${colorWithAlpha('#059669',.2)}">
            <div style="font-size:11px;font-weight:700;color:#059669;text-transform:uppercase">Koniec horyzontu</div>
            <div style="font-size:18px;font-weight:800;color:#059669;margin:4px 0">${fmt(final.value,cur)}</div>
            <div style="font-size:11px;color:var(--muted)">Kapitał: ${fmt(final.capital,cur)}</div>
            <div style="font-size:11px;color:var(--muted)">Odsetki: ${fmt(final.interest,cur)}</div>
          </div>
          <div style="padding:10px;border-radius:10px;background:${colorWithAlpha('#8b5cf6',.08)};border:1px solid ${colorWithAlpha('#8b5cf6',.2)}">
            <div style="font-size:11px;font-weight:700;color:#8b5cf6;text-transform:uppercase">Podgląd miesiąca: ${escapeHtml(targetRow.monthLabel)}</div>
            <div style="font-size:18px;font-weight:800;color:#8b5cf6;margin:4px 0">${fmt(targetRow.value,cur)}</div>
            <div style="font-size:11px;color:var(--muted)">Kapitał: ${fmt(targetRow.capital,cur)}</div>
            <div style="font-size:11px;color:var(--muted)">Odsetki: ${fmt(targetRow.interest,cur)}</div>
          </div>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:8px">Kliknij słupek miesiąca na wykresie, aby zaktualizować kafelek „Podgląd miesiąca”.</div>`;
    }

    const canvas=el('inv-hub-calc-chart');
    if(canvas){
      const capitalData=forecastRows.map(r=>Math.round(r.capital));
      const interestData=forecastRows.map(r=>Math.round(r.interest));
      invHubCalcChart=new Chart(canvas.getContext('2d'),{
        type:'bar',
        data:{
          labels,
          datasets:[
            {
              label:'Kapitał (wpłaty)',
              data:capitalData,
              stack:'portfolio',
              borderColor:'#059669',
              backgroundColor:colorWithAlpha('#059669',.75),
              borderWidth:1,
              borderRadius:4,
              borderSkipped:false
            },
            {
              label:'Odsetki',
              data:interestData,
              stack:'portfolio',
              borderColor:'#8b5cf6',
              backgroundColor:colorWithAlpha('#8b5cf6',.78),
              borderWidth:1,
              borderRadius:4,
              borderSkipped:false
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{position:'bottom',labels:{font:{size:12,weight:'600'},padding:18,usePointStyle:true}},
            tooltip:{mode:'index',intersect:false,callbacks:{
              label:ctx=>`${ctx.dataset.label}: ${currencyTicks(ctx.parsed.y)}`,
              afterBody:items=>{
                const idx=items?.[0]?.dataIndex||0;
                const row=forecastRows[idx];
                if(!row) return '';
                return `Razem: ${fmt(row.value,cur)} | Kapitał: ${fmt(row.capital,cur)} | Odsetki: ${fmt(row.interest,cur)}`;
              }
            }}
          },
          onClick:(evt,elements)=>{
            if(!elements?.length||!targetMonthInput) return;
            const idx=elements[0].index;
            const row=forecastRows[idx];
            if(!row) return;
            targetMonthInput.value=row.monthLabel;
            renderInvHubForecast(stats,deposits);
          },
          scales:{
            x:{stacked:true,grid:{display:false},ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:10,font:{size:11}}},
            y:{stacked:true,ticks:{callback:v=>currencyTicks(v),font:{size:11}},grid:{color:'rgba(148,163,184,.1)'}}
          }
        }
      });
    }
  }

  function bindInvHub(){
    if(invHubBound) return;
    invHubBound=true;
    const snapBtn=document.getElementById('inv-hub-snap-btn');
    if(snapBtn) snapBtn.onclick=invHubTakeSnapshot;
    const clearBtn=document.getElementById('inv-hub-snap-clear');
    if(clearBtn) clearBtn.onclick=()=>{
      if(confirm('Usunąć całą historię snapshotów?')){
        invHubSaveSnapshots([]);
        renderInvHub();
      }
    };

    // Deposits toggle
    document.querySelectorAll('.inv-hub-dep-mode').forEach(btn=>{
      btn.onclick=()=>{
        invHubDepMode=btn.dataset.depMode||'monthly';
        document.querySelectorAll('.inv-hub-dep-mode').forEach(b=>b.classList.toggle('is-active',b===btn));
        renderInvHubDeposits(invHubComputeDeposits());
      };
    });
    // Deposits range slider
    const depRange=document.getElementById('inv-hub-dep-range');
    if(depRange) depRange.oninput=()=>renderInvHubDeposits(invHubComputeDeposits());

    // Forecast controls
    const recalcForecast=()=>{
      const stats=computePortfolioStats();
      const deposits=invHubComputeDeposits();
      renderInvHubForecast(stats,deposits);
    };
    const calcBtn=document.getElementById('inv-hub-calc-btn');
    if(calcBtn) calcBtn.onclick=recalcForecast;
    ['inv-hub-calc-rate','inv-hub-calc-years','inv-hub-calc-multiplier','inv-hub-calc-target-month'].forEach(id=>{
      const inp=document.getElementById(id);
      if(!inp) return;
      inp.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();recalcForecast();}});
      inp.addEventListener('change',recalcForecast);
    });
  }

  // --- Main Render -----------------------------------------------------------
  function renderInvestments(){
    ensureInvestmentCategory();
    const data=investments();
    bindInvestmentModal();
    bindInvestmentAnalyticsNav();

    // Trade mode tabs
    document.querySelectorAll('.inv-trade-tab').forEach(tab=>{
      if(tab._bound) return; tab._bound=true;
      tab.onclick=()=>setInvTradeMode(tab.dataset.tradeMode||'buy');
    });
    setInvTradeMode(invTradeMode);

    // Trade filter tabs
    document.querySelectorAll('.inv-trade-filter').forEach(f=>{
      if(f._bound) return; f._bound=true;
      f.onclick=()=>setInvTradeFilter(f.dataset.filter||'all');
    });

    // Asset manager buttons
    const addRowBtn=document.getElementById('inv-asset-add-row');
    const addGroupBtn=document.getElementById('inv-asset-add-group');
    const saveAllBtn=document.getElementById('inv-asset-save-all');
    const refreshBtn=document.getElementById('inv-refresh-prices-btn');
    const modalRefreshBtn=document.getElementById('inv-asset-refresh-prices');
    if(addRowBtn&&!addRowBtn._bound){addRowBtn._bound=true;addRowBtn.onclick=addBlankAssetRow;}
    if(addGroupBtn&&!addGroupBtn._bound){
      addGroupBtn._bound=true;
      addGroupBtn.onclick=()=>{
        const name=prompt('Nazwa nowej grupy:');
        if(!name) return;
        addInvestmentGroup(name);
        document.querySelectorAll('.inv-asset-group').forEach(sel=>populateAssetGroupSelect(sel,sel.value||name));
        fillInvestmentAssetSelects();
      };
    }
    if(saveAllBtn&&!saveAllBtn._bound){saveAllBtn._bound=true;saveAllBtn.onclick=saveAllAssetRows;}
    if(refreshBtn&&!refreshBtn._bound){refreshBtn._bound=true;refreshBtn.onclick=refreshInvestmentPrices;}
    if(modalRefreshBtn&&!modalRefreshBtn._bound){modalRefreshBtn._bound=true;modalRefreshBtn.onclick=refreshInvestmentPrices;}
    renderAssetManagerList(data.assets,data.trades);

    // Buy form
    const buyForm=document.getElementById('inv-buy-form');
    if(buyForm&&!buyForm._bound){
      buyForm._bound=true;
      const srcSel=buyForm.querySelector('select[name="fundSource"]');
      const footnote=document.getElementById('inv-buy-footnote');
      if(srcSel){
        srcSel.onchange=()=>{
          if(footnote) footnote.textContent=srcSel.value==='reinvest'?'Źródło: pula reinwestycyjna — jeśli kwota przekroczy pulę, reszta zostanie pobrana z budżetu.':'Źródło: budżet — kwota zostanie zaksięgowana jako inwestycja.';
        };
      }
      buyForm.onsubmit=e=>{
        e.preventDefault();
        const f=new FormData(buyForm);
        const assetId=String(f.get('assetId'));
        const asset=data.assets.find(a=>a.id===assetId);
        if(!asset){alert('Dodaj najpierw aktywo.');return;}
        const date=f.get('date')||new Date().toISOString().slice(0,10);
        const amount=Math.abs(num(f.get('amount')));
        const quantity=num(f.get('quantity'));
        const note=String(f.get('note')||'');
        const fundSource=f.get('fundSource')||'budget';
        if(amount<=0||quantity<=0){alert('Kwota i ilość muszą być > 0.');return;}
        const pricePerUnit=amount/quantity;
        if(fundSource==='reinvest'){
          const pool=computePortfolioStats().reinvestPool;
          if(pool<0.01){alert('Pula reinwestycyjna jest pusta — zakup zostanie zaksięgowany z budżetu.');
            // fallthrough to full budget buy below
            const catId=ensureInvestmentCategory();
            const txId=`tx_${Math.random().toString(36).slice(2)}`;
            b().transactions.unshift({id:txId,date,amount:signFor(catId,amount),categoryId:catId,accountId:b().accounts[0]?.id||'a_main',note:`Inwestycja: ${asset.name}${note?` (${note})`:''}`});
            data.trades.unshift({id:'inv_trade_'+Math.random().toString(36).slice(2),assetId,date,side:'buy',amount,quantity,note,txId,fundSource:'budget'});
          } else if(amount<=pool+0.01){
            // full reinvest buy
            data.trades.unshift({id:'inv_trade_'+Math.random().toString(36).slice(2),assetId,date,side:'buy',amount,quantity,note,txId:null,fundSource:'reinvest'});
          } else {
            // split: part from pool, rest from budget
            const fromPool=Math.min(pool,amount);
            const fromBudget=amount-fromPool;
            const qtyPool=fromPool/pricePerUnit;
            const qtyBudget=quantity-qtyPool;
            // reinvest portion (no budget tx)
            data.trades.unshift({id:'inv_trade_'+Math.random().toString(36).slice(2),assetId,date,side:'buy',amount:fromPool,quantity:qtyPool,note:note?note+' [reinwest.]':'[reinwest.]',txId:null,fundSource:'reinvest'});
            // budget portion (with budget tx)
            const catId=ensureInvestmentCategory();
            const txId=`tx_${Math.random().toString(36).slice(2)}`;
            b().transactions.unshift({id:txId,date,amount:signFor(catId,fromBudget),categoryId:catId,accountId:b().accounts[0]?.id||'a_main',note:`Inwestycja: ${asset.name}${note?` (${note})`:''} [dopłata z budżetu]`});
            data.trades.unshift({id:'inv_trade_'+Math.random().toString(36).slice(2),assetId,date,side:'buy',amount:fromBudget,quantity:qtyBudget,note:note?note+' [z budżetu]':'[z budżetu]',txId,fundSource:'budget'});
          }
        } else {
          const catId=ensureInvestmentCategory();
          const txId=`tx_${Math.random().toString(36).slice(2)}`;
          b().transactions.unshift({id:txId,date,amount:signFor(catId,amount),categoryId:catId,accountId:b().accounts[0]?.id||'a_main',note:`Inwestycja: ${asset.name}${note?` (${note})`:''}`});
          data.trades.unshift({id:'inv_trade_'+Math.random().toString(36).slice(2),assetId,date,side:'buy',amount,quantity,note,txId,fundSource:'budget'});
        }
        save(state);buyForm.reset();
        const di=buyForm.querySelector('input[name="date"]');if(di) di.value=new Date().toISOString().slice(0,10);
        renderAll();
      };
    }

    // Sell form
    const sellForm=document.getElementById('inv-sell-form');
    if(sellForm&&!sellForm._bound){
      sellForm._bound=true;
      const qtyInput=sellForm.querySelector('input[name="quantity"]');
      const ppuInput=sellForm.querySelector('input[name="pricePerUnit"]');
      const assetSel=sellForm.querySelector('select[name="assetId"]');
      [qtyInput,ppuInput,assetSel].forEach(el=>{if(el) el.addEventListener('input',updateSellPreview);});
      if(assetSel) assetSel.addEventListener('change',updateSellPreview);
      const sellAllBtn=document.getElementById('inv-sell-all-btn');
      if(sellAllBtn){
        sellAllBtn.onclick=()=>{
          const aid=assetSel?.value;
          if(!aid) return;
          const {availableQty}=computeSellCostBasis(aid,0);
          if(qtyInput&&availableQty>0) qtyInput.value=availableQty;
          updateSellPreview();
        };
      }
      sellForm.onsubmit=e=>{
        e.preventDefault();
        const f=new FormData(sellForm);
        const assetId=String(f.get('assetId'));
        const asset=data.assets.find(a=>a.id===assetId);
        if(!asset){alert('Wybierz aktywo.');return;}
        const date=f.get('date')||new Date().toISOString().slice(0,10);
        const quantity=num(f.get('quantity'));
        const pricePerUnit=num(f.get('pricePerUnit'));
        const note=String(f.get('note')||'');
        const sellDestination=f.get('sellDestination')||'reinvest';
        if(quantity<=0||pricePerUnit<=0){alert('Ilość i cena muszą być > 0.');return;}
        const {costBasis,availableQty}=computeSellCostBasis(assetId,quantity);
        if(quantity>availableQty+0.000001){alert(`Posiadasz tylko ${availableQty.toFixed(4)} szt.`);return;}
        const proceeds=quantity*pricePerUnit;
        const realizedPnl=proceeds-costBasis;
        let txId=null;
        if(sellDestination==='budget'){
          const catId=ensureInvestmentCategory();
          txId=`tx_${Math.random().toString(36).slice(2)}`;
          b().transactions.unshift({id:txId,date,amount:-Math.abs(proceeds),categoryId:catId,accountId:b().accounts[0]?.id||'a_main',note:`Sprzedaż inwestycji: ${asset.name}${note?` (${note})`:''} → budżet`});
        }
        // Update asset price to last sell price
        asset.currentPrice=pricePerUnit;
        asset.priceDate=date;
        data.trades.unshift({id:'inv_trade_'+Math.random().toString(36).slice(2),assetId,date,side:'sell',amount:proceeds,quantity,note,txId,sellDestination,realizedPnl});
        save(state);sellForm.reset();
        const di=sellForm.querySelector('input[name="date"]');if(di) di.value=new Date().toISOString().slice(0,10);
        renderAll();
      };
    }

    fillInvestmentAssetSelects();
    const buyDate=document.querySelector('#inv-buy-form input[name="date"]');
    if(buyDate&&!buyDate.value) buyDate.value=new Date().toISOString().slice(0,10);
    const sellDate=document.querySelector('#inv-sell-form input[name="date"]');
    if(sellDate&&!sellDate.value) sellDate.value=new Date().toISOString().slice(0,10);

    // Compute & render
    const stats=computePortfolioStats();
    renderInvDashboardKpis(stats);
    renderInvHoldingsTable(stats.holdings,stats);
    renderInvGroupSummary(stats.holdings,data.trades);
    renderInvTradeHistory();
    renderInvCapitalChart(data.trades,data.assets);
    renderInvCumulativeChart(data.trades,data.assets);
    renderInvAllocations(stats.holdings);
    renderInvPnlChart(data.trades,data.assets);
    bindInvHub();
    renderInvHub();
    bindMoneyInputs(document.getElementById('tab-investments'));
  }

  // --- Categories -------------------------------------------------------------
  function renderCategories(){
    const tbody=document.getElementById('cat-rows');tbody.innerHTML='';
    const emptyInfo=document.getElementById('cat-empty');
    const ym=b().workingMonth; const cats=b().categories||[];
    emptyInfo.style.display = cats.length===0 ? 'block' : 'none';

    const entries=entriesForMonth(ym);
    const spending={};
    for(const e of entries){
      const catId=e.categoryId; const c=cats.find(c=>c.id===catId);
      if(c && c.type==='expense'){spending[catId]=(spending[catId]||0)+Math.abs(e.amount)}
    }
    for(const c of cats){
      const spent=spending[c.id]||0; const budget=num(c.budget); let status='—';
      if(c.type==='expense' && budget>0){
        const pct=(spent/budget)*100;
        if(pct>100) status=`<span class="bad">${pct.toFixed(0)}% (przekroczenie)</span>`;
        else if(pct>80) status=`<span class="warn">${pct.toFixed(0)}%</span>`;
        else status=`<span class="ok">${pct.toFixed(0)}%</span>`;
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.emoji||''}</td><td>${c.name}</td><td>${c.type}</td><td>${budget>0?fmt(budget,state.currency):'—'}</td><td>${fmt(spent,state.currency)}</td><td>${status}</td><td><button class="btn danger">Usuń</button></td>`;
      tr.querySelector('.btn').onclick=()=>{
        if(c.id==='c_fixed'){alert('Nie można usunąć kategorii „Wydatki stałe”.'); return;}
        if(!confirm('Usunąć kategorię?')) return;
        b().categories=b().categories.filter(x=>x.id!==c.id && x.id!=='c_fixed'); save(state); renderAll()
      };
      tbody.appendChild(tr);
    }
  }

  // --- EOM --------------------------------------------------------------------
  function destroyEomChart(key){
    if(eomCharts[key]){
      eomCharts[key].destroy();
      delete eomCharts[key];
    }
  }

  function sumBalances(map){
    return Object.values(map || {}).reduce((sum, val) => sum + (Number(val) || 0), 0);
  }

  const MONTH_NAMES_PL=['styczeń','luty','marzec','kwiecień','maj','czerwiec','lipiec','sierpień','wrzesień','październik','listopad','grudzień'];

  function formatMonthLabel(ym){
    if(!ym || typeof ym!=='string') return ym || '—';
    const parts=ym.split('-');
    if(parts.length!==2) return ym;
    const [year,month]=parts;
    const idx=Number(month)-1;
    const name=MONTH_NAMES_PL[idx] || month;
    return `${name} ${year}`;
  }

  function buildEomContext(){
    const accounts = b().accounts || [];
    const entries = (b().eom || []).map(entry => ({
      ym: String(entry.ym),
      accountId: entry.accountId,
      balance: num(entry.balance)
    })).filter(entry => entry.ym && entry.accountId);

    const monthBalances = {};
    const accountHistory = {};

    for(const entry of entries){
      if(!monthBalances[entry.ym]) monthBalances[entry.ym] = {};
      monthBalances[entry.ym][entry.accountId] = entry.balance;
      if(!accountHistory[entry.accountId]) accountHistory[entry.accountId] = [];
      accountHistory[entry.accountId].push({ ym: entry.ym, balance: entry.balance });
    }

    Object.values(accountHistory).forEach(hist => hist.sort((a,b) => a.ym.localeCompare(b.ym)));

    const months = Object.keys(monthBalances).sort();
    const workingYm = b().workingMonth;
    const workingBalances = monthBalances[workingYm] || {};
    const hasWorking = Object.keys(workingBalances).length > 0;
    const latestMonth = months.length ? months[months.length - 1] : null;
    const focusMonth = hasWorking ? workingYm : latestMonth;
    const focusPrevMonth = focusMonth ? months.filter(m => m < focusMonth).pop() || null : null;
    const focusBalances = focusMonth ? (monthBalances[focusMonth] || {}) : {};
    const focusPrevBalances = focusPrevMonth ? (monthBalances[focusPrevMonth] || {}) : {};
    const netWorthByMonth = months.map(ym => ({ ym, total: sumBalances(monthBalances[ym]) }));

    return {
      accounts,
      accountHistory,
      monthBalances,
      months,
      workingYm,
      workingBalances,
      hasWorking,
      latestMonth,
      focusMonth,
      focusPrevMonth,
      focusBalances,
      focusPrevBalances,
      netWorthByMonth
    };
  }

  const EOM_SCENARIOS = {
    actual:{ label:'Realny', description:'Bez dodatkowych założeń.' },
    optimistic:{ label:'Optymistyczny', description:'Aktywa +5%, zobowiązania -5%.' },
    stress:{ label:'Stresowy', description:'Aktywa -8%, zobowiązania +12%.' }
  };

  function capitalizeFirst(text){
    if(!text) return '';
    return text.charAt(0).toUpperCase() + text.slice(1);
  }

  function inferAccountType(acc){
    if(acc?.kind) return acc.kind;
    if(acc?.type) return acc.type;
    const name = (acc?.name || '').toLowerCase();
    if(/oszcz|saver|lokata|konto oszcz/.test(name)) return 'oszczędności';
    if(/inwest|broker|etf|akcje/.test(name)) return 'inwestycje';
    if(/karta|credit|zadłuż|dług|loan|kredyt/.test(name)) return 'zadłużenie';
    if(/gotówk|cash|portfel/.test(name)) return 'gotówka';
    if(/emeryt|ike|ikze/.test(name)) return 'emerytura';
    return 'inne';
  }

  const EOM_ACCOUNT_TYPE_OPTIONS = [
    { value:'oszczędności', label:'Oszczędności' },
    { value:'inwestycje', label:'Inwestycje' },
    { value:'zadłużenie', label:'Zadłużenie' },
    { value:'gotówka', label:'Gotówka' },
    { value:'emerytura', label:'Emerytura' },
    { value:'inne', label:'Inne' }
  ];
  const EOM_ACCOUNT_TYPE_AUTO = '__auto__';
  const EOM_ACCOUNT_TYPE_ALL = '__all__';

  function getAccountTypeOptions(accounts){
    const base = new Map(EOM_ACCOUNT_TYPE_OPTIONS.map(opt => [opt.value, opt]));
    (accounts || []).forEach(acc => {
      const type = inferAccountType(acc);
      if(type && !base.has(type)){
        base.set(type, { value: type, label: capitalizeFirst(type) });
      }
    });
    return Array.from(base.values());
  }

  function eomAccountStatus(balance){
    if(balance === null || balance === undefined) return 'neutralne';
    return balance >= 0 ? 'aktywa' : 'zobowiązania';
  }

  function scenarioMultiplier(scenario, balance){
    switch(scenario){
      case 'optimistic':
        return balance >= 0 ? 1.05 : 0.95;
      case 'stress':
        return balance >= 0 ? 0.92 : 1.12;
      default:
        return 1;
    }
  }

  function applyScenarioToValue(value, scenario){
    if(value === null || value === undefined) return value === null ? null : undefined;
    const mult = scenarioMultiplier(scenario, value);
    const adjusted = Number((value * mult).toFixed(2));
    return adjusted;
  }

  function normalizeYmRange(range){
    if(!range) return { from:null, to:null };
    const from = range.from && /^\d{4}-\d{2}$/.test(range.from) ? range.from : null;
    const to = range.to && /^\d{4}-\d{2}$/.test(range.to) ? range.to : null;
    if(from && to && from > to){
      return { from: to, to: from };
    }
    return { from, to };
  }

  function getMonthsWithinRange(months, range){
    const { from, to } = normalizeYmRange(range || {});
    return months.filter(ym => {
      if(from && ym < from) return false;
      if(to && ym > to) return false;
      return true;
    });
  }

  function buildSparklinePoints(history, months){
    if(!history || !history.length) return [];
    const set = new Set(months);
    const filtered = history.filter(item => set.size === 0 || set.has(item.ym));
    return filtered.map(item => ({ ym:item.ym, value:item.balance }));
  }

  function renderSparkline(canvas, points, options={}){
    if(!canvas || !points.length){
      if(canvas){
        const ctx2d = canvas.getContext('2d');
        if(ctx2d){
          const width = canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);
          const height = canvas.height = canvas.clientHeight * (window.devicePixelRatio || 1);
          ctx2d.clearRect(0,0,width,height);
        }
      }
      return;
    }
    const ctx2d = canvas.getContext('2d');
    const width = canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);
    const height = canvas.height = canvas.clientHeight * (window.devicePixelRatio || 1);
    ctx2d.clearRect(0,0,width,height);
    const values = points.map(p => p.value);
    const min = Math.min(...values);
    const max = Math.max(...values);
    const range = max - min || 1;
    const step = width / Math.max(points.length - 1, 1);
    const color = options.color || '#2563eb';
    const fill = options.fill !== undefined ? options.fill : 'rgba(37, 99, 235, 0.18)';
    const lineWidth = (options.lineWidth ?? 2) * (window.devicePixelRatio || 1);
    ctx2d.lineWidth = lineWidth;
    ctx2d.strokeStyle = color;
    ctx2d.beginPath();
    points.forEach((pt, idx) => {
      const x = idx * step;
      const y = height - ((pt.value - min) / range) * height;
      if(idx === 0) ctx2d.moveTo(x, y);
      else ctx2d.lineTo(x, y);
    });
    ctx2d.stroke();
    if(fill){
      ctx2d.fillStyle = fill;
      ctx2d.lineTo(width, height);
      ctx2d.lineTo(0, height);
      ctx2d.closePath();
      ctx2d.fill();
    }
  }

  function monthsForSparkline(ctx, range){
    const months = getMonthsWithinRange(ctx.months, range);
    return months.length ? months : ctx.months.slice(-6);
  }

  function renderEomAccountTypeConfigurator(ctx){
    const container = document.getElementById('eom-account-config');
    if(!container) return;
    const accounts = ctx.accounts || [];
    const options = getAccountTypeOptions(accounts);
    if(!accounts.length){
      container.innerHTML = '<div class="muted tiny">Dodaj konto, aby przypisać typy.</div>';
      return;
    }
    const rows = accounts.map(acc => {
      const configuredType = acc.type || acc.kind || '';
      const effectiveType = inferAccountType(acc);
      const hint = configuredType
        ? `Ustawione: ${capitalizeFirst(configuredType)}`
        : `Automatycznie: ${capitalizeFirst(effectiveType)}`;
      const optionsHtml = [
        `<option value="${EOM_ACCOUNT_TYPE_AUTO}" ${configuredType ? '' : 'selected'}>Automatycznie (z nazwy)</option>`,
        ...options.map(opt => `<option value="${opt.value}" ${opt.value === configuredType ? 'selected' : ''}>${opt.label}</option>`)
      ].join('');
      return `
        <tr>
          <td><strong>${acc.name}</strong><div class="tiny muted">${hint}</div></td>
          <td><select data-account-type="${acc.id}">${optionsHtml}</select></td>
        </tr>
      `;
    }).join('');
    container.innerHTML = `
      <div class="eom-account-config-header">
        <div>
          <div class="title" style="margin:0">Konfigurator typów kont</div>
          <div class="tiny muted">Przypisz konta do kategorii (oszczędności, inwestycje itd.), aby raporty EoM były dokładniejsze.</div>
        </div>
      </div>
      <table>
        <thead><tr><th>Konto</th><th>Typ konta</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    container.querySelectorAll('select[data-account-type]').forEach(select => {
      select.addEventListener('change', () => {
        const accountId = select.dataset.accountType;
        const value = select.value;
        const acc = (b().accounts || []).find(item => item.id === accountId);
        if(!acc) return;
        if(value === EOM_ACCOUNT_TYPE_AUTO){
          delete acc.type;
          delete acc.kind;
        } else {
          acc.type = value;
          delete acc.kind;
        }
        save(state);
        renderEOM();
        renderEOMHistory();
      });
    });
  }

  function renderEomInteractiveGrid(ctx, rows, options={}){
    const container = document.getElementById('eom-grid');
    if(!container) return { inputs:[], refreshSparklines:()=>{} };
    container.innerHTML = '';
    container.className = 'eom-grid-shell';

    const totalAccounts = (ctx.accounts || []).length;
    const countEl = document.getElementById('eom-account-count');
    if(countEl){
      const visible = rows.length;
      countEl.textContent = totalAccounts
        ? `Pokazujesz ${visible} z ${totalAccounts} kont`
        : `Pokazujesz ${visible} kont`;
    }

    if(!rows.length){
      container.innerHTML = '<div class="eom-grid-empty">Brak kont spełniających kryteria. Dodaj nowe konto lub zmień filtry.</div>';
      return { inputs:[], refreshSparklines:()=>{} };
    }

    const sortKey = eomUiState.accountSort || 'balance';
    const sortedRows = [...rows];
    sortedRows.sort((a,b) => {
      switch(sortKey){
        case 'name':
          return a.acc.name.localeCompare(b.acc.name, 'pl', { sensitivity:'base' });
        case 'change-up':
          return ((b.deltaPct ?? -Infinity) - (a.deltaPct ?? -Infinity));
        case 'change-down':
          return ((a.deltaPct ?? Infinity) - (b.deltaPct ?? Infinity));
        case 'balance':
        default:
          return ((b.adjustedCurrent ?? b.currentValue ?? 0) - (a.adjustedCurrent ?? a.currentValue ?? 0));
      }
    });

    const expandedSet = new Set(Array.isArray(eomUiState.expandedAccounts) ? eomUiState.expandedAccounts : []);
    const focusId = options.focusedAccountId || null;

    const prioritySet = (() => {
      const ranked = [...sortedRows]
        .filter(row => Number.isFinite(row.deltaAdjusted) && Math.abs(row.deltaAdjusted || 0) >= 0.005)
        .sort((a,b) => Math.abs((b.deltaAdjusted ?? 0)) - Math.abs((a.deltaAdjusted ?? 0)));
      return new Set(ranked.slice(0, Math.min(3, ranked.length)).map(row => row.acc.id));
    })();

    const accordion = document.createElement('div');
    accordion.className = 'eom-account-accordion';
    container.appendChild(accordion);

    const inputs = [];
    const sparkTargets = [];

    sortedRows.forEach(row => {
      const isExpanded = expandedSet.has(row.acc.id);
      const card = document.createElement('article');
      card.className = 'eom-account-item';
      if(prioritySet.has(row.acc.id)) card.classList.add('is-priority');
      if(Number.isFinite(row.adjustedCurrent) && row.adjustedCurrent < 0) card.classList.add('is-debt');
      if(row.isDormant) card.classList.add('is-dormant');
      if(focusId && focusId === row.acc.id) card.classList.add('is-focused');
      if(isExpanded) card.classList.add('is-expanded');
      card.dataset.accountId = row.acc.id;
      card.title = `${row.acc.name}: ${row.displayBalance}${row.deltaDisplay && row.deltaDisplay !== '—' ? ` | Δ ${row.deltaDisplay}` : ''}`;

      const trendTone = row.trendDirection === 'up' ? 'up' : row.trendDirection === 'down' ? 'down' : 'flat';
      const deltaTone = row.trendDirection === 'up' ? 'positive' : row.trendDirection === 'down' ? 'negative' : 'neutral';
      const deltaText = row.deltaPctDisplay && row.deltaPctDisplay !== '—'
        ? `${row.deltaDisplay} <span class="tiny muted">(${row.deltaPctDisplay})</span>`
        : row.deltaDisplay;

      const headerBtn = document.createElement('button');
      headerBtn.type = 'button';
      headerBtn.className = 'eom-account-header';
      headerBtn.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
      headerBtn.innerHTML = `
        <div class="eom-account-title">
          <strong>${row.acc.name}</strong>
          <span>${row.subtitle}</span>
        </div>
        <div class="eom-account-balance" data-balance="${row.acc.id}">${row.displayBalance}</div>
        <div class="eom-account-trend ${trendTone}" data-delta="${row.acc.id}" data-role="header">
          <span class="arrow ${trendTone}">${row.trendArrow}</span>
          <span>${deltaText}</span>
        </div>
        <span class="eom-account-toggle-icon">${isExpanded ? '▲' : '▼'}</span>
      `;
      card.appendChild(headerBtn);

      const body = document.createElement('div');
      body.className = 'eom-account-body';
      const recordDisplay = row.recordEntry ? fmt(row.recordEntry.value, state.currency) : '—';
      const recordDate = row.recordEntry?.ym || '—';
      const minDisplay = row.minEntry ? fmt(row.minEntry.value, state.currency) : '—';
      const minDate = row.minEntry?.ym || '—';
      const avgDisplay = row.averageSix !== null && row.averageSix !== undefined ? fmt(row.averageSix, state.currency) : '—';
      const rangeHint = row.sparklinePoints.length
        ? `Zakres danych: ${row.sparklinePoints[0].ym} → ${row.sparklinePoints[row.sparklinePoints.length - 1].ym}`
        : 'Brak danych historycznych w wybranym zakresie.';
      body.innerHTML = `
        <div class="eom-account-body-inner">
          <div>
            <div class="eom-account-spark-large">
              <canvas data-big-spark="${row.acc.id}"></canvas>
            </div>
            <div class="tiny muted">${rangeHint}</div>
            <div class="eom-account-stats">
              <div><span>Rekord</span><strong>${recordDisplay}</strong><span>${recordDate}</span></div>
              <div><span>Najniższa</span><strong>${minDisplay}</strong><span>${minDate}</span></div>
              <div><span>Średnia (6M)</span><strong>${avgDisplay}</strong><span>${row.sparklinePoints.length >= 6 ? 'Ostatnie 6 miesięcy' : 'Wszystkie dostępne'}</span></div>
            </div>
          </div>
          <div>
            <div class="eom-account-change">
              <div class="delta ${deltaTone}" data-delta="${row.acc.id}" data-role="detail">${row.deltaDisplay}${row.deltaPctDisplay && row.deltaPctDisplay !== '—' ? ` (${row.deltaPctDisplay})` : ''}</div>
              <div class="tiny muted">Poprzedni miesiąc: ${row.previousDisplay}</div>
              <p class="tiny">${row.trendDescription}</p>
            </div>
            <div class="eom-account-actions">
              <label class="tiny" for="eom-input-${row.acc.id}">Aktualizuj saldo</label>
              <input id="eom-input-${row.acc.id}" inputmode="decimal" data-id="${row.acc.id}" value="${row.currentInput}" placeholder="0,00" />
              <button class="btn ghost" type="button" data-drill="${row.acc.id}">Historia</button>
              <button class="btn danger" type="button" data-del="${row.acc.id}">Usuń</button>
            </div>
          </div>
        </div>
      `;
      card.appendChild(body);
      accordion.appendChild(card);

      const input = body.querySelector('input[data-id]');
      if(input) inputs.push(input);
      const sparkCanvas = body.querySelector('canvas[data-big-spark]');
      if(sparkCanvas){
        sparkTargets.push({ canvas: sparkCanvas, row });
      }

      if(isExpanded){
        requestAnimationFrame(() => {
          body.style.maxHeight = `${body.scrollHeight}px`;
        });
      } else {
        body.style.maxHeight = '0px';
      }
    });

    if(!accordion.dataset.bound){
      accordion.dataset.bound = '1';
      accordion.addEventListener('click', event => {
        const header = event.target.closest('.eom-account-header');
        if(!header || !accordion.contains(header)) return;
        const card = header.closest('.eom-account-item');
        if(!card) return;
        const body = card.querySelector('.eom-account-body');
        const accountId = card.dataset.accountId;
        const isExpanded = card.classList.toggle('is-expanded');
        header.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
        const icon = header.querySelector('.eom-account-toggle-icon');
        if(icon) icon.textContent = isExpanded ? '▲' : '▼';
        const nextSet = new Set(Array.isArray(eomUiState.expandedAccounts) ? eomUiState.expandedAccounts : []);
        if(isExpanded) nextSet.add(accountId); else nextSet.delete(accountId);
        eomUiState.expandedAccounts = Array.from(nextSet);
        if(body){
          if(isExpanded){
            body.style.maxHeight = `${body.scrollHeight}px`;
          } else {
            body.style.maxHeight = '0px';
          }
        }
      });
    }

    return {
      inputs,
      refreshSparklines(){
        sparkTargets.forEach(target => {
          const color = target.row?.sparkColor || '#2563eb';
          const points = target.row?.sparklinePoints || [];
          renderSparkline(target.canvas, points, { color, fill: withAlpha(color, 0.16) });
        });
      }
    };
  }

  function renderEomPivotTable(ctx, rows, months, scenario='actual'){
    const container = document.getElementById('eom-grid');
    if(!container) return { inputs:[], refreshSparklines:()=>{} };
    container.innerHTML = '';
    const countEl = document.getElementById('eom-account-count');
    if(countEl){
      const totalAccounts = (ctx.accounts || []).length;
      const visible = rows.length;
      countEl.textContent = totalAccounts
        ? `Pokazujesz ${visible} z ${totalAccounts} kont`
        : `Pokazujesz ${visible} kont`;
    }
    if(!rows.length){
      container.innerHTML = '<div class="eom-grid-empty">Brak danych do zbudowania tabeli przestawnej.</div>';
      return { inputs:[], refreshSparklines:()=>{} };
    }
    const table = document.createElement('table');
    table.className = 'eom-pivot-table';
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');
    table.appendChild(thead);
    table.appendChild(tbody);
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = '<th>Konto</th>' + months.map(m => `<th>${m}</th>`).join('') + '<th>Mediana</th><th>Rekord</th>';
    thead.appendChild(headerRow);
    const medians = [];
    rows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.acc.name}</td>` + months.map(m => {
        const entry = row.history.find(item => item.ym === m);
        const adjusted = entry ? applyScenarioToValue(entry.balance, scenario) : null;
        return `<td>${adjusted === null ? '<span class="muted">—</span>' : fmt(adjusted, state.currency)}</td>`;
      }).join('');
      const values = row.history
        .filter(item => months.includes(item.ym))
        .map(item => applyScenarioToValue(item.balance, scenario))
        .filter(val => typeof val === 'number');
      values.sort((a,b)=>a-b);
      const median = values.length ? values[Math.floor(values.length/2)] : null;
      const record = values.length ? (row.deltaAdjusted >= 0 ? Math.max(...values) : Math.min(...values)) : null;
      tr.innerHTML += `<td>${median === null ? '<span class="muted">—</span>' : fmt(median, state.currency)}</td>`;
      tr.innerHTML += `<td>${record === null ? '<span class="muted">—</span>' : fmt(record, state.currency)}</td>`;
      tbody.appendChild(tr);
      medians.push({ account: row.acc, median, record });
    });
    container.appendChild(table);
    return { inputs:[], refreshSparklines:()=>{} };
  }

  function renderEomHeatmap(ctx, rows, months, scenario='actual'){
    const container = document.getElementById('eom-heatmap');
    if(!container) return;
    container.innerHTML = '';
    if(!rows.length || !months.length){
      container.innerHTML = '<div class="muted tiny">Heatmapa pojawi się, gdy zapiszesz co najmniej dwa miesiące danych.</div>';
      return;
    }
    const grid = document.createElement('div');
    grid.className = 'eom-heatmap-grid';
    const flat = [];
    rows.forEach(row => {
      months.forEach(m => {
        const entry = row.history.find(item => item.ym === m);
        if(entry){
          const adjusted = applyScenarioToValue(entry.balance, scenario) ?? 0;
          flat.push(Math.abs(adjusted));
        }
      });
    });
    const max = flat.length ? Math.max(...flat) : 0;
    rows.forEach(row => {
      const cell = document.createElement('div');
      cell.className = 'eom-heatmap-cell';
      cell.innerHTML = `<strong>${row.acc.name}</strong>`;
      months.forEach(m => {
        const entry = row.history.find(item => item.ym === m);
        const val = entry ? applyScenarioToValue(entry.balance, scenario) : null;
        const pct = max ? Math.abs(val || 0)/max : 0;
        const color = val === null ? 'transparent' : `rgba(59, 130, 246, ${0.15 + pct*0.6})`;
        const badge = document.createElement('div');
        badge.style.background = color;
        badge.style.borderRadius = '8px';
        badge.style.padding = '4px 6px';
        badge.style.fontVariantNumeric = 'tabular-nums';
        badge.innerHTML = val === null ? '<span class="muted">—</span>' : fmt(val, state.currency);
        badge.title = `${row.acc.name} — ${m}`;
        cell.appendChild(badge);
      });
      grid.appendChild(cell);
    });
    const scale = document.createElement('div');
    scale.className = 'eom-heatmap-scale';
    scale.innerHTML = '<span></span><span></span><span></span><span></span><span></span> Intensywność zmian';
    container.appendChild(grid);
    container.appendChild(scale);
  }

  function entryForMonth(history, ym){
    if(!history) return null;
    return history.find(item => item.ym === ym) || null;
  }

  function lastEntryBefore(history, ym){
    if(!history) return null;
    let prev = null;
    for(const item of history){
      if(item.ym < ym){
        prev = item;
      } else if(item.ym >= ym){
        break;
      }
    }
    return prev;
  }

  function computeAccountStatsForMonth(ctx, targetMonth, options={}){
    if(!targetMonth) return [];
    const { accounts, accountHistory } = ctx;
    const scenario = options.scenario || 'actual';
    const allowedTypes = Array.isArray(options.accountTypes) && options.accountTypes.length ? options.accountTypes : null;
    return accounts.map(acc => {
      const type = inferAccountType(acc);
      if(allowedTypes && !allowedTypes.includes(type)) return null;
      const history = accountHistory[acc.id] || [];
      const historyUpTo = history.filter(item => item.ym <= targetMonth);
      if(historyUpTo.length === 0) return null;
      const currentEntry = entryForMonth(history, targetMonth);
      const prevEntry = lastEntryBefore(history, targetMonth);
      const baseCurrent = currentEntry ? currentEntry.balance : null;
      const basePrevious = prevEntry ? prevEntry.balance : null;
      const current = baseCurrent === null ? null : applyScenarioToValue(baseCurrent, scenario);
      const previous = basePrevious === null ? null : applyScenarioToValue(basePrevious, scenario);
      const hasAny = current !== null || previous !== null;
      const delta = hasAny ? ((current ?? 0) - (previous ?? 0)) : null;
      const deltaPct = previous && previous !== 0 ? (delta / Math.abs(previous)) * 100 : null;
      const lastThree = historyUpTo.slice(-3).map(item => applyScenarioToValue(item.balance, scenario));
      const avg3 = lastThree.length ? lastThree.reduce((sum, val) => sum + val, 0) / lastThree.length : null;
      const trendVsAvg = current !== null && avg3 !== null ? current - avg3 : null;
      const maxEntry = historyUpTo.reduce((max, item) => !max || item.balance > max.balance ? item : max, null);
      const minEntry = historyUpTo.reduce((min, item) => !min || item.balance < min.balance ? item : min, null);
      return {
        account: acc,
        type,
        status: eomAccountStatus(current ?? previous ?? 0),
        current,
        currentYm: currentEntry?.ym || targetMonth,
        previous,
        previousYm: prevEntry?.ym || null,
        delta,
        deltaPct,
        avg3,
        trendVsAvg,
        maxEntry,
        minEntry,
        baseCurrent,
        basePrevious,
        scenario,
        history
      };
    }).filter(Boolean);
  }

  function computeMonthlySummary(ctx, options={}){
    const { months, monthBalances, accounts, accountHistory } = ctx;
    const scenario = options.scenario || 'actual';
    const typeFilter = new Set(Array.isArray(options.accountTypes) ? options.accountTypes : []);
    const relevantAccounts = accounts.filter(acc => typeFilter.size === 0 || typeFilter.has(inferAccountType(acc)));
    return months.map(ym => {
      const balances = monthBalances[ym] || {};
      const prevMonth = months.filter(m => m < ym).pop() || null;
      const prevBalances = prevMonth ? (monthBalances[prevMonth] || {}) : {};
      let positive = 0;
      let negative = 0;
      let prevPositive = 0;
      let prevNegative = 0;
      for(const acc of relevantAccounts){
        const currentVal = balances[acc.id];
        const prevVal = prevBalances[acc.id];
        if(currentVal !== undefined){
          const adjusted = applyScenarioToValue(currentVal, scenario) ?? 0;
          if(adjusted >= 0) positive += adjusted; else negative += adjusted;
        }
        if(prevVal !== undefined){
          const adjustedPrev = applyScenarioToValue(prevVal, scenario) ?? 0;
          if(adjustedPrev >= 0) prevPositive += adjustedPrev; else prevNegative += adjustedPrev;
        }
      }
      const netWorth = positive + negative;
      const prevNetWorth = prevMonth !== null ? (prevPositive + prevNegative) : null;
      const delta = prevNetWorth !== null ? netWorth - prevNetWorth : null;
      const base = positive + Math.abs(negative);
      const debtShare = base ? (Math.abs(negative) / base) * 100 : 0;
      let best = null;
      let worst = null;
      for(const acc of relevantAccounts){
        const history = accountHistory[acc.id] || [];
        if(history.length === 0) continue;
        const currentRaw = entryForMonth(history, ym)?.balance ?? null;
        const prevEntry = lastEntryBefore(history, ym);
        if(currentRaw === null && !prevEntry) continue;
        const current = currentRaw === null ? null : applyScenarioToValue(currentRaw, scenario);
        const prevVal = prevEntry?.balance ?? null;
        const previous = prevVal === null ? null : applyScenarioToValue(prevVal, scenario);
        const deltaAcc = (current ?? 0) - (previous ?? 0);
        if(!best || deltaAcc > best.delta) best = { account: acc, delta: deltaAcc };
        if(!worst || deltaAcc < worst.delta) worst = { account: acc, delta: deltaAcc };
      }
      return { ym, netWorth, delta, positive, negative, debtShare, best, worst };
    });
  }

  function renderDeltaBadge(delta){
    if(delta === null || delta === undefined) return '<span class="delta-neutral">—</span>';
    if(Math.abs(delta) < 0.005) return '<span class="delta-neutral">—</span>';
    const cls = delta > 0 ? 'delta-up' : 'delta-down';
    const sign = delta > 0 ? '+' : '';
    return `<span class="${cls}">${sign}${fmt(delta, state.currency)}</span>`;
  }

  function renderEomKpis(ctx, accountStats){
    const container = document.getElementById('eom-kpis');
    if(!container) return;
    container.innerHTML = '';
    if(!ctx.months.length){
      container.innerHTML = `<div class="muted" style="grid-column:1 / -1;text-align:center;padding:18px;">Dodaj pierwsze salda, aby zobaczyć wskaźniki.</div>`;
      renderEomInsights(ctx, []);
      return;
    }

    const scenario = eomUiState.scenario || 'actual';
    const typeFilter = new Set(eomUiState.accountTypes || []);
    const relevantAccounts = ctx.accounts.filter(acc => typeFilter.size === 0 || typeFilter.has(inferAccountType(acc)));
    if(!relevantAccounts.length){
      container.innerHTML = `<div class="muted" style="grid-column:1 / -1;text-align:center;padding:18px;">Brak kont spełniających filtry — zmień wybór typów kont.</div>`;
      renderEomInsights(ctx, []);
      return;
    }

    const netWorthForMonth = (ym) => {
      if(!ym) return 0;
      const balances = ctx.monthBalances[ym] || {};
      return relevantAccounts.reduce((sum, acc) => {
        const value = balances[acc.id];
        if(value === undefined) return sum;
        const adjusted = applyScenarioToValue(value, scenario);
        return sum + (typeof adjusted === 'number' ? adjusted : 0);
      }, 0);
    };

    const focusMonth = ctx.focusMonth;
    const focusPrevMonth = ctx.focusPrevMonth;
    const netWorth = netWorthForMonth(focusMonth);
    const prevNetWorth = focusPrevMonth ? netWorthForMonth(focusPrevMonth) : null;
    const delta = prevNetWorth !== null ? netWorth - prevNetWorth : null;
    const hasDelta = delta !== null && Math.abs(delta) >= 0.005;
    const deltaPct = hasDelta && prevNetWorth !== 0 ? (delta / (prevNetWorth || 1)) * 100 : null;
    const deltaClass = !hasDelta ? 'neutral' : (delta > 0 ? 'positive' : 'negative');

    const focusLabel = focusMonth
      ? (focusMonth === ctx.workingYm ? `Dane z ${focusMonth}` : `Ostatni zapis: ${focusMonth}`)
      : 'Brak zapisów';

    const balanceBreakdown = relevantAccounts.reduce((acc, account) => {
      const value = ctx.focusBalances[account.id];
      if(value === undefined) return acc;
      const adjusted = applyScenarioToValue(value, scenario);
      if(typeof adjusted !== 'number') return acc;
      if(adjusted >= 0) acc.assets += adjusted; else acc.debt += adjusted;
      return acc;
    }, { assets:0, debt:0 });
    const prevBreakdown = focusPrevMonth ? relevantAccounts.reduce((acc, account) => {
      const value = ctx.focusPrevBalances[account.id];
      if(value === undefined) return acc;
      const adjusted = applyScenarioToValue(value, scenario);
      if(typeof adjusted !== 'number') return acc;
      if(adjusted >= 0) acc.assets += adjusted; else acc.debt += adjusted;
      return acc;
    }, { assets:0, debt:0 }) : null;
    const debtTotal = Math.abs(balanceBreakdown.debt);
    const base = balanceBreakdown.assets + debtTotal;
    const debtShare = base ? (debtTotal / base) * 100 : 0;
    const prevDebtTotal = prevBreakdown ? Math.abs(prevBreakdown.debt) : null;
    const debtDelta = prevDebtTotal !== null ? debtTotal - prevDebtTotal : null;
    const debtDeltaClass = debtDelta === null ? 'neutral' : (debtDelta > 0 ? 'negative' : (debtDelta < 0 ? 'positive' : 'neutral'));

    const record = ctx.months.reduce((best, ym) => {
      const total = netWorthForMonth(ym);
      if(!Number.isFinite(total)) return best;
      if(!best || total > best.total) return { ym, total };
      return best;
    }, null);
    const recordGap = record ? netWorth - record.total : null;
    const recordTrendClass = recordGap === null ? 'neutral' : (recordGap >= 0 ? 'positive' : 'negative');

    const bestAccount = accountStats.filter(row => Number.isFinite(row.delta)).sort((a,b) => (b.delta || 0) - (a.delta || 0))[0];
    const worstAccount = accountStats.filter(row => Number.isFinite(row.delta)).sort((a,b) => (a.delta || 0) - (b.delta || 0))[0];
    const growthInsight = bestAccount && Math.abs(bestAccount.delta || 0) >= 0.005
      ? { text: `Najszybszy wzrost: ${bestAccount.account.name} ${bestAccount.delta > 0 ? '+' : ''}${fmt(bestAccount.delta, state.currency)}`, className: 'positive', icon: '🚀' }
      : null;
    const dragInsight = worstAccount && Math.abs(worstAccount.delta || 0) >= 0.005
      ? { text: `Największy spadek: ${worstAccount.account.name} ${worstAccount.delta > 0 ? '+' : ''}${fmt(worstAccount.delta, state.currency)}`, className: worstAccount.delta < 0 ? 'negative' : 'neutral', icon: '📉' }
      : null;
    const debtShareInsight = debtTotal
      ? { text: `Zadłużenie to ${debtShare.toFixed(1)}% portfela`, className: debtShare > 35 ? 'negative' : 'neutral', icon: debtShare > 35 ? '⚠️' : 'ℹ️' }
      : null;
    const insights = [];
    if(growthInsight) insights.push(growthInsight);
    if(debtShareInsight) insights.push(debtShareInsight);
    if(insights.length < 2 && dragInsight) insights.push(dragInsight);
    if(insights.length === 0 && record){
      insights.push({ text: `Rekord: ${record.ym} ${fmt(record.total, state.currency)}`, className: 'positive', icon: '🏆' });
    }

    const cards = [
      {
        id: 'net-worth',
        target: 'eom-networth-chart',
        primary: true,
        icon: '💼',
        label: 'Majątek netto',
        value: fmt(netWorth, state.currency),
        trend: hasDelta ? { className: deltaClass, text: `${delta > 0 ? '▲' : '▼'} ${fmt(Math.abs(delta), state.currency)}${deltaPct !== null ? ` (${delta > 0 ? '+' : ''}${deltaPct.toFixed(1)}%)` : ''}` } : { className: 'neutral', text: 'Stabilnie m/m' },
        meta: [ `${focusLabel}` ]
      },
      {
        id: 'mom-change',
        target: 'eom-mom',
        primary: false,
        icon: '📈',
        label: 'Zmiana m/m',
        value: hasDelta ? `${delta > 0 ? '+' : ''}${fmt(delta, state.currency)}` : '—',
        trend: hasDelta ? { className: deltaClass, text: `${deltaPct !== null ? `${deltaPct > 0 ? '+' : ''}${deltaPct.toFixed(1)}%` : 'vs poprzedni miesiąc'}` } : { className: 'neutral', text: 'Brak danych historycznych' },
        meta: [ prevNetWorth !== null ? `Poprzedni miesiąc: ${fmt(prevNetWorth, state.currency)}` : 'Czekamy na pierwszy zapis', focusPrevMonth ? `Porównanie z ${focusPrevMonth}` : '' ].filter(Boolean)
      },
      {
        id: 'net-record',
        target: 'eom-accounts-history',
        primary: false,
        icon: '🏆',
        label: 'Rekord historyczny',
        value: record ? fmt(record.total, state.currency) : '—',
        trend: record ? (Math.abs(recordGap || 0) < 0.005
          ? { className: 'positive', text: 'Nowy rekord w tym miesiącu' }
          : { className: recordTrendClass, text: `${recordGap > 0 ? 'Rekord pobity' : 'Do rekordu brakuje'} ${fmt(Math.abs(recordGap), state.currency)}` }
        ) : { className: 'neutral', text: 'Brak historii' },
        meta: [ record ? `Ustanowiony: ${record.ym}` : 'Dodaj więcej miesięcy', record && focusMonth && record.ym !== focusMonth ? `Obecnie: ${fmt(netWorth, state.currency)}` : '' ].filter(Boolean)
      },
      {
        id: 'net-debt',
        target: 'eom-grid',
        primary: false,
        icon: '💳',
        label: 'Zadłużenie',
        value: debtTotal ? `-${fmt(debtTotal, state.currency)}` : '—',
        trend: debtDelta !== null
          ? { className: debtDeltaClass, text: `${debtDelta > 0 ? '▲' : debtDelta < 0 ? '▼' : '●'} ${debtDelta > 0 ? '+' : ''}${fmt(debtDelta, state.currency)}` }
          : { className: 'neutral', text: 'Brak danych historycznych' },
        meta: [ `Stanowi ${debtShare.toFixed(1)}% portfela`, balanceBreakdown.assets ? `Aktywa: ${fmt(balanceBreakdown.assets, state.currency)}` : '' ].filter(Boolean)
      }
    ];

    renderEomInsights(ctx, insights);

    container.innerHTML = cards.map((card, idx) => {
      const trendHtml = card.trend ? `<div class="eom-kpi-trend ${card.trend.className}">${card.trend.text}</div>` : '';
      const metaHtml = card.meta && card.meta.length ? `<div class="eom-kpi-meta">${card.meta.map(line => `<span>${line}</span>`).join('')}</div>` : '';
      return `
        <article class="eom-kpi-card${card.primary ? ' primary' : ''}" data-target="${card.target}" style="--eom-delay:${idx * 80}ms">
          <div class="eom-kpi-icon">${card.icon}</div>
          <span class="eom-kpi-label">${card.label}</span>
          <span class="eom-kpi-value">${card.value}</span>
          ${trendHtml}
          ${metaHtml}
        </article>
      `;
    }).join('');

    requestAnimationFrame(() => {
      container.querySelectorAll('.eom-kpi-card').forEach(card => {
        card.classList.add('is-visible');
        const target = card.getAttribute('data-target');
        if(target && !card.dataset.bound){
          card.dataset.bound = '1';
          card.addEventListener('click', () => {
            const el = document.getElementById(target);
            if(el){
              const panel = el.closest('.eom-dashboard-panel');
              if(panel && panel.dataset.panel){
                updateEomDashboardView(panel.dataset.panel);
              }
              requestAnimationFrame(() => {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
            }
          });
        }
      });
    });
  }

  function renderEomInsights(ctx, insightItems){
    const container = document.getElementById('eom-insights');
    if(!container) return;
    const items = Array.isArray(insightItems)
      ? insightItems.filter(item => item && typeof item.text === 'string' && item.text.trim().length)
      : [];
    if(!ctx.months.length || !items.length){
      container.innerHTML = '';
      return;
    }
    container.innerHTML = items.slice(0, 2).map(item => {
      const cls = item.className === 'negative' ? 'eom-insight-pill negative' : 'eom-insight-pill';
      const icon = item.icon ? `${item.icon} ` : '';
      return `<span class="${cls}">${icon}${item.text}</span>`;
    }).join('');
  }

  function renderEomHistoryTable(ctx, monthsToShow, options={}){
    const table = document.getElementById('eom-accounts-history');
    const footer = document.getElementById('eom-history-footer');
    const scrollShell = document.querySelector('.eom-history-table-scroll');
    const exportBtn = document.getElementById('eom-history-export');
    eomHistoryExportCache = null;
    if(!table) return;
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if(thead) thead.innerHTML = '';
    if(tbody) tbody.innerHTML = '';
    if(footer) footer.innerHTML = '';
    if(scrollShell) scrollShell.scrollTop = 0;
    if(exportBtn) exportBtn.disabled = true;

    const scenario = options.scenario || 'actual';
    const typeFilter = new Set(Array.isArray(options.accountTypes) ? options.accountTypes : []);
    let accounts = ctx.accounts
      .filter(acc => typeFilter.size === 0 || typeFilter.has(inferAccountType(acc)))
      .sort((a, b) => a.name.localeCompare(b.name, 'pl', { sensitivity: 'base' }));
    const searchTerm = (options.search || '').trim().toLowerCase();
    if(searchTerm){
      accounts = accounts.filter(acc => acc.name.toLowerCase().includes(searchTerm));
    }

    const emptyRow = '<tr><td class="muted" style="text-align:center;padding:16px;">Brak danych historycznych do wyświetlenia.</td></tr>';
    if(!monthsToShow.length){
      if(tbody) tbody.innerHTML = emptyRow;
      if(footer) footer.innerHTML = '<span class="muted">Brak danych historycznych. Dodaj transakcje, aby rozpocząć analizę.</span>';
      return;
    }

    if(!accounts.length){
      if(tbody) tbody.innerHTML = '<tr><td class="muted" style="text-align:center;padding:16px;">Brak kont spełniających bieżące filtry lub wyszukiwanie.</td></tr>';
      if(footer) footer.innerHTML = '<span class="muted">Dostosuj filtry, aby zobaczyć dane historyczne.</span>';
      return;
    }

    const chronologicalMonths = [...monthsToShow].sort((a, b) => a.localeCompare(b));
    const initialAccountIds = accounts.map(acc => acc.id);
    let monthRecords = buildHistoryMonthRecords(ctx, chronologicalMonths, initialAccountIds, scenario);
    let accountSummaries = computeHistoryAccountSummaries(monthRecords, initialAccountIds);

    if(options.onlyChanges){
      accounts = accounts.filter(acc => accountSummaries[acc.id]?.hasChange);
    }

    if(!accounts.length){
      if(tbody) tbody.innerHTML = '<tr><td class="muted" style="text-align:center;padding:16px;">Żadne konto nie wykazuje zmian w wybranym zakresie.</td></tr>';
      if(footer) footer.innerHTML = '<span class="muted">Zmień filtr lub zakres, by zobaczyć ruchy na kontach.</span>';
      return;
    }

    const accountIds = accounts.map(acc => acc.id);
    monthRecords = buildHistoryMonthRecords(ctx, chronologicalMonths, accountIds, scenario);
    accountSummaries = computeHistoryAccountSummaries(monthRecords, accountIds);
    const netWorthAverage = computeNetWorthAverage(monthRecords);
    const totalMonths = Number.isFinite(options.totalMonths) ? options.totalMonths : ctx.months.length;
    const sortState = normalizeHistorySort(options.sort, options.transpose);

    if(!table.dataset.historySortBound){
      table.dataset.historySortBound = '1';
      table.addEventListener('click', event => {
        const button = event.target.closest('button[data-sort-key]');
        if(!button) return;
        const key = button.dataset.sortKey;
        if(!key) return;
        const transposeMode = !!eomUiState.historyTranspose;
        const prev = eomUiState.historySort || { key: transposeMode ? 'name' : 'ym', dir: transposeMode ? 'asc' : 'desc' };
        let dir = 'desc';
        if(prev.key === key){
          dir = prev.dir === 'asc' ? 'desc' : 'asc';
        } else if(key === 'name' || key === 'avg'){ dir = 'asc'; }
        else if(key === 'ym'){ dir = 'desc'; }
        else { dir = 'desc'; }
        eomUiState.historySort = { key, dir };
        saveEomUiState();
        renderEOMHistory();
      });
    }

    if(options.transpose){
      renderHistoryTableTransposed({
        thead,
        tbody,
        accounts,
        accountSummaries,
        monthRecords,
        sortState,
        netWorthAverage,
        chronologicalMonths
      });
    } else {
      renderHistoryTableStandard({
        thead,
        tbody,
        accounts,
        accountSummaries,
        monthRecords,
        sortState,
        netWorthAverage
      });
    }

    updateHistoryFooter(footer, monthRecords, netWorthAverage, totalMonths, accounts.length);
    if(exportBtn && eomHistoryExportCache && Array.isArray(eomHistoryExportCache.rows) && eomHistoryExportCache.rows.length){
      exportBtn.disabled = false;
    }
  }

  function normalizeHistorySort(sort, transpose){
    const fallback = transpose ? { key:'name', dir:'asc' } : { key:'ym', dir:'desc' };
    if(!sort || !sort.key) return { ...fallback };
    const dir = sort.dir === 'asc' ? 'asc' : 'desc';
    if(transpose){
      if(sort.key === 'name' || sort.key === 'avg' || sort.key === 'lastChange' || (typeof sort.key === 'string' && sort.key.startsWith('month:'))){
        return { key: sort.key, dir };
      }
      return { ...fallback };
    }
    if(sort.key === 'ym' || sort.key === 'netWorth' || sort.key === 'delta' || (typeof sort.key === 'string' && sort.key.startsWith('acc:'))){
      return { key: sort.key, dir };
    }
    return { ...fallback };
  }

  function buildHistoryMonthRecords(ctx, months, accountIds, scenario){
    return months.map((ym, idx) => {
      const balances = ctx.monthBalances[ym] || {};
      const prevYm = idx > 0 ? months[idx - 1] : null;
      const prevBalances = prevYm ? (ctx.monthBalances[prevYm] || {}) : null;
      const perAccount = {};
      let netWorth = 0;
      let prevNetWorth = prevYm ? 0 : null;
      for(const id of accountIds){
        const currentRaw = balances[id];
        const current = currentRaw === undefined ? null : applyScenarioToValue(currentRaw, scenario);
        const prevRaw = prevBalances ? prevBalances[id] : undefined;
        const previous = prevRaw === undefined || prevRaw === null ? null : applyScenarioToValue(prevRaw, scenario);
        let change = current !== null && previous !== null ? current - previous : null;
        if(change !== null && Math.abs(change) < 0.005) change = 0;
        const pct = change !== null && previous !== null && previous !== 0 ? (change / Math.abs(previous)) * 100 : null;
        perAccount[id] = { value: current, prev: previous, change, pct };
        if(typeof current === 'number') netWorth += current;
        if(prevYm && typeof previous === 'number') prevNetWorth += previous;
      }
      const delta = prevYm ? netWorth - (prevNetWorth ?? 0) : null;
      return { ym, perAccount, netWorth, prevNetWorth: prevYm ? prevNetWorth : null, delta };
    });
  }

  function computeHistoryAccountSummaries(records, accountIds){
    const summaries = {};
    for(const id of accountIds){
      let sum = 0;
      let count = 0;
      let hasChange = false;
      for(const record of records){
        const info = record.perAccount[id];
        if(!info) continue;
        if(typeof info.value === 'number'){ sum += info.value; count += 1; }
        if(info.change !== null && info.change !== undefined && Math.abs(info.change) >= 0.005){
          hasChange = true;
        }
      }
      summaries[id] = { avg: count ? sum / count : null, hasChange };
    }
    return summaries;
  }

  function computeNetWorthAverage(records){
    const values = records
      .map(record => typeof record.netWorth === 'number' ? record.netWorth : null)
      .filter(value => value !== null && !Number.isNaN(value));
    if(!values.length) return null;
    return values.reduce((sum, value) => sum + value, 0) / values.length;
  }

  function renderHistoryTableStandard({ thead, tbody, accounts, accountSummaries, monthRecords, sortState, netWorthAverage }){
    if(!thead || !tbody) return;
    const headerRow = document.createElement('tr');
    headerRow.appendChild(createHistoryHeaderCell('ym', 'Miesiąc', sortState));
    accounts.forEach(acc => {
      headerRow.appendChild(createHistoryHeaderCell(`acc:${acc.id}`, acc.name, sortState));
    });
    headerRow.appendChild(createHistoryHeaderCell('netWorth', 'Majątek netto', sortState));
    headerRow.appendChild(createHistoryHeaderCell('delta', 'Zmiana m/m', sortState));
    thead.appendChild(headerRow);

    const records = sortHistoryRecords([...monthRecords], sortState);
    const positiveColor = cssVar('--green', '#22c55e');
    const negativeColor = cssVar('--red', '#ef4444');
    const exportHeaders = ['Miesiąc', ...accounts.map(acc => acc.name), 'Majątek netto', 'Zmiana m/m'];
    const exportRows = [];

    records.forEach(record => {
      const tr = document.createElement('tr');
      const monthTd = document.createElement('td');
      monthTd.innerHTML = `<div class="eom-history-value">${formatMonthLabel(record.ym)}</div><div class="tiny muted">${record.ym}</div>`;
      monthTd.dataset.value = record.ym;
      tr.appendChild(monthTd);

      accounts.forEach(acc => {
        const summary = accountSummaries[acc.id] || {};
        const info = record.perAccount[acc.id] || { value:null, change:null, prev:null, pct:null };
        const td = createHistoryValueCell(info, summary.avg, positiveColor, negativeColor, false);
        tr.appendChild(td);
      });

      const netInfo = {
        value: record.netWorth,
        change: record.delta,
        prev: record.prevNetWorth,
        pct: record.prevNetWorth ? (record.delta / Math.abs(record.prevNetWorth)) * 100 : null
      };
      const netTd = createHistoryValueCell(netInfo, netWorthAverage, positiveColor, negativeColor, true);
      netTd.classList.add('networth');
      tr.appendChild(netTd);

      const deltaTd = document.createElement('td');
      deltaTd.className = 'delta';
      if(record.delta === null || Number.isNaN(record.delta)){
        deltaTd.innerHTML = '<span class="muted">—</span>';
      } else {
        deltaTd.innerHTML = renderDeltaBadge(record.delta);
        const pct = record.prevNetWorth ? (record.delta / Math.abs(record.prevNetWorth)) * 100 : null;
        if(pct !== null && Number.isFinite(pct)){
          deltaTd.title = `Zmiana m/m: ${record.delta >= 0 ? '+' : ''}${fmt(record.delta, state.currency)} (${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%)`;
        }
      }
      deltaTd.dataset.value = record.delta ?? '';
      tr.appendChild(deltaTd);

      tbody.appendChild(tr);

      exportRows.push([
        formatMonthLabel(record.ym),
        ...accounts.map(acc => formatHistoryExportValue(record.perAccount[acc.id]?.value)),
        formatHistoryExportValue(record.netWorth),
        formatHistoryExportDelta(record.delta)
      ]);
    });

    eomHistoryExportCache = {
      headers: exportHeaders,
      rows: exportRows,
      filename: `historia_${new Date().toISOString().slice(0,10)}.csv`
    };
  }

  function renderHistoryTableTransposed({ thead, tbody, accounts, accountSummaries, monthRecords, sortState, netWorthAverage, chronologicalMonths }){
    if(!thead || !tbody) return;
    const headerRow = document.createElement('tr');
    headerRow.appendChild(createHistoryHeaderCell('name', 'Konto', sortState));
    chronologicalMonths.forEach(ym => {
      headerRow.appendChild(createHistoryHeaderCell(`month:${ym}`, formatMonthLabel(ym), sortState));
    });
    headerRow.appendChild(createHistoryHeaderCell('avg', 'Średnia', sortState));
    headerRow.appendChild(createHistoryHeaderCell('lastChange', 'Zmiana m/m', sortState));
    thead.appendChild(headerRow);

    const positiveColor = cssVar('--green', '#22c55e');
    const negativeColor = cssVar('--red', '#ef4444');

    const rows = accounts.map(acc => {
      const values = chronologicalMonths.map((ym, idx) => monthRecords[idx].perAccount[acc.id] || { value:null, change:null, prev:null, pct:null });
      const lastInfo = values[values.length - 1] || { change:null, prev:null, pct:null };
      return {
        key: `acc:${acc.id}`,
        label: acc.name,
        values,
        average: accountSummaries[acc.id]?.avg ?? null,
        lastChange: lastInfo.change,
        lastPrev: lastInfo.prev,
        lastPct: lastInfo.pct,
        isNetWorth: false
      };
    });

    const netValues = chronologicalMonths.map((ym, idx) => {
      const record = monthRecords[idx];
      return {
        value: record.netWorth,
        change: record.delta,
        prev: record.prevNetWorth,
        pct: record.prevNetWorth ? (record.delta / Math.abs(record.prevNetWorth)) * 100 : null
      };
    });
    const netLast = netValues[netValues.length - 1] || { change:null, prev:null, pct:null };
    rows.push({
      key: 'networth',
      label: 'Majątek netto',
      values: netValues,
      average: netWorthAverage,
      lastChange: netLast.change,
      lastPrev: netLast.prev,
      lastPct: netLast.pct,
      isNetWorth: true
    });

    const sortedRows = sortHistoryTransposedRows(rows, sortState, chronologicalMonths);
    const exportHeaders = ['Konto', ...chronologicalMonths.map(formatMonthLabel), 'Średnia', 'Zmiana m/m'];
    const exportRows = [];

    sortedRows.forEach(row => {
      const tr = document.createElement('tr');
      const nameTd = document.createElement('td');
      nameTd.innerHTML = `<div class="eom-history-value">${row.label}</div>`;
      tr.appendChild(nameTd);

      row.values.forEach(valueInfo => {
        const td = createHistoryValueCell(valueInfo, row.isNetWorth ? netWorthAverage : row.average, positiveColor, negativeColor, row.isNetWorth);
        tr.appendChild(td);
      });

      const avgTd = document.createElement('td');
      avgTd.className = 'networth';
      if(row.average === null || Number.isNaN(row.average)){
        avgTd.innerHTML = '<span class="muted">—</span>';
      } else {
        avgTd.innerHTML = `<span class="eom-history-value">${fmt(row.average, state.currency)}</span>`;
      }
      tr.appendChild(avgTd);

      const lastTd = document.createElement('td');
      lastTd.className = 'delta';
      if(row.lastChange === null || row.lastChange === undefined || Number.isNaN(row.lastChange)){
        lastTd.innerHTML = '<span class="muted">—</span>';
      } else {
        lastTd.innerHTML = renderDeltaBadge(row.lastChange);
        if(row.lastPrev !== null && row.lastPrev !== undefined){
          const pct = row.lastPct !== null && row.lastPct !== undefined && Number.isFinite(row.lastPct)
            ? `${row.lastChange >= 0 ? '+' : ''}${row.lastPct.toFixed(1)}%`
            : '—';
          lastTd.title = `Zmiana vs poprzedni miesiąc: ${row.lastChange >= 0 ? '+' : ''}${fmt(row.lastChange, state.currency)} (${pct})`;
        }
      }
      tr.appendChild(lastTd);

      if(row.isNetWorth) tr.classList.add('networth-row');
      tbody.appendChild(tr);

      exportRows.push([
        row.label,
        ...row.values.map(valueInfo => formatHistoryExportValue(valueInfo?.value)),
        formatHistoryExportValue(row.average),
        formatHistoryExportDelta(row.lastChange)
      ]);
    });

    eomHistoryExportCache = {
      headers: exportHeaders,
      rows: exportRows,
      filename: `historia_${new Date().toISOString().slice(0,10)}.csv`
    };
  }

  function createHistoryHeaderCell(key, label, sortState){
    const th = document.createElement('th');
    const button = document.createElement('button');
    button.type = 'button';
    button.textContent = label;
    button.dataset.sortKey = key;
    if(sortState.key === key){
      button.dataset.sortDir = sortState.dir === 'asc' ? '▲' : '▼';
    }
    th.appendChild(button);
    return th;
  }

  function sortHistoryRecords(records, sortState){
    const dir = sortState.dir === 'asc' ? 1 : -1;
    const key = sortState.key;
    return records.sort((a, b) => {
      if(key === 'ym') return a.ym.localeCompare(b.ym) * dir;
      if(key === 'netWorth') return compareNumericValues(a.netWorth, b.netWorth, dir);
      if(key === 'delta') return compareNumericValues(a.delta, b.delta, dir);
      if(typeof key === 'string' && key.startsWith('acc:')){
        const id = key.slice(4);
        return compareNumericValues(a.perAccount[id]?.value, b.perAccount[id]?.value, dir);
      }
      return 0;
    });
  }

  function sortHistoryTransposedRows(rows, sortState, months){
    const dir = sortState.dir === 'asc' ? 1 : -1;
    const key = sortState.key;
    return rows.sort((a, b) => {
      if(a.isNetWorth && !b.isNetWorth) return 1;
      if(!a.isNetWorth && b.isNetWorth) return -1;
      if(key === 'name') return a.label.localeCompare(b.label, 'pl', { sensitivity: 'base' }) * dir;
      if(key === 'avg') return compareNumericValues(a.average, b.average, dir);
      if(key === 'lastChange') return compareNumericValues(a.lastChange, b.lastChange, dir);
      if(typeof key === 'string' && key.startsWith('month:')){
        const ym = key.slice(6);
        const idx = months.indexOf(ym);
        if(idx === -1) return 0;
        return compareNumericValues(a.values[idx]?.value, b.values[idx]?.value, dir);
      }
      return 0;
    });
  }

  function compareNumericValues(a, b, dir){
    const aValid = typeof a === 'number' && !Number.isNaN(a);
    const bValid = typeof b === 'number' && !Number.isNaN(b);
    if(!aValid && !bValid) return 0;
    if(!aValid) return 1 * dir;
    if(!bValid) return -1 * dir;
    if(a === b) return 0;
    return a > b ? dir : -dir;
  }

  function createHistoryValueCell(info, average, positiveColor, negativeColor, isNetWorth){
    const td = document.createElement('td');
    const value = info && typeof info.value === 'number' ? info.value : null;
    if(value === null){
      td.innerHTML = '<span class="muted">—</span>';
      return td;
    }
    const span = document.createElement('span');
    span.className = 'eom-history-value';
    span.textContent = fmt(value, state.currency);
    td.appendChild(span);
    td.dataset.value = value;

    if(info && info.change !== null && info.change !== undefined){
      const change = info.change || 0;
      const arrow = document.createElement('span');
      let tone = 'neutral';
      if(change > 0) tone = 'positive';
      if(change < 0) tone = 'negative';
      arrow.className = `eom-history-arrow ${tone}`;
      arrow.textContent = change > 0 ? '△' : change < 0 ? '▽' : '→';
      td.appendChild(arrow);
      if(info.prev !== null && info.prev !== undefined){
        const pct = info.pct !== null && info.pct !== undefined && Number.isFinite(info.pct)
          ? `${change >= 0 ? '+' : ''}${info.pct.toFixed(1)}%`
          : '—';
        td.title = `Zmiana vs poprzedni miesiąc: ${change >= 0 ? '+' : ''}${fmt(change, state.currency)} (${pct})`;
      }
    }

    applyHistoryHeat(td, value, average, positiveColor, negativeColor);
    if(isNetWorth) td.classList.add('networth');
    return td;
  }

  function applyHistoryHeat(cell, value, average, positiveColor, negativeColor){
    if(value === null || average === null || average === undefined || Number.isNaN(value) || Number.isNaN(average)) return;
    const diff = value - average;
    if(Math.abs(diff) < 0.005) return;
    const tone = diff > 0 ? 'positive' : 'negative';
    const ratio = Math.min(1.5, Math.abs(diff) / Math.max(Math.abs(average), 1));
    const alpha = 0.12 + ratio * 0.25;
    const color = tone === 'positive' ? colorWithAlpha(positiveColor, alpha) : colorWithAlpha(negativeColor, alpha);
    cell.style.background = color;
    cell.classList.add(tone);
  }

  function formatHistoryExportValue(value){
    if(value === null || value === undefined || Number.isNaN(value)) return '';
    return fmt(value, state.currency);
  }

  function formatHistoryExportDelta(delta){
    if(delta === null || delta === undefined || Number.isNaN(delta)) return '';
    return `${delta >= 0 ? '+' : ''}${fmt(delta, state.currency)}`;
  }

  function updateHistoryFooter(container, records, netWorthAverage, totalMonths, accountCount){
    if(!container){
      return;
    }
    if(!records.length){
      container.innerHTML = '<span class="muted">Brak danych do podsumowania.</span>';
      return;
    }
    const first = records[0];
    const last = records[records.length - 1];
    const change = (typeof first.netWorth === 'number' && typeof last.netWorth === 'number') ? last.netWorth - first.netWorth : null;
    const pct = change !== null && first.netWorth ? (change / Math.abs(first.netWorth)) * 100 : null;
    const trendSymbol = change === null ? '→' : change > 0 ? '↗' : change < 0 ? '↘' : '→';
    const avgDisplay = netWorthAverage === null ? '—' : fmt(netWorthAverage, state.currency);
    const changeDisplay = change === null ? '—' : `${change >= 0 ? '+' : ''}${fmt(change, state.currency)}${pct !== null && Number.isFinite(pct) ? ` (${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%)` : ''}`;
    const rangeDisplay = `${formatMonthLabel(first.ym)} → ${formatMonthLabel(last.ym)}`;
    container.innerHTML = `
      <div>
        <div class="muted">Średni majątek netto</div>
        <strong>${avgDisplay}</strong>
      </div>
      <div>
        <div class="muted">Trend ogólny</div>
        <strong>${trendSymbol} ${changeDisplay}</strong>
      </div>
      <div>
        <div class="muted">Zakres danych</div>
        <span>${rangeDisplay}</span>
      </div>
      <div>
        <div class="muted">Widoczność</div>
        <span>Pokazujesz ${records.length} z ${totalMonths} miesięcy · ${accountCount} kont</span>
      </div>
    `;
  }

  function exportEomHistoryCsv(){
    if(!eomHistoryExportCache || !Array.isArray(eomHistoryExportCache.rows) || !eomHistoryExportCache.rows.length){
      return;
    }
    const headers = eomHistoryExportCache.headers || [];
    const rows = eomHistoryExportCache.rows || [];
    const lines = [headers.map(csvEscape).join(';'), ...rows.map(row => row.map(csvEscape).join(';'))];
    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = eomHistoryExportCache.filename || 'eom-history.csv';
    document.body.appendChild(a);
    a.click();
    requestAnimationFrame(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  function csvEscape(value){
    if(value === null || value === undefined) return '';
    const str = String(value).replace(/\r?\n|\r/g, ' ').replace(/"/g, '""');
    if(/[";,]/.test(str)){
      return `"${str}"`;
    }
    return str;
  }

  function renderEomPerformanceMatrix(ctx, accountStats){
    const container = document.getElementById('eom-performance-matrix');
    if(!container) return;
    const topZone = container.querySelector('[data-zone="top"]');
    const watchZone = container.querySelector('[data-zone="watch"]');
    if(!topZone || !watchZone) return;

    topZone.innerHTML = '';
    watchZone.innerHTML = '';

    if(!ctx.months.length){
      topZone.innerHTML = '<div class="eom-performance-empty">Dodaj pierwsze salda, aby zobaczyć ranking kont.</div>';
      watchZone.innerHTML = '<div class="eom-performance-empty">✅ Wszystko pod kontrolą</div>';
      return;
    }

    const scenario = eomUiState.scenario || 'actual';
    const topAccounts = accountStats
      .filter(stat => Number.isFinite(stat.delta) && stat.delta > 0)
      .sort((a,b) => (b.delta || 0) - (a.delta || 0))
      .slice(0, 5);

    if(!topAccounts.length){
      topZone.innerHTML = '<div class="eom-performance-empty">Wszystkie konta stabilne</div>';
    } else {
      topAccounts.forEach(stat => {
        const card = buildEomAccountPerformanceCard(ctx, stat, { tone: 'positive', scenario });
        topZone.appendChild(card);
      });
    }

    const watchCandidates = accountStats
      .filter(stat => Number.isFinite(stat.delta) && stat.delta < 0)
      .map(stat => ({
        stat,
        magnitude: Math.abs(stat.delta ?? 0),
        pct: Math.abs(stat.deltaPct ?? 0),
        alert: detectEomAccountAlert(stat, scenario)
      }))
      .sort((a,b) => {
        if(a.magnitude !== b.magnitude) return b.magnitude - a.magnitude;
        if(a.pct !== b.pct) return b.pct - a.pct;
        return a.stat.account.name.localeCompare(b.stat.account.name, 'pl', { sensitivity:'base' });
      });

    const watchList = watchCandidates.slice(0, 5);
    if(!watchList.length){
      watchZone.innerHTML = '<div class="eom-performance-empty">✅ Wszystko pod kontrolą</div>';
    } else {
      watchList.forEach(item => {
        const card = buildEomAccountPerformanceCard(ctx, item.stat, { tone: 'negative', scenario, alert: item.alert });
        watchZone.appendChild(card);
      });
    }

    requestAnimationFrame(() => {
      container.querySelectorAll('canvas[data-spark]').forEach(canvas => {
        const raw = canvas.dataset.values || '';
        const values = raw ? raw.split(',').map(Number).filter(val => Number.isFinite(val)) : [];
        const color = canvas.dataset.color || 'var(--accent)';
        drawMiniSparkline(canvas, values, { color });
      });
    });
  }

  function renderEomComparison(ctx){
    const section = document.getElementById('eom-mom');
    if(!section) return;
    const selectA = document.getElementById('eom-mom-month-a');
    const selectB = document.getElementById('eom-mom-month-b');
    const swapBtn = document.getElementById('eom-mom-swap');
    const runBtn = document.getElementById('eom-mom-run');
    const emptyEl = document.getElementById('eom-mom-empty');
    const content = document.getElementById('eom-mom-content');
    const summaryValue = document.getElementById('eom-mom-summary-value');
    const summaryText = document.getElementById('eom-mom-summary-text');
    const pillsContainer = document.getElementById('eom-mom-pills');
    const rankingTable = document.getElementById('eom-mom-ranking-table');
    const rankingNote = document.getElementById('eom-mom-ranking-note');
    const autoList = document.getElementById('eom-mom-auto-insights');

    if(content && !content.dataset.bound){
      content.dataset.bound = '1';
      content.addEventListener('click', (event) => {
        const trigger = event.target.closest('[data-account-id]');
        if(trigger){
          const accId = trigger.dataset.accountId;
          if(accId){
            eomUiState.focusedAccountId = accId;
            eomUiState.dashboardView = 'accounts';
            saveEomUiState();
            renderEOM();
            const detail = document.getElementById('eom-grid');
            if(detail){
              requestAnimationFrame(() => {
                detail.scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
            }
          }
        }
      });
    }

    const months = Array.from(new Set([...(ctx.months || []), ctx.workingYm].filter(Boolean))).sort();
    const monthsDesc = [...months].sort((a,b) => b.localeCompare(a));

    const ensureMonth = (key, fallbackIndex) => {
      if(!months.length) return null;
      if(key && months.includes(key)) return key;
      if(typeof fallbackIndex === 'number' && months[fallbackIndex]) return months[fallbackIndex];
      return months[months.length - 1];
    };

    if(!eomUiState.compareMonthA || !months.includes(eomUiState.compareMonthA)){
      const workingIdx = months.indexOf(ctx.workingYm);
      eomUiState.compareMonthA = ensureMonth(ctx.workingYm, workingIdx >= 0 ? workingIdx : months.length - 1);
    }
    if(!eomUiState.compareMonthB || !months.includes(eomUiState.compareMonthB) || eomUiState.compareMonthB === eomUiState.compareMonthA){
      const idxA = months.indexOf(eomUiState.compareMonthA);
      const prev = idxA > 0 ? months[idxA - 1] : months.find(ym => ym !== eomUiState.compareMonthA) || null;
      eomUiState.compareMonthB = prev;
    }

    const populateSelect = (select, value) => {
      if(!select) return;
      select.innerHTML = monthsDesc.map(ym => `<option value="${ym}">${formatMonthLabel(ym)}</option>`).join('');
      select.value = value && months.includes(value) ? value : '';
      if(!select.value && monthsDesc.length){
        select.value = monthsDesc[0];
      }
    };

    populateSelect(selectA, eomUiState.compareMonthA);
    populateSelect(selectB, eomUiState.compareMonthB);

    if(selectA && !selectA.dataset.bound){
      selectA.dataset.bound = '1';
      selectA.addEventListener('change', (e) => {
        eomUiState.compareMonthA = e.target.value || null;
        saveEomUiState();
        renderEOM();
      });
    }
    if(selectB && !selectB.dataset.bound){
      selectB.dataset.bound = '1';
      selectB.addEventListener('change', (e) => {
        eomUiState.compareMonthB = e.target.value || null;
        saveEomUiState();
        renderEOM();
      });
    }
    if(swapBtn && !swapBtn.dataset.bound){
      swapBtn.dataset.bound = '1';
      swapBtn.addEventListener('click', () => {
        const nextA = eomUiState.compareMonthB;
        const nextB = eomUiState.compareMonthA;
        eomUiState.compareMonthA = nextA;
        eomUiState.compareMonthB = nextB;
        saveEomUiState();
        renderEOM();
      });
    }
    if(runBtn && !runBtn.dataset.bound){
      runBtn.dataset.bound = '1';
      runBtn.addEventListener('click', () => {
        renderEOM();
      });
    }

    const monthA = eomUiState.compareMonthA && months.includes(eomUiState.compareMonthA)
      ? eomUiState.compareMonthA
      : null;
    const monthB = eomUiState.compareMonthB && months.includes(eomUiState.compareMonthB)
      ? eomUiState.compareMonthB
      : null;

    const showEmpty = (message) => {
      if(emptyEl){
        emptyEl.textContent = message;
        emptyEl.style.display = 'block';
      }
      if(content) content.style.display = 'none';
      if(pillsContainer) pillsContainer.innerHTML = '';
      if(summaryText) summaryText.textContent = '';
      if(summaryValue){
        summaryValue.textContent = '—';
        summaryValue.className = 'value neutral';
      }
      if(rankingTable) rankingTable.innerHTML = '';
      if(rankingNote) rankingNote.textContent = '';
      if(autoList) autoList.innerHTML = '';
    };

    const hideEmpty = () => {
      if(emptyEl) emptyEl.style.display = 'none';
      if(content) content.style.display = 'flex';
    };

    if(!months.length){
      showEmpty('Dodaj co najmniej dwa zapisy, aby skorzystać z porównania.');
      return;
    }

    if(!monthA || !monthB){
      showEmpty('Wybierz dwa miesiące do porównania.');
      return;
    }

    if(monthA === monthB){
      showEmpty('Wybierz różne miesiące, aby zobaczyć porównanie.');
      return;
    }

    hideEmpty();

    const balancesA = ctx.monthBalances[monthA] || {};
    const balancesB = ctx.monthBalances[monthB] || {};
    const accountMap = new Map((ctx.accounts || []).map(acc => [acc.id, acc]));

    const hasOwn = (obj, key) => Object.prototype.hasOwnProperty.call(obj || {}, key);
    const formatSigned = (value) => {
      if(value === null || value === undefined) return '—';
      if(Math.abs(value) < 0.0005) return fmt(0, state.currency);
      const formatted = fmt(Math.abs(value), state.currency);
      if(value > 0) return `+${formatted}`;
      if(value < 0) return `-${formatted}`;
      return formatted;
    };
    const formatPercent = (value) => {
      if(value === null || value === undefined || Number.isNaN(value)) return '—';
      if(Math.abs(value) < 0.0005) return '0.0%';
      return `${value > 0 ? '+' : ''}${value.toFixed(1)}%`;
    };
    const describeMonths = (count) => {
      if(!Number.isFinite(count) || count <= 0) return '0 miesięcy';
      if(count === 1) return '1 miesiąc';
      if(count >= 2 && count <= 4) return `${count} miesiące`;
      return `${count} miesięcy`;
    };
    const sumBalances = (balances) => {
      return Object.values(balances || {}).reduce((sum, value) => {
        const num = Number(value);
        if(Number.isFinite(num)) return sum + num;
        return sum;
      }, 0);
    };

    const allIds = new Set([...Object.keys(balancesA || {}), ...Object.keys(balancesB || {})]);
    const rows = [];
    allIds.forEach(id => {
      const hasA = hasOwn(balancesA, id);
      const hasB = hasOwn(balancesB, id);
      if(!hasA && !hasB) return;
      const valueA = hasA ? Number(balancesA[id]) : null;
      const valueB = hasB ? Number(balancesB[id]) : null;
      const delta = (valueA ?? 0) - (valueB ?? 0);
      const baseForPct = hasB && valueB !== 0
        ? Math.abs(valueB)
        : (hasA && valueA !== 0 ? Math.abs(valueA) : null);
      const deltaPct = baseForPct ? (delta / baseForPct) * 100 : null;
      let tone = 'neutral';
      if(Math.abs(delta) < 0.005){
        tone = 'neutral';
      } else if(deltaPct !== null && Math.abs(deltaPct) < 1){
        tone = 'neutral';
      } else if(delta > 0){
        tone = 'positive';
      } else if(delta < 0){
        tone = 'negative';
      }
      const status = hasA && !hasB ? 'new' : (!hasA && hasB ? 'closed' : 'existing');
      if(status !== 'existing'){
        tone = delta > 0 ? 'positive' : delta < 0 ? 'negative' : 'neutral';
      }
      const account = accountMap.get(id) || { id, name:`Konto ${id.slice(-4)}` };
      rows.push({
        account,
        id,
        hasA,
        hasB,
        valueA: hasA ? valueA : null,
        valueB: hasB ? valueB : null,
        delta,
        deltaPct,
        tone,
        status
      });
    });

    const totalA = sumBalances(balancesA);
    const totalB = sumBalances(balancesB);
    const totalDelta = totalA - totalB;
    const totalPct = totalB ? (totalDelta / Math.abs(totalB)) * 100 : (totalA ? null : 0);
    const totalTone = totalDelta > 0 ? 'positive' : totalDelta < 0 ? 'negative' : 'neutral';

    const toIndex = (ym) => {
      if(!ym) return null;
      const [y, m] = ym.split('-').map(Number);
      if(!Number.isFinite(y) || !Number.isFinite(m)) return null;
      return y * 12 + (m || 0);
    };
    const idxA = toIndex(monthA);
    const idxB = toIndex(monthB);
    const spanMonths = (idxA !== null && idxB !== null) ? Math.max(1, Math.abs(idxA - idxB)) : null;
    const avgPerMonth = spanMonths ? totalDelta / spanMonths : null;

    if(summaryValue){
      summaryValue.textContent = formatSigned(totalDelta);
      summaryValue.className = `value ${totalTone}`;
    }
    if(summaryText){
      const pctText = Number.isFinite(totalPct) ? formatPercent(totalPct) : null;
      let message = '';
      if(Math.abs(totalDelta) < 0.005){
        message = `Saldo w miesiącu ${formatMonthLabel(monthA)} jest na tym samym poziomie co w ${formatMonthLabel(monthB)}.`;
      } else {
        const directionWord = totalDelta > 0 ? 'WYŻSZE' : 'NIŻSZE';
        const pctPart = pctText ? ` (${pctText})` : '';
        message = `Saldo w miesiącu ${formatMonthLabel(monthA)} jest o ${formatSigned(totalDelta)}${pctPart} ${directionWord} niż w ${formatMonthLabel(monthB)}.`;
      }
      if(spanMonths && spanMonths > 0){
        message += ` Okres między zapisami: ${describeMonths(spanMonths)}.`;
      }
      if(avgPerMonth !== null){
        message += ` Średnio na miesiąc: ${formatSigned(avgPerMonth)}.`;
      }
      summaryText.textContent = message;
    }
    const rowsByMagnitude = [...rows].sort((a,b) => Math.abs((b.delta ?? 0)) - Math.abs((a.delta ?? 0)));
    const topIncrease = rows.filter(row => (row.delta ?? 0) > 0.005).sort((a,b) => (b.delta ?? 0) - (a.delta ?? 0))[0] || null;
    const topDecrease = rows.filter(row => (row.delta ?? 0) < -0.005).sort((a,b) => (a.delta ?? 0) - (b.delta ?? 0))[0] || null;
    const newAccounts = rows.filter(row => row.status === 'new');
    const closedAccounts = rows.filter(row => row.status === 'closed');
    const totalMagnitude = rows.reduce((sum, item) => sum + Math.abs(item.delta ?? 0), 0);
    const topThree = rowsByMagnitude.slice(0, 3);
    const topShare = totalMagnitude > 0 ? (topThree.reduce((sum, item) => sum + Math.abs(item.delta ?? 0), 0) / totalMagnitude) * 100 : 0;

    const insightPills = [];
    if(topIncrease){
      insightPills.push({ label: `Największy wzrost: ${topIncrease.account.name} ${formatSigned(topIncrease.delta)}`, tone: 'positive', accountId: topIncrease.account.id });
    }
    if(topDecrease){
      insightPills.push({ label: `Największy spadek: ${topDecrease.account.name} ${formatSigned(topDecrease.delta)}`, tone: 'negative', accountId: topDecrease.account.id });
    }
    if(topThree.length && totalMagnitude > 0){
      insightPills.push({ label: `TOP 3 odpowiadają za ${topShare.toFixed(1)}% zmiany`, tone: 'info' });
    }
    if(pillsContainer){
      pillsContainer.innerHTML = insightPills.length
        ? insightPills.map(pill => {
            const attrs = pill.accountId ? ` data-account-id="${pill.accountId}"` : '';
            return `<button type="button" class="insight-pill ${pill.tone}"${attrs}>${pill.label}</button>`;
          }).join('')
        : '<span class="tiny muted">Brak wyróżnionych zmian.</span>';
    }

    const maxMagnitude = rows.reduce((max, row) => Math.max(max, Math.abs(row.delta ?? 0)), 0) || 1;
    const biggestChange = rows.reduce((best, item) => {
      const magnitude = Math.abs(item.delta ?? 0);
      if(!best || magnitude > Math.abs(best.delta ?? 0)) return item;
      return best;
    }, null);
    if(biggestChange && Math.abs(biggestChange.delta || 0) >= 0.005){
      biggestChange.isBiggest = true;
    }

    if(rankingTable){
      if(!rows.length){
        rankingTable.innerHTML = '<tbody><tr><td class="muted" style="text-align:center;padding:12px;">Brak danych do rankingu.</td></tr></tbody>';
      } else {
        const head = `<thead><tr><th>Konto</th><th>${formatMonthLabel(monthA)}</th><th>${formatMonthLabel(monthB)}</th><th>Δ PLN</th><th>Δ %</th></tr></thead>`;
        const body = rowsByMagnitude.map(row => {
          const tone = row.delta > 0 ? 'positive' : row.delta < 0 ? 'negative' : 'neutral';
          const progress = Math.min(1, Math.abs(row.delta ?? 0) / maxMagnitude);
          const deltaBar = `<div class=\"eom-mom-change-bar ${tone}\" style=\"--delta-progress:${progress.toFixed(3)}\"><span>${formatSigned(row.delta)}</span></div>`;
          const statusNote = row.status === 'new'
            ? `<div class=\"tiny muted\">Nowe w ${formatMonthLabel(monthA)}</div>`
            : row.status === 'closed'
              ? `<div class=\"tiny muted\">Zamknięte po ${formatMonthLabel(monthB)}</div>`
              : '';
          const biggest = row.isBiggest ? '<div class="tiny muted">Największa zmiana</div>' : '';
          const valueA = row.hasA ? fmt(row.valueA, state.currency) : '<span class="muted">—</span>';
          const valueB = row.hasB ? fmt(row.valueB, state.currency) : '<span class="muted">—</span>';
          const deltaPctCell = row.deltaPct !== null ? formatPercent(row.deltaPct) : '—';
          return `
            <tr data-account-id="${row.account.id}">
              <td><div>${row.account.name}</div>${statusNote}</td>
              <td>${valueA}</td>
              <td>${valueB}</td>
              <td>${deltaBar}${biggest}</td>
              <td>${deltaPctCell}</td>
            </tr>
          `;
        }).join('');
        rankingTable.innerHTML = head + `<tbody>${body}</tbody>`;
      }
    }
    if(rankingNote){
      rankingNote.textContent = rows.length
        ? `Pokazujesz ${rows.length} kont (nowe: ${newAccounts.length}, zamknięte: ${closedAccounts.length}).`
        : '';
    }

    const netSeries = (ctx.netWorthByMonth || [])
      .filter(item => Number.isFinite(item.total))
      .sort((a,b) => a.ym.localeCompare(b.ym));
    const netDiffs = [];
    for(let i=1;i<netSeries.length;i++){
      netDiffs.push(netSeries[i].total - netSeries[i-1].total);
    }
    const historicalAvg = netDiffs.length ? netDiffs.reduce((sum,val)=>sum+val,0) / netDiffs.length : null;
    const last3 = netDiffs.slice(-3);
    const last3Avg = last3.length ? last3.reduce((sum,val)=>sum+val,0) / last3.length : null;
    const vsHistorical = (avgPerMonth !== null && historicalAvg !== null)
      ? avgPerMonth - historicalAvg
      : null;

    const autoInsights = [];
    const totalPctText = Number.isFinite(totalPct) ? formatPercent(totalPct) : null;
    autoInsights.push({
      icon: totalDelta > 0 ? '📈' : totalDelta < 0 ? '📉' : '🟰',
      title: totalDelta === 0 ? 'Portfel bez zmian' : `Całkowita zmiana ${formatSigned(totalDelta)}`,
      description: totalDelta === 0
        ? `Saldo w ${formatMonthLabel(monthA)} jest takie samo jak w ${formatMonthLabel(monthB)}.`
        : `Portfel jest ${totalDelta > 0 ? 'wyższy' : 'niższy'} o ${formatSigned(totalDelta)}${totalPctText ? ` (${totalPctText})` : ''} względem ${formatMonthLabel(monthB)}.`,
      severity: totalDelta > 0 ? 'success' : totalDelta < 0 ? 'danger' : 'info'
    });
    if(topIncrease){
      autoInsights.push({
        icon: '⭐',
        title: `Największy wzrost: ${topIncrease.account.name}`,
        description: `${formatSigned(topIncrease.delta)} vs ${formatMonthLabel(monthB)}.`,
        severity: 'success',
        accountId: topIncrease.account.id
      });
    }
    if(topDecrease){
      autoInsights.push({
        icon: '⚠️',
        title: `Największy spadek: ${topDecrease.account.name}`,
        description: `${formatSigned(topDecrease.delta)} vs ${formatMonthLabel(monthB)}.`,
        severity: 'danger',
        accountId: topDecrease.account.id
      });
    }
    if(topThree.length && totalMagnitude > 0){
      autoInsights.push({
        icon: '📊',
        title: 'Największe kontrybutory zmiany',
        description: `${topThree.map(row => row.account.name).join(', ')} odpowiada za ${topShare.toFixed(1)}% całkowitej zmiany.`,
        severity: 'info'
      });
    }
    if(newAccounts.length){
      autoInsights.push({
        icon: '🆕',
        title: 'Nowe konta w miesiącu A',
        description: newAccounts.map(row => row.account.name).slice(0, 4).join(', '),
        severity: 'info'
      });
    }
    if(closedAccounts.length){
      autoInsights.push({
        icon: '📁',
        title: 'Zamknięte od miesiąca B',
        description: closedAccounts.map(row => row.account.name).slice(0, 4).join(', '),
        severity: 'warning'
      });
    }
    if(avgPerMonth !== null){
      autoInsights.push({
        icon: '⏱️',
        title: 'Średnio miesięczna zmiana',
        description: `Tempo wynosi ${formatSigned(avgPerMonth)} na ${spanMonths ? describeMonths(spanMonths) : 'wybrany okres'}.`,
        severity: avgPerMonth > 0 ? 'success' : avgPerMonth < 0 ? 'danger' : 'info'
      });
    }
    if(last3Avg !== null){
      autoInsights.push({
        icon: '📅',
        title: 'Ostatnie 3 miesiące',
        description: `Średnio ${formatSigned(last3Avg)} na miesiąc w ostatnich 3 zapisach.`,
        severity: last3Avg > 0 ? 'success' : last3Avg < 0 ? 'danger' : 'info'
      });
    }
    if(vsHistorical !== null){
      autoInsights.push({
        icon: '📐',
        title: 'Porównanie do historii',
        description: `Tempo jest ${vsHistorical > 0 ? 'wyższe' : 'niższe'} o ${formatSigned(vsHistorical)} względem średniej historycznej ${historicalAvg !== null ? formatSigned(historicalAvg) : '—'}.`,
        severity: vsHistorical > 0 ? 'success' : vsHistorical < 0 ? 'warning' : 'info'
      });
    }

    if(autoList){
      const finalAuto = autoInsights.slice(0, 8);
      autoList.innerHTML = finalAuto.length
        ? finalAuto.map(item => {
            const attrs = item.accountId ? ` data-account-id="${item.accountId}"` : '';
            return `
              <div class="eom-mom-auto-card ${item.severity}"${attrs}>
                <div class="title"><span>${item.icon}</span><span>${item.title}</span></div>
                <div class="description">${item.description}</div>
              </div>
            `;
          }).join('')
        : '<div class="muted" style="padding:12px;text-align:center;">Brak dodatkowych wniosków dla wybranych miesięcy.</div>';
    }

    const applyFocusedAccount = () => {
      if(!content) return;
      const focusId = eomUiState.focusedAccountId;
      content.querySelectorAll('[data-account-id]').forEach(el => {
        if(focusId && el.dataset.accountId === focusId){
          el.classList.add('is-highlighted');
        } else {
          el.classList.remove('is-highlighted');
        }
      });
    };

    applyFocusedAccount();
  }

  function updateEomDashboardView(view){
    const panels = Array.from(document.querySelectorAll('.eom-dashboard-panel'));
    if(!panels.length) return;
    let desired = view || 'overview';
    if(!panels.some(panel => panel.dataset.panel === desired)){
      desired = panels[0].dataset.panel || 'overview';
    }
    const nav = document.getElementById('eom-dashboard-nav');
    panels.forEach(panel => {
      const match = panel.dataset.panel === desired;
      panel.classList.toggle('is-active', match);
      if(match){
        panel.removeAttribute('hidden');
      } else {
        panel.setAttribute('hidden', '');
      }
    });
    if(nav){
      nav.querySelectorAll('[data-panel]').forEach(btn => {
        const match = btn.dataset.panel === desired;
        btn.classList.toggle('is-active', match);
        if(btn.getAttribute('role') === 'tab'){
          btn.setAttribute('aria-selected', match ? 'true' : 'false');
          btn.setAttribute('tabindex', match ? '0' : '-1');
        }
      });
    }
    if(eomUiState.dashboardView !== desired){
      eomUiState.dashboardView = desired;
      saveEomUiState();
    }
  }

  function buildEomAccountPerformanceCard(ctx, stat, options={}){
    const tone = options.tone === 'negative' ? 'negative' : 'positive';
    const scenario = options.scenario || stat.scenario || 'actual';
    const alertText = options.alert || detectEomAccountAlert(stat, scenario);

    const card = document.createElement('button');
    card.type = 'button';
    card.className = `eom-account-card ${tone}`;
    if(eomUiState.focusedAccountId === stat.account.id){
      card.classList.add('is-focused');
    }
    card.dataset.accountId = stat.account.id;

    const deltaLabel = Number.isFinite(stat.delta)
      ? `${stat.delta >= 0 ? '+' : ''}${fmt(stat.delta, state.currency)}`
      : '—';
    const pctLabel = Number.isFinite(stat.deltaPct)
      ? `${stat.deltaPct >= 0 ? '+' : ''}${stat.deltaPct.toFixed(1)}%`
      : '—';
    const currentLabel = Number.isFinite(stat.current)
      ? fmt(stat.current, state.currency)
      : (Number.isFinite(stat.previous) ? fmt(stat.previous, state.currency) : '—');
    const previousLabel = Number.isFinite(stat.previous)
      ? fmt(stat.previous, state.currency)
      : '—';
    const monthLabel = stat.currentYm || stat.previousYm || ctx.focusMonth || '';

    const header = document.createElement('div');
    header.className = 'eom-account-card-header';
    const nameEl = document.createElement('span');
    nameEl.className = 'eom-account-name';
    nameEl.textContent = stat.account.name;
    header.appendChild(nameEl);
    const deltaEl = document.createElement('span');
    const deltaClass = tone === 'negative'
      ? (Number.isFinite(stat.delta) && stat.delta < 0 ? 'negative' : 'attention')
      : (Number.isFinite(stat.delta) && stat.delta < 0 ? 'negative' : 'positive');
    deltaEl.className = `eom-account-delta ${deltaClass}`;
    deltaEl.textContent = deltaLabel;
    header.appendChild(deltaEl);
    card.appendChild(header);

    const meta = document.createElement('div');
    meta.className = 'eom-account-meta';
    const pctEl = document.createElement('span');
    pctEl.textContent = pctLabel;
    meta.appendChild(pctEl);
    const balanceEl = document.createElement('span');
    balanceEl.className = 'tiny muted';
    balanceEl.textContent = `Saldo: ${currentLabel}${monthLabel ? ` (${monthLabel})` : ''}`;
    meta.appendChild(balanceEl);
    card.appendChild(meta);

    if(alertText){
      const badge = document.createElement('span');
      badge.className = 'eom-account-alert';
      badge.textContent = alertText;
      card.appendChild(badge);
    }

    const sparkWrap = document.createElement('div');
    sparkWrap.className = 'eom-account-spark';
    const canvas = document.createElement('canvas');
    canvas.dataset.spark = stat.account.id;
    let values = (stat.history || [])
      .slice(-6)
      .map(item => {
        const adjusted = applyScenarioToValue(item.balance, scenario);
        return typeof adjusted === 'number' && Number.isFinite(adjusted) ? adjusted : null;
      })
      .filter(val => val !== null);
    if(!values.length){
      const fallback = Number.isFinite(stat.current)
        ? stat.current
        : (Number.isFinite(stat.previous) ? stat.previous : 0);
      values = [fallback, fallback];
    } else if(values.length === 1){
      values = [values[0], values[0]];
    }
    canvas.dataset.values = values.map(val => Number(val.toFixed(2))).join(',');
    canvas.dataset.color = tone === 'negative' ? 'var(--red)' : 'var(--green)';
    sparkWrap.appendChild(canvas);
    card.appendChild(sparkWrap);

    card.title = [
      `Konto: ${stat.account.name}`,
      `Aktualne saldo: ${currentLabel}${monthLabel ? ` (${monthLabel})` : ''}`,
      `Poprzednio: ${previousLabel}${stat.previousYm ? ` (${stat.previousYm})` : ''}`,
      `Zmiana m/m: ${deltaLabel}${pctLabel !== '—' ? ` (${pctLabel})` : ''}`
    ].join('\n');

    card.addEventListener('click', () => {
      eomUiState.focusedAccountId = stat.account.id;
      eomUiState.dashboardView = 'accounts';
      saveEomUiState();
      renderEOM();
      const target = document.getElementById('eom-grid');
      if(target){
        requestAnimationFrame(() => {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      }
    });

    return card;
  }

  function detectEomAccountAlert(stat, scenario){
    const history = stat.history || [];
    let worseningDebt = 0;
    for(let i = Math.max(1, history.length - 3); i < history.length; i++){
      const prevEntry = history[i - 1];
      const currentEntry = history[i];
      const prevVal = prevEntry ? applyScenarioToValue(prevEntry.balance, scenario) : null;
      const currVal = currentEntry ? applyScenarioToValue(currentEntry.balance, scenario) : null;
      if(typeof prevVal === 'number' && typeof currVal === 'number' && prevVal < 0 && currVal < 0 && currVal < prevVal){
        worseningDebt += 1;
      } else {
        worseningDebt = 0;
      }
    }
    if(worseningDebt >= 3){
      return 'Dług rośnie 3 mies.';
    }
    if(stat.deltaPct !== null && Math.abs(stat.deltaPct) >= 50){
      return stat.deltaPct > 0 ? 'Skok >50%' : 'Spadek >50%';
    }
    return null;
  }

  function drawMiniSparkline(canvas, values, options={}){
    if(!canvas) return;
    const ctx2d = canvas.getContext('2d');
    if(!ctx2d) return;
    const width = canvas.clientWidth || 120;
    const height = canvas.clientHeight || 30;
    const ratio = typeof window !== 'undefined' ? (window.devicePixelRatio || 1) : 1;
    canvas.width = width * ratio;
    canvas.height = height * ratio;
    ctx2d.setTransform(ratio, 0, 0, ratio, 0, 0);
    ctx2d.clearRect(0, 0, width, height);

    if(!values.length){
      ctx2d.strokeStyle = 'rgba(148, 163, 184, 0.45)';
      ctx2d.lineWidth = 1.5;
      ctx2d.beginPath();
      ctx2d.moveTo(0, height / 2);
      ctx2d.lineTo(width, height / 2);
      ctx2d.stroke();
      return;
    }

    const min = Math.min(...values);
    const max = Math.max(...values);
    const range = max - min || 1;
    const step = values.length > 1 ? width / (values.length - 1) : width;

    ctx2d.lineWidth = 2;
    ctx2d.lineJoin = 'round';
    ctx2d.lineCap = 'round';
    ctx2d.strokeStyle = options.color || 'var(--accent)';
    ctx2d.beginPath();
    values.forEach((val, idx) => {
      const ratioY = range === 0 ? 0.5 : (val - min) / range;
      const x = idx * step;
      const y = height - ratioY * (height - 6) - 3;
      if(idx === 0) ctx2d.moveTo(x, y); else ctx2d.lineTo(x, y);
    });
    ctx2d.stroke();

    ctx2d.fillStyle = options.pointColor || ctx2d.strokeStyle;
    values.forEach((val, idx) => {
      const ratioY = range === 0 ? 0.5 : (val - min) / range;
      const x = idx * step;
      const y = height - ratioY * (height - 6) - 3;
      ctx2d.beginPath();
      ctx2d.arc(x, y, 2.5, 0, Math.PI * 2);
      ctx2d.fill();
    });
  }

  function renderEomMonthlySummary(summaryRows, options={}){
    const table = document.getElementById('eom-monthly-summary');
    if(!table) return;
    const scenarioKey = options.scenario || 'actual';
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if(thead) thead.innerHTML = '';
    if(tbody) tbody.innerHTML = '';
    if(!summaryRows.length){
      if(tbody) tbody.innerHTML = `<tr><td colspan="8" class="muted" style="text-align:center;padding:16px;">Brak danych historycznych do zestawienia.</td></tr>`;
      return;
    }
    if(!thead || !tbody) return;
    const sortState = eomUiState.monthlySort;
    const cols = [
      { label:'Miesiąc', key:'ym' },
      { label:'Majątek netto', key:'netWorth' },
      { label:'Zmiana m/m', key:'delta' },
      { label:'Największy wzrost', key:'best' },
      { label:'Największy spadek', key:'worst' },
      { label:'Saldo dodatnie', key:'positive' },
      { label:'Saldo ujemne', key:'negative' },
      { label:'Udział długu', key:'debtShare' }
    ];
    thead.innerHTML = '<tr>' + cols.map(col => {
      const active = sortState.field === col.key;
      const indicator = active ? `<span class="sort-indicator">${sortState.dir === 'asc' ? '▲' : '▼'}</span>` : '';
      return `<th data-sort="${col.key}">${col.label}${indicator}</th>`;
    }).join('') + '</tr>';

    const rows = [...summaryRows];
    rows.sort((a,b) => {
      const dir = sortState.dir === 'asc' ? 1 : -1;
      const key = sortState.field;
      if(key === 'ym') return a.ym.localeCompare(b.ym) * dir;
      if(key === 'best'){
        const av = a.best ? a.best.delta : -Infinity;
        const bv = b.best ? b.best.delta : -Infinity;
        if(av === bv) return a.ym.localeCompare(b.ym) * dir;
        return (av - bv) * dir;
      }
      if(key === 'worst'){
        const av = a.worst ? a.worst.delta : Infinity;
        const bv = b.worst ? b.worst.delta : Infinity;
        if(av === bv) return a.ym.localeCompare(b.ym) * dir;
        return (av - bv) * dir;
      }
      const av = Number(a[key] ?? 0);
      const bv = Number(b[key] ?? 0);
      if(av === bv) return a.ym.localeCompare(b.ym) * dir;
      return (av - bv) * dir;
    });

    tbody.innerHTML = rows.map(row => {
      const deltaHtml = row.delta === null ? '<span class="muted">—</span>' : renderDeltaBadge(row.delta);
      const bestHtml = row.best
        ? `<div>${row.best.account.name}</div><div class="tiny ok">${row.best.delta > 0 ? '+' : ''}${fmt(row.best.delta, state.currency)}</div>`
        : '<span class="muted">—</span>';
      const worstHtml = row.worst
        ? `<div>${row.worst.account.name}</div><div class="tiny bad">${row.worst.delta > 0 ? '+' : ''}${fmt(row.worst.delta, state.currency)}</div>`
        : '<span class="muted">—</span>';
      return `<tr><td><b>${row.ym}</b></td><td>${fmt(row.netWorth, state.currency)}</td><td>${deltaHtml}</td><td>${bestHtml}</td><td>${worstHtml}</td><td>${fmt(row.positive, state.currency)}</td><td>${fmt(Math.abs(row.negative), state.currency)}</td><td>${row.debtShare.toFixed(1)}%</td></tr>`;
    }).join('');

    thead.querySelectorAll('th[data-sort]').forEach(th => {
      const key = th.dataset.sort;
      th.onclick = () => {
        if(eomUiState.monthlySort.field === key){
          eomUiState.monthlySort.dir = eomUiState.monthlySort.dir === 'asc' ? 'desc' : 'asc';
        } else {
          eomUiState.monthlySort.field = key;
          eomUiState.monthlySort.dir = key === 'ym' ? 'desc' : 'desc';
        }
        renderEOMHistory();
      };
    });
  }

  function cssVar(name, fallback=''){
    try{
      const value = getComputedStyle(document.documentElement).getPropertyValue(name);
      return value ? value.trim() : fallback;
    }catch(err){
      return fallback;
    }
  }

  function colorWithAlpha(color, alpha){
    if(color === undefined || color === null){
      return `rgba(37,99,235,${alpha})`;
    }
    const value = String(color).trim();
    if(value.startsWith('#')) return withAlpha(value, alpha);
    if(value.startsWith('rgba')){
      const parts = value.replace(/rgba\(|\)/g,'').split(',').map(p=>p.trim()).slice(0,3);
      if(parts.length===3) return `rgba(${parts[0]},${parts[1]},${parts[2]},${alpha})`;
      return value;
    }
    if(value.startsWith('rgb')){
      const parts = value.replace(/rgb\(|\)/g,'').split(',').map(p=>p.trim()).slice(0,3);
      if(parts.length===3) return `rgba(${parts[0]},${parts[1]},${parts[2]},${alpha})`;
      return value;
    }
    if(value.startsWith('hsl') && value.includes('/')){
      return value.replace(/\/[^)]+\)/, `/ ${alpha})`);
    }
    if(value.startsWith('hsl')){
      return `${value.replace(/\)$/, '')} / ${alpha})`;
    }
    return value;
  }

  function updateNetWorthRangeTabs(activeRange){
    const tabs = document.querySelectorAll('[data-range-tab]');
    tabs.forEach(tab => {
      const value = tab.dataset.rangeTab;
      tab.classList.toggle('is-active', value === activeRange);
      if(!tab.dataset.bound){
        tab.dataset.bound = '1';
        tab.addEventListener('click', () => {
          const next = tab.dataset.rangeTab;
          if(!next || next === eomUiState.netWorthRange) return;
          eomUiState.netWorthRange = next;
          saveEomUiState();
          renderEOMHistory();
        });
      }
    });
  }

  function renderMomDetailForecastChart(forecast,palette){
    const canvas=document.getElementById('mom-detail-forecast-chart');
    if(!canvas || !forecast){
      destroyMomDetailForecastChart();
      return;
    }
    const ctx=canvas.getContext('2d');
    if(!ctx){
      destroyMomDetailForecastChart();
      return;
    }
    destroyMomDetailForecastChart();
    const labels=forecast.labels;
    const actual=forecast.actualCumulative;
    const projected=forecast.projectedCumulative;
    const realisticLabel=forecast.realisticLabel||'Prognoza';
    const actualColor=colorWithAlpha(palette.ink,0.85);
    const forecastColor=colorWithAlpha(palette.negative,0.9);
    momDetailForecastChart=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[
          {
            label:'Faktycznie',
            data:actual,
            borderColor:actualColor,
            backgroundColor:colorWithAlpha(palette.ink,0.12),
            borderWidth:2,
            tension:0.32,
            fill:false,
            spanGaps:false,
            pointRadius:3,
            pointHoverRadius:4,
            segment:{borderDash:ctx=>ctx.p0?.skip&&ctx.p1?.skip?[6,6]:undefined}
          },
          {
            label:`Prognoza (${realisticLabel})`,
            data:projected,
            borderColor:forecastColor,
            backgroundColor:colorWithAlpha(palette.negative,0.08),
            borderWidth:2,
            tension:0.34,
            fill:false,
            spanGaps:true,
            pointRadius:0,
            borderDash:[6,5]
          }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'nearest',intersect:false},
        plugins:{
          legend:{labels:{color:palette.ink,font:{size:12}}},
          tooltip:{
            callbacks:{
              label(context){
                const value=context.parsed.y;
                if(!Number.isFinite(value)) return context.dataset.label||'';
                return `${context.dataset.label||''}: ${fmt(value,state.currency)}`;
              }
            }
          }
        },
        scales:{
          x:{
            ticks:{color:palette.muted,font:{size:11}},
            grid:{color:colorWithAlpha(palette.muted,0.18)}
          },
          y:{
            beginAtZero:true,
            ticks:{
              color:palette.muted,
              font:{size:11},
              callback(value){
                return fmt(value,state.currency);
              }
            },
            grid:{color:colorWithAlpha(palette.muted,0.14)}
          }
        }
      }
    });
  }

  function renderNetWorthMonthCard(detail){
    const container = document.getElementById('eom-networth-month-card');
    if(!container) return;
    if(!detail){
      container.classList.add('is-empty');
      container.innerHTML = 'Brak danych dla tego zakresu. Dodaj zapisy lub zmodyfikuj filtry, aby zobaczyć szczegóły.';
      return;
    }
    container.classList.remove('is-empty');
    const deltaClass = detail.delta === null ? 'neutral' : detail.delta > 0 ? 'positive' : detail.delta < 0 ? 'negative' : 'neutral';
    const deltaText = detail.delta === null
      ? 'Brak danych porównawczych'
      : `${detail.delta > 0 ? '+' : ''}${fmt(detail.delta, state.currency)}${detail.deltaPct !== null ? ` (${detail.deltaPct > 0 ? '+' : ''}${detail.deltaPct.toFixed(1)}%)` : ''}`;
    const prevLine = detail.prevMonth ? `<span class="muted">vs ${detail.prevMonth}</span>` : '';
    const holdingsHtml = detail.topHoldings.length
      ? detail.topHoldings.map(item => `<li${item.value < 0 ? ' class="negative"' : ''}><span>${item.account.name}${item.share ? ` <span class="tiny muted">${item.share.toFixed(1)}%</span>` : ''}</span><span>${fmt(item.value, state.currency)}</span></li>`).join('')
      : '<li class="muted">Brak danych o kontach</li>';
    const moversHtml = detail.topMovers.length
      ? detail.topMovers.map(item => `<li class="${item.delta >= 0 ? 'positive' : 'negative'}"><span>${item.account.name}</span><span>${item.delta >= 0 ? '+' : ''}${fmt(item.delta, state.currency)}</span></li>`).join('')
      : '<li class="muted">Brak znaczących zmian m/m</li>';
    container.innerHTML = `
      <div class="eom-networth-card-header">
        <span>Okres</span>
        <span class="eom-networth-card-month">${detail.ym}</span>
      </div>
      <div class="eom-networth-card-total">${fmt(detail.total, state.currency)}</div>
      <div class="eom-networth-card-delta ${deltaClass}">
        <span>${deltaText}</span>
        ${prevLine}
      </div>
      <div class="eom-networth-card-split">
        <span>Aktywa: <strong>${fmt(detail.assets, state.currency)}</strong></span>
        <span>Długi: <strong>${fmt(Math.abs(detail.debt), state.currency)}</strong> (${detail.debtShare.toFixed(1)}%)</span>
      </div>
      <div class="eom-networth-card-list">
        <span>Największe składniki</span>
        <ul>${holdingsHtml}</ul>
      </div>
      <div class="eom-networth-card-list">
        <span>Najmocniejsze ruchy m/m</span>
        <ul>${moversHtml}</ul>
      </div>
    `;
  }

  function updateNetWorthHighlight(chart, focusMonth){
    if(!chart) return;
    const dataset = chart.data?.datasets?.[0];
    if(!dataset) return;
    const details = chart.__details || [];
    const accent = cssVar('--accent','#2563eb');
    const ink = cssVar('--ink','#0f172a');
    const green = cssVar('--green','#22c55e');
    const red = cssVar('--red','#ef4444');
    dataset.pointRadius = details.map(detail => {
      const base = detail.isMax || detail.isMin ? 6 : 4;
      return detail.ym === focusMonth ? Math.max(base, 7) : base;
    });
    dataset.pointHoverRadius = dataset.pointRadius.map(r => r + 2);
    dataset.pointBackgroundColor = details.map(detail => {
      if(detail.ym === focusMonth) return accent || '#2563eb';
      if(detail.isMax) return green || '#22c55e';
      if(detail.isMin) return red || '#ef4444';
      return ink || '#0f172a';
    });
    dataset.pointBorderColor = details.map(detail => {
      if(detail.ym === focusMonth) return colorWithAlpha(accent || '#2563eb', 0.75);
      if(detail.isMax) return colorWithAlpha(green || '#22c55e', 0.45);
      if(detail.isMin) return colorWithAlpha(red || '#ef4444', 0.45);
      return colorWithAlpha(accent || '#2563eb', 0.25);
    });
    dataset.pointBorderWidth = details.map(detail => detail.ym === focusMonth ? 3 : (detail.isMax || detail.isMin ? 2 : 1.5));
    chart.update('none');
  }

  function setNetWorthFocus(month, chart, persist=true){
    if(!chart){
      renderNetWorthMonthCard(null);
      return;
    }
    const details = chart.__details || [];
    const detail = details.find(item => item.ym === month) || details[details.length - 1] || null;
    eomUiState.netWorthFocusMonth = detail ? detail.ym : null;
    if(persist) saveEomUiState();
    updateNetWorthHighlight(chart, eomUiState.netWorthFocusMonth);
    renderNetWorthMonthCard(detail);
  }

  function renderEomNetWorthChart(ctx, options={}){
    const canvas = document.getElementById('eom-networth-chart');
    const emptyState = document.getElementById('eom-networth-empty');
    updateNetWorthRangeTabs(eomUiState.netWorthRange || '6m');
    if(!canvas){
      destroyEomChart('netWorth');
      renderNetWorthMonthCard(null);
      return;
    }
    destroyEomChart('netWorth');
    const scenario = options.scenario || 'actual';
    const typeFilter = new Set(Array.isArray(options.accountTypes) ? options.accountTypes : []);
    const relevantAccounts = ctx.accounts.filter(acc => typeFilter.size === 0 || typeFilter.has(inferAccountType(acc)));
    const baseMonths = getMonthsWithinRange(ctx.months, eomUiState.dateRange);
    const months = baseMonths.length ? baseMonths : ctx.months;
    const rangeKey = eomUiState.netWorthRange || '6m';
    let labels = months.slice();
    if(rangeKey !== 'all'){
      const limit = Number(rangeKey.replace('m','')) || 6;
      labels = labels.slice(-limit);
    }
    if(!labels.length || !relevantAccounts.length){
      if(emptyState) emptyState.classList.add('is-visible');
      renderNetWorthMonthCard(null);
      return;
    }
    if(emptyState) emptyState.classList.remove('is-visible');

    const netWorthForMonth = (ym) => {
      if(!ym) return null;
      const balances = ctx.monthBalances[ym] || {};
      let sum = 0;
      let hasAny = false;
      for(const acc of relevantAccounts){
        const value = balances[acc.id];
        if(value === undefined) continue;
        const adjusted = applyScenarioToValue(value, scenario);
        if(typeof adjusted !== 'number' || Number.isNaN(adjusted)) continue;
        sum += adjusted;
        hasAny = true;
      }
      if(!hasAny) return null;
      return Number(sum.toFixed(2));
    };

    const details = labels.map(ym => {
      const total = netWorthForMonth(ym);
      if(total === null) return null;
      const prevMonth = ctx.months.filter(m => m < ym).pop() || null;
      const prevTotal = prevMonth ? netWorthForMonth(prevMonth) : null;
      const delta = prevTotal !== null && prevTotal !== undefined ? Number((total - prevTotal).toFixed(2)) : null;
      const deltaPct = delta !== null && prevTotal ? (delta / Math.abs(prevTotal)) * 100 : null;
      const breakdown = [];
      let assets = 0;
      let debt = 0;
      const balances = ctx.monthBalances[ym] || {};
      const prevBalances = prevMonth ? (ctx.monthBalances[prevMonth] || {}) : {};
      for(const acc of relevantAccounts){
        const raw = balances[acc.id];
        if(raw === undefined) continue;
        const value = applyScenarioToValue(raw, scenario);
        if(typeof value !== 'number' || Number.isNaN(value)) continue;
        const prevRaw = prevBalances[acc.id];
        const prevVal = prevRaw === undefined ? null : applyScenarioToValue(prevRaw, scenario);
        const deltaAcc = prevVal === null || prevVal === undefined ? value : Number((value - prevVal).toFixed(2));
        if(value >= 0) assets += value; else debt += value;
        breakdown.push({ account: acc, value, delta: deltaAcc, previous: prevVal });
      }
      const shareBase = assets + Math.abs(debt);
      const topHoldings = breakdown.length
        ? [...breakdown].sort((a,b) => Math.abs(b.value) - Math.abs(a.value)).slice(0,3).map(item => ({
            account:item.account,
            value:item.value,
            share: shareBase ? (Math.abs(item.value) / shareBase) * 100 : 0
          }))
        : [];
      const movers = breakdown.filter(item => item.delta !== null && item.delta !== undefined && Math.abs(item.delta) >= 0.005);
      const topMovers = movers.length
        ? [...movers].sort((a,b) => Math.abs(b.delta) - Math.abs(a.delta)).slice(0,3)
        : [];
      const debtShare = shareBase ? (Math.abs(debt) / shareBase) * 100 : 0;
      return {
        ym,
        total,
        prevMonth,
        delta,
        deltaPct,
        assets: Number(assets.toFixed(2)),
        debt: Number(debt.toFixed(2)),
        debtShare,
        topHoldings,
        topMovers,
        breakdown
      };
    }).filter(Boolean);

    if(!details.length){
      renderNetWorthMonthCard(null);
      return;
    }

    const maxDetail = details.reduce((best, item) => (!best || item.total > best.total) ? item : best, null);
    const minDetail = details.reduce((worst, item) => (!worst || item.total < worst.total) ? item : worst, null);
    details.forEach(detail => {
      detail.isMax = !!(maxDetail && detail.ym === maxDetail.ym);
      detail.isMin = !!(minDetail && detail.ym === minDetail.ym);
      const holdings = detail.topHoldings.length
        ? detail.topHoldings
        : [...detail.breakdown].sort((a,b) => Math.abs(b.value) - Math.abs(a.value)).slice(0,3).map(item => ({ account:item.account, value:item.value, share:0 }));
      detail.tooltipHoldings = holdings.map(item => ({ account:item.account, value:item.value, share:item.share ?? 0 }));
    });

    const accent = cssVar('--accent','#2563eb');
    const ink = cssVar('--ink','#0f172a');
    const green = cssVar('--green','#22c55e');
    const red = cssVar('--red','#ef4444');
    const datasetColor = accent || '#2563eb';
    const data = details.map(detail => detail.total);
    const ctx2d = canvas.getContext('2d');

    eomCharts.netWorth = new Chart(ctx2d, {
      type:'line',
      data:{
        labels: details.map(detail => detail.ym),
        datasets:[{
          label:`Majątek netto (${EOM_SCENARIOS[scenario]?.label || 'Realny'})`,
          data,
          tension:0.35,
          borderWidth:2.5,
          borderColor: datasetColor,
          fill:true,
          pointHitRadius:14,
          pointHoverBorderWidth:3,
          pointRadius: details.map(detail => detail.isMax || detail.isMin ? 6 : 4),
          pointHoverRadius: details.map(detail => detail.isMax || detail.isMin ? 7 : 6),
          pointBackgroundColor: details.map(detail => detail.isMax ? (green || '#22c55e') : detail.isMin ? (red || '#ef4444') : (ink || '#0f172a')),
          pointBorderColor: details.map(detail => colorWithAlpha(datasetColor, detail.isMax || detail.isMin ? 0.45 : 0.25)),
          pointBorderWidth: details.map(detail => detail.isMax || detail.isMin ? 2 : 1.5),
          backgroundColor: (ctxGradient) => {
            const chartArea = ctxGradient.chart.chartArea;
            if(!chartArea){
              return colorWithAlpha(datasetColor, 0.16);
            }
            const gradient = ctxGradient.chart.ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
            gradient.addColorStop(0, colorWithAlpha(datasetColor, 0.28));
            gradient.addColorStop(1, colorWithAlpha(datasetColor, 0));
            return gradient;
          }
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        plugins:{
          legend:{ display:false },
          tooltip:{
            displayColors:false,
            callbacks:{
              title: items => items[0]?.label ? `Miesiąc ${items[0].label}` : '',
              label: context => `${fmt(context.parsed.y, state.currency)}`,
              afterBody: items => {
                if(!items.length) return [];
                const detail = details[items[0].dataIndex];
                if(!detail || !detail.tooltipHoldings.length) return [];
                const lines = detail.tooltipHoldings.map(item => ` ${item.account.name}: ${fmt(item.value, state.currency)}${item.share ? ` (${item.share.toFixed(1)}%)` : ''}`);
                return ['Top konta:'].concat(lines);
              },
              footer: items => {
                if(!items.length) return '';
                const detail = details[items[0].dataIndex];
                if(!detail || detail.delta === null) return '';
                const sign = detail.delta > 0 ? '+' : '';
                const pct = detail.deltaPct !== null ? ` (${detail.deltaPct > 0 ? '+' : ''}${detail.deltaPct.toFixed(1)}%)` : '';
                return `Δ m/m: ${sign}${fmt(detail.delta, state.currency)}${pct}`;
              }
            }
          }
        },
        layout:{ padding:{ top:8, right:12, bottom:8, left:12 } },
        scales:{
          x:{
            grid:{ display:false },
            ticks:{ maxRotation:0 }
          },
          y:{
            ticks:{ callback: currencyTicks },
            grid:{ drawBorder:false, color: colorWithAlpha(ink || '#0f172a', 0.08) }
          }
        },
        onHover:(evt, elements)=>{
          const target = evt?.native?.target;
          if(target){
            target.style.cursor = elements.length ? 'pointer' : 'default';
          }
        },
        onClick:(evt)=>{
          const chart = eomCharts.netWorth;
          if(!chart) return;
          const elements = chart.getElementsAtEventForMode(evt,'nearest',{ intersect:false },true);
          if(!elements.length) return;
          const idx = elements[0].index;
          const detail = details[idx];
          if(detail){
            setNetWorthFocus(detail.ym, chart, true);
          }
        }
      }
    });

    eomCharts.netWorth.__details = details;
    const focusCandidate = eomUiState.netWorthFocusMonth && details.some(detail => detail.ym === eomUiState.netWorthFocusMonth)
      ? eomUiState.netWorthFocusMonth
      : details[details.length - 1].ym;
    setNetWorthFocus(focusCandidate, eomCharts.netWorth, false);

    if(!canvas.dataset.networthBound){
      canvas.dataset.networthBound = '1';
      canvas.addEventListener('dblclick', evt => {
        const chart = eomCharts.netWorth;
        if(!chart) return;
        const elements = chart.getElementsAtEventForMode(evt,'nearest',{ intersect:false },true);
        if(!elements.length){
          eomUiState.dateRange = { from:null, to:null };
          renderEOM();
          renderEOMHistory();
          return;
        }
        const idx = elements[0].index;
        const labels = chart.data.labels || [];
        if(!labels.length) return;
        const start = Math.max(0, idx - 1);
        const end = Math.min(labels.length - 1, idx + 1);
        eomUiState.dateRange = { from: labels[start], to: labels[end] };
        renderEOM();
        renderEOMHistory();
      });
    }
  }

  // ===== EOM V2 — Redesigned Wealth Tracker =================================
  let eom2NwChart=null, eom2BreakdownChart=null, eom2DdChart=null;
  let eom2SelectedRange=6;
  let eom2SelectedCat='all';
  let eom2Bound=false;
  const eom2TypeOrder=['oszczędności','inwestycje','gotówka','emerytura','zadłużenie','inne'];
  const eom2TypeLabelMap={'oszczędności':'Oszczędności','inwestycje':'Inwestycje','gotówka':'Gotówka','emerytura':'Emerytura','zadłużenie':'Zobowiązania','inne':'Inne'};
  const eom2TypeColorMap={'oszczędności':'#2563eb','inwestycje':'#8b5cf6','gotówka':'#059669','emerytura':'#0ea5e9','zadłużenie':'#dc2626','inne':'#94a3b8'};

  function renderEomV2(){
    const ctx=buildEomContext();
    const cur=state.currency;
    const accounts=ctx.accounts;
    const el=id=>document.getElementById(id);

    // --- Month selector ---
    const monthSel=el('eom2-month-select');
    if(monthSel){
      const allMonths=[...new Set([...ctx.months,ctx.workingYm])].sort();
      const prev=monthSel.value;
      monthSel.innerHTML='';
      for(const m of allMonths.reverse()) monthSel.add(new Option(formatMonthLabel(m),m,false,m===ctx.workingYm));
      if(prev&&allMonths.includes(prev)) monthSel.value=prev;
      else monthSel.value=ctx.workingYm;
    }

    const activeYm=monthSel?.value||ctx.workingYm;
    const prevYm=ctx.months.filter(m=>m<activeYm).pop()||null;
    const activeBalances=ctx.monthBalances[activeYm]||{};
    const prevBalances=prevYm?(ctx.monthBalances[prevYm]||{}):{};

    el('eom2-month-label').textContent=formatMonthLabel(activeYm);

    // --- KPIs ---
    const netWorth=sumBalances(activeBalances);
    const prevNetWorth=prevYm?sumBalances(prevBalances):null;
    const change=prevNetWorth!==null?(netWorth-prevNetWorth):null;
    const changePct=prevNetWorth&&prevNetWorth!==0?((change/Math.abs(prevNetWorth))*100):null;

    el('eom2-kpi-nw').textContent=Object.keys(activeBalances).length?fmt(netWorth,cur):'—';
    el('eom2-kpi-nw-sub').textContent=Object.keys(activeBalances).length?`${Object.keys(activeBalances).length} kont zaksięgowanych`:'Uzupełnij salda poniżej';

    if(change!==null){
      el('eom2-kpi-change').textContent=`${change>=0?'+':''}${fmt(change,cur)}`;
      el('eom2-kpi-change-sub').textContent=changePct!==null?`${changePct>=0?'+':''}${changePct.toFixed(1)}% vs ${formatMonthLabel(prevYm)}`:'';
      const chCard=el('eom2-kpi-change-card');
      if(chCard) chCard.className='eom2-kpi '+(change>0?'positive':change<0?'negative':'');
    } else {
      el('eom2-kpi-change').textContent='—';
      el('eom2-kpi-change-sub').textContent='Brak poprzedniego miesiąca';
    }

    let totalAssets=0, totalDebt=0, assetCount=0, debtCount=0;
    for(const acc of accounts){
      const bal=activeBalances[acc.id];
      if(bal===undefined) continue;
      if(bal>=0){totalAssets+=bal;assetCount++;}
      else{totalDebt+=bal;debtCount++;}
    }
    el('eom2-kpi-assets').textContent=totalAssets>0?fmt(totalAssets,cur):'—';
    el('eom2-kpi-assets-sub').textContent=assetCount?`${assetCount} kont`:'';
    el('eom2-kpi-debt').textContent=totalDebt<0?fmt(totalDebt,cur):'—';
    el('eom2-kpi-debt-sub').textContent=debtCount?`${debtCount} kont`:'Brak zobowiązań';

    // --- Booking Grid ---
    const grid=el('eom2-booking-grid');
    if(grid){
      grid.innerHTML='';
      // Group accounts by type
      const grouped={};
      for(const acc of accounts){
        const type=inferAccountType(acc);
        if(!grouped[type]) grouped[type]=[];
        grouped[type].push(acc);
      }
      for(const type of eom2TypeOrder){
        const accs=grouped[type];
        if(!accs||!accs.length) continue;
        const groupDiv=document.createElement('div');
        groupDiv.className='eom2-booking-group';
        groupDiv.innerHTML=`<div class="eom2-booking-group-title"><span>${escapeHtml(eom2TypeLabelMap[type]||type)}</span><span class="eom2-booking-group-summary" data-group-delta="${type}">—</span></div>`;

        for(const acc of accs){
          const prevBal=prevBalances[acc.id];
          const curBal=activeBalances[acc.id];
          const row=document.createElement('div');
          row.className='eom2-booking-row';
          const color=eom2TypeColorMap[type]||'#94a3b8';
          row.innerHTML=`
            <div class="eom2-booking-name">${escapeHtml(acc.name)}<span class="type-badge" style="background:${colorWithAlpha(color,.12)};color:${color}">${escapeHtml(eom2TypeLabelMap[type]||type)}</span></div>
            <div class="eom2-booking-prev">${prevBal!==undefined?fmt(prevBal,cur):'—'}</div>
            <div class="eom2-booking-input"><input type="text" inputmode="decimal" data-acc-id="${acc.id}" value="${curBal!==undefined?String(curBal).replace('.',','):''}" placeholder="0,00" /></div>
            <div class="eom2-booking-delta" data-delta-for="${acc.id}"></div>
            <div class="eom2-booking-actions"><button type="button" data-del-acc="${acc.id}" title="Usuń konto">✕</button></div>`;
          groupDiv.appendChild(row);
        }
        grid.appendChild(groupDiv);
      }

      // Live delta updates
      const updateBookingTotals=()=>{
        let total=0;
        const byType={};
        const byTypeHasPrev={};
        grid.querySelectorAll('input[data-acc-id]').forEach(i=>{
          const accId=i.dataset.accId;
          const acc=accounts.find(a=>a.id===accId);
          if(!acc) return;
          const type=inferAccountType(acc);
          if(i.value.trim()){
            const currentVal=num(i.value);
            total+=currentVal;
            const prev=prevBalances[accId];
            if(prev!==undefined){
              byType[type]=(byType[type]||0)+(currentVal-prev);
              byTypeHasPrev[type]=true;
            }
          }
        });
        const liveTotal=el('eom2-live-total');
        if(liveTotal) liveTotal.textContent=`Netto: ${fmt(total,cur)}`;
        grid.querySelectorAll('[data-group-delta]').forEach(summary=>{
          const type=summary.dataset.groupDelta;
          const delta=byType[type]||0;
          if(byTypeHasPrev[type]){
            summary.textContent=`${delta>=0?'+':''}${fmt(delta,cur)}`;
            summary.className='eom2-booking-group-summary '+(delta>0?'pos':delta<0?'neg':'');
          } else {
            summary.textContent='—';
            summary.className='eom2-booking-group-summary';
          }
        });
      };
      grid.querySelectorAll('input[data-acc-id]').forEach(inp=>{
        const updateDelta=()=>{
          const accId=inp.dataset.accId;
          const val=num(inp.value);
          const prev=prevBalances[accId];
          const deltaEl=grid.querySelector(`[data-delta-for="${accId}"]`);
          if(!deltaEl) return;
          if(prev!==undefined&&inp.value.trim()){
            const d=val-prev;
            deltaEl.textContent=`${d>=0?'+':''}${fmt(d,cur)}`;
            deltaEl.className='eom2-booking-delta '+(d>0?'pos':d<0?'neg':'');
          } else {
            deltaEl.textContent='';
            deltaEl.className='eom2-booking-delta';
          }
          updateBookingTotals();
        };
        inp.addEventListener('input',updateDelta);
        updateDelta(); // init
      });

      // Delete account buttons
      grid.querySelectorAll('[data-del-acc]').forEach(btn=>{
        btn.onclick=()=>{
          const accId=btn.dataset.delAcc;
          const acc=accounts.find(a=>a.id===accId);
          if(!confirm(`Usunąć konto "${acc?.name||accId}"? Dane historyczne zostaną zachowane.`)) return;
          b().accounts=b().accounts.filter(a=>a.id!==accId);
          save(state);renderEomV2();
        };
      });
    }

    // --- Net Worth Trend Chart (LINE with category filter) ---
    if(eom2NwChart){eom2NwChart.destroy();eom2NwChart=null;}
    const nwCanvas=el('eom2-nw-chart');
    // populate category filter dropdown
    const catFilter=el('eom2-cat-filter');
    if(catFilter){
      const curVal=eom2SelectedCat;
      const usedTypes=new Set();
      for(const acc of accounts) usedTypes.add(inferAccountType(acc));
      let opts='<option value="all">Wszystkie kategorie</option>';
      for(const t of eom2TypeOrder){
        if(usedTypes.has(t)) opts+=`<option value="${t}">${eom2TypeLabelMap[t]||t}</option>`;
      }
      catFilter.innerHTML=opts;
      catFilter.value=curVal;
    }
    if(nwCanvas){
      let months=ctx.months;
      if(eom2SelectedRange!=='all'){
        const n=parseInt(eom2SelectedRange)||6;
        months=months.slice(-n);
      }
      if(months.length>0){
        const subAccColors=['#f59e0b','#10b981','#6366f1','#ec4899','#14b8a6','#f97316','#8b5cf6','#06b6d4','#e11d48','#84cc16'];
        const datasets=[];
        if(eom2SelectedCat==='all'){
          // "All" mode: show net worth total + one line per category total
          const nwData=months.map(ym=>sumBalances(ctx.monthBalances[ym]||{}));
          datasets.push({label:'Majątek netto',data:nwData,borderColor:'#1e293b',backgroundColor:colorWithAlpha('#1e293b',.06),borderWidth:3,pointRadius:4,pointBackgroundColor:'#1e293b',pointBorderColor:'#fff',pointBorderWidth:2,tension:.3,fill:true});
          const usedTypes=new Set();
          for(const acc of accounts) usedTypes.add(inferAccountType(acc));
          for(const t of eom2TypeOrder){
            if(!usedTypes.has(t)) continue;
            const col=eom2TypeColorMap[t]||'#94a3b8';
            const catData=months.map(ym=>{
              let s=0;
              for(const a of accounts){
                if(inferAccountType(a)!==t) continue;
                const v=(ctx.monthBalances[ym]||{})[a.id];
                if(v!==undefined) s+=v;
              }
              return s;
            });
            datasets.push({label:eom2TypeLabelMap[t]||t,data:catData,borderColor:col,backgroundColor:'transparent',borderWidth:2,pointRadius:3,pointBackgroundColor:col,tension:.3,fill:false});
          }
        } else {
          // Single-category mode: solid total + dashed sub-accounts
          const catAccounts=accounts.filter(a=>inferAccountType(a)===eom2SelectedCat);
          const catColor=eom2TypeColorMap[eom2SelectedCat]||'#94a3b8';
          const totalData=months.map(ym=>{
            let s=0;
            for(const a of catAccounts){const v=(ctx.monthBalances[ym]||{})[a.id];if(v!==undefined)s+=v;}
            return s;
          });
          datasets.push({label:(eom2TypeLabelMap[eom2SelectedCat]||eom2SelectedCat)+' — Suma',data:totalData,borderColor:catColor,backgroundColor:colorWithAlpha(catColor,.08),borderWidth:3,pointRadius:4,pointBackgroundColor:catColor,pointBorderColor:'#fff',pointBorderWidth:2,tension:.3,fill:true});
          catAccounts.forEach((acc,i)=>{
            const col=subAccColors[i%subAccColors.length];
            const accData=months.map(ym=>(ctx.monthBalances[ym]||{})[acc.id]??null);
            datasets.push({label:acc.name,data:accData,borderColor:col,backgroundColor:'transparent',borderWidth:2,borderDash:[6,3],pointRadius:3,pointBackgroundColor:col,tension:.3,fill:false,spanGaps:true});
          });
        }
        eom2NwChart=new Chart(nwCanvas.getContext('2d'),{
          type:'line',
          data:{labels:months.map(m=>formatMonthLabel(m)),datasets},
          options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{position:'bottom',labels:{font:{size:11},usePointStyle:true,pointStyle:'circle'}},tooltip:{mode:'index',intersect:false,callbacks:{label:ctx2=>`${ctx2.dataset.label}: ${currencyTicks(ctx2.parsed.y)}`}}},
            interaction:{mode:'index',intersect:false},
            scales:{x:{grid:{display:false}},y:{ticks:{callback:v=>currencyTicks(v)},grid:{color:'rgba(148,163,184,.08)'}}}
          }
        });
      }
    }

    // --- Breakdown Doughnut ---
    if(eom2BreakdownChart){eom2BreakdownChart.destroy();eom2BreakdownChart=null;}
    const bdCanvas=el('eom2-breakdown-chart');
    if(bdCanvas&&Object.keys(activeBalances).length>0){
      const byType={};
      for(const acc of accounts){
        const bal=activeBalances[acc.id];
        if(bal===undefined) continue;
        const type=inferAccountType(acc);
        byType[type]=(byType[type]||0)+Math.abs(bal);
      }
      const types=Object.keys(byType).filter(t=>byType[t]>0);
      const typeColorMap2={'oszczędności':'#2563eb','inwestycje':'#8b5cf6','gotówka':'#059669','emerytura':'#0ea5e9','zadłużenie':'#ef4444','inne':'#94a3b8'};
      const typeLabelMap2={'oszczędności':'Oszczędności','inwestycje':'Inwestycje','gotówka':'Gotówka','emerytura':'Emerytura','zadłużenie':'Zobowiązania','inne':'Inne'};
      const totalAbs=types.reduce((s,t)=>s+byType[t],0);

      eom2BreakdownChart=new Chart(bdCanvas.getContext('2d'),{
        type:'doughnut',
        data:{
          labels:types.map(t=>typeLabelMap2[t]||t),
          datasets:[{
            data:types.map(t=>byType[t]),
            backgroundColor:types.map(t=>colorWithAlpha(typeColorMap2[t]||'#94a3b8',.8)),
            borderColor:'#fff',borderWidth:2
          }]
        },
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{position:'bottom',labels:{font:{size:11}}},
            tooltip:{callbacks:{label:ctx2=>`${ctx2.label}: ${currencyTicks(ctx2.parsed)} (${totalAbs?((ctx2.parsed/totalAbs)*100).toFixed(1):'0'}%)`}}}
        }
      });
    }

    // --- Bottleneck: Gainers & Losers ---
    const gainersEl=el('eom2-top-gainers');
    const losersEl=el('eom2-top-losers');
    if(gainersEl&&losersEl){
      gainersEl.innerHTML='';losersEl.innerHTML='';
      if(prevYm){
        const deltas=accounts.map(acc=>{
          const cur2=activeBalances[acc.id];
          const prev2=prevBalances[acc.id];
          if(cur2===undefined&&prev2===undefined) return null;
          return {name:acc.name,delta:(cur2||0)-(prev2||0)};
        }).filter(Boolean).filter(d=>d.delta!==0).sort((a,b2)=>b2.delta-a.delta);

        const gainers=deltas.filter(d=>d.delta>0).slice(0,5);
        const losers=deltas.filter(d=>d.delta<0).slice(-5).reverse();

        if(!gainers.length) gainersEl.innerHTML='<div class="muted" style="padding:10px;font-size:12px">Brak wzrostów w tym miesiącu</div>';
        for(const g of gainers){
          const div=document.createElement('div');
          div.className='eom2-gainer-item';
          div.innerHTML=`<span class="eom2-gainer-name">${escapeHtml(g.name)}</span><span class="eom2-gainer-delta pos">+${fmt(g.delta,cur)}</span>`;
          gainersEl.appendChild(div);
        }

        if(!losers.length) losersEl.innerHTML='<div class="muted" style="padding:10px;font-size:12px">Brak spadków — dobrze!</div>';
        for(const l of losers){
          const div=document.createElement('div');
          div.className='eom2-gainer-item';
          div.innerHTML=`<span class="eom2-gainer-name">${escapeHtml(l.name)}</span><span class="eom2-gainer-delta neg">${fmt(l.delta,cur)}</span>`;
          losersEl.appendChild(div);
        }
      } else {
        gainersEl.innerHTML='<div class="muted" style="padding:10px;font-size:12px">Potrzeba min. 2 miesięcy danych</div>';
        losersEl.innerHTML='<div class="muted" style="padding:10px;font-size:12px">Potrzeba min. 2 miesięcy danych</div>';
      }
    }

    // --- History Table ---
    const hThead=el('eom2-history-thead');
    const hTbody=el('eom2-history-tbody');
    const hCount=el('eom2-history-count');
    if(hThead&&hTbody){
      hThead.innerHTML='';hTbody.innerHTML='';
      const months=ctx.months.slice(-12);
      if(hCount) hCount.textContent=`(${months.length} mies.)`;
      if(months.length>0){
        // Header: Month | Account1 | Account2 | ... | Net Worth
        const usedAccounts=accounts.filter(a=>months.some(m=>(ctx.monthBalances[m]||{})[a.id]!==undefined));
        let hdr='<tr><th>Miesiąc</th>';
        for(const a of usedAccounts) hdr+=`<th style="text-align:right">${escapeHtml(a.name)}</th>`;
        hdr+='<th style="text-align:right;font-weight:800">Netto</th></tr>';
        hThead.innerHTML=hdr;

        for(const m of [...months].reverse()){
          const bals=ctx.monthBalances[m]||{};
          let row=`<tr><td><strong>${formatMonthLabel(m)}</strong></td>`;
          for(const a of usedAccounts){
            const v=bals[a.id];
            const cls=v!==undefined?(v<0?'inv-pnl-neg':''):'muted';
            row+=`<td style="text-align:right" class="${cls}">${v!==undefined?fmt(v,cur):'—'}</td>`;
          }
          const nw=sumBalances(bals);
          row+=`<td style="text-align:right;font-weight:800">${fmt(nw,cur)}</td></tr>`;
          hTbody.innerHTML+=row;
        }
      } else {
        hTbody.innerHTML='<tr><td colspan="99" style="text-align:center;color:var(--muted);padding:20px">Brak danych historycznych</td></tr>';
      }
    }
  }

  // ---- Deep-Dive Category One-Pager ----
  function renderEomDeepDive(catKey){
    const wrap=el('eom2-deepdive');
    if(!wrap) return;
    if(!catKey||catKey==='all'){wrap.style.display='none';return;}
    wrap.style.display='';
    const ctx=buildEomContext();
    const accounts=(b().accounts||[]);
    const catAccounts=accounts.filter(a=>inferAccountType(a)===catKey);
    const catLabel=eom2TypeLabelMap[catKey]||catKey;
    const catColor=eom2TypeColorMap[catKey]||'#94a3b8';
    const cur=state.modules.budget.currency||'PLN';

    // Title
    const titleEl=el('eom2-dd-title');
    if(titleEl) titleEl.textContent='Deep-dive: '+catLabel;

    // Time range: use all months
    const months=ctx.months;

    // Compute totals per month
    const monthTotals=months.map(ym=>{
      let s=0;
      for(const a of catAccounts){const v=(ctx.monthBalances[ym]||{})[a.id];if(v!==undefined)s+=v;}
      return s;
    });

    // Latest & previous values
    const latest=monthTotals.length?monthTotals[monthTotals.length-1]:0;
    const prev=monthTotals.length>=2?monthTotals[monthTotals.length-2]:0;
    const delta=latest-prev;
    const deltaP=prev?((delta/Math.abs(prev))*100):0;

    // Max & min
    const maxVal=Math.max(...monthTotals,0);
    const minVal=Math.min(...monthTotals,0);

    // Average monthly change
    let avgChange=0;
    if(monthTotals.length>=2){
      const changes=[];
      for(let i=1;i<monthTotals.length;i++) changes.push(monthTotals[i]-monthTotals[i-1]);
      avgChange=changes.reduce((s,v)=>s+v,0)/changes.length;
    }

    // KPIs
    const kpiEl=el('eom2-dd-kpis');
    if(kpiEl){
      const ddChgCls=delta>0?'positive':delta<0?'negative':'';
      kpiEl.innerHTML=`
        <div class="eom2-kpi accent"><span class="kpi-label">Aktualna wartość</span><span class="kpi-val">${fmt(latest,cur)}</span><span class="kpi-sub">${catAccounts.length} kont</span></div>
        <div class="eom2-kpi ${ddChgCls}"><span class="kpi-label">Zmiana m/m</span><span class="kpi-val">${delta>=0?'+':''}${fmt(delta,cur)}</span><span class="kpi-sub">${deltaP>=0?'+':''}${deltaP.toFixed(1)}%</span></div>
        <div class="eom2-kpi"><span class="kpi-label">Śr. zmiana mies.</span><span class="kpi-val">${fmt(avgChange,cur)}</span><span class="kpi-sub">na podstawie ${monthTotals.length} mies.</span></div>
        <div class="eom2-kpi"><span class="kpi-label">Rozpiętość</span><span class="kpi-val">${fmt(maxVal,cur)}</span><span class="kpi-sub">min: ${fmt(minVal,cur)}</span></div>
      `;
    }

    // Chart: total line + dashed per account
    if(eom2DdChart){eom2DdChart.destroy();eom2DdChart=null;}
    const ddCanvas=el('eom2-dd-chart');
    if(ddCanvas&&months.length>0){
      const subAccColors=['#f59e0b','#10b981','#6366f1','#ec4899','#14b8a6','#f97316','#8b5cf6','#06b6d4','#e11d48','#84cc16'];
      const datasets=[{
        label:catLabel+' — Suma',data:monthTotals,borderColor:catColor,backgroundColor:colorWithAlpha(catColor,.08),
        borderWidth:3,pointRadius:4,pointBackgroundColor:catColor,pointBorderColor:'#fff',pointBorderWidth:2,tension:.3,fill:true
      }];
      catAccounts.forEach((acc,i)=>{
        const col=subAccColors[i%subAccColors.length];
        const accData=months.map(ym=>(ctx.monthBalances[ym]||{})[acc.id]??null);
        datasets.push({label:acc.name,data:accData,borderColor:col,backgroundColor:'transparent',borderWidth:2,borderDash:[6,3],pointRadius:3,pointBackgroundColor:col,tension:.3,fill:false,spanGaps:true});
      });
      eom2DdChart=new Chart(ddCanvas.getContext('2d'),{
        type:'line',
        data:{labels:months.map(m=>formatMonthLabel(m)),datasets},
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{position:'bottom',labels:{font:{size:11},usePointStyle:true,pointStyle:'circle'}},tooltip:{mode:'index',intersect:false,callbacks:{label:ctx2=>`${ctx2.dataset.label}: ${currencyTicks(ctx2.parsed.y)}`}}},
          interaction:{mode:'index',intersect:false},
          scales:{x:{grid:{display:false}},y:{ticks:{callback:v=>currencyTicks(v)},grid:{color:'rgba(148,163,184,.08)'}}}
        }
      });
    }

    // Table: month-by-month per account + totals + deltas
    const thead=el('eom2-dd-thead');
    const tbody=el('eom2-dd-tbody');
    if(thead&&tbody){
      thead.innerHTML='';tbody.innerHTML='';
      const dispMonths=months.slice(-12);
      let hdr='<tr><th>Miesiąc</th>';
      for(const a of catAccounts) hdr+=`<th style="text-align:right">${escapeHtml(a.name)}</th>`;
      hdr+='<th style="text-align:right;font-weight:800">Suma</th><th style="text-align:right">Zmiana</th></tr>';
      thead.innerHTML=hdr;

      let prevTotal=null;
      const rows=[...dispMonths].reverse();
      for(const m of rows){
        const bals=ctx.monthBalances[m]||{};
        let row=`<tr><td><strong>${formatMonthLabel(m)}</strong></td>`;
        let total=0;
        for(const a of catAccounts){
          const v=bals[a.id];
          if(v!==undefined) total+=v;
          const cls=v!==undefined?(v<0?'inv-pnl-neg':''):'muted';
          row+=`<td style="text-align:right" class="${cls}">${v!==undefined?fmt(v,cur):'—'}</td>`;
        }
        // Find next month's total (since rows are reversed) for delta
        const mIdx=months.indexOf(m);
        const nextTotal=mIdx<months.length-1?(()=>{let s=0;for(const a of catAccounts){const v=(ctx.monthBalances[months[mIdx+1]]||{})[a.id];if(v!==undefined)s+=v;}return s;})():null;
        const mDelta=mIdx<months.length-1?total-(()=>{let s=0;for(const a of catAccounts){const v=(ctx.monthBalances[months[mIdx-1]]||{})[a.id];if(v!==undefined)s+=v;}return s;})():null;
        // Simpler: compute delta from previous month in chronological order
        const prevMonthIdx=months.indexOf(m)-1;
        let chg=null;
        if(prevMonthIdx>=0){
          let pt=0;for(const a of catAccounts){const v=(ctx.monthBalances[months[prevMonthIdx]]||{})[a.id];if(v!==undefined)pt+=v;}
          chg=total-pt;
        }
        row+=`<td style="text-align:right;font-weight:800">${fmt(total,cur)}</td>`;
        row+=`<td style="text-align:right" class="${chg!==null?(chg>=0?'pos':'inv-pnl-neg'):'muted'}">${chg!==null?((chg>=0?'+':'')+fmt(chg,cur)):'—'}</td>`;
        row+='</tr>';
        tbody.innerHTML+=row;
      }
    }

    // Scroll to deep-dive
    wrap.scrollIntoView({behavior:'smooth',block:'start'});
  }

  function bindEomV2(){
    if(eom2Bound) return;
    eom2Bound=true;

    // Save button
    const saveBtn=document.getElementById('eom2-save');
    if(saveBtn) saveBtn.onclick=()=>{
      const monthSel=document.getElementById('eom2-month-select');
      const ym=monthSel?.value||b().workingMonth;
      const grid=document.getElementById('eom2-booking-grid');
      if(!grid) return;
      // Remove old entries for this month
      b().eom=b().eom.filter(e=>e.ym!==ym);
      // Add new entries
      grid.querySelectorAll('input[data-acc-id]').forEach(inp=>{
        const accId=inp.dataset.accId;
        const val=inp.value.trim();
        if(val) b().eom.push({ym,accountId:accId,balance:num(val)});
      });
      save(state);
      renderEomV2();
    };

    // Copy previous month
    const copyBtn=document.getElementById('eom2-copy-prev');
    if(copyBtn) copyBtn.onclick=()=>{
      const ctx=buildEomContext();
      const monthSel=document.getElementById('eom2-month-select');
      const ym=monthSel?.value||ctx.workingYm;
      const prevYm=ctx.months.filter(m=>m<ym).pop();
      if(!prevYm){alert('Brak poprzedniego miesiąca do skopiowania.');return;}
      const prevBals=ctx.monthBalances[prevYm]||{};
      const grid=document.getElementById('eom2-booking-grid');
      if(!grid) return;
      grid.querySelectorAll('input[data-acc-id]').forEach(inp=>{
        const accId=inp.dataset.accId;
        if(prevBals[accId]!==undefined) inp.value=String(prevBals[accId]).replace('.',',');
        inp.dispatchEvent(new Event('input'));
      });
    };

    // Month selector change
    const monthSel=document.getElementById('eom2-month-select');
    if(monthSel) monthSel.onchange=()=>renderEomV2();

    // Range buttons
    document.querySelectorAll('.eom2-range-btn').forEach(btn=>{
      btn.onclick=()=>{
        eom2SelectedRange=btn.dataset.range==='all'?'all':parseInt(btn.dataset.range);
        document.querySelectorAll('.eom2-range-btn').forEach(b2=>b2.classList.toggle('is-active',b2===btn));
        renderEomV2();
      };
    });

    // Add account form
    const addForm=document.getElementById('eom2-add-account');
    if(addForm) addForm.onsubmit=e=>{
      e.preventDefault();
      const f=new FormData(addForm);
      const name=String(f.get('name')||'').trim();
      const type=String(f.get('type')||'inne');
      if(!name) return;
      const id='a_'+Math.random().toString(36).slice(2);
      b().accounts.push({id,name,kind:type});
      save(state);addForm.reset();renderEomV2();
    };

    // Category filter for net worth chart
    const catFilter=document.getElementById('eom2-cat-filter');
    if(catFilter) catFilter.onchange=()=>{
      eom2SelectedCat=catFilter.value;
      renderEomV2();
      // Also trigger deep-dive if a specific category is selected
      if(eom2SelectedCat!=='all') renderEomDeepDive(eom2SelectedCat);
      else{ const dd=document.getElementById('eom2-deepdive'); if(dd) dd.style.display='none'; }
    };

    // Deep-dive close
    const ddClose=document.getElementById('eom2-dd-close');
    if(ddClose) ddClose.onclick=()=>{
      const dd=document.getElementById('eom2-deepdive');
      if(dd) dd.style.display='none';
    };
  }

  // ===== /EOM V2 ===============================================================

  function renderEOM(){
    return; // replaced by renderEomV2
    const ctx = buildEomContext();
    const ym = ctx.workingYm;
    const prompt = document.getElementById('eom-prompt');
    if(prompt){
      const lastInfo = ctx.hasWorking
        ? 'Masz już zapisane salda dla tego miesiąca — możesz je zaktualizować.'
        : ctx.latestMonth ? `Ostatnio zapisano dane dla ${ctx.latestMonth}.` : 'To będzie Twój pierwszy zapis sald.';
      prompt.innerHTML = `Wprowadź salda swoich kont na koniec miesiąca <b>${ym}</b>. <span class="muted">${lastInfo}</span>`;
    }
    const badge = document.getElementById('eom-active-month');
    if(badge) badge.textContent = ym;

    const dashboardNav = document.getElementById('eom-dashboard-nav');
    if(dashboardNav){
      if(!dashboardNav.dataset.bound){
        dashboardNav.dataset.bound = '1';
        dashboardNav.addEventListener('click', (event) => {
          const btn = event.target.closest('[data-panel]');
          if(!btn) return;
          const next = btn.dataset.panel;
          if(!next) return;
          updateEomDashboardView(next);
        });
      }
      updateEomDashboardView(eomUiState.dashboardView || 'overview');
    }

    renderEomComparison(ctx);

    const sortSelect = document.getElementById('eom-account-sort');
    if(sortSelect){
      sortSelect.value = eomUiState.accountSort || 'balance';
      if(!sortSelect.dataset.bound){
        sortSelect.dataset.bound = '1';
        sortSelect.addEventListener('change', () => {
          eomUiState.accountSort = sortSelect.value;
          renderEOM();
        });
      }
    }

    const positiveBox = document.getElementById('eom-filter-positive');
    const negativeBox = document.getElementById('eom-filter-negative');
    const hideZeroBox = document.getElementById('eom-filter-hide-zero');
    if(positiveBox){
      positiveBox.checked = !!eomUiState.filterPositiveOnly;
      if(!positiveBox.dataset.bound){
        positiveBox.dataset.bound = '1';
        positiveBox.addEventListener('change', () => {
          eomUiState.filterPositiveOnly = positiveBox.checked;
          renderEOM();
        });
      }
    }
    if(negativeBox){
      negativeBox.checked = !!eomUiState.filterNegativeOnly;
      if(!negativeBox.dataset.bound){
        negativeBox.dataset.bound = '1';
        negativeBox.addEventListener('change', () => {
          eomUiState.filterNegativeOnly = negativeBox.checked;
          renderEOM();
        });
      }
    }
    if(hideZeroBox){
      hideZeroBox.checked = !!eomUiState.hideZeroAccounts;
      if(!hideZeroBox.dataset.bound){
        hideZeroBox.dataset.bound = '1';
        hideZeroBox.addEventListener('change', () => {
          eomUiState.hideZeroAccounts = hideZeroBox.checked;
          renderEOM();
        });
      }
    }

    const expandAllBtn = document.getElementById('eom-expand-all');
    if(expandAllBtn && !expandAllBtn.dataset.bound){
      expandAllBtn.dataset.bound = '1';
      expandAllBtn.addEventListener('click', () => {
        const cards = Array.from(document.querySelectorAll('#eom-grid .eom-account-item'));
        eomUiState.expandedAccounts = cards.map(card => card.dataset.accountId).filter(Boolean);
        renderEOM();
      });
    }
    const collapseAllBtn = document.getElementById('eom-collapse-all');
    if(collapseAllBtn && !collapseAllBtn.dataset.bound){
      collapseAllBtn.dataset.bound = '1';
      collapseAllBtn.addEventListener('click', () => {
        eomUiState.expandedAccounts = [];
        renderEOM();
      });
    }

    renderEomAccountTypeConfigurator(ctx);

    const typeSelect = document.getElementById('eom-account-type-filter');
    if(typeSelect){
      const typeOptions = getAccountTypeOptions(ctx.accounts);
      const types = typeOptions.map(opt => opt.value).sort((a,b) => a.localeCompare(b, 'pl', { sensitivity:'base' }));
      const selected = new Set(eomUiState.accountTypes || []);
      const selectAll = selected.size === 0;
      typeSelect.innerHTML = '';
      typeSelect.add(new Option('Wszystkie konta', EOM_ACCOUNT_TYPE_ALL, false, selectAll));
      types.forEach(type => typeSelect.add(new Option(capitalizeFirst(type), type, false, selected.has(type))));
      if(!typeSelect.dataset.bound){
        typeSelect.dataset.bound = '1';
        typeSelect.addEventListener('change', () => {
          const values = Array.from(typeSelect.selectedOptions).map(opt => opt.value);
          if(values.includes(EOM_ACCOUNT_TYPE_ALL)){
            if(values.length > 1){
              const filtered = values.filter(val => val !== EOM_ACCOUNT_TYPE_ALL);
              eomUiState.accountTypes = filtered;
              Array.from(typeSelect.options).forEach(option => {
                option.selected = filtered.includes(option.value);
              });
            } else {
              eomUiState.accountTypes = [];
              Array.from(typeSelect.options).forEach(option => {
                option.selected = option.value === EOM_ACCOUNT_TYPE_ALL;
              });
            }
          } else {
            eomUiState.accountTypes = values;
          }
          renderEOM();
          renderEOMHistory();
        });
      }
    }

    const fromInput = document.getElementById('eom-date-from');
    if(fromInput){
      fromInput.value = eomUiState.dateRange.from || '';
      if(!fromInput.dataset.bound){
        fromInput.dataset.bound = '1';
        fromInput.addEventListener('change', () => {
          eomUiState.dateRange.from = fromInput.value || null;
          renderEOM();
          renderEOMHistory();
        });
      }
    }
    const toInput = document.getElementById('eom-date-to');
    if(toInput){
      toInput.value = eomUiState.dateRange.to || '';
      if(!toInput.dataset.bound){
        toInput.dataset.bound = '1';
        toInput.addEventListener('change', () => {
          eomUiState.dateRange.to = toInput.value || null;
          renderEOM();
          renderEOMHistory();
        });
      }
    }

    const pivotToggle = document.getElementById('eom-pivot-toggle');
    if(pivotToggle){
      pivotToggle.dataset.active = eomUiState.pivotMode ? '1' : '0';
      pivotToggle.textContent = eomUiState.pivotMode ? 'Widok edycyjny' : 'Widok pivot';
      if(!pivotToggle.dataset.bound){
        pivotToggle.dataset.bound = '1';
        pivotToggle.addEventListener('click', () => {
          eomUiState.pivotMode = !eomUiState.pivotMode;
          renderEOM();
        });
      }
    }

    const groupSel = document.getElementById('eom-group-by');
    if(groupSel){
      groupSel.value = eomUiState.groupBy;
      if(!groupSel.dataset.bound){
        groupSel.dataset.bound = '1';
        groupSel.addEventListener('change', () => {
          eomUiState.groupBy = groupSel.value;
          renderEOM();
        });
      }
    }

    const sparkMonths = monthsForSparkline(ctx, eomUiState.dateRange);
    const selectedTypes = new Set(eomUiState.accountTypes || []);
    const wantsPositiveOnly = !!eomUiState.filterPositiveOnly;
    const wantsNegativeOnly = !!eomUiState.filterNegativeOnly;
    const hideZeroAccounts = !!eomUiState.hideZeroAccounts;
    const threshold = 0.005;

    const rows = ctx.accounts.map(acc => {
      const type = inferAccountType(acc);
      if(selectedTypes.size && !selectedTypes.has(type)) return null;
      const history = ctx.accountHistory[acc.id] || [];
      const currentEntry = entryForMonth(history, ym);
      const prevEntry = lastEntryBefore(history, ym);
      const referenceValue = currentEntry ? currentEntry.balance : (prevEntry ? prevEntry.balance : 0);
      const isZero = Math.abs(referenceValue || 0) < threshold;
      if(wantsPositiveOnly && !wantsNegativeOnly && referenceValue <= 0) return null;
      if(!wantsPositiveOnly && wantsNegativeOnly && referenceValue >= 0) return null;
      if(wantsPositiveOnly && wantsNegativeOnly && isZero) return null;
      if(hideZeroAccounts && isZero) return null;
      const currentValue = currentEntry ? currentEntry.balance : null;
      const previousValue = prevEntry ? prevEntry.balance : null;
      const scenarioCurrent = currentValue === null ? null : applyScenarioToValue(currentValue, eomUiState.scenario);
      const scenarioPrevious = previousValue === null ? null : applyScenarioToValue(previousValue, eomUiState.scenario);
      const deltaAdjusted = (scenarioCurrent !== null || scenarioPrevious !== null) ? ((scenarioCurrent ?? 0) - (scenarioPrevious ?? 0)) : null;
      const deltaPct = scenarioPrevious && scenarioPrevious !== 0 ? (deltaAdjusted / Math.abs(scenarioPrevious)) * 100 : null;
      const sparklinePoints = buildSparklinePoints(history, sparkMonths).map(pt => ({ ym: pt.ym, value: applyScenarioToValue(pt.value, eomUiState.scenario) ?? 0 }));
      const adjustedHistory = history.map(item => {
        const value = applyScenarioToValue(item.balance, eomUiState.scenario);
        return { ym: item.ym, value: typeof value === 'number' ? value : null };
      }).filter(item => item.value !== null);
      const lastSix = adjustedHistory.slice(-6);
      const avgSix = lastSix.length ? lastSix.reduce((sum, item) => sum + item.value, 0) / lastSix.length : null;
      const recordEntry = adjustedHistory.reduce((best, item) => (!best || item.value > best.value ? item : best), null);
      const minEntry = adjustedHistory.reduce((worst, item) => (!worst || item.value < worst.value ? item : worst), null);
      let streakDir = null;
      let streakCount = 0;
      for(let i = adjustedHistory.length - 1; i > 0; i--){
        const curr = adjustedHistory[i]?.value;
        const prev = adjustedHistory[i-1]?.value;
        if(typeof curr !== 'number' || typeof prev !== 'number') continue;
        const diff = curr - prev;
        const dir = diff > threshold ? 'up' : diff < -threshold ? 'down' : 'flat';
        if(dir === 'flat'){
          if(streakDir === null) continue;
          else break;
        }
        if(streakDir === null){
          streakDir = dir;
          streakCount = 1;
        } else if(streakDir === dir){
          streakCount += 1;
        } else {
          break;
        }
      }
      let trendDescription = 'Wahania bez wyraźnego trendu';
      if(streakDir === 'up' && streakCount >= 2){
        trendDescription = `Rośnie ${streakCount + 1} miesiąc z rzędu`;
      } else if(streakDir === 'down' && streakCount >= 2){
        trendDescription = `Spada ${streakCount + 1} miesiąc z rzędu`;
      } else if(streakDir === 'up'){
        trendDescription = 'Lekki wzrost w tym miesiącu';
      } else if(streakDir === 'down'){
        trendDescription = 'Lekki spadek w tym miesiącu';
      } else if(Math.abs(deltaAdjusted || 0) < threshold){
        trendDescription = 'Stabilne w ostatnim miesiącu';
      }
      const trendDirection = deltaAdjusted === null ? 'flat' : (deltaAdjusted > threshold ? 'up' : deltaAdjusted < -threshold ? 'down' : 'flat');
      const trendArrow = trendDirection === 'up' ? '↗' : trendDirection === 'down' ? '↘' : '→';
      const deltaDisplay = deltaAdjusted === null ? '—' : `${deltaAdjusted > 0 ? '+' : '−'}${fmt(Math.abs(deltaAdjusted), state.currency)}`;
      const pctDisplay = deltaPct !== null ? `${deltaPct > 0 ? '+' : ''}${deltaPct.toFixed(1)}%` : '—';
      const scenarioBalance = scenarioCurrent !== null ? fmt(scenarioCurrent, state.currency) : (currentValue !== null ? fmt(currentValue, state.currency) : '—');
      const previousDisplay = scenarioPrevious !== null ? fmt(scenarioPrevious, state.currency) : (previousValue !== null ? fmt(previousValue, state.currency) : '—');
      const dormant = history.length >= 3 ? history.slice(-3).every(item => {
        const val = applyScenarioToValue(item.balance, eomUiState.scenario);
        return Math.abs((typeof val === 'number' ? val : 0)) < threshold;
      }) : false;
      const subtitleParts = [capitalizeFirst(type), capitalizeFirst(eomAccountStatus(referenceValue))];
      const subtitle = subtitleParts.filter(Boolean).join(' · ');
      const sparkColor = trendDirection === 'down' ? '#dc2626' : trendDirection === 'up' ? '#16a34a' : '#64748b';
      let deltaLabel = deltaAdjusted === null ? '<span class=\"muted\">—</span>' : renderDeltaBadge(deltaAdjusted);
      const prevBits = [];
      if(previousValue === null){
        prevBits.push('<span class=\"muted\">Brak danych</span>');
      } else {
        prevBits.push(`<strong>${fmt(previousValue, state.currency)}</strong>`);
        if(prevEntry?.ym){
          prevBits.push(`<span class=\"tiny muted\">${prevEntry.ym}</span>`);
        }
      }
      let groupKey = 'Wszystkie konta';
      if(eomUiState.groupBy === 'type') groupKey = `Typ: ${capitalizeFirst(type)}`;
      if(eomUiState.groupBy === 'status') groupKey = `Status: ${capitalizeFirst(eomAccountStatus(referenceValue))}`;
      return {
        acc,
        typeLabel: capitalizeFirst(type),
        statusLabel: capitalizeFirst(eomAccountStatus(referenceValue)),
        previousLabel: prevBits.join('<br>'),
        currentInput: currentValue === null ? '' : String(currentValue).replace('.',','),
        currentValue,
        adjustedCurrent: scenarioCurrent,
        adjustedPrevious: scenarioPrevious,
        previousAdjusted: scenarioPrevious,
        deltaAdjusted,
        deltaPct,
        deltaLabel,
        deltaDisplay,
        deltaPctDisplay: pctDisplay,
        trendArrow,
        trendDirection,
        trendDescription,
        displayBalance: scenarioBalance,
        previousDisplay,
        averageSix: avgSix,
        recordEntry,
        minEntry,
        sparkColor,
        isDormant: dormant,
        subtitle,
        sparklinePoints,
        history,
        groupKey
      };
    }).filter(Boolean);

    if(eomUiState.focusedAccountId && !rows.some(row => row.acc.id === eomUiState.focusedAccountId)){
      eomUiState.focusedAccountId = null;
    }

    const gridResult = eomUiState.pivotMode
      ? renderEomPivotTable(ctx, rows, sparkMonths, eomUiState.scenario)
      : renderEomInteractiveGrid(ctx, rows, { focusedAccountId: eomUiState.focusedAccountId, scenario: eomUiState.scenario });

    renderEomHeatmap(ctx, rows, sparkMonths, eomUiState.scenario);

    const gridContainer = document.getElementById('eom-grid');
    const totalEl = document.getElementById('eom-total');
    const updateTotal = () => {
      if(!gridContainer || !totalEl) return;
      const inputs = Array.from(gridContainer.querySelectorAll('input[data-id]'));
      const scenarioKey = eomUiState.scenario || 'actual';
      if(!inputs.length){
        const base = rows.reduce((sum, row) => sum + (row.currentValue ?? 0), 0);
        const scenarioTotal = rows.reduce((sum, row) => {
          if(row.currentValue === null || row.currentValue === undefined) return sum;
          const adjusted = applyScenarioToValue(row.currentValue, scenarioKey) ?? 0;
          return sum + adjusted;
        }, 0);
        totalEl.innerHTML = `${fmt(base, state.currency)}${scenarioKey !== 'actual' ? ` <span class="tiny muted">(${fmt(scenarioTotal, state.currency)} ${EOM_SCENARIOS[scenarioKey]?.label || ''})</span>` : ''}`;
        return;
      }
      let scenarioTotal = 0;
      const total = inputs.reduce((sum, input) => {
        if(input.value.trim() === '') return sum;
        const raw = num(input.value) || 0;
        scenarioTotal += applyScenarioToValue(raw, scenarioKey) ?? 0;
        return sum + raw;
      }, 0);
      totalEl.innerHTML = `${fmt(total, state.currency)}${scenarioKey !== 'actual' ? ` <span class="tiny muted">(${fmt(scenarioTotal, state.currency)} ${EOM_SCENARIOS[scenarioKey]?.label || ''})</span>` : ''}`;
    };

    if(!eomUiState.pivotMode){
      bindMoneyInputs(gridContainer);
      const rowMap = new Map(rows.map(row => [row.acc.id, row]));
      gridResult.inputs.forEach(input => {
        const accountId = input.dataset.id;
        const row = rowMap.get(accountId);
        const deltaNodes = gridContainer.querySelectorAll(`[data-delta="${accountId}"]`);
        const balanceNode = gridContainer.querySelector(`[data-balance="${accountId}"]`);
        const updateRow = () => {
          const raw = input.value.trim() === '' ? null : num(input.value);
          const scenarioValue = raw === null ? null : applyScenarioToValue(raw, eomUiState.scenario);
          row.currentValue = raw;
          row.adjustedCurrent = scenarioValue;

          const prevAdjusted = row.adjustedPrevious ?? row.previousAdjusted ?? null;
          const hasAny = !(scenarioValue === null && prevAdjusted === null);
          const deltaVal = hasAny ? ((scenarioValue ?? 0) - (prevAdjusted ?? 0)) : null;
          const pctVal = prevAdjusted && prevAdjusted !== 0 ? (deltaVal / Math.abs(prevAdjusted)) * 100 : null;
          row.deltaAdjusted = deltaVal;
          row.deltaPct = pctVal;

          const threshold = 0.005;
          const direction = deltaVal === null ? 'flat' : (deltaVal > threshold ? 'up' : deltaVal < -threshold ? 'down' : 'flat');
          const arrow = direction === 'up' ? '↗' : direction === 'down' ? '↘' : '→';
          const deltaDisplay = deltaVal === null ? '—' : `${deltaVal > 0 ? '+' : '−'}${fmt(Math.abs(deltaVal), state.currency)}`;
          const pctDisplay = pctVal !== null ? `${pctVal > 0 ? '+' : ''}${pctVal.toFixed(1)}%` : '—';
          row.trendDirection = direction;
          row.trendArrow = arrow;
          row.deltaDisplay = deltaDisplay;
          row.deltaPctDisplay = pctDisplay;
          row.sparkColor = direction === 'down' ? '#dc2626' : direction === 'up' ? '#16a34a' : '#64748b';

          if(balanceNode){
            const balanceText = scenarioValue !== null ? fmt(scenarioValue, state.currency) : (raw !== null ? fmt(raw, state.currency) : '—');
            balanceNode.textContent = balanceText;
            row.displayBalance = balanceText;
          }

          const cardEl = input.closest('.eom-account-item');
          if(cardEl){
            cardEl.title = `${row.acc.name}: ${row.displayBalance}${row.deltaDisplay && row.deltaDisplay !== '—' ? ` | Δ ${row.deltaDisplay}` : ''}`;
          }

          if(deltaNodes.length){
            deltaNodes.forEach(node => {
              const role = node.dataset.role || '';
              if(role === 'header'){
                const tone = direction === 'up' ? 'up' : direction === 'down' ? 'down' : 'flat';
                node.classList.remove('up','down','flat');
                node.classList.add(tone);
                const headerHtml = pctDisplay !== '—'
                  ? `<span class="arrow ${tone}">${arrow}</span><span>${deltaDisplay} <span class="tiny muted">(${pctDisplay})</span></span>`
                  : `<span class="arrow ${tone}">${arrow}</span><span>${deltaDisplay}</span>`;
                node.innerHTML = headerHtml;
              } else if(role === 'detail'){
                const tone = direction === 'up' ? 'positive' : direction === 'down' ? 'negative' : 'neutral';
                node.classList.remove('positive','negative','neutral');
                node.classList.add(tone);
                node.textContent = pctDisplay !== '—' ? `${deltaDisplay} (${pctDisplay})` : deltaDisplay;
              } else {
                node.textContent = deltaDisplay;
              }
            });
          }

          const sparkPoint = row.sparklinePoints?.find(pt => pt.ym === ym);
          if(sparkPoint){
            sparkPoint.value = scenarioValue ?? 0;
          }

          updateTotal();
          if(typeof gridResult.refreshSparklines === 'function'){
            gridResult.refreshSparklines();
          }
        };
        input.addEventListener('input', updateRow);
        updateRow();
      });
      if(typeof gridResult.refreshSparklines === 'function'){
        gridResult.refreshSparklines();
      }
    } else {
      updateTotal();
    }

    if(!eomUiState.pivotMode){
      gridContainer.querySelectorAll('button[data-del]').forEach(btn => {
        btn.onclick = () => {
          const accountId = btn.dataset.del;
          const used = (b().transactions || []).some(t => t.accountId === accountId);
          if(used){ alert('Nie można usunąć: konto ma powiązane transakcje.'); return; }
          if(!confirm('Usunąć konto i powiązane salda EOM?')) return;
          state.modules.budget.accounts = (b().accounts || []).filter(x => x.id !== accountId);
          state.modules.budget.eom = (b().eom || []).filter(e => e.accountId !== accountId);
          save(state);
          renderAll();
        };
      });
      gridContainer.querySelectorAll('button[data-drill]').forEach(btn => {
        btn.onclick = () => {
          eomUiState.focusedAccountId = btn.dataset.drill;
          renderEOMHistory();
        };
      });
    }

    updateTotal();

    const saveBtn = document.getElementById('eom-save');
    if(saveBtn){
      saveBtn.onclick = () => {
        if(eomUiState.pivotMode){
          alert('Widok pivot służy do analizy. Wróć do widoku edycyjnego, aby zapisać zmiany.');
          return;
        }
        const inputs = Array.from(gridContainer.querySelectorAll('input[data-id]'));
        const updateIds = new Set(inputs.map(inp => inp.dataset.id));
        const retained = (b().eom || []).filter(entry => !(entry.ym === ym && updateIds.has(entry.accountId)));
        for(const inp of inputs){
          const raw = inp.value.trim();
          if(!raw) continue;
          const bal = num(raw) || 0;
          retained.push({ ym, accountId: inp.dataset.id, balance: bal });
        }
        state.modules.budget.eom = retained;
        save(state);
        renderEOM();
        renderEOMHistory();
      };
    }

    const copyBtn = document.getElementById('eom-copy-last');
    if(copyBtn){
      copyBtn.onclick = () => {
        if(eomUiState.pivotMode){
          alert('Kopiowanie dostępne jest w widoku edycyjnym.');
          return;
        }
        for(const row of rows){
          const history = ctx.accountHistory[row.acc.id] || [];
          const source = lastEntryBefore(history, ym) || history[history.length - 1];
          if(!source) continue;
          const input = gridContainer.querySelector(`input[data-id="${row.acc.id}"]`);
          if(input){
            input.value = String(source.balance).replace('.',',');
            input.dispatchEvent(new Event('input', { bubbles:true }));
          }
        }
      };
    }

    const resetBtn = document.getElementById('eom-reset-inputs');
    if(resetBtn){
      resetBtn.onclick = () => {
        if(eomUiState.pivotMode){
          alert('Wyczyszczanie pól dostępne jest po wyłączeniu widoku pivot.');
          return;
        }
        gridContainer.querySelectorAll('input[data-id]').forEach(inp => {
          inp.value = '';
          inp.dispatchEvent(new Event('input', { bubbles:true }));
        });
      };
    }

    renderEOMHistory();
  }

  function renderEOMHistory(){
    return; // replaced by renderEomV2
    const ctx = buildEomContext();
    const rangeSelect = document.getElementById('eom-history-range');
    const transposeBtn = document.getElementById('eom-history-transpose');
    const searchInput = document.getElementById('eom-history-search');
    const onlyChangesBox = document.getElementById('eom-history-only-changes');
    const exportBtn = document.getElementById('eom-history-export');

    if(rangeSelect){
      const desired = eomUiState.historyRange || '6';
      if(rangeSelect.value !== desired) rangeSelect.value = desired;
      if(!rangeSelect.dataset.bound){
        rangeSelect.dataset.bound = '1';
        rangeSelect.addEventListener('change', event => {
          eomUiState.historyRange = event.target.value || '6';
          saveEomUiState();
          renderEOMHistory();
        });
      }
    }

    if(searchInput){
      searchInput.value = eomUiState.historySearch || '';
      if(!searchInput.dataset.bound){
        searchInput.dataset.bound = '1';
        searchInput.addEventListener('input', event => {
          eomUiState.historySearch = event.target.value || '';
          saveEomUiState();
          renderEOMHistory();
        });
      }
    }

    if(onlyChangesBox){
      onlyChangesBox.checked = !!eomUiState.historyOnlyChanges;
      if(!onlyChangesBox.dataset.bound){
        onlyChangesBox.dataset.bound = '1';
        onlyChangesBox.addEventListener('change', event => {
          eomUiState.historyOnlyChanges = !!event.target.checked;
          saveEomUiState();
          renderEOMHistory();
        });
      }
    }

    if(transposeBtn){
      transposeBtn.dataset.active = eomUiState.historyTranspose ? '1' : '0';
      transposeBtn.textContent = eomUiState.historyTranspose ? 'Widok standardowy' : 'Transponuj widok';
      if(!transposeBtn.dataset.bound){
        transposeBtn.dataset.bound = '1';
        transposeBtn.addEventListener('click', () => {
          eomUiState.historyTranspose = !eomUiState.historyTranspose;
          if(eomUiState.historyTranspose && eomUiState.historySort?.key === 'ym'){
            eomUiState.historySort = { key:'name', dir:'asc' };
          }
          saveEomUiState();
          renderEOMHistory();
        });
      }
    }

    if(exportBtn && !exportBtn.dataset.bound){
      exportBtn.dataset.bound = '1';
      exportBtn.addEventListener('click', exportEomHistoryCsv);
    }

    const months = ctx.months;
    const rangeMonths = getMonthsWithinRange(months, eomUiState.dateRange);
    const baseMonths = rangeMonths.length ? rangeMonths : months;
    const limitValue = eomUiState.historyRange || '6';
    const monthsToShow = !baseMonths.length
      ? []
      : (limitValue === 'all' ? baseMonths : baseMonths.slice(-Number(limitValue || 6)));

    if(!baseMonths.length){
      renderEomKpis(ctx, []);
      renderEomPerformanceMatrix(ctx, []);
      renderEomHistoryTable(ctx, [], { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
      renderEomMonthlySummary([]);
      renderEomNetWorthChart(ctx, { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
      return;
    }

    const focusCandidate = ctx.focusMonth || ctx.latestMonth || baseMonths[baseMonths.length - 1];
    const focusTarget = baseMonths.includes(focusCandidate) ? focusCandidate : (baseMonths[baseMonths.length - 1]);
    const accountStats = computeAccountStatsForMonth(ctx, focusTarget, { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
    const monthlySummary = computeMonthlySummary(ctx, { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });

    renderEomKpis(ctx, accountStats);
    renderEomPerformanceMatrix(ctx, accountStats);
    renderEomHistoryTable(ctx, monthsToShow, {
      scenario: eomUiState.scenario,
      accountTypes: eomUiState.accountTypes,
      transpose: eomUiState.historyTranspose,
      search: eomUiState.historySearch,
      onlyChanges: eomUiState.historyOnlyChanges,
      sort: eomUiState.historySort,
      totalMonths: baseMonths.length
    });
    renderEomMonthlySummary(monthlySummary.filter(row => monthsToShow.includes(row.ym)), { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
    renderEomNetWorthChart(ctx, { scenario: eomUiState.scenario, accountTypes: eomUiState.accountTypes });
  }

  const DAY_MS = 1000*60*60*24;

  function setDefaultDateForAlloc() {
    const dateInput = document.querySelector('#alloc-form input[name="date"]');
    if (dateInput && !dateInput.value) {
        dateInput.value = new Date().toISOString().slice(0, 10);
    }
  }

  function renderAllocSelect(){
    const sel=document.querySelector('#alloc-form select[name="goalId"]'); if(!sel) return;
    sel.innerHTML=''; for(const g of (b().goals||[])){ sel.add(new Option(g.name,g.id)); }
  }

  // --- Analytics Helpers ---
  const ANALYTICS_STATE_KEY='lifeos_budget_filters_v1';
  let analyticsUiState = loadAnalyticsUiState();
  const analyticsCharts={};
  const eomCharts={};
  let eomHistoryExportCache=null;
  const EOM_UI_STATE_KEY='lifeos_budget_eom_ui_v1';
  const DEFAULT_EOM_UI_STATE={
    accountTypes:[],
    dateRange:{ from:null, to:null },
    scenario:'actual',
    groupBy:'type',
    pivotMode:false,
    focusedAccountId:null,
    monthlySort:{field:'ym',dir:'desc'},
    netWorthRange:'6m',
    netWorthFocusMonth:null,
    accountSort:'balance',
    filterPositiveOnly:false,
    filterNegativeOnly:false,
    hideZeroAccounts:false,
    expandedAccounts:[],
    dashboardView:'overview',
    compareMonthA:null,
    compareMonthB:null,
    historyRange:'6',
    historyTranspose:false,
    historySearch:'',
    historyOnlyChanges:false,
    historySort:{ key:'ym', dir:'desc' }
  };

  function loadEomUiState(){
    try{
      const raw=localStorage.getItem(EOM_UI_STATE_KEY);
      if(!raw) return {};
      const parsed=JSON.parse(raw);
      if(!parsed || typeof parsed!=='object') return {};
      return parsed;
    }catch(err){
      console.warn('Nie można odczytać ustawień EOM',err);
      return {};
    }
  }

  function saveEomUiState(){
    try{
      const payload={
        netWorthRange:eomUiState.netWorthRange,
        netWorthFocusMonth:eomUiState.netWorthFocusMonth,
        compareMonthA:eomUiState.compareMonthA,
        compareMonthB:eomUiState.compareMonthB,
        historyRange:eomUiState.historyRange,
        historyTranspose:eomUiState.historyTranspose,
        historySearch:eomUiState.historySearch,
        historyOnlyChanges:eomUiState.historyOnlyChanges,
        historySort:eomUiState.historySort,
        dashboardView:eomUiState.dashboardView
      };
      localStorage.setItem(EOM_UI_STATE_KEY,JSON.stringify(payload));
    }catch(err){
      console.warn('Nie można zapisać ustawień EOM',err);
    }
  }

  let eomUiState={...DEFAULT_EOM_UI_STATE,...loadEomUiState()};
  eomUiState.scenario='actual';
  if(!eomUiState.dateRange){
    eomUiState.dateRange={ from:null, to:null };
  }else{
    eomUiState.dateRange=normalizeYmRange(eomUiState.dateRange);
  }
  const ANALYTICS_COLORS=['#0ea5e9','#ef4444','#16a34a','#f97316','#8b5cf6','#14b8a6','#facc15','#6366f1','#0f172a'];

  function loadAnalyticsUiState(){
    try{
      const raw=localStorage.getItem(ANALYTICS_STATE_KEY);
      if(!raw) return {selectedCategoryIds:[],sortField:'total',sortDir:'desc',searchTerm:'',selectedMonths:null};
      const parsed=JSON.parse(raw);
      return {
        selectedCategoryIds:Array.isArray(parsed?.selectedCategoryIds)?parsed.selectedCategoryIds:[],
        sortField:typeof parsed?.sortField==='string'?parsed.sortField:'total',
        sortDir:parsed?.sortDir==='asc'?'asc':'desc',
        searchTerm:typeof parsed?.searchTerm==='string'?parsed.searchTerm:'',
        selectedMonths:Array.isArray(parsed?.selectedMonths)?parsed.selectedMonths:null
      };
    }catch(err){
      console.warn('Nie można odczytać ustawień analityki',err);
      return {selectedCategoryIds:[],sortField:'total',sortDir:'desc',searchTerm:'',selectedMonths:null};
    }
  }
  function saveAnalyticsUiState(){
    try{localStorage.setItem(ANALYTICS_STATE_KEY,JSON.stringify(analyticsUiState));}catch(err){console.warn('Nie można zapisać ustawień analityki',err);}
  }
  function analyticsExpenseCategories(){
    return (b().categories||[]).filter(c=>c.type==='expense'||c.type==='saving');
  }
  function getActiveAnalyticsCategoryIds(expenseCats=analyticsExpenseCategories()){
    const valid=(analyticsUiState?.selectedCategoryIds||[]).filter(id=>expenseCats.some(c=>c.id===id));
    return valid.length?valid:expenseCats.map(c=>c.id);
  }
  function setAnalyticsSelectedCategories(ids){
    analyticsUiState.selectedCategoryIds=Array.from(new Set(ids));
    saveAnalyticsUiState();
  }
  function setAnalyticsSelectedMonths(months){
    const unique=Array.from(new Set(Array.isArray(months)?months:[])).sort();
    analyticsUiState.selectedMonths=unique;
    saveAnalyticsUiState();
  }
  function getAnalyticsAvailableMonths(){
    const months=new Set();
    (b().transactions||[]).forEach(t=>{if(t?.date) months.add(t.date.slice(0,7));});
    if(b().monthly){
      Object.keys(b().monthly).forEach(ym=>months.add(ym));
    }
    return Array.from(months).sort();
  }
  function defaultAnalyticsMonths(allMonths){
    if(!allMonths.length) return [];
    const current=b().workingMonth;
    if(current && allMonths.includes(current)) return [current];
    return [allMonths[allMonths.length-1]];
  }
  function getAnalyticsSelectedMonths(allMonths){
    const currentRaw=Array.isArray(analyticsUiState.selectedMonths)?analyticsUiState.selectedMonths:[];
    const currentSorted=[...currentRaw].sort();
    let valid=currentRaw.filter(m=>allMonths.includes(m));
    if(valid.length===0 && allMonths.length>0){
      valid=defaultAnalyticsMonths(allMonths);
    }
    const normalized=Array.from(new Set(valid)).sort();
    const changed=normalized.length!==currentSorted.length || normalized.some((m,i)=>m!==currentSorted[i]);
    if(changed){
      analyticsUiState.selectedMonths=normalized;
      saveAnalyticsUiState();
    }
    return normalized;
  }
  function ensureAnalyticsSortDefaults(){
    if(!analyticsUiState.sortField) analyticsUiState.sortField='total';
    if(!['asc','desc'].includes(analyticsUiState.sortDir)) analyticsUiState.sortDir='desc';
  }
  function destroyAnalyticsChart(key){
    if(analyticsCharts[key]){analyticsCharts[key].destroy(); delete analyticsCharts[key];}
  }
  function calcMedian(values){
    if(!values||!values.length) return 0;
    const sorted=[...values].sort((a,b)=>a-b);
    const mid=Math.floor(sorted.length/2);
    return sorted.length%2?sorted[mid]:(sorted[mid-1]+sorted[mid])/2;
  }
  function formatTrend(amount, percent, type){
    if(!amount && !percent) return '<span class="delta-neutral">—</span>';
    const isPositive=amount>0;
    const good=type==='saving';
    const cls=isPositive?(good?'delta-up':'delta-down'):(good?'delta-down':'delta-up');
    const arrow=isPositive?'▲':'▼';
    const pctText=percent?` (${percent>0?'+':''}${percent.toFixed(1)}%)`:'';
    return `<span class="${cls}">${arrow} ${fmt(amount, state.currency)}${pctText}</span>`;
  }
  function formatCountTrend(delta, prevCount, type){
    if(!delta) return '<span class="delta-neutral">—</span>';
    const isPositive=delta>0;
    const good=type==='saving';
    const cls=isPositive?(good?'delta-up':'delta-down'):(good?'delta-down':'delta-up');
    const arrow=isPositive?'▲':'▼';
    const pct=prevCount?Math.abs(delta/prevCount)*100:0;
    const pctText=pct?` (${delta>0?'+':''}${pct.toFixed(0)}%)`:'';
    return `<span class="${cls}">${arrow} ${delta>0?'+':''}${delta}${pctText}</span>`;
  }
  function heatColor(ratio){
    if(!Number.isFinite(ratio)||ratio===0) return 'transparent';
    if(ratio>=1.5) return '#fee2e2';
    if(ratio>=1.15) return '#ffedd5';
    if(ratio>=0.9) return '#f8fafc';
    if(ratio>=0.65) return '#dcfce7';
    return '#dbeafe';
  }
  function withAlpha(hex,alpha){
    const raw=(hex||'').replace('#','');
    if(raw.length!==6){return hex;}
    const r=parseInt(raw.slice(0,2),16);
    const g=parseInt(raw.slice(2,4),16);
    const b=parseInt(raw.slice(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }
  function getVisibleTotal(chart) {
    if (!chart || !chart.getDatasetMeta) return 0;
    const meta = chart.getDatasetMeta(0);
    if (!meta || !meta.data) return 0;
    let visibleTotal = 0;
    for (let i = 0; i < meta.data.length; i++) {
        if (chart.getDataVisibility(i)) {
            visibleTotal += chart.data.datasets[0].data[i];
        }
    }
    return visibleTotal;
  }

  // --- Analytics V2 -----------------------------------------------------------
  let anDdChart=null, anViewMode='dashboard';

  function anShowView(mode){
    anViewMode=mode;
    ['dashboard','categories','habits'].forEach(v=>{
      const el=document.getElementById('an-view-'+v);
      if(el) el.style.display=v===mode?'':'none';
    });
  }

  function renderAnMonthPicker(allMonths, selectedMonths){
    const container=document.getElementById('an-month-picker');
    const summary=document.getElementById('an-month-summary');
    const quick=document.getElementById('an-month-quick');
    if(!container) return;
    container.innerHTML='';
    if(!allMonths.length){
      if(summary) summary.textContent='Brak danych. Dodaj transakcje, aby rozpocząć analizę.';
      if(quick) quick.style.display='none';
      return;
    }
    if(quick) quick.style.display='flex';
    const selectedSet=new Set(selectedMonths);
    [...allMonths].sort().reverse().forEach(ym=>{
      const chip=document.createElement('button');
      chip.type='button';
      chip.className='analytics-month-chip'+(selectedSet.has(ym)?' active':'');
      chip.textContent=ym;
      chip.onclick=()=>{
        const cur=getAnalyticsSelectedMonths(allMonths);
        const nxt=new Set(cur);
        if(nxt.has(ym)){if(nxt.size===1)return;nxt.delete(ym);}else{nxt.add(ym);}
        setAnalyticsSelectedMonths(Array.from(nxt));
        renderAnalytics();
      };
      container.appendChild(chip);
    });
    if(summary){
      if(selectedMonths.length<=1) summary.textContent=`Miesiąc: ${selectedMonths[0]||'—'}`;
      else summary.textContent=`${selectedMonths.length} miesięcy (${selectedMonths[0]} → ${selectedMonths[selectedMonths.length-1]})`;
    }
    if(quick) quick.querySelectorAll('button[data-range]').forEach(btn=>{
      btn.onclick=()=>{
        const r=btn.dataset.range;
        let sel=[];
        if(r==='current'){const c=b().workingMonth;sel=c&&allMonths.includes(c)?[c]:defaultAnalyticsMonths(allMonths);}
        else if(r==='last3') sel=allMonths.slice(-3);
        else if(r==='last6') sel=allMonths.slice(-6);
        else if(r==='year'){const y=(b().workingMonth||'').slice(0,4)||String(new Date().getFullYear());sel=allMonths.filter(m=>m.startsWith(y));if(!sel.length)sel=allMonths.slice(-12);}
        else if(r==='all') sel=[...allMonths];
        else sel=defaultAnalyticsMonths(allMonths);
        if(!sel.length) sel=defaultAnalyticsMonths(allMonths);
        setAnalyticsSelectedMonths(sel);
        renderAnalytics();
      };
    });
  }

  function renderAnFilterPanel(expenseCats, categoryStats, totalExpense){
    const list=document.getElementById('an-cat-filter-list');
    const searchInput=document.getElementById('an-cat-search');
    const summary=document.getElementById('an-filter-summary');
    if(!list) return;
    const selectedIds=getActiveAnalyticsCategoryIds(expenseCats);
    const selectedSet=new Set(selectedIds);
    const search=(analyticsUiState.searchTerm||'').toLowerCase();
    const sorted=[...expenseCats].sort((a,b2)=>(categoryStats[b2.id]?.total||0)-(categoryStats[a.id]?.total||0));
    list.innerHTML='';
    sorted.forEach(cat=>{
      const name=`${cat.emoji||''} ${cat.name}`.trim();
      if(search&&!name.toLowerCase().includes(search)) return;
      const stat=categoryStats[cat.id];
      const total=stat?.total||0;
      const share=totalExpense>0?((total/totalExpense)*100).toFixed(1)+'%':'0%';
      const label=document.createElement('label');
      label.className=selectedSet.has(cat.id)?'active':'';
      label.innerHTML=`<input type="checkbox" ${selectedSet.has(cat.id)?'checked':''} data-cat-id="${cat.id}" style="accent-color:var(--blue)" /><span>${escapeHtml(name)}<small class="muted" style="margin-left:auto;font-size:11px">${fmt(total,state.currency)} (${share})</small></span>`;
      label.querySelector('input').onchange=e=>{
        const next=new Set(getActiveAnalyticsCategoryIds(expenseCats));
        if(e.target.checked) next.add(cat.id); else next.delete(cat.id);
        setAnalyticsSelectedCategories(Array.from(next));
        renderAnalytics();
      };
      list.appendChild(label);
    });
    const selectedTotal=selectedIds.reduce((s,id)=>s+(categoryStats[id]?.total||0),0);
    const selShare=totalExpense>0?((selectedTotal/totalExpense)*100).toFixed(1):'0';
    if(summary) summary.textContent=`${selectedIds.length} z ${expenseCats.length} kategorii \u2022 ${fmt(selectedTotal,state.currency)} (${selShare}%)`;
    if(searchInput&&!searchInput.dataset.bound){
      searchInput.dataset.bound='1';
      searchInput.oninput=()=>{analyticsUiState.searchTerm=searchInput.value;renderAnFilterPanel(expenseCats,categoryStats,totalExpense);};
    }
    // Quick buttons
    const bindQuick=(id,fn)=>{const el=document.getElementById(id);if(el&&!el.dataset.bound){el.dataset.bound='1';el.onclick=()=>{fn();renderAnalytics();};}};
    bindQuick('an-sel-all',()=>setAnalyticsSelectedCategories(expenseCats.map(c=>c.id)));
    bindQuick('an-sel-none',()=>setAnalyticsSelectedCategories([]));
    bindQuick('an-sel-expense',()=>setAnalyticsSelectedCategories(expenseCats.filter(c=>c.type==='expense').map(c=>c.id)));
    bindQuick('an-sel-savings',()=>setAnalyticsSelectedCategories(expenseCats.filter(c=>c.type==='saving').map(c=>c.id)));
    bindQuick('an-sel-top5',()=>{const top=sorted.slice(0,5).map(c=>c.id);setAnalyticsSelectedCategories(top);});
  }

  function renderAnKpis(ctx){
    const c=document.getElementById('an-kpis');
    if(!c) return;
    const {totalIncome,totalExpenseAll,netChange,avgSavingsRate,totalSelectedExpense,totalSelectedCount,selectedAvg,selectedMedian,monthsCount,lastMonthSummary,prevMonthSummary,lastVsPrevAmount,lastVsPrevPercent}=ctx;
    const avgPerM=monthsCount?totalSelectedExpense/monthsCount:0;
    const momCls=lastVsPrevAmount>0?'red':lastVsPrevAmount<0?'green':'';
    const momSign=lastVsPrevAmount>0?'+':'';
    c.innerHTML=`
      <div class="an-kpi accent"><div class="an-kpi-label">Przychody</div><div class="an-kpi-val">${fmt(totalIncome,state.currency)}</div><div class="an-kpi-sub">${fmt(totalIncome/(monthsCount||1),state.currency)} / mies.</div></div>
      <div class="an-kpi ${netChange>=0?'green':'red'}"><div class="an-kpi-label">Bilans netto</div><div class="an-kpi-val">${fmt(netChange,state.currency)}</div><div class="an-kpi-sub">Stopa oszcz.: ${avgSavingsRate.toFixed(1)}%</div></div>
      <div class="an-kpi"><div class="an-kpi-label">Wydatki (wybr.)</div><div class="an-kpi-val">${fmt(totalSelectedExpense,state.currency)}</div><div class="an-kpi-sub">${fmt(avgPerM,state.currency)} / mies. \u2022 ${totalSelectedCount} transakcji</div></div>
      <div class="an-kpi"><div class="an-kpi-label">\u015Arednia / mediana</div><div class="an-kpi-val">${fmt(selectedAvg,state.currency)}</div><div class="an-kpi-sub">Mediana: ${fmt(selectedMedian,state.currency)}</div></div>
      <div class="an-kpi ${momCls}"><div class="an-kpi-label">Dynamika m/m</div><div class="an-kpi-val">${momSign}${fmt(lastVsPrevAmount,state.currency)}</div><div class="an-kpi-sub">${lastVsPrevPercent>=0?'+':''}${lastVsPrevPercent.toFixed(1)}% vs prev</div></div>
      <div class="an-kpi"><div class="an-kpi-label">Wydatki ca\u0142k.</div><div class="an-kpi-val">${fmt(totalExpenseAll,state.currency)}</div><div class="an-kpi-sub">${fmt(totalExpenseAll/(monthsCount||1),state.currency)} / mies.</div></div>
    `;
  }

  function renderAnPulseChart(monthlySummaries){
    const canvas=document.getElementById('an-pulse-chart');
    if(!canvas) return;
    destroyAnalyticsChart('pulse');
    const labels=monthlySummaries.map(m=>formatMonthLabel(m.ym));
    const incomes=monthlySummaries.map(m=>m.incomes);
    const expenses=monthlySummaries.map(m=>m.expenses);
    const savings=monthlySummaries.map(m=>m.incomes-m.expenses);
    const selected=monthlySummaries.map(m=>m.selectedTotal);
    analyticsCharts.pulse=new Chart(canvas.getContext('2d'),{
      type:'line',
      data:{labels,datasets:[
        {label:'Przychody',data:incomes,borderColor:'#16a34a',backgroundColor:withAlpha('#16a34a',.06),borderWidth:2.5,tension:.3,fill:true,pointRadius:3,pointBackgroundColor:'#16a34a'},
        {label:'Wydatki (wszystkie)',data:expenses,borderColor:'#ef4444',backgroundColor:withAlpha('#ef4444',.06),borderWidth:2.5,tension:.3,fill:true,pointRadius:3,pointBackgroundColor:'#ef4444'},
        {label:'Wydatki (wybrane)',data:selected,borderColor:'#8b5cf6',backgroundColor:'transparent',borderWidth:2,tension:.3,borderDash:[6,3],pointRadius:3,pointBackgroundColor:'#8b5cf6'},
        {label:'Oszcz\u0119dno\u015Bci netto',data:savings,borderColor:'#0ea5e9',backgroundColor:withAlpha('#0ea5e9',.04),borderWidth:2,tension:.3,fill:true,pointRadius:3,pointBackgroundColor:'#0ea5e9'}
      ]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{size:11},usePointStyle:true,pointStyle:'circle'}},tooltip:{mode:'index',intersect:false,callbacks:{label:c2=>`${c2.dataset.label}: ${fmt(c2.parsed.y,state.currency)}`}}},
        interaction:{mode:'index',intersect:false},
        scales:{x:{grid:{display:false}},y:{ticks:{callback:v=>currencyTicks(v)},grid:{color:'rgba(148,163,184,.08)'}}}
      }
    });
  }

  function renderAnCatBars(categoryStats, selectedCatIds, monthlySummaries){
    const wrap=document.getElementById('an-cat-bars');
    if(!wrap) return;
    const stats=selectedCatIds.map(id=>categoryStats[id]).filter(Boolean).sort((a,b2)=>(b2.total||0)-(a.total||0)).slice(0,10);
    if(!stats.length){wrap.innerHTML='<div class="muted" style="padding:12px;text-align:center">Brak danych</div>';return;}
    const maxVal=stats[0]?.total||1;
    // Compute MoM delta for each category
    const lastMs=monthlySummaries[monthlySummaries.length-1];
    const prevMs=monthlySummaries.length>=2?monthlySummaries[monthlySummaries.length-2]:null;
    let html='';
    stats.forEach((stat,i)=>{
      const cat=stat.category;
      const pct=Math.max(5,(stat.total/maxVal)*100);
      const color=ANALYTICS_COLORS[i%ANALYTICS_COLORS.length];
      const lastVal=lastMs?.byCategory[cat.id]?.total||0;
      const prevVal=prevMs?.byCategory[cat.id]?.total||0;
      const delta=prevVal?((lastVal-prevVal)/prevVal*100):0;
      const deltaTxt=prevVal?`${delta>=0?'+':''}${delta.toFixed(0)}%`:'';
      const deltaCls=delta>5?'delta-up':delta<-5?'delta-down':'delta-neutral';
      html+=`<div class="an-cat-bar-row">
        <div class="an-cat-bar-label">${cat.emoji||''} ${escapeHtml(cat.name)}</div>
        <div class="an-cat-bar-track"><div class="an-cat-bar-fill" style="width:${pct}%;background:${color}"><span>${stat.count}x</span></div></div>
        <div class="an-cat-bar-amount">${fmt(stat.total,state.currency)}</div>
        <div class="an-cat-bar-delta ${deltaCls}">${deltaTxt}</div>
      </div>`;
    });
    wrap.innerHTML=html;
  }

  function renderAnCatDoughnut(categoryStats, selectedCatIds){
    const canvas=document.getElementById('an-cat-doughnut');
    if(!canvas) return;
    destroyAnalyticsChart('catDoughnut');
    const stats=selectedCatIds.map(id=>categoryStats[id]).filter(Boolean).sort((a,b2)=>(b2.total||0)-(a.total||0));
    const labels=stats.map(s=>`${s.category?.emoji||''} ${s.category?.name||'\u2014'}`.trim());
    const data=stats.map(s=>s.total);
    analyticsCharts.catDoughnut=new Chart(canvas.getContext('2d'),{
      type:'doughnut',
      data:{labels,datasets:[{data,backgroundColor:labels.map((_,i)=>ANALYTICS_COLORS[i%ANALYTICS_COLORS.length]),borderColor:'#fff',borderWidth:2}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'right',labels:{font:{size:11},generateLabels:chart=>{
          const d=chart.data;
          const vis=getVisibleTotal(chart);
          return d.labels.map((l,i)=>{
            const hidden=!chart.getDataVisibility(i);
            const p=!hidden&&vis>0?((d.datasets[0].data[i]/vis)*100).toFixed(1)+'%':'';
            return {text:`${l} ${p}`,fillStyle:d.datasets[0].backgroundColor[i],hidden,index:i};
          });
        }}},tooltip:{callbacks:{label:c2=>{const vis=getVisibleTotal(c2.chart);const p=vis>0?((c2.raw/vis)*100).toFixed(1)+'%':'';return `${c2.label}: ${fmt(c2.raw,state.currency)} (${p})`;}}}}
      }
    });
  }

  function renderAnDeviationBars(categoryStats, selectedCatIds, monthlySummaries){
    const wrap=document.getElementById('an-deviation-bars');
    if(!wrap) return;
    if(monthlySummaries.length<2){wrap.innerHTML='<div class="muted" style="padding:12px;text-align:center">Potrzeba min. 2 miesi\u0119cy danych</div>';return;}
    // For each category, compute average across all months except last, then compare last month
    const lastMs=monthlySummaries[monthlySummaries.length-1];
    const histMs=monthlySummaries.slice(0,-1);
    const rows=selectedCatIds.map(id=>{
      const stat=categoryStats[id];
      if(!stat) return null;
      const cat=stat.category;
      const histAvg=histMs.reduce((s,m)=>s+(m.byCategory[id]?.total||0),0)/histMs.length;
      const lastVal=lastMs.byCategory[id]?.total||0;
      const deviation=histAvg>0?((lastVal-histAvg)/histAvg)*100:lastVal>0?100:0;
      return {cat,histAvg,lastVal,deviation,absDev:Math.abs(deviation)};
    }).filter(Boolean).filter(r=>r.histAvg>0||r.lastVal>0).sort((a,b2)=>b2.absDev-a.absDev).slice(0,10);
    if(!rows.length){wrap.innerHTML='<div class="muted" style="padding:12px;text-align:center">Brak odchyle\u0144</div>';return;}
    const maxDev=Math.max(...rows.map(r=>r.absDev),30);
    let html='';
    rows.forEach(r=>{
      const pct=Math.min((r.absDev/maxDev)*50,50);
      const isUp=r.deviation>0;
      const color=isUp?'#ef4444':'#22c55e';
      const left=isUp?'50%':`${50-pct}%`;
      const barStyle=isUp?`left:50%;width:${pct}%`:`left:${50-pct}%;width:${pct}%`;
      html+=`<div class="an-deviation-row">
        <div class="an-deviation-label">${r.cat.emoji||''} ${escapeHtml(r.cat.name)}</div>
        <div class="an-deviation-bar-wrap"><div class="an-deviation-center"></div><div class="an-deviation-bar" style="${barStyle};background:${color}"></div></div>
        <div class="an-deviation-val" style="color:${color}">${r.deviation>=0?'+':''}${r.deviation.toFixed(0)}%</div>
      </div>`;
    });
    html+='<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-top:4px"><span>Poni\u017Cej \u015Bredniej</span><span>\u015Arednia historyczna</span><span>Powy\u017Cej \u015Bredniej</span></div>';
    wrap.innerHTML=html;
  }

  function renderAnAnomalies(ctx){
    const wrap=document.getElementById('an-anomalies');
    if(!wrap) return;
    const {categoryStats,selectedCatIds,monthlySummaries,lastMonthSummary,prevMonthSummary,totalExpenseAll,monthsCount}=ctx;
    const items=[];
    if(monthlySummaries.length>=2){
      const last=lastMonthSummary;
      const prev=prevMonthSummary;
      // Check each category for spikes
      selectedCatIds.forEach(id=>{
        const stat=categoryStats[id];
        if(!stat) return;
        const cat=stat.category;
        const monthVals=monthlySummaries.map(m=>m.byCategory[id]?.total||0);
        const avg=monthVals.reduce((s,v)=>s+v,0)/monthVals.length;
        const lastVal=monthVals[monthVals.length-1];
        if(avg>0&&lastVal>avg*1.8&&lastVal>50){
          items.push({type:'danger',icon:'\u26A0\uFE0F',text:`<strong>${cat.emoji||''} ${escapeHtml(cat.name)}</strong>: wydano ${fmt(lastVal,state.currency)} \u2014 to <strong>${(lastVal/avg).toFixed(1)}x</strong> \u015Bredniej (${fmt(avg,state.currency)}). Sprawd\u017A co si\u0119 sta\u0142o!`});
        } else if(avg>0&&lastVal>avg*1.3&&lastVal>50){
          items.push({type:'warn',icon:'\u{1F4C8}',text:`<strong>${cat.emoji||''} ${escapeHtml(cat.name)}</strong>: ${fmt(lastVal,state.currency)} to ${((lastVal/avg-1)*100).toFixed(0)}% powy\u017Cej \u015Bredniej. Trend rosn\u0105cy.`});
        }
        // 3-month rising trend
        if(monthVals.length>=3){
          const last3=monthVals.slice(-3);
          if(last3[2]>last3[1]&&last3[1]>last3[0]&&last3[2]>50){
            items.push({type:'warn',icon:'\u{1F4C8}',text:`<strong>${cat.emoji||''} ${escapeHtml(cat.name)}</strong>: ro\u015Bnie 3. miesi\u0105c z rz\u0119du (${last3.map(v=>fmt(v,state.currency)).join(' \u2192 ')}).`});
          }
        }
        // Category disappeared
        if(monthVals.length>=3&&lastVal===0&&monthVals[monthVals.length-2]>0){
          items.push({type:'ok',icon:'\u2705',text:`<strong>${cat.emoji||''} ${escapeHtml(cat.name)}</strong>: zero wydatk\u00F3w w ostatnim miesi\u0105cu \u2014 dobra zmiana czy przeoczenie?`});
        }
      });
      // Overall spending spike
      if(prev&&last){
        const totalDelta=last.expenses-prev.expenses;
        const totalDeltaPct=prev.expenses>0?(totalDelta/prev.expenses)*100:0;
        if(totalDeltaPct>25&&totalDelta>200){
          items.push({type:'danger',icon:'\u{1F6A8}',text:`Wydatki og\u00F3\u0142em wzros\u0142y o <strong>${totalDeltaPct.toFixed(0)}%</strong> (${fmt(totalDelta,state.currency)}) vs poprzedni miesi\u0105c.`});
        }
        // Savings rate dropping
        const lastSR=last.incomes>0?((last.incomes-last.expenses)/last.incomes)*100:0;
        const prevSR=prev.incomes>0?((prev.incomes-prev.expenses)/prev.incomes)*100:0;
        if(prevSR>10&&lastSR<prevSR-10){
          items.push({type:'warn',icon:'\u{1F4B8}',text:`Stopa oszcz\u0119dno\u015Bci spad\u0142a z ${prevSR.toFixed(0)}% do ${lastSR.toFixed(0)}%.`});
        }
      }
    }
    // Concentration risk
    const topCat=selectedCatIds.map(id=>categoryStats[id]).filter(Boolean).sort((a,b2)=>(b2.total||0)-(a.total||0))[0];
    const selTotal=selectedCatIds.reduce((s,id)=>s+(categoryStats[id]?.total||0),0);
    if(topCat&&selTotal>0){
      const topShare=(topCat.total/selTotal)*100;
      if(topShare>40){
        items.push({type:'info',icon:'\u{1F3AF}',text:`<strong>${topCat.category?.emoji||''} ${escapeHtml(topCat.category?.name||'')}</strong> to ${topShare.toFixed(0)}% wszystkich wydatk\u00F3w. Du\u017Ca koncentracja \u2014 warto obserwowa\u0107.`});
      }
    }
    if(!items.length){
      wrap.innerHTML='<div class="an-anomaly-item ok"><div class="an-anomaly-icon">\u2705</div><div class="an-anomaly-text">Brak wykrytych anomalii \u2014 wydatki w normie!</div></div>';
      return;
    }
    items.sort((a,b2)=>{const o={danger:0,warn:1,info:2,ok:3};return (o[a.type]||9)-(o[b2.type]||9);});
    wrap.innerHTML=items.slice(0,8).map(i=>`<div class="an-anomaly-item ${i.type}"><div class="an-anomaly-icon">${i.icon}</div><div class="an-anomaly-text">${i.text}</div></div>`).join('');
  }

  function renderAnMonthlyTable(ctx){
    const table=document.getElementById('an-monthly-table');
    if(!table) return;
    const {monthlySummaries,selectedCatIds,categoryStats}=ctx;
    if(!monthlySummaries.length){table.innerHTML='<tbody><tr><td class="muted" style="text-align:center">Brak danych</td></tr></tbody>';return;}
    let h='<thead><tr><th>Miesi\u0105c</th><th style="text-align:right">Przychody</th><th style="text-align:right">Wydatki</th><th style="text-align:right">Wybrane</th><th style="text-align:right">Bilans</th><th style="text-align:right">\u0394 m/m</th><th>Top kategoria</th></tr></thead><tbody>';
    [...monthlySummaries].reverse().forEach((ms,idx)=>{
      const prev=idx<monthlySummaries.length-1?[...monthlySummaries].reverse()[idx+1]:null;
      const net=ms.incomes-ms.expenses;
      const delta=prev?(ms.selectedTotal-prev.selectedTotal):0;
      const deltaPct=prev&&prev.selectedTotal>0?((delta/prev.selectedTotal)*100):0;
      const deltaCls=delta>0?'delta-up':delta<0?'delta-down':'delta-neutral';
      const top=selectedCatIds.map(id=>({id,total:ms.byCategory[id]?.total||0})).sort((a,b2)=>b2.total-a.total)[0];
      let topCell='\u2014';
      if(top&&top.total>0){const cat=categoryStats[top.id]?.category;topCell=`${cat?.emoji||''} ${escapeHtml(cat?.name||'\u2014')}`;}
      h+=`<tr><td><strong>${formatMonthLabel(ms.ym)}</strong></td><td style="text-align:right">${fmt(ms.incomes,state.currency)}</td><td style="text-align:right">${fmt(ms.expenses,state.currency)}</td><td style="text-align:right">${fmt(ms.selectedTotal,state.currency)}</td><td style="text-align:right" class="${net>=0?'ok':'bad'}">${fmt(net,state.currency)}</td><td style="text-align:right" class="${deltaCls}">${prev?(delta>=0?'+':'')+fmt(delta,state.currency)+` (${deltaPct>=0?'+':''}${deltaPct.toFixed(0)}%)`:'\u2014'}</td><td>${topCell}</td></tr>`;
    });
    h+='</tbody>';
    table.innerHTML=h;
  }

  function renderAnTopTx(ctx){
    const table=document.getElementById('an-top-tx');
    if(!table) return;
    const selectedSet=new Set(ctx.selectedCatIds);
    const cm=catsById();
    const flat=[];
    (ctx.allEntriesInPeriod||[]).forEach(tx=>{
      const process=(entry,catId,rawAmt,note)=>{
        const cat=cm[catId];
        if(!cat||(cat.type!=='expense'&&cat.type!=='saving')) return;
        if(selectedSet.size>0&&!selectedSet.has(catId)) return;
        const amt=Math.abs(num(rawAmt));
        if(amt<=0) return;
        flat.push({date:entry.date,catId,amount:amt,note:note||''});
      };
      if(tx.splits&&tx.splits.length>0) tx.splits.forEach(s=>process(tx,s.categoryId,s.amount,tx.note));
      else process(tx,tx.categoryId,tx.amount,tx.note);
    });
    const top=flat.sort((a,b2)=>b2.amount-a.amount).slice(0,15);
    if(!top.length){table.innerHTML='<tbody><tr><td class="muted" style="text-align:center" colspan="4">Brak transakcji</td></tr></tbody>';return;}
    let h='<thead><tr><th>Data</th><th>Kategoria</th><th style="text-align:right">Kwota</th><th>Notatka</th></tr></thead><tbody>';
    top.forEach(e=>{
      const cat=cm[e.catId];
      h+=`<tr><td>${e.date}</td><td>${cat?`${cat.emoji||''} ${escapeHtml(cat.name)}`:'\u2014'}</td><td style="text-align:right;font-weight:600">${fmt(e.amount,state.currency)}</td><td class="muted">${escapeHtml(e.note)||'\u2014'}</td></tr>`;
    });
    h+='</tbody>';
    table.innerHTML=h;
  }

  // ==== CATEGORIES VIEW ====
  function renderAnCatTrendChart(months, categoryStats, selectedCatIds){
    const canvas=document.getElementById('an-cat-trend-chart');
    if(!canvas) return;
    destroyAnalyticsChart('catTrend');
    const stats=selectedCatIds.map(id=>categoryStats[id]).filter(Boolean).sort((a,b2)=>(b2.total||0)-(a.total||0)).slice(0,7);
    const datasets=stats.map((stat,idx)=>({
      label:`${stat.category?.emoji||''} ${stat.category?.name||'\u2014'}`.trim(),
      data:months.map(ym=>stat.months[ym]?.total||0),
      borderColor:ANALYTICS_COLORS[idx%ANALYTICS_COLORS.length],
      backgroundColor:withAlpha(ANALYTICS_COLORS[idx%ANALYTICS_COLORS.length],.1),
      tension:.3,fill:false,borderWidth:2,pointRadius:3,pointBackgroundColor:ANALYTICS_COLORS[idx%ANALYTICS_COLORS.length]
    }));
    analyticsCharts.catTrend=new Chart(canvas.getContext('2d'),{
      type:'line',
      data:{labels:months.map(m=>formatMonthLabel(m)),datasets},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{size:11},usePointStyle:true,pointStyle:'circle'}},tooltip:{mode:'index',intersect:false,callbacks:{label:c2=>`${c2.dataset.label}: ${fmt(c2.parsed.y,state.currency)}`}}},
        interaction:{mode:'index',intersect:false},
        scales:{x:{grid:{display:false}},y:{beginAtZero:true,ticks:{callback:v=>currencyTicks(v)},grid:{color:'rgba(148,163,184,.08)'}}}
      }
    });
  }

  function renderAnCatRanking(ctx){
    const table=document.getElementById('an-cat-ranking');
    if(!table) return;
    const {categoryStats,selectedCatIds,totalSelectedExpense,selectedMood,lastMonthSummary,prevMonthSummary}=ctx;
    const rows=selectedCatIds.map(id=>categoryStats[id]).filter(Boolean).map(stat=>{
      const cat=stat.category;
      const label=`${cat?.emoji||''} ${cat?.name||'\u2014'}`.trim();
      const avg=stat.count?stat.total/stat.count:0;
      const median=calcMedian(stat.values);
      const share=totalSelectedExpense>0?(stat.total/totalSelectedExpense)*100:0;
      const lastYm=lastMonthSummary?.ym;
      const prevYm=prevMonthSummary?.ym;
      const lastD=lastYm?(stat.months[lastYm]||{total:0,count:0}):{total:0,count:0};
      const prevD=prevYm?(stat.months[prevYm]||{total:0,count:0}):null;
      const delta=prevD?lastD.total-prevD.total:0;
      const deltaPct=prevD&&prevD.total>0?(delta/prevD.total)*100:0;
      return {label,total:stat.total,count:stat.count,avg,median,share,delta,deltaPct,maxAmount:stat.max?.amount||0,maxDate:stat.max?.date||'',type:cat?.type||selectedMood,catId:cat?.id};
    });
    if(!rows.length){table.innerHTML='<tbody><tr><td class="muted" style="text-align:center" colspan="8">Brak danych</td></tr></tbody>';return;}
    ensureAnalyticsSortDefaults();
    const sk=analyticsUiState.sortField||'total';
    const sd=analyticsUiState.sortDir==='asc'?1:-1;
    rows.sort((a,b2)=>{
      if(sk==='label') return a.label.localeCompare(b2.label,'pl',{sensitivity:'base'})*sd;
      return ((Number(a[sk])||0)-(Number(b2[sk])||0))*sd;
    });
    const cols=[
      {l:'Kategoria',k:'label',f:r=>`<span style="cursor:pointer;text-decoration:underline dotted" data-dd-cat="${r.catId}">${r.label}</span>`},
      {l:'Suma',k:'total',f:r=>fmt(r.total,state.currency)},
      {l:'Ile',k:'count',f:r=>r.count},
      {l:'\u015Arednia',k:'avg',f:r=>fmt(r.avg,state.currency)},
      {l:'Mediana',k:'median',f:r=>fmt(r.median,state.currency)},
      {l:'Udzia\u0142',k:'share',f:r=>`${r.share.toFixed(1)}%`},
      {l:'\u0394 m/m',k:'delta',f:r=>formatTrend(r.delta,r.deltaPct,r.type)},
      {l:'Max',k:'maxAmount',f:r=>r.maxAmount?`${fmt(r.maxAmount,state.currency)}<br><span class="muted" style="font-size:10px">${r.maxDate}</span>`:'\u2014'}
    ];
    let h='<thead><tr>';
    cols.forEach(c=>{
      const active=sk===c.k;
      const ind=active?`<span class="sort-indicator">${analyticsUiState.sortDir==='asc'?'\u25B2':'\u25BC'}</span>`:'';
      h+=`<th data-sort="${c.k}" style="text-align:${c.k==='label'?'left':'right'}">${c.l}${ind}</th>`;
    });
    h+='</tr></thead><tbody>';
    rows.forEach(r=>{h+='<tr>'+cols.map(c=>`<td style="text-align:${c.k==='label'?'left':'right'}">${c.f(r)}</td>`).join('')+'</tr>';});
    h+='</tbody>';
    table.innerHTML=h;
    table.querySelectorAll('th[data-sort]').forEach(th=>{
      th.onclick=()=>{
        if(analyticsUiState.sortField===th.dataset.sort) analyticsUiState.sortDir=analyticsUiState.sortDir==='asc'?'desc':'asc';
        else{analyticsUiState.sortField=th.dataset.sort;analyticsUiState.sortDir=th.dataset.sort==='label'?'asc':'desc';}
        saveAnalyticsUiState();renderAnCatRanking(ctx);
      };
    });
    // Deep-dive click
    table.querySelectorAll('[data-dd-cat]').forEach(el=>{
      el.onclick=()=>renderAnCatDeepDive(el.dataset.ddCat,ctx);
    });
  }

  function renderAnCatMatrix(months, categoryStats, selectedCatIds){
    const table=document.getElementById('an-cat-matrix');
    if(!table) return;
    const rows=selectedCatIds.map(id=>categoryStats[id]).filter(Boolean);
    if(!rows.length){table.innerHTML='<tbody><tr><td class="muted" style="text-align:center" colspan="99">Brak danych</td></tr></tbody>';return;}
    let h='<thead><tr><th>Kategoria</th>';
    months.forEach(ym=>h+=`<th style="text-align:right;font-size:11px">${formatMonthLabel(ym)}</th>`);
    h+='</tr></thead><tbody>';
    rows.forEach(stat=>{
      const cat=stat.category;
      const avgPM=stat.total/(months.length||1);
      h+=`<tr><td style="white-space:nowrap">${cat?.emoji||''} ${escapeHtml(cat?.name||'\u2014')}</td>`;
      months.forEach(ym=>{
        const md=stat.months[ym]||{total:0,count:0};
        const ratio=avgPM?md.total/avgPM:0;
        const bg=heatColor(ratio);
        h+=md.total>0?`<td style="text-align:right;background:${bg};font-size:12px">${fmt(md.total,state.currency)}<br><span class="muted" style="font-size:10px">${md.count}x</span></td>`:`<td style="background:${bg};text-align:center" class="muted">\u2014</td>`;
      });
      h+='</tr>';
    });
    h+='</tbody>';
    table.innerHTML=h;
  }

  function renderAnMomentum(ctx){
    const table=document.getElementById('an-momentum');
    if(!table) return;
    const {categoryStats,selectedCatIds,lastMonthSummary,prevMonthSummary,selectedMood}=ctx;
    if(!lastMonthSummary){table.innerHTML='<tbody><tr><td class="muted" style="text-align:center" colspan="7">Min. 1 miesi\u0105c danych</td></tr></tbody>';return;}
    const lastYm=lastMonthSummary.ym;
    const prevYm=prevMonthSummary?.ym;
    const rows=selectedCatIds.map(id=>{
      const stat=categoryStats[id]; if(!stat) return null;
      const cat=stat.category;
      const ld=stat.months[lastYm]||{total:0,count:0};
      const pd=prevYm?(stat.months[prevYm]||{total:0,count:0}):null;
      const avgL=ld.count?ld.total/ld.count:0;
      const avgP=pd&&pd.count?pd.total/pd.count:0;
      const dAmt=pd?ld.total-pd.total:ld.total;
      const dPct=pd&&pd.total>0?(dAmt/pd.total)*100:0;
      const dCnt=pd?ld.count-pd.count:ld.count;
      const dAvg=avgL-avgP;
      const dAvgP=avgP?(dAvg/avgP)*100:0;
      const cntChg=pd&&pd.count>0?Math.abs(dCnt/pd.count):dCnt?1:0;
      const avgChg=avgP?Math.abs(dAvg/avgP):avgL?1:0;
      let comment='Stabilnie';
      if(!pd||(pd.total===0&&pd.count===0)) comment=dAmt>0?'Nowa aktywno\u015B\u0107':'Brak danych';
      else if(Math.abs(dAmt)<pd.total*0.05) comment='Stabilnie';
      else if(cntChg>avgChg*1.2) comment=dAmt>=0?'\u2191 liczba transakcji':'\u2193 liczba transakcji';
      else if(avgChg>cntChg*1.2) comment=dAmt>=0?'\u2191 kwoty':'\u2193 kwoty';
      else comment=dAmt>=0?'Wzrost mieszany':'Spadek mieszany';
      return {cat,ld,pd,avgL,avgP,dAmt,dPct,dCnt,dAvg,dAvgP,type:cat?.type||selectedMood,comment};
    }).filter(Boolean);
    if(!rows.length){table.innerHTML='<tbody><tr><td class="muted" style="text-align:center" colspan="7">Brak danych</td></tr></tbody>';return;}
    let h=`<thead><tr><th>Kategoria</th><th style="text-align:right">${formatMonthLabel(lastYm)}</th><th style="text-align:right">${prevYm?formatMonthLabel(prevYm):'Prev'}</th><th style="text-align:right">\u0394 suma</th><th style="text-align:right">\u0394 liczby</th><th style="text-align:right">\u0394 \u015Bredniej</th><th>Komentarz</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      const lastCell=`${fmt(r.ld.total,state.currency)}<br><span class="muted" style="font-size:10px">${r.ld.count}x \u00D7 ${fmt(r.avgL,state.currency)}</span>`;
      const prevCell=r.pd?r.pd.total>0?`${fmt(r.pd.total,state.currency)}<br><span class="muted" style="font-size:10px">${r.pd.count}x \u00D7 ${fmt(r.avgP,state.currency)}</span>`:'\u2014':'\u2014';
      h+=`<tr><td>${r.cat?.emoji||''} ${escapeHtml(r.cat?.name||'\u2014')}</td><td style="text-align:right">${lastCell}</td><td style="text-align:right">${prevCell}</td><td style="text-align:right">${formatTrend(r.dAmt,r.dPct,r.type)}</td><td style="text-align:right">${formatCountTrend(r.dCnt,r.pd?.count||0,r.type)}</td><td style="text-align:right">${formatTrend(r.dAvg,r.dAvgP,r.type)}</td><td style="font-size:12px">${r.comment}</td></tr>`;
    });
    h+='</tbody>';
    table.innerHTML=h;
  }

  function renderAnCatDeepDive(catId, ctx){
    const wrap=document.getElementById('an-cat-deepdive');
    if(!wrap) return;
    const stat=ctx.categoryStats[catId];
    if(!stat){wrap.style.display='none';return;}
    wrap.style.display='';
    const cat=stat.category;
    const title=document.getElementById('an-dd-title');
    if(title) title.textContent=`Deep-dive: ${cat?.emoji||''} ${cat?.name||'\u2014'}`;
    // KPIs
    const kpi=document.getElementById('an-dd-kpis');
    const avg=stat.count?stat.total/stat.count:0;
    const median=calcMedian(stat.values);
    const monthVals=ctx.months.map(ym=>stat.months[ym]?.total||0);
    const lastVal=monthVals.length?monthVals[monthVals.length-1]:0;
    const prevVal=monthVals.length>=2?monthVals[monthVals.length-2]:0;
    const delta=lastVal-prevVal;
    const deltaPct=prevVal?(delta/prevVal*100):0;
    const avgMonthly=stat.total/(ctx.months.length||1);
    if(kpi) kpi.innerHTML=`
      <div class="an-kpi accent"><div class="an-kpi-label">Suma ca\u0142kowita</div><div class="an-kpi-val">${fmt(stat.total,state.currency)}</div><div class="an-kpi-sub">${stat.count} transakcji</div></div>
      <div class="an-kpi"><div class="an-kpi-label">\u015Arednia mies.</div><div class="an-kpi-val">${fmt(avgMonthly,state.currency)}</div><div class="an-kpi-sub">\u015Arednia tx: ${fmt(avg,state.currency)}</div></div>
      <div class="an-kpi ${delta>0?'red':delta<0?'green':''}"><div class="an-kpi-label">\u0394 m/m</div><div class="an-kpi-val">${delta>=0?'+':''}${fmt(delta,state.currency)}</div><div class="an-kpi-sub">${deltaPct>=0?'+':''}${deltaPct.toFixed(1)}%</div></div>
      <div class="an-kpi"><div class="an-kpi-label">Mediana / Max</div><div class="an-kpi-val">${fmt(median,state.currency)}</div><div class="an-kpi-sub">Max: ${fmt(stat.max?.amount||0,state.currency)}</div></div>
    `;
    // Chart
    if(anDdChart){anDdChart.destroy();anDdChart=null;}
    const canvas=document.getElementById('an-dd-chart');
    if(canvas&&ctx.months.length>0){
      const color=ANALYTICS_COLORS[0];
      anDdChart=new Chart(canvas.getContext('2d'),{
        type:'bar',
        data:{labels:ctx.months.map(m=>formatMonthLabel(m)),datasets:[
          {label:'Suma',data:monthVals,backgroundColor:withAlpha(color,.5),borderRadius:6},
          {type:'line',label:'\u015Arednia',data:ctx.months.map(()=>avgMonthly),borderColor:'#0f172a',borderDash:[6,3],borderWidth:2,pointRadius:0,fill:false}
        ]},
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{position:'bottom',labels:{font:{size:11}}},tooltip:{callbacks:{label:c2=>`${c2.dataset.label}: ${fmt(c2.parsed.y,state.currency)}`}}},
          scales:{x:{grid:{display:false}},y:{beginAtZero:true,ticks:{callback:v=>currencyTicks(v)}}}
        }
      });
    }
    // Table: per-month detail
    const dt=document.getElementById('an-dd-table');
    if(dt){
      let h='<thead><tr><th>Miesi\u0105c</th><th style="text-align:right">Suma</th><th style="text-align:right">Transakcji</th><th style="text-align:right">\u015Arednia</th><th style="text-align:right">\u0394 m/m</th></tr></thead><tbody>';
      [...ctx.months].reverse().forEach((ym,i)=>{
        const md=stat.months[ym]||{total:0,count:0};
        const prevYm=[...ctx.months].reverse()[i+1];
        const prevMd=prevYm?(stat.months[prevYm]||{total:0}):null;
        const d=prevMd?md.total-prevMd.total:0;
        const dp=prevMd&&prevMd.total>0?(d/prevMd.total)*100:0;
        const mAvg=md.count?md.total/md.count:0;
        h+=`<tr><td><strong>${formatMonthLabel(ym)}</strong></td><td style="text-align:right">${fmt(md.total,state.currency)}</td><td style="text-align:right">${md.count}</td><td style="text-align:right">${fmt(mAvg,state.currency)}</td><td style="text-align:right">${prevMd?formatTrend(d,dp,cat?.type||'expense'):'\u2014'}</td></tr>`;
      });
      h+='</tbody>';
      dt.innerHTML=h;
    }
    wrap.scrollIntoView({behavior:'smooth',block:'start'});
  }

  // ==== HABITS VIEW ====
  function renderAnHeatmap(ctx){
    const wrap=document.getElementById('an-heatmap');
    if(!wrap) return;
    const {allEntriesInPeriod,months,selectedCatIds}=ctx;
    const selectedSet=new Set(selectedCatIds);
    const cm=catsById();
    // Group by date
    const byDate={};
    let maxDay=0;
    (allEntriesInPeriod||[]).forEach(tx=>{
      const process=(catId,rawAmt)=>{
        const cat=cm[catId];
        if(!cat||(cat.type!=='expense'&&cat.type!=='saving')) return;
        if(selectedSet.size>0&&!selectedSet.has(catId)) return;
        const amt=Math.abs(num(rawAmt));
        if(amt<=0) return;
        byDate[tx.date]=(byDate[tx.date]||0)+amt;
      };
      if(tx.splits&&tx.splits.length>0) tx.splits.forEach(s=>process(s.categoryId,s.amount));
      else process(tx.categoryId,tx.amount);
    });
    Object.values(byDate).forEach(v=>{if(v>maxDay)maxDay=v;});
    // Render last 3 months as calendar grids
    const displayMonths=months.slice(-3);
    if(!displayMonths.length){wrap.innerHTML='<div class="muted" style="padding:12px;text-align:center">Brak danych</div>';return;}
    const dayNames=['Pn','Wt','\u015Ar','Cz','Pt','So','Nd'];
    let html='';
    displayMonths.forEach(ym=>{
      const [y,m]=ym.split('-').map(Number);
      const daysInMonth=new Date(y,m,0).getDate();
      const firstDow=(new Date(y,m-1,1).getDay()+6)%7; // Mon=0
      html+=`<div class="an-heatmap-month"><div class="an-heatmap-month-label">${formatMonthLabel(ym)}</div>`;
      html+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;font-size:10px;color:var(--muted);margin-bottom:3px">${dayNames.map(d=>`<div style="text-align:center">${d}</div>`).join('')}</div>`;
      html+=`<div class="an-heatmap-grid" style="grid-template-columns:repeat(7,1fr)">`;
      for(let i=0;i<firstDow;i++) html+=`<div class="an-heatmap-cell" style="background:transparent"></div>`;
      for(let d=1;d<=daysInMonth;d++){
        const dateStr=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const val=byDate[dateStr]||0;
        const intensity=maxDay>0?Math.min(val/maxDay,1):0;
        const bg=val===0?'rgba(148,163,184,.06)':`rgba(239,68,68,${0.1+intensity*0.7})`;
        const title=val>0?`${dateStr}: ${fmt(val,state.currency)}`:`${dateStr}: brak wydatk\u00F3w`;
        html+=`<div class="an-heatmap-cell" style="background:${bg}" title="${title}"></div>`;
      }
      html+=`</div></div>`;
    });
    // Legend
    html+=`<div class="an-heatmap-legend"><span>Mniej</span>`;
    [0,.15,.35,.55,.8].forEach(op=>{
      html+=`<div class="an-heatmap-legend-cell" style="background:rgba(239,68,68,${0.1+op*0.7})"></div>`;
    });
    html+=`<span>Wi\u0119cej</span></div>`;
    wrap.innerHTML=html;
  }

  function renderAnStreaks(ctx){
    const wrap=document.getElementById('an-streaks');
    if(!wrap) return;
    const {categoryStats,selectedCatIds,months}=ctx;
    if(months.length<3){wrap.innerHTML='<div class="muted" style="padding:12px;text-align:center">Min. 3 miesi\u0105ce danych</div>';return;}
    // For each category: track consecutive months where spending decreased or stayed stable
    const rows=selectedCatIds.map(id=>{
      const stat=categoryStats[id];
      if(!stat||!stat.total) return null;
      const cat=stat.category;
      const avgPM=stat.total/(months.length||1);
      const monthChecks=months.map(ym=>{
        const v=stat.months[ym]?.total||0;
        return v<=avgPM*1.1; // within 10% of average = "on track"
      });
      let currentStreak=0;
      for(let i=monthChecks.length-1;i>=0;i--){
        if(monthChecks[i]) currentStreak++; else break;
      }
      let bestStreak=0,s=0;
      monthChecks.forEach(ok=>{if(ok){s++;if(s>bestStreak)bestStreak=s;}else s=0;});
      return {cat,monthChecks,currentStreak,bestStreak,avgPM};
    }).filter(Boolean).sort((a,b2)=>b2.currentStreak-a.currentStreak).slice(0,8);
    if(!rows.length){wrap.innerHTML='<div class="muted" style="padding:12px;text-align:center">Brak danych</div>';return;}
    let html='';
    rows.forEach(r=>{
      const dots=r.monthChecks.slice(-12).map((ok,i)=>`<div class="an-streak-dot" style="background:${ok?'#22c55e':'#ef4444'}" title="${months.slice(-12)[i]||''}">${ok?'\u2713':'\u2717'}</div>`).join('');
      html+=`<div class="an-streak-row">
        <div class="an-streak-label">${r.cat.emoji||''} ${escapeHtml(r.cat.name)}</div>
        <div class="an-streak-dots">${dots}</div>
        <div class="an-streak-stat">${r.currentStreak} mies.</div>
      </div>`;
    });
    html+=`<div class="muted" style="font-size:11px;margin-top:6px">\u2713 = wydatki \u2264 110% \u015Bredniej \u2022 Ostatnie 12 miesi\u0119cy</div>`;
    wrap.innerHTML=html;
  }

  function renderAnDowChart(ctx){
    const canvas=document.getElementById('an-dow-chart');
    if(!canvas) return;
    destroyAnalyticsChart('dow');
    const {allEntriesInPeriod,selectedCatIds}=ctx;
    const selectedSet=new Set(selectedCatIds);
    const cm=catsById();
    const dowTotals=[0,0,0,0,0,0,0];
    const dowCounts=[0,0,0,0,0,0,0];
    (allEntriesInPeriod||[]).forEach(tx=>{
      const process=(catId,rawAmt)=>{
        const cat=cm[catId];
        if(!cat||(cat.type!=='expense'&&cat.type!=='saving')) return;
        if(selectedSet.size>0&&!selectedSet.has(catId)) return;
        const amt=Math.abs(num(rawAmt));
        if(amt<=0) return;
        const d=new Date(tx.date);
        if(isNaN(d)) return;
        const dow=(d.getDay()+6)%7;
        dowTotals[dow]+=amt;
        dowCounts[dow]+=1;
      };
      if(tx.splits&&tx.splits.length>0) tx.splits.forEach(s=>process(s.categoryId,s.amount));
      else process(tx.categoryId,tx.amount);
    });
    const dowAvg=dowTotals.map((t,i)=>dowCounts[i]?t/dowCounts[i]:0);
    const dayLabels=['Poniedzia\u0142ek','Wtorek','\u015Aroda','Czwartek','Pi\u0105tek','Sobota','Niedziela'];
    const maxAvg=Math.max(...dowAvg);
    const colors=dowAvg.map(v=>{
      const ratio=maxAvg>0?v/maxAvg:0;
      return ratio>0.8?'rgba(239,68,68,.7)':ratio>0.5?'rgba(249,115,22,.6)':'rgba(34,197,94,.5)';
    });
    analyticsCharts.dow=new Chart(canvas.getContext('2d'),{
      type:'bar',
      data:{labels:dayLabels,datasets:[{label:'\u015Aredni wydatek',data:dowAvg,backgroundColor:colors,borderRadius:8}]},
      options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',
        plugins:{legend:{display:false},tooltip:{callbacks:{label:c2=>`\u015Arednia: ${fmt(c2.parsed.x,state.currency)} (${dowCounts[c2.dataIndex]} transakcji)`}}},
        scales:{x:{ticks:{callback:v=>currencyTicks(v)},grid:{color:'rgba(148,163,184,.08)'}},y:{grid:{display:false}}}
      }
    });
  }

  function renderAnRecurring(ctx){
    const wrap=document.getElementById('an-recurring');
    if(!wrap) return;
    const {allEntriesInPeriod,selectedCatIds,months}=ctx;
    if(months.length<2){wrap.innerHTML='<div class="muted" style="padding:12px;text-align:center">Min. 2 miesi\u0105ce danych</div>';return;}
    const selectedSet=new Set(selectedCatIds);
    const cm=catsById();
    // Group by category+approximate amount (rounded to nearest 10)
    const patterns={};
    (allEntriesInPeriod||[]).forEach(tx=>{
      const process=(catId,rawAmt)=>{
        const cat=cm[catId];
        if(!cat||(cat.type!=='expense'&&cat.type!=='saving')) return;
        if(selectedSet.size>0&&!selectedSet.has(catId)) return;
        const amt=Math.abs(num(rawAmt));
        if(amt<10) return;
        const bucket=Math.round(amt/10)*10;
        const key=`${catId}_${bucket}`;
        if(!patterns[key]) patterns[key]={catId,bucket,months:new Set(),total:0,count:0};
        patterns[key].months.add(tx.date.slice(0,7));
        patterns[key].total+=amt;
        patterns[key].count+=1;
      };
      if(tx.splits&&tx.splits.length>0) tx.splits.forEach(s=>process(s.categoryId,s.amount));
      else process(tx.categoryId,tx.amount);
    });
    const recurring=Object.values(patterns)
      .filter(p=>p.months.size>=Math.min(months.length,3)&&p.count>=3)
      .sort((a,b2)=>b2.total-a.total).slice(0,8);
    if(!recurring.length){wrap.innerHTML='<div class="muted" style="padding:12px;text-align:center">Brak wykrytych wzorc\u00F3w powtarzalnych</div>';return;}
    let html='';
    recurring.forEach(r=>{
      const cat=cm[r.catId];
      const avgAmt=r.total/r.count;
      html+=`<div class="an-recurring-item">
        <div class="an-recurring-amount">${fmt(avgAmt,state.currency)}</div>
        <div class="an-recurring-detail"><strong>${cat?.emoji||''} ${escapeHtml(cat?.name||'\u2014')}</strong><div class="an-recurring-freq">${r.months.size} z ${months.length} miesi\u0119cy \u2022 ${r.count} wyst\u0105pie\u0144 \u2022 Suma: ${fmt(r.total,state.currency)}</div></div>
      </div>`;
    });
    wrap.innerHTML=html;
  }

  // ==== MAIN renderAnalytics ====
  function renderAnalytics(){
    const allMonths=getAnalyticsAvailableMonths();
    const selectedMonths=getAnalyticsSelectedMonths(allMonths);
    renderAnMonthPicker(allMonths, selectedMonths);

    // View mode binding
    const viewSel=document.getElementById('an-view-mode');
    if(viewSel&&!viewSel.dataset.bound){
      viewSel.dataset.bound='1';
      viewSel.onchange=()=>{anShowView(viewSel.value);renderAnalytics();};
    }
    if(viewSel) viewSel.value=anViewMode;
    anShowView(anViewMode);

    // Deep-dive close
    const ddClose=document.getElementById('an-dd-close');
    if(ddClose&&!ddClose.dataset.bound){ddClose.dataset.bound='1';ddClose.onclick=()=>{const w=document.getElementById('an-cat-deepdive');if(w)w.style.display='none';};}

    ensureAnalyticsSortDefaults();
    const expenseCats=analyticsExpenseCategories();

    if(selectedMonths.length===0){
      const emptyStats={};
      for(const cat of expenseCats) emptyStats[cat.id]={category:cat,total:0,count:0,values:[],months:{},max:{amount:0,date:''},min:{amount:0,date:''}};
      renderAnFilterPanel(expenseCats, emptyStats, 0);
      const msg=allMonths.length?'Wybierz miesi\u0105ce, aby zobaczy\u0107 analizy.':'Brak danych historycznych.';
      const kpi=document.getElementById('an-kpis');
      if(kpi) kpi.innerHTML=`<p class="muted" style="grid-column:1/-1;text-align:center">${msg}</p>`;
      ['pulse','catDoughnut','catTrend','dow'].forEach(k=>destroyAnalyticsChart(k));
      return;
    }

    const monthsToAnalyze=selectedMonths;
    const monthsSet=new Set(monthsToAnalyze);
    const selectedCatIds=getActiveAnalyticsCategoryIds(expenseCats);
    const selectedCatSet=new Set(selectedCatIds);
    const catsMap=catsById();

    const allEntriesInPeriod=b().transactions.filter(t=>monthsSet.has(t.date.slice(0,7)));

    const categoryStats={};
    const monthlySummaries=[];
    let totalIncome=0,totalExpenseAll=0,totalSelectedExpense=0,totalSelectedCount=0,totalEntriesAll=0;
    const selectedAmounts=[];

    monthsToAnalyze.forEach(ym=>{
      ensureMonth(ym);
      const monthIncome=b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
      totalIncome+=monthIncome;
      const monthEntries=entriesForMonth(ym);
      let monthExpense=0,monthSelectedTotal=0,monthSelectedCount=0;
      const monthSelectedValues=[];
      const byCategory={};

      monthEntries.forEach(e=>{
        const cat=catsMap[e.categoryId];
        if(!cat||(cat.type!=='expense'&&cat.type!=='saving')) return;
        const amount=Math.abs(e.amount);
        monthExpense+=amount;totalExpenseAll+=amount;totalEntriesAll+=1;
        let stat=categoryStats[cat.id];
        if(!stat){stat=categoryStats[cat.id]={category:cat,total:0,count:0,values:[],months:{},max:{amount:0,date:''},min:{amount:Infinity,date:''}};}
        stat.total+=amount;stat.count+=1;stat.values.push(amount);
        if(!stat.months[ym])stat.months[ym]={total:0,count:0,values:[]};
        stat.months[ym].total+=amount;stat.months[ym].count+=1;stat.months[ym].values.push(amount);
        if(amount>stat.max.amount)stat.max={amount,date:e.date};
        if(amount<stat.min.amount)stat.min={amount,date:e.date};
        if(!byCategory[cat.id])byCategory[cat.id]={total:0,count:0,values:[]};
        byCategory[cat.id].total+=amount;byCategory[cat.id].count+=1;byCategory[cat.id].values.push(amount);
        if(selectedCatSet.has(cat.id)){
          monthSelectedTotal+=amount;monthSelectedCount+=1;
          totalSelectedExpense+=amount;totalSelectedCount+=1;
          selectedAmounts.push(amount);monthSelectedValues.push(amount);
        }
      });

      monthlySummaries.push({ym,incomes:monthIncome,expenses:monthExpense,selectedTotal:monthSelectedTotal,selectedCount:monthSelectedCount,selectedAvg:monthSelectedCount?monthSelectedTotal/monthSelectedCount:0,selectedMedian:calcMedian(monthSelectedValues),byCategory});
    });

    expenseCats.forEach(cat=>{
      if(!categoryStats[cat.id]) categoryStats[cat.id]={category:cat,total:0,count:0,values:[],months:{},max:{amount:0,date:''},min:{amount:0,date:''}};
      else if(categoryStats[cat.id].min.amount===Infinity) categoryStats[cat.id].min={amount:0,date:''};
    });

    const monthsCount=monthsToAnalyze.length;
    const netChange=totalIncome-totalExpenseAll;
    const avgSavingsRate=totalIncome>0?(netChange/totalIncome)*100:0;
    const selectedAvg=totalSelectedCount?totalSelectedExpense/totalSelectedCount:0;
    const selectedMedian=calcMedian(selectedAmounts);
    const selectedShare=totalExpenseAll>0?(totalSelectedExpense/totalExpenseAll)*100:0;
    const lastMonthSummary=monthlySummaries[monthlySummaries.length-1];
    const prevMonthSummary=monthlySummaries.length>=2?monthlySummaries[monthlySummaries.length-2]:null;
    const lastVsPrevAmount=prevMonthSummary?lastMonthSummary.selectedTotal-prevMonthSummary.selectedTotal:0;
    const lastVsPrevPercent=(prevMonthSummary&&prevMonthSummary.selectedTotal>0)?(lastVsPrevAmount/prevMonthSummary.selectedTotal)*100:0;
    const lastCountDelta=prevMonthSummary?lastMonthSummary.selectedCount-prevMonthSummary.selectedCount:0;
    const selectedTypeTotals=selectedCatIds.reduce((acc,id)=>{const cat=categoryStats[id]?.category;if(!cat)return acc;acc[cat.type]=(acc[cat.type]||0)+(categoryStats[id]?.total||0);return acc;},{expense:0,saving:0});
    const selectedMood=selectedTypeTotals.saving>selectedTypeTotals.expense?'saving':'expense';
    const largestCategory=selectedCatIds.map(id=>categoryStats[id]).filter(Boolean).sort((a,b2)=>(b2?.total||0)-(a?.total||0))[0]||null;

    const analyticsContext={months:monthsToAnalyze,monthlySummaries,categoryStats,selectedCatIds,totalSelectedExpense,totalSelectedCount,selectedAvg,selectedMedian,selectedShare,totalExpenseAll,totalIncome,netChange,avgSavingsRate,monthsCount,lastMonthSummary,prevMonthSummary,lastVsPrevAmount,lastVsPrevPercent,lastCountDelta,selectedMood,largestCategory,allEntriesInPeriod,totalEntriesAll,selectedTypeTotals};

    renderAnFilterPanel(expenseCats, categoryStats, totalExpenseAll);

    // Dashboard view
    renderAnKpis(analyticsContext);
    renderAnPulseChart(monthlySummaries);
    renderAnCatBars(categoryStats, selectedCatIds, monthlySummaries);
    renderAnCatDoughnut(categoryStats, selectedCatIds);
    renderAnDeviationBars(categoryStats, selectedCatIds, monthlySummaries);
    renderAnAnomalies(analyticsContext);
    renderAnMonthlyTable(analyticsContext);
    renderAnTopTx(analyticsContext);

    // Categories view
    renderAnCatTrendChart(monthsToAnalyze, categoryStats, selectedCatIds);
    renderAnCatRanking(analyticsContext);
    renderAnCatMatrix(monthsToAnalyze, categoryStats, selectedCatIds);
    renderAnMomentum(analyticsContext);

    // Habits view
    renderAnHeatmap(analyticsContext);
    renderAnStreaks(analyticsContext);
    renderAnDowChart(analyticsContext);
    renderAnRecurring(analyticsContext);
  }

  // --- MoM comparison ----------------------------------------------------------
  const MOM_COLORS={a:'#0ea5e9',b:'#f97316'};
  const MOM_DIFF_COLORS={positive:'#ef4444',negative:'#22c55e',neutral:'#94a3b8'};
  const MOM_NO_FIXED_ID='__all_no_fixed';
  const MOM_NO_FIXED_LABEL='Wszystkie bez wydatków stałych';
  const MOM_NO_FIXED_SAVINGS_ID='__all_no_fixed_savings';
  const MOM_NO_FIXED_SAVINGS_LABEL='Wszystkie bez stałych i oszczędności';
  const MOM_SAVINGS_ID='__all_savings';
  const MOM_SAVINGS_LABEL='Wszystkie oszczędności';
  const MOM_FIXED_CATEGORY_ID='c_fixed';
  const momState={
    monthA:null,
    monthB:null,
    day:Math.min(31,Math.max(1,new Date().getDate())),
    selectedCategory:'__all'
  };
  let momChart=null;
  let momDiffChart=null;
  let momDetailWaterfallChart=null;
  let momDetailForecastChart=null;
  let momLastContext=null;
  let momDetailHeatmapData=new Map();
  let momDetailHeatmapTooltip=null;

  function momPalette(){
    return {
      monthA: cssVar('--blue', MOM_COLORS.a),
      monthB: cssVar('--orange', MOM_COLORS.b),
      positive: cssVar('--red', MOM_DIFF_COLORS.positive),
      negative: cssVar('--green', MOM_DIFF_COLORS.negative),
      neutral: cssVar('--muted', MOM_DIFF_COLORS.neutral),
      ink: cssVar('--ink', '#0f172a'),
      muted: cssVar('--muted', '#475569')
    };
  }

  function destroyMomChart(){
    if(momChart){momChart.destroy(); momChart=null;}
  }

  function destroyMomDiffChart(){
    if(momDiffChart){momDiffChart.destroy(); momDiffChart=null;}
  }

  function destroyMomDetailWaterfallChart(){
    if(momDetailWaterfallChart){
      momDetailWaterfallChart.destroy();
      momDetailWaterfallChart=null;
    }
  }

  function destroyMomDetailForecastChart(){
    if(momDetailForecastChart){
      momDetailForecastChart.destroy();
      momDetailForecastChart=null;
    }
  }

  function renderMomDetailWaterfallChart(detail){
    const canvas=document.getElementById('mom-detail-waterfall');
    if(!canvas){
      destroyMomDetailWaterfallChart();
      return;
    }
    if(!detail || !Array.isArray(detail.days)){
      destroyMomDetailWaterfallChart();
      return;
    }
    const ctx=canvas.getContext('2d');
    if(!ctx){
      destroyMomDetailWaterfallChart();
      return;
    }
    const palette=momPalette();
    const ranked=detail.days
      .map((day,index)=>({index,impact:Math.abs(day.delta)}))
      .filter(item=>item.impact>0)
      .sort((a,b)=>b.impact-a.impact)
      .slice(0,3)
      .map(item=>item.index);
    const highlightSet=new Set(ranked);
    let cumulative=0;
    const dataPoints=detail.days.map(day=>{
      const start=cumulative;
      cumulative+=day.delta;
      return [start,cumulative];
    });
    const totalDiff=detail.totalA-detail.totalB;
    destroyMomDetailWaterfallChart();
    momDetailWaterfallChart=new Chart(ctx,{
      type:'bar',
      data:{
        labels:detail.days.map(day=>day.label),
        datasets:[{
          label:'Wpływ dnia',
          data:dataPoints,
          borderRadius:6,
          barPercentage:0.9,
          categoryPercentage:0.9,
          backgroundColor:context=>{
            const day=detail.days[context.dataIndex];
            const tone=day.delta>0?palette.positive:day.delta<0?palette.negative:palette.neutral;
            const alpha=highlightSet.has(context.dataIndex)&&Math.abs(day.delta)>0.01?0.88:0.65;
            return colorWithAlpha(tone,alpha);
          },
          borderColor:context=>{
            const day=detail.days[context.dataIndex];
            const tone=day.delta>0?palette.positive:day.delta<0?palette.negative:palette.neutral;
            const alpha=highlightSet.has(context.dataIndex)&&Math.abs(day.delta)>0.01?0.95:0.55;
            return colorWithAlpha(tone,alpha);
          },
          borderWidth:context=>{
            const day=detail.days[context.dataIndex];
            return highlightSet.has(context.dataIndex)&&Math.abs(day.delta)>0.01?3:1;
          },
          hoverBackgroundColor:context=>{
            const day=detail.days[context.dataIndex];
            const tone=day.delta>0?palette.positive:day.delta<0?palette.negative:palette.neutral;
            return colorWithAlpha(tone,0.95);
          },
          hoverBorderColor:context=>{
            const day=detail.days[context.dataIndex];
            const tone=day.delta>0?palette.positive:day.delta<0?palette.negative:palette.neutral;
            return colorWithAlpha(tone,0.95);
          }
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:{duration:420},
        interaction:{mode:'index',intersect:false},
        plugins:{
          legend:{display:false},
          tooltip:{
            backgroundColor:colorWithAlpha(cssVar('--surface','#f8fafc'),0.98),
            borderColor:colorWithAlpha(cssVar('--ink','#0f172a'),0.12),
            borderWidth:1,
            padding:12,
            caretSize:6,
            titleColor:cssVar('--ink','#0f172a'),
            titleFont:{
              family:"Inter, system-ui, -apple-system, 'Segoe UI', sans-serif",
              size:13,
              weight:'600'
            },
            bodyColor:cssVar('--ink','#0f172a'),
            bodyFont:{
              family:"Inter, system-ui, -apple-system, 'Segoe UI', sans-serif",
              size:12,
              weight:'500'
            },
            callbacks:{
              title:items=>{
                if(!items.length) return '';
                const day=detail.days[items[0].dataIndex];
                const sampleIso=day.isoA||day.isoB;
                const weekday=formatWeekdayShort(sampleIso);
                return weekday?`Dzień ${day.label} • ${weekday}`:`Dzień ${day.label}`;
              },
              label:context=>{
                const day=detail.days[context.dataIndex];
                const diff=day.delta;
                const diffAbs=fmt(Math.abs(diff), state.currency);
                const diffLabel=diff>0?`+${diffAbs}`:diff<0?`−${diffAbs}`:diffAbs;
                let pctLabel='—';
                if(totalDiff!==0){
                  const pct=(diff/totalDiff)*100;
                  const pctSign=pct>0?'+':pct<0?'−':'';
                  pctLabel=`${pctSign}${Math.abs(pct).toFixed(1)}%`;
                }
                return [
                  `Miesiąc A: ${fmt(day.totalA,state.currency)}`,
                  `Miesiąc B: ${fmt(day.totalB,state.currency)}`,
                  `Różnica: ${diffLabel}`,
                  `Udział: ${pctLabel}`
                ];
              },
              labelColor:context=>{
                const day=detail.days[context.dataIndex];
                const tone=day.delta>0?palette.positive:day.delta<0?palette.negative:palette.neutral;
                return {borderColor:tone,backgroundColor:tone};
              },
              labelTextColor:()=>cssVar('--ink','#0f172a')
            }
          }
        },
        scales:{
          x:{
            grid:{display:false},
            ticks:{color:cssVar('--muted','#475569')}
          },
          y:{
            grid:{color:colorWithAlpha(palette.ink,0.08)},
            ticks:{callback:value=>currencyTicks(value)}
          }
        }
      }
    });
  }

  function ensureMomState(months){
    const sorted=[...months].sort();
    if(sorted.length===0){
      momState.monthA=null;
      momState.monthB=null;
      momState.selectedCategory='__all';
      return;
    }

    const workingMonth=b().workingMonth;
    if(!sorted.includes(momState.monthA)){
      if(workingMonth && sorted.includes(workingMonth)) momState.monthA=workingMonth;
      else momState.monthA=sorted[sorted.length-1];
    }

    if(!sorted.includes(momState.monthB)){
      const base=sorted.includes(momState.monthA)?momState.monthA:sorted[sorted.length-1];
      const desiredPrev=base?ymAdd(base,-1):null;
      if(desiredPrev && sorted.includes(desiredPrev)) momState.monthB=desiredPrev;
      else {
        const idx=sorted.indexOf(base);
        if(idx>0) momState.monthB=sorted[idx-1];
        else if(sorted.length>1) momState.monthB=sorted[sorted.length-2];
        else momState.monthB=base;
      }
    }

    const rawDay=Number(momState.day);
    if(!Number.isFinite(rawDay) || rawDay<1){
      momState.day=Math.min(31,Math.max(1,new Date().getDate()));
    }else{
      momState.day=Math.min(31,Math.max(1,Math.round(rawDay)));
    }
  }

  function getMomEffectiveDay(monthA,monthB,requested){
    const values=[];
    if(Number.isFinite(requested) && requested>0) values.push(requested);
    if(monthA) values.push(daysInYm(monthA));
    if(monthB) values.push(daysInYm(monthB));
    if(!values.length) return 1;
    return Math.min(...values);
  }

  function buildMomSeries(ym,categoryIds){
    const out={ym,days:0,series:{}};
    categoryIds.forEach(id=>{out.series[id]=[];});
    if(!ym) return out;
    const days=daysInYm(ym);
    out.days=days;
    categoryIds.forEach(id=>{out.series[id]=Array(days).fill(0);});
    const catSet=new Set(categoryIds);
    const entries=entriesForMonth(ym);
    for(const entry of entries){
      const cat=catsById()[entry.categoryId];
      if(!cat || (cat.type!=='expense' && cat.type!=='saving')) continue;
      const isSaving=cat.type==='saving';
      const isExpense=cat.type==='expense';
      if(!catSet.has(entry.categoryId) && !isSaving) continue;
      const day=Math.min(days,Math.max(1,Number(entry.date.slice(-2))||1));
      const idx=day-1;
      const amount=Math.abs(entry.amount);
      if(out.series[entry.categoryId]){
        out.series[entry.categoryId][idx]+=amount;
      }
      if(out.series.__all) out.series.__all[idx]+=amount;
      if(out.series[MOM_SAVINGS_ID] && isSaving){
        out.series[MOM_SAVINGS_ID][idx]+=amount;
      }
      if(out.series[MOM_NO_FIXED_ID]){
        const eligible = (isExpense && entry.categoryId!==MOM_FIXED_CATEGORY_ID) || isSaving;
        if(eligible) out.series[MOM_NO_FIXED_ID][idx]+=amount;
      }
      if(out.series[MOM_NO_FIXED_SAVINGS_ID] && isExpense && entry.categoryId!==MOM_FIXED_CATEGORY_ID){
        out.series[MOM_NO_FIXED_SAVINGS_ID][idx]+=amount;
      }
    }
    for(const id of categoryIds){
      const arr=out.series[id];
      for(let i=1;i<arr.length;i++){arr[i]+=arr[i-1];}
    }
    return out;
  }

  function momSeriesSlice(seriesData,catId,dayLimit){
    const arr=seriesData?.series?.[catId];
    if(!arr || !arr.length) return [];
    const limit=Math.min(dayLimit,arr.length);
    return arr.slice(0,limit);
  }

  function momSeriesValue(seriesData,catId,dayLimit){
    const arr=seriesData?.series?.[catId];
    if(!arr || !arr.length) return 0;
    const idx=Math.min(dayLimit,arr.length);
    if(idx<=0) return 0;
    return arr[idx-1];
  }

  function formatMomDiff(diff){
    if(!Number.isFinite(diff) || Math.abs(diff)<0.01) return '<span class="delta-neutral">—</span>';
    const cls=diff>0?'delta-down':'delta-up';
    const arrow=diff>0?'▲':'▼';
    return `<span class="${cls}">${arrow} ${fmt(Math.abs(diff), state.currency)}</span>`;
  }

  function formatMomPace(totalA,totalB){
    if(!Number.isFinite(totalA)) totalA=0;
    if(!Number.isFinite(totalB)) totalB=0;
    if(totalB<=0) return totalA>0?'<span class="delta-neutral">—</span>':'<span class="delta-neutral">—</span>';
    const pct=((totalA-totalB)/totalB)*100;
    if(!Number.isFinite(pct) || Math.abs(pct)<0.05) return '<span class="delta-neutral">—</span>';
    const cls=pct>0?'delta-down':'delta-up';
    const arrow=pct>0?'▲':'▼';
    return `<span class="${cls}">${arrow} ${Math.abs(pct).toFixed(1)}%</span>`;
  }

  function momCategoryLabel(cat){
    if(!cat) return '';
    if(cat.id==='__all') return 'Wszystkie kategorie';
    const prefix=cat.emoji?cat.emoji+' ':'';
    return `${prefix}${cat.name}`;
  }

  function updateMomActiveRows(tbody){
    if(!tbody) return;
    tbody.querySelectorAll('tr').forEach(row=>{
      row.classList.toggle('active',row.dataset.catId===momState.selectedCategory);
    });
  }

  const MOM_DETAIL_TABS=['overview','calendar','patterns','stats','transactions'];
  let momDetailOpen=false;
  let momDetailSort='impact';
  let momDetailTab='overview';
  let momDetailTabCache={};
  let momDetailBound=false;
  let momDetailKeyBound=false;
  let momDetailScrollRestore=0;

  function isValidMomDetailTab(value){
    return MOM_DETAIL_TABS.includes(value);
  }

  function updateMomDetailTabButtons(){
    document.querySelectorAll('[data-mom-detail-tab]').forEach(btn=>{
      const value=btn.dataset.momDetailTab||'overview';
      const isActive=value===momDetailTab;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-selected', isActive?'true':'false');
      if(isActive){
        btn.removeAttribute('tabindex');
      }else{
        btn.setAttribute('tabindex','-1');
      }
    });
  }

  function updateMomDetailSortVisibility(){
    const sortWrap=document.getElementById('mom-detail-sort');
    if(!sortWrap) return;
    const shouldShow=momDetailTab==='transactions';
    sortWrap.hidden=!shouldShow;
  }

  function activateMomDetailTab(){
    const bodyEl=document.getElementById('mom-detail-body');
    if(!bodyEl) return;
    hideMomDetailHeatmapTooltip();
    const panels=bodyEl.querySelectorAll('[data-mom-detail-panel]');
    panels.forEach(panel=>{
      const key=panel.dataset.momDetailPanel;
      const isActive=key===momDetailTab;
      panel.classList.toggle('is-active', isActive);
      panel.setAttribute('aria-hidden', isActive?'false':'true');
      if(isActive){
        const cache=momDetailTabCache[key];
        if(cache && !cache.loaded){
          cache.render(panel);
          cache.loaded=true;
        }else if(!cache && !panel.dataset.momPlaceholder){
          panel.innerHTML='<div class="mom-detail-empty">Brak danych do wyświetlenia.</div>';
          panel.dataset.momPlaceholder='1';
        }
      }
    });
    updateMomDetailTabButtons();
    updateMomDetailSortVisibility();
    if(momDetailTab==='transactions'){
      updateMomDetailSortButtons();
    }
  }

  function setMomDetailTab(value){
    const valid=isValidMomDetailTab(value)?value:'overview';
    if(momDetailTab===valid){
      activateMomDetailTab();
      return;
    }
    momDetailTab=valid;
    updateMomDetailTabButtons();
    updateMomDetailSortVisibility();
    const scrollWrap=document.querySelector('.mom-detail-scroll');
    const header=document.querySelector('.mom-detail-header');
    if(scrollWrap){
      scrollWrap.scrollTop=0;
      if(header){
        header.classList.toggle('scrolled', scrollWrap.scrollTop>60);
      }
    }
    activateMomDetailTab();
  }

  function momDetailEligible(catId){
    return !!catId && catId!=='__all' && catId!==MOM_NO_FIXED_ID && catId!==MOM_NO_FIXED_SAVINGS_ID && catId!==MOM_SAVINGS_ID;
  }

  function ensureMomDetailBindings(){
    const button=document.getElementById('mom-detail-toggle');
    const panel=document.getElementById('mom-detail-panel');
    const backdrop=document.getElementById('mom-detail-backdrop');
    const closeBtn=document.getElementById('mom-detail-close');
    if(button && panel && backdrop && !momDetailBound){
      button.addEventListener('click',()=>{ if(!button.disabled) openMomDetail(); });
      if(closeBtn){ closeBtn.addEventListener('click',()=>closeMomDetail()); }
      backdrop.addEventListener('click',()=>closeMomDetail());
      momDetailBound=true;
    }
    const sortWrap=document.getElementById('mom-detail-sort');
    if(sortWrap && !sortWrap.dataset.bound){
      sortWrap.dataset.bound='1';
      sortWrap.querySelectorAll('button[data-mom-detail-sort]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const value=btn.dataset.momDetailSort||'impact';
          if(momDetailSort===value) return;
          momDetailSort=value;
          updateMomDetailSortButtons();
          if(momDetailOpen) renderMomDetail();
        });
      });
    }
    const tabsWrap=document.getElementById('mom-detail-tabs');
    if(tabsWrap && !tabsWrap.dataset.bound){
      tabsWrap.dataset.bound='1';
      tabsWrap.querySelectorAll('button[data-mom-detail-tab]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const value=btn.dataset.momDetailTab||'overview';
          setMomDetailTab(value);
        });
      });
    }
    if(!momDetailKeyBound){
      document.addEventListener('keydown',evt=>{
        if(evt.key==='Escape' && momDetailOpen){
          closeMomDetail();
        }
      });
      momDetailKeyBound=true;
    }
  }

  function openMomDetail(){
    const panel=document.getElementById('mom-detail-panel');
    const backdrop=document.getElementById('mom-detail-backdrop');
    if(!panel || !backdrop) return;
    momDetailScrollRestore=window.scrollY||window.pageYOffset||document.documentElement.scrollTop||0;
    if(document.body) document.body.classList.add('mom-detail-open');
    momDetailOpen=true;
    renderMomDetail();
    backdrop.hidden=false;
    panel.setAttribute('aria-hidden','false');
    const showElements=()=>{
      panel.classList.add('is-visible');
      backdrop.classList.add('is-visible');
    };
    if(typeof requestAnimationFrame==='function') requestAnimationFrame(showElements);
    else showElements();
    const closeBtn=document.getElementById('mom-detail-close');
    if(closeBtn) closeBtn.focus({preventScroll:true});
  }

  function closeMomDetail(options={}){
    const {focusTrigger=true}=options;
    const panel=document.getElementById('mom-detail-panel');
    const backdrop=document.getElementById('mom-detail-backdrop');
    if(!panel || !backdrop) return;
    const header=document.querySelector('.mom-detail-header');
    if(header){
      header.classList.remove('scrolled');
    }
    hideMomDetailHeatmapTooltip();
    momDetailHeatmapData.clear();
    momDetailOpen=false;
    destroyMomDetailWaterfallChart();
    destroyMomDetailForecastChart();
    panel.classList.remove('is-visible');
    panel.setAttribute('aria-hidden','true');
    backdrop.classList.remove('is-visible');
    setTimeout(()=>{ if(!momDetailOpen) backdrop.hidden=true; }, 240);
    if(document.body) document.body.classList.remove('mom-detail-open');
    if(Number.isFinite(momDetailScrollRestore) && momDetailScrollRestore>=0){
      window.scrollTo({top:momDetailScrollRestore,left:0,behavior:'auto'});
    }
    momDetailScrollRestore=0;
    if(focusTrigger){
      const button=document.getElementById('mom-detail-toggle');
      if(button) button.focus({preventScroll:true});
    }
  }

  function updateMomDetailSortButtons(){
    document.querySelectorAll('[data-mom-detail-sort]').forEach(btn=>{
      const value=btn.dataset.momDetailSort||'impact';
      btn.classList.toggle('is-active', value===momDetailSort);
    });
  }

  function updateMomDetailTrigger(){
    ensureMomDetailBindings();
    const button=document.getElementById('mom-detail-toggle');
    if(!button){
      if(momDetailOpen) closeMomDetail({focusTrigger:false});
      return;
    }
    const labelEl=button.querySelector('.label');
    const context=momLastContext;
    const selected=context?.categories?.find(c=>c.id===momState.selectedCategory);
    const eligible=context && selected && momDetailEligible(selected.id);
    const enabled=Boolean(eligible && context?.monthA && context?.monthB);
    button.disabled=!enabled;
    button.classList.toggle('is-ready', enabled);
    const labelText=enabled ? `Detale: ${momCategoryLabel(selected)}` : 'Szczegóły kategorii';
    if(labelEl) labelEl.textContent=labelText;
    else button.textContent=labelText;
    if(enabled){
      button.title=`Pokaż transakcje dla ${momCategoryLabel(selected)} (${context.monthA} vs ${context.monthB})`;
    }else{
      button.title='Wybierz kategorię wydatków, aby zobaczyć szczegóły.';
    }
    if(!enabled && momDetailOpen){
      closeMomDetail({focusTrigger:false});
    }
  }

  function formatYmHuman(ym){
    if(!ym) return '';
    const parts=ym.split('-').map(Number);
    if(parts.length<2) return ym;
    const [year, month]=parts;
    if(!year || !month) return ym;
    const date=new Date(year, month-1, 1);
    if(Number.isNaN(date.getTime())) return ym;
    try{
      return date.toLocaleDateString('pl-PL',{month:'long',year:'numeric'});
    }catch(err){
      return ym;
    }
  }

  function formatWeekdayShort(iso){
    if(!iso) return '';
    const date=new Date(iso);
    if(Number.isNaN(date.getTime())) return '';
    try{
      return date.toLocaleDateString('pl-PL',{weekday:'short'});
    }catch(err){
      return '';
    }
  }

  function percentile(sorted, p){
    if(!Array.isArray(sorted) || !sorted.length) return 0;
    const clamped=Math.min(Math.max(p,0),1);
    if(sorted.length===1) return sorted[0];
    const idx=(sorted.length-1)*clamped;
    const lower=Math.floor(idx);
    const upper=Math.ceil(idx);
    const weight=idx-lower;
    if(upper>=sorted.length) return sorted[sorted.length-1];
    if(lower===upper) return sorted[lower];
    return sorted[lower]+(sorted[upper]-sorted[lower])*weight;
  }

  function computeDistributionStats(values){
    const arr=Array.isArray(values)?values.filter(val=>Number.isFinite(val)&&val>=0):[];
    const count=arr.length;
    if(!count){
      return {
        count:0,
        sum:0,
        mean:0,
        stdDev:0,
        cv:0,
        p25:0,
        median:0,
        p75:0,
        p90:0,
        iqr:0,
        outliers:0,
        outlierThreshold:0,
        gini:0,
        min:0,
        max:0
      };
    }
    const sorted=[...arr].sort((a,b)=>a-b);
    const sum=sorted.reduce((acc,val)=>acc+val,0);
    const mean=sum/count;
    const variance=count>1?sorted.reduce((acc,val)=>acc+Math.pow(val-mean,2),0)/(count-1):0;
    const stdDev=Math.sqrt(Math.max(variance,0));
    const cv=mean>0?stdDev/mean:0;
    const p25=percentile(sorted,0.25);
    const median=percentile(sorted,0.5);
    const p75=percentile(sorted,0.75);
    const p90=percentile(sorted,0.9);
    const iqr=Math.max(p75-p25,0);
    const outlierThreshold=p75+1.5*iqr;
    const outliers=sorted.filter(val=>val>outlierThreshold).length;
    const min=sorted[0];
    const max=sorted[sorted.length-1];
    let gini=0;
    if(sum>0){
      const cumulative=sorted.reduce((acc,val,idx)=>acc+((idx+1)*val),0);
      gini=(2*cumulative)/(count*sum)-(count+1)/count;
      gini=Math.max(0, Math.min(1, gini));
    }
    return {
      count,
      sum,
      mean,
      stdDev,
      cv,
      p25,
      median,
      p75,
      p90,
      iqr,
      outliers,
      outlierThreshold,
      gini,
      min,
      max
    };
  }

  function buildMomDetailData(monthA, monthB, categoryId, dayLimit){
    const limit=Math.max(1, Number(dayLimit)||1);
    const collect=ym=>{
      const map=new Map();
      if(!ym) return map;
      const entries=entriesForMonth(ym);
      for(const entry of entries){
        if(entry.categoryId!==categoryId) continue;
        const day=Number(entry.date.slice(-2));
        if(!Number.isFinite(day) || day<1 || day>limit) continue;
        if(!map.has(day)) map.set(day,[]);
        map.get(day).push(entry);
      }
      return map;
    };
    const mapA=collect(monthA);
    const mapB=collect(monthB);
    const maxDaysA=monthA?daysInYm(monthA):0;
    const maxDaysB=monthB?daysInYm(monthB):0;
    const days=[];
    const amountsA=[];
    const amountsB=[];
    for(let day=1; day<=limit; day++){
      const entriesA=mapA.get(day)||[];
      const entriesB=mapB.get(day)||[];
      const totalA=entriesA.reduce((sum,entry)=>sum+Math.abs(entry.amount),0);
      const totalB=entriesB.reduce((sum,entry)=>sum+Math.abs(entry.amount),0);
      const padded=String(day).padStart(2,'0');
      days.push({
        day,
        label:padded,
        totalA,
        totalB,
        delta: totalA-totalB,
        entriesA,
        entriesB,
        isoA: monthA && day<=maxDaysA ? `${monthA}-${padded}` : null,
        isoB: monthB && day<=maxDaysB ? `${monthB}-${padded}` : null,
        cumulativeA: 0,
        cumulativeB: 0,
        cumulativeDelta: 0
      });
      entriesA.forEach(entry=>amountsA.push(Math.abs(entry.amount)));
      entriesB.forEach(entry=>amountsB.push(Math.abs(entry.amount)));
    }
    let runningA=0;
    let runningB=0;
    let crossoverDay=null;
    let ledFromStart=false;
    let everLed=false;
    let totalCountA=0;
    let totalCountB=0;
    days.forEach((row,idx)=>{
      totalCountA+=row.entriesA.length;
      totalCountB+=row.entriesB.length;
      runningA+=row.totalA;
      runningB+=row.totalB;
      row.cumulativeA=runningA;
      row.cumulativeB=runningB;
      row.cumulativeDelta=runningA-runningB;
      if(runningA>runningB){
        everLed=true;
        if(crossoverDay===null) crossoverDay=row.day;
        if(idx===0) ledFromStart=true;
      }
    });
    const totalA=runningA;
    const totalB=runningB;
    const avgA=totalCountA>0?totalA/totalCountA:0;
    const avgB=totalCountB>0?totalB/totalCountB:0;
    const statsA=computeDistributionStats(amountsA);
    const statsB=computeDistributionStats(amountsB);
    return {
      days,
      totalA,
      totalB,
      dayLimit:limit,
      countA:totalCountA,
      countB:totalCountB,
      avgA,
      avgB,
      medianA:statsA.median,
      medianB:statsB.median,
      maxA:statsA.max,
      maxB:statsB.max,
      statsA,
      statsB,
      crossoverDay,
      ledFromStart,
      everLed,
      finalDelta: totalA-totalB
    };
  }

  function computeMomDetailForecast(detail, monthA, monthB, categoryId){
    if(!detail || !monthA || !categoryId) return null;
    if(categoryId==='__all' || categoryId===MOM_NO_FIXED_ID) return null;
    const now=new Date();
    const [yearStr, monthStr]=monthA.split('-');
    const year=Number(yearStr);
    const monthIndex=Number(monthStr);
    if(!Number.isFinite(year) || !Number.isFinite(monthIndex)) return null;
    if(now.getFullYear()!==year || (now.getMonth()+1)!==monthIndex) return null;
    const daysInMonth=daysInYm(monthA);
    if(!Number.isFinite(daysInMonth) || daysInMonth<=0) return null;
    const today=Math.min(daysInMonth, Math.max(0, now.getDate()));
    const daysElapsed=today;
    const remainingDays=Math.max(0, daysInMonth-daysElapsed);
    const dailyTotals=Array(daysInMonth).fill(0);
    const currentEntries=entriesForMonth(monthA).filter(entry=>entry.categoryId===categoryId);
    for(const entry of currentEntries){
      const day=Number(entry.date?.slice(-2));
      if(Number.isFinite(day) && day>=1 && day<=daysInMonth){
        dailyTotals[day-1]+=Math.abs(entry.amount);
      }
    }
    const spentSoFar=dailyTotals.slice(0, Math.max(0, daysElapsed)).reduce((sum,value)=>sum+value,0);
    const averageDaily=daysElapsed>0?spentSoFar/daysElapsed:0;
    let linearProjection=spentSoFar+averageDaily*remainingDays;
    if(!Number.isFinite(linearProjection)) linearProjection=spentSoFar;
    const recentWindow=Math.min(7, daysElapsed);
    const recentSlice=recentWindow>0?dailyTotals.slice(daysElapsed-recentWindow, daysElapsed):[];
    const recentAverage=recentSlice.length?recentSlice.reduce((sum,value)=>sum+value,0)/recentSlice.length:averageDaily;
    let trendProjection=spentSoFar+recentAverage*remainingDays;
    if(!Number.isFinite(trendProjection)) trendProjection=spentSoFar;
    const allMonths=getAnalyticsAvailableMonths();
    const historyMonths=allMonths.filter(ym=>ym<monthA);
    const historyTotals=historyMonths.map(ym=>{
      const monthEntries=entriesForMonth(ym).filter(entry=>entry.categoryId===categoryId);
      return monthEntries.reduce((sum,entry)=>sum+Math.abs(entry.amount),0);
    }).filter(value=>Number.isFinite(value));
    const historyAverage=historyTotals.length?historyTotals.reduce((sum,value)=>sum+value,0)/historyTotals.length:null;
    let historyProjection=historyAverage!==null?historyAverage:null;
    const safeSpent=Math.max(0, spentSoFar);
    if(linearProjection<safeSpent) linearProjection=safeSpent;
    if(trendProjection<safeSpent) trendProjection=safeSpent;
    if(historyProjection!==null && historyProjection<safeSpent) historyProjection=safeSpent;
    const monthBTotal=monthB
      ? entriesForMonth(monthB).filter(entry=>entry.categoryId===categoryId).reduce((sum,entry)=>sum+Math.abs(entry.amount),0)
      : null;
    const methodLabels={
      linear:'Liniowa ekstrapolacja',
      trend:'Trend 7 dni',
      history:'Średnia historyczna'
    };
    const methodDescriptions={
      linear:'Średnie tempo z dotychczasowych dni miesiąca.',
      trend:'Tempo z ostatnich 7 dni (jeśli dostępne).',
      history:'Średnia z poprzednich miesięcy dla tej kategorii.'
    };
    const projections=[];
    const pushProjection=(key,value,pace)=>{
      if(!Number.isFinite(value)) return;
      const safeValue=Math.max(safeSpent, value);
      const safePace=Math.max(0, Number.isFinite(pace)?pace:0);
      projections.push({
        key,
        label:methodLabels[key]||key,
        description:methodDescriptions[key]||'',
        value:safeValue,
        pace:safePace
      });
    };
    pushProjection('linear', linearProjection, averageDaily);
    if(recentWindow>0) pushProjection('trend', trendProjection, recentAverage);
    if(historyProjection!==null) pushProjection('history', historyProjection, remainingDays>0?(historyProjection-safeSpent)/remainingDays:0);
    if(!projections.length){
      projections.push({
        key:'linear',
        label:methodLabels.linear,
        description:'Brak danych do predykcji — przyjęto dotychczasowy poziom wydatków.',
        value:safeSpent,
        pace:0
      });
    }
    const realistic=projections.find(p=>p.key==='trend')||projections.find(p=>p.key==='linear')||projections[0];
    const optimistic=projections.reduce((best,proj)=>best && best.value<=proj.value?best:proj, realistic);
    const pessimistic=projections.reduce((best,proj)=>best && best.value>=proj.value?best:proj, realistic);
    const labels=Array.from({length:daysInMonth},(_,i)=>String(i+1).padStart(2,'0'));
    const actualCumulative=Array(daysInMonth).fill(null);
    let running=0;
    for(let i=0;i<daysInMonth;i++){
      running+=dailyTotals[i];
      if(i<daysElapsed){
        actualCumulative[i]=running;
      }
    }
    const projectedCumulative=Array(daysInMonth).fill(null);
    const remainingTarget=Math.max(0, realistic.value-safeSpent);
    const projectedPace=remainingDays>0?remainingTarget/remainingDays:0;
    let projectedRunning=daysElapsed>0?safeSpent:0;
    for(let i=0;i<daysInMonth;i++){
      if(i<daysElapsed){
        projectedCumulative[i]=actualCumulative[i];
      }else{
        if(daysElapsed===0 && i===0){
          projectedRunning=0;
        }
        if(i===daysElapsed && daysElapsed>0){
          projectedRunning=safeSpent;
        }
        if(daysElapsed===0 || i>=daysElapsed){
          projectedRunning+=projectedPace;
        }
        projectedCumulative[i]=projectedRunning;
      }
    }
    let alert=null;
    if(Number.isFinite(monthBTotal) && monthBTotal>0 && realistic.value>monthBTotal){
      const overrun=realistic.value-monthBTotal;
      const pct=overrun/monthBTotal;
      if(pct>=0.1){
        alert={
          type:'overrun',
          amount:overrun,
          percent:pct
        };
      }
    }else if((!Number.isFinite(monthBTotal) || monthBTotal<=0) && realistic.value>safeSpent){
      alert={
        type:'new-spend',
        amount:realistic.value,
        percent:null
      };
    }
    return {
      isCurrent:true,
      daysElapsed,
      daysInMonth,
      remainingDays,
      spentSoFar:safeSpent,
      averageDaily,
      recentAverage,
      historyAverage,
      projections,
      scenarios:{
        optimistic,
        realistic,
        pessimistic
      },
      labels,
      actualCumulative,
      projectedCumulative,
      realisticLabel:realistic?.label||'Prognoza',
      monthBTotal,
      alert
    };
  }

  function detectPatterns(dayData, monthA, monthB){
    const patterns=[];
    const days=Array.isArray(dayData)?dayData.map(day=>({
      day:Number(day.day)||0,
      totalA:Math.max(0, Number(day.totalA)||0),
      totalB:Math.max(0, Number(day.totalB)||0),
      delta:Number(day.delta)||0,
      isoA:day.isoA||null,
      isoB:day.isoB||null,
      cumulativeDelta:Number(day.cumulativeDelta)||0
    })).filter(day=>day.day>0):[];

    const ensureIso=(dayNumber)=>{
      const base=monthA||monthB;
      if(!base) return null;
      const padded=String(dayNumber).padStart(2,'0');
      const max=daysInYm(base);
      if(dayNumber>max) return null;
      return `${base}-${padded}`;
    };

    const totalCombined=days.reduce((sum,day)=>sum+day.totalA+day.totalB,0);
    if(totalCombined<=0){
      return [
        {key:'clustering',icon:'📅',title:'Klaster wydatków',description:'Brak wydatków w analizowanym zakresie.'},
        {key:'spike',icon:'🚨',title:'Nagły skok',description:'Brak odchyleń przekraczających próg 2σ.'},
        {key:'weekend',icon:'🛍️',title:'Efekt weekendu',description:'Za mało danych, aby porównać weekendy z dniami roboczymi.'},
        {key:'trend',icon:'📈',title:'Trend miesiąca',description:'Brak danych do analizy trendu różnicy A-B.'},
        {key:'regularity',icon:'🔁',title:'Regularność',description:'Brak danych do wykrycia powtarzalnego rytmu wydatków.'}
      ];
    }

    // Klasterowanie
    const buckets={early:0,mid:0,late:0};
    days.forEach(day=>{
      const bucket=day.day<=10?'early':day.day<=20?'mid':'late';
      buckets[bucket]+=day.totalA+day.totalB;
    });
    const bucketEntries=Object.entries(buckets).sort((a,b)=>b[1]-a[1]);
    const [topBucketKey,topBucketValue]=bucketEntries[0];
    const bucketShare=topBucketValue/totalCombined;
    const bucketLabel=topBucketKey==='early'?'początek':topBucketKey==='mid'?'środek':'koniec';
    const bucketPercent=Math.round(bucketShare*100);
    patterns.push({
      key:'clustering',
      icon:'📅',
      title:'Klaster wydatków',
      description:`${bucketPercent}% wydatków przypada na ${bucketLabel} miesiąca.`
    });

    // Spike detection
    const deltas=days.map(day=>Math.abs(day.delta));
    const meanDelta=deltas.reduce((sum,val)=>sum+val,0)/deltas.length;
    const variance=deltas.reduce((sum,val)=>sum+Math.pow(val-meanDelta,2),0)/deltas.length;
    const stdDev=Math.sqrt(variance);
    const threshold=meanDelta+2*stdDev;
    let spike=null;
    days.forEach(day=>{
      const impact=Math.abs(day.delta);
      if(impact>threshold && (!spike || impact>spike.impact)){
        spike={day,impact};
      }
    });
    if(spike){
      const direction=spike.day.delta>0?'Miesiąc A wydał więcej':'Miesiąc B wydał więcej';
      patterns.push({
        key:'spike',
        icon:'🚨',
        title:'Nagły skok',
        description:`Dzień ${String(spike.day.day).padStart(2,'0')} wygenerował różnicę ${fmt(Math.abs(spike.day.delta), state.currency)} (${direction}).`
      });
    }else{
      patterns.push({
        key:'spike',
        icon:'🚨',
        title:'Nagły skok',
        description:'Brak odchyleń przekraczających próg 2σ.'
      });
    }

    // Weekend effect
    let weekendSum=0;
    let weekdaySum=0;
    let weekendCount=0;
    let weekdayCount=0;
    days.forEach(day=>{
      const iso=day.isoA||day.isoB||ensureIso(day.day);
      if(!iso) return;
      const date=new Date(`${iso}T00:00:00`);
      if(Number.isNaN(date.getTime())) return;
      const jsDay=date.getDay();
      const isWeekend=jsDay===0||jsDay===6;
      const combined=day.totalA+day.totalB;
      if(isWeekend){
        weekendSum+=combined;
        weekendCount++;
      }else{
        weekdaySum+=combined;
        weekdayCount++;
      }
    });
    let weekendDescription='Za mało danych, aby porównać weekendy z dniami roboczymi.';
    if(weekendCount>0 && weekdayCount>0 && (weekendSum+weekdaySum)>0){
      const weekendAvg=weekendSum/weekendCount;
      const weekdayAvg=weekdaySum/weekdayCount;
      if(weekendAvg>weekdayAvg*1.1){
        weekendDescription=`Weekendy generują średnio ${fmt(weekendAvg, state.currency)} dziennie vs ${fmt(weekdayAvg, state.currency)} w dni robocze.`;
      }else if(weekdayAvg>weekendAvg*1.1){
        weekendDescription=`Dni robocze są cięższe: ${fmt(weekdayAvg, state.currency)} dziennie vs ${fmt(weekendAvg, state.currency)} w weekendy.`;
      }else{
        weekendDescription=`Weekend i dni robocze są zbliżone (${fmt(weekendAvg, state.currency)} vs ${fmt(weekdayAvg, state.currency)} na dzień).`;
      }
    }
    patterns.push({
      key:'weekend',
      icon:'🛍️',
      title:'Efekt weekendu',
      description:weekendDescription
    });

    // Trend
    let trendDescription='Różnica A-B pozostaje stabilna przez miesiąc.';
    if(days.length>=2){
      const n=days.length;
      const yValues=days.map(day=>Number.isFinite(day.cumulativeDelta)?day.cumulativeDelta:0);
      const meanX=(n+1)/2;
      const meanY=yValues.reduce((sum,val)=>sum+val,0)/n;
      let numerator=0;
      let denominator=0;
      days.forEach((day,idx)=>{
        const x=idx+1;
        const y=yValues[idx];
        numerator+=(x-meanX)*(y-meanY);
        denominator+=(x-meanX)*(x-meanX);
      });
      const slope=denominator!==0?numerator/denominator:0;
      const avgAbsDelta=days.reduce((sum,day)=>sum+Math.abs(day.delta),0)/n;
      const threshold=Math.max(avgAbsDelta*0.1, 0.01);
      if(slope>threshold){
        trendDescription=`Różnica A-B rośnie — średnio +${fmt(Math.abs(slope), state.currency)} dziennie.`;
      }else if(slope<-threshold){
        trendDescription=`Różnica A-B maleje — średnio −${fmt(Math.abs(slope), state.currency)} dziennie.`;
      }
    }
    patterns.push({
      key:'trend',
      icon:'📈',
      title:'Trend miesiąca',
      description:trendDescription
    });

    // Regularity
    let regularDescription='Brak powtarzalnego cyklu — odstępy między wydatkami są nieregularne.';
    const activeDays=days.filter(day=>day.totalA+day.totalB>0).map(day=>day.day).sort((a,b)=>a-b);
    if(activeDays.length>=3){
      const gapCounts=new Map();
      for(let i=1;i<activeDays.length;i++){
        const gap=activeDays[i]-activeDays[i-1];
        if(gap<=0) continue;
        gapCounts.set(gap,(gapCounts.get(gap)||0)+1);
      }
      if(gapCounts.size>0){
        const sortedGaps=[...gapCounts.entries()].sort((a,b)=>{
          if(b[1]!==a[1]) return b[1]-a[1];
          return a[0]-b[0];
        });
        const [bestGap,bestCount]=sortedGaps[0];
        if(bestCount>=2){
          const occur=bestCount+1;
          let label=`co ${bestGap} dni`;
          if(bestGap===7) label='około co tydzień';
          else if(bestGap===14) label='mniej więcej co dwa tygodnie';
          regularDescription=`Wydatki pojawiają się ${label} (${occur} powtórzenia).`;
        }
      }
    }else{
      regularDescription='Zbyt mało dni z wydatkami, aby wykryć rytm.';
    }
    patterns.push({
      key:'regularity',
      icon:'🔁',
      title:'Regularność',
      description:regularDescription
    });

    return patterns;
  }

  function buildMomDetailWeeklySection(detail, monthA, monthB, palette){
    const weekdaysShort=['Pn','Wt','Śr','Cz','Pt','So','Nd'];
    const weekdaysLong=['Poniedziałek','Wtorek','Środa','Czwartek','Piątek','Sobota','Niedziela'];
    const buckets=weekdaysLong.map((label,idx)=>({
      idx,
      label,
      short:weekdaysShort[idx],
      totalA:0,
      totalB:0,
      countA:0,
      countB:0,
      entriesA:[],
      entriesB:[]
    }));
    const getWeekdayIndex=iso=>{
      if(!iso) return -1;
      const date=new Date(iso);
      if(Number.isNaN(date.getTime())) return -1;
      const jsDay=date.getDay();
      return (jsDay+6)%7;
    };
    (detail?.days||[]).forEach(day=>{
      if(day.isoA){
        const idx=getWeekdayIndex(day.isoA);
        if(idx>=0){
          const bucket=buckets[idx];
          bucket.totalA+=day.totalA;
          bucket.countA+=day.entriesA.length;
          day.entriesA.forEach(entry=>{
            bucket.entriesA.push({
              amount:Math.abs(entry.amount)||0,
              note:entry.note||'',
              date:entry.date||day.isoA
            });
          });
        }
      }
      if(day.isoB){
        const idx=getWeekdayIndex(day.isoB);
        if(idx>=0){
          const bucket=buckets[idx];
          bucket.totalB+=day.totalB;
          bucket.countB+=day.entriesB.length;
          day.entriesB.forEach(entry=>{
            bucket.entriesB.push({
              amount:Math.abs(entry.amount)||0,
              note:entry.note||'',
              date:entry.date||day.isoB
            });
          });
        }
      }
    });
    const maxValue=buckets.reduce((max,b)=>Math.max(max,b.totalA,b.totalB),0);
    const humanMonthA=formatYmHuman(monthA)||'Miesiąc A';
    const humanMonthB=formatYmHuman(monthB)||'Miesiąc B';
    const formatCount=count=>{
      if(!count) return 'Brak';
      if(count===1) return '1 trans.';
      return `${count} trans.`;
    };
    const formatCountAria=count=>{
      if(!count) return 'Brak transakcji';
      if(count===1) return '1 transakcja';
      return `${count} transakcje`;
    };
    const topA=buckets.reduce((acc,b)=>b.totalA>(acc?.total||0)?{index:b.idx,total:b.totalA,label:b.label}:acc,null);
    const topB=buckets.reduce((acc,b)=>b.totalB>(acc?.total||0)?{index:b.idx,total:b.totalB,label:b.label}:acc,null);
    const headerCells=weekdaysShort.map(short=>`<div class="mom-detail-heatmap-head" aria-hidden="true">${short}</div>`).join('');
    const cellMap=new Map();
    const rows=[
      {key:'A',label:humanMonthA,color:palette.monthA,totalKey:'totalA',countKey:'countA',entriesKey:'entriesA',top:topA},
      {key:'B',label:humanMonthB,color:palette.monthB,totalKey:'totalB',countKey:'countB',entriesKey:'entriesB',top:topB}
    ].map(config=>{
      const cells=buckets.map(bucket=>{
        const total=bucket[config.totalKey];
        const count=bucket[config.countKey];
        const entries=bucket[config.entriesKey];
        const id=`${config.key}-${bucket.idx}`;
        const ratio=maxValue>0?Math.min(1,total/maxValue):0;
        const hasValue=total>0;
        const background=hasValue?colorWithAlpha(config.color,0.18+0.45*ratio):colorWithAlpha(palette.ink,0.05);
        const border=hasValue?colorWithAlpha(config.color,0.35+0.3*ratio):colorWithAlpha(palette.ink,0.12);
        const classes=['mom-detail-heatmap-cell'];
        if(!hasValue) classes.push('is-empty');
        if(config.top && config.top.index===bucket.idx && hasValue) classes.push('is-top');
        const ariaLabel=`${config.label} — ${bucket.label}: ${hasValue?fmt(total,state.currency):'Brak wydatków'}, ${formatCountAria(count)}`;
        cellMap.set(id,{
          monthKey:config.key,
          monthLabel:config.label,
          dowIndex:bucket.idx,
          dowLabel:bucket.label,
          total,
          count,
          transactions:entries.map(entry=>({
            amount:entry.amount,
            note:entry.note,
            date:entry.date
          }))
        });
        return `<button type="button" class="${classes.join(' ')}" data-mom-heatmap="${id}" style="--mom-heat-bg:${background};--mom-heat-border:${border};" aria-label="${escapeHtml(ariaLabel)}"><span class="mom-detail-heatmap-total">${hasValue?fmt(total,state.currency):'—'}</span><span class="mom-detail-heatmap-count">${formatCount(count)}</span></button>`;
      }).join('');
      return `<div class="mom-detail-heatmap-label">${escapeHtml(config.label)}</div>${cells}`;
    }).join('');
    const gridHtml=`<div class="mom-detail-heatmap-scroll"><div class="mom-detail-heatmap-grid"><div class="mom-detail-heatmap-corner" aria-hidden="true">Dzień</div>${headerCells}${rows}</div></div>`;
    const metricCard=(label, top)=>{
      const hasData=top && top.total>0;
      const value=hasData?`${escapeHtml(top.label)} • ${fmt(top.total,state.currency)}`:'Brak danych';
      return `<article class="mom-detail-heatmap-metric"><span class="mom-detail-heatmap-metric-eyebrow">${escapeHtml(label)}</span><h6 class="mom-detail-heatmap-metric-title">Najdroższy dzień tygodnia</h6><p class="mom-detail-heatmap-metric-value">${value}</p></article>`;
    };
    const metricsHtml=`<div class="mom-detail-heatmap-metrics">${metricCard(humanMonthA, topA)}${metricCard(humanMonthB, topB)}</div>`;
    const limitLabel=String(detail?.dayLimit||0).padStart(2,'0');
    const subtitle=`Do dnia ${limitLabel} • ${humanMonthA} / ${humanMonthB}`;
    const sectionHtml=`<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">🗓️ Które dni tygodnia?</h5><p class="mom-detail-section-subtitle">${subtitle}</p></div></div><div class="mom-detail-heatmap">${gridHtml}${metricsHtml}</div></section>`;
    return {section:sectionHtml,cells:cellMap};
  }

  function buildMomDetailForecastSection(forecast){
    if(!forecast) return '';
    const {daysElapsed, daysInMonth, remainingDays, spentSoFar, averageDaily, recentAverage, historyAverage, scenarios, alert, monthBTotal}=forecast;
    const scenarioOrder=[['optimistic','optimistyczny'],['realistic','realistyczny'],['pessimistic','pesymistyczny']];
    const scenarioCards=scenarioOrder.map(([key,label])=>{
      const scenario=scenarios?.[key];
      if(!scenario) return '';
      const paceLabel=scenario.pace>0?`${fmt(scenario.pace,state.currency)}/dzień`:'Stały poziom';
      const methodNote=scenario.description?escapeHtml(scenario.description):escapeHtml(scenario.label);
      const valueLabel=fmt(scenario.value,state.currency);
      return `<article class="mom-detail-forecast-card ${escapeHtml(key)}"><span class="mom-detail-forecast-card-title">Scenariusz ${escapeHtml(label)}</span><span class="mom-detail-forecast-card-value">${valueLabel}</span><p class="mom-detail-forecast-card-note">${methodNote}</p><div class="mom-detail-forecast-card-meta"><span>${paceLabel}</span><span>•</span><span>${escapeHtml(scenario.label)}</span></div></article>`;
    }).join('');
    const metrics=[];
    metrics.push(`<span class="mom-detail-forecast-metric">Do dziś: <strong>${fmt(spentSoFar,state.currency)}</strong></span>`);
    metrics.push(`<span class="mom-detail-forecast-metric">Pozostało dni: <strong>${remainingDays}</strong></span>`);
    metrics.push(`<span class="mom-detail-forecast-metric">Śr. tempo: <strong>${averageDaily>0?fmt(averageDaily,state.currency):'—'}</strong>/dzień</span>`);
    metrics.push(`<span class="mom-detail-forecast-metric">Trend 7 dni: <strong>${recentAverage>0?fmt(recentAverage,state.currency):'—'}</strong>/dzień</span>`);
    metrics.push(`<span class="mom-detail-forecast-metric">Śr. historyczna: <strong>${Number.isFinite(historyAverage)?fmt(historyAverage,state.currency):'—'}</strong></span>`);
    if(Number.isFinite(monthBTotal)){
      metrics.push(`<span class="mom-detail-forecast-metric">Miesiąc B: <strong>${fmt(monthBTotal,state.currency)}</strong></span>`);
    }
    const metricsHtml=`<div class="mom-detail-forecast-metrics">${metrics.join('')}</div>`;
    let alertHtml='';
    if(alert){
      if(alert.type==='overrun'){
        const pctLabel=`${Math.round((alert.percent||0)*1000)/10}%`;
        alertHtml=`<div class="mom-detail-forecast-alert"><span class="mom-detail-forecast-alert-icon">⚠️</span><div><strong>Ryzyko przekroczenia</strong><br/>Prognoza wskazuje wydatki wyższe od miesiąca B o ${fmt(alert.amount,state.currency)} (${pctLabel}). Rozważ korektę budżetu.</div></div>`;
      }else if(alert.type==='new-spend'){
        alertHtml=`<div class="mom-detail-forecast-alert"><span class="mom-detail-forecast-alert-icon">⚠️</span><div><strong>Nowe wydatki</strong><br/>Prognoza zakłada dodatkowe wydatki do końca miesiąca. Monitoruj kategorię, aby uniknąć niespodzianek.</div></div>`;
      }
    }
    const subtitleParts=[];
    subtitleParts.push(daysElapsed>0?`Na podstawie ${daysElapsed} dni (${Math.round((daysElapsed/daysInMonth)*100)}% miesiąca).`:'Brak wydatków w bieżącym miesiącu.');
    if(remainingDays>0){
      subtitleParts.push(`Pozostało ${remainingDays} dni.`);
    }
    const subtitle=subtitleParts.join(' ');
    return `<div class="mom-detail-forecast-block"><div class="mom-detail-forecast-heading">🔮 Prognoza do końca miesiąca</div><p class="mom-detail-forecast-note">${escapeHtml(subtitle)}</p><div class="mom-detail-forecast"><div class="mom-detail-forecast-grid">${scenarioCards}</div>${metricsHtml}${alertHtml}<div class="mom-detail-forecast-chart"><canvas id="mom-detail-forecast-chart" role="img" aria-label="Porównanie wydatków faktycznych i prognozowanych"></canvas></div></div></div>`;
  }

  function formatMomContributionDate(iso){
    if(!iso) return '—';
    const date=new Date(iso);
    if(Number.isNaN(date.getTime())) return iso;
    try{
      const day=date.toLocaleDateString('pl-PL',{day:'2-digit',month:'2-digit'});
      const weekday=date.toLocaleDateString('pl-PL',{weekday:'short'});
      return `${day} · ${weekday}`;
    }catch(err){
      return iso;
    }
  }

  function buildMomDetailContributionsSection(detail, monthA, monthB){
    const humanMonthA=formatYmHuman(monthA)||'Miesiąc A';
    const humanMonthB=formatYmHuman(monthB)||'Miesiąc B';
    const rows=[];
    const signatureCounts=new Map();
    const totalDiff=(detail?.totalA||0)-(detail?.totalB||0);
    const addEntry=(entry, monthKey)=>{
      const amount=Math.abs(entry?.amount)||0;
      if(amount<=0) return;
      const iso=entry?.date||null;
      const note=entry?.note||'';
      const signature=`${amount.toFixed(2)}|${note.trim().toLowerCase().replace(/\s+/g,' ')}`;
      const base={
        id:`${monthKey}-${entry?.parentId||entry?.id||iso||Math.random().toString(36).slice(2)}-${rows.length}`,
        monthKey,
        iso,
        dateLabel:formatMomContributionDate(iso),
        amount,
        note,
        signature,
        impact:monthKey==='A'?amount:-amount
      };
      rows.push(base);
      const current=signatureCounts.get(signature)||{A:0,B:0};
      current[monthKey]=(current[monthKey]||0)+1;
      signatureCounts.set(signature,current);
    };
    (detail?.days||[]).forEach(day=>{
      (day?.entriesA||[]).forEach(entry=>addEntry(entry,'A'));
      (day?.entriesB||[]).forEach(entry=>addEntry(entry,'B'));
    });
    const contributions=rows.map(row=>{
      const signatureStat=signatureCounts.get(row.signature)||{A:0,B:0};
      const isUnique=row.monthKey==='A'?signatureStat.B===0:signatureStat.A===0;
      const monthLabel=row.monthKey==='A'?humanMonthA:humanMonthB;
      const impactClass=row.impact>0?'negative':row.impact<0?'positive':'neutral';
      const impactLabel=row.impact===0?'—':`${row.impact>0?'+':'−'}${fmt(Math.abs(row.impact), state.currency)}`;
      const noteHtml=row.note?escapeHtml(row.note):'<span class="muted">Brak notatki</span>';
      const uniqueHtml=isUnique?`<span class="mom-detail-contrib-unique">Unikalna ${row.monthKey}</span>`:'';
      const monthClass=row.monthKey==='A'?'month-a':'month-b';
      const amountLabel=fmt(row.amount,state.currency);
      return {
        ...row,
        isUnique,
        monthLabel,
        impactLabel,
        impactClass,
        noteHtml,
        uniqueHtml,
        monthClass,
        amountLabel,
        rowHtml:`<tr><td class="mom-detail-contrib-date">${escapeHtml(row.dateLabel)}</td><td><span class="mom-detail-contrib-badge ${monthClass}" title="${escapeHtml(monthLabel)}">${row.monthKey}</span><span class="mom-detail-contrib-amount">${amountLabel}</span>${uniqueHtml}</td><td class="mom-detail-contrib-note">${noteHtml}</td><td><span class="mom-detail-contrib-impact ${impactClass}">${impactLabel}</span></td></tr>`
      };
    });
    contributions.sort((a,b)=>{
      const diff=Math.abs(b.impact)-Math.abs(a.impact);
      if(Math.abs(diff)>0.005) return diff;
      if(b.impact!==a.impact) return b.impact-a.impact;
      return (a.iso||'').localeCompare(b.iso||'');
    });
    const totalCount=contributions.length;
    const filterLabel=`Tylko transakcje >`;
    const topDetails=totalCount
      ? `<details class="mom-detail-contrib-top"><summary>Top 10 transakcji <span class="mom-detail-contrib-count" data-mom-contrib-count></span></summary><div class="mom-detail-contrib-table-wrap"><table class="mom-detail-contrib-table" aria-label="Top transakcje wpływające na różnicę"><thead><tr><th>Data</th><th>Kwota</th><th>Notatka</th><th>Miesięczny wpływ</th></tr></thead><tbody data-mom-contrib-table="top"></tbody></table></div></details>`
      : '<div class="mom-detail-contrib-empty">Brak transakcji wpływających na różnicę pomiędzy miesiącami.</div>';
    const filterControl=`<label class="mom-detail-contrib-filter">${filterLabel}<span class="mom-detail-contrib-filter-input"><input type="number" inputmode="decimal" min="0" step="10" value="0" data-mom-contrib-filter aria-label="Filtruj minimalną kwotę"/><span>zł</span></span></label>`;
    const topSectionHtml=`<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">💥 Największe wpływy</h5><p class="mom-detail-section-subtitle">Największy wpływ na różnicę między ${escapeHtml(humanMonthA)} a ${escapeHtml(humanMonthB)}.</p></div>${filterControl}</div><div class="mom-detail-contrib-body" data-mom-contrib-container data-mom-contrib-total="${totalDiff}">${topDetails}</div></section>`;
    const fullTable=totalCount
      ? `<div class="mom-detail-contrib-table-wrap mom-detail-contrib-all" data-mom-contrib-all hidden><table class="mom-detail-contrib-table" aria-label="Lista wszystkich transakcji wpływających na różnicę"><thead><tr><th>Data</th><th>Kwota</th><th>Notatka</th><th>Miesięczny wpływ</th></tr></thead><tbody data-mom-contrib-table="all"></tbody></table></div>`
      : '<div class="mom-detail-contrib-empty">Brak transakcji do wyświetlenia.</div>';
    const fullControls=totalCount
      ? `<button type="button" class="mom-detail-contrib-toggle" data-mom-contrib-toggle>▶ Zobacz wszystkie transakcje</button>`
      : '';
    const fullSectionHtml=`<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">🗂️ Pełna lista transakcji</h5><p class="mom-detail-section-subtitle">Zobacz każdą transakcję wpływającą na różnicę miesiąc do miesiąca.</p></div></div>${fullControls}${fullTable}</section>`;
    return {topSection:topSectionHtml,fullSection:fullSectionHtml,rows:contributions};
  }

  function bindMomDetailContributions(root, contributions){
    if(!root) return;
    const container=root.querySelector('[data-mom-contrib-container]');
    const filterInput=root.querySelector('[data-mom-contrib-filter]');
    const topBody=root.querySelector('[data-mom-contrib-table="top"]');
    const allBody=root.querySelector('[data-mom-contrib-table="all"]');
    const countEl=root.querySelector('[data-mom-contrib-count]');
    const toggleButton=root.querySelector('[data-mom-contrib-toggle]');
    const allWrap=root.querySelector('[data-mom-contrib-all]');
    if(!container || !filterInput){
      return;
    }
    const renderRows=(rows)=>rows.map(row=>row.rowHtml).join('');
    const applyFilter=()=>{
      const thresholdRaw=Number(String(filterInput.value||'').replace(',','.'));
      const threshold=Number.isFinite(thresholdRaw)&&thresholdRaw>0?thresholdRaw:0;
      const filtered=contributions.filter(row=>row.amount>=threshold);
      const topEntries=filtered.slice(0,10);
      if(topBody) topBody.innerHTML=topEntries.length?renderRows(topEntries):'<tr><td colspan="4" class="mom-detail-contrib-note"><span class="muted">Brak transakcji spełniających próg.</span></td></tr>';
      if(allBody) allBody.innerHTML=filtered.length?renderRows(filtered):'<tr><td colspan="4" class="mom-detail-contrib-note"><span class="muted">Brak transakcji do wyświetlenia.</span></td></tr>';
      if(countEl) countEl.textContent=`${topEntries.length} z ${filtered.length}`;
      const hasMore=filtered.length>10;
      if(toggleButton){
        toggleButton.hidden=!hasMore;
        toggleButton.disabled=!hasMore;
        toggleButton.textContent=hasMore && allWrap?.hasAttribute('hidden')? '▶ Zobacz wszystkie transakcje' : '▼ Ukryj pełną listę';
      }
      if(!hasMore && allWrap){
        allWrap.setAttribute('hidden','');
      }
    };
    filterInput.addEventListener('input',()=>{
      applyFilter();
    });
    if(toggleButton && allWrap){
      toggleButton.addEventListener('click',()=>{
        const isHidden=allWrap.hasAttribute('hidden');
        if(isHidden){
          allWrap.removeAttribute('hidden');
          toggleButton.textContent='▼ Ukryj pełną listę';
        }else{
          allWrap.setAttribute('hidden','');
          toggleButton.textContent='▶ Zobacz wszystkie transakcje';
        }
      });
    }
    applyFilter();
  }

  function ensureMomDetailHeatmapTooltip(){
    if(!momDetailHeatmapTooltip){
      momDetailHeatmapTooltip=document.createElement('div');
      momDetailHeatmapTooltip.className='mom-detail-heatmap-tooltip';
      document.body.appendChild(momDetailHeatmapTooltip);
    }
    return momDetailHeatmapTooltip;
  }

  function hideMomDetailHeatmapTooltip(){
    if(momDetailHeatmapTooltip){
      momDetailHeatmapTooltip.classList.remove('is-visible');
    }
  }

  function positionMomDetailHeatmapTooltip(coords){
    if(!momDetailHeatmapTooltip || !momDetailHeatmapTooltip.classList.contains('is-visible') || !coords) return;
    const offset=18;
    let left=(coords.x||0)+offset;
    let top=(coords.y||0)+offset;
    const rect=momDetailHeatmapTooltip.getBoundingClientRect();
    const viewportWidth=window.innerWidth||document.documentElement.clientWidth||0;
    const viewportHeight=window.innerHeight||document.documentElement.clientHeight||0;
    if(left+rect.width>viewportWidth-12) left=(coords.x||0)-rect.width-offset;
    if(top+rect.height>viewportHeight-12) top=(coords.y||0)-rect.height-offset;
    if(left<12) left=12;
    if(top<12) top=12;
    momDetailHeatmapTooltip.style.left=`${left}px`;
    momDetailHeatmapTooltip.style.top=`${top}px`;
  }

  function formatHeatmapDateLabel(value){
    if(!value) return '—';
    const date=new Date(value);
    if(Number.isNaN(date.getTime())) return value;
    try{
      return date.toLocaleDateString('pl-PL',{day:'2-digit',month:'2-digit'});
    }catch(err){
      return value;
    }
  }

  function showMomDetailHeatmapTooltip(data, coords){
    if(!data) return;
    const tooltip=ensureMomDetailHeatmapTooltip();
    const totalLabel=data.total>0?fmt(data.total,state.currency):'—';
    const countLabel=data.count?(data.count===1?'1 transakcja':`${data.count} trans.`):'Brak transakcji';
    const entries=(data.transactions||[]).slice(0,6);
    const rowsHtml=entries.length
      ? entries.map(entry=>{
          const dateLabel=formatHeatmapDateLabel(entry.date);
          const amount=fmt(entry.amount,state.currency);
          const note=entry.note?escapeHtml(entry.note):'Bez opisu';
          return `<div class="mom-detail-heatmap-tooltip-item"><span>${escapeHtml(dateLabel)}</span><span>${amount}</span><span class="mom-detail-heatmap-tooltip-item-note">${note}</span></div>`;
        }).join('')
      : '<div class="mom-detail-heatmap-tooltip-empty">Brak transakcji w tym dniu tygodnia.</div>';
    const remainder=Math.max(0,(data.transactions?.length||0)-entries.length);
    const moreHtml=remainder>0?`<div class="mom-detail-heatmap-tooltip-more">+${remainder} kolejnych pozycji</div>`:'';
    tooltip.innerHTML=`<div class="mom-detail-heatmap-tooltip-header"><div><span class="mom-detail-heatmap-tooltip-label">${escapeHtml(data.monthLabel)}</span><div class="mom-detail-heatmap-tooltip-day">${escapeHtml(data.dowLabel)}</div></div><div class="mom-detail-heatmap-tooltip-total">${totalLabel}</div></div><div class="mom-detail-heatmap-tooltip-count">${escapeHtml(countLabel)}</div><div class="mom-detail-heatmap-tooltip-body">${rowsHtml}${moreHtml}</div>`;
    tooltip.classList.add('is-visible');
    requestAnimationFrame(()=>positionMomDetailHeatmapTooltip(coords));
  }

  function bindMomDetailHeatmap(root, cellMap){
    momDetailHeatmapData.clear();
    if(!root || !(cellMap instanceof Map) || cellMap.size===0) return;
    cellMap.forEach((value,key)=>{
      momDetailHeatmapData.set(key,{
        monthKey:value.monthKey,
        monthLabel:value.monthLabel,
        dowIndex:value.dowIndex,
        dowLabel:value.dowLabel,
        total:value.total,
        count:value.count,
        transactions:(value.transactions||[]).map(entry=>({
          amount:entry.amount,
          note:entry.note,
          date:entry.date
        }))
      });
    });
    const cells=root.querySelectorAll('[data-mom-heatmap]');
    cells.forEach(cell=>{
      const id=cell.dataset.momHeatmap;
      if(!id) return;
      const handleEnter=evt=>{
        const data=momDetailHeatmapData.get(id);
        if(!data) return;
        showMomDetailHeatmapTooltip(data,{x:evt.clientX,y:evt.clientY});
      };
      const handleMove=evt=>{
        positionMomDetailHeatmapTooltip({x:evt.clientX,y:evt.clientY});
      };
      const handleLeave=()=>hideMomDetailHeatmapTooltip();
      const handleFocus=evt=>{
        const data=momDetailHeatmapData.get(id);
        if(!data) return;
        const rect=evt.currentTarget.getBoundingClientRect();
        showMomDetailHeatmapTooltip(data,{x:rect.left+rect.width/2,y:rect.top});
      };
      cell.addEventListener('mouseenter', handleEnter);
      cell.addEventListener('mousemove', handleMove);
      cell.addEventListener('mouseleave', handleLeave);
      cell.addEventListener('focus', handleFocus);
      cell.addEventListener('blur', hideMomDetailHeatmapTooltip);
      cell.addEventListener('keydown', evt=>{ if(evt.key==='Escape') hideMomDetailHeatmapTooltip(); });
      cell.addEventListener('touchstart', evt=>{
        const touch=evt.touches && evt.touches[0];
        const data=momDetailHeatmapData.get(id);
        if(!touch || !data) return;
        showMomDetailHeatmapTooltip(data,{x:touch.clientX,y:touch.clientY});
      }, {passive:true});
      cell.addEventListener('touchend', hideMomDetailHeatmapTooltip, {passive:true});
      cell.addEventListener('touchcancel', hideMomDetailHeatmapTooltip, {passive:true});
    });
  }

  function renderMomDetailEntries(entries){
    if(!entries.length){
      return '<div class="mom-detail-month-empty">Brak wydatków</div>';
    }
    return entries.map(entry=>{
      const amount=fmt(Math.abs(entry.amount), state.currency);
      const note=entry.note ? escapeHtml(entry.note).replace(/\n/g,'<br />') : '<span class="muted">Brak notatki</span>';
      return `<div class="mom-detail-entry"><div class="mom-detail-entry-amount">${amount}</div><div class="mom-detail-entry-info"><div class="mom-detail-entry-note">${note}</div></div></div>`;
    }).join('');
  }

  function renderMomDetailCalendarEntries(entries){
    if(!entries.length){
      return '<div class="mom-detail-calendar-entry"><span class="muted">Brak wpisów</span></div>';
    }
    return entries.map(entry=>{
      const amount=fmt(Math.abs(entry.amount), state.currency);
      const note=entry.note ? escapeHtml(entry.note).replace(/\n/g,'<br />') : '<span class="muted">Brak notatki</span>';
      return `<div class="mom-detail-calendar-entry"><strong>${amount}</strong><span class="mom-detail-calendar-note">${note}</span></div>`;
    }).join('');
  }

  function renderMomDetail(){
    if(!momDetailOpen) return;
    ensureMomDetailBindings();
    const titleEl=document.getElementById('mom-detail-title');
    const subtitleEl=document.getElementById('mom-detail-subtitle');
    const metaEl=document.getElementById('mom-detail-meta');
    const bodyEl=document.getElementById('mom-detail-body');
    const breadcrumbEl=document.getElementById('mom-detail-breadcrumb');
    const toolbar=document.getElementById('mom-detail-toolbar');
    if(!titleEl || !subtitleEl || !metaEl || !bodyEl) return;
    updateMomDetailSortButtons();
    hideMomDetailHeatmapTooltip();
    momDetailHeatmapData.clear();
    momDetailTabCache={};
    if(!isValidMomDetailTab(momDetailTab)) momDetailTab='overview';
    const context=momLastContext;
    if(!context){
      titleEl.textContent='Szczegóły kategorii';
      subtitleEl.textContent='Wybierz miesiące oraz kategorię, aby zobaczyć transakcje.';
      if(breadcrumbEl) breadcrumbEl.textContent='Porównanie MoM';
      metaEl.innerHTML='';
      bodyEl.innerHTML='<div class="mom-detail-empty">Brak danych do analizy. Wybierz dwa miesiące do porównania.</div>';
      if(toolbar) toolbar.style.display='none';
      destroyMomDetailWaterfallChart();
      destroyMomDetailForecastChart();
      updateMomDetailTabButtons();
      updateMomDetailSortVisibility();
      return;
    }
    const {categories,monthA,monthB,dayLimit}=context;
    const selected=categories.find(c=>c.id===momState.selectedCategory);
    if(!selected || !momDetailEligible(selected.id)){
      titleEl.textContent='Szczegóły kategorii';
      subtitleEl.textContent='Kliknij konkretną kategorię z tabeli, aby zobaczyć transakcje.';
      if(breadcrumbEl) breadcrumbEl.textContent='Porównanie MoM';
      metaEl.innerHTML='';
      bodyEl.innerHTML='<div class="mom-detail-empty">Wybierz kategorię wydatków, aby wejść w szczegóły.</div>';
      if(toolbar) toolbar.style.display='none';
      destroyMomDetailWaterfallChart();
      destroyMomDetailForecastChart();
      updateMomDetailTabButtons();
      updateMomDetailSortVisibility();
      return;
    }
    const titleLabel=momCategoryLabel(selected);
    const humanMonthA=formatYmHuman(monthA)||'Miesiąc A';
    const humanMonthB=formatYmHuman(monthB)||'Miesiąc B';
    titleEl.textContent=titleLabel;
    subtitleEl.textContent=`${humanMonthA} vs ${humanMonthB} • do dnia ${String(dayLimit).padStart(2,'0')}`;
    if(breadcrumbEl) breadcrumbEl.textContent=`Porównanie MoM › ${titleLabel} › ${humanMonthA} vs ${humanMonthB}`;
    const detail=buildMomDetailData(monthA, monthB, selected.id, dayLimit);
    if(toolbar) toolbar.style.display='';
    metaEl.innerHTML='';
    const totalDiff=detail.totalA-detail.totalB;
    const dayLimitLabel=String(detail.dayLimit).padStart(2,'0');
    const hasTransactions=(detail.countA||0)+(detail.countB||0)>0;
    const changeTone=totalDiff>0?'negative':totalDiff<0?'positive':'neutral';
    const changeValue=totalDiff===0?'—':`${totalDiff>0?'+':'−'}${fmt(Math.abs(totalDiff), state.currency)}`;
    const changeTrend=totalDiff>0?'↗ Wzrost wydatków':'↘ Oszczędności';
    const percentBase=detail.totalB;
    let percentTone='neutral';
    let percentValue='—';
    let percentTrend='Stabilnie względem miesiąca B';
    if(percentBase>0){
      const pct=((detail.totalA-detail.totalB)/percentBase)*100;
      if(Math.abs(pct)<0.05){
        percentValue='0,0%';
        percentTone='neutral';
        percentTrend='Różnica pomijalna';
      }else{
        percentTone=pct>0?'negative':'positive';
        const sign=pct>0?'+':'−';
        percentValue=`${sign}${Math.abs(pct).toFixed(1)}%`;
        percentTrend=pct>0?'↗ Tempo rośnie':'↘ Tempo maleje';
      }
    }else if(detail.totalA>0){
      percentValue='—';
      percentTone='negative';
      percentTrend='Brak punktu odniesienia (0 w miesiącu B)';
    }else{
      percentValue='—';
      percentTone='neutral';
      percentTrend='Brak transakcji w obu miesiącach';
    }
    const formatCount=value=>Number.isFinite(value)?String(value):'0';
    const renderChip=(label,value)=>`<span class="mom-detail-metric-chip">${label} <span>${value}</span></span>`;
    const renderDelta=(delta,unit,preferPositive=false)=>{
      if(!Number.isFinite(delta) || Math.abs(delta)<(unit==='count'?0.5:0.01)){
        return '<span class="mom-detail-metric-delta neutral">—</span>';
      }
      const isIncrease=delta>0;
      const tone=isIncrease===preferPositive?'positive':'negative';
      const arrow=isIncrease?'↗':'↘';
      const valueText=unit==='currency'?
        `${isIncrease?'+':'−'}${fmt(Math.abs(delta),state.currency)}`:
        `${isIncrease?'+':'−'}${Math.abs(Math.round(delta))}${unit==='count'?' trans.':''}`;
      return `<span class="mom-detail-metric-delta ${tone}">${arrow} ${valueText}</span>`;
    };
    const countDelta=detail.countA-detail.countB;
    const avgDelta=detail.avgA-detail.avgB;
    const medianA=detail.medianA;
    const medianB=detail.medianB;
    const maxA=detail.maxA;
    const maxB=detail.maxB;
    const statsA=detail.statsA||computeDistributionStats([]);
    const statsB=detail.statsB||computeDistributionStats([]);
    const hasStatsA=(statsA?.count||0)>0;
    const hasStatsB=(statsB?.count||0)>0;
    const percentFormatter=new Intl.NumberFormat('pl-PL',{style:'percent',minimumFractionDigits:0,maximumFractionDigits:1});
    const formatCurrencyStat=(value,has)=>has?fmt(value,state.currency):'—';
    const formatPercentStat=(value,has)=>has&&Number.isFinite(value)?percentFormatter.format(value):'—';
    const formatGiniStat=(value,has)=>has&&Number.isFinite(value)?value.toLocaleString('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2}):'—';
    const tooltipButton=(label,text)=>`<button type="button" class="mom-detail-metric-help" aria-label="Wyjaśnienie: ${escapeHtml(label)}" data-tooltip="${escapeHtml(text)}">?</button>`;
    const renderPercentileRow=(label,stats,has)=>{
      if(!has){
        return `<div class="mom-detail-advanced-row"><span class="mom-detail-advanced-row-label">${escapeHtml(label)}</span><span class="mom-detail-advanced-empty">Brak danych</span></div>`;
      }
      return `<div class="mom-detail-advanced-row"><span class="mom-detail-advanced-row-label">${escapeHtml(label)}</span><div class="mom-detail-advanced-row-values">${renderChip('P25', fmt(stats.p25,state.currency))}${renderChip('P50', fmt(stats.median,state.currency))}${renderChip('P75', fmt(stats.p75,state.currency))}${renderChip('P90', fmt(stats.p90,state.currency))}</div></div>`;
    };
    const outlierValue=(stats,has)=>has?`${stats.outliers} > ${fmt(stats.outlierThreshold,state.currency)}`:'—';
    const realMax=Math.max(statsA.max||0, statsB.max||0);
    const rangeMax=Math.max(realMax,1);
    const clampPercent=value=>Math.max(0, Math.min(100, value));
    const toPercent=value=>rangeMax>0?(value/rangeMax)*100:0;
    const buildBoxPlotRow=(label,stats,variant)=>{
      if(!stats || !(stats.count>0)){
        return `<div class="mom-detail-boxplot-row is-empty ${variant}"><span class="mom-detail-boxplot-label">${escapeHtml(label)}</span><span class="mom-detail-advanced-empty">Brak danych</span></div>`;
      }
      const whiskerStart=clampPercent(toPercent(stats.min));
      const whiskerEnd=clampPercent(toPercent(stats.max));
      const boxStart=clampPercent(toPercent(stats.p25));
      const boxEnd=clampPercent(toPercent(stats.p75));
      const medianPos=clampPercent(toPercent(stats.median));
      const whiskerWidth=Math.max(whiskerEnd-whiskerStart,0.6);
      const boxWidth=Math.max(boxEnd-boxStart,0.6);
      return `<div class="mom-detail-boxplot-row ${variant}"><span class="mom-detail-boxplot-label">${escapeHtml(label)}</span><div class="mom-detail-boxplot-track"><span class="mom-detail-boxplot-whisker" style="left:${whiskerStart}%;width:${Math.min(whiskerWidth,100)}%;"></span><span class="mom-detail-boxplot-box" style="left:${boxStart}%;width:${Math.min(boxWidth,100)}%;"></span><span class="mom-detail-boxplot-median" style="left:${medianPos}%;"></span></div><div class="mom-detail-boxplot-values">Min ${fmt(stats.min,state.currency)} • Q1 ${fmt(stats.p25,state.currency)} • Mediana ${fmt(stats.median,state.currency)} • Q3 ${fmt(stats.p75,state.currency)} • Max ${fmt(stats.max,state.currency)}</div></div>`;
    };
    const advancedMetricsHtml=hasTransactions
      ? `<div class="mom-detail-advanced-grid">
          <article class="mom-detail-advanced-card">
            <div class="mom-detail-advanced-header"><span>Odchylenie standardowe</span>${tooltipButton('Odchylenie standardowe','Odchylenie standardowe pokazuje typowy rozrzut kwot wokół średniej. Im wyższe, tym większa zmienność wydatków.')}</div>
            <div class="mom-detail-advanced-values">${renderChip('A', formatCurrencyStat(statsA.stdDev, hasStatsA))}${renderChip('B', formatCurrencyStat(statsB.stdDev, hasStatsB))}</div>
          </article>
          <article class="mom-detail-advanced-card">
            <div class="mom-detail-advanced-header"><span>Współczynnik zmienności</span>${tooltipButton('Współczynnik zmienności','CV = σ/μ. Normalizuje zmienność względem średniej — im wyższy, tym bardziej chaotyczne wydatki.')}</div>
            <div class="mom-detail-advanced-values">${renderChip('A', formatPercentStat(statsA.cv, hasStatsA && statsA.mean>0))}${renderChip('B', formatPercentStat(statsB.cv, hasStatsB && statsB.mean>0))}</div>
          </article>
          <article class="mom-detail-advanced-card">
            <div class="mom-detail-advanced-header"><span>Percentyle</span>${tooltipButton('Percentyle','Percentyle pokazują próg, poniżej którego mieści się 25%, 50%, 75% i 90% wydatków.')}</div>
            <div class="mom-detail-advanced-rows">${renderPercentileRow('Miesiąc A', statsA, hasStatsA)}${renderPercentileRow('Miesiąc B', statsB, hasStatsB)}</div>
          </article>
          <article class="mom-detail-advanced-card">
            <div class="mom-detail-advanced-header"><span>Outliery</span>${tooltipButton('Outliery','Liczba transakcji powyżej progu Q3 + 1,5×IQR — potencjalne obserwacje odstające.')}</div>
            <div class="mom-detail-advanced-values">${renderChip('A', escapeHtml(outlierValue(statsA, hasStatsA)))}${renderChip('B', escapeHtml(outlierValue(statsB, hasStatsB)))}</div>
          </article>
          <article class="mom-detail-advanced-card">
            <div class="mom-detail-advanced-header"><span>Współczynnik Giniego</span>${tooltipButton('Współczynnik Giniego','Mierzy nierówność wydatków: 0 oznacza równy rozkład, 1 oznacza pełną koncentrację w jednej transakcji.')}</div>
            <div class="mom-detail-advanced-values">${renderChip('A', formatGiniStat(statsA.gini, hasStatsA))}${renderChip('B', formatGiniStat(statsB.gini, hasStatsB))}</div>
          </article>
        </div>`
      : '';
    const boxPlotRows=`${buildBoxPlotRow('Miesiąc A', statsA, 'month-a')}${buildBoxPlotRow('Miesiąc B', statsB, 'month-b')}`;

    const boxPlotSection=hasTransactions
      ? `<div class="mom-detail-boxplot">
          <div class="mom-detail-advanced-header"><span>Box plot kwot transakcji</span>${tooltipButton('Box plot','Wykres pudełkowy prezentuje minimum, kwartyle, medianę i maksimum dla obu miesięcy.')}</div>
          <div class="mom-detail-boxplot-body">${boxPlotRows}</div>
          <div class="mom-detail-boxplot-scale"><span>${fmt(0,state.currency)}</span><span>${fmt(realMax,state.currency)}</span></div>
        </div>`
      : '';
    const diffSign=totalDiff>0?'+':totalDiff<0?'−':'';
    const diffSummary=totalDiff===0?'Brak różnicy A-B':`Skumulowana różnica: ${diffSign}${fmt(Math.abs(totalDiff), state.currency)}`;
    const palette=momPalette();
    const forecast=computeMomDetailForecast(detail, monthA, monthB, selected.id);
    const forecastSection=forecast?buildMomDetailForecastSection(forecast):'';
    const heroSign=totalDiff>0?'+':totalDiff<0?'−':'';
    const heroValueLabel=totalDiff===0?'—':`${heroSign}${fmt(Math.abs(totalDiff), state.currency)}`;
    const heroToneClass=changeTone||'neutral';
    const heroPercentClass=percentTone||'neutral';
    const summaryDiff=Math.abs(totalDiff);
    let heroSummary='Wydałeś tyle samo w wybranych miesiącach.';
    if(totalDiff>0){
      heroSummary=`Wydałeś o ${fmt(summaryDiff,state.currency)} więcej w ${humanMonthA} niż w ${humanMonthB}.`;
    }else if(totalDiff<0){
      heroSummary=`Wydałeś o ${fmt(summaryDiff,state.currency)} mniej w ${humanMonthA} niż w ${humanMonthB}.`;
    }
    const heroChangeText=percentValue==='—'?'Zmiana: —':`Zmiana: ${percentValue}`;
    const heroSection=`<section class="mom-detail-hero"><div class="mom-detail-hero-label">🚀 Wynik miesiąc do miesiąca</div><div class="mom-detail-hero-value ${heroToneClass}">${heroValueLabel}</div><div class="mom-detail-hero-change ${heroPercentClass}">${heroChangeText}</div><p class="mom-detail-hero-summary">${escapeHtml(heroSummary)}</p></section>`;
    const insights=[];
    const pushInsight=(icon,text)=>{ if(text) insights.push({icon,text}); };
    const topDay=detail.days.reduce((best,day)=>{
      if(!best || Math.abs(day.delta)>Math.abs(best.delta)){ return day; }
      return best;
    },null);
    if(topDay && Math.abs(topDay.delta)>0){
      const dayLabel=String(topDay.day).padStart(2,'0');
      const owner=topDay.delta>0?'Miesiąc A':'Miesiąc B';
      const deltaLabel=fmt(Math.abs(topDay.delta), state.currency);
      pushInsight('💡', `Główny winowajca: dzień ${dayLabel} — ${owner} +${deltaLabel}.`);
    }
    if(percentBase>0){
      const pctRaw=((detail.totalA-detail.totalB)/percentBase)*100;
      if(Math.abs(pctRaw)>=0.1){
        const paceLabel=Math.abs(pctRaw).toFixed(1);
        pushInsight('📊', pctRaw>0
          ? `Wydajesz ${paceLabel}% szybciej niż w ${humanMonthB}.`
          : `Wydajesz ${paceLabel}% wolniej niż w ${humanMonthB}.`);
      }else{
        pushInsight('📊', 'Tempo wydatków jest bardzo zbliżone do poprzedniego miesiąca.');
      }
    }else if(detail.totalA>0 && percentBase<=0){
      pushInsight('📊', `${humanMonthB} nie ma porównywalnych wydatków — każda nowa transakcja mocno zmienia wynik.`);
    }
    if(forecast && forecast.scenarios?.realistic){
      const realistic=forecast.scenarios.realistic;
      const targetLabel=fmt(realistic.value,state.currency);
      const referenceLabel=fmt(Number.isFinite(forecast.monthBTotal)?forecast.monthBTotal:detail.totalB,state.currency);
      pushInsight('🎯', `Jeśli utrzymasz tempo, zakończysz miesiąc z ${targetLabel} (vs ${referenceLabel} w ${humanMonthB}).`);
    }
    if(detail.everLed){
      if(detail.ledFromStart){
        pushInsight('🧭', `${humanMonthA} prowadzi od pierwszego dnia okresu.`);
      }else if(detail.crossoverDay){
        const crossDay=String(detail.crossoverDay).padStart(2,'0');
        pushInsight('🧭', `Przewaga miesiąca A pojawiła się w dniu ${crossDay}.`);
      }
    }else{
      pushInsight('🧭', `${humanMonthB} utrzymuje prowadzenie do dnia ${dayLimitLabel}.`);
    }
    const fallbackInsights=[
      'Monitoruj wydatki na bieżąco, aby szybciej reagować na odchylenia.',
      `Masz do porównania ${detail.days.length} dni — obserwuj zmiany tempa.`,
      'Skup się na największych transakcjach, aby poprawić wynik miesiąca.'
    ];
    for(const message of fallbackInsights){
      if(insights.length>=3) break;
      pushInsight('ℹ️', message);
    }
    const insightsCards=insights.slice(0,4).map(item=>`<article class="mom-detail-insight-card"><span class="mom-detail-insight-icon" aria-hidden="true">${item.icon}</span><span class="mom-detail-insight-text">${escapeHtml(item.text)}</span></article>`).join('');
    const insightsSection=`<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">🧠 Kluczowe insighty</h5><p class="mom-detail-section-subtitle">Najważniejsze wnioski dla kategorii ${escapeHtml(titleLabel)}.</p></div></div><div class="mom-detail-insights-grid">${insightsCards}</div>${forecastSection}</section>`;
    const waterfallSubtitle=`Do dnia ${dayLimitLabel} • ${diffSummary}`;
    const waterfallSection=`<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">🌊 Gdzie się różnimy?</h5><p class="mom-detail-section-subtitle">${waterfallSubtitle}</p></div></div><div class="mom-detail-waterfall-chart"><canvas id="mom-detail-waterfall" role="img" aria-label="Wykres wodospadowy różnicy dziennej"></canvas></div><p class="mom-detail-section-footnote">Największe różnice wyróżnione grubszą obwódką.</p></section>`;
    const overviewSection=`<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">📊 Przegląd kategorii</h5><p class="mom-detail-section-subtitle">Narastająco do dnia ${dayLimitLabel}</p></div></div><div class="mom-detail-kpi-grid"><article class="mom-detail-kpi-card month-a"><span class="label">Łączne wydatki — miesiąc A</span><p class="mom-detail-kpi-value">${fmt(detail.totalA,state.currency)}</p><span class="mom-detail-kpi-trend neutral">${humanMonthA}</span></article><article class="mom-detail-kpi-card month-b"><span class="label">Łączne wydatki — miesiąc B</span><p class="mom-detail-kpi-value">${fmt(detail.totalB,state.currency)}</p><span class="mom-detail-kpi-trend neutral">${humanMonthB}</span></article><article class="mom-detail-kpi-card ${changeTone}"><span class="label">Zmiana absolutna</span><p class="mom-detail-kpi-value">${changeValue}</p><span class="mom-detail-kpi-trend ${changeTone}">${totalDiff===0?'Stabilnie':changeTrend}</span></article><article class="mom-detail-kpi-card ${percentTone}"><span class="label">Zmiana procentowa</span><p class="mom-detail-kpi-value">${percentValue}</p><span class="mom-detail-kpi-trend ${percentTone}">${percentTrend}</span></article></div><div class="mom-detail-compare-grid"><article class="mom-detail-compare-card"><div class="mom-detail-compare-title">🔢 Liczba transakcji</div><div class="mom-detail-compare-values">${renderChip('A', formatCount(detail.countA))}${renderChip('B', formatCount(detail.countB))}</div><span class="mom-detail-compare-delta">${renderDelta(countDelta,'count',false)}</span></article><article class="mom-detail-compare-card"><div class="mom-detail-compare-title">💳 Średnia wartość</div><div class="mom-detail-compare-values">${renderChip('A', hasTransactions?fmt(detail.avgA,state.currency):'—')}${renderChip('B', hasTransactions?fmt(detail.avgB,state.currency):'—')}</div><span class="mom-detail-compare-delta">${hasTransactions?renderDelta(avgDelta,'currency',false):'<span class=\"mom-detail-metric-delta neutral\">—</span>'}</span></article><article class="mom-detail-compare-card"><div class="mom-detail-compare-title">⚖️ Mediana</div><div class="mom-detail-compare-values">${renderChip('A', medianA>0?fmt(medianA,state.currency):'—')}${renderChip('B', medianB>0?fmt(medianB,state.currency):'—')}</div><span class="mom-detail-compare-delta">${renderDelta(medianA-medianB,'currency',false)}</span></article></div></section>`;
    const statsPieces=[];
    if(advancedMetricsHtml) statsPieces.push(advancedMetricsHtml);
    if(boxPlotSection) statsPieces.push(boxPlotSection);
    if(!statsPieces.length){
      statsPieces.push('<div class="mom-detail-empty">Brak danych do obliczenia zaawansowanych statystyk.</div>');
    }
    const statsSection=hasTransactions
      ? `<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">📈 Zaawansowane statystyki</h5><p class="mom-detail-section-subtitle">Zmiany rozkładu i koncentracja wydatków.</p></div></div>${statsPieces.join('')}</section>`
      : `<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">📈 Zaawansowane statystyki</h5><p class="mom-detail-section-subtitle">Brak transakcji w wybranych miesiącach.</p></div></div><div class="mom-detail-empty">Brak danych do analizy.</div></section>`;
    const weeklySection=buildMomDetailWeeklySection(detail, monthA, monthB, palette);
    if(!hasTransactions){
      bodyEl.innerHTML='<div class="mom-detail-empty">Brak wydatków w tej kategorii w wybranych miesiącach do wskazanego dnia.</div>';
      if(toolbar) toolbar.style.display='none';
      destroyMomDetailWaterfallChart();
      destroyMomDetailForecastChart();
      updateMomDetailTabButtons();
      updateMomDetailSortVisibility();
      return;
    }
    const patterns=detectPatterns(detail.days, monthA, monthB);
    const patternsCards=patterns.map(pattern=>`<article class="mom-detail-pattern-card" data-mom-pattern="${pattern.key}"><span class="mom-detail-pattern-icon" aria-hidden="true">${pattern.icon}</span><span class="mom-detail-pattern-title">${pattern.title}</span><p class="mom-detail-pattern-desc">${pattern.description}</p></article>`).join('');
    const patternsSection=patterns.length
      ? `<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">🔍 Co się wyróżnia?</h5><p class="mom-detail-section-subtitle">Automatycznie wychwycone sygnały w wydatkach porównywanych miesięcy.</p></div></div><div class="mom-detail-patterns-grid">${patternsCards}</div></section>`
      : `<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">🔍 Co się wyróżnia?</h5><p class="mom-detail-section-subtitle">Automatycznie wychwycone sygnały w wydatkach porównywanych miesięcy.</p></div></div><div class="mom-detail-empty">Brak jednoznacznych wzorców dla wybranej kategorii.</div></section>`;
    const patternsContent=`${patternsSection}${weeklySection.section}`;
    const contributionsSection=buildMomDetailContributionsSection(detail, monthA, monthB);
    const sortedDays=[...detail.days];
    if(momDetailSort==='impact'){
      sortedDays.sort((a,b)=>{
        const impactDiff=Math.abs(b.delta)-Math.abs(a.delta);
        if(Math.abs(impactDiff)>0.01) return impactDiff;
        if(b.totalA!==a.totalA) return b.totalA-a.totalA;
        if(b.totalB!==a.totalB) return b.totalB-a.totalB;
        return a.day-b.day;
      });
    }else{
      sortedDays.sort((a,b)=>a.day-b.day);
    }
    const formatDayCount=count=>{
      if(!count) return 'Brak';
      if(count===1) return '1 trans.';
      return `${count} trans.`;
    };
    const weekdayLabels=['Pn','Wt','Śr','Cz','Pt','So','Nd'];
    const anchorMonth=monthA||monthB;
    let calendarOffset=0;
    if(anchorMonth){
      const [anchorYear,anchorMonthIdx]=anchorMonth.split('-').map(Number);
      if(anchorYear && anchorMonthIdx){
        const firstDate=new Date(anchorYear, anchorMonthIdx-1, 1);
        if(!Number.isNaN(firstDate.getTime())){
          const jsDay=firstDate.getDay();
          calendarOffset=(jsDay+6)%7;
        }
      }
    }
    const weekdayRow=weekdayLabels.map(label=>`<div class="mom-detail-calendar-weekday" aria-hidden="true">${label}</div>`).join('');
    const leadingPlaceholders=Array.from({length:calendarOffset},()=>'<div class="mom-detail-calendar-cell placeholder" aria-hidden="true"></div>').join('');
    const dayCells=detail.days.map(day=>{
      const sampleIso=day.isoA || day.isoB;
      const weekday=formatWeekdayShort(sampleIso);
      const dayLabel=weekday?`${day.label} · ${weekday}`:day.label;
      const hasEntries=day.entriesA.length>0 || day.entriesB.length>0;
      const toneClass=day.delta>0?'positive':day.delta<0?'negative':'';
      const classes=['mom-detail-calendar-cell'];
      if(!hasEntries) classes.push('is-empty');
      if(toneClass) classes.push(toneClass);
      let deltaLabel='Brak';
      if(hasEntries){
        if(day.delta>0) deltaLabel=`A +${fmt(Math.abs(day.delta), state.currency)}`;
        else if(day.delta<0) deltaLabel=`B +${fmt(Math.abs(day.delta), state.currency)}`;
        else deltaLabel='Bez zmian';
      }
      const amountA=day.totalA>0?fmt(day.totalA,state.currency):'—';
      const amountB=day.totalB>0?fmt(day.totalB,state.currency):'—';
      const badgeAStyle=`style="--mom-badge-bg:${colorWithAlpha(palette.monthA,0.16)};--mom-badge-color:${palette.monthA};"`;
      const badgeBStyle=`style="--mom-badge-bg:${colorWithAlpha(palette.monthB,0.16)};--mom-badge-color:${palette.monthB};"`;
      return `<div class="${classes.join(' ')}" data-mom-calendar-day="${day.day}"><div class="mom-detail-calendar-top"><div class="mom-detail-calendar-day">${dayLabel}</div><span class="mom-detail-calendar-delta">${deltaLabel}</span></div><div class="mom-detail-calendar-tracks"><div class="mom-detail-calendar-track"><div class="mom-detail-calendar-track-header"><span class="mom-detail-calendar-badge" ${badgeAStyle}>A</span><span class="mom-detail-calendar-amount">${amountA}</span></div><div class="mom-detail-calendar-list">${renderMomDetailCalendarEntries(day.entriesA)}</div></div><div class="mom-detail-calendar-track"><div class="mom-detail-calendar-track-header"><span class="mom-detail-calendar-badge" ${badgeBStyle}>B</span><span class="mom-detail-calendar-amount">${amountB}</span></div><div class="mom-detail-calendar-list">${renderMomDetailCalendarEntries(day.entriesB)}</div></div></div></div>`;
    }).join('');
    const totalCells=calendarOffset+detail.days.length;
    const trailingCount=(7-(totalCells%7))%7;
    const trailingPlaceholders=Array.from({length:trailingCount},()=>'<div class="mom-detail-calendar-cell placeholder" aria-hidden="true"></div>').join('');
    const calendarGridHtml=weekdayRow+leadingPlaceholders+dayCells+trailingPlaceholders;
    const calendarSubtitle=`Do dnia ${String(detail.dayLimit).padStart(2,'0')} • ${humanMonthA} / ${humanMonthB}`;
    const deltaToneClass=changeTone||'neutral';
    const calendarLegend=`<div class="mom-detail-calendar-legend"><span class="mom-detail-calendar-pill month-a">A: ${fmt(detail.totalA,state.currency)}</span><span class="mom-detail-calendar-pill month-b">B: ${fmt(detail.totalB,state.currency)}</span><span class="mom-detail-calendar-pill delta ${deltaToneClass}">Δ ${changeValue}</span></div>`;
    const calendarSection=`<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">📅 Kalendarz transakcji</h5><p class="mom-detail-section-subtitle">${calendarSubtitle}</p></div></div><div class="mom-detail-calendar">${calendarLegend}<div class="mom-detail-calendar-grid">${calendarGridHtml}</div></div></section>`;
    const daysForList=sortedDays.filter(day=>day.entriesA.length>0 || day.entriesB.length>0);
    const maxImpact=daysForList.reduce((max,day)=>Math.max(max,Math.abs(day.delta)),0);
    const listTitle=momDetailSort==='impact'?'🗂️ Największe różnice dzienne':'🗂️ Pełna lista dni';
    const listSubtitle=momDetailSort==='impact'
      ? 'Sortowanie według największych odchyleń pomiędzy miesiącami A i B.'
      : 'Chronologiczne zestawienie różnic dla każdego dnia zakresu.';
    const listCards=daysForList.map((day,idx)=>{
      const toneClass=day.delta>0?'positive':day.delta<0?'negative':'neutral';
      const badgeTone=day.delta>0?'positive':day.delta<0?'negative':'neutral';
      const sampleIso=day.isoA || day.isoB;
      const weekday=formatWeekdayShort(sampleIso);
      const dayTitle=weekday?`Dzień ${day.label} • ${weekday}`:`Dzień ${day.label}`;
      const subTitle=`Suma: A ${fmt(day.totalA,state.currency)} • B ${fmt(day.totalB,state.currency)}`;
      const cumulativeLine=`Narastająco A ${fmt(day.cumulativeA,state.currency)} • B ${fmt(day.cumulativeB,state.currency)}`;
      const deltaValue=Math.abs(day.delta);
      let badgeText='Bez różnicy';
      if(day.delta>0) badgeText=`A +${fmt(deltaValue,state.currency)}`;
      else if(day.delta<0) badgeText=`B +${fmt(deltaValue,state.currency)}`;
      const countA=formatDayCount(day.entriesA.length);
      const countB=formatDayCount(day.entriesB.length);
      return `<div class="mom-detail-day ${toneClass}" data-mom-detail-day="${idx}"><div class="mom-detail-day-header"><div><div class="mom-detail-day-title">${dayTitle}</div><div class="mom-detail-day-subtitle">${subTitle}</div><div class="mom-detail-day-subline">${cumulativeLine}</div></div><div class="mom-detail-badge ${badgeTone}">${badgeText}</div></div><div class="mom-detail-columns"><div class="mom-detail-month"><div class="mom-detail-month-label"><span>Miesiąc A</span><span class="mom-detail-month-count">${countA}</span></div>${renderMomDetailEntries(day.entriesA)}</div><div class="mom-detail-month"><div class="mom-detail-month-label"><span>Miesiąc B</span><span class="mom-detail-month-count">${countB}</span></div>${renderMomDetailEntries(day.entriesB)}</div></div></div>`;
    }).join('');
    const listContent=daysForList.length
      ? `<details class="mom-detail-daylist-panel"><summary>Pokaż szczegóły dni (${daysForList.length})</summary><div class="mom-detail-daylist">${listCards}</div></details>`
      : '<div class="mom-detail-empty">Brak transakcji do wyświetlenia w wybranym zakresie.</div>';
    const daylistSection=`<section class="mom-detail-section"><div class="mom-detail-section-header"><div><h5 class="mom-detail-section-title">${listTitle}</h5><p class="mom-detail-section-subtitle">${listSubtitle}</p></div></div>${listContent}</section>`;
    destroyMomDetailWaterfallChart();
    destroyMomDetailForecastChart();
    const panelsHtml=MOM_DETAIL_TABS.map(key=>`<div class="mom-detail-tabpanel" id="mom-detail-panel-${key}" data-mom-detail-panel="${key}" role="tabpanel" aria-labelledby="mom-detail-tab-${key}" aria-hidden="true"></div>`).join('');
    bodyEl.innerHTML=`<div class="mom-detail-tabpanels">${panelsHtml}</div>`;
    const overviewFlow=[heroSection,insightsSection,overviewSection,waterfallSection,patternsSection,weeklySection.section,calendarSection,contributionsSection.topSection,contributionsSection.fullSection,daylistSection].filter(Boolean).join('');
    momDetailTabCache={
      overview:{
        loaded:false,
        render:panel=>{
          panel.innerHTML=overviewFlow;
          destroyMomDetailWaterfallChart();
          destroyMomDetailForecastChart();
          const scheduleWaterfall=()=>renderMomDetailWaterfallChart(detail);
          if(typeof requestAnimationFrame==='function') requestAnimationFrame(scheduleWaterfall);
          else scheduleWaterfall();
          if(forecastSection){
            const scheduleForecast=()=>renderMomDetailForecastChart(forecast,palette);
            if(typeof requestAnimationFrame==='function') requestAnimationFrame(scheduleForecast);
            else scheduleForecast();
          }
          bindMomDetailHeatmap(panel, weeklySection.cells);
          bindMomDetailContributions(panel, contributionsSection.rows);
          daysForList.forEach((day,idx)=>{
            const el=panel.querySelector(`[data-mom-detail-day="${idx}"]`);
            if(!el) return;
            const toneColor=day.delta>0?palette.positive:day.delta<0?palette.negative:palette.ink;
            const impact=maxImpact>0?Math.min(1,Math.abs(day.delta)/maxImpact):0;
            const background=day.delta===0?colorWithAlpha(palette.ink,0.06):colorWithAlpha(toneColor,0.14+0.22*impact);
            const border=day.delta===0?colorWithAlpha(palette.ink,0.16):colorWithAlpha(toneColor,0.32+0.2*impact);
            el.style.background=`linear-gradient(135deg, ${background}, rgba(255,255,255,0.92))`;
            el.style.borderColor=border;
          });
        }
      },
      calendar:{
        loaded:false,
        render:panel=>{
          panel.innerHTML=calendarSection;
        }
      },
      patterns:{
        loaded:false,
        render:panel=>{
          panel.innerHTML=patternsContent;
          bindMomDetailHeatmap(panel, weeklySection.cells);
        }
      },
      stats:{
        loaded:false,
        render:panel=>{
          panel.innerHTML=statsSection;
        }
      },
      transactions:{
        loaded:false,
        render:panel=>{
          panel.innerHTML=`${contributionsSection.topSection}${contributionsSection.fullSection}${daylistSection}`;
          bindMomDetailContributions(panel, contributionsSection.rows);
          daysForList.forEach((day,idx)=>{
            const el=panel.querySelector(`[data-mom-detail-day="${idx}"]`);
            if(!el) return;
            const toneColor=day.delta>0?palette.positive:day.delta<0?palette.negative:palette.ink;
            const impact=maxImpact>0?Math.min(1,Math.abs(day.delta)/maxImpact):0;
            const background=day.delta===0?colorWithAlpha(palette.ink,0.06):colorWithAlpha(toneColor,0.14+0.22*impact);
            const border=day.delta===0?colorWithAlpha(palette.ink,0.16):colorWithAlpha(toneColor,0.32+0.2*impact);
            el.style.background=`linear-gradient(135deg, ${background}, rgba(255,255,255,0.92))`;
            el.style.borderColor=border;
          });
        }
      }
    };
    activateMomDetailTab();
    const scrollWrap=document.querySelector('.mom-detail-scroll');
    const header=document.querySelector('.mom-detail-header');
    if(scrollWrap){
      scrollWrap.scrollTop=0;
      if(header){
        header.classList.toggle('scrolled', scrollWrap.scrollTop>60);
      }
      if(!scrollWrap.dataset.heatmapScrollBound){
        scrollWrap.dataset.heatmapScrollBound='1';
        scrollWrap.addEventListener('scroll',()=>{
          hideMomDetailHeatmapTooltip();
          if(header){
            header.classList.toggle('scrolled', scrollWrap.scrollTop>60);
          }
        },{passive:true});
      }
    } else if(header){
      header.classList.remove('scrolled');
    }
  }

  function renderMomComparison(){
    const section=document.getElementById('tab-mom');
    if(!section) return;
    const info=document.getElementById('mom-info');
    const summary=document.getElementById('mom-summary');
    const selectA=document.getElementById('mom-month-a');
    const selectB=document.getElementById('mom-month-b');
    const dayInput=document.getElementById('mom-day-input');
    const tableBody=document.querySelector('#mom-table tbody');
    const colA=document.getElementById('mom-col-a');
    const colB=document.getElementById('mom-col-b');
    const emptyChart=document.getElementById('mom-chart-empty');
    const chartCanvas=document.getElementById('mom-chart');
    const caption=document.getElementById('mom-chart-caption');
    const diffCanvas=document.getElementById('mom-diff-chart');
    const diffEmpty=document.getElementById('mom-diff-empty');
    const diffCaption=document.getElementById('mom-diff-caption');

    ensureMomDetailBindings();

    const months=getAnalyticsAvailableMonths();
    ensureMomState(months);

    if(selectA){
      selectA.innerHTML='';
      if(months.length===0){
        selectA.disabled=true;
        selectA.add(new Option('Brak danych',''));
      }else{
        selectA.disabled=false;
        months.forEach(m=>selectA.add(new Option(m,m,false,m===momState.monthA)));
      }
      selectA.onchange=e=>{momState.monthA=e.target.value||null; renderMomComparison();};
    }
    if(selectB){
      selectB.innerHTML='';
      if(months.length===0){
        selectB.disabled=true;
        selectB.add(new Option('Brak danych',''));
      }else{
        selectB.disabled=false;
        months.forEach(m=>selectB.add(new Option(m,m,false,m===momState.monthB)));
      }
      selectB.onchange=e=>{momState.monthB=e.target.value||null; renderMomComparison();};
    }
    if(dayInput){
      dayInput.disabled=months.length===0;
      dayInput.value=momState.day;
      dayInput.onchange=e=>{
        const raw=Number(e.target.value);
        if(!Number.isFinite(raw)){
          e.target.value=momState.day;
          return;
        }
        momState.day=Math.min(31,Math.max(1,Math.round(raw)));
        renderMomComparison();
      };
    }

    if(months.length===0){
      if(info) info.textContent='Brak danych do porównania. Dodaj transakcje, aby rozpocząć analizę.';
      if(summary){summary.style.display='none'; summary.textContent='';}
      if(colA) colA.textContent='Miesiąc A';
      if(colB) colB.textContent='Miesiąc B';
      if(tableBody) tableBody.innerHTML='<tr><td colspan="5" class="muted" style="text-align:center;">Brak danych do wyświetlenia.</td></tr>';
      momLastContext=null;
      destroyMomChart();
      destroyMomDiffChart();
      if(chartCanvas) chartCanvas.style.display='none';
      if(emptyChart) emptyChart.style.display='flex';
      if(caption) caption.textContent='';
      if(diffCanvas) diffCanvas.style.display='none';
      if(diffEmpty) diffEmpty.style.display='flex';
      if(diffCaption) diffCaption.textContent='';
      updateMomDetailTrigger();
      if(momDetailOpen) renderMomDetail();
      return;
    }

    const effectiveDay=getMomEffectiveDay(momState.monthA,momState.monthB,Number(momState.day));

    if(info) info.textContent='Porównuj tempo wydatków w dwóch miesiącach roku.';
    if(summary){
      const requested=Number(momState.day);
      summary.style.display='block';
      const base=`Porównanie do dnia ${String(effectiveDay).padStart(2,'0')}.`;
      summary.textContent = effectiveDay !== requested ? `${base} Dopasowano do liczby dni krótszego miesiąca.` : base;
    }
    if(colA) colA.textContent = momState.monthA ? `Miesiąc A (${momState.monthA})` : 'Miesiąc A';
    if(colB) colB.textContent = momState.monthB ? `Miesiąc B (${momState.monthB})` : 'Miesiąc B';

    const allCats=(b().categories||[]);
    const expenseCats=allCats.filter(c=>c.type==='expense');
    const savingCats=allCats.filter(c=>c.type==='saving');
    const aggregateCategories=[
      {id:'__all',name:'Wszystkie kategorie',emoji:'📊'},
      {id:MOM_SAVINGS_ID,name:MOM_SAVINGS_LABEL,emoji:'💰'},
      {id:MOM_NO_FIXED_ID,name:MOM_NO_FIXED_LABEL,emoji:'🧾'},
      {id:MOM_NO_FIXED_SAVINGS_ID,name:MOM_NO_FIXED_SAVINGS_LABEL,emoji:'📂'}
    ];
    const categories=[...aggregateCategories];
    for(const cat of expenseCats){
      categories.push({id:cat.id,name:cat.name,emoji:cat.emoji||''});
    }
    for(const cat of savingCats){
      categories.push({id:cat.id,name:cat.name,emoji:cat.emoji||''});
    }
    if(!categories.some(c=>c.id===momState.selectedCategory)){
      momState.selectedCategory='__all';
    }

    const catIds=categories.map(c=>c.id);
    const monthAData=buildMomSeries(momState.monthA,catIds);
    const monthBData=buildMomSeries(momState.monthB,catIds);

    const rows=categories.map(cat=>{
      const totalA=momSeriesValue(monthAData,cat.id,effectiveDay);
      const totalB=momSeriesValue(monthBData,cat.id,effectiveDay);
      return {cat,totalA,totalB,diff:totalA-totalB};
    });
    const aggregateOrder=new Map(aggregateCategories.map((cat,idx)=>[cat.id,idx]));
    const aggregateRows=rows
      .filter(row=>aggregateOrder.has(row.cat.id))
      .sort((a,b)=>aggregateOrder.get(a.cat.id)-aggregateOrder.get(b.cat.id));
    const detailRows=rows
      .filter(row=>!aggregateOrder.has(row.cat.id))
      .sort((a,b)=>b.totalA-a.totalA);
    const ordered=[...aggregateRows,...detailRows];

    if(tableBody){
      tableBody.innerHTML='';
      ordered.forEach(row=>{
        const tr=document.createElement('tr');
        tr.dataset.catId=row.cat.id;
        const label=momCategoryLabel(row.cat);
        tr.innerHTML=`<td>${label}</td><td>${fmt(row.totalA, state.currency)}</td><td>${fmt(row.totalB, state.currency)}</td><td>${formatMomDiff(row.diff)}</td><td>${formatMomPace(row.totalA,row.totalB)}</td>`;
        tr.addEventListener('click',()=>{
          momState.selectedCategory=row.cat.id;
          updateMomActiveRows(tableBody);
          updateMomChart();
          updateMomDetailTrigger();
          if(momDetailOpen) renderMomDetail();
        });
        tableBody.appendChild(tr);
      });
      updateMomActiveRows(tableBody);
    }

    momLastContext={categories,monthA:momState.monthA,monthB:momState.monthB,dayLimit:effectiveDay,monthAData,monthBData};
    updateMomDetailTrigger();
    updateMomChart();
    if(momDetailOpen) renderMomDetail();
  }

  function updateMomChart(){
    const canvas=document.getElementById('mom-chart');
    const empty=document.getElementById('mom-chart-empty');
    const caption=document.getElementById('mom-chart-caption');
    const diffCanvas=document.getElementById('mom-diff-chart');
    const diffEmpty=document.getElementById('mom-diff-empty');
    const diffCaption=document.getElementById('mom-diff-caption');
    if(!canvas || !diffCanvas){
      destroyMomChart();
      destroyMomDiffChart();
      return;
    }
    if(!momLastContext){
      destroyMomChart();
      destroyMomDiffChart();
      if(empty) empty.style.display='flex';
      canvas.style.display='none';
      if(caption) caption.textContent='';
      if(diffEmpty) diffEmpty.style.display='flex';
      diffCanvas.style.display='none';
      if(diffCaption) diffCaption.textContent='';
      updateMomDetailTrigger();
      if(momDetailOpen) renderMomDetail();
      return;
    }
    const {categories,monthA,monthB,dayLimit,monthAData,monthBData}=momLastContext;
    const selected=categories.find(c=>c.id===momState.selectedCategory)||categories[0];
    const seriesA=momSeriesSlice(monthAData,selected.id,dayLimit);
    const seriesB=momSeriesSlice(monthBData,selected.id,dayLimit);
    const maxLen=Math.max(seriesA.length,seriesB.length);
    if(maxLen===0){
      destroyMomChart();
      destroyMomDiffChart();
      if(empty) empty.style.display='flex';
      canvas.style.display='none';
      if(caption) caption.textContent='Brak danych dla wybranej kategorii.';
      if(diffEmpty) diffEmpty.style.display='flex';
      diffCanvas.style.display='none';
      if(diffCaption) diffCaption.textContent='';
      updateMomDetailTrigger();
      if(momDetailOpen) renderMomDetail();
      return;
    }
    const labels=Array.from({length:maxLen},(_,i)=>String(i+1).padStart(2,'0'));
    const diffSeries=labels.map((_,idx)=>{
      const valA=idx<seriesA.length?seriesA[idx]:null;
      const valB=idx<seriesB.length?seriesB[idx]:null;
      if(valA===null && valB===null) return null;
      const safeA=Number.isFinite(valA)?valA:0;
      const safeB=Number.isFinite(valB)?valB:0;
      return safeA-safeB;
    });
    canvas.style.display='block';
    diffCanvas.style.display='block';
    if(empty) empty.style.display='none';
    if(diffEmpty) diffEmpty.style.display='none';
    destroyMomChart();
    destroyMomDiffChart();
    const palette=momPalette();
    const toRgb=(value)=>{
      if(!value) return null;
      const raw=String(value).trim();
      const hexMatch=raw.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
      if(hexMatch){
        let hex=hexMatch[1];
        if(hex.length===3){
          hex=hex.split('').map(ch=>ch+ch).join('');
        }
        const int=parseInt(hex,16);
        return {
          r:(int>>16)&255,
          g:(int>>8)&255,
          b:int&255
        };
      }
      const rgbMatch=raw.match(/^rgba?\(([^)]+)\)$/i);
      if(rgbMatch){
        const parts=rgbMatch[1].split(',').map(part=>Number(part.trim())).filter(num=>Number.isFinite(num));
        if(parts.length>=3){
          return {r:parts[0],g:parts[1],b:parts[2]};
        }
      }
      return null;
    };
    const mixColor=(color,target,amount)=>{
      const base=toRgb(color);
      const mix=toRgb(target);
      if(!base||!mix) return color;
      const clamp=(v)=>Math.max(0,Math.min(255,Math.round(v)));
      const r=clamp(base.r+(mix.r-base.r)*amount);
      const g=clamp(base.g+(mix.g-base.g)*amount);
      const b=clamp(base.b+(mix.b-base.b)*amount);
      return `rgb(${r},${g},${b})`;
    };
    const createGradient=(ctx,color)=>{
      const area=ctx.chart.chartArea;
      if(!area){
        return colorWithAlpha(color,0.18);
      }
      const gradient=ctx.chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
      gradient.addColorStop(0, colorWithAlpha(color,0.28));
      gradient.addColorStop(1, colorWithAlpha(color,0));
      return gradient;
    };
    const lineDataset=(label,data,color)=>({
      label,
      data,
      tension:0.35,
      borderWidth:2.5,
      borderColor:color,
      fill:true,
      spanGaps:true,
      pointRadius:4,
      pointHoverRadius:6,
      pointHitRadius:14,
      pointHoverBorderWidth:3,
      pointBackgroundColor:colorWithAlpha(color,0.95),
      pointBorderColor:colorWithAlpha(color,0.35),
      pointBorderWidth:2,
      backgroundColor:(ctx)=>createGradient(ctx,color)
    });
    momChart=new Chart(canvas.getContext('2d'),{
      type:'line',
      data:{
        labels,
        datasets:[
          lineDataset(monthA||'Miesiąc A',seriesA,palette.monthA),
          lineDataset(monthB||'Miesiąc B',seriesB,palette.monthB)
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'nearest',intersect:false},
        layout:{padding:{top:8,right:12,bottom:8,left:12}},
        animations:{
          radius:{duration:300},
          tension:{duration:500,easing:'easeOutQuart'}
        },
        plugins:{
          legend:{
            display:true,
            labels:{
              usePointStyle:true,
              boxWidth:10,
              boxHeight:10,
              padding:16
            }
          },
          tooltip:{
            displayColors:false,
            mode:'nearest',
            intersect:false,
            callbacks:{
              title:items=>items[0]?`Dzień ${items[0].label}`:'',
              label:context=>`${context.dataset.label}: ${fmt(context.parsed.y,state.currency)}`,
              footer:items=>{
                if(items.length<2) return '';
                const diff=items[0].parsed.y-items[1].parsed.y;
                if(!Number.isFinite(diff)) return '';
                const sign=diff>0?'+':'';
                return `Δ A−B: ${sign}${fmt(diff,state.currency)}`;
              }
            }
          }
        },
        scales:{
          x:{
            title:{display:true,text:'Dzień miesiąca'},
            grid:{display:false},
            ticks:{maxRotation:0}
          },
          y:{
            beginAtZero:true,
            ticks:{callback:currencyTicks},
            grid:{drawBorder:false,color:colorWithAlpha(palette.ink,0.08)}
          }
        },
        onHover:(evt,elements)=>{
          const target=evt?.native?.target;
          if(target){
            target.style.cursor=elements.length?'pointer':'default';
          }
        }
      }
    });
    const diffDatasetColor=context=>{
      const value=context.raw;
      if(value===null||value===undefined) return 'transparent';
      if(value>0) return palette.positive;
      if(value<0) return palette.negative;
      return palette.neutral;
    };
    const buildBarGradient=(ctx,base)=>{
      if(base==='transparent') return base;
      const area=ctx.chart.chartArea;
      if(!area){
        return colorWithAlpha(base,0.48);
      }
      const chartCtx=ctx.chart.ctx;
      const gradient=chartCtx.createLinearGradient(0, area.bottom, 0, area.top);
      const highlight=mixColor(base,'#ffffff',0.22);
      const shadow=mixColor(base,palette.ink,0.35);
      const isPositive=(ctx.raw??0)>=0;
      if(isPositive){
        gradient.addColorStop(0, colorWithAlpha(shadow,0.55));
        gradient.addColorStop(0.55, colorWithAlpha(base,0.62));
        gradient.addColorStop(1, colorWithAlpha(highlight,0.85));
      }else{
        gradient.addColorStop(0, colorWithAlpha(highlight,0.85));
        gradient.addColorStop(0.45, colorWithAlpha(base,0.62));
        gradient.addColorStop(1, colorWithAlpha(shadow,0.55));
      }
      return gradient;
    };
    const resolveBorderColor=(base)=>{
      if(base==='transparent') return base;
      return mixColor(base,palette.ink,0.45);
    };
    const resolveHoverFill=(ctx,base)=>{
      if(base==='transparent') return base;
      const lift=mixColor(base,'#ffffff',0.32);
      return colorWithAlpha(lift,0.9);
    };
    momDiffChart=new Chart(diffCanvas.getContext('2d'),{
      type:'bar',
      data:{
        labels,
        datasets:[{
          label:'Różnica skumulowana (A − B)',
          data:diffSeries,
          backgroundColor:(ctx)=>{
            const base=diffDatasetColor(ctx);
            return buildBarGradient(ctx,base);
          },
          borderColor:(ctx)=>resolveBorderColor(diffDatasetColor(ctx)),
          hoverBorderColor:(ctx)=>diffDatasetColor(ctx),
          hoverBackgroundColor:(ctx)=>resolveHoverFill(ctx,diffDatasetColor(ctx)),
          borderWidth:1.5,
          borderRadius:(ctx)=>{
            const value=ctx.raw;
            if(value===null||value===undefined) return 0;
            const radius=6;
            if(value>=0){
              return {topLeft:radius,topRight:radius,bottomLeft:2,bottomRight:2};
            }
            return {topLeft:2,topRight:2,bottomLeft:radius,bottomRight:radius};
          },
          borderSkipped:false,
          barPercentage:0.58,
          categoryPercentage:0.78,
          maxBarThickness:26
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'nearest',intersect:false},
        layout:{padding:{top:8,right:12,bottom:8,left:12}},
        animations:{
          y:{duration:600,easing:'easeOutQuart'},
          x:{duration:400,easing:'easeOutQuad'}
        },
        plugins:{
          legend:{display:false},
          tooltip:{
            filter:item=>item.raw!==null && item.raw!==undefined,
            callbacks:{
              title:items=>items[0]?`Dzień ${items[0].label}`:'',
              label:context=>`${fmt(context.parsed.y,state.currency)} (A − B)`,
              afterLabel:context=>{
                const value=context.parsed.y;
                if(!Number.isFinite(value)) return '';
                if(value>0) return 'Miesiąc A wydaje szybciej.';
                if(value<0) return 'Miesiąc B wydaje szybciej.';
                return 'Tempo wydatków jest identyczne.';
              }
            }
          }
        },
        scales:{
          x:{
            title:{display:true,text:'Dzień miesiąca'},
            grid:{display:false},
            ticks:{maxRotation:0}
          },
          y:{
            beginAtZero:true,
            ticks:{callback:currencyTicks},
            grid:{drawBorder:false,color:colorWithAlpha(palette.ink,0.08)}
          }
        }
      }
    });
    if(caption){
      const label=momCategoryLabel(selected);
      caption.textContent=`Aktualnie porównywana kategoria: ${label}.`;
    }
    if(diffCaption){
      diffCaption.textContent='Wartości dodatnie wskazują, że miesiąc A wyprzedza miesiąc B (wydano więcej).';
    }
  }


  // --- Recurring templates (variable expenses) --------------------------------
  function scheduledDateFor(tpl, ym){
    const d=Math.min(Math.max(1, Number(tpl.day)||1), daysInYm(ym));
    return `${ym}-${String(d).padStart(2,'0')}`;
  }
  function isLogged(templateId, ym){
    return (b().recurringLog||[]).some(r=>r.templateId===templateId && r.ym===ym);
  }
  function renderRecurringSuggestions(){
    const ym=b().workingMonth;
    const box=document.getElementById('rec-suggestions');
    const list=document.getElementById('rec-sugg-list');
    const monthLabel=document.getElementById('rec-sugg-month');
    monthLabel.textContent=ym;

    const candidates=(b().recurringTemplates||[])
      .map(t=>({t, date:scheduledDateFor(t,ym)}))
      .filter(x=>!isLogged(x.t.id, ym));

    if(candidates.length===0){ box.style.display='none'; }
    else{
      box.style.display='block';
      list.innerHTML='';
      for(const {t,date} of candidates){
        const summary = t.splits?.length
          ? `Split (${t.splits.length} pozycji)`
          : `${fmt(signFor(t.categoryId, num(t.amount)), state.currency)} • ${(catsById()[t.categoryId]?.name)||'—'}`;
        const div=document.createElement('div'); div.className='card';
        div.innerHTML=`
          <div class="row">
            <div><b>${t.label}</b> <span class="muted">(${date})</span></div>
            <div class="muted">${summary}</div>
          </div>
          <div class="row" style="margin-top:6px">
            <div class="tiny">${t.note||''}</div>
            <div style="display:flex;gap:6px">
              <button class="btn soft" data-act="add-date">Dodaj (na ${date})</button>
              <button class="btn soft" data-act="add-today">Dodaj na dziś</button>
              <button class="btn danger" data-act="dismiss">Odrzuć</button>
            </div>
          </div>`;
        div.querySelector('[data-act="add-date"]').onclick=()=>applyTemplate(t,date);
        div.querySelector('[data-act="add-today"]').onclick=()=>applyTemplate(t,new Date().toISOString().slice(0,10));
        div.querySelector('[data-act="dismiss"]').onclick=()=>{b().recurringLog.push({templateId:t.id,ym,action:'dismissed'}); save(state); renderAll();};
        list.appendChild(div);
      }
    }
    document.getElementById('rec-manage-toggle').onclick=()=>{
      const m=document.getElementById('rec-manage');
      m.style.display = m.style.display==='none' ? 'block' : 'none';
      if(m.style.display==='block'){renderRecurringManage()}
    }
  }
  function applyTemplate(tpl,date){
    const txBase={id:`tx_${Math.random().toString(36).slice(2)}`,date,accountId:tpl.accountId||b().accounts[0]?.id||'a_main',note:tpl.note||tpl.label};
    if(tpl.splits?.length){
      const total=tpl.splits.reduce((s,sp)=>s+signFor(sp.categoryId,num(sp.amount)),0);
      b().transactions.unshift({...txBase,categoryId:tpl.splits[0].categoryId,amount:total,splits:tpl.splits.map(s=>({categoryId:s.categoryId,amount:num(s.amount)}))});
    }else{
      const signed=signFor(tpl.categoryId, num(t.amount));
      b().transactions.unshift({...txBase,categoryId:tpl.categoryId,amount:signed});
    }
    b().recurringLog.push({templateId:tpl.id,ym:date.slice(0,7),action:'added'});
    save(state); renderAll();
  }
  function renderRecurringManage(){
    const form=document.getElementById('rec-add-form');
    const catSel=form.querySelector('select[name="categoryId"]'); catSel.innerHTML=''; for(const c of (b().categories||[])){catSel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id))}
    const accSel=form.querySelector('select[name="accountId"]'); accSel.innerHTML=''; for(const a of (b().accounts||[])){accSel.add(new Option(a.name,a.id))}
    const isSplit=form.querySelector('input[name="isSplit"]');
    const singleBox=form.querySelector('[data-mode="single"]');
    const splitBox=form.querySelector('[data-mode="split"]');
    isSplit.onchange=()=>{singleBox.style.display=isSplit.checked?'none':'grid'; splitBox.style.display=isSplit.checked?'block':'none'}
    const splitTbody=form.querySelector('.rec-split-rows');
    function addRow(sp){const tr=document.createElement('tr'); tr.className='rec-split-row'; tr.innerHTML=`<td><select class="sp-cat"></select></td><td><input class="sp-amt" inputmode="decimal" value="${sp?String(sp.amount).replace('.',','):''}" /></td><td><button class="btn danger" type="button">X</button></td>`; const sel=tr.querySelector('.sp-cat'); for(const c of (b().categories||[])){sel.add(new Option((c.emoji?c.emoji+' ':'')+c.name,c.id,false, sp?sp.categoryId===c.id:false))} tr.querySelector('button').onclick=()=>{tr.remove()}; splitTbody.appendChild(tr); bindMoneyInputs(tr);}
    document.getElementById('rec-split-add').onclick=()=>addRow();
    form.onsubmit=(e)=>{
      e.preventDefault();
      const f=new FormData(form);
      const label=String(f.get('label')); const day=Number(f.get('day'));
      const accountId=String(f.get('accountId')||b().accounts[0]?.id||'a_main'); const note=String(f.get('note')||'');
      if(isSplit.checked){
        const rows=Array.from(splitTbody.querySelectorAll('.rec-split-row')); if(rows.length===0){alert('Dodaj wiersze split.'); return;}
        const splits=[]; for(const r of rows){const cat=r.querySelector('.sp-cat').value; const amt=num(r.querySelector('.sp-amt').value); if(!cat || !amt){alert('Uzupełnij kategorię i kwotę w każdym wierszu.'); return;} splits.push({categoryId:cat, amount:amt});}
        b().recurringTemplates.push({id:'rt_'+Math.random().toString(36).slice(2),label,day,accountId,note,splits});
      }else{
        const categoryId=String(f.get('categoryId')); const amount=num(f.get('amount')); if(!categoryId || !amount){alert('Uzupełnij kategorię i kwotę.'); return;}
        b().recurringTemplates.push({id:'rt_'+Math.random().toString(36).slice(2),label,day,accountId,categoryId,amount,note});
      }
      save(state); form.reset(); splitTbody.innerHTML=''; singleBox.style.display='grid'; splitBox.style.display='none'; isSplit.checked=false; renderRecurringManage();
    };
    const tbody=document.getElementById('rec-rows'); tbody.innerHTML='';
    for(const t of (b().recurringTemplates||[])){
      const mode=t.splits?.length?'split':'single';
      const summary = t.splits?.length ? t.splits.map(s=>`${(catsById()[s.categoryId]?.name)||'—'}: ${fmt(num(s.amount),state.currency)}`).join(' | ') : `${fmt(signFor(t.categoryId,num(t.amount)),state.currency)} • ${(catsById()[t.categoryId]?.name)||'—'}`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.label}</td><td>${t.day}</td><td>${mode}</td><td>${summary||'—'}</td><td>${(b().accounts||[]).find(a=>a.id===t.accountId)?.name||'—'}</td><td>${t.note||''}</td><td><button class="btn danger">Usuń</button></td>`;
      tr.querySelector('.btn').onclick=()=>{ if(!confirm('Usunąć szablon cykliczny?')) return; b().recurringTemplates=(b().recurringTemplates||[]).filter(x=>x.id!==t.id); b().recurringLog=(b().recurringLog||[]).filter(x=>x.templateId!==t.id); save(state); renderRecurringManage(); };
      tbody.appendChild(tr);
    }
    bindMoneyInputs(form);
  }

  // --- Safe render orchestrator ----------------------------------------------
  function safeRender(fn, name){ try{ fn(); } catch(err){ console.error('Render error:', name, err); } }

  function renderIncomes(){
    const ym=b().workingMonth; ensureMonth(ym);
    document.getElementById('inc-month').textContent=ym;
    const tbody=document.getElementById('inc-rows');tbody.innerHTML='';
    const sum=b().monthly[ym].incomes.reduce((s,x)=>s+num(x.amount),0);
    document.getElementById('inc-sum').textContent=fmt(sum,state.currency);
    for(const r of b().monthly[ym].incomes){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${fmt(r.amount,state.currency)}</td><td>${r.note||''}</td><td><button data-id="${r.id}" class="btn danger">Usuń</button></td>`;
      tr.querySelector('button').onclick=()=>{ if(!confirm('Na pewno usunąć ten przychód?')) return; b().monthly[ym].incomes=b().monthly[ym].incomes.filter(x=>x.id!==r.id); save(state); renderAll(); };
      tbody.appendChild(tr);
    }
  }

  function renderFixed(){
    const ym=b().workingMonth; ensureMonth(ym);
    document.getElementById('fix-month').textContent=ym;
    
    // NEW: Render suggestions from templates
    renderFixedSuggestions();

    // NEW: Setup manager toggle button
    document.getElementById('fix-manage-templates-btn').onclick=()=>{
      const manager = document.getElementById('fix-templates-manager');
      manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
      if(manager.style.display === 'block') renderFixedTemplatesManager();
    };

    const tbody=document.getElementById('fix-rows');tbody.innerHTML='';
    let unpaidSum = 0;
    const fixedForMonth = b().monthly[ym].fixed.sort((a,b) => (a.due||'').localeCompare(b.due||''));

    for(const r of fixedForMonth){
      if (!r.paid) unpaidSum += num(r.amount);
      let daysToDue = '';
      if (r.due) {
        const dueDate = new Date(r.due); const today = new Date(); today.setHours(0,0,0,0);
        const diffDays = Math.ceil((dueDate - today) / (1000*60*60*24));
        if (diffDays < 0) daysToDue = `<span class="bad">${Math.abs(diffDays)} dni po terminie</span>`;
        else if (diffDays <= 3) daysToDue = `<span class="warn">${diffDays} dni</span>`;
        else if (diffDays <= 7) daysToDue = `<span class="ok">${diffDays} dni</span>`;
        else daysToDue = `${diffDays} dni`;
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><label style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" ${r.paid?'checked':''}/> ${r.paid?'✅ Opłacone':'⏳ Do zapłaty'}</label></td><td>${r.title}</td><td>${fmt(r.amount,state.currency)}</td><td>${r.due||'—'}</td><td>${daysToDue}</td><td><button class="btn danger">Usuń</button></td>`;
      tr.querySelector('input').onchange=()=>{
        r.paid=!r.paid;

        const existingTxIndex = b().transactions.findIndex(tx => tx.linkedFixedId === r.id);
        if (existingTxIndex > -1) {
            b().transactions.splice(existingTxIndex, 1);
        }

        if(r.paid && b().createTxOnFixedPay){
          const date = r.due && new Date(r.due) <= new Date() ? r.due : new Date().toISOString().slice(0,10);
          b().transactions.unshift({
            id:`tx_${Math.random().toString(36).slice(2)}`,
            date,
            amount:-Math.abs(r.amount),
            categoryId:'c_fixed',
            accountId:b().accounts[0]?.id||'a_main',
            note:`Stały: ${r.title}`,
            linkedFixedId: r.id
          });
        }
        save(state); renderAll()
      };
      tr.querySelector('.btn').onclick=()=>{ if(!confirm('Usunąć ten stały wydatek?')) return; b().monthly[ym].fixed=b().monthly[ym].fixed.filter(x=>x.id!==r.id); save(state); renderAll() };
      tbody.appendChild(tr);
    }
    document.getElementById('fix-unpaid-sum').textContent = fmt(unpaidSum, state.currency);
    document.getElementById('autoTx').checked = !!b().createTxOnFixedPay;
    document.getElementById('payAllFixed').onclick = ()=>{
      const unpaid = b().monthly[ym].fixed.filter(f=>!f.paid);
      if(unpaid.length === 0) { alert('Wszystkie stałe wydatki na ten miesiąc są już opłacane.'); return; }
      if(!confirm(`Czy na pewno chcesz opłacić ${unpaid.length} pozycji?`)) return;
      for(const item of unpaid) {
        item.paid=true;
        if(b().createTxOnFixedPay){
            const txExists = b().transactions.some(tx => tx.linkedFixedId === item.id);
            if (!txExists) {
                const date = item.due && new Date(item.due) <= new Date() ? item.due : new Date().toISOString().slice(0,10);
                b().transactions.unshift({
                    id:`tx_${Math.random().toString(36).slice(2)}`,
                    date,
                    amount:-Math.abs(item.amount),
                    categoryId:'c_fixed',
                    accountId:b().accounts[0]?.id||'a_main',
                    note:`Stały: ${item.title}`,
                    linkedFixedId: item.id
                });
            }
        }
      }
      save(state); renderAll();
    };
  }

  function renderGoalsAndEOM(){ safeRender(()=>{bindEomV2();renderEomV2();},'EOM'); safeRender(renderGoals,'Goals'); }

  function renderAll(){
    const ym=b().workingMonth;
    document.getElementById('workingMonth').textContent=ym;
    safeRender(renderDashboard,'Dashboard');
    safeRender(renderOverview,'Overview');
    safeRender(renderIncomes,'Incomes');
    safeRender(renderFixed,'Fixed');
    safeRender(renderVariable,'Variable');
    safeRender(renderInvestments,'Investments');
    safeRender(renderCategories,'Categories');
    safeRender(renderMomComparison,'MoM');
    safeRender(renderGoalsAndEOM,'Goals+EOM');
    bindMoneyInputs();
  }
  renderAll();
  </script>
</body>
</html>
