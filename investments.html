<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS ‚Äî Inwestycje (tryb arkusza)</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Minimalny, arkuszowy wyglƒÖd */
    .sheet-card { border: 1px solid var(--line); border-radius: 14px; background: var(--card); box-shadow: 0 10px 30px rgba(15,23,42,0.05); }
    .sheet-card h3 { margin: 0 0 8px; }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .kpi { padding: 16px; border-radius: 12px; border: 1px solid var(--line); background: linear-gradient(120deg, rgba(59,130,246,0.05), rgba(16,185,129,0.05)); }
    .kpi .value { font-size: 26px; font-weight: 800; }
    .kpi .label { color: var(--muted); font-size: 13px; }

    .table-toolbar { display: flex; flex-wrap: wrap; gap: 8px; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .filter-tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .filter-tabs button { border-radius: 10px; border: 1px solid var(--line); background: var(--surface); padding: 8px 12px; cursor: pointer; }
    .filter-tabs button.active { background: var(--primary-light); color: var(--primary); border-color: var(--primary); }

    .sheet-table { width: 100%; border-collapse: collapse; }
    .sheet-table th, .sheet-table td { border: 1px solid #e2e8f0; padding: 10px; background: white; }
    .sheet-table thead th { background: #f8fafc; text-align: left; cursor: pointer; user-select: none; position: sticky; top: 0; z-index: 2; }
    .sheet-table tbody tr:nth-child(even) td { background: #f9fbfd; }
    .sheet-table tbody tr:hover td { background: #eef2ff; }
    .sheet-table .number { text-align: right; font-variant-numeric: tabular-nums; }
    .sheet-table input, .sheet-table select { width: 100%; padding: 8px; border: 1px solid var(--line); border-radius: 8px; background: var(--surface); }

    .add-row { background: #0f172a0d; }
    .add-row td { background: #f8fafc; }
    .add-row button { width: 100%; }

    .pill { display: inline-flex; gap: 6px; align-items: center; padding: 6px 10px; border-radius: 999px; background: var(--surface); border: 1px solid var(--line); font-size: 12px; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 10px; background: #f1f5f9; border: 1px solid var(--line); font-size: 12px; }

    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .chart-box { padding: 16px; border-radius: 12px; border: 1px solid var(--line); background: white; min-height: 260px; }

    .snapshot-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: space-between; }
    .snapshot-list { display: flex; gap: 8px; flex-wrap: wrap; }

    .muted { color: var(--muted); }
    .text-green { color: var(--green); }
    .text-red { color: var(--red); }
    .shake { animation: shake 0.3s ease; }
    @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-4px);} 50%{transform:translateX(4px);} 75%{transform:translateX(-3px);} }

    @media (max-width: 720px) {
      .sheet-table { display: block; overflow-x: auto; white-space: nowrap; }
      .sheet-table thead { display: table-header-group; }
      .sheet-table th, .sheet-table td { min-width: 120px; }
      .sheet-table td:first-child, .sheet-table th:first-child { position: sticky; left: 0; background: #f8fafc; z-index: 3; }
      .table-toolbar { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body data-page="investments">
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar__header"><span class="sidebar__emoji">üß≠</span><span class="sidebar__brand">LifeOS</span></div>
      <nav class="sidebar__nav">
        <ul class="sidebar__list">
          <li class="sidebar__item"><a class="sidebar__link" href="index.html" data-page="dashboard"><span class="sidebar__icon">üìä</span><span class="sidebar__label">Dashboard</span></a></li>
          <li class="sidebar__item"><a class="sidebar__link" href="budget.html" data-page="budget"><span class="sidebar__icon">üí∞</span><span class="sidebar__label">Bud≈ºet</span></a></li>
          <li class="sidebar__item"><a class="sidebar__link" href="tasks.html" data-page="tasks"><span class="sidebar__icon">‚úÖ</span><span class="sidebar__label">Zadania</span></a></li>
          <li class="sidebar__item"><a class="sidebar__link" href="trainings.html" data-page="trainings"><span class="sidebar__icon">üí™</span><span class="sidebar__label">Progres</span></a></li>
          <li class="sidebar__item"><a class="sidebar__link" href="fuel.html" data-page="fuel"><span class="sidebar__icon">‚õΩ</span><span class="sidebar__label">Paliwo</span></a></li>
          <li class="sidebar__item"><a class="sidebar__link" href="loan.html" data-page="loan"><span class="sidebar__icon">üè¶</span><span class="sidebar__label">Kredyt</span></a></li>
          <li class="sidebar__item"><a class="sidebar__link" href="inventory.html" data-page="inventory"><span class="sidebar__icon">üì¶</span><span class="sidebar__label">Magazyn</span></a></li>
          <li class="sidebar__item"><a class="sidebar__link" href="house.html" data-page="house"><span class="sidebar__icon">üè†</span><span class="sidebar__label">Budowa</span></a></li>
          <li class="sidebar__item"><a class="sidebar__link active" href="investments.html" data-page="investments"><span class="sidebar__icon">üìà</span><span class="sidebar__label">Inwestycje</span></a></li>
        </ul>
      </nav>
      <div class="sidebar__footer"><strong>Tw√≥j cyfrowy dom</strong></div>
    </aside>

    <div class="main">
      <header class="page-header">
        <div class="page-header__top">
          <span class="page-overline">Finanse</span>
          <h1 class="page-title"><span class="page-title__icon">üìà</span><span class="page-title__text">Arkusz inwestycji</span></h1>
        </div>
        <div class="page-header__actions">
          <button class="btn" id="snapshot-btn">üíæ Zapisz snapshot</button>
          <button class="btn soft" id="reset-btn">üßπ Wyczy≈õƒá dane</button>
        </div>
      </header>

      <div class="content">
        <main class="page-content stack" style="gap: 14px;">
          <section class="sheet-card" style="padding: 16px;">
            <div class="kpi-grid">
              <div class="kpi">
                <div class="label">Warto≈õƒá portfela</div>
                <div class="value" id="kpi-value">0 z≈Ç</div>
                <div class="muted" id="kpi-pnl">PnL: 0 z≈Ç</div>
              </div>
              <div class="kpi">
                <div class="label">Wp≈Çaty (BUY)</div>
                <div class="value" id="kpi-inflows">0 z≈Ç</div>
                <div class="muted">Suma wszystkich zakup√≥w</div>
              </div>
              <div class="kpi">
                <div class="label">Aktywa w portfelu</div>
                <div class="value" id="kpi-assets">0</div>
                <div class="muted" id="kpi-activity">Transakcje w tym miesiƒÖcu: 0</div>
              </div>
            </div>
          </section>

          <section class="chart-grid">
            <div class="chart-box">
              <div class="snapshot-row">
                <h3>Historia warto≈õci</h3>
                <span class="muted">Tw√≥rz snapshoty, aby ≈õledziƒá progres</span>
              </div>
              <canvas id="valueChart" height="160"></canvas>
            </div>
            <div class="chart-box">
              <h3>Alokacja wg typu</h3>
              <canvas id="allocationChart" height="160"></canvas>
              <div id="top-allocation" class="muted" style="margin-top: 10px;"></div>
            </div>
            <div class="chart-box">
              <h3>Wp≈Çaty miesiƒôczne</h3>
              <canvas id="inflowChart" height="160"></canvas>
            </div>
          </section>

          <section class="sheet-card" style="padding: 16px;">
            <div class="table-toolbar">
              <div class="filter-tabs">
                <button data-filter="all" class="active">Wszystko</button>
                <button data-filter="buy">Kupno</button>
                <button data-filter="sell">Sprzeda≈º</button>
              </div>
              <div class="muted">Dodaj transakcje jak w arkuszu ‚Äî linijka po linijce</div>
            </div>
            <div class="table-wrapper" id="history">
              <table class="sheet-table" id="transactions-table">
                <thead>
                  <tr>
                    <th data-sort="date">Data</th>
                    <th data-sort="ticker">Ticker</th>
                    <th>Nazwa</th>
                    <th data-sort="type">Typ</th>
                    <th data-sort="side">Kupno/Sprzeda≈º</th>
                    <th data-sort="quantity" class="number">Ilo≈õƒá</th>
                    <th data-sort="price" class="number">Cena</th>
                    <th class="number">Warto≈õƒá</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="transactions-body"></tbody>
                <tfoot>
                  <tr class="add-row">
                    <td><input type="date" id="input-date"></td>
                    <td><input type="text" id="input-ticker" placeholder="BTC"></td>
                    <td><input type="text" id="input-name" placeholder="Bitcoin"></td>
                    <td>
                      <select id="input-type">
                        <option value="crypto">Krypto</option>
                        <option value="stock">Akcje</option>
                        <option value="etf">ETF</option>
                        <option value="currency">Waluty</option>
                        <option value="gold">Z≈Çoto</option>
                        <option value="bond">Obligacje</option>
                      </select>
                    </td>
                    <td>
                      <select id="input-side">
                        <option value="buy">Kupno</option>
                        <option value="sell">Sprzeda≈º</option>
                      </select>
                    </td>
                    <td><input type="number" id="input-qty" step="0.0001" min="0" placeholder="0.0"></td>
                    <td><input type="number" id="input-price" step="0.01" min="0" placeholder="0.00"></td>
                    <td class="number" id="input-total">0.00</td>
                    <td><button class="btn" id="add-transaction-btn">+ Dodaj</button></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>

  <script>
    const state = loadState();
    let currentFilter = 'all';
    let sortState = { key: 'date', dir: 'desc' };
    let valueChart, allocationChart, inflowChart;

    function loadState() {
      const raw = localStorage.getItem('investSheet');
      if (raw) return JSON.parse(raw);
      const seed = {
        transactions: [
          { id: crypto.randomUUID(), date: new Date().toISOString().slice(0,10), ticker: 'BTC', name: 'Bitcoin', type: 'crypto', side: 'buy', quantity: 0.01, price: 140000 },
          { id: crypto.randomUUID(), date: new Date().toISOString().slice(0,10), ticker: 'MSFT', name: 'Microsoft', type: 'stock', side: 'buy', quantity: 1, price: 150 },
          { id: crypto.randomUUID(), date: new Date().toISOString().slice(0,10), ticker: 'GOLD', name: 'Z≈Çoto', type: 'gold', side: 'buy', quantity: 0.5, price: 270 },
        ],
        snapshots: []
      };
      return seed;
    }

    function saveState() {
      localStorage.setItem('investSheet', JSON.stringify(state));
    }

    function formatCurrency(value) {
      return value.toLocaleString('pl-PL', { style: 'currency', currency: 'PLN', maximumFractionDigits: 2 });
    }

    function calcHoldings() {
      const holdings = {};
      const sorted = [...state.transactions].sort((a,b) => new Date(a.date) - new Date(b.date));
      sorted.forEach(tx => {
        const key = tx.ticker.toUpperCase();
        if (!holdings[key]) {
          holdings[key] = { ticker: key, name: tx.name, type: tx.type, quantity: 0, cost: 0, lastPrice: tx.price };
        }
        const h = holdings[key];
        const total = tx.quantity * tx.price;
        if (tx.side === 'buy') {
          h.quantity += tx.quantity;
          h.cost += total;
        } else {
          const avg = h.quantity ? h.cost / h.quantity : 0;
          h.quantity -= tx.quantity;
          h.cost -= avg * tx.quantity;
          if (h.quantity < 0) { h.quantity = 0; h.cost = 0; }
        }
        h.lastPrice = tx.price;
      });
      return holdings;
    }

    function calcStats() {
      const holdings = calcHoldings();
      const positions = Object.values(holdings).filter(h => h.quantity > 0);
      const totalValue = positions.reduce((sum, h) => sum + h.quantity * h.lastPrice, 0);
      const totalInvested = state.transactions.filter(t => t.side === 'buy').reduce((s,t) => s + t.quantity * t.price, 0);
      const cost = positions.reduce((sum, h) => sum + h.cost, 0);
      const pnl = totalValue - cost;
      const month = new Date().toISOString().slice(0,7);
      const monthlyActivity = state.transactions.filter(t => t.date.startsWith(month)).length;
      return { holdings: positions, totalValue, invested: totalInvested, pnl, count: positions.length, monthlyActivity };
    }

    function renderKPIs() {
      const { totalValue, invested, pnl, count, monthlyActivity } = calcStats();
      document.getElementById('kpi-value').textContent = formatCurrency(totalValue);
      const pnlEl = document.getElementById('kpi-pnl');
      pnlEl.textContent = `PnL: ${formatCurrency(pnl)} (${((pnl/(invested||1))*100).toFixed(2)}%)`;
      pnlEl.className = pnl >= 0 ? 'text-green' : 'text-red';
      document.getElementById('kpi-inflows').textContent = formatCurrency(invested);
      document.getElementById('kpi-assets').textContent = count;
      document.getElementById('kpi-activity').textContent = `Transakcje w tym miesiƒÖcu: ${monthlyActivity}`;
    }

    function renderTable() {
      const body = document.getElementById('transactions-body');
      body.innerHTML = '';
      const filtered = state.transactions.filter(t => currentFilter === 'all' ? true : t.side === currentFilter);
      const sorted = filtered.sort((a,b) => {
        const dir = sortState.dir === 'asc' ? 1 : -1;
        if (sortState.key === 'price' || sortState.key === 'quantity') {
          return (a[sortState.key] - b[sortState.key]) * dir;
        }
        if (sortState.key === 'date') {
          return (new Date(a.date) - new Date(b.date)) * dir;
        }
        return a[sortState.key].localeCompare(b[sortState.key]) * dir;
      });

      sorted.forEach(tx => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${tx.date}</td>
          <td><strong>${tx.ticker.toUpperCase()}</strong></td>
          <td>${tx.name || '-'}</td>
          <td>${mapType(tx.type)}</td>
          <td><span class="pill">${tx.side === 'buy' ? 'Kupno' : 'Sprzeda≈º'}</span></td>
          <td class="number">${tx.quantity.toFixed(4)}</td>
          <td class="number">${formatCurrency(tx.price)}</td>
          <td class="number">${formatCurrency(tx.quantity * tx.price)}</td>
          <td><button class="btn soft" aria-label="Usu≈Ñ" onclick="removeTx('${tx.id}')">‚úï</button></td>
        `;
        body.appendChild(row);
      });
    }

    function mapType(type) {
      const labels = { crypto: 'Krypto', stock: 'Akcje', etf: 'ETF', currency: 'Waluty', gold: 'Z≈Çoto', bond: 'Obligacje' };
      return labels[type] || type;
    }

    function addTransaction() {
      const date = document.getElementById('input-date').value || new Date().toISOString().slice(0,10);
      const ticker = document.getElementById('input-ticker').value.trim();
      const name = document.getElementById('input-name').value.trim();
      const type = document.getElementById('input-type').value;
      const side = document.getElementById('input-side').value;
      const quantity = parseFloat(document.getElementById('input-qty').value);
      const price = parseFloat(document.getElementById('input-price').value);

      if (!ticker || !quantity || !price) {
        flashRow();
        return;
      }

      state.transactions.push({ id: crypto.randomUUID(), date, ticker, name, type, side, quantity, price });
      saveState();
      clearForm();
      renderAll();
    }

    function flashRow() {
      const row = document.querySelector('.add-row');
      row.classList.add('shake');
      setTimeout(() => row.classList.remove('shake'), 500);
    }

    function clearForm() {
      document.getElementById('input-ticker').value = '';
      document.getElementById('input-name').value = '';
      document.getElementById('input-qty').value = '';
      document.getElementById('input-price').value = '';
      document.getElementById('input-total').textContent = '0.00';
      document.getElementById('input-date').value = new Date().toISOString().slice(0,10);
    }

    function removeTx(id) {
      state.transactions = state.transactions.filter(t => t.id !== id);
      saveState();
      renderAll();
    }

    function renderTotalsPreview() {
      const qty = parseFloat(document.getElementById('input-qty').value) || 0;
      const price = parseFloat(document.getElementById('input-price').value) || 0;
      document.getElementById('input-total').textContent = (qty * price).toFixed(2);
    }

    function bindFilters() {
      document.querySelectorAll('.filter-tabs button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-tabs button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderTable();
        });
      });
    }

    function bindSorting() {
      document.querySelectorAll('#transactions-table thead th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.sort;
          if (sortState.key === key) {
            sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
          } else {
            sortState.key = key;
            sortState.dir = 'asc';
          }
          renderTable();
        });
      });
    }

    function renderAllocationChart() {
      const holdings = calcStats().holdings;
      const labels = holdings.map(h => h.type.toUpperCase());
      const values = holdings.map(h => h.quantity * h.lastPrice);
      const byType = {};
      holdings.forEach(h => {
        byType[h.type] = (byType[h.type] || 0) + h.quantity * h.lastPrice;
      });
      const typeLabels = Object.keys(byType).map(mapType);
      const typeValues = Object.values(byType);

      if (allocationChart) allocationChart.destroy();
      allocationChart = new Chart(document.getElementById('allocationChart'), {
        type: 'doughnut',
        data: { labels: typeLabels, datasets: [{ data: typeValues, backgroundColor: ['#2563eb','#16a34a','#f59e0b','#8b5cf6','#0ea5e9','#ef4444'] }] },
        options: { plugins: { legend: { position: 'bottom' } } }
      });

      const top = Object.entries(byType).sort((a,b) => b[1]-a[1]).slice(0,3).map(([type, val]) => `${mapType(type)}: ${formatCurrency(val)}`);
      document.getElementById('top-allocation').textContent = top.length ? top.join(' ‚Ä¢ ') : 'Brak danych o alokacji';
    }

    function renderValueChart() {
      const snapshots = state.snapshots.length ? state.snapshots : buildVirtualSnapshots();
      const labels = snapshots.map(s => new Date(s.date).toLocaleDateString('pl-PL'));
      const values = snapshots.map(s => s.value);
      if (valueChart) valueChart.destroy();
      valueChart = new Chart(document.getElementById('valueChart'), {
        type: 'line',
        data: { labels, datasets: [{ label: 'Warto≈õƒá portfela', data: values, tension: 0.25, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', fill: true }] },
        options: { scales: { y: { beginAtZero: false } }, plugins: { legend: { display: false } } }
      });
    }

    function buildVirtualSnapshots() {
      const today = new Date().toISOString();
      const { totalValue, invested } = calcStats();
      return [{ date: today, value: totalValue, invested }];
    }

    function renderInflowsChart() {
      const buckets = {};
      state.transactions.filter(t => t.side === 'buy').forEach(tx => {
        const key = tx.date.slice(0,7);
        buckets[key] = (buckets[key] || 0) + tx.quantity * tx.price;
      });
      const labels = Object.keys(buckets).sort();
      const values = labels.map(l => buckets[l]);
      if (inflowChart) inflowChart.destroy();
      inflowChart = new Chart(document.getElementById('inflowChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Wp≈Çaty', data: values, backgroundColor: '#10b981' }] },
        options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
      });
    }

    function addSnapshot() {
      const { totalValue, invested } = calcStats();
      state.snapshots.push({ id: crypto.randomUUID(), date: new Date().toISOString(), value: totalValue, invested });
      saveState();
      renderCharts();
    }

    function resetData() {
      if (!confirm('Wyczy≈õciƒá wszystkie dane?')) return;
      localStorage.removeItem('investSheet');
      Object.assign(state, loadState());
      saveState();
      renderAll();
    }

    function renderCharts() {
      renderValueChart();
      renderAllocationChart();
      renderInflowsChart();
    }

    function renderAll() {
      renderKPIs();
      renderTable();
      renderCharts();
    }

    function init() {
      bindFilters();
      bindSorting();
      document.getElementById('add-transaction-btn').addEventListener('click', addTransaction);
      ['input-qty','input-price'].forEach(id => document.getElementById(id).addEventListener('input', renderTotalsPreview));
      document.getElementById('snapshot-btn').addEventListener('click', addSnapshot);
      document.getElementById('reset-btn').addEventListener('click', resetData);
      document.getElementById('input-date').value = new Date().toISOString().slice(0,10);
      renderTotalsPreview();
      renderAll();
    }

    init();
  </script>
</body>
</html>
