<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS – Trainings</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
:root {
  --bg-alt: var(--surface);
  --primary: var(--accent);
  --primary-soft: var(--accent-weak);
  --primary-border: hsl(var(--accent-h) 55% 80% / 0.7);
  --success: var(--green);
  --success-soft: #f0fdf4;
  --success-border: #bbf7d0;
  --warning: var(--orange);
  --danger: var(--red);
  --danger-soft: #fef2f2;
  --danger-border: #fecaca;
  --warning-soft: #fffbeb;
  --warning-border: #fde68a;
  --shadow-sm: 0 12px 30px rgba(15, 23, 42, 0.08);
  --shadow-lg: 0 28px 60px rgba(15, 23, 42, 0.12);
  --transition: all .2s ease;
  --gym-color: hsl(265, 65%, 48%);
  --run-color: var(--green);
  --read-color: var(--accent);
  --extra-color: #0ea5e9;
  --vacation-color: #64748b;
}

.page-content {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.month-switcher {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.month-switcher .month-labels {
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: center;
  min-width: 140px;
}

.month-switcher .month-label {
  font-size: 18px;
  font-weight: 700;
  text-transform: capitalize;
}

.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: var(--surface);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
}

.icon-btn .icon {
  width: 18px;
  height: 18px;
}

.icon-btn:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
  border-color: hsl(var(--accent-h) 45% 75%);
}

.btn.icon-btn {
  width: 40px;
  height: 40px;
  padding: 0;
}

.btn.icon-btn .icon {
  width: 18px;
  height: 18px;
}

.icon { width: 16px; height: 16px; }

.month-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; background: var(--primary-soft); color: var(--accent); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; }

.card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
.card-header p { margin-top: 4px; }

.muted { color: var(--muted); }
.tiny { font-size: 11px; letter-spacing: 0.02em; }


/* New Activity Hub Styles */
.activity-hub {
  display: grid;
  grid-template-columns: minmax(0, 1.5fr) minmax(320px, 1fr);
  gap: 20px;
  align-items: flex-start;
  min-height: 520px;
}

.calendar-wrapper {
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 100%;
}

.calendar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  padding-bottom: 4px;
}

.calendar-header h3 { font-size: 16px; font-weight: 700; }
.calendar-legend { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; font-size: 11px; color: var(--muted); }
.calendar-legend span { display: inline-flex; align-items: center; gap: 6px; font-weight: 500;}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
  color: var(--muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-weight: 600;
  padding: 0 4px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
  grid-auto-rows: minmax(80px, 1fr);
  flex: 1;
}

.calendar-day {
  background: var(--surface);
  border-radius: 14px;
  border: 1px solid var(--line);
  padding: 8px;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}

.calendar-day:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); transform: translateY(-2px); }
.calendar-day.is-other-month { opacity: 0.5; background: transparent; border-color: transparent; }
.calendar-day.is-other-month:hover { opacity: 1; background: var(--surface); border-color: var(--primary); }
.calendar-day.is-selected { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
.calendar-day.is-today .calendar-date-number { border-color: var(--success); color: var(--success); }
.calendar-day.is-vacation { 
  background-color: #f8fafc; 
  border-color: #e2e8f0;
  background-image: repeating-linear-gradient(-45deg, transparent, transparent 4px, rgba(100, 116, 139, 0.07) 4px, rgba(100, 116, 139, 0.07) 8px);
}
.calendar-day.is-planned { background: var(--warning-soft); border-color: var(--warning-border); }
.calendar-day.is-completed { background: var(--success-soft); border-color: var(--success-border); }
.calendar-day.is-missed { background: var(--danger-soft); border-color: var(--danger-border); }
.calendar-day.is-drag-over { outline: 2px dashed var(--primary); outline-offset: 3px; background: var(--primary-soft); }
.calendar-grid.is-planning .calendar-day:not(.is-other-month) { cursor: crosshair; }

.calendar-date-number {
  font-weight: 600;
  font-size: 13px;
  line-height: 1;
  border: 1px solid transparent;
  display: inline-block;
  padding: 2px;
  border-radius: 6px;
}

.calendar-day-emojis {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  min-height: 28px;
  font-size: 20px;
}
.activity-emoji {
  opacity: 1;
  transition: opacity 0.2s ease;
}
.activity-emoji.completed {
  opacity: 0.4;
}
.activity-emoji[draggable="true"] {
    cursor: grab;
}
.activity-emoji.is-dragging {
    opacity: 0.2;
    transform: scale(1.5);
}

.calendar-day-footer {
  margin-top: auto;
  display: flex;
  justify-content: flex-end;
}

.completion-badge {
  font-size: 9px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 999px;
  color: #fff;
  background-color: var(--muted);
  opacity: 0;
  transition: var(--transition);
}
.calendar-day:hover .completion-badge,
.calendar-day.is-selected .completion-badge {
  opacity: 1;
}
.completion-badge.is-done { background-color: var(--success); }
.completion-badge.in-progress { background-color: var(--warning); }


/* Day Detail Panel Styles */
.day-detail {
  background: var(--surface);
  border-radius: 18px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  height: 100%;
  min-height: 520px;
}

.day-detail-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  gap: 12px;
  height: 100%;
  color: var(--muted);
}
.day-detail-placeholder .icon { width: 40px; height: 40px; color: rgba(148, 163, 184, 0.4); }

.day-detail-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
.day-detail-title h3 { font-size: 18px; font-weight: 700; }
.day-detail-title p { font-size: 12px; color: var(--muted); margin-top: 2px; }
.day-detail-meta { display: flex; gap: 8px; }
.day-detail-meta .btn { padding: 8px; font-size: 11px; }

.day-detail-body {
  display: flex;
  flex-direction: column;
  gap: 20px;
  flex: 1;
  overflow-y: auto;
  min-height: 0;
  padding-right: 4px;
}
.vacation-note {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
  background: #f8fafc;
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 10px 12px;
}
.vacation-note .icon { width: 18px; height: 18px; color: var(--vacation-color); }

.detail-block { display: flex; flex-direction: column; gap: 10px; }
.detail-block-header { 
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600; 
  font-size: 11px; 
  text-transform: uppercase; 
  letter-spacing: 0.08em; 
  color: var(--muted); 
  padding: 0 4px; 
}
.detail-list { display: flex; flex-direction: column; gap: 8px; }
.quick-add-list { display: flex; flex-wrap: wrap; gap: 8px; }
.quick-add-btn {
  background: #f8fafc;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}
.quick-add-btn:hover {
  background: #fff;
  border-color: var(--primary);
  color: var(--primary);
  box-shadow: var(--shadow-sm);
}


.detail-item {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: #f8fafc;
  transition: var(--transition);
}
.detail-item[draggable="true"] { cursor: grab; }
.detail-item.is-dragging { opacity: 0.4; cursor: grabbing; background: var(--primary-soft); }
.detail-item:hover { border-color: var(--primary-border); box-shadow: var(--shadow-sm); background: #fff; }
.detail-item.is-completed { background: var(--success-soft); border-color: var(--success-border); }
.detail-item.is-completed .detail-title { text-decoration: line-through; color: var(--muted); }

.detail-info { display: flex; align-items: center; gap: 10px; }
.detail-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 18px;
}
.detail-icon .icon { width: 18px; height: 18px; }
.detail-icon.gym { background: rgba(167, 139, 250, 0.2); color: var(--gym-color); }
.detail-icon.running { background: rgba(110, 231, 183, 0.3); color: var(--run-color); }
.detail-icon.reading { background: rgba(147, 197, 253, 0.3); color: var(--read-color); }
.detail-icon.extra { background: rgba(103, 232, 249, 0.3); color: var(--extra-color); }
.detail-text { display: flex; flex-direction: column; gap: 2px; }
.detail-title { font-weight: 600; font-size: 13px; }
.detail-meta { font-size: 11px; color: var(--muted); }
.detail-actions-inline { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }

.action-btn {
  width: 32px;
  height: 32px;
  padding: 0;
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  background: #fff;
  color: var(--ink);
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.action-btn .icon { width: 14px; height: 14px; }
.action-btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
.action-btn.success { background: var(--success); color: #fff; border-color: var(--success); }
.action-btn.danger { background: #fff5f5; color: var(--danger); border-color: transparent; }
.action-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }

.day-detail-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; padding-top: 12px; }
.day-detail-actions .btn { font-size: 12.5px; }

.planning-banner {
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  background: var(--primary-soft);
  border: 1px solid var(--primary-border);
  border-radius: 14px;
  padding: 10px 14px;
  margin-top: 8px;
}
.planning-banner.is-active { display: flex; }
.planning-banner-info { display: flex; align-items: center; gap: 8px; }
.planning-banner-info strong { display: block; font-size: 12px; font-weight: 700; color: var(--primary); }
.planning-banner-info span { display: block; font-size: 11px; color: var(--muted); }
.planning-banner .icon { color: var(--primary); }
.btn.small { padding: 6px 12px; font-size: 11px; border-radius: 10px; }


.heatmap-card { display: flex; flex-direction: column; gap: 16px; }
.heatmap { display: flex; gap: 4px; overflow-x: auto; padding: 4px; justify-content: center; }
.heatmap-week { display: grid; grid-template-rows: repeat(7, 14px) auto; gap: 4px; align-items: center; }
.heatmap-cell { width: 14px; height: 14px; border-radius: 4px; background: #e2e8f0; }
.heatmap-cell[data-level="0"] { background: #e2e8f0; }
.heatmap-cell[data-level="1"] { background: #b7f3d0; }
.heatmap-cell[data-level="2"] { background: #6ee7b7; }
.heatmap-cell[data-level="3"] { background: #34d399; }
.heatmap-cell[data-level="4"] { background: #059669; }
.heatmap-cell--empty { background: transparent; }
.heatmap-month-label { font-size: 9px; text-transform: uppercase; color: var(--muted); text-align: center; letter-spacing: 0.08em; margin-top: 1px; }
.heatmap-legend { display: flex; align-items: center; justify-content: flex-end; gap: 10px; font-size: 11px; color: var(--muted); }
.heatmap-legend-scale { display: inline-flex; align-items: center; gap: 4px; }
.heatmap-legend-scale span { width: 14px; height: 14px; border-radius: 3px; background: #e2e8f0; }
.heatmap-legend-scale span[data-level="1"] { background: #b7f3d0; }
.heatmap-legend-scale span[data-level="2"] { background: #6ee7b7; }
.heatmap-legend-scale span[data-level="3"] { background: #34d399; }
.heatmap-legend-scale span[data-level="4"] { background: #059669; }

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s ease;
  z-index: 100;
}
.modal-overlay.visible { opacity: 1; pointer-events: all; }
.modal-card {
  background: #fff;
  padding: 28px;
  border-radius: 18px;
  max-width: 440px;
  width: 90%;
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.modal-card h3 { font-size: 18px; font-weight: 700; }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.modal-card input, .modal-card textarea, .modal-card select { width: 100%; border: 1px solid var(--line); border-radius: 12px; padding: 12px; font-family: inherit; font-size: 13px; }
.modal-field { display: flex; flex-direction: column; gap: 6px; }
.modal-field-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.modal-options { display: flex; flex-direction: column; gap: 10px; }
.option-label { border: 1px solid var(--line); border-radius: 12px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: var(--transition); }
.option-label:hover { border-color: var(--primary); background: var(--primary-soft); }
.option-label input { accent-color: var(--primary); }

#save-status {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--ink);
  color: #fff;
  padding: 10px 20px;
  border-radius: 14px;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  pointer-events: none;
  transition: opacity .3s ease, transform .3s ease;
  font-size: 12px;
  z-index: 120;
}
#save-status.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

.kpi-progress-card {
  gap: 12px;
}

.kpi-progress-card .kpi-body {
  gap: 8px;
}
.goal-progress-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.goal-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}
.goal-progress-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 600;
}
.goal-progress-meta {
  font-size: 11px;
  color: var(--muted);
  font-weight: 500;
  text-align: right;
  flex-shrink: 0;
}
.kpi-progress-bar {
  height: 6px;
  background: #f1f5f9;
  border-radius: 999px;
  overflow: hidden;
}
.kpi-progress-fill {
  height: 100%;
  border-radius: inherit;
  transition: width 0.4s ease;
}

@media (max-width: 1080px) {
  .activity-hub { grid-template-columns: 1fr; }
  .day-detail, .day-detail-placeholder { min-height: 380px; }
}
@media (max-width: 720px) {
  .wrap { padding: 24px 18px 40px; }
  .page-header-top { flex-direction: column; align-items: flex-start; }
  .page-header-actions { width: 100%; }
  .page-header-actions .btn { flex: 1; justify-content: center; }
  .calendar-weekdays { display: none; }
  .calendar-grid { grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); grid-auto-rows: 70px; }
}
  </style>
</head>
<body data-page="trainings">
  <div class="layout">
    <aside class="sidebar" aria-label="Główna nawigacja">
      <div class="sidebar__header">
        <span class="sidebar__emoji">🧭</span>
        <span class="sidebar__brand">LifeOS</span>
      </div>
      <nav class="sidebar__nav" aria-label="Sekcje LifeOS">
        <ul class="sidebar__list">
          <li class="sidebar__item">
            <a class="sidebar__link" href="index.html" data-page="dashboard">
              <span class="sidebar__icon">📊</span>
              <span class="sidebar__label">Dashboard</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="budget.html" data-page="budget">
              <span class="sidebar__icon">💰</span>
              <span class="sidebar__label">Budżet</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="inventory.html" data-page="inventory">
              <span class="sidebar__icon">📦</span>
              <span class="sidebar__label">Magazyn</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="fuel.html" data-page="fuel">
              <span class="sidebar__icon">⛽</span>
              <span class="sidebar__label">Paliwo</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="trainings.html" data-page="trainings">
              <span class="sidebar__icon">💪</span>
              <span class="sidebar__label">Treningi</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="loan.html" data-page="loan">
              <span class="sidebar__icon">🏦</span>
              <span class="sidebar__label">Kredyt</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="tasks.html" data-page="tasks">
              <span class="sidebar__icon">✅</span>
              <span class="sidebar__label">Zadania</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="house.html" data-page="house">
              <span class="sidebar__icon">🏠</span>
              <span class="sidebar__label">Budowa</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar__footer">
        <strong>Twój cyfrowy dom</strong>
        Zarządzaj budżetem, zadaniami i celami w jednym miejscu.
      </div>
    </aside>

    <div class="main">
      <header class="page-header" role="banner">
        <div class="page-header__top">
          <span class="page-overline">Program treningowy</span>
          <h1 class="page-title">
            <span class="page-title__icon">💪</span>
            <span class="page-title__text">Treningi</span>
          </h1>
        </div>
        <div class="page-header__actions month-switcher" aria-label="Akcje strony">
          <button id="prev-month-btn" class="btn ghost icon-btn" aria-label="Poprzedni miesiąc"><i data-lucide="chevron-left" class="icon"></i></button>
          <div class="month-labels">
            <span class="month-label" id="current-month-label">--</span>
            <span class="tiny muted" id="current-month-range">--</span>
          </div>
          <span class="chip" id="header-month-chip">--</span>
          <button id="next-month-btn" class="btn ghost icon-btn" aria-label="Następny miesiąc"><i data-lucide="chevron-right" class="icon"></i></button>
          <button id="today-month-btn" class="btn soft"><i data-lucide="calendar" class="icon"></i>Dzisiaj</button>
        </div>
      </header>

      <div class="content">
        <main class="page-content content-main stack">
          <!-- New Activity Hub Layout -->
          <div class="card activity-hub">
            <div class="calendar-wrapper">
              <div class="calendar-header">
                <h3>Dziennik aktywności</h3>
                <div class="calendar-legend">
                  <span title="Trening siłowy">🏋️ Siłownia</span>
                  <span title="Bieganie">🏃 Bieganie</span>
                  <span title="Czytanie">📚 Czytanie</span>
                  <span title="Aktywność dodatkowa">✨ Dodatkowe</span>
                  <span title="Urlop">🌴 Urlop</span>
                </div>
              </div>
              <div class="calendar-weekdays">
                <span>Pon</span><span>Wt</span><span>Śr</span><span>Czw</span><span>Pt</span><span>Sob</span><span>Niedz</span>
              </div>
              <div id="calendar-grid" class="calendar-grid"></div>
              <div class="planning-banner" id="planning-banner" aria-live="polite">
                <div class="planning-banner-info">
                  <i data-lucide="mouse-pointer-click" class="icon"></i>
                  <div>
                    <strong id="planning-banner-title">Tryb planowania</strong>
                    <span id="planning-banner-meta">Klikaj dni, by dodać ten trening.</span>
                  </div>
                </div>
                <button id="stop-planning-btn" class="btn soft small"><i data-lucide="check" class="icon"></i>Zakończ</button>
              </div>
            </div>

            <div id="day-detail-container">
              <!-- This will be populated by JS -->
            </div>
          </div>
          <!-- End of Activity Hub -->

          <section class="card heatmap-card">
            <div class="card-header">
              <div>
                <h3>Historia aktywności</h3>
                <p class="muted tiny">Podsumowanie ukończonych zadań w ciągu roku</p>
              </div>
              <span class="month-chip" id="heatmap-year-label">--</span>
            </div>
            <div id="heatmap" class="heatmap"></div>
            <div class="heatmap-legend">
              <span>Brak</span>
              <div class="heatmap-legend-scale">
                <span data-level="0"></span>
                <span data-level="1"></span>
                <span data-level="2"></span>
                <span data-level="3"></span>
                <span data-level="4"></span>
              </div>
              <span>Intensywnie</span>
            </div>
          </section>
        </main>

        <aside class="right-rail">
          <div class="kpi-compact kpi-progress-card">
            <span class="kpi-emoji">📈</span>
            <div class="kpi-body">
              <span class="kpi-label">Postęp tygodniowy</span>
              <span class="kpi-value" id="metric-weekly-complete-percent">0%</span>
              <span class="tiny muted" id="metric-weekly-complete-sub"></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">📆</span>
            <div class="kpi-body">
              <span class="kpi-label">Tygodnie zaliczone</span>
              <span class="kpi-value" id="metric-weekly-complete-count">0/0</span>
              <span class="tiny muted" id="metric-weekly-count-note">Brak danych rocznych</span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">🧍</span>
            <div class="kpi-body">
              <span class="kpi-label">Dni aktywne</span>
              <span class="kpi-value" id="metric-active-days">0/0</span>
              <span class="tiny muted" id="metric-active-days-note">Brak danych</span>
            </div>
          </div>
          <div class="kpi-compact metric-card--visual kpi-next-activity" id="metric-next-activity-card" data-activity-type="none">
            <span class="kpi-emoji">🎯</span>
            <div class="kpi-body">
              <span class="kpi-label">Najbliższa aktywność</span>
              <span class="kpi-value kpi-value--sm" id="metric-next-activity-date">Brak terminu</span>
              <span class="tiny muted" id="metric-next-activity-note">Zaplanuj kolejny ruch</span>
            </div>
          </div>
          <div id="goal-progress-list" class="goal-progress-grid"></div>
        </aside>
      </div>
    </div>
  </div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-card">
    <h3 id="modal-title"></h3>
    <p id="modal-text" class="muted"></p>
    <div id="modal-input-container"></div>
    <div id="modal-options-container"></div>
    <div id="modal-actions" class="modal-actions"></div>
  </div>
</div>
<div id="save-status">Zapisano zmiany</div>

<script>
  (function activateSidebarLink() {
    const currentPage = document.body.dataset.page;
    if (!currentPage) return;
    document.querySelectorAll('.sidebar__link[data-page]').forEach((link) => {
      if (link.dataset.page === currentPage) {
        link.classList.add('sidebar__link--active');
        link.setAttribute('aria-current', 'page');
      } else {
        link.classList.remove('sidebar__link--active');
        link.removeAttribute('aria-current');
      }
    });
  })();
</script>
<script>
const STORAGE_KEY = 'lifeos_trainings_month_v1';
const LEGACY_STORAGE_KEY = 'lifeos_trainings_v1';
const MIGRATION_FLAG_KEY = 'lifeos_trainings_migrated_to_month_v1';
const ACTIVITY_EMOJIS = {
    gym: '🏋️',
    running: '🏃',
    reading: '📚',
    extra: '✨',
    vacation: '🌴'
};
const GOAL_DEFINITIONS = {
  gym: { target: 3, unit: 'sesje', label: 'Trening siłowy', icon: 'dumbbell', color: 'var(--gym-color)', emoji: ACTIVITY_EMOJIS.gym },
  running: { target: 5, unit: 'km', label: 'Bieganie', icon: 'activity', color: 'var(--run-color)', emoji: ACTIVITY_EMOJIS.running },
  reading: { target: 100, unit: 'stron', label: 'Czytanie', icon: 'book-open', color: 'var(--read-color)', emoji: ACTIVITY_EMOJIS.reading }
};
const EXTRA_ACTIVITY_CATEGORIES = [
  { value: 'training', label: 'Trening / ruch' },
  { value: 'learning', label: 'Nauka / rozwój' },
  { value: 'relax', label: 'Regeneracja' },
  { value: 'home', label: 'Dom i organizacja' },
  { value: 'other', label: 'Inne' }
];
const EXTRA_CATEGORY_LABELS = EXTRA_ACTIVITY_CATEGORIES.reduce((acc, item) => {
  acc[item.value] = item.label;
  return acc;
}, {});

const DAY_MS = 24 * 60 * 60 * 1000;

const safeParse = (raw, fallbackFactory) => {
  const fallback = () => (typeof fallbackFactory === 'function' ? fallbackFactory() : fallbackFactory);
  if (!raw) return fallback();
  try {
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === 'object' ? parsed : fallback();
  } catch {
    return fallback();
  }
};

let state = { activities: {}, extras: {}, vacations: {}, predefinedExtras: [] };
let currentMonth = startOfMonth(new Date());
let selectedDate = toYYYYMMDD(new Date());
let planningMode = null;
let saveTimeout;

function startOfMonth(date) {
  return new Date(date.getFullYear(), date.getMonth(), 1);
}

function toYYYYMMDD(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function parseDate(dateString) {
  const [y, m, d] = dateString.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function formatMonth(date) {
  return date.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
}

function formatRange(start, end) {
  return `${start.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' })} – ${end.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' })}`;
}

function formatDateWithDay(date) {
  return date.toLocaleDateString('pl-PL', { weekday: 'long', day: '2-digit', month: 'long' });
}

function formatPlanningSummary(type, plannedValue) {
  const def = GOAL_DEFINITIONS[type];
  if (!def) return 'Nowy trening';
  if (type === 'gym') return def.label;
  const numeric = Number(plannedValue);
  if (!Number.isFinite(numeric) || numeric <= 0) return def.label;
  const valueLabel = `${numeric.toLocaleString('pl-PL')} ${def.unit}`;
  return `${def.label} · ${valueLabel}`;
}

function isPlanningActive() {
  return Boolean(planningMode && planningMode.active);
}

function startPlanningMode(type, plannedValue) {
  planningMode = {
    active: true,
    type,
    plannedValue: type === 'gym' ? 1 : Number(plannedValue) || 0
  };
  setTimeout(() => render(), 0);
}

function stopPlanningMode() {
  if (!isPlanningActive()) return;
  planningMode = null;
  setTimeout(() => render(), 0);
}

function addDays(date, days) {
  const copy = new Date(date);
  copy.setDate(copy.getDate() + days);
  return copy;
}

function startOfWeek(date) {
  const copy = new Date(date);
  const offset = (copy.getDay() + 6) % 7;
  copy.setDate(copy.getDate() - offset);
  copy.setHours(0, 0, 0, 0);
  return copy;
}

function ensureDay(dateString) {
  if (!state.activities[dateString]) state.activities[dateString] = [];
  if (!state.extras[dateString]) state.extras[dateString] = [];
}

function isVacationDay(dateString) {
  return Boolean(state.vacations && state.vacations[dateString]);
}

function toggleVacationDay(dateString) {
  if (!state.vacations) state.vacations = {};
  if (isVacationDay(dateString)) {
    delete state.vacations[dateString];
  } else {
    state.vacations[dateString] = true;
  }
  saveState();
  render();
}

function planVacationRange(startDateString, endDateString) {
  if (!startDateString || !endDateString) return;
  const start = parseDate(startDateString);
  const end = parseDate(endDateString);
  if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return;
  const normalizedStart = normalizeDate(start);
  const normalizedEnd = normalizeDate(end);
  if (normalizedEnd < normalizedStart) return;
  if (!state.vacations) state.vacations = {};
  const cursor = new Date(normalizedStart);
  let guard = 0;
  while (cursor.getTime() <= normalizedEnd.getTime() && guard < 370) {
    const key = toYYYYMMDD(cursor);
    state.vacations[key] = true;
    cursor.setDate(cursor.getDate() + 1);
    guard += 1;
  }
  saveState();
  render();
}

let dragPayload = null;

function enableDrag(element, payload) {
  if (!element) return;
  element.setAttribute('draggable', 'true');
  element.addEventListener('dragstart', event => {
    dragPayload = payload;
    element.classList.add('is-dragging');
    if (event.dataTransfer) {
      event.dataTransfer.effectAllowed = 'move';
      try {
        event.dataTransfer.setData('application/json', JSON.stringify(payload));
      } catch (error) {
        // ignore unsupported MIME
      }
    }
  });
  element.addEventListener('dragend', () => {
    dragPayload = null;
    element.classList.remove('is-dragging');
  });
}

function resolveDragPayload(event) {
  if (dragPayload) return dragPayload;
  if (!event || !event.dataTransfer) return null;
  try {
    const data = event.dataTransfer.getData('application/json');
    if (data) {
      return JSON.parse(data);
    }
  } catch (error) {
    return null;
  }
  return null;
}

function movePlannedItem(payload, targetDate) {
  if (!payload || !targetDate || payload.sourceDate === targetDate) return;
  ensureDay(payload.sourceDate);
  ensureDay(targetDate);
  let moved = false;
  if (payload.itemType === 'activity') {
    const sourceList = state.activities[payload.sourceDate] || [];
    const index = sourceList.findIndex(item => item.id === payload.id);
    if (index > -1) {
      const [item] = sourceList.splice(index, 1);
      state.activities[targetDate].push(item);
      moved = true;
    }
  } else if (payload.itemType === 'extra') {
    const sourceList = state.extras[payload.sourceDate] || [];
    const index = sourceList.findIndex(item => item.id === payload.id);
    if (index > -1) {
      const [item] = sourceList.splice(index, 1);
      state.extras[targetDate].push(item);
      moved = true;
    }
  }
  if (moved) {
    if (state.vacations && state.vacations[targetDate] && (state.activities[targetDate].length > 0 || state.extras[targetDate].length > 0)) {
      delete state.vacations[targetDate];
    }
    saveState();
    render();
  }
}

function sameMonth(date, reference) {
  return date.getFullYear() === reference.getFullYear() && date.getMonth() === reference.getMonth();
}

function normalizeDate(date) {
  const normalized = new Date(date);
  normalized.setHours(0, 0, 0, 0);
  return normalized;
}

function getISOWeekStart(year, week) {
  const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
  const day = simple.getUTCDay();
  const diff = (day === 0 ? -6 : 1) - day;
  simple.setUTCDate(simple.getUTCDate() + diff);
  return new Date(simple.getUTCFullYear(), simple.getUTCMonth(), simple.getUTCDate());
}

function getISOWeekInfo(date) {
  const target = new Date(date);
  target.setHours(0, 0, 0, 0);
  const dayNumber = (target.getDay() + 6) % 7;
  target.setDate(target.getDate() - dayNumber + 3);
  const isoYear = target.getFullYear();
  const firstWeekStart = getISOWeekStart(isoYear, 1);
  const diffDays = Math.round((target.getTime() - firstWeekStart.getTime()) / DAY_MS);
  const week = 1 + Math.floor(diffDays / 7);
  return { year: isoYear, week: Math.max(1, week) };
}

function loadState() {
  state = { activities: {}, extras: {}, vacations: {}, predefinedExtras: [] };
  planningMode = null;
  const parsed = safeParse(localStorage.getItem(STORAGE_KEY), () => ({}));
  if (parsed && typeof parsed === 'object') {
    state.activities = parsed.activities && typeof parsed.activities === 'object' ? parsed.activities : {};
    state.extras = parsed.extras && typeof parsed.extras === 'object' ? parsed.extras : {};
    state.vacations = parsed.vacations && typeof parsed.vacations === 'object' ? parsed.vacations : {};
    state.predefinedExtras = Array.isArray(parsed.predefinedExtras) ? parsed.predefinedExtras : [];
  }
  migrateLegacyState();
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  const status = document.getElementById('save-status');
  status.classList.add('visible');
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => status.classList.remove('visible'), 1600);
}

function migrateLegacyState() {
  try {
    if (localStorage.getItem(MIGRATION_FLAG_KEY)) return;
    const legacyRaw = localStorage.getItem(LEGACY_STORAGE_KEY);
    if (!legacyRaw) {
      localStorage.setItem(MIGRATION_FLAG_KEY, 'done_empty');
      return;
    };
    const legacyState = safeParse(legacyRaw, () => null);
    if (!legacyState || typeof legacyState !== 'object') {
      localStorage.setItem(MIGRATION_FLAG_KEY, 'done_invalid');
      return;
    }
    let imported = false;
    Object.keys(legacyState).forEach(yearKey => {
      const weeks = legacyState[yearKey];
      if (!weeks || typeof weeks !== 'object') return;
      Object.keys(weeks).forEach(weekKey => {
        const weekData = weeks[weekKey];
        if (!weekData || typeof weekData !== 'object') return;
        const year = Number(yearKey);
        const week = Number(weekKey);
        if (!Number.isFinite(year) || !Number.isFinite(week)) return;
        const weekStart = getISOWeekStart(year, week);
        if (Number.isNaN(weekStart.getTime())) return;

        const mapDayToDate = (dayIndex) => {
          const base = new Date(weekStart);
          const offset = dayIndex === 0 ? 6 : dayIndex - 1;
          base.setDate(weekStart.getDate() + offset);
          base.setHours(0, 0, 0, 0);
          return base;
        };

        const plan = weekData.plan && typeof weekData.plan === 'object' ? weekData.plan : {};
        Object.keys(plan).forEach(dayKey => {
          const dayIndex = Number(dayKey);
          if (!Number.isFinite(dayIndex)) return;
          const date = mapDayToDate(dayIndex);
          const dateString = toYYYYMMDD(date);
          ensureDay(dateString);
          const activities = Array.isArray(plan[dayKey]) ? plan[dayKey] : [];
          activities.forEach(activity => {
            if (!activity || !activity.type || !GOAL_DEFINITIONS[activity.type]) return;
            if (state.activities[dateString].some(item => item.id === activity.id)) return;
            const plannedValue = activity.type === 'gym' ? 1 : Number(activity.plannedValue) || 0;
            const loggedValue = activity.type === 'gym'
              ? (activity.completed ? 1 : 0)
              : Number(activity.loggedValue) || (activity.completed ? plannedValue : 0);
            state.activities[dateString].push({
              id: activity.id || `act_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              type: activity.type,
              plannedValue,
              loggedValue,
              completed: Boolean(activity.completed),
              createdAt: activity.createdAt || Date.now()
            });
            imported = true;
          });
        });

        const extras = weekData.extras && typeof weekData.extras === 'object' ? weekData.extras : {};
        Object.keys(extras).forEach(dayKey => {
          const dayIndex = Number(dayKey);
          if (!Number.isFinite(dayIndex)) return;
          const date = mapDayToDate(dayIndex);
          const dateString = toYYYYMMDD(date);
          ensureDay(dateString);
          const list = Array.isArray(extras[dayKey]) ? extras[dayKey] : [];
          list.forEach(extra => {
            if (!extra || !extra.title) return;
            if (state.extras[dateString].some(item => item.id === extra.id)) return;
            state.extras[dateString].push({
              id: extra.id || `extra_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              title: extra.title,
              category: extra.category || 'other',
              completed: Boolean(extra.completed),
              createdAt: extra.createdAt || Date.now()
            });
            imported = true;
          });
        });

      });
    });
    if (imported) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    localStorage.setItem(MIGRATION_FLAG_KEY, 'done');
  } catch (error) {
    console.error('Legacy trainings migration failed', error);
  }
}

function getCalendarDays(monthDate) {
  const start = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const offset = (start.getDay() + 6) % 7;
  start.setDate(start.getDate() - offset);
  const days = [];
  for (let i = 0; i < 42; i++) {
    const cell = new Date(start);
    cell.setDate(start.getDate() + i);
    days.push(cell);
  }
  return days;
}

function ensureSelectionInMonth() {
  const currentSelection = parseDate(selectedDate);
  if (!sameMonth(currentSelection, currentMonth)) {
    selectedDate = toYYYYMMDD(currentMonth);
  }
}

function calculateMonthlyStats(monthDate) {
  const firstDay = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const lastDay = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
  const totalDays = lastDay.getDate();
  const totals = { planned: 0, completed: 0 };
  const activeDays = new Set();
  const upcoming = [];
  const today = normalizeDate(new Date());

  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    if (!sameMonth(date, monthDate)) return;
    const normalized = normalizeDate(date);
    if (activities.length) activeDays.add(dateString);
    totals.planned += activities.length;
    activities.forEach(activity => {
      if (activity.completed) totals.completed += 1;
      else if (normalized >= today) {
        upcoming.push({ type: activity.type, date: normalized });
      }
    });
  });

  Object.entries(state.extras).forEach(([dateString, extras]) => {
    const date = parseDate(dateString);
    if (!sameMonth(date, monthDate)) return;
    const normalized = normalizeDate(date);
    if (extras.length) activeDays.add(dateString);
    totals.planned += extras.length;
    extras.forEach(extra => {
      if (extra.completed) totals.completed += 1;
      else if (normalized >= today) {
        upcoming.push({ type: 'extra', date: normalized });
      }
    });
  });

  upcoming.sort((a, b) => a.date - b.date);
  const next = upcoming[0];
  const nextActivity = next ? {
    type: next.type,
    relative: getRelativeLabel(next.date, today)
  } : null;

  return {
    plannedCount: totals.planned,
    completedCount: totals.completed,
    activeDays: activeDays.size,
    totalDays,
    nextActivity,
    range: { start: firstDay, end: lastDay }
  };
}

function calculateWeeklyGoalStats(referenceDate) {
  const base = referenceDate ? new Date(referenceDate) : new Date();
  const weekStart = startOfWeek(base);
  const weekEnd = addDays(weekStart, 6);
  const totals = { gym: 0, running: 0, reading: 0 };

  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    const normalized = normalizeDate(date);
    if (normalized < weekStart || normalized > weekEnd) return;
    activities.forEach(activity => {
      if (!activity || !GOAL_DEFINITIONS[activity.type] || !activity.completed) return;
      if (activity.type === 'gym') {
        totals.gym += 1;
      } else {
        const logged = Number(activity.loggedValue);
        const planned = Number(activity.plannedValue);
        const value = !Number.isNaN(logged) && logged > 0
          ? logged
          : (!Number.isNaN(planned) ? planned : 0);
        totals[activity.type] += value;
      }
    });
  });

  const goalPercents = {};
  Object.keys(GOAL_DEFINITIONS).forEach(type => {
    const progress = totals[type] || 0;
    const target = GOAL_DEFINITIONS[type].target;
    const percent = target > 0 ? Math.min(100, Math.round((progress / target) * 100)) : 0;
    goalPercents[type] = { percent, progress, target };
  });

  const averageGoalPercent = Math.round(
    Object.values(goalPercents).reduce((acc, info) => acc + info.percent, 0) /
    Object.keys(GOAL_DEFINITIONS).length
  ) || 0;

  return { goalPercents, averageGoalPercent, range: { start: weekStart, end: weekEnd } };
}

function calculateWeekCompletionToDate() {
  const today = normalizeDate(new Date());
  const info = getISOWeekInfo(today);
  const totalWeeks = Math.max(0, info.week - 1);
  let completedWeeks = 0;

  for (let week = 1; week < info.week; week++) {
    const weekStart = getISOWeekStart(info.year, week);
    const stats = calculateWeeklyGoalStats(weekStart);
    const goals = Object.values(stats.goalPercents || {});
    if (goals.length && goals.every(goal => Number(goal.percent || 0) >= 100)) {
      completedWeeks += 1;
    }
  }

  const percent = totalWeeks > 0 ? Math.round((completedWeeks / totalWeeks) * 100) : 0;
  return { completedWeeks, totalWeeks, percent, currentWeek: info.week, isoYear: info.year };
}

function getRelativeLabel(targetDate, today) {
  const diff = Math.round((targetDate.getTime() - today.getTime()) / DAY_MS);
  if (diff === 0) return 'Dziś';
  if (diff === 1) return 'Jutro';
  if (diff > 1 && diff < 7) return `Za ${diff} dni`;
  return targetDate.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' });
}

function render() {
  ensureSelectionInMonth();
  const monthStats = calculateMonthlyStats(currentMonth);
  const weekStats = calculateWeeklyGoalStats(parseDate(selectedDate));
  const yearStats = calculateWeekCompletionToDate();
  renderHeader(monthStats, weekStats, yearStats);
  renderCalendar();
  renderDayDetail();
  renderGoalProgress(weekStats.goalPercents);
  renderHeatmap();
  renderPlanningIndicator();
  lucide.createIcons();
}

function renderHeader(monthStats, weekStats, yearStats) {
  const monthLabel = formatMonth(currentMonth);
  document.getElementById('header-month-chip').textContent = monthLabel;
  document.getElementById('current-month-label').textContent = monthLabel;
  document.getElementById('current-month-range').textContent = `${formatRange(monthStats.range.start, monthStats.range.end)} ${currentMonth.getFullYear()}`;
  document.getElementById('today-month-btn').style.display = sameMonth(new Date(), currentMonth) ? 'none' : 'inline-flex';
  
  const weeklyRange = weekStats?.range ? formatRange(weekStats.range.start, weekStats.range.end) : '--';
  document.getElementById('metric-weekly-complete-percent').textContent = `${weekStats.averageGoalPercent}%`;
  document.getElementById('metric-weekly-complete-sub').innerHTML = `<span class="metric-subline">Cele tygodniowe</span><span class="metric-subline">${weeklyRange}</span>`;
  document.getElementById('metric-active-days').textContent = `${monthStats.activeDays}/${monthStats.totalDays}`;
  const activeDaysNote = document.getElementById('metric-active-days-note');
  if (monthStats.totalDays) {
    const activePercent = Math.round((monthStats.activeDays / monthStats.totalDays) * 100);
    activeDaysNote.textContent = `${activePercent}% dni z aktywnością`;
  } else {
    activeDaysNote.textContent = 'Brak danych dla miesiąca';
  }

  const weeksCountEl = document.getElementById('metric-weekly-complete-count');
  const weeksCountNote = document.getElementById('metric-weekly-count-note');
  if (yearStats) {
    weeksCountEl.textContent = `${yearStats.completedWeeks}/${yearStats.totalWeeks}`;
    weeksCountNote.textContent = `${yearStats.percent}% tygodni roku ukończonych`;
  } else {
    weeksCountEl.textContent = '0/0';
    weeksCountNote.textContent = 'Brak danych rocznych';
  }

  const nextCard = document.getElementById('metric-next-activity-card');
  const nextDate = document.getElementById('metric-next-activity-date');
  const nextEmoji = nextCard.querySelector('.kpi-emoji');
  const nextNote = document.getElementById('metric-next-activity-note');
  if (monthStats.nextActivity) {
      nextDate.textContent = monthStats.nextActivity.relative || 'Najbliższe dni';
      nextEmoji.textContent = ACTIVITY_EMOJIS[monthStats.nextActivity.type] || '🎯';
      nextNote.textContent = 'Najbliższy termin w kalendarzu';
  } else {
      nextDate.textContent = 'Brak terminu';
      nextEmoji.textContent = '🗓️';
      nextNote.textContent = 'Zaplanuj kolejny ruch';
  }
}

function renderCalendar() {
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  const today = normalizeDate(new Date());
  const days = getCalendarDays(currentMonth);
  
  days.forEach(date => {
    const dateString = toYYYYMMDD(date);
    ensureDay(dateString);
    const activities = state.activities[dateString] || [];
    const extras = state.extras[dateString] || [];
    const vacationDay = isVacationDay(dateString);
    const isCurrentMonth = sameMonth(date, currentMonth);
    const plannedCount = activities.length + extras.length;
    const completedCount = activities.filter(a => a.completed).length + extras.filter(e => e.completed).length;
    const isPast = normalizeDate(date) < today;

    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    cell.dataset.date = dateString;
    if (!isCurrentMonth) cell.classList.add('is-other-month');
    if (dateString === selectedDate) cell.classList.add('is-selected');
    if (normalizeDate(date).getTime() === today.getTime()) cell.classList.add('is-today');
    
    if (vacationDay) {
      cell.classList.add('is-vacation');
    } else if (plannedCount > 0) {
      if (completedCount === plannedCount) {
        cell.classList.add('is-completed');
      } else if (isPast) {
        cell.classList.add('is-missed');
      } else {
        cell.classList.add('is-planned');
      }
    } else if (isPast) {
        cell.classList.add('is-missed');
    }

    const number = document.createElement('span');
    number.className = 'calendar-date-number';
    number.textContent = date.getDate();
    cell.appendChild(number);

    const emojisContainer = document.createElement('div');
    emojisContainer.className = 'calendar-day-emojis';
    if (vacationDay) {
      const emojiSpan = document.createElement('span');
      emojiSpan.className = 'activity-emoji';
      emojiSpan.title = 'Urlop';
      emojiSpan.textContent = ACTIVITY_EMOJIS.vacation;
      emojisContainer.appendChild(emojiSpan);
    }
    activities.forEach(a => {
      const emojiSpan = document.createElement('span');
      emojiSpan.className = `activity-emoji ${a.completed ? 'completed' : ''}`;
      emojiSpan.title = GOAL_DEFINITIONS[a.type].label;
      emojiSpan.textContent = GOAL_DEFINITIONS[a.type].emoji;
      enableDrag(emojiSpan, { itemType: 'activity', id: a.id, sourceDate: dateString });
      emojisContainer.appendChild(emojiSpan);
    });
    extras.forEach(e => {
      const emojiSpan = document.createElement('span');
      emojiSpan.className = `activity-emoji ${e.completed ? 'completed' : ''}`;
      emojiSpan.title = e.title;
      emojiSpan.textContent = e.emoji || ACTIVITY_EMOJIS.extra;
      enableDrag(emojiSpan, { itemType: 'extra', id: e.id, sourceDate: dateString });
      emojisContainer.appendChild(emojiSpan);
    });
    cell.appendChild(emojisContainer);

    const footer = document.createElement('div');
    footer.className = 'calendar-day-footer';
    if(plannedCount > 0 && !vacationDay){
        const badge = document.createElement('span');
        badge.className = 'completion-badge';
        badge.textContent = `${completedCount}/${plannedCount}`;
        if (completedCount >= plannedCount) badge.classList.add('is-done');
        else if (completedCount > 0) badge.classList.add('in-progress');
        footer.appendChild(badge);
    }
    cell.appendChild(footer);

    const handleDragTarget = (event) => {
      const payload = resolveDragPayload(event);
      if (!payload || payload.sourceDate === dateString) return;
      event.preventDefault();
      cell.classList.add('is-drag-over');
      if (event.dataTransfer) event.dataTransfer.dropEffect = 'move';
    };

    cell.addEventListener('dragover', handleDragTarget);
    cell.addEventListener('dragenter', handleDragTarget);
    cell.addEventListener('dragleave', (event) => {
      if (event.relatedTarget && cell.contains(event.relatedTarget)) return;
      cell.classList.remove('is-drag-over');
    });
    cell.addEventListener('drop', (event) => {
      event.preventDefault();
      cell.classList.remove('is-drag-over');
      const payload = resolveDragPayload(event);
      if (!payload || payload.sourceDate === dateString) return;
      movePlannedItem(payload, dateString);
    });

    cell.addEventListener('click', () => {
      selectedDate = dateString;
      if (!isCurrentMonth) {
        currentMonth = startOfMonth(date);
      }
      if (isPlanningActive()) {
        addTraining(dateString, planningMode.type, planningMode.plannedValue);
        return;
      }
      render();
    });

    grid.appendChild(cell);
  });
}

function renderPlanningIndicator() {
  const banner = document.getElementById('planning-banner');
  const title = document.getElementById('planning-banner-title');
  const meta = document.getElementById('planning-banner-meta');
  const grid = document.getElementById('calendar-grid');
  
  if (isPlanningActive()) {
    const summary = formatPlanningSummary(planningMode.type, planningMode.plannedValue);
    banner.classList.add('is-active');
    title.textContent = summary;
    meta.textContent = 'Klikaj dni, by dodać ten trening.';
    grid.classList.add('is-planning');
  } else {
    banner.classList.remove('is-active');
    title.textContent = 'Tryb planowania';
    grid.classList.remove('is-planning');
  }
}

function renderDayDetail() {
  const container = document.getElementById('day-detail-container');
  if (!selectedDate) {
    container.innerHTML = `<div class="day-detail-placeholder">
      <i data-lucide="calendar-days" class="icon"></i>
      <strong>Wybierz dzień</strong>
      <p class="muted tiny">Kliknij w datę na kalendarzu, aby zobaczyć szczegóły i zarządzać planem.</p>
    </div>`;
    lucide.createIcons();
    return;
  }
  ensureDay(selectedDate);
  const date = parseDate(selectedDate);
  const activities = state.activities[selectedDate] || [];
  const extras = state.extras[selectedDate] || [];
  const vacationDay = isVacationDay(selectedDate);
  
  container.innerHTML = `
    <div class="day-detail">
      <div class="day-detail-header">
        <div class="day-detail-title">
          <h3 id="selected-day-title">${formatDateWithDay(date)}</h3>
          <p id="selected-day-summary"></p>
        </div>
        <div class="day-detail-meta">
          <button id="plan-vacation-range-btn" class="btn ghost small" title="Zaplanuj dłuższy urlop"><i data-lucide="calendar-plus" class="icon"></i></button>
          <button id="toggle-vacation-btn" class="btn ghost small" title="${vacationDay ? 'Usuń urlop' : 'Oznacz jako urlop'}">
            <i data-lucide="${vacationDay ? 'sun' : 'plane'}" class="icon"></i>
          </button>
        </div>
      </div>
      <div class="day-detail-body">
        ${vacationDay ? `
          <div id="vacation-note" class="vacation-note">
            <i data-lucide="plane" class="icon"></i>
            <span>Dzień oznaczony jako urlop — bez oczekiwań treningowych.</span>
          </div>` : ''}

        <div class="detail-block">
          <h4 class="detail-block-header">Plan treningowy</h4>
          <div id="day-plan-list" class="detail-list"></div>
        </div>
        <div class="detail-block">
          <h4 class="detail-block-header">Szybkie Akcje
            <button id="manage-predefined-btn" class="btn ghost" style="padding: 2px 6px; font-size: 10px; height: auto;">Zarządzaj</button>
          </h4>
          <div id="quick-add-list" class="quick-add-list"></div>
        </div>
        <div class="detail-block">
          <h4 class="detail-block-header">Aktywności dodatkowe</h4>
          <div id="day-extra-list" class="detail-list"></div>
        </div>
      </div>
      <div class="day-detail-actions">
        <button id="add-training-btn" class="btn"><i data-lucide="plus" class="icon"></i>Zaplanuj trening</button>
        <button id="add-extra-btn" class="btn soft"><i data-lucide="sparkles" class="icon"></i>Dodaj aktywność</button>
      </div>
    </div>`;

  renderDayActivities(activities);
  renderDayExtras(extras);
  renderQuickAddButtons();
  updateDaySummary();

  document.getElementById('add-training-btn').addEventListener('click', showAddTrainingModal);
  document.getElementById('add-extra-btn').addEventListener('click', showAddExtraModal);
  document.getElementById('toggle-vacation-btn').addEventListener('click', () => toggleVacationDay(selectedDate));
  document.getElementById('plan-vacation-range-btn').addEventListener('click', showVacationRangeModal);
  document.getElementById('manage-predefined-btn').addEventListener('click', showManagePredefinedExtrasModal);
  lucide.createIcons();
}

function updateDaySummary(){
    const activities = state.activities[selectedDate] || [];
    const extras = state.extras[selectedDate] || [];
    const vacationDay = isVacationDay(selectedDate);
    const completedCount = activities.filter(a => a.completed).length + extras.filter(e => e.completed).length;
    const total = activities.length + extras.length;
    
    const summaryEl = document.getElementById('selected-day-summary');
    if(!summaryEl) return;

    if (vacationDay) {
      summaryEl.textContent = total > 0 ? `Urlop · ${completedCount}/${total} ukończone` : 'Dzień urlopowy';
    } else {
      summaryEl.textContent = total > 0 ? `${completedCount}/${total} ukończone` : 'Brak planów';
    }
}

function renderDayActivities(activities) {
  const list = document.getElementById('day-plan-list');
  list.innerHTML = '';
  if (!activities.length) {
    list.innerHTML = `<p class="muted tiny" style="padding: 0 4px;">Brak zaplanowanych treningów.</p>`;
    return;
  }
  
  activities.forEach(activity => {
    const goal = GOAL_DEFINITIONS[activity.type];
    const item = document.createElement('div');
    item.className = `detail-item ${activity.completed ? 'is-completed' : ''}`;
    
    const plannedInfo = activity.type === 'gym' ? '' : (activity.plannedValue ? `Plan: ${Number(activity.plannedValue).toLocaleString('pl-PL')} ${goal.unit}` : '');
    let progressInfo = '';
    if (activity.completed) {
      if (activity.type === 'gym') progressInfo = 'Ukończono';
      else progressInfo = `Wynik: ${Number(activity.loggedValue).toLocaleString('pl-PL')} ${goal.unit}`;
    }
    const metaText = [plannedInfo, progressInfo].filter(Boolean).join(' · ');

    item.innerHTML = `
      <div class="detail-info">
        <div class="detail-icon ${activity.type}">${goal.emoji}</div>
        <div class="detail-text">
          <div class="detail-title">${goal.label}</div>
          <div class="detail-meta">${metaText}</div>
        </div>
      </div>
      <div class="detail-actions-inline">
        ${activity.completed 
          ? `<button class="action-btn" title="Cofnij ukończenie" data-action="undo-activity"><i data-lucide="rotate-ccw" class="icon"></i></button>` 
          : `<button class="action-btn success" title="Oznacz jako wykonane" data-action="complete-activity"><i data-lucide="check" class="icon"></i></button>`}
        ${activity.type !== 'gym' ? `<button class="action-btn" title="Edytuj wynik" data-action="edit-activity"><i data-lucide="edit-3" class="icon"></i></button>` : ''}
        <button class="action-btn danger" title="Usuń" data-action="delete-activity"><i data-lucide="trash-2" class="icon"></i></button>
      </div>
    `;
    item.querySelector('[data-action="complete-activity"]')?.addEventListener('click', () => completeActivity(selectedDate, activity.id));
    item.querySelector('[data-action="undo-activity"]')?.addEventListener('click', () => undoActivity(selectedDate, activity.id));
    item.querySelector('[data-action="edit-activity"]')?.addEventListener('click', () => editActivity(selectedDate, activity.id));
    item.querySelector('[data-action="delete-activity"]')?.addEventListener('click', () => deleteActivity(selectedDate, activity.id));

    enableDrag(item, { itemType: 'activity', id: activity.id, sourceDate: selectedDate });
    list.appendChild(item);
  });
  lucide.createIcons();
}

function renderDayExtras(extras) {
  const list = document.getElementById('day-extra-list');
  list.innerHTML = '';
  if (!extras.length) {
    list.innerHTML = `<p class="muted tiny" style="padding: 0 4px;">Brak dodatkowych aktywności.</p>`;
    return;
  }
  
  extras.forEach(extra => {
    const item = document.createElement('div');
    item.className = `detail-item ${extra.completed ? 'is-completed' : ''}`;
    item.innerHTML = `
      <div class="detail-info">
        <div class="detail-icon extra">${extra.emoji || ACTIVITY_EMOJIS.extra}</div>
        <div class="detail-text">
          <div class="detail-title">${extra.title}</div>
          <div class="detail-meta">${EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność'}</div>
        </div>
      </div>
      <div class="detail-actions-inline">
        <button class="action-btn ${extra.completed ? '' : 'success'}" title="${extra.completed ? 'Cofnij' : 'Zakończ'}" data-action="toggle-extra">
            <i data-lucide="${extra.completed ? 'rotate-ccw' : 'check'}" class="icon"></i>
        </button>
        <button class="action-btn danger" title="Usuń" data-action="delete-extra"><i data-lucide="trash-2" class="icon"></i></button>
      </div>
    `;
    item.querySelector('[data-action="toggle-extra"]')?.addEventListener('click', () => toggleExtra(selectedDate, extra.id));
    item.querySelector('[data-action="delete-extra"]')?.addEventListener('click', () => deleteExtra(selectedDate, extra.id));

    enableDrag(item, { itemType: 'extra', id: extra.id, sourceDate: selectedDate });
    list.appendChild(item);
  });
  lucide.createIcons();
}

function renderQuickAddButtons() {
    const container = document.getElementById('quick-add-list');
    container.innerHTML = '';
    if (!state.predefinedExtras || state.predefinedExtras.length === 0) {
        container.innerHTML = `<p class="muted tiny" style="padding: 0 4px;">Brak szablonów. Dodaj nową aktywność i zaznacz opcję, by ją zapisać.</p>`;
        return;
    }

    state.predefinedExtras.forEach(extra => {
        const btn = document.createElement('button');
        btn.className = 'quick-add-btn';
        btn.textContent = `${extra.emoji || ''} ${extra.title}`.trim();
        btn.title = `Dodaj "${extra.title}"`;
        btn.addEventListener('click', () => {
            addExtra(selectedDate, extra.title, extra.category, extra.emoji);
        });
        container.appendChild(btn);
    });
}


function renderGoalProgress(goalPercents) {
  const container = document.getElementById('goal-progress-list');
  if (!container) return;
  container.innerHTML = '';
  if (!goalPercents) return;
  
  Object.entries(goalPercents).forEach(([type, info]) => {
    const def = GOAL_DEFINITIONS[type];
    if (!def) return;
    const item = document.createElement('div');
    item.className = 'goal-progress-item';

    const progressValue = Number(info.progress || 0).toLocaleString('pl-PL');
    const targetValue = Number((info && info.target) || def.target || 0).toLocaleString('pl-PL');

    item.innerHTML = `
      <div class="goal-progress-header">
        <span class="goal-progress-label">${def.emoji} ${def.label}</span>
        <span class="goal-progress-meta">${progressValue} / ${targetValue} ${def.unit}</span>
      </div>
      <div class="kpi-progress-bar">
        <div class="kpi-progress-fill" style="width: ${info.percent}%; background-color: ${def.color};"></div>
      </div>
    `;
    container.appendChild(item);
  });
}

function getHeatLevel(value) {
  if (value >= 5) return 4;
  if (value >= 3) return 3;
  if (value >= 2) return 2;
  if (value >= 1) return 1;
  return 0;
}

function renderHeatmap() {
  const container = document.getElementById('heatmap');
  container.innerHTML = '';
  const year = currentMonth.getFullYear();
  document.getElementById('heatmap-year-label').textContent = year;
  const counts = {};
  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    if (date.getFullYear() !== year) return;
    const completed = activities.filter(a => a.completed).length;
    if (completed > 0) counts[dateString] = (counts[dateString] || 0) + completed;
  });
  Object.entries(state.extras).forEach(([dateString, extras]) => {
    const date = parseDate(dateString);
    if (date.getFullYear() !== year) return;
    const completed = extras.filter(e => e.completed).length;
    if (completed > 0) counts[dateString] = (counts[dateString] || 0) + completed;
  });

  const start = new Date(year, 0, 1);
  const offset = (start.getDay() + 6) % 7;
  start.setDate(start.getDate() - offset);

  for (let week = 0; week < 53; week++) {
    const weekStart = addDays(start, week * 7);
    if (weekStart.getFullYear() > year && weekStart.getMonth() > 0) break;

    const column = document.createElement('div');
    column.className = 'heatmap-week';
    let monthLabel = '';
    
    // Check if this week contains the end of a month
    for (let day = 0; day < 7; day++) {
        const current = addDays(weekStart, day);
        const next = addDays(current, 1);
        if (current.getMonth() !== next.getMonth() && current.getFullYear() === year) {
            column.style.marginRight = '8px'; // Add wider gap
            const monthDate = new Date(year, current.getMonth(), 1);
            monthLabel = monthDate.toLocaleDateString('pl-PL', { month: 'short' }).replace('.', '').toUpperCase();
            break; // Found the end of the month, no need to check further
        }
    }

    // Create day cells
    for (let day = 0; day < 7; day++) {
      const current = addDays(weekStart, day);
      const key = toYYYYMMDD(current);
      const cell = document.createElement('div');
      cell.className = 'heatmap-cell';
      if (current.getFullYear() === year) {
        const value = counts[key] || 0;
        const level = getHeatLevel(value);
        cell.dataset.level = level;
        const labelText = current.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' });
        cell.title = value > 0 ? `${labelText}: ${value} ukończone aktywności` : labelText;
      } else {
        cell.classList.add('heatmap-cell--empty');
      }
      column.appendChild(cell);
    }
    
    const label = document.createElement('span');
    label.className = 'heatmap-month-label';
    label.textContent = monthLabel;
    column.appendChild(label);
    
    container.appendChild(column);
  }
}


function addTraining(dateString, type, plannedValue) {
  ensureDay(dateString);
  state.activities[dateString].push({
    id: `act_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    type,
    plannedValue: type === 'gym' ? 1 : Number(plannedValue) || 0,
    loggedValue: 0,
    completed: false,
    createdAt: Date.now()
  });
  if (state.vacations && state.vacations[dateString]) delete state.vacations[dateString];
  saveState();
  render();
}

function addExtra(dateString, title, category, emoji) {
  ensureDay(dateString);
  state.extras[dateString].push({
    id: `extra_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    title,
    category,
    emoji: emoji || ACTIVITY_EMOJIS.extra,
    completed: false,
    createdAt: Date.now()
  });
  if (state.vacations && state.vacations[dateString]) delete state.vacations[dateString];
  saveState();
  render();
}

function completeActivity(day, id) {
  const activities = state.activities[day] || [];
  const activity = activities.find(a => a.id === id);
  if (!activity) return;
  if (activity.type === 'gym') {
    activity.completed = true;
    activity.loggedValue = 1;
    saveState();
    render();
  } else {
    showLogModal(activity, day);
  }
}

function showLogModal(activity, day) {
  const goal = GOAL_DEFINITIONS[activity.type];
  showModal({
    title: `Zaloguj ${goal.label.toLowerCase()}`,
    text: `Podaj zrealizowaną wartość dla ${formatDateWithDay(parseDate(day))}.`,
    input: { type: 'number', value: activity.loggedValue || activity.plannedValue || '', placeholder: `Wartość w ${goal.unit}`, min: '0', step: '1' },
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Zapisz', class: 'btn', action: (value) => {
          const numeric = Number(value);
          if (Number.isNaN(numeric) || numeric < 0) return false;
          activity.loggedValue = numeric;
          activity.completed = true;
          saveState();
          render();
        } }
    ]
  });
}

function editActivity(day, id) {
  const activity = (state.activities[day] || []).find(a => a.id === id);
  if (!activity || activity.type === 'gym') return;
  showLogModal(activity, day);
}

function undoActivity(day, id) {
  const activity = (state.activities[day] || []).find(a => a.id === id);
  if (!activity) return;
  activity.completed = false;
  activity.loggedValue = 0;
  saveState();
  render();
}

function deleteActivity(day, id) {
  if (!state.activities[day]) return;
  state.activities[day] = state.activities[day].filter(a => a.id !== id);
  saveState();
  render();
}

function toggleExtra(day, id) {
  const extra = (state.extras[day] || []).find(e => e.id === id);
  if (!extra) return;
  extra.completed = !extra.completed;
  saveState();
  render();
}

function deleteExtra(day, id) {
  if (!state.extras[day]) return;
  state.extras[day] = state.extras[day].filter(e => e.id !== id);
  saveState();
  render();
}

function showAddTrainingModal() {
  const date = parseDate(selectedDate);
  showModal({
    title: 'Zaplanuj trening',
    text: `Dodaj aktywność na ${date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' })}.`,
    input: { type: 'number', placeholder: 'Docelowa wartość', min: '0', step: '1' },
    options: [
      { value: 'gym', label: '🏋️ Trening siłowy', checked: true },
      { value: 'running', label: '🏃 Bieganie' },
      { value: 'reading', label: '📚 Czytanie' }
    ],
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Planowanie wielu dni', class: 'btn ghost', action: (value, selected) => {
          const type = selected || 'gym';
          if (type !== 'gym') {
            const numeric = Number(value);
            if (!numeric || numeric <= 0) return false;
            startPlanningMode(type, numeric);
          } else {
            startPlanningMode(type, 1);
          }
        } },
      { text: 'Dodaj na dziś', class: 'btn', action: (value, selected) => {
          const type = selected || 'gym';
          if (type !== 'gym') {
            const numeric = Number(value);
            if (!numeric || numeric <= 0) return false;
            addTraining(selectedDate, type, numeric);
          } else {
            addTraining(selectedDate, type, 1);
          }
        } }
    ],
    onShow: ({ overlay, input }) => {
      const radios = overlay.querySelectorAll('input[name="modal-option"]');
      const update = () => {
        const type = overlay.querySelector('input[name="modal-option"]:checked')?.value;
        if (!input) return;
        if (type === 'gym') {
          input.value = '';
          input.placeholder = 'Sesja siłowa – bez dodatkowej wartości';
          input.disabled = true;
        } else if (type === 'running') {
          input.disabled = false;
          input.placeholder = 'Cel w kilometrach';
        } else if (type === 'reading') {
          input.disabled = false;
          input.placeholder = 'Cel w stronach';
        }
      };
      update();
      radios.forEach(radio => radio.addEventListener('change', update));
    }
  });
}

function showAddExtraModal() {
  const date = parseDate(selectedDate);
  showModal({
    title: 'Dodaj aktywność dodatkową',
    text: `Dodaj drobne działanie na ${date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' })}.`,
    inputs: [
        { type: 'text', placeholder: 'Opis aktywności', key: 'title', required: true },
        { type: 'text', placeholder: 'Emoji (np. ✨)', key: 'emoji', maxLength: 2 }
    ],
    options: EXTRA_ACTIVITY_CATEGORIES.map((cat, index) => ({ value: cat.value, label: cat.label, checked: index === 0 })),
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { 
        text: 'Dodaj i zapisz szablon', 
        class: 'btn ghost', 
        action: (value, selected) => {
            const textValue = (value.title || '').trim();
            if (!textValue) return false;
            const newExtra = {
                id: `pre_${Date.now()}_${Math.random().toString(16).slice(2)}`,
                title: textValue,
                category: selected || 'other',
                emoji: value.emoji || ACTIVITY_EMOJIS.extra
            };
            if (!state.predefinedExtras.find(p => p.title === newExtra.title)) {
                state.predefinedExtras.push(newExtra);
            }
            addExtra(selectedDate, newExtra.title, newExtra.category, newExtra.emoji);
        }
      },
      { text: 'Dodaj', class: 'btn', action: (value, selected) => {
          const textValue = (value.title || '').trim();
          if (!textValue) return false;
          addExtra(selectedDate, textValue, selected || 'other', value.emoji);
        } }
    ]
  });
}

function showManagePredefinedExtrasModal() {
    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.gap = '8px';

    state.predefinedExtras.forEach(extra => {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.justifyContent = 'space-between';
        item.style.alignItems = 'center';
        item.style.padding = '8px';
        item.style.borderRadius = '8px';
        item.style.background = '#f8fafc';
        item.innerHTML = `<span>${extra.emoji || ''} ${extra.title}</span>`;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn ghost';
        deleteBtn.innerHTML = `<i data-lucide="trash-2" class="icon"></i>`;
        deleteBtn.style.padding = '4px';
        deleteBtn.style.height = 'auto';
        deleteBtn.onclick = () => {
            state.predefinedExtras = state.predefinedExtras.filter(p => p.id !== extra.id);
            saveState();
            // Re-render modal content
            const newContainer = showManagePredefinedExtrasModal();
            const modalInput = document.getElementById('modal-input-container');
            modalInput.innerHTML = '';
            modalInput.appendChild(newContainer);
            lucide.createIcons();
        };
        item.appendChild(deleteBtn);
        container.appendChild(item);
    });

    if (state.predefinedExtras.length === 0) {
        container.innerHTML = `<p class="muted tiny">Brak zapisanych szablonów.</p>`;
    }

    showModal({
        title: 'Zarządzaj szablonami',
        text: 'Usuń szablony, których już nie potrzebujesz.',
        customHTML: container,
        buttons: [
            { text: 'Zamknij', class: 'btn', action: 'close' }
        ],
        onShow: () => {
          lucide.createIcons();
        }
    });
    return container;
}

function showVacationRangeModal() {
  showModal({
    title: 'Plan urlopu',
    text: 'Oznacz cały zakres dat jako urlop, aby kalendarz uwzględnił przerwę.',
    inputs: [
      { type: 'date', value: selectedDate, label: 'Początek urlopu', key: 'start' },
      { type: 'date', value: selectedDate, label: 'Koniec urlopu', key: 'end' }
    ],
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Zapisz', class: 'btn', action: (value) => {
          if (!value || !value.start || !value.end) return false;
          if (value.end < value.start) return false;
          planVacationRange(value.start, value.end);
        } }
    ],
    onShow: ({ inputs }) => {
      if (!inputs || inputs.length < 2) return;
      const [startField, endField] = inputs;
      if (!startField || !endField) return;
      endField.min = startField.value;
      startField.addEventListener('change', () => {
        if (endField.value < startField.value) {
          endField.value = startField.value;
        }
        endField.min = startField.value;
      });
    }
  });
}

function showModal(config) {
  const overlay = document.getElementById('modal-overlay');
  document.getElementById('modal-title').textContent = config.title || '';
  document.getElementById('modal-text').innerHTML = config.text || '';
  const inputContainer = document.getElementById('modal-input-container');
  const optionsContainer = document.getElementById('modal-options-container');
  const actions = document.getElementById('modal-actions');
  inputContainer.innerHTML = '';
  optionsContainer.innerHTML = '';
  actions.innerHTML = '';

  if (config.customHTML) {
    inputContainer.appendChild(config.customHTML);
  }

  const inputConfigs = [];
  if (Array.isArray(config.inputs)) inputConfigs.push(...config.inputs);
  if (config.input) inputConfigs.push(config.input);

  inputConfigs.forEach(inputConfig => {
    const wrapper = document.createElement('div');
    wrapper.className = 'modal-field';
    if (inputConfig.label) {
      const label = document.createElement('span');
      label.className = 'modal-field-label';
      label.textContent = inputConfig.label;
      wrapper.appendChild(label);
    }
    const input = document.createElement('input');
    input.type = inputConfig.type || 'text';
    if (inputConfig.placeholder) input.placeholder = inputConfig.placeholder;
    if (inputConfig.value !== undefined) input.value = inputConfig.value;
    if (inputConfig.min !== undefined) input.min = inputConfig.min;
    if (inputConfig.max !== undefined) input.max = inputConfig.max;
    if (inputConfig.step !== undefined) input.step = inputConfig.step;
    if (inputConfig.maxLength !== undefined) input.maxLength = inputConfig.maxLength;
    if (inputConfig.required) input.required = true;
    input.autocomplete = 'off';
    input.dataset.modalInput = 'true';
    if (inputConfig.key) input.dataset.modalKey = inputConfig.key;
    if (inputConfig.name) input.name = inputConfig.name;
    wrapper.appendChild(input);
    inputContainer.appendChild(wrapper);
  });

  if (config.textarea) {
    const wrapper = document.createElement('div');
    wrapper.className = 'modal-field';
    const textarea = document.createElement('textarea');
    textarea.placeholder = config.textarea.placeholder || '';
    textarea.value = config.textarea.value || '';
    textarea.rows = config.textarea.rows || 4;
    textarea.autocomplete = 'off';
    textarea.dataset.modalInput = 'true';
    wrapper.appendChild(textarea);
    inputContainer.appendChild(wrapper);
  }

  if (config.options) {
    const optionsDiv = document.createElement('div');
    optionsDiv.className = 'modal-options';
    config.options.forEach(opt => {
      const label = document.createElement('label');
      label.className = 'option-label';
      label.innerHTML = `<input type="radio" name="modal-option" value="${opt.value}" ${opt.checked ? 'checked' : ''}> <span>${opt.label}</span>`;
      optionsDiv.appendChild(label);
    });
    optionsContainer.appendChild(optionsDiv);
  }

  config.buttons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.text;
    button.className = btn.class;
    button.addEventListener('click', () => {
      if (btn.action === 'close') {
        overlay.classList.remove('visible');
        render(); // Re-render to reflect changes if modal was for management
        return;
      }
      const fields = Array.from(inputContainer.querySelectorAll('[data-modal-input]'));
      const selectedOption = optionsContainer.querySelector('input[name="modal-option"]:checked')?.value;
      let value = '';
      if (fields.length === 1) {
        value = fields[0].value;
      } else if (fields.length > 1) {
        value = {};
        fields.forEach((field, index) => {
          const key = field.dataset.modalKey || field.name || `field${index + 1}`;
          value[key] = field.value;
        });
      }
      const result = btn.action(value, selectedOption);
      if (result === false) return;
      overlay.classList.remove('visible');
    });
    actions.appendChild(button);
  });

  overlay.classList.add('visible');
  if (typeof config.onShow === 'function') {
    const inputs = Array.from(inputContainer.querySelectorAll('[data-modal-input]'));
    config.onShow({ overlay, input: inputs[0] || null, inputs, optionsContainer, inputContainer });
  }
  const focusTarget = inputContainer.querySelector('[data-modal-input]');
  if (focusTarget && !focusTarget.disabled) focusTarget.focus();
}

function setupEventListeners() {
  document.getElementById('prev-month-btn').addEventListener('click', () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
    render();
  });
  document.getElementById('next-month-btn').addEventListener('click', () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
    render();
  });
  document.getElementById('today-month-btn').addEventListener('click', () => {
    const today = new Date();
    currentMonth = startOfMonth(today);
    selectedDate = toYYYYMMDD(today);
    render();
  });
  
  document.getElementById('stop-planning-btn').addEventListener('click', () => stopPlanningMode());

  document.getElementById('modal-overlay').addEventListener('click', (event) => {
    if (event.target === event.currentTarget) {
      event.currentTarget.classList.remove('visible');
      render(); // Re-render in case a management modal was closed
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  loadState();
  ensureDay(selectedDate);
  render();
  setupEventListeners();
});
</script>
</body>
</html>

