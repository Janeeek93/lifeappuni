<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS – Trainings</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
:root {
  --bg-alt: var(--surface);
  --primary: var(--accent);
  --primary-soft: var(--accent-weak);
  --primary-border: hsl(var(--accent-h) 55% 80% / 0.7);
  --success: var(--green);
  --success-soft: var(--green-soft);
  --success-border: hsl(152 62% 80% / 0.65);
  --warning: var(--orange);
  --danger: var(--red);
  --shadow-sm: 0 12px 30px rgba(15, 23, 42, 0.08);
  --shadow-lg: 0 28px 60px rgba(15, 23, 42, 0.12);
  --transition: all .2s ease;
  --gym-color: hsl(var(--accent-h) 65% 42%);
  --run-color: var(--green);
  --read-color: var(--accent);
  --extra-color: #0ea5e9;
  --day-empty: #fff1f2;
  --day-empty-border: rgba(248, 113, 113, 0.5);
  --day-planned: #fff7ed;
  --day-planned-border: rgba(251, 191, 36, 0.45);
  --day-completed: var(--green-soft);
  --day-completed-border: rgba(34, 197, 94, 0.45);
}

.page-content {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.module-title-row {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}

.month-switcher {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.month-switcher .month-labels {
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: center;
  min-width: 140px;
}

.month-switcher .month-label {
  font-size: 18px;
  font-weight: 700;
  text-transform: capitalize;
}

.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: var(--surface);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
}

.icon-btn .icon {
  width: 18px;
  height: 18px;
}

.icon-btn:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
  border-color: hsl(var(--accent-h) 45% 75%);
}

.top-grid {
  display: grid;
  grid-template-columns: minmax(280px, 1fr) minmax(520px, 2fr);
  gap: 20px;
  align-items: stretch;
}

.metrics-card {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.metrics-header h3 { font-size: 16px; font-weight: 700; }
.metrics-header p { margin-top: 4px; }

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  gap: 12px;
}

.focus-card {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.plan-overview {
  align-items: flex-start;
}

.grid-2.plan-overview {
  grid-template-columns: minmax(260px, 0.85fr) minmax(560px, 1.75fr);
  gap: 18px;
  align-items: stretch;
}

.plan-card {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 18px;
  height: 100%;
  min-height: 0;
}

.plan-card--slim {
  gap: 10px;
  padding: 16px;
}

.plan-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
}

.plan-card-title {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.plan-card-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.plan-card-body {
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-height: 0;
}

.plan-card--board {
  padding: 18px;
}

.plan-card-layout {
  display: grid;
  grid-template-columns: minmax(0, 0.85fr) minmax(0, 1.15fr);
  gap: 16px;
  align-items: start;
}

.plan-summary {
  border: 1px solid var(--line);
  border-radius: 14px;
  background: rgba(148, 163, 184, 0.12);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-height: 0;
}

.plan-summary-head {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
}

.plan-summary-title {
  font-size: 18px;
  font-weight: 700;
  line-height: 1.35;
  margin: 0;
}

.plan-summary .vacation-note {
  margin: 0;
}

.plan-panel-stack {
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-height: 0;
}

.plan-panels {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.plan-panel {
  border: 1px solid var(--line);
  border-radius: 14px;
  background: var(--surface);
  overflow: hidden;
}

.plan-panel.is-empty:not([open]) {
  border-style: dashed;
  color: var(--muted);
}

.plan-panel summary {
  list-style: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  padding: 10px 12px;
  cursor: pointer;
}

.plan-panel summary::-webkit-details-marker {
  display: none;
}

.plan-panel[open] summary {
  border-bottom: 1px solid var(--line);
  background: rgba(148, 163, 184, 0.08);
}

.plan-panel-body {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 12px 14px 14px;
  max-height: 240px;
  overflow-y: auto;
}

.panel-main {
  display: flex;
  align-items: center;
  gap: 6px;
}

.panel-title {
  font-size: 13px;
  font-weight: 700;
}

.panel-count {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  background: rgba(37, 99, 235, 0.1);
  color: var(--accent);
}

.plan-panel.is-empty .panel-count {
  background: rgba(148, 163, 184, 0.12);
  color: var(--muted);
}

.panel-meta {
  font-size: 11px;
  color: var(--muted);
  font-weight: 500;
  text-align: right;
}

.plan-panel.is-empty .panel-meta {
  color: var(--muted);
}

.plan-panel .detail-list {
  max-height: none;
  overflow: visible;
  padding-right: 0;
}

.plan-panel .empty-state {
  font-size: 11px;
  color: var(--muted);
  margin: 0;
}


.plan-card-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.plan-card-actions .btn {
  flex: 1 1 140px;
}

.plan-card-actions--compact {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 8px;
  margin-top: 0;
}

.plan-card-actions--compact .btn {
  padding: 10px 12px;
  font-size: 13px;
}

.plan-card-actions--stacked {
  grid-template-columns: 1fr;
  gap: 10px;
}

.plan-card-actions--stacked .btn {
  justify-content: flex-start;
}

.focus-card--compact {
  gap: 14px;
}

.focus-card--compact .focus-columns {
  grid-template-columns: 1fr;
  gap: 14px;
}

.focus-card--compact .detail-actions {
  flex-wrap: wrap;
  gap: 10px;
}

.focus-card--compact .detail-actions .btn {
  flex: 1 1 160px;
  min-width: 140px;
}

.focus-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 16px;
}

.focus-title h3 { font-size: 20px; font-weight: 700; }

.focus-meta {
  display: flex;
  gap: 10px;
  align-items: center;
}

.focus-columns {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 18px;
  align-items: start;
}

.focus-column {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.vacation-note {
  display: none;
  font-size: 11px;
  font-weight: 600;
  color: var(--muted);
  background: rgba(148, 163, 184, 0.16);
  border-radius: 12px;
  padding: 8px 12px;
}

.focus-goals {
  display: flex;
  flex-direction: column;
  gap: 12px;
  background: rgba(37, 99, 235, 0.06);
  border: 1px solid rgba(37, 99, 235, 0.16);
  border-radius: 16px;
  padding: 14px 16px;
}

.page-header {
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.page-header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}

.title-block { display: flex; flex-direction: column; gap: 6px; }
.title-block .back-link { align-self: flex-start; }
.eyebrow {
  text-transform: uppercase;
  letter-spacing: 0.14em;
  font-size: 10px;
  font-weight: 600;
  color: var(--muted);
}

.title-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.title-row h1 { font-size: 26px; font-weight: 800; letter-spacing: -0.3px; }

.page-header-actions { display: flex; gap: 10px; align-items: center; }

.btn.icon-btn {
  width: 40px;
  height: 40px;
  padding: 0;
}

.btn.icon-btn .icon {
  width: 18px;
  height: 18px;
}

.icon { width: 16px; height: 16px; }

.month-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; background: var(--primary-soft); color: var(--accent); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; }

.metrics-row {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 12px;
}

.metric-card {
  border: 1px solid rgba(148, 163, 184, 0.3);
  border-radius: 16px;
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  background: linear-gradient(160deg, rgba(37, 99, 235, 0.08), rgba(14, 165, 233, 0.05));
}

.metric-text {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.metric-card--donut,
.metric-card--visual {
  flex-direction: row;
  align-items: center;
  gap: 14px;
}

.metric-card--donut .metric-text,
.metric-card--visual .metric-text {
  flex: 1;
}

.metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.12em; color: var(--muted); font-weight: 600; }
.metric-value { font-size: 22px; font-weight: 700; }
.metric-sub { font-size: 11px; color: var(--muted); display: block; }
.metric-sub--stacked { display: flex; flex-direction: column; gap: 2px; }
.metric-subline { display: block; }

.metric-donut {
  position: relative;
  width: 56px;
  height: 56px;
  flex-shrink: 0;
}

.metric-donut svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.metric-donut circle {
  fill: none;
  stroke-width: 3.6;
}

.metric-donut .donut-bg {
  stroke: rgba(148, 163, 184, 0.28);
}

.metric-donut .donut-value {
  stroke: var(--primary);
  stroke-linecap: round;
  stroke-dasharray: 100;
  stroke-dashoffset: 100;
  transition: stroke-dashoffset 0.4s ease;
}

.metric-donut span {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
}

.metric-visual {
  width: 52px;
  height: 52px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(37, 99, 235, 0.12);
  color: var(--primary);
  flex-shrink: 0;
  transition: var(--transition);
}

.metric-visual .icon {
  width: 24px;
  height: 24px;
}

.metric-visual--compact {
  width: 44px;
  height: 44px;
  border-radius: 14px;
}

.metric-visual--compact .icon {
  width: 20px;
  height: 20px;
}

.metric-card--visual[data-activity-type="gym"] .metric-visual {
  background: rgba(91, 33, 182, 0.12);
  color: var(--gym-color);
}

.metric-card--visual[data-activity-type="running"] .metric-visual {
  background: rgba(4, 120, 87, 0.12);
  color: var(--run-color);
}

.metric-card--visual[data-activity-type="reading"] .metric-visual {
  background: rgba(29, 78, 216, 0.12);
  color: var(--read-color);
}

.metric-card--visual[data-activity-type="extra"] .metric-visual {
  background: rgba(14, 165, 233, 0.14);
  color: var(--extra-color);
}

.metric-card--visual[data-activity-type="none"] .metric-visual {
  background: rgba(148, 163, 184, 0.18);
  color: var(--muted);
}

.kpi-value--sm {
  font-size: 18px;
}

.kpi-progress-card {
  align-items: stretch;
}

.kpi-progress-card > span {
  align-self: flex-start;
}

.kpi-progress-card > div {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.kpi-next-activity {
  gap: 12px;
  align-items: center;
}

.kpi-next-activity .kpi-value--sm {
  margin-top: 2px;
}

.goal-progress-grid {
  display: grid;
  gap: 12px;
}

.goal-progress-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
}

.goal-progress-item .goal-progress-body {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
.card-header p { margin-top: 4px; }

.muted { color: var(--muted); }
.tiny { font-size: 11px; letter-spacing: 0.02em; }

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
  color: var(--muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-weight: 600;
}

.calendar-weekdays span {
  display: flex;
  justify-content: flex-start;
  padding-bottom: 2px;
  padding-left: 4px;
}


.calendar-card--compact {
  display: flex;
  flex-direction: column;
  gap: 14px;
  padding: 16px 18px;
  height: 100%;
  min-height: 0;
}

.calendar-card .card-header {
  margin-bottom: 0;
  align-items: flex-start;
}
.calendar-card .card-header p {
  margin-top: 2px;
}

.calendar-card--compact .calendar-grid {
  flex: 1;
  overflow: auto;
  padding-right: 2px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
  grid-auto-rows: minmax(140px, 1fr);
}

.calendar-day {
  background: var(--surface);
  border-radius: 12px;
  border: 1px solid var(--line);
  padding: 12px;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  box-shadow: 0 1px 0 rgba(15, 23, 42, 0.04);
  overflow: hidden;
}

.calendar-day:hover { border-color: var(--primary); box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12); transform: translateY(-2px); }
.calendar-day--other-month { opacity: 0.45; }
.calendar-day--selected { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.14); }
.calendar-day--today { border-color: var(--success); }
.calendar-day--empty { background: var(--day-empty); border-color: var(--day-empty-border); }
.calendar-day--planned { background: var(--day-planned); border-color: var(--day-planned-border); }
.calendar-day--completed { background: var(--day-completed); border-color: var(--day-completed-border); }
.calendar-day--vacation {
  background: #f1f5f9;
  border-color: rgba(148, 163, 184, 0.4);
  color: var(--muted);
}
.calendar-day--drag-over {
  outline: 2px dashed var(--primary);
  outline-offset: 3px;
}

.calendar-day-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 8px;
}
.calendar-day-title {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
}
.calendar-day-weekday {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
  font-weight: 600;
}
.calendar-date-number {
  font-weight: 700;
  font-size: 16px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 26px;
  height: 28px;
  border-radius: 9px;
  border: 1px solid var(--line);
  background: var(--card);
  color: var(--ink);
  box-shadow: inset 0 -1px 0 rgba(15, 23, 42, 0.06);
}
.calendar-day-status {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--muted);
}
.calendar-day-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: flex-end;
}
.calendar-day-status[data-state="planned"] { color: var(--warning); }
.calendar-day-status[data-state="progress"] { color: var(--accent); }
.calendar-day-status[data-state="done"] { color: var(--success); }
.calendar-day-status[data-state="vacation"] { color: rgba(30, 41, 59, 0.6); }
.calendar-day-status[data-state="empty"] { color: var(--muted); }
.calendar-day-badges {
  display: inline-flex;
  gap: 4px;
  align-items: center;
  flex-shrink: 0;
}
.calendar-badge {
  background: rgba(148, 163, 184, 0.16);
  border-radius: 999px;
  padding: 2px 6px;
  font-size: 10px;
  font-weight: 600;
  border: 1px solid rgba(148, 163, 184, 0.3);
  color: var(--muted);
}

.calendar-day-tags {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-height: 0;
  flex: 1;
  overflow: hidden;
}
.activity-tag {
  display: grid;
  grid-template-columns: auto 1fr;
  align-items: start;
  gap: 6px;
  padding: 6px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  background: rgba(148, 163, 184, 0.12);
  color: var(--ink);
  border: 1px solid rgba(148, 163, 184, 0.24);
  max-width: 100%;
  white-space: normal;
  line-height: 1.35;
  word-break: break-word;
  overflow-wrap: anywhere;
}
.activity-tag::before {
  content: '•';
  font-size: 12px;
  color: var(--muted);
  line-height: 1;
  transform: translateY(2px);
}
.activity-tag[draggable="true"] { cursor: grab; }
.activity-tag.dragging { opacity: 0.6; cursor: grabbing; }
.activity-tag.gym { background: rgba(91, 33, 182, 0.08); color: var(--gym-color); border-color: rgba(91, 33, 182, 0.18); }
.activity-tag.gym::before { content: '🏋️'; }
.activity-tag.running { background: rgba(4, 120, 87, 0.08); color: var(--run-color); border-color: rgba(4, 120, 87, 0.18); }
.activity-tag.running::before { content: '🏃'; }
.activity-tag.reading { background: rgba(29, 78, 216, 0.08); color: var(--read-color); border-color: rgba(29, 78, 216, 0.18); }
.activity-tag.reading::before { content: '📚'; }
.activity-tag.extra { background: rgba(14, 165, 233, 0.1); color: var(--extra-color); border-color: rgba(14, 165, 233, 0.18); }
.activity-tag.extra::before { content: '✨'; }
.activity-tag.vacation { background: rgba(148, 163, 184, 0.18); color: var(--muted); border-color: rgba(148, 163, 184, 0.32); font-weight: 700; }
.activity-tag.vacation::before { content: '🌴'; }
.activity-tag.more { background: rgba(148, 163, 184, 0.12); color: var(--muted); border-style: dashed; }
.activity-tag.more::before { content: '➕'; color: var(--muted); }

.calendar-progress {
  height: 4px;
  background: rgba(148, 163, 184, 0.16);
  border-radius: 999px;
  overflow: hidden;
  margin-top: 2px;
}
.calendar-progress-fill {
  height: 100%;
  border-radius: inherit;
  background: var(--accent);
  transition: width 0.25s ease;
}
.calendar-progress-fill[data-state="empty"] { background: rgba(248, 113, 113, 0.65); }
.calendar-progress-fill[data-state="planned"] { background: rgba(251, 191, 36, 0.8); }
.calendar-progress-fill[data-state="progress"] { background: rgba(59, 130, 246, 0.85); }
.calendar-progress-fill[data-state="done"] { background: rgba(34, 197, 94, 0.85); }
.calendar-progress-fill[data-state="vacation"] { background: rgba(148, 163, 184, 0.6); }

.calendar-day-footer {
  margin-top: auto;
  font-size: 10px;
  color: var(--muted);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
}
.calendar-footer-label {
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 6px;
  border-radius: 999px;
  background: rgba(148, 163, 184, 0.16);
  color: var(--muted);
}
.calendar-footer-label::before {
  content: '✓';
  font-size: 10px;
}
.calendar-day--empty .calendar-footer-label { color: var(--danger); background: rgba(248, 113, 113, 0.12); }
.calendar-day--empty .calendar-footer-label::before { content: '○'; }
.calendar-day--planned .calendar-footer-label { color: var(--warning); background: rgba(251, 191, 36, 0.18); }
.calendar-day--planned .calendar-footer-label::before { content: '•'; }
.calendar-day--completed .calendar-footer-label { color: var(--success); background: rgba(34, 197, 94, 0.16); }
.calendar-footer-remaining {
  font-size: 10px;
  color: var(--muted);
}

.calendar-legend { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; font-size: 11px; color: var(--muted); }
.calendar-legend span { display: inline-flex; align-items: center; gap: 6px; }
.legend-tag {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-weight: 600;
  font-size: 10px;
  letter-spacing: 0.02em;
  background: rgba(148, 163, 184, 0.16);
  color: var(--muted);
}
.legend-tag.gym { background: rgba(91, 33, 182, 0.12); color: var(--gym-color); }
.legend-tag.running { background: rgba(4, 120, 87, 0.12); color: var(--run-color); }
.legend-tag.reading { background: rgba(29, 78, 216, 0.12); color: var(--read-color); }
.legend-tag.extra { background: rgba(14, 165, 233, 0.12); color: var(--extra-color); }
.legend-tag.vacation { background: rgba(148, 163, 184, 0.22); color: var(--muted); }

.planning-banner {
  display: none;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  background: rgba(37, 99, 235, 0.04);
  border: 1px dashed rgba(37, 99, 235, 0.2);
  border-radius: 12px;
  padding: 10px 12px;
  margin-top: 4px;
}

.planning-banner.active {
  display: flex;
  border-style: solid;
  background: rgba(37, 99, 235, 0.1);
  box-shadow: var(--shadow-sm);
}
.planning-banner:not(.active) #stop-planning-btn { display: none; }
.planning-banner-info { display: flex; align-items: flex-start; gap: 8px; }
.planning-banner-info strong { display: block; font-size: 12px; font-weight: 700; color: var(--ink); }
.planning-banner-info span { display: block; font-size: 11px; color: var(--muted); }
.planning-banner .icon { color: var(--primary); }

.btn.small { padding: 6px 12px; font-size: 11px; border-radius: 10px; }

.calendar-card--planning { border-color: var(--primary); box-shadow: var(--shadow-sm); }
.calendar-grid.is-planning .calendar-day { cursor: crosshair; }

.empty-state {
  font-size: 12px;
  color: var(--muted);
  text-align: center;
  padding: 12px 10px;
  border-radius: 10px;
  background: rgba(248, 250, 252, 0.7);
  border: 1px dashed rgba(148, 163, 184, 0.4);
}
.day-detail-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
.detail-block { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }
.detail-block-header { font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
.detail-list { display: flex; flex-direction: column; gap: 10px; }
.detail-item {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 12px;
  border: 1px solid rgba(148, 163, 184, 0.26);
  background: rgba(248, 250, 252, 0.85);
  transition: var(--transition);
}
.detail-item[draggable="true"] { cursor: grab; }
.detail-item.dragging { opacity: 0.6; cursor: grabbing; }
.detail-item:hover { border-color: var(--primary-border); box-shadow: var(--shadow-sm); background: #fff; }
.detail-item.completed { background: var(--success-soft); border-color: var(--success-border); }
.detail-info { display: flex; gap: 8px; }
.detail-icon { width: 34px; height: 34px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 13px; }
.detail-icon.gym { background: rgba(91, 33, 182, 0.2); color: var(--gym-color); }
.detail-icon.running { background: rgba(4, 120, 87, 0.18); color: var(--run-color); }
.detail-icon.reading { background: rgba(29, 78, 216, 0.18); color: var(--read-color); }
.detail-icon.extra { background: rgba(14, 165, 233, 0.18); color: var(--extra-color); }
.detail-title { font-weight: 600; font-size: 12.5px; }
.detail-meta { font-size: 11px; color: var(--muted); }
.detail-actions-inline { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }

.action-btn {
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  background: #fff;
  color: var(--ink);
  font-size: 11px;
  font-weight: 600;
  padding: 6px 10px;
  cursor: pointer;
  transition: var(--transition);
}

.action-btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
.action-btn.success { background: var(--success); color: #fff; border-color: var(--success); }
.action-btn.danger { border-color: rgba(220, 38, 38, 0.3); color: var(--danger); background: #fff5f5; }
.action-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }

.detail-actions { display: flex; gap: 10px; margin-top: 18px; flex-wrap: wrap; }



.heatmap-card { display: flex; flex-direction: column; gap: 16px; }
.heatmap { display: flex; gap: 3px; overflow-x: auto; padding-bottom: 8px; flex-wrap: nowrap; }
.heatmap-week { display: grid; grid-template-rows: repeat(7, 11px) auto; gap: 3px; align-items: center; }
.heatmap-cell { width: 11px; height: 11px; border-radius: 3px; background: #e2e8f0; }
.heatmap-cell[data-level="0"] { background: #e2e8f0; }
.heatmap-cell[data-level="1"] { background: #b7f3d0; }
.heatmap-cell[data-level="2"] { background: #6ee7b7; }
.heatmap-cell[data-level="3"] { background: #34d399; }
.heatmap-cell[data-level="4"] { background: #059669; }
.heatmap-cell--empty { background: transparent; }
.heatmap-month-label { font-size: 9px; text-transform: uppercase; color: var(--muted); text-align: center; letter-spacing: 0.08em; margin-top: 1px; }
.heatmap-legend { display: flex; align-items: center; justify-content: flex-end; gap: 10px; font-size: 11px; color: var(--muted); }
.heatmap-legend-scale { display: inline-flex; align-items: center; gap: 4px; }
.heatmap-legend-scale span { width: 14px; height: 14px; border-radius: 3px; background: #e2e8f0; }
.heatmap-legend-scale span[data-level="1"] { background: #b7f3d0; }
.heatmap-legend-scale span[data-level="2"] { background: #6ee7b7; }
.heatmap-legend-scale span[data-level="3"] { background: #34d399; }
.heatmap-legend-scale span[data-level="4"] { background: #059669; }
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s ease;
  z-index: 100;
}

.modal-overlay.visible { opacity: 1; pointer-events: all; }

.modal-card {
  background: #fff;
  padding: 28px;
  border-radius: 18px;
  max-width: 440px;
  width: 90%;
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.modal-card h3 { font-size: 18px; font-weight: 700; }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.modal-card input, .modal-card textarea, .modal-card select { width: 100%; border: 1px solid var(--line); border-radius: 12px; padding: 12px; font-family: inherit; font-size: 13px; }
.modal-field { display: flex; flex-direction: column; gap: 6px; }
.modal-field-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.modal-options { display: flex; flex-direction: column; gap: 10px; }
.option-label { border: 1px solid var(--line); border-radius: 12px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: var(--transition); }
.option-label:hover { border-color: var(--primary); background: var(--primary-soft); }
.option-label input { accent-color: var(--primary); }

#save-status {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--ink);
  color: #fff;
  padding: 10px 20px;
  border-radius: 14px;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  pointer-events: none;
  transition: opacity .3s ease, transform .3s ease;
  font-size: 12px;
  z-index: 120;
}

#save-status.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

@media (max-width: 1080px) {
  .top-grid { grid-template-columns: 1fr; }
  .focus-columns { grid-template-columns: 1fr; }
  .bottom-grid { grid-template-columns: 1fr; }
  .grid-2.plan-overview { grid-template-columns: 1fr; }
  .plan-card-layout { grid-template-columns: 1fr; }
}

@media (max-width: 720px) {
  .wrap { padding: 24px 18px 40px; }
  .page-header-top { flex-direction: column; align-items: flex-start; }
  .page-header-actions { width: 100%; }
  .page-header-actions .btn { flex: 1; justify-content: center; }
  .metrics-grid { grid-template-columns: 1fr; }
  .focus-meta { flex-direction: column; align-items: flex-start; }
  .detail-actions { flex-direction: column; }
  .bottom-grid { grid-template-columns: 1fr; }
  .calendar-weekdays { display: none; }
  .calendar-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
  </style>
</head>
<body data-page="trainings">
  <div class="layout">
    <aside class="sidebar" aria-label="Główna nawigacja">
      <div class="sidebar-header"><span class="emoji">🧭</span><span>LifeOS</span></div>
      <nav class="sidebar-nav">
        <a class="nav-link" href="index.html"><span class="icon">📊</span><span>Dashboard</span></a>
        <a class="nav-link" href="budget.html"><span class="icon">💰</span><span>Budżet</span></a>
        <a class="nav-link" href="fuel.html"><span class="icon">⛽</span><span>Paliwo</span></a>
        <a class="nav-link active" href="trainings.html" aria-current="page"><span class="icon">💪</span><span>Treningi</span></a>
        <a class="nav-link" href="loan.html"><span class="icon">🏦</span><span>Kredyt</span></a>
        <a class="nav-link" href="tasks.html"><span class="icon">✅</span><span>Zadania</span></a>
        <a class="nav-link" href="house.html"><span class="icon">🏠</span><span>Budowa</span></a>
        <a class="nav-link" href="index.html#settings"><span class="icon">⚙️</span><span>Ustawienia</span></a>
      </nav>
      <div class="sidebar-footer">
        <strong>Twój cyfrowy dom</strong>
        Zarządzaj budżetem, zadaniami i celami w jednym miejscu.
      </div>
    </aside>

    <div class="main">
      <header class="topbar">
        <div>
          <p class="topbar-eyebrow">Program treningowy</p>
          <div class="module-title-row">
            <h1 class="topbar-title">Treningi</h1>
            <span class="chip" id="header-month-chip">--</span>
          </div>
        </div>
        <div class="topbar-actions month-switcher">
          <button id="prev-month-btn" class="btn ghost icon-btn" aria-label="Poprzedni miesiąc"><i data-lucide="chevron-left" class="icon"></i></button>
          <div class="month-labels">
            <span class="month-label" id="current-month-label">--</span>
            <span class="tiny muted" id="current-month-range">--</span>
          </div>
          <button id="next-month-btn" class="btn ghost icon-btn" aria-label="Następny miesiąc"><i data-lucide="chevron-right" class="icon"></i></button>
          <button id="today-month-btn" class="btn soft"><i data-lucide="calendar" class="icon"></i>Dzisiaj</button>
        </div>
      </header>

      <div class="content">
        <main class="page-content content-main stack">
          <div class="grid-2 plan-overview">
            <section class="card focus-card focus-card--compact plan-card plan-card--slim plan-card--board">
              <header class="plan-card-header">
                <div class="plan-card-title">
                  <span class="tiny muted">Plan na dziś</span>
                  <h3>Twoja dzisiejsza ścieżka</h3>
                </div>
                <div class="plan-card-meta">
                  <span class="month-chip" id="selected-day-chip">--</span>
                  <button id="toggle-vacation-btn" class="btn ghost small"><i data-lucide="plane" class="icon"></i>Urlop</button>
                </div>
              </header>
              <div class="plan-card-body">
                <div class="plan-card-layout">
                  <div class="plan-summary">
                    <div class="plan-summary-head">
                      <h4 id="selected-day-title" class="plan-summary-title">--</h4>
                    </div>
                    <p class="muted tiny" id="selected-day-summary">Wybierz dzień z kalendarza, aby zarządzać planem.</p>
                    <div id="vacation-note" class="vacation-note">Dzień oznaczony jako urlop — bez oczekiwań treningowych.</div>
                    <div class="plan-card-actions plan-card-actions--compact plan-card-actions--stacked">
                      <button id="add-training-btn" class="btn"><i data-lucide="plus" class="icon"></i>Zaplanuj treningi</button>
                      <button id="add-extra-btn" class="btn ghost"><i data-lucide="sparkles" class="icon"></i>Dodaj aktywność</button>
                      <button id="plan-vacation-range-btn" class="btn ghost"><i data-lucide="calendar-range" class="icon"></i>Zaplanuj urlop</button>
                    </div>
                    <div class="planning-banner" id="planning-banner" aria-live="polite">
                      <div class="planning-banner-info">
                        <i data-lucide="mouse-pointer" class="icon"></i>
                        <div>
                          <strong id="planning-banner-title">Tryb planowania</strong>
                          <span id="planning-banner-meta">Wybierz typ treningu, aby rozpocząć tryb planowania wielu dni.</span>
                        </div>
                      </div>
                      <button id="stop-planning-btn" class="btn soft small"><i data-lucide="check" class="icon"></i>Zakończ</button>
                    </div>
                  </div>
                  <div class="plan-panel-stack">
                    <div class="plan-panels">
                      <details id="plan-training-panel" class="plan-panel" open>
                        <summary>
                          <div class="panel-main">
                            <span class="panel-title">Plan treningowy</span>
                            <span class="panel-count" id="day-plan-count">0</span>
                          </div>
                          <span class="panel-meta" id="day-plan-meta">Brak zaplanowanych treningów</span>
                        </summary>
                        <div class="plan-panel-body">
                          <div id="day-plan-list" class="detail-list"></div>
                          <p id="day-plan-empty" class="empty-state">Brak zaplanowanych treningów na ten dzień.</p>
                        </div>
                      </details>
                      <details id="plan-extra-panel" class="plan-panel">
                        <summary>
                          <div class="panel-main">
                            <span class="panel-title">Aktywności dodatkowe</span>
                            <span class="panel-count" id="day-extra-count">0</span>
                          </div>
                          <span class="panel-meta" id="day-extra-meta">Nic zaplanowanego</span>
                        </summary>
                        <div class="plan-panel-body">
                          <div id="day-extra-list" class="detail-list"></div>
                          <p id="day-extra-empty" class="empty-state">Dodaj krótkie działania lub przypomnienia.</p>
                        </div>
                      </details>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="card calendar-card calendar-card--compact">
              <div class="card-header">
                <div>
                  <h3>Dziennik aktywności</h3>
                  <p class="muted tiny">Pełny miesiąc w jednym widoku</p>
                </div>
                <div class="calendar-legend">
                  <span class="legend-tag gym">Siłownia</span>
                  <span class="legend-tag running">Bieganie</span>
                  <span class="legend-tag reading">Czytanie</span>
                  <span class="legend-tag extra">Dodatkowe</span>
                  <span class="legend-tag vacation">Urlop</span>
                </div>
              </div>
              <div class="calendar-weekdays">
                <span>Pon</span><span>Wt</span><span>Śr</span><span>Czw</span><span>Pt</span><span>Sob</span><span>Niedz</span>
              </div>
              <div id="calendar-grid" class="calendar-grid"></div>
            </section>
          </div>

          <section class="card heatmap-card">
            <div class="card-header">
              <div>
                <h3>Historia aktywności</h3>
                <p class="muted tiny">Podsumowanie ukończonych zadań w ciągu roku</p>
              </div>
              <span class="month-chip" id="heatmap-year-label">--</span>
            </div>
            <div id="heatmap" class="heatmap"></div>
            <div class="heatmap-legend">
              <span>Brak</span>
              <div class="heatmap-legend-scale">
                <span data-level="0"></span>
                <span data-level="1"></span>
                <span data-level="2"></span>
                <span data-level="3"></span>
                <span data-level="4"></span>
              </div>
              <span>Intensywnie</span>
            </div>
          </section>
        </main>

        <aside class="right-rail">
          <div class="kpi-compact kpi-progress-card">
            <span class="kpi-emoji">📈</span>
            <div>
              <div class="kpi-label">Postęp tygodniowy</div>
              <div class="kpi-value" id="metric-weekly-complete-percent">0%</div>
              <div class="tiny muted" id="metric-weekly-complete-sub"></div>
            </div>
          </div>
          <div id="goal-progress-list" class="goal-progress-grid"></div>
          <div class="kpi-compact">
            <span class="kpi-emoji">📆</span>
            <div>
              <div class="kpi-label">Tygodnie zaliczone</div>
              <div class="kpi-value" id="metric-weekly-complete-count">0/0</div>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">🧍</span>
            <div>
              <div class="kpi-label">Dni aktywne</div>
              <div class="kpi-value" id="metric-active-days">0/0</div>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">✅</span>
            <div>
              <div class="kpi-label">Akcje wykonane</div>
              <div class="kpi-value" id="metric-plan-completion">0/0</div>
            </div>
          </div>
          <div class="kpi-compact metric-card--visual kpi-next-activity" id="metric-next-activity-card" data-activity-type="none">
            <span class="metric-visual metric-visual--compact" id="metric-next-activity-visual"><i data-lucide="calendar" class="icon"></i></span>
            <div>
              <div class="kpi-label">Najbliższa aktywność</div>
              <div class="kpi-value kpi-value--sm" id="metric-next-activity-date">Brak terminu</div>
              <div class="tiny muted">Zaplanuj kolejny ruch</div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-card">
    <h3 id="modal-title"></h3>
    <p id="modal-text" class="muted"></p>
    <div id="modal-input-container"></div>
    <div id="modal-options-container"></div>
    <div id="modal-actions" class="modal-actions"></div>
  </div>
</div>
<div id="save-status">Zapisano zmiany</div>

<script>
const STORAGE_KEY = 'lifeos_trainings_month_v1';
const LEGACY_STORAGE_KEY = 'lifeos_trainings_v1';
const MIGRATION_FLAG_KEY = 'lifeos_trainings_migrated_to_month_v1';
const GOAL_DEFINITIONS = {
  gym: { target: 3, unit: 'sesje', label: 'Trening siłowy', icon: 'dumbbell', color: 'var(--gym-color)' },
  running: { target: 5, unit: 'km', label: 'Bieganie', icon: 'activity', color: 'var(--run-color)' },
  reading: { target: 100, unit: 'stron', label: 'Czytanie', icon: 'book-open', color: 'var(--read-color)' }
};
const EXTRA_ACTIVITY_CATEGORIES = [
  { value: 'training', label: 'Trening / ruch' },
  { value: 'learning', label: 'Nauka / rozwój' },
  { value: 'relax', label: 'Regeneracja' },
  { value: 'home', label: 'Dom i organizacja' },
  { value: 'other', label: 'Inne' }
];
const EXTRA_CATEGORY_LABELS = EXTRA_ACTIVITY_CATEGORIES.reduce((acc, item) => {
  acc[item.value] = item.label;
  return acc;
}, {});
const ACTIVITY_TAG_SHORT = { gym: 'Siła', running: 'Bieg', reading: 'Czyt.' };
const ACTIVITY_UNIT_SHORT = { running: 'km', reading: 'str.' };
const MAX_CALENDAR_TAGS = 4;
const DEFAULT_PLANNING_META = 'Wybierz typ treningu, aby rozpocząć tryb planowania wielu dni.';
const DAY_MS = 24 * 60 * 60 * 1000;
const DONUT_CIRCUMFERENCE = 2 * Math.PI * 16;

const safeParse = (raw, fallbackFactory) => {
  const fallback = () => (typeof fallbackFactory === 'function' ? fallbackFactory() : fallbackFactory);
  if (!raw) return fallback();
  try {
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === 'object' ? parsed : fallback();
  } catch {
    return fallback();
  }
};

let state = { activities: {}, extras: {}, vacations: {} };
let currentMonth = startOfMonth(new Date());
let selectedDate = toYYYYMMDD(new Date());
let planningMode = null;
let saveTimeout;

function startOfMonth(date) {
  return new Date(date.getFullYear(), date.getMonth(), 1);
}

function toYYYYMMDD(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function parseDate(dateString) {
  const [y, m, d] = dateString.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function formatMonth(date) {
  return date.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
}

function formatRange(start, end) {
  return `${start.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' })} – ${end.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' })}`;
}

function formatDateWithDay(date) {
  return date.toLocaleDateString('pl-PL', { weekday: 'short', day: '2-digit', month: 'short' });
}

function formatPlanningSummary(type, plannedValue) {
  const def = GOAL_DEFINITIONS[type];
  if (!def) return 'Nowy trening';
  if (type === 'gym') return def.label;
  const numeric = Number(plannedValue);
  if (!Number.isFinite(numeric) || numeric <= 0) return def.label;
  const valueLabel = `${numeric.toLocaleString('pl-PL')} ${def.unit}`;
  return `${def.label} · ${valueLabel}`;
}

function getActivityTagText(activity) {
  if (!activity || !activity.type) return 'Trening';
  const short = ACTIVITY_TAG_SHORT[activity.type] || 'Plan';
  if (activity.type === 'gym') return short;
  const numeric = Number(activity.plannedValue || activity.loggedValue);
  if (!Number.isFinite(numeric) || numeric <= 0) return short;
  const unit = ACTIVITY_UNIT_SHORT[activity.type] || '';
  const value = numeric.toLocaleString('pl-PL');
  return unit ? `${short} ${value} ${unit}` : `${short} ${value}`;
}

function getExtraTagText(extra) {
  if (!extra) return 'Aktywność';
  const base = (extra.title || '').trim() || EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność';
  if (base.length <= 14) return base;
  return `${base.slice(0, 13)}…`;
}

function isPlanningActive() {
  return Boolean(planningMode && planningMode.active);
}

function startPlanningMode(type, plannedValue) {
  planningMode = {
    active: true,
    type,
    plannedValue: type === 'gym' ? 1 : Number(plannedValue) || 0
  };
  setTimeout(() => render(), 0);
}

function stopPlanningMode() {
  if (!isPlanningActive()) return;
  planningMode = null;
  setTimeout(() => render(), 0);
}

function addDays(date, days) {
  const copy = new Date(date);
  copy.setDate(copy.getDate() + days);
  return copy;
}

function startOfWeek(date) {
  const copy = new Date(date);
  const offset = (copy.getDay() + 6) % 7;
  copy.setDate(copy.getDate() - offset);
  copy.setHours(0, 0, 0, 0);
  return copy;
}

function ensureDay(dateString) {
  if (!state.activities[dateString]) state.activities[dateString] = [];
  if (!state.extras[dateString]) state.extras[dateString] = [];
}

function isVacationDay(dateString) {
  return Boolean(state.vacations && state.vacations[dateString]);
}

function toggleVacationDay(dateString) {
  if (!state.vacations) state.vacations = {};
  if (isVacationDay(dateString)) {
    delete state.vacations[dateString];
  } else {
    state.vacations[dateString] = true;
  }
  saveState();
  render();
}

function planVacationRange(startDateString, endDateString) {
  if (!startDateString || !endDateString) return;
  const start = parseDate(startDateString);
  const end = parseDate(endDateString);
  if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return;
  const normalizedStart = normalizeDate(start);
  const normalizedEnd = normalizeDate(end);
  if (normalizedEnd < normalizedStart) return;
  if (!state.vacations) state.vacations = {};
  const cursor = new Date(normalizedStart);
  let guard = 0;
  while (cursor.getTime() <= normalizedEnd.getTime() && guard < 370) {
    const key = toYYYYMMDD(cursor);
    state.vacations[key] = true;
    cursor.setDate(cursor.getDate() + 1);
    guard += 1;
  }
  saveState();
  render();
}

let dragPayload = null;

function enableDrag(element, payload) {
  if (!element) return;
  element.setAttribute('draggable', 'true');
  element.addEventListener('dragstart', event => {
    dragPayload = payload;
    element.classList.add('dragging');
    if (event.dataTransfer) {
      event.dataTransfer.effectAllowed = 'move';
      try {
        event.dataTransfer.setData('application/json', JSON.stringify(payload));
      } catch (error) {
        // ignore unsupported MIME
      }
    }
  });
  element.addEventListener('dragend', () => {
    dragPayload = null;
    element.classList.remove('dragging');
  });
}

function resolveDragPayload(event) {
  if (dragPayload) return dragPayload;
  if (!event || !event.dataTransfer) return null;
  try {
    const data = event.dataTransfer.getData('application/json');
    if (data) {
      return JSON.parse(data);
    }
  } catch (error) {
    return null;
  }
  return null;
}

function movePlannedItem(payload, targetDate) {
  if (!payload || !targetDate || payload.sourceDate === targetDate) return;
  ensureDay(payload.sourceDate);
  ensureDay(targetDate);
  let moved = false;
  if (payload.itemType === 'activity') {
    const sourceList = state.activities[payload.sourceDate] || [];
    const index = sourceList.findIndex(item => item.id === payload.id);
    if (index > -1) {
      const [item] = sourceList.splice(index, 1);
      state.activities[targetDate].push(item);
      moved = true;
    }
  } else if (payload.itemType === 'extra') {
    const sourceList = state.extras[payload.sourceDate] || [];
    const index = sourceList.findIndex(item => item.id === payload.id);
    if (index > -1) {
      const [item] = sourceList.splice(index, 1);
      state.extras[targetDate].push(item);
      moved = true;
    }
  }
  if (moved) {
    if (state.vacations && state.vacations[targetDate] && (state.activities[targetDate].length > 0 || state.extras[targetDate].length > 0)) {
      delete state.vacations[targetDate];
    }
    saveState();
    render();
  }
}

function sameMonth(date, reference) {
  return date.getFullYear() === reference.getFullYear() && date.getMonth() === reference.getMonth();
}

function normalizeDate(date) {
  const normalized = new Date(date);
  normalized.setHours(0, 0, 0, 0);
  return normalized;
}

function getISOWeekStart(year, week) {
  const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
  const day = simple.getUTCDay();
  const diff = (day === 0 ? -6 : 1) - day;
  simple.setUTCDate(simple.getUTCDate() + diff);
  return new Date(simple.getUTCFullYear(), simple.getUTCMonth(), simple.getUTCDate());
}

function getISOWeekInfo(date) {
  const target = new Date(date);
  target.setHours(0, 0, 0, 0);
  const dayNumber = (target.getDay() + 6) % 7;
  target.setDate(target.getDate() - dayNumber + 3);
  const isoYear = target.getFullYear();
  const firstWeekStart = getISOWeekStart(isoYear, 1);
  const diffDays = Math.round((target.getTime() - firstWeekStart.getTime()) / DAY_MS);
  const week = 1 + Math.floor(diffDays / 7);
  return { year: isoYear, week: Math.max(1, week) };
}

function loadState() {
  state = { activities: {}, extras: {}, vacations: {} };
  planningMode = null;
  const parsed = safeParse(localStorage.getItem(STORAGE_KEY), () => ({}));
  if (parsed && typeof parsed === 'object') {
    state.activities = parsed.activities && typeof parsed.activities === 'object' ? parsed.activities : {};
    state.extras = parsed.extras && typeof parsed.extras === 'object' ? parsed.extras : {};
    state.vacations = parsed.vacations && typeof parsed.vacations === 'object' ? parsed.vacations : {};
  }
  migrateLegacyState();
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  const status = document.getElementById('save-status');
  status.classList.add('visible');
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => status.classList.remove('visible'), 1600);
}

function migrateLegacyState() {
  try {
    if (localStorage.getItem(MIGRATION_FLAG_KEY)) return;
    const legacyRaw = localStorage.getItem(LEGACY_STORAGE_KEY);
    if (!legacyRaw) return;
    const legacyState = safeParse(legacyRaw, () => null);
    if (!legacyState || typeof legacyState !== 'object') {
      localStorage.setItem(MIGRATION_FLAG_KEY, 'done');
      return;
    }
    let imported = false;
    Object.keys(legacyState).forEach(yearKey => {
      const weeks = legacyState[yearKey];
      if (!weeks || typeof weeks !== 'object') return;
      Object.keys(weeks).forEach(weekKey => {
        const weekData = weeks[weekKey];
        if (!weekData || typeof weekData !== 'object') return;
        const year = Number(yearKey);
        const week = Number(weekKey);
        if (!Number.isFinite(year) || !Number.isFinite(week)) return;
        const weekStart = getISOWeekStart(year, week);
        if (Number.isNaN(weekStart.getTime())) return;

        const mapDayToDate = (dayIndex) => {
          const base = new Date(weekStart);
          const offset = dayIndex === 0 ? 6 : dayIndex - 1;
          base.setDate(weekStart.getDate() + offset);
          base.setHours(0, 0, 0, 0);
          return base;
        };

        const plan = weekData.plan && typeof weekData.plan === 'object' ? weekData.plan : {};
        Object.keys(plan).forEach(dayKey => {
          const dayIndex = Number(dayKey);
          if (!Number.isFinite(dayIndex)) return;
          const date = mapDayToDate(dayIndex);
          const dateString = toYYYYMMDD(date);
          ensureDay(dateString);
          const activities = Array.isArray(plan[dayKey]) ? plan[dayKey] : [];
          activities.forEach(activity => {
            if (!activity || !activity.type || !GOAL_DEFINITIONS[activity.type]) return;
            if (state.activities[dateString].some(item => item.id === activity.id)) return;
            const plannedValue = activity.type === 'gym' ? 1 : Number(activity.plannedValue) || 0;
            const loggedValue = activity.type === 'gym'
              ? (activity.completed ? 1 : 0)
              : Number(activity.loggedValue) || (activity.completed ? plannedValue : 0);
            state.activities[dateString].push({
              id: activity.id || `act_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              type: activity.type,
              plannedValue,
              loggedValue,
              completed: Boolean(activity.completed),
              createdAt: activity.createdAt || Date.now()
            });
            imported = true;
          });
        });

        const extras = weekData.extras && typeof weekData.extras === 'object' ? weekData.extras : {};
        Object.keys(extras).forEach(dayKey => {
          const dayIndex = Number(dayKey);
          if (!Number.isFinite(dayIndex)) return;
          const date = mapDayToDate(dayIndex);
          const dateString = toYYYYMMDD(date);
          ensureDay(dateString);
          const list = Array.isArray(extras[dayKey]) ? extras[dayKey] : [];
          list.forEach(extra => {
            if (!extra || !extra.title) return;
            if (state.extras[dateString].some(item => item.id === extra.id)) return;
            state.extras[dateString].push({
              id: extra.id || `extra_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              title: extra.title,
              category: extra.category || 'other',
              completed: Boolean(extra.completed),
              createdAt: extra.createdAt || Date.now()
            });
            imported = true;
          });
        });

      });
    });
    if (imported) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    localStorage.setItem(MIGRATION_FLAG_KEY, 'done');
  } catch (error) {
    console.error('Legacy trainings migration failed', error);
  }
}

function getMonthKey(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
}

function getCalendarDays(monthDate) {
  const start = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const offset = (start.getDay() + 6) % 7;
  start.setDate(start.getDate() - offset);
  const days = [];
  for (let i = 0; i < 42; i++) {
    const cell = new Date(start);
    cell.setDate(start.getDate() + i);
    days.push(cell);
  }
  return days;
}

function ensureSelectionInMonth() {
  const currentSelection = parseDate(selectedDate);
  if (!sameMonth(currentSelection, currentMonth)) {
    selectedDate = toYYYYMMDD(currentMonth);
  }
}

function calculateMonthlyStats(monthDate) {
  const firstDay = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const lastDay = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
  const totalDays = lastDay.getDate();
  const totals = { planned: 0, completed: 0 };
  const activeDays = new Set();
  const upcoming = [];
  const today = normalizeDate(new Date());

  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    if (!sameMonth(date, monthDate)) return;
    const normalized = normalizeDate(date);
    if (activities.length) activeDays.add(dateString);
    totals.planned += activities.length;
    activities.forEach(activity => {
      if (activity.completed) {
        totals.completed += 1;
      } else if (normalized >= today) {
        const goal = GOAL_DEFINITIONS[activity.type];
        if (!goal) return;
        let label = goal.label;
        if (activity.type !== 'gym' && activity.plannedValue) {
          label += ` • ${Number(activity.plannedValue).toLocaleString('pl-PL')} ${goal.unit}`;
        }
        upcoming.push({
          type: activity.type,
          label,
          badge: 'Trening',
          icon: goal.icon || 'activity',
          date: normalized,
          dateLabel: formatDateWithDay(normalized),
          relative: getRelativeLabel(normalized, today)
        });
      }
    });
  });

  Object.entries(state.extras).forEach(([dateString, extras]) => {
    const date = parseDate(dateString);
    if (!sameMonth(date, monthDate)) return;
    const normalized = normalizeDate(date);
    if (extras.length) activeDays.add(dateString);
    totals.planned += extras.length;
    extras.forEach(extra => {
      if (extra.completed) {
        totals.completed += 1;
      } else if (normalized >= today) {
        upcoming.push({
          type: 'extra',
          label: extra.title,
          badge: EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność',
          icon: 'sparkles',
          date: normalized,
          dateLabel: formatDateWithDay(normalized),
          relative: getRelativeLabel(normalized, today)
        });
      }
    });
  });

  upcoming.sort((a, b) => {
    const diff = a.date - b.date;
    if (diff !== 0) return diff;
    return a.type.localeCompare(b.type);
  });

  return {
    plannedCount: totals.planned,
    completedCount: totals.completed,
    activeDays: activeDays.size,
    totalDays,
    nextActivity: upcoming.length ? upcoming[0] : null,
    upcoming,
    range: { start: firstDay, end: lastDay }
  };
}

function calculateWeeklyGoalStats(referenceDate) {
  const base = referenceDate ? new Date(referenceDate) : new Date();
  const weekStart = startOfWeek(base);
  const weekEnd = addDays(weekStart, 6);
  const totals = { gym: 0, running: 0, reading: 0 };

  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    const normalized = normalizeDate(date);
    if (normalized < weekStart || normalized > weekEnd) return;
    activities.forEach(activity => {
      if (!activity || !GOAL_DEFINITIONS[activity.type] || !activity.completed) return;
      if (activity.type === 'gym') {
        totals.gym += 1;
      } else {
        const logged = Number(activity.loggedValue);
        const planned = Number(activity.plannedValue);
        const value = !Number.isNaN(logged) && logged > 0
          ? logged
          : (!Number.isNaN(planned) ? planned : 0);
        totals[activity.type] += value;
      }
    });
  });

  const goalPercents = {};
  Object.keys(GOAL_DEFINITIONS).forEach(type => {
    const progress = totals[type] || 0;
    const target = GOAL_DEFINITIONS[type].target;
    const percent = target > 0 ? Math.min(100, Math.round((progress / target) * 100)) : 0;
    goalPercents[type] = { percent, progress, target };
  });

  const averageGoalPercent = Math.round(
    Object.values(goalPercents).reduce((acc, info) => acc + info.percent, 0) /
    Object.keys(GOAL_DEFINITIONS).length
  ) || 0;

  return { goalPercents, averageGoalPercent, range: { start: weekStart, end: weekEnd } };
}

function calculateWeekCompletionToDate() {
  const today = normalizeDate(new Date());
  const info = getISOWeekInfo(today);
  const totalWeeks = Math.max(0, info.week - 1);
  let completedWeeks = 0;

  for (let week = 1; week < info.week; week++) {
    const weekStart = getISOWeekStart(info.year, week);
    const stats = calculateWeeklyGoalStats(weekStart);
    const goals = Object.values(stats.goalPercents || {});
    if (goals.length && goals.every(goal => Number(goal.percent || 0) >= 100)) {
      completedWeeks += 1;
    }
  }

  const percent = totalWeeks > 0 ? Math.round((completedWeeks / totalWeeks) * 100) : 0;
  return { completedWeeks, totalWeeks, percent, currentWeek: info.week, isoYear: info.year };
}

function getRelativeLabel(targetDate, today) {
  const diff = Math.round((targetDate.getTime() - today.getTime()) / DAY_MS);
  if (diff === 0) return 'Dziś';
  if (diff === 1) return 'Jutro';
  if (diff === 2) return 'Pojutrze';
  if (diff > 2 && diff < 7) return `Za ${diff} dni`;
  if (diff === -1) return 'Wczoraj';
  if (diff < -1 && diff > -7) return `${Math.abs(diff)} dni temu`;
  return targetDate.toLocaleDateString('pl-PL', { weekday: 'short', day: '2-digit', month: 'short' });
}

function calculateUpcomingWindow() {
  const today = normalizeDate(new Date());
  const horizon = addDays(today, 6);
  const items = [];

  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    const normalized = normalizeDate(date);
    if (normalized < today || normalized > horizon) return;
    activities.forEach(activity => {
      if (!activity || activity.completed) return;
      const goal = GOAL_DEFINITIONS[activity.type];
      if (!goal) return;
      let label = goal.label;
      if (activity.type !== 'gym' && activity.plannedValue) {
        label += ` • ${Number(activity.plannedValue).toLocaleString('pl-PL')} ${goal.unit}`;
      }
      items.push({
        type: activity.type,
        label,
        badge: 'Trening',
        icon: goal.icon || 'activity',
        date: normalized,
        dateLabel: formatDateWithDay(normalized),
        relative: getRelativeLabel(normalized, today)
      });
    });
  });

  Object.entries(state.extras).forEach(([dateString, extras]) => {
    const date = parseDate(dateString);
    const normalized = normalizeDate(date);
    if (normalized < today || normalized > horizon) return;
    extras.forEach(extra => {
      if (!extra || extra.completed) return;
      items.push({
        type: 'extra',
        label: extra.title,
        badge: EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność',
        icon: 'sparkles',
        date: normalized,
        dateLabel: formatDateWithDay(normalized),
        relative: getRelativeLabel(normalized, today)
      });
    });
  });

  items.sort((a, b) => {
    const diff = a.date - b.date;
    if (diff !== 0) return diff;
    return a.label.localeCompare(b.label);
  });

  return items;
}

function render() {
  ensureSelectionInMonth();
  const monthStats = calculateMonthlyStats(currentMonth);
  const weekStats = calculateWeeklyGoalStats(parseDate(selectedDate));
  const upcomingWindow = calculateUpcomingWindow();
  const yearStats = calculateWeekCompletionToDate();
  renderHeader(monthStats, weekStats, upcomingWindow, yearStats);
  renderCalendar();
  renderDayDetail();
  renderGoalProgress(weekStats.goalPercents);
  renderHeatmap();
  renderPlanningIndicator();
  lucide.createIcons();
}

function renderHeader(monthStats, weekStats, upcomingWindow, yearStats) {
  const monthLabel = formatMonth(currentMonth);
  document.getElementById('header-month-chip').textContent = monthLabel;
  document.getElementById('current-month-label').textContent = monthLabel;
  document.getElementById('current-month-range').textContent = `${formatRange(monthStats.range.start, monthStats.range.end)} ${currentMonth.getFullYear()}`;
  const todayButton = document.getElementById('today-month-btn');
  if (sameMonth(new Date(), currentMonth)) todayButton.style.display = 'none';
  else todayButton.style.display = 'inline-flex';
  const weeklyPercentLabel = `${weekStats.averageGoalPercent}%`;
  const goalProgressEl = document.getElementById('metric-goal-progress');
  if (goalProgressEl) goalProgressEl.textContent = weeklyPercentLabel;
  const heroGoalProgress = document.getElementById('hero-goal-progress');
  if (heroGoalProgress) heroGoalProgress.textContent = weeklyPercentLabel;
  const goalProgressSub = document.getElementById('metric-goal-progress-sub');
  const weeklyRange = weekStats && weekStats.range ? formatRange(weekStats.range.start, weekStats.range.end) : '--';
  if (goalProgressSub) {
    goalProgressSub.innerHTML = `<span class="metric-subline">Cele tygodniowe</span><span class="metric-subline">${weeklyRange}</span>`;
  }
  const heroGoalNote = document.getElementById('hero-goal-progress-note');
  if (heroGoalNote) heroGoalNote.textContent = `Cele tygodniowe — ${weeklyRange}`;
  const planCompletionLabel = `${monthStats.completedCount}/${monthStats.plannedCount}`;
  document.getElementById('metric-plan-completion').textContent = planCompletionLabel;
  document.getElementById('metric-active-days').textContent = `${monthStats.activeDays}/${monthStats.totalDays}`;
  const heroActiveDays = document.getElementById('hero-active-days');
  if (heroActiveDays) heroActiveDays.textContent = `${monthStats.activeDays}/${monthStats.totalDays}`;
  const heroActiveNote = document.getElementById('hero-active-days-note');
  if (heroActiveNote) heroActiveNote.textContent = `Ukończone ${monthStats.completedCount.toLocaleString('pl-PL')} działań`;
  const countEl = document.getElementById('metric-weekly-complete-count');
  if (countEl && yearStats) {
    const completedLabel = `${yearStats.completedWeeks.toLocaleString('pl-PL')}/${yearStats.totalWeeks.toLocaleString('pl-PL')}`;
    countEl.textContent = completedLabel;
  } else if (countEl) {
    countEl.textContent = '0/0';
  }
  const heroWeeklyCount = document.getElementById('hero-weekly-complete-count');
  if (heroWeeklyCount) {
    if (yearStats) {
      heroWeeklyCount.textContent = `${yearStats.completedWeeks.toLocaleString('pl-PL')}/${yearStats.totalWeeks.toLocaleString('pl-PL')}`;
    } else {
      heroWeeklyCount.textContent = '0/0';
    }
  }
  const subEl = document.getElementById('metric-weekly-complete-sub');
  if (subEl) {
    if (yearStats && yearStats.totalWeeks > 0) {
      const uptoWeek = Math.max(0, yearStats.currentWeek - 1);
      subEl.innerHTML = `<span class="metric-subline">Rok ${yearStats.isoYear}</span><span class="metric-subline">Do tygodnia ${uptoWeek.toLocaleString('pl-PL')}</span>`;
    } else if (yearStats) {
      subEl.innerHTML = `<span class="metric-subline">Rok ${yearStats.isoYear}</span><span class="metric-subline">Start sezonu</span>`;
    } else {
      subEl.innerHTML = `<span class="metric-subline">Rok --</span><span class="metric-subline">--</span>`;
    }
  }
  const percentEl = document.getElementById('metric-weekly-complete-percent');
  const heroWeeklyNote = document.getElementById('hero-weekly-complete-note');
  const value = yearStats ? yearStats.percent : 0;
  const formatted = Number(value).toLocaleString('pl-PL', { maximumFractionDigits: 0 });
  if (percentEl) {
    percentEl.textContent = `${formatted}%`;
  }
  if (heroWeeklyNote) heroWeeklyNote.textContent = `${formatted}% wykonania`;
  const circle = document.getElementById('metric-weekly-complete-circle');
  if (circle) {
    const safePercent = yearStats ? Math.max(0, Math.min(100, yearStats.percent)) : 0;
    const dashOffset = DONUT_CIRCUMFERENCE * (1 - safePercent / 100);
    circle.setAttribute('stroke-dasharray', DONUT_CIRCUMFERENCE);
    circle.setAttribute('stroke-dashoffset', dashOffset);
  }
  const metricNext = upcomingWindow && upcomingWindow.length ? upcomingWindow[0] : monthStats.nextActivity;
  const nextCard = document.getElementById('metric-next-activity-card');
  const nextVisual = document.getElementById('metric-next-activity-visual');
  const nextDate = document.getElementById('metric-next-activity-date');
  if (metricNext) {
    if (nextDate) nextDate.textContent = metricNext.relative || metricNext.dateLabel || 'Najbliższe dni';
    if (nextCard) nextCard.dataset.activityType = metricNext.type || 'none';
    if (nextVisual) nextVisual.innerHTML = `<i data-lucide="${metricNext.icon || 'calendar'}" class="icon"></i>`;
  } else {
    if (nextDate) nextDate.textContent = 'Brak terminu';
    if (nextCard) nextCard.dataset.activityType = 'none';
    if (nextVisual) nextVisual.innerHTML = '<i data-lucide="calendar-x" class="icon"></i>';
  }
}

function renderCalendar() {
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  const today = normalizeDate(new Date());
  const days = getCalendarDays(currentMonth);
  days.forEach(date => {
    const dateString = toYYYYMMDD(date);
    ensureDay(dateString);
    const activities = state.activities[dateString] || [];
    const extras = state.extras[dateString] || [];
    const vacationDay = isVacationDay(dateString);
    const plannedCount = activities.length + extras.length;
    const completedCount = activities.filter(a => a.completed).length + extras.filter(e => e.completed).length;
    const pendingCount = Math.max(0, plannedCount - completedCount);

    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    cell.dataset.date = dateString;
    cell.dataset.planned = String(plannedCount);
    cell.dataset.completed = String(completedCount);
    if (date.getMonth() !== currentMonth.getMonth()) cell.classList.add('calendar-day--other-month');
    if (dateString === selectedDate) cell.classList.add('calendar-day--selected');
    if (normalizeDate(date).getTime() === today.getTime()) cell.classList.add('calendar-day--today');
    if (vacationDay) cell.classList.add('calendar-day--vacation');
    if (!vacationDay && plannedCount === 0) cell.classList.add('calendar-day--empty');
    else if (plannedCount > 0 && completedCount === 0) cell.classList.add('calendar-day--planned');
    else if (plannedCount > 0) cell.classList.add('calendar-day--completed');

    const stateKey = vacationDay
      ? 'vacation'
      : (plannedCount === 0
        ? 'empty'
        : (completedCount === 0
          ? 'planned'
          : (completedCount >= plannedCount ? 'done' : 'progress')));
    cell.dataset.state = stateKey;

    let statusLabel = 'Plan';
    if (stateKey === 'vacation') statusLabel = 'Urlop';
    else if (stateKey === 'empty') statusLabel = 'Wolne';
    else if (stateKey === 'planned') statusLabel = 'Zaplanowano';
    else if (stateKey === 'progress') statusLabel = 'W toku';
    else if (stateKey === 'done') statusLabel = 'Zrealizowano';

    let tooltipSummary = '';
    if (stateKey === 'vacation') tooltipSummary = 'Urlop – dzień wolny od planów';
    else if (plannedCount === 0) tooltipSummary = 'Brak zaplanowanych aktywności';
    else {
      tooltipSummary = `${completedCount} z ${plannedCount} ukończonych`;
      if (pendingCount > 0) tooltipSummary += ` · ${pendingCount} otwarte`;
    }
    cell.title = tooltipSummary;
    if (tooltipSummary) {
      const ariaSummary = `${date.toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' })} · ${tooltipSummary}`;
      cell.setAttribute('aria-label', ariaSummary);
    }

    const header = document.createElement('div');
    header.className = 'calendar-day-header';
    const titleWrap = document.createElement('div');
    titleWrap.className = 'calendar-day-title';
    const weekday = document.createElement('span');
    weekday.className = 'calendar-day-weekday';
    weekday.textContent = date.toLocaleDateString('pl-PL', { weekday: 'short' }).replace('.', '').toUpperCase();
    titleWrap.appendChild(weekday);
    const number = document.createElement('span');
    number.className = 'calendar-date-number';
    number.textContent = date.getDate();
    titleWrap.appendChild(number);
    header.appendChild(titleWrap);
    const metaWrap = document.createElement('div');
    metaWrap.className = 'calendar-day-meta';
    const status = document.createElement('span');
    status.className = 'calendar-day-status';
    status.dataset.state = stateKey;
    status.textContent = statusLabel;
    metaWrap.appendChild(status);
    const badges = document.createElement('div');
    badges.className = 'calendar-day-badges';
    if (plannedCount > 0) {
      const badge = document.createElement('span');
      badge.className = 'calendar-badge';
      badge.textContent = plannedCount;
      badge.title = 'Liczba zaplanowanych aktywności';
      badge.setAttribute('aria-label', `${plannedCount} zaplanowanych aktywności`);
      badges.appendChild(badge);
    }
    if (badges.childElementCount > 0) {
      metaWrap.appendChild(badges);
    }
    header.appendChild(metaWrap);
    cell.appendChild(header);

    const tags = document.createElement('div');
    tags.className = 'calendar-day-tags';
    const tagItems = [];
    activities.forEach(activity => {
      tagItems.push({
        type: activity.type,
        text: getActivityTagText(activity),
        tooltip: formatPlanningSummary(activity.type, activity.plannedValue || activity.loggedValue),
        itemType: 'activity',
        id: activity.id,
        draggable: true
      });
    });
    extras.forEach(extra => {
      tagItems.push({
        type: 'extra',
        text: getExtraTagText(extra),
        tooltip: (extra.title || '').trim() || EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność dodatkowa',
        itemType: 'extra',
        id: extra.id,
        draggable: true
      });
    });
    if (vacationDay) {
      tagItems.unshift({
        type: 'vacation',
        text: 'Urlop',
        tooltip: 'Dzień wolny od planów',
        draggable: false
      });
    }
    tagItems.slice(0, MAX_CALENDAR_TAGS).forEach(tag => {
      const pill = document.createElement('span');
      pill.className = `activity-tag ${tag.type}`;
      pill.textContent = tag.text;
      pill.title = tag.tooltip || tag.text;
      if (tag.draggable !== false && tag.itemType && tag.id) {
        enableDrag(pill, { itemType: tag.itemType, id: tag.id, sourceDate: dateString });
      }
      tags.appendChild(pill);
    });
    if (tagItems.length > MAX_CALENDAR_TAGS) {
      const more = document.createElement('span');
      more.className = 'activity-tag more';
      more.textContent = `+${tagItems.length - MAX_CALENDAR_TAGS}`;
      more.title = 'Więcej zaplanowanych aktywności';
      tags.appendChild(more);
    }
    cell.appendChild(tags);

    if (plannedCount > 0 || vacationDay) {
      const progress = document.createElement('div');
      progress.className = 'calendar-progress';
      const fill = document.createElement('div');
      fill.className = 'calendar-progress-fill';
      fill.dataset.state = stateKey;
      const ratio = plannedCount > 0 ? Math.min(1, Math.max(0, completedCount / plannedCount)) : 0;
      const width = stateKey === 'vacation' ? 1 : ratio;
      fill.style.width = `${Math.round(width * 100)}%`;
      progress.appendChild(fill);
      cell.appendChild(progress);
    }

    const footer = document.createElement('div');
    footer.className = 'calendar-day-footer';
    const done = document.createElement('span');
    done.className = 'calendar-footer-label';
    done.textContent = vacationDay && plannedCount === 0 ? 'Urlop' : `${completedCount} ukończ.`;
    const remaining = document.createElement('span');
    remaining.className = 'calendar-footer-remaining';
    remaining.textContent = pendingCount > 0 ? `${pendingCount} otwarte` : '';
    footer.appendChild(done);
    footer.appendChild(remaining);
    cell.appendChild(footer);

    const handleDragTarget = (event) => {
      const payload = resolveDragPayload(event);
      if (!payload || payload.sourceDate === dateString) return;
      event.preventDefault();
      cell.classList.add('calendar-day--drag-over');
      if (event.dataTransfer) event.dataTransfer.dropEffect = 'move';
    };

    cell.addEventListener('dragover', handleDragTarget);
    cell.addEventListener('dragenter', handleDragTarget);
    cell.addEventListener('dragleave', (event) => {
      if (event.relatedTarget && cell.contains(event.relatedTarget)) return;
      cell.classList.remove('calendar-day--drag-over');
    });
    cell.addEventListener('drop', (event) => {
      event.preventDefault();
      cell.classList.remove('calendar-day--drag-over');
      const payload = resolveDragPayload(event);
      if (!payload || payload.sourceDate === dateString) return;
      movePlannedItem(payload, dateString);
    });

    cell.addEventListener('click', () => {
      selectedDate = dateString;
      if (!sameMonth(date, currentMonth)) {
        currentMonth = startOfMonth(date);
      }
      if (isPlanningActive()) {
        addTraining(dateString, planningMode.type, planningMode.plannedValue);
        return;
      }
      render();
    });

    grid.appendChild(cell);
  });
}

function renderPlanningIndicator() {
  const banner = document.getElementById('planning-banner');
  const title = document.getElementById('planning-banner-title');
  const meta = document.getElementById('planning-banner-meta');
  const calendarCard = document.querySelector('.calendar-card');
  const grid = document.getElementById('calendar-grid');
  const addBtn = document.getElementById('add-training-btn');
  if (!banner || !title || !meta || !calendarCard || !grid || !addBtn) return;

  if (isPlanningActive()) {
    const summary = formatPlanningSummary(planningMode.type, planningMode.plannedValue);
    banner.classList.add('active');
    title.textContent = summary;
    meta.textContent = 'Klikaj dni w kalendarzu, aby dodać ten trening. Zakończ, gdy skończysz planować.';
    calendarCard.classList.add('calendar-card--planning');
    grid.classList.add('is-planning');
    addBtn.innerHTML = '<i data-lucide="x" class="icon"></i>Zakończ planowanie';
    addBtn.classList.add('ghost');
  } else {
    banner.classList.remove('active');
    title.textContent = 'Tryb planowania';
    meta.textContent = DEFAULT_PLANNING_META;
    calendarCard.classList.remove('calendar-card--planning');
    grid.classList.remove('is-planning');
    addBtn.innerHTML = '<i data-lucide="plus" class="icon"></i>Zaplanuj treningi';
    addBtn.classList.remove('ghost');
  }
}

function renderDayDetail() {
  ensureDay(selectedDate);
  const date = parseDate(selectedDate);
  const activities = state.activities[selectedDate] || [];
  const extras = state.extras[selectedDate] || [];
  const vacationDay = isVacationDay(selectedDate);
  const completedCount = activities.filter(a => a.completed).length + extras.filter(e => e.completed).length;
  const total = activities.length + extras.length;
  document.getElementById('selected-day-title').textContent = date.toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' });
  const summary = vacationDay
    ? (total > 0
      ? `Urlop · Zaplanowane: ${total} · Ukończone: ${completedCount}`
      : 'Dzień urlopowy. Nie planujesz aktywności.')
    : (total > 0
      ? `Zaplanowane: ${total} · Ukończone: ${completedCount}`
      : 'Brak zaplanowanych aktywności na ten dzień.');
  document.getElementById('selected-day-summary').textContent = summary;
  document.getElementById('selected-day-chip').textContent = date.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' }).replace('.', '').toUpperCase();
  const vacationNote = document.getElementById('vacation-note');
  if (vacationNote) vacationNote.style.display = vacationDay ? 'block' : 'none';
  const vacationBtn = document.getElementById('toggle-vacation-btn');
  if (vacationBtn) {
    if (vacationDay) {
      vacationBtn.classList.add('active');
      vacationBtn.innerHTML = '<i data-lucide="sun" class="icon"></i>Usuń urlop';
    } else {
      vacationBtn.classList.remove('active');
      vacationBtn.innerHTML = '<i data-lucide="plane" class="icon"></i>Oznacz urlop';
    }
  }

  renderDayActivities(activities);
  renderDayExtras(extras);
}

function renderDayActivities(activities) {
  const list = document.getElementById('day-plan-list');
  const empty = document.getElementById('day-plan-empty');
  const count = document.getElementById('day-plan-count');
  const meta = document.getElementById('day-plan-meta');
  const panel = document.getElementById('plan-training-panel');
  list.innerHTML = '';
  if (!activities.length) {
    empty.style.display = 'block';
    if (count) count.textContent = '0';
    if (meta) meta.textContent = 'Brak zaplanowanych treningów';
    if (panel) {
      panel.classList.add('is-empty');
      panel.open = false;
      panel.removeAttribute('data-user-collapsed');
    }
    return;
  }
  empty.style.display = 'none';
  if (count) count.textContent = activities.length.toString();
  const completed = activities.filter(activity => activity.completed).length;
  if (meta) meta.textContent = `${completed}/${activities.length} ukończone`;
  if (panel) {
    panel.classList.remove('is-empty');
    if (panel.dataset.userCollapsed === 'true') {
      panel.open = false;
    } else {
      panel.open = true;
    }
  }

  activities.forEach(activity => {
    const goal = GOAL_DEFINITIONS[activity.type];
    const item = document.createElement('div');
    item.className = 'detail-item';
    if (activity.completed) item.classList.add('completed');
    const plannedInfo = activity.type === 'gym' ? 'Sesja siłowa' : (activity.plannedValue ? `Plan: ${Number(activity.plannedValue).toLocaleString('pl-PL')} ${goal.unit}` : 'Plan: brak');
    let progressInfo = '';
    if (activity.completed) {
      if (activity.type === 'gym') progressInfo = 'Sesja zakończona';
      else progressInfo = `Zrealizowano: ${Number(activity.loggedValue).toLocaleString('pl-PL')} ${goal.unit}`;
    }
    const metaText = [plannedInfo, progressInfo].filter(Boolean).join(' · ');
    item.innerHTML = `
      <div class="detail-info">
        <div class="detail-icon ${activity.type}"><i data-lucide="${goal.icon}" class="icon"></i></div>
        <div>
          <div class="detail-title">${goal.label}</div>
          <div class="detail-meta">${metaText}</div>
        </div>
      </div>
      <div class="detail-actions-inline">
        ${activity.completed ? `<button class="action-btn" data-action="undo-activity" data-day="${selectedDate}" data-activity-id="${activity.id}">Cofnij</button>` : `<button class="action-btn primary" data-action="complete-activity" data-day="${selectedDate}" data-type="${activity.type}" data-activity-id="${activity.id}">${activity.type === 'gym' ? 'Oznacz wykonane' : 'Zaloguj wynik'}</button>`}
        ${activity.type !== 'gym' ? `<button class="action-btn" data-action="edit-activity" data-day="${selectedDate}" data-activity-id="${activity.id}">Edytuj wynik</button>` : ''}
        <button class="action-btn danger" data-action="delete-activity" data-day="${selectedDate}" data-activity-id="${activity.id}">Usuń</button>
      </div>
    `;
    enableDrag(item, { itemType: 'activity', id: activity.id, sourceDate: selectedDate });
    list.appendChild(item);
  });
}

function renderDayExtras(extras) {
  const list = document.getElementById('day-extra-list');
  const empty = document.getElementById('day-extra-empty');
  const count = document.getElementById('day-extra-count');
  const meta = document.getElementById('day-extra-meta');
  const panel = document.getElementById('plan-extra-panel');
  list.innerHTML = '';
  if (!extras.length) {
    empty.style.display = 'block';
    if (count) count.textContent = '0';
    if (meta) meta.textContent = 'Nic zaplanowanego';
    if (panel) {
      panel.classList.add('is-empty');
      panel.open = false;
      panel.removeAttribute('data-user-collapsed');
    }
    return;
  }
  empty.style.display = 'none';
  if (count) count.textContent = extras.length.toString();
  const completed = extras.filter(extra => extra.completed).length;
  if (meta) meta.textContent = `${completed}/${extras.length} ukończone`;
  if (panel) {
    panel.classList.remove('is-empty');
    if (panel.dataset.userCollapsed === 'true') {
      panel.open = false;
    } else {
      panel.open = true;
    }
  }
  extras.forEach(extra => {
    const item = document.createElement('div');
    item.className = 'detail-item';
    if (extra.completed) item.classList.add('completed');
    item.innerHTML = `
      <div class="detail-info">
        <div class="detail-icon extra"><i data-lucide="sparkles" class="icon"></i></div>
        <div>
          <div class="detail-title">${extra.title}</div>
          <div class="detail-meta">${EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność'}</div>
        </div>
      </div>
      <div class="detail-actions-inline">
        <button class="action-btn ${extra.completed ? '' : 'success'}" data-action="toggle-extra" data-day="${selectedDate}" data-extra-id="${extra.id}">${extra.completed ? 'Cofnij' : 'Zakończ'}</button>
        <button class="action-btn danger" data-action="delete-extra" data-day="${selectedDate}" data-extra-id="${extra.id}">Usuń</button>
      </div>
    `;
    enableDrag(item, { itemType: 'extra', id: extra.id, sourceDate: selectedDate });
    list.appendChild(item);
  });
}

function renderGoalProgress(goalPercents) {
  const container = document.getElementById('goal-progress-list');
  if (!container) return;
  container.innerHTML = '';
  if (!goalPercents) return;
  const emojiMap = { gym: '🏋️', running: '🏃', reading: '📚' };
  Object.entries(goalPercents).forEach(([type, info]) => {
    const def = GOAL_DEFINITIONS[type];
    if (!def) return;
    const item = document.createElement('div');
    item.className = 'goal-progress-item kpi-compact';
    const progressValue = Number(info.progress || 0).toLocaleString('pl-PL');
    const targetValue = Number((info && info.target) || def.target || 0).toLocaleString('pl-PL');
    item.innerHTML = `
      <span class="kpi-emoji">${emojiMap[type] || '🏅'}</span>
      <div class="goal-progress-body">
        <div class="kpi-label">${def.label}</div>
        <div class="kpi-value">${info.percent}%</div>
        <div class="tiny muted">${progressValue} / ${targetValue} ${def.unit}</div>
      </div>
    `;
    container.appendChild(item);
  });
}

function getHeatLevel(value) {
  if (value >= 5) return 4;
  if (value >= 3) return 3;
  if (value >= 2) return 2;
  if (value >= 1) return 1;
  return 0;
}

function renderHeatmap() {
  const container = document.getElementById('heatmap');
  container.innerHTML = '';
  const year = currentMonth.getFullYear();
  document.getElementById('heatmap-year-label').textContent = year;
  const counts = {};
  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    if (date.getFullYear() !== year) return;
    const completed = activities.filter(a => a.completed).length;
    if (completed > 0) counts[dateString] = (counts[dateString] || 0) + completed;
  });
  Object.entries(state.extras).forEach(([dateString, extras]) => {
    const date = parseDate(dateString);
    if (date.getFullYear() !== year) return;
    const completed = extras.filter(e => e.completed).length;
    if (completed > 0) counts[dateString] = (counts[dateString] || 0) + completed;
  });

  const start = new Date(year, 0, 1);
  const offset = (start.getDay() + 6) % 7;
  start.setDate(start.getDate() - offset);
  for (let week = 0; week < 53; week++) {
    const column = document.createElement('div');
    column.className = 'heatmap-week';
    const weekStart = new Date(start);
    weekStart.setDate(start.getDate() + week * 7);
    for (let day = 0; day < 7; day++) {
      const current = new Date(weekStart);
      current.setDate(weekStart.getDate() + day);
      const key = toYYYYMMDD(current);
      const cell = document.createElement('div');
      cell.className = 'heatmap-cell';
      if (current.getFullYear() === year) {
        const value = counts[key] || 0;
        const level = getHeatLevel(value);
        cell.dataset.level = level;
        const label = current.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' });
        cell.title = value > 0 ? `${label}: ${value} ukończone aktywności` : label;
      } else {
        cell.classList.add('heatmap-cell--empty');
      }
      column.appendChild(cell);
    }
    const label = document.createElement('span');
    label.className = 'heatmap-month-label';
    if (weekStart.getFullYear() === year) {
      label.textContent = weekStart.toLocaleDateString('pl-PL', { month: 'short' }).replace('.', '').toUpperCase();
      label.title = `${formatRange(weekStart, addDays(weekStart, 6))} ${weekStart.getFullYear()}`;
    } else {
      label.textContent = '';
    }
    column.appendChild(label);
    container.appendChild(column);
  }
}

function addTraining(dateString, type, plannedValue) {
  ensureDay(dateString);
  state.activities[dateString].push({
    id: `act_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    type,
    plannedValue: type === 'gym' ? 1 : Number(plannedValue) || 0,
    loggedValue: 0,
    completed: false,
    createdAt: Date.now()
  });
  if (state.vacations && state.vacations[dateString]) delete state.vacations[dateString];
  saveState();
  render();
}

function addExtra(dateString, title, category) {
  ensureDay(dateString);
  state.extras[dateString].push({
    id: `extra_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    title,
    category,
    completed: false,
    createdAt: Date.now()
  });
  if (state.vacations && state.vacations[dateString]) delete state.vacations[dateString];
  saveState();
  render();
}

function completeActivity(day, id) {
  const activities = state.activities[day] || [];
  const activity = activities.find(a => a.id === id);
  if (!activity) return;
  if (activity.type === 'gym') {
    activity.completed = true;
    activity.loggedValue = 1;
    saveState();
    render();
  } else {
    showLogModal(activity, day);
  }
}

function showLogModal(activity, day) {
  const goal = GOAL_DEFINITIONS[activity.type];
  showModal({
    title: `Zaloguj ${goal.label.toLowerCase()}`,
    text: `Podaj zrealizowaną wartość dla ${formatDateWithDay(parseDate(day))}.`,
    input: { type: 'number', value: activity.loggedValue || activity.plannedValue || '', placeholder: `Wartość w ${goal.unit}`, min: '0', step: '1' },
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Zapisz', class: 'btn', action: (value) => {
          const numeric = Number(value);
          if (!numeric || numeric <= 0) return false;
          activity.loggedValue = numeric;
          activity.completed = true;
          saveState();
          render();
        } }
    ]
  });
}

function editActivity(day, id) {
  const activity = (state.activities[day] || []).find(a => a.id === id);
  if (!activity || activity.type === 'gym') return;
  showLogModal(activity, day);
}

function undoActivity(day, id) {
  const activity = (state.activities[day] || []).find(a => a.id === id);
  if (!activity) return;
  activity.completed = false;
  activity.loggedValue = 0;
  saveState();
  render();
}

function deleteActivity(day, id) {
  if (!state.activities[day]) return;
  state.activities[day] = state.activities[day].filter(a => a.id !== id);
  saveState();
  render();
}

function toggleExtra(day, id) {
  const extra = (state.extras[day] || []).find(e => e.id === id);
  if (!extra) return;
  extra.completed = !extra.completed;
  saveState();
  render();
}

function deleteExtra(day, id) {
  if (!state.extras[day]) return;
  state.extras[day] = state.extras[day].filter(e => e.id !== id);
  saveState();
  render();
}

function showAddTrainingModal() {
  const date = parseDate(selectedDate);
  showModal({
    title: 'Zaplanuj trening',
    text: `Dodaj aktywność na ${date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' })}.`,
    input: { type: 'number', placeholder: 'Docelowa wartość', min: '0', step: '1' },
    options: [
      { value: 'gym', label: 'Trening siłowy', checked: true },
      { value: 'running', label: 'Bieganie' },
      { value: 'reading', label: 'Czytanie' }
    ],
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Planowanie wielu dni', class: 'btn ghost', action: (value, selected) => {
          const type = selected || 'gym';
          if (type !== 'gym') {
            const numeric = Number(value);
            if (!numeric || numeric <= 0) return false;
            startPlanningMode(type, numeric);
          } else {
            startPlanningMode(type, 1);
          }
        } },
      { text: 'Dodaj', class: 'btn', action: (value, selected) => {
          const type = selected || 'gym';
          if (type !== 'gym') {
            const numeric = Number(value);
            if (!numeric || numeric <= 0) return false;
            addTraining(selectedDate, type, numeric);
          } else {
            addTraining(selectedDate, type, 1);
          }
        } }
    ],
    onShow: ({ overlay, input }) => {
      const radios = overlay.querySelectorAll('input[name="modal-option"]');
      const update = () => {
        const type = overlay.querySelector('input[name="modal-option"]:checked')?.value;
        if (!input) return;
        if (type === 'gym') {
          input.value = '';
          input.placeholder = 'Sesja siłowa – bez dodatkowej wartości';
          input.disabled = true;
        } else if (type === 'running') {
          input.disabled = false;
          input.placeholder = 'Cel w kilometrach';
        } else if (type === 'reading') {
          input.disabled = false;
          input.placeholder = 'Cel w stronach';
        }
      };
      update();
      radios.forEach(radio => radio.addEventListener('change', update));
    }
  });
}

function showAddExtraModal() {
  const date = parseDate(selectedDate);
  showModal({
    title: 'Dodaj aktywność dodatkową',
    text: `Dodaj drobne działanie na ${date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' })}.`,
    textarea: { placeholder: 'Opis aktywności' },
    options: EXTRA_ACTIVITY_CATEGORIES.map((cat, index) => ({ value: cat.value, label: cat.label, checked: index === 0 })),
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Dodaj', class: 'btn', action: (value, selected) => {
          const textValue = (value || '').trim();
          if (!textValue) return false;
          addExtra(selectedDate, textValue, selected || 'other');
        } }
    ]
  });
}

function showVacationRangeModal() {
  showModal({
    title: 'Plan urlopu',
    text: 'Oznacz cały zakres dat jako urlop, aby kalendarz uwzględnił przerwę.',
    inputs: [
      { type: 'date', value: selectedDate, label: 'Początek urlopu', key: 'start' },
      { type: 'date', value: selectedDate, label: 'Koniec urlopu', key: 'end' }
    ],
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Zapisz', class: 'btn', action: (value) => {
          if (!value || !value.start || !value.end) return false;
          if (value.end < value.start) return false;
          planVacationRange(value.start, value.end);
        } }
    ],
    onShow: ({ inputs }) => {
      if (!inputs || inputs.length < 2) return;
      const [startField, endField] = inputs;
      if (!startField || !endField) return;
      endField.min = startField.value;
      endField.addEventListener('change', () => {
        if (endField.value < startField.value) {
          endField.value = startField.value;
        }
      });
      startField.addEventListener('change', () => {
        if (endField.value < startField.value) {
          endField.value = startField.value;
        }
        endField.min = startField.value;
      });
    }
  });
}

function showModal(config) {
  const overlay = document.getElementById('modal-overlay');
  document.getElementById('modal-title').textContent = config.title || '';
  document.getElementById('modal-text').innerHTML = config.text || '';
  const inputContainer = document.getElementById('modal-input-container');
  const optionsContainer = document.getElementById('modal-options-container');
  const actions = document.getElementById('modal-actions');
  inputContainer.innerHTML = '';
  optionsContainer.innerHTML = '';
  actions.innerHTML = '';

  const inputConfigs = [];
  if (Array.isArray(config.inputs)) inputConfigs.push(...config.inputs);
  if (config.input) inputConfigs.push(config.input);

  inputConfigs.forEach(inputConfig => {
    const wrapper = document.createElement('div');
    wrapper.className = 'modal-field';
    if (inputConfig.label) {
      const label = document.createElement('span');
      label.className = 'modal-field-label';
      label.textContent = inputConfig.label;
      wrapper.appendChild(label);
    }
    const input = document.createElement('input');
    input.type = inputConfig.type || 'text';
    if (inputConfig.placeholder) input.placeholder = inputConfig.placeholder;
    if (inputConfig.value !== undefined) input.value = inputConfig.value;
    if (inputConfig.min !== undefined) input.min = inputConfig.min;
    if (inputConfig.max !== undefined) input.max = inputConfig.max;
    if (inputConfig.step !== undefined) input.step = inputConfig.step;
    if (inputConfig.disabled) input.disabled = true;
    if (inputConfig.required) input.required = true;
    input.autocomplete = 'off';
    input.dataset.modalInput = 'true';
    if (inputConfig.key) input.dataset.modalKey = inputConfig.key;
    if (inputConfig.name) input.name = inputConfig.name;
    wrapper.appendChild(input);
    inputContainer.appendChild(wrapper);
  });

  if (config.textarea) {
    const wrapper = document.createElement('div');
    wrapper.className = 'modal-field';
    if (config.textarea.label) {
      const label = document.createElement('span');
      label.className = 'modal-field-label';
      label.textContent = config.textarea.label;
      wrapper.appendChild(label);
    }
    const textarea = document.createElement('textarea');
    textarea.placeholder = config.textarea.placeholder || '';
    textarea.value = config.textarea.value || '';
    textarea.rows = config.textarea.rows || 4;
    textarea.autocomplete = 'off';
    textarea.dataset.modalInput = 'true';
    if (config.textarea.key) textarea.dataset.modalKey = config.textarea.key;
    wrapper.appendChild(textarea);
    inputContainer.appendChild(wrapper);
  }

  if (config.options) {
    const optionsDiv = document.createElement('div');
    optionsDiv.className = 'modal-options';
    config.options.forEach(opt => {
      const label = document.createElement('label');
      label.className = 'option-label';
      label.innerHTML = `<input type="radio" name="modal-option" value="${opt.value}" ${opt.checked ? 'checked' : ''}> <span>${opt.label}</span>`;
      optionsDiv.appendChild(label);
    });
    optionsContainer.appendChild(optionsDiv);
  }

  config.buttons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.text;
    button.className = btn.class;
    button.addEventListener('click', () => {
      if (btn.action === 'close') {
        overlay.classList.remove('visible');
        return;
      }
      const fields = Array.from(inputContainer.querySelectorAll('[data-modal-input]'));
      const selectedOption = optionsContainer.querySelector('input[name="modal-option"]:checked')?.value;
      let value = '';
      if (fields.length === 1) {
        value = fields[0].value;
      } else if (fields.length > 1) {
        value = {};
        fields.forEach((field, index) => {
          const key = field.dataset.modalKey || field.name || `field${index + 1}`;
          value[key] = field.value;
        });
      }
      const result = btn.action(value, selectedOption);
      if (result === false) return;
      overlay.classList.remove('visible');
    });
    actions.appendChild(button);
  });

  overlay.classList.add('visible');
  if (typeof config.onShow === 'function') {
    const inputs = Array.from(inputContainer.querySelectorAll('[data-modal-input]'));
    config.onShow({ overlay, input: inputs[0] || null, inputs, optionsContainer, inputContainer });
  }
  const focusTarget = inputContainer.querySelector('[data-modal-input]');
  if (focusTarget && !focusTarget.disabled) focusTarget.focus();
}

function setupEventListeners() {
  document.getElementById('prev-month-btn').addEventListener('click', () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
    render();
  });
  document.getElementById('next-month-btn').addEventListener('click', () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
    render();
  });
  document.getElementById('today-month-btn').addEventListener('click', () => {
    const today = new Date();
    currentMonth = startOfMonth(today);
    selectedDate = toYYYYMMDD(today);
    render();
  });
  document.getElementById('add-training-btn').addEventListener('click', () => {
    if (isPlanningActive()) {
      stopPlanningMode();
    } else {
      showAddTrainingModal();
    }
  });
  document.getElementById('stop-planning-btn').addEventListener('click', () => stopPlanningMode());
  document.getElementById('add-extra-btn').addEventListener('click', showAddExtraModal);
  document.getElementById('plan-vacation-range-btn').addEventListener('click', showVacationRangeModal);
  document.getElementById('toggle-vacation-btn').addEventListener('click', () => toggleVacationDay(selectedDate));

  document.getElementById('day-plan-list').addEventListener('click', (event) => {
    const target = event.target.closest('[data-action]');
    if (!target) return;
    const day = target.dataset.day;
    const id = target.dataset.activityId;
    const action = target.dataset.action;
    if (action === 'complete-activity') completeActivity(day, id);
    if (action === 'undo-activity') undoActivity(day, id);
    if (action === 'delete-activity') deleteActivity(day, id);
    if (action === 'edit-activity') editActivity(day, id);
  });

  document.getElementById('day-extra-list').addEventListener('click', (event) => {
    const target = event.target.closest('[data-action]');
    if (!target) return;
    const day = target.dataset.day;
    const id = target.dataset.extraId;
    const action = target.dataset.action;
    if (action === 'toggle-extra') toggleExtra(day, id);
    if (action === 'delete-extra') deleteExtra(day, id);
  });

  document.querySelectorAll('.plan-panel').forEach(panel => {
    panel.addEventListener('toggle', () => {
      if (panel.open) {
        panel.removeAttribute('data-user-collapsed');
      } else if (!panel.classList.contains('is-empty')) {
        panel.dataset.userCollapsed = 'true';
      }
    });
  });

  document.getElementById('modal-overlay').addEventListener('click', (event) => {
    if (event.target === event.currentTarget) {
      event.currentTarget.classList.remove('visible');
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  loadState();
  ensureDay(selectedDate);
  render();
  setupEventListeners();
});
</script>
</body>
</html>