<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS ‚Äì Trainings & Analytics</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
:root {
  --bg-alt: var(--surface);
  --primary: var(--accent);
  --primary-soft: var(--accent-weak);
  --primary-border: hsl(var(--accent-h) 55% 80% / 0.7);
  --success: var(--green);
  --success-soft: #f0fdf4;
  --success-border: #bbf7d0;
  --warning: var(--orange);
  --danger: var(--red);
  --danger-soft: #fef2f2;
  --danger-border: #fecaca;
  --warning-soft: #fffbeb;
  --warning-border: #fde68a;
  --shadow-sm: 0 12px 30px rgba(15, 23, 42, 0.08);
  --shadow-lg: 0 28px 60px rgba(15, 23, 42, 0.12);
  --transition: all .2s ease;
  --gym-color: hsl(265, 65%, 48%);
  --run-color: var(--green);
  --read-color: var(--accent);
  --extra-color: #0ea5e9;
  --vacation-color: #64748b;
}

.page-content {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.month-switcher {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.month-switcher .month-labels {
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: center;
  min-width: 140px;
}

.month-switcher .month-label {
  font-size: 18px;
  font-weight: 700;
  text-transform: capitalize;
}

.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: var(--surface);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition);
}

.icon-btn .icon {
  width: 18px;
  height: 18px;
}

.icon-btn:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
  border-color: hsl(var(--accent-h) 45% 75%);
}

.btn.icon-btn {
  width: 40px;
  height: 40px;
  padding: 0;
}

.btn.icon-btn .icon {
  width: 18px;
  height: 18px;
}

.icon { width: 16px; height: 16px; }

.month-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; background: var(--primary-soft); color: var(--accent); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; }

.card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
.card-header p { margin-top: 4px; }

.muted { color: var(--muted); }
.tiny { font-size: 11px; letter-spacing: 0.02em; }


/* New Activity Hub Styles */
.activity-hub {
  display: grid;
  grid-template-columns: minmax(0, 1.5fr) minmax(320px, 1fr);
  gap: 20px;
  align-items: flex-start;
  min-height: 520px;
}

.calendar-wrapper {
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 100%;
}

.calendar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  padding-bottom: 4px;
}

.calendar-header h3 { font-size: 16px; font-weight: 700; }
.calendar-legend { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; font-size: 11px; color: var(--muted); }
.calendar-legend span { display: inline-flex; align-items: center; gap: 6px; font-weight: 500;}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
  color: var(--muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-weight: 600;
  padding: 0 4px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
  grid-auto-rows: minmax(80px, 1fr);
  flex: 1;
}

.calendar-day {
  background: var(--surface);
  border-radius: 14px;
  border: 1px solid var(--line);
  padding: 8px;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}

.calendar-day:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); transform: translateY(-2px); }
.calendar-day.is-other-month { opacity: 0.5; background: transparent; border-color: transparent; }
.calendar-day.is-other-month:hover { opacity: 1; background: var(--surface); border-color: var(--primary); }
.calendar-day.is-selected { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
.calendar-day.is-today .calendar-date-number { border-color: var(--success); color: var(--success); }
.calendar-day.is-vacation { 
  background-color: #f8fafc; 
  border-color: #e2e8f0;
  background-image: repeating-linear-gradient(-45deg, transparent, transparent 4px, rgba(100, 116, 139, 0.07) 4px, rgba(100, 116, 139, 0.07) 8px);
}
.calendar-day.is-planned { background: var(--warning-soft); border-color: var(--warning-border); }
.calendar-day.is-completed { background: var(--success-soft); border-color: var(--success-border); }
.calendar-day.is-missed { background: var(--danger-soft); border-color: var(--danger-border); }
.calendar-day.is-drag-over { outline: 2px dashed var(--primary); outline-offset: 3px; background: var(--primary-soft); }
.calendar-grid.is-planning .calendar-day:not(.is-other-month) { cursor: crosshair; }

.calendar-date-number {
  font-weight: 600;
  font-size: 13px;
  line-height: 1;
  border: 1px solid transparent;
  display: inline-block;
  padding: 2px;
  border-radius: 6px;
}

.calendar-day-emojis {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  min-height: 28px;
  font-size: 20px;
}
.activity-emoji {
  opacity: 1;
  transition: opacity 0.2s ease;
}
.activity-emoji.completed {
  opacity: 0.4;
}
.activity-emoji[draggable="true"] {
    cursor: grab;
}
.activity-emoji.is-dragging {
    opacity: 0.2;
    transform: scale(1.5);
}

.calendar-day-footer {
  margin-top: auto;
  display: flex;
  justify-content: flex-end;
}

.completion-badge {
  font-size: 9px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 999px;
  color: #fff;
  background-color: var(--muted);
  opacity: 0;
  transition: var(--transition);
}
.calendar-day:hover .completion-badge,
.calendar-day.is-selected .completion-badge {
  opacity: 1;
}
.completion-badge.is-done { background-color: var(--success); }
.completion-badge.in-progress { background-color: var(--warning); }


/* Day Detail Panel Styles */
.day-detail {
  background: var(--surface);
  border-radius: 18px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  height: 100%;
  min-height: 520px;
}

.day-detail-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  gap: 12px;
  height: 100%;
  color: var(--muted);
}
.day-detail-placeholder .icon { width: 40px; height: 40px; color: rgba(148, 163, 184, 0.4); }

.day-detail-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
.day-detail-title h3 { font-size: 18px; font-weight: 700; }
.day-detail-title p { font-size: 12px; color: var(--muted); margin-top: 2px; }
.day-detail-meta { display: flex; gap: 8px; }
.day-detail-meta .btn { padding: 8px; font-size: 11px; }

.day-detail-body {
  display: flex;
  flex-direction: column;
  gap: 20px;
  flex: 1;
  overflow-y: auto;
  min-height: 0;
  padding-right: 4px;
}
.vacation-note {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
  background: #f8fafc;
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 10px 12px;
}
.vacation-note .icon { width: 18px; height: 18px; color: var(--vacation-color); }

.detail-block { display: flex; flex-direction: column; gap: 10px; }
.detail-block-header { 
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600; 
  font-size: 11px; 
  text-transform: uppercase; 
  letter-spacing: 0.08em; 
  color: var(--muted); 
  padding: 0 4px; 
}
.detail-list { display: flex; flex-direction: column; gap: 8px; }
.quick-add-list { display: flex; flex-wrap: wrap; gap: 8px; }
.quick-add-btn {
  background: #f8fafc;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}
.quick-add-btn:hover {
  background: #fff;
  border-color: var(--primary);
  color: var(--primary);
  box-shadow: var(--shadow-sm);
}


.detail-item {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: #f8fafc;
  transition: var(--transition);
}
.detail-item[draggable="true"] { cursor: grab; }
.detail-item.is-dragging { opacity: 0.4; cursor: grabbing; background: var(--primary-soft); }
.detail-item:hover { border-color: var(--primary-border); box-shadow: var(--shadow-sm); background: #fff; }
.detail-item.is-completed { background: var(--success-soft); border-color: var(--success-border); }
.detail-item.is-completed .detail-title { text-decoration: line-through; color: var(--muted); }

.detail-info { display: flex; align-items: center; gap: 10px; }
.detail-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 18px;
}
.detail-icon .icon { width: 18px; height: 18px; }
.detail-icon.gym { background: rgba(167, 139, 250, 0.2); color: var(--gym-color); }
.detail-icon.running { background: rgba(110, 231, 183, 0.3); color: var(--run-color); }
.detail-icon.reading { background: rgba(147, 197, 253, 0.3); color: var(--read-color); }
.detail-icon.extra { background: rgba(103, 232, 249, 0.3); color: var(--extra-color); }
.detail-text { display: flex; flex-direction: column; gap: 2px; }
.detail-title { font-weight: 600; font-size: 13px; }
.detail-meta { font-size: 11px; color: var(--muted); }
.detail-actions-inline { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }

.action-btn {
  width: 32px;
  height: 32px;
  padding: 0;
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  background: #fff;
  color: var(--ink);
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.action-btn .icon { width: 14px; height: 14px; }
.action-btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
.action-btn.success { background: var(--success); color: #fff; border-color: var(--success); }
.action-btn.danger { background: #fff5f5; color: var(--danger); border-color: transparent; }
.action-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }

.day-detail-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; padding-top: 12px; }
.day-detail-actions .btn { font-size: 12.5px; }

.planning-banner {
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  background: var(--primary-soft);
  border: 1px solid var(--primary-border);
  border-radius: 14px;
  padding: 10px 14px;
  margin-top: 8px;
}
.planning-banner.is-active { display: flex; }
.planning-banner-info { display: flex; align-items: center; gap: 8px; }
.planning-banner-info strong { display: block; font-size: 12px; font-weight: 700; color: var(--primary); }
.planning-banner-info span { display: block; font-size: 11px; color: var(--muted); }
.planning-banner .icon { color: var(--primary); }
.btn.small { padding: 6px 12px; font-size: 11px; border-radius: 10px; }


.heatmap-card { display: flex; flex-direction: column; gap: 16px; }
.heatmap { display: flex; gap: 4px; overflow-x: auto; padding: 4px; justify-content: center; }
.heatmap-week { display: grid; grid-template-rows: repeat(7, 14px) auto; gap: 4px; align-items: center; }
.heatmap-cell { width: 14px; height: 14px; border-radius: 4px; background: #e2e8f0; }
.heatmap-cell[data-level="0"] { background: #e2e8f0; }
.heatmap-cell[data-level="1"] { background: #b7f3d0; }
.heatmap-cell[data-level="2"] { background: #6ee7b7; }
.heatmap-cell[data-level="3"] { background: #34d399; }
.heatmap-cell[data-level="4"] { background: #059669; }
.heatmap-cell--empty { background: transparent; }
.heatmap-month-label { font-size: 9px; text-transform: uppercase; color: var(--muted); text-align: center; letter-spacing: 0.08em; margin-top: 1px; }
.heatmap-legend { display: flex; align-items: center; justify-content: flex-end; gap: 10px; font-size: 11px; color: var(--muted); }
.heatmap-legend-scale { display: inline-flex; align-items: center; gap: 4px; }
.heatmap-legend-scale span { width: 14px; height: 14px; border-radius: 3px; background: #e2e8f0; }
.heatmap-legend-scale span[data-level="1"] { background: #b7f3d0; }
.heatmap-legend-scale span[data-level="2"] { background: #6ee7b7; }
.heatmap-legend-scale span[data-level="3"] { background: #34d399; }
.heatmap-legend-scale span[data-level="4"] { background: #059669; }

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s ease;
  z-index: 100;
}
.modal-overlay.visible { opacity: 1; pointer-events: all; }
.modal-card {
  background: #fff;
  padding: 28px;
  border-radius: 18px;
  max-width: 440px;
  width: 90%;
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.modal-card h3 { font-size: 18px; font-weight: 700; }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.modal-card input, .modal-card textarea, .modal-card select { width: 100%; border: 1px solid var(--line); border-radius: 12px; padding: 12px; font-family: inherit; font-size: 13px; }
.modal-field { display: flex; flex-direction: column; gap: 6px; }
.modal-field-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.modal-options { display: flex; flex-direction: column; gap: 10px; }
.option-label { border: 1px solid var(--line); border-radius: 12px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: var(--transition); }
.option-label:hover { border-color: var(--primary); background: var(--primary-soft); }
.option-label input { accent-color: var(--primary); }

#save-status {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--ink);
  color: #fff;
  padding: 10px 20px;
  border-radius: 14px;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  pointer-events: none;
  transition: opacity .3s ease, transform .3s ease;
  font-size: 12px;
  z-index: 120;
}
#save-status.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

.kpi-progress-card {
  gap: 12px;
}

.kpi-progress-card .kpi-body {
  gap: 8px;
}
.goal-progress-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.goal-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}
.goal-progress-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 600;
}
.goal-progress-meta {
  font-size: 11px;
  color: var(--muted);
  font-weight: 500;
  text-align: right;
  flex-shrink: 0;
}
.kpi-progress-bar {
  height: 6px;
  background: #f1f5f9;
  border-radius: 999px;
  overflow: hidden;
}
.kpi-progress-fill {
  height: 100%;
  border-radius: inherit;
  transition: width 0.4s ease;
}

/* Body metrics */
.body-metrics-card {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.metrics-layout {
  display: grid;
  grid-template-columns: minmax(0, 360px) minmax(0, 1fr);
  gap: 20px;
}

.metrics-sidebar {
  background: var(--surface);
  border-radius: 20px;
  border: 1px solid var(--line);
  padding: 18px;
  box-shadow: var(--shadow-sm);
  display: grid;
  gap: 12px;
}

.metrics-preview {
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px dashed var(--line);
  background: var(--bg-alt);
  display: grid;
  gap: 8px;
}

.metrics-preview-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
}

.metrics-preview-value {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
}

.metrics-form-grid {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.metrics-form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
}

.metrics-form-grid label,
.metrics-form-row label {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
}

.metrics-form-grid input,
.metrics-form-grid select,
.metrics-form-row input,
.metrics-form-row select {
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--line);
  font-size: 13px;
  background: var(--surface);
}

.metrics-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.metrics-feedback {
  padding: 12px 14px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
  background: var(--bg-alt);
  border: 1px dashed var(--line);
  color: var(--muted);
}

.metrics-feedback.success {
  background: var(--success-soft);
  border-color: var(--success-border);
  color: var(--success);
}

.metrics-feedback.warning {
  background: var(--warning-soft);
  border-color: var(--warning-border);
  color: var(--warning);
}

.metrics-feedback.danger {
  background: var(--danger-soft);
  border-color: var(--danger-border);
  color: var(--danger);
}

.metrics-history {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.metrics-log-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 320px;
  overflow-y: auto;
  padding-right: 4px;
}

.metrics-log-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: var(--surface);
}

.metrics-log-item strong { font-size: 13px; }
.metrics-log-item span { font-size: 12px; color: var(--muted); }

.metrics-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.metrics-filter {
  display: flex;
  align-items: center;
  gap: 8px;
}

.metrics-summary {
  font-size: 12px;
  color: var(--muted);
  font-weight: 600;
}

.metrics-dashboard {
  display: grid;
  gap: 18px;
}

.metrics-kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 14px;
}

.metrics-kpi-tile {
  background: var(--surface);
  border-radius: 18px;
  padding: 16px;
  border: 1px solid var(--line);
  box-shadow: var(--shadow-sm);
  display: grid;
  gap: 6px;
}

.metrics-kpi-head {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-weight: 600;
}

.metrics-kpi-head .icon {
  width: 16px;
  height: 16px;
}

.metrics-kpi-value {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: -0.02em;
}

.metrics-trend {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
}

.metrics-trend .icon {
  width: 14px;
  height: 14px;
}

.metrics-trend.good { color: var(--success); }
.metrics-trend.bad { color: var(--danger); }
.metrics-trend.neutral { color: var(--muted); }

.metrics-status-card {
  background: linear-gradient(135deg, #f8fafc, #eef2ff);
  border-radius: 20px;
  padding: 20px;
  border: 1px solid var(--line);
  display: grid;
  gap: 8px;
  box-shadow: var(--shadow-sm);
}

.metrics-status-card.good {
  border-color: var(--success-border);
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
}

.metrics-status-card.warning {
  border-color: var(--warning-border);
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
}

.metrics-status-card.danger {
  border-color: var(--danger-border);
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
}

.metrics-status-header {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  font-size: 14px;
}

.metrics-status-header .icon {
  width: 18px;
  height: 18px;
}

.metrics-status-text {
  color: var(--text);
  font-size: 13px;
  line-height: 1.4;
}

.metrics-chart-card {
  background: var(--surface);
  border-radius: 18px;
  padding: 16px;
  border: 1px solid var(--line);
  box-shadow: var(--shadow-sm);
  display: grid;
  gap: 12px;
}

.metrics-chart-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 13px;
  font-weight: 600;
}

.metrics-chart-wrapper {
  position: relative;
  min-height: 220px;
}

.metrics-goal-card {
  background: var(--surface);
  border-radius: 18px;
  padding: 16px;
  border: 1px solid var(--line);
  box-shadow: var(--shadow-sm);
  display: grid;
  gap: 12px;
}

.metrics-goal-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.metrics-goal-input {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
}

.metrics-goal-input input {
  width: 90px;
}

.metrics-goal-progress {
  display: grid;
  gap: 6px;
}

.metrics-goal-bar {
  height: 10px;
  border-radius: 999px;
  background: #e2e8f0;
  overflow: hidden;
}

.metrics-goal-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--success));
  border-radius: inherit;
  width: 0%;
  transition: width 0.4s ease;
}

.metrics-goal-meta {
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
}

@media (max-width: 980px) {
  .metrics-layout {
    grid-template-columns: minmax(0, 1fr);
  }
}

/* Sub navigation */
.subnav {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin: 8px 0 20px;
}

.subnav button {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: var(--surface);
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  cursor: pointer;
  transition: var(--transition);
}

.subnav button:hover {
  color: var(--accent);
  border-color: var(--primary-border);
  box-shadow: var(--shadow-sm);
}

.subnav button.is-active {
  color: var(--accent);
  background: var(--primary-soft);
  border-color: var(--primary-border);
  box-shadow: var(--shadow-sm);
}

.section-panel {
  display: none;
}

.section-panel.is-active {
  display: block;
}

.activity-hub.section-panel.is-active {
  display: grid;
}

/* Analytics */
.analytics-dashboard {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.analytics-top-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.analytics-score-card {
    background: var(--surface);
    border: 1px solid var(--line);
    border-radius: 18px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
}
.score-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--primary-soft);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 800;
    border: 3px solid var(--primary-border);
}
.score-info h4 { font-size: 14px; font-weight: 700; color: var(--ink); margin: 0; }
.score-info p { font-size: 11px; color: var(--muted); margin-top: 2px; }

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 18px;
}

.analytics-card {
  border-radius: 18px;
  border: 1px solid var(--line);
  background: var(--surface);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  box-shadow: var(--shadow-sm);
}

.analytics-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.analytics-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    font-size: 15px;
}
.analytics-title .icon { color: var(--primary); width: 18px; height: 18px; }

.analytics-subtitle {
  font-size: 11px;
  color: var(--muted);
  font-weight: 600;
  background: #f1f5f9;
  padding: 4px 8px;
  border-radius: 6px;
}

.analytics-chart-container {
  height: 220px;
  position: relative;
  width: 100%;
}
.analytics-chart-container.sm { height: 180px; }

.analytics-chart canvas {
  width: 100% !important;
  height: 100% !important;
}

.analytics-summary-text {
    font-size: 12px;
    color: var(--muted);
    line-height: 1.5;
    border-top: 1px solid var(--line);
    padding-top: 12px;
}

/* Legend Text Styles for Charts */
.analytics-legend-text {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 11px;
    color: var(--muted);
    justify-content: center;
    margin-top: 4px;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
}
.legend-color {
    width: 8px;
    height: 8px;
    border-radius: 2px;
}


@media (max-width: 980px) {
  .analytics-grid { grid-template-columns: 1fr; }
}

@media (max-width: 1080px) {
  .activity-hub { grid-template-columns: 1fr; }
  .day-detail, .day-detail-placeholder { min-height: 380px; }
  .metrics-layout { grid-template-columns: 1fr; }
}
@media (max-width: 720px) {
  .wrap { padding: 24px 18px 40px; }
  .page-header-top { flex-direction: column; align-items: flex-start; }
  .page-header-actions { width: 100%; }
  .page-header-actions .btn { flex: 1; justify-content: center; }
  .calendar-weekdays { display: none; }
  .calendar-grid { grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); grid-auto-rows: 70px; }
}
  </style>
</head>
<body data-page="trainings">
  <div class="layout">
    <aside class="sidebar" aria-label="G≈Ç√≥wna nawigacja">
      <div class="sidebar__header">
        <span class="sidebar__emoji">üß≠</span>
        <span class="sidebar__brand">LifeOS</span>
      </div>
      <nav class="sidebar__nav" aria-label="Sekcje LifeOS">
        <ul class="sidebar__list">
          <li class="sidebar__item">
            <a class="sidebar__link" href="index.html" data-page="dashboard">
              <span class="sidebar__icon">üìä</span>
              <span class="sidebar__label">Dashboard</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="budget.html" data-page="budget">
              <span class="sidebar__icon">üí∞</span>
              <span class="sidebar__label">Bud≈ºet</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="tasks.html" data-page="tasks">
              <span class="sidebar__icon">‚úÖ</span>
              <span class="sidebar__label">Zadania</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="trainings.html" data-page="trainings">
              <span class="sidebar__icon">üí™</span>
              <span class="sidebar__label">Progres</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="fuel.html" data-page="fuel">
              <span class="sidebar__icon">‚õΩ</span>
              <span class="sidebar__label">Paliwo</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="loan.html" data-page="loan">
              <span class="sidebar__icon">üè¶</span>
              <span class="sidebar__label">Kredyt</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="inventory.html" data-page="inventory">
              <span class="sidebar__icon">üì¶</span>
              <span class="sidebar__label">Magazyn</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="house.html" data-page="house">
              <span class="sidebar__icon">üè†</span>
              <span class="sidebar__label">Budowa</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar__footer">
        <strong>Tw√≥j cyfrowy dom</strong>
        ZarzƒÖdzaj bud≈ºetem, zadaniami i celami w jednym miejscu.
      </div>
    </aside>

    <div class="main">
      <header class="page-header" role="banner">
        <div class="page-header__top">
          <span class="page-overline">Program treningowy</span>
          <h1 class="page-title">
            <span class="page-title__icon">üí™</span>
            <span class="page-title__text">Treningi</span>
          </h1>
        </div>
        <div class="page-header__actions month-switcher" aria-label="Akcje strony">
          <button id="prev-month-btn" class="btn ghost icon-btn" aria-label="Poprzedni miesiƒÖc"><i data-lucide="chevron-left" class="icon"></i></button>
          <div class="month-labels">
            <span class="month-label" id="current-month-label">--</span>
            <span class="tiny muted" id="current-month-range">--</span>
          </div>
          <span class="chip" id="header-month-chip">--</span>
          <button id="next-month-btn" class="btn ghost icon-btn" aria-label="Nastƒôpny miesiƒÖc"><i data-lucide="chevron-right" class="icon"></i></button>
          <button id="today-month-btn" class="btn soft"><i data-lucide="calendar" class="icon"></i>Dzisiaj</button>
        </div>
      </header>

      <nav class="subnav" aria-label="Podmenu sekcji">
        <button type="button" class="is-active" data-section-target="activity-hub"><i data-lucide="calendar-days" class="icon"></i>Dziennik</button>
        <button type="button" data-section-target="activity-heatmap"><i data-lucide="flame" class="icon"></i>Historia</button>
        <button type="button" data-section-target="body-metrics"><i data-lucide="activity" class="icon"></i>Log wagi</button>
        <button type="button" data-section-target="analytics"><i data-lucide="pie-chart" class="icon"></i>Analityka</button>
      </nav>

      <div class="content">
        <main class="page-content content-main stack">
          <!-- New Activity Hub Layout -->
          <div class="card activity-hub section-panel is-active" id="activity-hub">
            <div class="calendar-wrapper">
              <div class="calendar-header">
                <h3>Dziennik aktywno≈õci</h3>
                <div class="calendar-legend">
                  <span title="Trening si≈Çowy">üèãÔ∏è Si≈Çownia</span>
                  <span title="Bieganie">üèÉ Bieganie</span>
                  <span title="Czytanie">üìö Czytanie</span>
                  <span title="Aktywno≈õƒá dodatkowa">‚ú® Dodatkowe</span>
                  <span title="Urlop">üå¥ Urlop</span>
                </div>
              </div>
              <div class="calendar-weekdays">
                <span>Pon</span><span>Wt</span><span>≈ör</span><span>Czw</span><span>Pt</span><span>Sob</span><span>Niedz</span>
              </div>
              <div id="calendar-grid" class="calendar-grid"></div>
              <div class="planning-banner" id="planning-banner" aria-live="polite">
                <div class="planning-banner-info">
                  <i data-lucide="mouse-pointer-click" class="icon"></i>
                  <div>
                    <strong id="planning-banner-title">Tryb planowania</strong>
                    <span id="planning-banner-meta">Klikaj dni, by dodaƒá ten trening.</span>
                  </div>
                </div>
                <button id="stop-planning-btn" class="btn soft small"><i data-lucide="check" class="icon"></i>Zako≈Ñcz</button>
              </div>
            </div>

            <div id="day-detail-container">
              <!-- This will be populated by JS -->
            </div>
          </div>
          <!-- End of Activity Hub -->

          <section class="card heatmap-card section-panel" id="activity-heatmap">
            <div class="card-header">
              <div>
                <h3>Historia aktywno≈õci</h3>
                <p class="muted tiny">Podsumowanie uko≈Ñczonych zada≈Ñ w ciƒÖgu roku</p>
              </div>
              <span class="month-chip" id="heatmap-year-label">--</span>
            </div>
            <div id="heatmap" class="heatmap"></div>
            <div class="heatmap-legend">
              <span>Brak</span>
              <div class="heatmap-legend-scale">
                <span data-level="0"></span>
                <span data-level="1"></span>
                <span data-level="2"></span>
                <span data-level="3"></span>
                <span data-level="4"></span>
              </div>
              <span>Intensywnie</span>
            </div>
          </section>

          <section class="card body-metrics-card section-panel" id="body-metrics">
            <div class="card-header">
              <div>
                <h3>Log wagi i sk≈Çadu cia≈Ça</h3>
                <p class="muted tiny">Zapisuj ka≈ºdy cykl, buduj progres i ≈õled≈∫ trendy.</p>
              </div>
              <span class="month-chip">2026+</span>
            </div>
            <div class="metrics-layout">
              <div class="metrics-form metrics-sidebar">
                <form id="metrics-form" class="metrics-form-grid">
                  <div class="metrics-form-row">
                    <label>Data logu
                      <input type="date" id="metrics-date" required>
                    </label>
                    <label>Cel / cykl
                      <input type="text" id="metrics-cycle" list="metrics-cycle-list" placeholder="np. Redukcja 2025" required>
                      <datalist id="metrics-cycle-list"></datalist>
                    </label>
                    <label>Waga (kg)
                      <input type="number" id="metrics-weight" min="0" step="0.1" placeholder="np. 84.2">
                    </label>
                    <label>BF (%)
                      <input type="number" id="metrics-bf" min="0" step="0.1" placeholder="np. 17.5">
                    </label>
                    <label>Wzrost (cm)
                      <input type="number" id="metrics-height" min="0" step="0.1" placeholder="np. 182">
                    </label>
                  </div>
                  <div class="metrics-actions">
                    <button class="btn" type="submit"><i data-lucide="save" class="icon"></i>Zapisz log</button>
                    <button class="btn soft" type="button" id="metrics-clear-btn"><i data-lucide="rotate-ccw" class="icon"></i>Wyczy≈õƒá pola</button>
                    <button class="btn ghost" type="button" id="metrics-delete-last-btn"><i data-lucide="trash-2" class="icon"></i>Usu≈Ñ ostatni pomiar</button>
                  </div>
                </form>
                <div class="metrics-preview" aria-live="polite">
                  <div class="metrics-preview-row">
                    <span>BMI (podglƒÖd)</span>
                    <span class="metrics-preview-value" id="metrics-bmi-preview">--</span>
                  </div>
                  <div class="metrics-preview-row">
                    <span>LBM (podglƒÖd)</span>
                    <span class="metrics-preview-value" id="metrics-lbm-preview">--</span>
                  </div>
                </div>
                <div id="metrics-feedback" class="metrics-feedback" role="status">Dodaj pierwszy log, a zobaczysz trendy i komunikaty o progresie.</div>
              </div>
              <div>
                <div class="metrics-toolbar">
                  <div class="metrics-filter">
                    <span class="tiny muted">Cykl:</span>
                    <select id="metrics-cycle-filter"></select>
                  </div>
                  <div id="metrics-cycle-summary" class="metrics-summary"></div>
                </div>
                <div class="metrics-dashboard">
                  <div class="metrics-kpi-grid">
                    <div class="metrics-kpi-tile">
                      <div class="metrics-kpi-head"><i data-lucide="scale" class="icon"></i>Waga</div>
                      <div class="metrics-kpi-value" id="metrics-weight-value">--</div>
                      <div class="metrics-trend neutral" id="metrics-weight-trend">Brak trendu</div>
                    </div>
                    <div class="metrics-kpi-tile">
                      <div class="metrics-kpi-head"><i data-lucide="percent" class="icon"></i>Body Fat %</div>
                      <div class="metrics-kpi-value" id="metrics-bf-value">--</div>
                      <div class="metrics-trend neutral" id="metrics-bf-trend">Brak trendu</div>
                    </div>
                    <div class="metrics-kpi-tile">
                      <div class="metrics-kpi-head"><i data-lucide="dumbbell" class="icon"></i>Masa Miƒô≈õniowa (kg)</div>
                      <div class="metrics-kpi-value" id="metrics-muscle-value">--</div>
                      <div class="metrics-trend neutral" id="metrics-muscle-trend">Brak trendu</div>
                    </div>
                  </div>
                  <div class="metrics-status-card" id="metrics-status-card">
                    <div class="metrics-status-header">
                      <i data-lucide="sparkles" class="icon"></i>
                      <span>Status Sylwetki</span>
                    </div>
                    <div class="metrics-status-text" id="metrics-status-text">Dodaj dwa logi, aby zobaczyƒá ocenƒô sylwetki.</div>
                  </div>
                  <div class="metrics-chart-card">
                    <div class="metrics-chart-header">
                      <span>Waga vs Body Fat %</span>
                      <span class="tiny muted">Dual Axis</span>
                    </div>
                    <div class="metrics-chart-wrapper">
                      <canvas id="metrics-weight-bf-chart"></canvas>
                    </div>
                  </div>
                  <div class="metrics-goal-card">
                    <div class="metrics-chart-header">
                      <span>Road to Summer</span>
                      <span class="tiny muted">Tempo BF (4 tyg.)</span>
                    </div>
                    <div class="metrics-goal-row">
                      <div class="metrics-goal-input">
                        <label for="metrics-target-bf">Cel BF %</label>
                        <input type="number" id="metrics-target-bf" min="0" step="0.1" placeholder="np. 12">
                      </div>
                      <div class="metrics-goal-meta" id="metrics-goal-date">Podaj cel BF, aby obliczyƒá datƒô.</div>
                    </div>
                    <div class="metrics-goal-progress">
                      <div class="metrics-goal-bar">
                        <div class="metrics-goal-bar-fill" id="metrics-goal-bar-fill"></div>
                      </div>
                      <div class="metrics-goal-meta" id="metrics-goal-progress">0% drogi do celu</div>
                    </div>
                  </div>
                </div>
                <div class="metrics-history">
                  <h4>Historia log√≥w</h4>
                  <div id="metrics-log-list" class="metrics-log-list"></div>
                </div>
              </div>
            </div>
          </section>

          <!-- MODERN ANALYTICS DASHBOARD -->
          <section class="section-panel" id="analytics">
            <div class="analytics-dashboard">
                <div class="card-header">
                    <div>
                      <h3>Dashboard Analityczny</h3>
                      <p class="muted tiny">Twoje centrum dowodzenia nawykami.</p>
                    </div>
                    <span class="month-chip">Live</span>
                </div>

                <div class="analytics-top-row">
                    <div class="analytics-score-card">
                        <div class="score-circle" id="habit-score-value">--</div>
                        <div class="score-info">
                            <h4>Habit Score</h4>
                            <p>Og√≥lny wska≈∫nik dyscypliny (ost. 30 dni)</p>
                        </div>
                    </div>
                    <div class="analytics-score-card">
                        <div class="score-circle" id="streak-value" style="color: var(--warning); border-color: var(--warning-border); background: var(--warning-soft);">--</div>
                        <div class="score-info">
                            <h4>Aktualna Seria</h4>
                            <p>Dni z rzƒôdu z jakƒÖkolwiek aktywno≈õciƒÖ</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-grid">
                    <!-- Chart 1: 12-Week Progress Trend -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-title">
                                <i data-lucide="trending-up" class="icon"></i>
                                Trend 12 Tygodni
                            </div>
                            <span class="analytics-subtitle">Konsekwencja</span>
                        </div>
                        <div class="analytics-chart-container">
                            <canvas id="analytics-12w-chart"></canvas>
                        </div>
                        <div class="analytics-summary-text">
                            Analiza trendu pokazuje Twoje zaanga≈ºowanie w czasie.
                        </div>
                        <div class="analytics-legend-text">
                            <div class="legend-item"><span class="legend-color" style="background: var(--primary);"></span>Liczba uko≈Ñczonych sesji (Wszystkie typy)</div>
                        </div>
                    </div>

                    <!-- Chart 2: Current Week Radar -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-title">
                                <i data-lucide="zap" class="icon"></i>
                                Bie≈ºƒÖcy Tydzie≈Ñ
                            </div>
                            <span class="analytics-subtitle">Balans</span>
                        </div>
                        <div class="analytics-chart-container">
                            <canvas id="analytics-week-radar"></canvas>
                        </div>
                        <div class="analytics-summary-text">
                            Czy nie zaniedbujesz jednej sfery kosztem innej?
                        </div>
                        <div class="analytics-legend-text">
                            <div class="legend-item"><span class="legend-color" style="background: rgba(99,102,241,0.5);"></span>Realizacja celu w % dla ka≈ºdej kategorii</div>
                        </div>
                    </div>

                     <!-- Chart 3: Monthly Comparisons (Gray Bar Logic) -->
                     <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-title">
                                <i data-lucide="bar-chart-2" class="icon"></i>
                                Dyscyplina Miesiƒôczna
                            </div>
                            <span class="analytics-subtitle">Tygodnie Idealne</span>
                        </div>
                        <div class="analytics-chart-container sm">
                            <canvas id="analytics-monthly-chart"></canvas>
                        </div>
                        <div class="analytics-summary-text">
                            Tydzie≈Ñ zaliczony do miesiƒÖca wg daty niedzieli.
                        </div>
                        <div class="analytics-legend-text">
                            <div class="legend-item"><span class="legend-color" style="background: var(--success);"></span>Tygodnie idealne (100% cel√≥w)</div>
                            <div class="legend-item"><span class="legend-color" style="background: #e2e8f0;"></span>Pozosta≈Çe tygodnie miesiƒÖca</div>
                        </div>
                    </div>

                    <!-- Chart 4: Weekly Rhythm -->
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-title">
                                <i data-lucide="calendar-clock" class="icon"></i>
                                Rytm Tygodnia
                            </div>
                            <span class="analytics-subtitle">Dni Aktywne</span>
                        </div>
                        <div class="analytics-chart-container sm" style="display: flex; justify-content: center;">
                            <canvas id="analytics-weekly-consistency"></canvas>
                        </div>
                        <div class="analytics-summary-text">
                            Twoje najsilniejsze dni w tygodniu.
                        </div>
                        <div class="analytics-legend-text">
                            <div class="legend-item"><span class="legend-color" style="background: var(--primary);"></span>Suma aktywno≈õci w dany dzie≈Ñ (ost. 90 dni)</div>
                        </div>
                    </div>
                </div>
            </div>
          </section>

        </main>

        <aside class="right-rail">
          <div class="kpi-compact kpi-progress-card">
            <span class="kpi-emoji">üìà</span>
            <div class="kpi-body">
              <span class="kpi-label">Postƒôp tygodniowy</span>
              <span class="kpi-value" id="metric-weekly-complete-percent">0%</span>
              <span class="tiny muted" id="metric-weekly-complete-sub"></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">üìÜ</span>
            <div class="kpi-body">
              <span class="kpi-label">Tygodnie zaliczone</span>
              <span class="kpi-value" id="metric-weekly-complete-count">0/0</span>
              <span class="tiny muted" id="metric-weekly-count-note">Brak danych rocznych</span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">üßç</span>
            <div class="kpi-body">
              <span class="kpi-label">Dni aktywne</span>
              <span class="kpi-value" id="metric-active-days">0/0</span>
              <span class="tiny muted" id="metric-active-days-note">Brak danych</span>
            </div>
          </div>
          <div class="kpi-compact metric-card--visual kpi-next-activity" id="metric-next-activity-card" data-activity-type="none">
            <span class="kpi-emoji">üéØ</span>
            <div class="kpi-body">
              <span class="kpi-label">Najbli≈ºsza aktywno≈õƒá</span>
              <span class="kpi-value kpi-value--sm" id="metric-next-activity-date">Brak terminu</span>
              <span class="tiny muted" id="metric-next-activity-note">Zaplanuj kolejny ruch</span>
            </div>
          </div>
          <div id="goal-progress-list" class="goal-progress-grid"></div>
        </aside>
      </div>
    </div>
  </div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-card">
    <h3 id="modal-title"></h3>
    <p id="modal-text" class="muted"></p>
    <div id="modal-input-container"></div>
    <div id="modal-options-container"></div>
    <div id="modal-actions" class="modal-actions"></div>
  </div>
</div>
<div id="save-status">Zapisano zmiany</div>

<script>
  (function activateSidebarLink() {
    const currentPage = document.body.dataset.page;
    if (!currentPage) return;
    document.querySelectorAll('.sidebar__link[data-page]').forEach((link) => {
      if (link.dataset.page === currentPage) {
        link.classList.add('sidebar__link--active');
        link.setAttribute('aria-current', 'page');
      } else {
        link.classList.remove('sidebar__link--active');
        link.removeAttribute('aria-current');
      }
    });
  })();
</script>
<script>
const STORAGE_KEY = 'lifeos_trainings_month_v1';
const LEGACY_STORAGE_KEY = 'lifeos_trainings_v1';
const MIGRATION_FLAG_KEY = 'lifeos_trainings_migrated_to_month_v1';
const ACTIVITY_EMOJIS = {
    gym: 'üèãÔ∏è',
    running: 'üèÉ',
    reading: 'üìö',
    extra: '‚ú®',
    vacation: 'üå¥'
};
const GOAL_DEFINITIONS = {
  gym: { target: 3, unit: 'sesje', label: 'Trening si≈Çowy', icon: 'dumbbell', color: 'var(--gym-color)', emoji: ACTIVITY_EMOJIS.gym },
  running: { target: 5, unit: 'km', label: 'Bieganie', icon: 'activity', color: 'var(--run-color)', emoji: ACTIVITY_EMOJIS.running },
  reading: { target: 100, unit: 'stron', label: 'Czytanie', icon: 'book-open', color: 'var(--read-color)', emoji: ACTIVITY_EMOJIS.reading }
};
const EXTRA_ACTIVITY_CATEGORIES = [
  { value: 'training', label: 'Trening / ruch' },
  { value: 'learning', label: 'Nauka / rozw√≥j' },
  { value: 'relax', label: 'Regeneracja' },
  { value: 'home', label: 'Dom i organizacja' },
  { value: 'other', label: 'Inne' }
];
const EXTRA_CATEGORY_LABELS = EXTRA_ACTIVITY_CATEGORIES.reduce((acc, item) => {
  acc[item.value] = item.label;
  return acc;
}, {});
const BODY_METRICS_KEY = 'lifeos_body_metrics_v1';
const BODY_METRICS_GOAL_KEY = 'lifeos_body_metrics_goal_bf_v1';

const DAY_MS = 24 * 60 * 60 * 1000;

const safeParse = (raw, fallbackFactory) => {
  const fallback = () => (typeof fallbackFactory === 'function' ? fallbackFactory() : fallbackFactory);
  if (!raw) return fallback();
  try {
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === 'object' ? parsed : fallback();
  } catch {
    return fallback();
  }
};

let state = { activities: {}, extras: {}, vacations: {}, predefinedExtras: [] };
let currentMonth = startOfMonth(new Date());
let selectedDate = toYYYYMMDD(new Date());
let planningMode = null;
let saveTimeout;
let bodyMetrics = [];
let selectedCycle = 'all';
let analyticsCharts = {};
let bodyMetricsChart = null;
let targetBfGoal = null;

function startOfMonth(date) {
  return new Date(date.getFullYear(), date.getMonth(), 1);
}

function toYYYYMMDD(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function parseDate(dateString) {
  const [y, m, d] = dateString.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function formatMonth(date) {
  return date.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
}

function formatRange(start, end) {
  return `${start.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' })} ‚Äì ${end.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' })}`;
}

function formatDateWithDay(date) {
  return date.toLocaleDateString('pl-PL', { weekday: 'long', day: '2-digit', month: 'long' });
}

function formatPlanningSummary(type, plannedValue) {
  const def = GOAL_DEFINITIONS[type];
  if (!def) return 'Nowy trening';
  if (type === 'gym') return def.label;
  const numeric = Number(plannedValue);
  if (!Number.isFinite(numeric) || numeric <= 0) return def.label;
  const valueLabel = `${numeric.toLocaleString('pl-PL')} ${def.unit}`;
  return `${def.label} ¬∑ ${valueLabel}`;
}

function isPlanningActive() {
  return Boolean(planningMode && planningMode.active);
}

function startPlanningMode(type, plannedValue) {
  planningMode = {
    active: true,
    type,
    plannedValue: type === 'gym' ? 1 : Number(plannedValue) || 0
  };
  setTimeout(() => render(), 0);
}

function stopPlanningMode() {
  if (!isPlanningActive()) return;
  planningMode = null;
  setTimeout(() => render(), 0);
}

function addDays(date, days) {
  const copy = new Date(date);
  copy.setDate(copy.getDate() + days);
  return copy;
}

function startOfWeek(date) {
  const copy = new Date(date);
  const offset = (copy.getDay() + 6) % 7;
  copy.setDate(copy.getDate() - offset);
  copy.setHours(0, 0, 0, 0);
  return copy;
}

function ensureDay(dateString) {
  if (!state.activities[dateString]) state.activities[dateString] = [];
  if (!state.extras[dateString]) state.extras[dateString] = [];
}

function isVacationDay(dateString) {
  return Boolean(state.vacations && state.vacations[dateString]);
}

function toggleVacationDay(dateString) {
  if (!state.vacations) state.vacations = {};
  if (isVacationDay(dateString)) {
    delete state.vacations[dateString];
  } else {
    state.vacations[dateString] = true;
  }
  saveState();
  render();
}

function planVacationRange(startDateString, endDateString) {
  if (!startDateString || !endDateString) return;
  const start = parseDate(startDateString);
  const end = parseDate(endDateString);
  if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return;
  const normalizedStart = normalizeDate(start);
  const normalizedEnd = normalizeDate(end);
  if (normalizedEnd < normalizedStart) return;
  if (!state.vacations) state.vacations = {};
  const cursor = new Date(normalizedStart);
  let guard = 0;
  while (cursor.getTime() <= normalizedEnd.getTime() && guard < 370) {
    const key = toYYYYMMDD(cursor);
    state.vacations[key] = true;
    cursor.setDate(cursor.getDate() + 1);
    guard += 1;
  }
  saveState();
  render();
}

let dragPayload = null;

function enableDrag(element, payload) {
  if (!element) return;
  element.setAttribute('draggable', 'true');
  element.addEventListener('dragstart', event => {
    dragPayload = payload;
    element.classList.add('is-dragging');
    if (event.dataTransfer) {
      event.dataTransfer.effectAllowed = 'move';
      try {
        event.dataTransfer.setData('application/json', JSON.stringify(payload));
      } catch (error) {
        // ignore unsupported MIME
      }
    }
  });
  element.addEventListener('dragend', () => {
    dragPayload = null;
    element.classList.remove('is-dragging');
  });
}

function resolveDragPayload(event) {
  if (dragPayload) return dragPayload;
  if (!event || !event.dataTransfer) return null;
  try {
    const data = event.dataTransfer.getData('application/json');
    if (data) {
      return JSON.parse(data);
    }
  } catch (error) {
    return null;
  }
  return null;
}

function movePlannedItem(payload, targetDate) {
  if (!payload || !targetDate || payload.sourceDate === targetDate) return;
  ensureDay(payload.sourceDate);
  ensureDay(targetDate);
  let moved = false;
  if (payload.itemType === 'activity') {
    const sourceList = state.activities[payload.sourceDate] || [];
    const index = sourceList.findIndex(item => item.id === payload.id);
    if (index > -1) {
      const [item] = sourceList.splice(index, 1);
      state.activities[targetDate].push(item);
      moved = true;
    }
  } else if (payload.itemType === 'extra') {
    const sourceList = state.extras[payload.sourceDate] || [];
    const index = sourceList.findIndex(item => item.id === payload.id);
    if (index > -1) {
      const [item] = sourceList.splice(index, 1);
      state.extras[targetDate].push(item);
      moved = true;
    }
  }
  if (moved) {
    if (state.vacations && state.vacations[targetDate] && (state.activities[targetDate].length > 0 || state.extras[targetDate].length > 0)) {
      delete state.vacations[targetDate];
    }
    saveState();
    render();
  }
}

function sameMonth(date, reference) {
  return date.getFullYear() === reference.getFullYear() && date.getMonth() === reference.getMonth();
}

function normalizeDate(date) {
  const normalized = new Date(date);
  normalized.setHours(0, 0, 0, 0);
  return normalized;
}

function getISOWeekStart(year, week) {
  const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
  const day = simple.getUTCDay();
  const diff = (day === 0 ? -6 : 1) - day;
  simple.setUTCDate(simple.getUTCDate() + diff);
  return new Date(simple.getUTCFullYear(), simple.getUTCMonth(), simple.getUTCDate());
}

function getISOWeekInfo(date) {
  const target = new Date(date);
  target.setHours(0, 0, 0, 0);
  const dayNumber = (target.getDay() + 6) % 7;
  target.setDate(target.getDate() - dayNumber + 3);
  const isoYear = target.getFullYear();
  const firstWeekStart = getISOWeekStart(isoYear, 1);
  const diffDays = Math.round((target.getTime() - firstWeekStart.getTime()) / DAY_MS);
  const week = 1 + Math.floor(diffDays / 7);
  return { year: isoYear, week: Math.max(1, week) };
}

function loadState() {
  state = { activities: {}, extras: {}, vacations: {}, predefinedExtras: [] };
  planningMode = null;
  const parsed = safeParse(localStorage.getItem(STORAGE_KEY), () => ({}));
  if (parsed && typeof parsed === 'object') {
    state.activities = parsed.activities && typeof parsed.activities === 'object' ? parsed.activities : {};
    state.extras = parsed.extras && typeof parsed.extras === 'object' ? parsed.extras : {};
    state.vacations = parsed.vacations && typeof parsed.vacations === 'object' ? parsed.vacations : {};
    state.predefinedExtras = Array.isArray(parsed.predefinedExtras) ? parsed.predefinedExtras : [];
  }
  migrateLegacyState();
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  showSaveStatus('Zapisano zmiany');
}

function showSaveStatus(message) {
  const status = document.getElementById('save-status');
  if (!status) return;
  status.textContent = message || 'Zapisano zmiany';
  status.classList.add('visible');
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => status.classList.remove('visible'), 1600);
}

function migrateLegacyState() {
  try {
    if (localStorage.getItem(MIGRATION_FLAG_KEY)) return;
    const legacyRaw = localStorage.getItem(LEGACY_STORAGE_KEY);
    if (!legacyRaw) {
      localStorage.setItem(MIGRATION_FLAG_KEY, 'done_empty');
      return;
    };
    const legacyState = safeParse(legacyRaw, () => null);
    if (!legacyState || typeof legacyState !== 'object') {
      localStorage.setItem(MIGRATION_FLAG_KEY, 'done_invalid');
      return;
    }
    let imported = false;
    Object.keys(legacyState).forEach(yearKey => {
      const weeks = legacyState[yearKey];
      if (!weeks || typeof weeks !== 'object') return;
      Object.keys(weeks).forEach(weekKey => {
        const weekData = weeks[weekKey];
        if (!weekData || typeof weekData !== 'object') return;
        const year = Number(yearKey);
        const week = Number(weekKey);
        if (!Number.isFinite(year) || !Number.isFinite(week)) return;
        const weekStart = getISOWeekStart(year, week);
        if (Number.isNaN(weekStart.getTime())) return;

        const mapDayToDate = (dayIndex) => {
          const base = new Date(weekStart);
          const offset = dayIndex === 0 ? 6 : dayIndex - 1;
          base.setDate(weekStart.getDate() + offset);
          base.setHours(0, 0, 0, 0);
          return base;
        };

        const plan = weekData.plan && typeof weekData.plan === 'object' ? weekData.plan : {};
        Object.keys(plan).forEach(dayKey => {
          const dayIndex = Number(dayKey);
          if (!Number.isFinite(dayIndex)) return;
          const date = mapDayToDate(dayIndex);
          const dateString = toYYYYMMDD(date);
          ensureDay(dateString);
          const activities = Array.isArray(plan[dayKey]) ? plan[dayKey] : [];
          activities.forEach(activity => {
            if (!activity || !activity.type || !GOAL_DEFINITIONS[activity.type]) return;
            if (state.activities[dateString].some(item => item.id === activity.id)) return;
            const plannedValue = activity.type === 'gym' ? 1 : Number(activity.plannedValue) || 0;
            const loggedValue = activity.type === 'gym'
              ? (activity.completed ? 1 : 0)
              : Number(activity.loggedValue) || (activity.completed ? plannedValue : 0);
            state.activities[dateString].push({
              id: activity.id || `act_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              type: activity.type,
              plannedValue,
              loggedValue,
              completed: Boolean(activity.completed),
              createdAt: activity.createdAt || Date.now()
            });
            imported = true;
          });
        });

        const extras = weekData.extras && typeof weekData.extras === 'object' ? weekData.extras : {};
        Object.keys(extras).forEach(dayKey => {
          const dayIndex = Number(dayKey);
          if (!Number.isFinite(dayIndex)) return;
          const date = mapDayToDate(dayIndex);
          const dateString = toYYYYMMDD(date);
          ensureDay(dateString);
          const list = Array.isArray(extras[dayKey]) ? extras[dayKey] : [];
          list.forEach(extra => {
            if (!extra || !extra.title) return;
            if (state.extras[dateString].some(item => item.id === extra.id)) return;
            state.extras[dateString].push({
              id: extra.id || `extra_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              title: extra.title,
              category: extra.category || 'other',
              completed: Boolean(extra.completed),
              createdAt: extra.createdAt || Date.now()
            });
            imported = true;
          });
        });

      });
    });
    if (imported) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    localStorage.setItem(MIGRATION_FLAG_KEY, 'done');
  } catch (error) {
    console.error('Legacy trainings migration failed', error);
  }
}

function getCalendarDays(monthDate) {
  const start = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const offset = (start.getDay() + 6) % 7;
  start.setDate(start.getDate() - offset);
  const days = [];
  for (let i = 0; i < 42; i++) {
    const cell = new Date(start);
    cell.setDate(start.getDate() + i);
    days.push(cell);
  }
  return days;
}

function ensureSelectionInMonth() {
  const currentSelection = parseDate(selectedDate);
  if (!sameMonth(currentSelection, currentMonth)) {
    selectedDate = toYYYYMMDD(currentMonth);
  }
}

function calculateMonthlyStats(monthDate) {
  const firstDay = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const lastDay = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
  const totalDays = lastDay.getDate();
  const totals = { planned: 0, completed: 0 };
  const activeDays = new Set();
  const upcoming = [];
  const today = normalizeDate(new Date());

  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    if (!sameMonth(date, monthDate)) return;
    const normalized = normalizeDate(date);
    if (activities.length) activeDays.add(dateString);
    totals.planned += activities.length;
    activities.forEach(activity => {
      if (activity.completed) totals.completed += 1;
      else if (normalized >= today) {
        upcoming.push({ type: activity.type, date: normalized });
      }
    });
  });

  Object.entries(state.extras).forEach(([dateString, extras]) => {
    const date = parseDate(dateString);
    if (!sameMonth(date, monthDate)) return;
    const normalized = normalizeDate(date);
    if (extras.length) activeDays.add(dateString);
    totals.planned += extras.length;
    extras.forEach(extra => {
      if (extra.completed) totals.completed += 1;
      else if (normalized >= today) {
        upcoming.push({ type: 'extra', date: normalized });
      }
    });
  });

  upcoming.sort((a, b) => a.date - b.date);
  const next = upcoming[0];
  const nextActivity = next ? {
    type: next.type,
    relative: getRelativeLabel(next.date, today)
  } : null;

  return {
    plannedCount: totals.planned,
    completedCount: totals.completed,
    activeDays: activeDays.size,
    totalDays,
    nextActivity,
    range: { start: firstDay, end: lastDay }
  };
}

function calculateWeeklyGoalStats(referenceDate) {
  const base = referenceDate ? new Date(referenceDate) : new Date();
  const weekStart = startOfWeek(base);
  const weekEnd = addDays(weekStart, 6);
  const totals = { gym: 0, running: 0, reading: 0 };

  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    const normalized = normalizeDate(date);
    if (normalized < weekStart || normalized > weekEnd) return;
    activities.forEach(activity => {
      if (!activity || !GOAL_DEFINITIONS[activity.type] || !activity.completed) return;
      if (activity.type === 'gym') {
        totals.gym += 1;
      } else {
        const logged = Number(activity.loggedValue);
        const planned = Number(activity.plannedValue);
        const value = !Number.isNaN(logged) && logged > 0
          ? logged
          : (!Number.isNaN(planned) ? planned : 0);
        totals[activity.type] += value;
      }
    });
  });

  const goalPercents = {};
  Object.keys(GOAL_DEFINITIONS).forEach(type => {
    const progress = totals[type] || 0;
    const target = GOAL_DEFINITIONS[type].target;
    const percent = target > 0 ? Math.min(100, Math.round((progress / target) * 100)) : 0;
    goalPercents[type] = { percent, progress, target };
  });

  const averageGoalPercent = Math.round(
    Object.values(goalPercents).reduce((acc, info) => acc + info.percent, 0) /
    Object.keys(GOAL_DEFINITIONS).length
  ) || 0;

  return { goalPercents, averageGoalPercent, range: { start: weekStart, end: weekEnd } };
}

function calculateWeekCompletionToDate() {
  const today = normalizeDate(new Date());
  const info = getISOWeekInfo(today);
  const totalWeeks = Math.max(0, info.week - 1);
  let completedWeeks = 0;

  for (let week = 1; week < info.week; week++) {
    const weekStart = getISOWeekStart(info.year, week);
    const stats = calculateWeeklyGoalStats(weekStart);
    const goals = Object.values(stats.goalPercents || {});
    if (goals.length && goals.every(goal => Number(goal.percent || 0) >= 100)) {
      completedWeeks += 1;
    }
  }

  const percent = totalWeeks > 0 ? Math.round((completedWeeks / totalWeeks) * 100) : 0;
  return { completedWeeks, totalWeeks, percent, currentWeek: info.week, isoYear: info.year };
}

function getRelativeLabel(targetDate, today) {
  const diff = Math.round((targetDate.getTime() - today.getTime()) / DAY_MS);
  if (diff === 0) return 'Dzi≈õ';
  if (diff === 1) return 'Jutro';
  if (diff > 1 && diff < 7) return `Za ${diff} dni`;
  return targetDate.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' });
}

function render() {
  ensureSelectionInMonth();
  const monthStats = calculateMonthlyStats(currentMonth);
  const weekStats = calculateWeeklyGoalStats(parseDate(selectedDate));
  const yearStats = calculateWeekCompletionToDate();
  renderHeader(monthStats, weekStats, yearStats);
  renderCalendar();
  renderDayDetail();
  renderGoalProgress(weekStats.goalPercents);
  renderHeatmap();
  renderPlanningIndicator();
  renderBodyMetrics();
  // Analytics is rendered only when active tab is clicked to prevent canvas issues
  if (document.getElementById('analytics').classList.contains('is-active')) {
      renderNewAnalytics();
  }
  lucide.createIcons();
}

function renderHeader(monthStats, weekStats, yearStats) {
  const monthLabel = formatMonth(currentMonth);
  document.getElementById('header-month-chip').textContent = monthLabel;
  document.getElementById('current-month-label').textContent = monthLabel;
  document.getElementById('current-month-range').textContent = `${formatRange(monthStats.range.start, monthStats.range.end)} ${currentMonth.getFullYear()}`;
  document.getElementById('today-month-btn').style.display = sameMonth(new Date(), currentMonth) ? 'none' : 'inline-flex';
  
  const weeklyRange = weekStats?.range ? formatRange(weekStats.range.start, weekStats.range.end) : '--';
  document.getElementById('metric-weekly-complete-percent').textContent = `${weekStats.averageGoalPercent}%`;
  document.getElementById('metric-weekly-complete-sub').innerHTML = `<span class="metric-subline">Cele tygodniowe</span><span class="metric-subline">${weeklyRange}</span>`;
  document.getElementById('metric-active-days').textContent = `${monthStats.activeDays}/${monthStats.totalDays}`;
  const activeDaysNote = document.getElementById('metric-active-days-note');
  if (monthStats.totalDays) {
    const activePercent = Math.round((monthStats.activeDays / monthStats.totalDays) * 100);
    activeDaysNote.textContent = `${activePercent}% dni z aktywno≈õciƒÖ`;
  } else {
    activeDaysNote.textContent = 'Brak danych dla miesiƒÖca';
  }

  const weeksCountEl = document.getElementById('metric-weekly-complete-count');
  const weeksCountNote = document.getElementById('metric-weekly-count-note');
  if (yearStats) {
    weeksCountEl.textContent = `${yearStats.completedWeeks}/${yearStats.totalWeeks}`;
    weeksCountNote.textContent = `${yearStats.percent}% tygodni roku uko≈Ñczonych`;
  } else {
    weeksCountEl.textContent = '0/0';
    weeksCountNote.textContent = 'Brak danych rocznych';
  }

  const nextCard = document.getElementById('metric-next-activity-card');
  const nextDate = document.getElementById('metric-next-activity-date');
  const nextEmoji = nextCard.querySelector('.kpi-emoji');
  const nextNote = document.getElementById('metric-next-activity-note');
  if (monthStats.nextActivity) {
      nextDate.textContent = monthStats.nextActivity.relative || 'Najbli≈ºsze dni';
      nextEmoji.textContent = ACTIVITY_EMOJIS[monthStats.nextActivity.type] || 'üéØ';
      nextNote.textContent = 'Najbli≈ºszy termin w kalendarzu';
  } else {
      nextDate.textContent = 'Brak terminu';
      nextEmoji.textContent = 'üóìÔ∏è';
      nextNote.textContent = 'Zaplanuj kolejny ruch';
  }
}

function renderCalendar() {
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  const today = normalizeDate(new Date());
  const days = getCalendarDays(currentMonth);
  
  days.forEach(date => {
    const dateString = toYYYYMMDD(date);
    ensureDay(dateString);
    const activities = state.activities[dateString] || [];
    const extras = state.extras[dateString] || [];
    const vacationDay = isVacationDay(dateString);
    const isCurrentMonth = sameMonth(date, currentMonth);
    const plannedCount = activities.length + extras.length;
    const completedCount = activities.filter(a => a.completed).length + extras.filter(e => e.completed).length;
    const isPast = normalizeDate(date) < today;

    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    cell.dataset.date = dateString;
    if (!isCurrentMonth) cell.classList.add('is-other-month');
    if (dateString === selectedDate) cell.classList.add('is-selected');
    if (normalizeDate(date).getTime() === today.getTime()) cell.classList.add('is-today');
    
    if (vacationDay) {
      cell.classList.add('is-vacation');
    } else if (plannedCount > 0) {
      if (completedCount === plannedCount) {
        cell.classList.add('is-completed');
      } else if (isPast) {
        cell.classList.add('is-missed');
      } else {
        cell.classList.add('is-planned');
      }
    } else if (isPast) {
        cell.classList.add('is-missed');
    }

    const number = document.createElement('span');
    number.className = 'calendar-date-number';
    number.textContent = date.getDate();
    cell.appendChild(number);

    const emojisContainer = document.createElement('div');
    emojisContainer.className = 'calendar-day-emojis';
    if (vacationDay) {
      const emojiSpan = document.createElement('span');
      emojiSpan.className = 'activity-emoji';
      emojiSpan.title = 'Urlop';
      emojiSpan.textContent = ACTIVITY_EMOJIS.vacation;
      emojisContainer.appendChild(emojiSpan);
    }
    activities.forEach(a => {
      const emojiSpan = document.createElement('span');
      emojiSpan.className = `activity-emoji ${a.completed ? 'completed' : ''}`;
      emojiSpan.title = GOAL_DEFINITIONS[a.type].label;
      emojiSpan.textContent = GOAL_DEFINITIONS[a.type].emoji;
      enableDrag(emojiSpan, { itemType: 'activity', id: a.id, sourceDate: dateString });
      emojisContainer.appendChild(emojiSpan);
    });
    extras.forEach(e => {
      const emojiSpan = document.createElement('span');
      emojiSpan.className = `activity-emoji ${e.completed ? 'completed' : ''}`;
      emojiSpan.title = e.title;
      emojiSpan.textContent = e.emoji || ACTIVITY_EMOJIS.extra;
      enableDrag(emojiSpan, { itemType: 'extra', id: e.id, sourceDate: dateString });
      emojisContainer.appendChild(emojiSpan);
    });
    cell.appendChild(emojisContainer);

    const footer = document.createElement('div');
    footer.className = 'calendar-day-footer';
    if(plannedCount > 0 && !vacationDay){
        const badge = document.createElement('span');
        badge.className = 'completion-badge';
        badge.textContent = `${completedCount}/${plannedCount}`;
        if (completedCount >= plannedCount) badge.classList.add('is-done');
        else if (completedCount > 0) badge.classList.add('in-progress');
        footer.appendChild(badge);
    }
    cell.appendChild(footer);

    const handleDragTarget = (event) => {
      const payload = resolveDragPayload(event);
      if (!payload || payload.sourceDate === dateString) return;
      event.preventDefault();
      cell.classList.add('is-drag-over');
      if (event.dataTransfer) event.dataTransfer.dropEffect = 'move';
    };

    cell.addEventListener('dragover', handleDragTarget);
    cell.addEventListener('dragenter', handleDragTarget);
    cell.addEventListener('dragleave', (event) => {
      if (event.relatedTarget && cell.contains(event.relatedTarget)) return;
      cell.classList.remove('is-drag-over');
    });
    cell.addEventListener('drop', (event) => {
      event.preventDefault();
      cell.classList.remove('is-drag-over');
      const payload = resolveDragPayload(event);
      if (!payload || payload.sourceDate === dateString) return;
      movePlannedItem(payload, dateString);
    });

    cell.addEventListener('click', () => {
      selectedDate = dateString;
      if (!isCurrentMonth) {
        currentMonth = startOfMonth(date);
      }
      if (isPlanningActive()) {
        addTraining(dateString, planningMode.type, planningMode.plannedValue);
        return;
      }
      render();
    });

    grid.appendChild(cell);
  });
}

function renderPlanningIndicator() {
  const banner = document.getElementById('planning-banner');
  const title = document.getElementById('planning-banner-title');
  const meta = document.getElementById('planning-banner-meta');
  const grid = document.getElementById('calendar-grid');
  
  if (isPlanningActive()) {
    const summary = formatPlanningSummary(planningMode.type, planningMode.plannedValue);
    banner.classList.add('is-active');
    title.textContent = summary;
    meta.textContent = 'Klikaj dni, by dodaƒá ten trening.';
    grid.classList.add('is-planning');
  } else {
    banner.classList.remove('is-active');
    title.textContent = 'Tryb planowania';
    grid.classList.remove('is-planning');
  }
}

function renderDayDetail() {
  const container = document.getElementById('day-detail-container');
  if (!selectedDate) {
    container.innerHTML = `<div class="day-detail-placeholder">
      <i data-lucide="calendar-days" class="icon"></i>
      <strong>Wybierz dzie≈Ñ</strong>
      <p class="muted tiny">Kliknij w datƒô na kalendarzu, aby zobaczyƒá szczeg√≥≈Çy i zarzƒÖdzaƒá planem.</p>
    </div>`;
    lucide.createIcons();
    return;
  }
  ensureDay(selectedDate);
  const date = parseDate(selectedDate);
  const activities = state.activities[selectedDate] || [];
  const extras = state.extras[selectedDate] || [];
  const vacationDay = isVacationDay(selectedDate);
  
  container.innerHTML = `
    <div class="day-detail">
      <div class="day-detail-header">
        <div class="day-detail-title">
          <h3 id="selected-day-title">${formatDateWithDay(date)}</h3>
          <p id="selected-day-summary"></p>
        </div>
        <div class="day-detail-meta">
          <button id="plan-vacation-range-btn" class="btn ghost small" title="Zaplanuj d≈Çu≈ºszy urlop"><i data-lucide="calendar-plus" class="icon"></i></button>
          <button id="toggle-vacation-btn" class="btn ghost small" title="${vacationDay ? 'Usu≈Ñ urlop' : 'Oznacz jako urlop'}">
            <i data-lucide="${vacationDay ? 'sun' : 'plane'}" class="icon"></i>
          </button>
        </div>
      </div>
      <div class="day-detail-body">
        ${vacationDay ? `
          <div id="vacation-note" class="vacation-note">
            <i data-lucide="plane" class="icon"></i>
            <span>Dzie≈Ñ oznaczony jako urlop ‚Äî bez oczekiwa≈Ñ treningowych.</span>
          </div>` : ''}

        <div class="detail-block">
          <h4 class="detail-block-header">Plan treningowy</h4>
          <div id="day-plan-list" class="detail-list"></div>
        </div>
        <div class="detail-block">
          <h4 class="detail-block-header">Szybkie Akcje
            <button id="manage-predefined-btn" class="btn ghost" style="padding: 2px 6px; font-size: 10px; height: auto;">ZarzƒÖdzaj</button>
          </h4>
          <div id="quick-add-list" class="quick-add-list"></div>
        </div>
        <div class="detail-block">
          <h4 class="detail-block-header">Aktywno≈õci dodatkowe</h4>
          <div id="day-extra-list" class="detail-list"></div>
        </div>
      </div>
      <div class="day-detail-actions">
        <button id="add-training-btn" class="btn"><i data-lucide="plus" class="icon"></i>Zaplanuj trening</button>
        <button id="add-extra-btn" class="btn soft"><i data-lucide="sparkles" class="icon"></i>Dodaj aktywno≈õƒá</button>
      </div>
    </div>`;

  renderDayActivities(activities);
  renderDayExtras(extras);
  renderQuickAddButtons();
  updateDaySummary();

  document.getElementById('add-training-btn').addEventListener('click', showAddTrainingModal);
  document.getElementById('add-extra-btn').addEventListener('click', showAddExtraModal);
  document.getElementById('toggle-vacation-btn').addEventListener('click', () => toggleVacationDay(selectedDate));
  document.getElementById('plan-vacation-range-btn').addEventListener('click', showVacationRangeModal);
  document.getElementById('manage-predefined-btn').addEventListener('click', showManagePredefinedExtrasModal);
  lucide.createIcons();
}

function updateDaySummary(){
    const activities = state.activities[selectedDate] || [];
    const extras = state.extras[selectedDate] || [];
    const vacationDay = isVacationDay(selectedDate);
    const completedCount = activities.filter(a => a.completed).length + extras.filter(e => e.completed).length;
    const total = activities.length + extras.length;
    
    const summaryEl = document.getElementById('selected-day-summary');
    if(!summaryEl) return;

    if (vacationDay) {
      summaryEl.textContent = total > 0 ? `Urlop ¬∑ ${completedCount}/${total} uko≈Ñczone` : 'Dzie≈Ñ urlopowy';
    } else {
      summaryEl.textContent = total > 0 ? `${completedCount}/${total} uko≈Ñczone` : 'Brak plan√≥w';
    }
}

function renderDayActivities(activities) {
  const list = document.getElementById('day-plan-list');
  list.innerHTML = '';
  if (!activities.length) {
    list.innerHTML = `<p class="muted tiny" style="padding: 0 4px;">Brak zaplanowanych trening√≥w.</p>`;
    return;
  }
  
  activities.forEach(activity => {
    const goal = GOAL_DEFINITIONS[activity.type];
    const item = document.createElement('div');
    item.className = `detail-item ${activity.completed ? 'is-completed' : ''}`;
    
    const plannedInfo = activity.type === 'gym' ? '' : (activity.plannedValue ? `Plan: ${Number(activity.plannedValue).toLocaleString('pl-PL')} ${goal.unit}` : '');
    let progressInfo = '';
    if (activity.completed) {
      if (activity.type === 'gym') progressInfo = 'Uko≈Ñczono';
      else progressInfo = `Wynik: ${Number(activity.loggedValue).toLocaleString('pl-PL')} ${goal.unit}`;
    }
    const metaText = [plannedInfo, progressInfo].filter(Boolean).join(' ¬∑ ');

    item.innerHTML = `
      <div class="detail-info">
        <div class="detail-icon ${activity.type}">${goal.emoji}</div>
        <div class="detail-text">
          <div class="detail-title">${goal.label}</div>
          <div class="detail-meta">${metaText}</div>
        </div>
      </div>
      <div class="detail-actions-inline">
        ${activity.completed 
          ? `<button class="action-btn" title="Cofnij uko≈Ñczenie" data-action="undo-activity"><i data-lucide="rotate-ccw" class="icon"></i></button>` 
          : `<button class="action-btn success" title="Oznacz jako wykonane" data-action="complete-activity"><i data-lucide="check" class="icon"></i></button>`}
        ${activity.type !== 'gym' ? `<button class="action-btn" title="Edytuj wynik" data-action="edit-activity"><i data-lucide="edit-3" class="icon"></i></button>` : ''}
        <button class="action-btn danger" title="Usu≈Ñ" data-action="delete-activity"><i data-lucide="trash-2" class="icon"></i></button>
      </div>
    `;
    item.querySelector('[data-action="complete-activity"]')?.addEventListener('click', () => completeActivity(selectedDate, activity.id));
    item.querySelector('[data-action="undo-activity"]')?.addEventListener('click', () => undoActivity(selectedDate, activity.id));
    item.querySelector('[data-action="edit-activity"]')?.addEventListener('click', () => editActivity(selectedDate, activity.id));
    item.querySelector('[data-action="delete-activity"]')?.addEventListener('click', () => deleteActivity(selectedDate, activity.id));

    enableDrag(item, { itemType: 'activity', id: activity.id, sourceDate: selectedDate });
    list.appendChild(item);
  });
  lucide.createIcons();
}

function renderDayExtras(extras) {
  const list = document.getElementById('day-extra-list');
  list.innerHTML = '';
  if (!extras.length) {
    list.innerHTML = `<p class="muted tiny" style="padding: 0 4px;">Brak dodatkowych aktywno≈õci.</p>`;
    return;
  }
  
  extras.forEach(extra => {
    const item = document.createElement('div');
    item.className = `detail-item ${extra.completed ? 'is-completed' : ''}`;
    item.innerHTML = `
      <div class="detail-info">
        <div class="detail-icon extra">${extra.emoji || ACTIVITY_EMOJIS.extra}</div>
        <div class="detail-text">
          <div class="detail-title">${extra.title}</div>
          <div class="detail-meta">${EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywno≈õƒá'}</div>
        </div>
      </div>
      <div class="detail-actions-inline">
        <button class="action-btn ${extra.completed ? '' : 'success'}" title="${extra.completed ? 'Cofnij' : 'Zako≈Ñcz'}" data-action="toggle-extra">
            <i data-lucide="${extra.completed ? 'rotate-ccw' : 'check'}" class="icon"></i>
        </button>
        <button class="action-btn danger" title="Usu≈Ñ" data-action="delete-extra"><i data-lucide="trash-2" class="icon"></i></button>
      </div>
    `;
    item.querySelector('[data-action="toggle-extra"]')?.addEventListener('click', () => toggleExtra(selectedDate, extra.id));
    item.querySelector('[data-action="delete-extra"]')?.addEventListener('click', () => deleteExtra(selectedDate, extra.id));

    enableDrag(item, { itemType: 'extra', id: extra.id, sourceDate: selectedDate });
    list.appendChild(item);
  });
  lucide.createIcons();
}

function renderQuickAddButtons() {
    const container = document.getElementById('quick-add-list');
    container.innerHTML = '';
    if (!state.predefinedExtras || state.predefinedExtras.length === 0) {
        container.innerHTML = `<p class="muted tiny" style="padding: 0 4px;">Brak szablon√≥w. Dodaj nowƒÖ aktywno≈õƒá i zaznacz opcjƒô, by jƒÖ zapisaƒá.</p>`;
        return;
    }

    state.predefinedExtras.forEach(extra => {
        const btn = document.createElement('button');
        btn.className = 'quick-add-btn';
        btn.textContent = `${extra.emoji || ''} ${extra.title}`.trim();
        btn.title = `Dodaj "${extra.title}"`;
        btn.addEventListener('click', () => {
            addExtra(selectedDate, extra.title, extra.category, extra.emoji);
        });
        container.appendChild(btn);
    });
}


function renderGoalProgress(goalPercents) {
  const container = document.getElementById('goal-progress-list');
  if (!container) return;
  container.innerHTML = '';
  if (!goalPercents) return;
  
  Object.entries(goalPercents).forEach(([type, info]) => {
    const def = GOAL_DEFINITIONS[type];
    if (!def) return;
    const item = document.createElement('div');
    item.className = 'goal-progress-item';

    const progressValue = Number(info.progress || 0).toLocaleString('pl-PL');
    const targetValue = Number((info && info.target) || def.target || 0).toLocaleString('pl-PL');

    item.innerHTML = `
      <div class="goal-progress-header">
        <span class="goal-progress-label">${def.emoji} ${def.label}</span>
        <span class="goal-progress-meta">${progressValue} / ${targetValue} ${def.unit}</span>
      </div>
      <div class="kpi-progress-bar">
        <div class="kpi-progress-fill" style="width: ${info.percent}%; background-color: ${def.color};"></div>
      </div>
    `;
    container.appendChild(item);
  });
}

function getHeatLevel(value) {
  if (value >= 5) return 4;
  if (value >= 3) return 3;
  if (value >= 2) return 2;
  if (value >= 1) return 1;
  return 0;
}

function renderHeatmap() {
  const container = document.getElementById('heatmap');
  container.innerHTML = '';
  const year = currentMonth.getFullYear();
  document.getElementById('heatmap-year-label').textContent = year;
  const counts = {};
  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    if (date.getFullYear() !== year) return;
    const completed = activities.filter(a => a.completed).length;
    if (completed > 0) counts[dateString] = (counts[dateString] || 0) + completed;
  });
  Object.entries(state.extras).forEach(([dateString, extras]) => {
    const date = parseDate(dateString);
    if (date.getFullYear() !== year) return;
    const completed = extras.filter(e => e.completed).length;
    if (completed > 0) counts[dateString] = (counts[dateString] || 0) + completed;
  });

  const start = new Date(year, 0, 1);
  const offset = (start.getDay() + 6) % 7;
  start.setDate(start.getDate() - offset);

  for (let week = 0; week < 53; week++) {
    const weekStart = addDays(start, week * 7);
    if (weekStart.getFullYear() > year && weekStart.getMonth() > 0) break;

    const column = document.createElement('div');
    column.className = 'heatmap-week';
    let monthLabel = '';
    
    // Check if this week contains the end of a month
    for (let day = 0; day < 7; day++) {
        const current = addDays(weekStart, day);
        const next = addDays(current, 1);
        if (current.getMonth() !== next.getMonth() && current.getFullYear() === year) {
            column.style.marginRight = '8px'; // Add wider gap
            const monthDate = new Date(year, current.getMonth(), 1);
            monthLabel = monthDate.toLocaleDateString('pl-PL', { month: 'short' }).replace('.', '').toUpperCase();
            break; // Found the end of the month, no need to check further
        }
    }

    // Create day cells
    for (let day = 0; day < 7; day++) {
      const current = addDays(weekStart, day);
      const key = toYYYYMMDD(current);
      const cell = document.createElement('div');
      cell.className = 'heatmap-cell';
      if (current.getFullYear() === year) {
        const value = counts[key] || 0;
        const level = getHeatLevel(value);
        cell.dataset.level = level;
        const labelText = current.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' });
        cell.title = value > 0 ? `${labelText}: ${value} uko≈Ñczone aktywno≈õci` : labelText;
      } else {
        cell.classList.add('heatmap-cell--empty');
      }
      column.appendChild(cell);
    }
    
    const label = document.createElement('span');
    label.className = 'heatmap-month-label';
    label.textContent = monthLabel;
    column.appendChild(label);
    
    container.appendChild(column);
  }
}

function loadBodyMetrics() {
  const parsed = safeParse(localStorage.getItem(BODY_METRICS_KEY), () => []);
  bodyMetrics = Array.isArray(parsed)
    ? parsed.map(normalizeMetricEntry).filter(Boolean)
    : [];
}

function saveBodyMetrics(message = 'Zapisano log wagi') {
  localStorage.setItem(BODY_METRICS_KEY, JSON.stringify(bodyMetrics));
  showSaveStatus(message);
}

function loadBodyMetricsGoal() {
  const parsed = safeParse(localStorage.getItem(BODY_METRICS_GOAL_KEY), () => null);
  const numeric = Number(parsed);
  targetBfGoal = Number.isFinite(numeric) ? numeric : null;
}

function saveBodyMetricsGoal() {
  if (!Number.isFinite(targetBfGoal)) {
    localStorage.removeItem(BODY_METRICS_GOAL_KEY);
    return;
  }
  localStorage.setItem(BODY_METRICS_GOAL_KEY, JSON.stringify(targetBfGoal));
}

function parseMetricValue(value) {
  if (value === '' || value === null || value === undefined) return null;
  const numeric = Number(value);
  return Number.isFinite(numeric) ? numeric : null;
}

function calculateBMI(weight, heightCm) {
  if (!Number.isFinite(weight) || !Number.isFinite(heightCm) || heightCm <= 0) return null;
  const heightM = heightCm / 100;
  return weight / (heightM * heightM);
}

function calculateLBM(weight, bf) {
  if (!Number.isFinite(weight) || !Number.isFinite(bf)) return null;
  return weight * (1 - bf / 100);
}

function normalizeMetricEntry(entry) {
  if (!entry || typeof entry !== 'object') return null;
  const weight = Number.isFinite(entry.weight) ? entry.weight : null;
  const bf = Number.isFinite(entry.bf) ? entry.bf : null;
  const height = Number.isFinite(entry.height) ? entry.height : null;
  const cycle = entry.cycle || entry.cut || null;
  const heightFromBmi = Number.isFinite(entry.bmi) && Number.isFinite(weight) && (!height || height <= 0)
    ? Math.sqrt(weight / entry.bmi) * 100
    : null;
  const normalizedHeight = Number.isFinite(height) ? height : (Number.isFinite(heightFromBmi) ? heightFromBmi : null);
  return {
    id: entry.id || `metric_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    date: entry.date,
    cycle,
    weight,
    bf,
    height: normalizedHeight
  };
}

function getUniqueCycles() {
  const cycles = new Set();
  bodyMetrics.forEach(entry => {
    if (entry && entry.cycle) cycles.add(entry.cycle);
  });
  return Array.from(cycles);
}

function sortMetricsByDate(list) {
  return list.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
}

function getMetricsForCycle(cycle) {
  if (!cycle || cycle === 'all') return sortMetricsByDate(bodyMetrics);
  return sortMetricsByDate(bodyMetrics.filter(entry => entry.cycle === cycle));
}

function getMetricValue(entry, metricKey) {
  if (!entry) return null;
  if (metricKey === 'bmi') return calculateBMI(entry.weight, entry.height);
  if (metricKey === 'lbm') return calculateLBM(entry.weight, entry.bf);
  return entry[metricKey];
}

function formatMetric(value, unit = '') {
  return Number.isFinite(value) ? `${value.toFixed(1)}${unit}` : '--';
}

function updateMetricsPreview() {
  const weight = parseMetricValue(document.getElementById('metrics-weight')?.value);
  const bf = parseMetricValue(document.getElementById('metrics-bf')?.value);
  const height = parseMetricValue(document.getElementById('metrics-height')?.value);
  const bmiPreview = document.getElementById('metrics-bmi-preview');
  const lbmPreview = document.getElementById('metrics-lbm-preview');
  if (bmiPreview) bmiPreview.textContent = formatMetric(calculateBMI(weight, height));
  if (lbmPreview) lbmPreview.textContent = formatMetric(calculateLBM(weight, bf), ' kg');
}

function calculateBfTrend(entries) {
  if (!entries.length) return null;
  const now = new Date();
  const windowStart = new Date(now.getTime() - 28 * DAY_MS);
  const recent = entries.filter(entry => {
    const date = parseDate(entry.date);
    return date >= windowStart && date <= now && Number.isFinite(entry.bf);
  });
  if (recent.length < 2) return null;
  const sorted = sortMetricsByDate(recent);
  const first = sorted[0];
  const last = sorted[sorted.length - 1];
  const days = Math.max(1, (parseDate(last.date) - parseDate(first.date)) / DAY_MS);
  const delta = last.bf - first.bf;
  return { dailyRate: delta / days, startBf: first.bf, currentBf: last.bf, startDate: first.date };
}

function renderRoadToSummer(entries) {
  const targetInput = document.getElementById('metrics-target-bf');
  const goalDateEl = document.getElementById('metrics-goal-date');
  const progressEl = document.getElementById('metrics-goal-progress');
  const barFill = document.getElementById('metrics-goal-bar-fill');
  if (!targetInput || !goalDateEl || !progressEl || !barFill) return;

  if (!targetInput.value && Number.isFinite(targetBfGoal)) {
    targetInput.value = targetBfGoal.toFixed(1);
  }

  const targetBf = parseMetricValue(targetInput.value);
  const trend = calculateBfTrend(entries);
  const currentBf = trend?.currentBf ?? (entries.length ? entries[entries.length - 1]?.bf : null);
  if (!Number.isFinite(targetBf) || !Number.isFinite(currentBf)) {
    goalDateEl.textContent = 'Podaj cel BF i aktualny pomiar.';
    progressEl.textContent = '0% drogi do celu';
    barFill.style.width = '0%';
    return;
  }

  if (!trend || trend.dailyRate >= 0) {
    goalDateEl.textContent = 'Brak spadku BF w ostatnich 4 tygodniach.';
  } else {
    const remaining = currentBf - targetBf;
    const daysNeeded = remaining / Math.abs(trend.dailyRate);
    const targetDate = new Date(Date.now() + daysNeeded * DAY_MS);
    goalDateEl.textContent = `Szacowana data celu: ${targetDate.toLocaleDateString('pl-PL')}`;
  }

  const startBf = Number.isFinite(trend?.startBf) ? trend.startBf : currentBf;
  const denominator = startBf - targetBf;
  const progress = denominator > 0 ? (startBf - currentBf) / denominator : 0;
  const clamped = Math.max(0, Math.min(1, progress));
  barFill.style.width = `${(clamped * 100).toFixed(0)}%`;
  progressEl.textContent = `${(clamped * 100).toFixed(0)}% drogi do celu`;
}

function getTrendData(metricKey, currentEntry, previousEntry) {
  if (!currentEntry || !previousEntry) {
    return { tone: 'neutral', icon: 'minus', text: 'Brak trendu' };
  }
  const currentValue = getMetricValue(currentEntry, metricKey);
  const previousValue = getMetricValue(previousEntry, metricKey);
  if (!Number.isFinite(currentValue) || !Number.isFinite(previousValue)) {
    return { tone: 'neutral', icon: 'minus', text: 'Brak trendu' };
  }
  const delta = currentValue - previousValue;
  if (Math.abs(delta) < 0.1) {
    return { tone: 'neutral', icon: 'minus', text: 'Stabilnie' };
  }

  const unit = metricKey === 'bf' ? '%' : ' kg';
  const icon = delta > 0 ? 'arrow-up' : 'arrow-down';
  const text = `${delta > 0 ? '+' : ''}${delta.toFixed(1)}${unit}`;
  let tone = 'neutral';

  if (metricKey === 'bf') {
    tone = delta < 0 ? 'good' : 'bad';
  } else if (metricKey === 'lbm') {
    tone = delta > 0 ? 'good' : 'bad';
  } else if (metricKey === 'weight') {
    tone = delta < 0 ? 'good' : 'neutral';
  }

  return { tone, icon, text };
}

function classifyBodyChange(current, previous) {
  if (!previous) return { status: 'start', tone: 'success' };
  const weightDelta = Number.isFinite(current?.weight) && Number.isFinite(previous?.weight)
    ? current.weight - previous.weight
    : null;
  const bfDelta = Number.isFinite(current?.bf) && Number.isFinite(previous?.bf)
    ? current.bf - previous.bf
    : null;
  const currentLbm = calculateLBM(current?.weight, current?.bf);
  const previousLbm = calculateLBM(previous?.weight, previous?.bf);
  const lbmDelta = Number.isFinite(currentLbm) && Number.isFinite(previousLbm)
    ? currentLbm - previousLbm
    : null;

  if (!Number.isFinite(weightDelta) || !Number.isFinite(bfDelta)) {
    return { status: 'incomplete', tone: 'warning' };
  }

  const weightDown = weightDelta < -0.2;
  const weightUp = weightDelta > 0.2;
  const weightStableOrSlightUp = weightDelta >= -0.2 && weightDelta <= 0.3;
  const bfDown = bfDelta < -0.2;
  const bfUp = bfDelta > 0.2;
  const lbmUp = Number.isFinite(lbmDelta) && lbmDelta > 0.2;

  if (weightDown && bfDown) return { status: 'clean_cut', tone: 'success' };
  if (weightStableOrSlightUp && bfDown) return { status: 'recomp', tone: 'success' };
  if (weightUp && lbmUp) return { status: 'clean_bulk', tone: 'success' };
  if (weightUp && bfUp) return { status: 'dirty_bulk', tone: 'danger' };
  return { status: 'mixed', tone: 'warning' };
}

function getStatusMessage(current, previous) {
  const classification = classifyBodyChange(current, previous);
  const messages = {
    start: '≈öwietny start! Dodaj kolejny log, by zobaczyƒá status sylwetki.',
    incomplete: 'Uzupe≈Çnij wagƒô i BF w obu logach, aby oceniƒá status sylwetki.',
    clean_cut: 'Czysta redukcja ‚Äî tempo jest idealne. Utrzymaj kurs!',
    recomp: 'Jeste≈õ w trybie idealnej rekompozycji ‚Äì tak trzymaj do wakacji!',
    clean_bulk: 'Czysta masa ‚Äî miƒô≈õnie rosnƒÖ w dobrym tempie. Brawo!',
    dirty_bulk: 'Nadmiar kalorii ‚Äî pilnuj jako≈õci jedzenia i tempa przyrostu.',
    mixed: 'Trend mieszany ‚Äî obserwuj kolejne pomiary i dopnij rutynƒô.'
  };
  const toneClass = classification.tone === 'success' ? 'good' : classification.tone;
  return { tone: toneClass, text: messages[classification.status] || messages.mixed };
}

function renderWeightBfChart(entries) {
  const canvas = document.getElementById('metrics-weight-bf-chart');
  if (!canvas || typeof Chart === 'undefined') return;
  const ctx = canvas.getContext('2d');
  if (!ctx) return;

  const points = entries
    .map(entry => ({
      date: entry.date,
      weight: getMetricValue(entry, 'weight'),
      bf: getMetricValue(entry, 'bf'),
      bmi: getMetricValue(entry, 'bmi'),
      lbm: getMetricValue(entry, 'lbm')
    }))
    .filter(point => Number.isFinite(point.weight) || Number.isFinite(point.bf));

  if (bodyMetricsChart) {
    bodyMetricsChart.destroy();
    bodyMetricsChart = null;
  }

  if (points.length === 0) return;

  const primary = getCssVar('--primary', '#6366f1');
  const accent = getCssVar('--warning', '#f59e0b');
  const textColor = getCssVar('--muted', '#64748b');
  const gridColor = '#e2e8f0';

  const gradient = ctx.createLinearGradient(0, 0, 0, 240);
  gradient.addColorStop(0, 'rgba(99, 102, 241, 0.35)');
  gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

  bodyMetricsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: points.map(point => point.date),
      datasets: [
        {
          label: 'Waga (kg)',
          data: points.map(point => point.weight),
          borderColor: primary,
          backgroundColor: gradient,
          fill: true,
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: '#fff',
          pointBorderColor: primary,
          yAxisID: 'yWeight'
        },
        {
          label: 'Body Fat %',
          data: points.map(point => point.bf),
          borderColor: accent,
          borderDash: [6, 4],
          backgroundColor: 'transparent',
          tension: 0.35,
          pointRadius: 3,
          pointBackgroundColor: '#fff',
          pointBorderColor: accent,
          yAxisID: 'yBf'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: true, labels: { color: textColor, font: { size: 11 } } },
        tooltip: {
          callbacks: {
            afterBody: context => {
              if (!context.length) return '';
              const index = context[0].dataIndex;
              const point = points[index];
              const bmi = Number.isFinite(point.bmi) ? point.bmi.toFixed(1) : '--';
              const lbm = Number.isFinite(point.lbm) ? point.lbm.toFixed(1) : '--';
              return [`BMI: ${bmi}`, `LBM: ${lbm} kg`];
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: textColor, font: { size: 10 } }
        },
        yWeight: {
          position: 'left',
          title: { display: true, text: 'Waga (kg)', color: textColor, font: { size: 11 } },
          grid: { color: gridColor },
          ticks: { color: textColor }
        },
        yBf: {
          position: 'right',
          title: { display: true, text: 'Body Fat %', color: textColor, font: { size: 11 } },
          grid: { drawOnChartArea: false },
          ticks: { color: textColor }
        }
      }
    }
  });
}

function renderMetricChart(containerId, entries, metricKey, unit, trendDirection) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const points = entries
    .map(entry => ({ date: entry.date, value: getMetricValue(entry, metricKey) }))
    .filter(point => Number.isFinite(point.value));

  if (points.length === 0) {
    container.innerHTML = `<div class="metrics-chart-empty">Brak danych dla tego parametru.</div>`;
    return;
  }

  const width = 260;
  const height = 120;
  const padding = 14;
  const values = points.map(point => point.value);
  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = max - min || 1;

  const coords = points.map((point, index) => {
    const x = padding + (index / Math.max(points.length - 1, 1)) * (width - padding * 2);
    const y = height - padding - ((point.value - min) / range) * (height - padding * 2);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  });

  const path = coords.join(' ');
  const first = points[0];
  const last = points[points.length - 1];
  const trend = last.value - first.value;
  const trendLabel = trendDirection === 'down'
    ? (trend <= 0 ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è')
    : (trend >= 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è');

  container.innerHTML = `
    <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
      <polyline fill="none" stroke="var(--primary)" stroke-width="2.5" points="${path}" />
      <polyline fill="rgba(99, 102, 241, 0.1)" stroke="none"
        points="${path} ${width - padding},${height - padding} ${padding},${height - padding}" />
      <circle cx="${coords[coords.length - 1].split(',')[0]}" cy="${coords[coords.length - 1].split(',')[1]}" r="3.5" fill="var(--primary)" />
    </svg>
    <div class="tiny muted" style="margin-top: -4px;">${first.date} ‚Üí ${last.date} ${trendLabel}</div>
  `;
}

function getMetricSummary(entries, metricKey, unit, trendDirection) {
  const values = entries.map(entry => getMetricValue(entry, metricKey)).filter(value => Number.isFinite(value));
  if (values.length === 0) return '--';
  const first = values[0];
  const last = values[values.length - 1];
  const diff = last - first;
  const arrow = trendDirection === 'down'
    ? (diff <= 0 ? '‚ñº' : '‚ñ≤')
    : (diff >= 0 ? '‚ñ≤' : '‚ñº');
  const unitLabel = unit ? ` ${unit}` : '';
  const diffLabel = `${diff >= 0 ? '+' : ''}${diff.toFixed(1)}${unitLabel}`;
  return `${last.toFixed(1)}${unitLabel} (${arrow} ${diffLabel})`;
}

function updateMetricsFeedback(message, tone = '') {
  const feedback = document.getElementById('metrics-feedback');
  if (!feedback) return;
  feedback.classList.remove('success', 'warning', 'danger');
  if (tone) feedback.classList.add(tone);
  feedback.textContent = message;
}

function renderBodyMetrics() {
  const logList = document.getElementById('metrics-log-list');
  const cycleFilter = document.getElementById('metrics-cycle-filter');
  const cycleList = document.getElementById('metrics-cycle-list');
  if (!logList || !cycleFilter || !cycleList) return;

  const cycles = getUniqueCycles();
  const formDate = document.getElementById('metrics-date');
  if (formDate && !formDate.value) formDate.value = toYYYYMMDD(new Date());

  cycleList.innerHTML = cycles.map(cycle => `<option value="${cycle}"></option>`).join('');
  cycleFilter.innerHTML = `
    <option value="all">Wszystkie</option>
    ${cycles.map(cycle => `<option value="${cycle}">${cycle}</option>`).join('')}
  `;
  if (!cycles.includes(selectedCycle) && selectedCycle !== 'all') selectedCycle = 'all';
  cycleFilter.value = selectedCycle;

  const filtered = getMetricsForCycle(selectedCycle);
  const summary = document.getElementById('metrics-cycle-summary');
  if (summary) {
    if (!filtered.length) {
      summary.textContent = 'Brak danych dla wybranego cyklu.';
    } else {
      const start = filtered[0].date;
      const end = filtered[filtered.length - 1].date;
      summary.textContent = `${filtered.length} log√≥w ¬∑ ${start} ‚Üí ${end}`;
    }
  }

  const latest = filtered[filtered.length - 1] || null;
  const previous = filtered.length > 1 ? filtered[filtered.length - 2] : null;
  const weightValue = getMetricValue(latest, 'weight');
  const bfValue = getMetricValue(latest, 'bf');
  const lbmValue = getMetricValue(latest, 'lbm');

  const weightValueEl = document.getElementById('metrics-weight-value');
  const bfValueEl = document.getElementById('metrics-bf-value');
  const muscleValueEl = document.getElementById('metrics-muscle-value');
  if (weightValueEl) weightValueEl.textContent = formatMetric(weightValue, ' kg');
  if (bfValueEl) bfValueEl.textContent = formatMetric(bfValue, '%');
  if (muscleValueEl) muscleValueEl.textContent = formatMetric(lbmValue, ' kg');

  const applyTrend = (elementId, trend) => {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.className = `metrics-trend ${trend.tone}`;
    el.innerHTML = `<i data-lucide="${trend.icon}" class="icon"></i>${trend.text}`;
  };

  applyTrend('metrics-weight-trend', getTrendData('weight', latest, previous));
  applyTrend('metrics-bf-trend', getTrendData('bf', latest, previous));
  applyTrend('metrics-muscle-trend', getTrendData('lbm', latest, previous));

  const status = getStatusMessage(latest, previous);
  const statusCard = document.getElementById('metrics-status-card');
  const statusText = document.getElementById('metrics-status-text');
  if (statusCard) {
    statusCard.classList.remove('good', 'warning', 'danger');
    if (status.tone) statusCard.classList.add(status.tone);
  }
  if (statusText) statusText.textContent = status.text;

  renderWeightBfChart(filtered);
  updateMetricsPreview();
  renderRoadToSummer(filtered);

  if (!filtered.length) {
    logList.innerHTML = `<p class="muted tiny">Brak zapisanych log√≥w. Dodaj pierwszy wpis.</p>`;
  } else {
    logList.innerHTML = '';
    filtered.slice().reverse().forEach(entry => {
      const item = document.createElement('div');
      item.className = 'metrics-log-item';
      const bmiValue = getMetricValue(entry, 'bmi');
      const lbmValue = getMetricValue(entry, 'lbm');
      item.innerHTML = `
        <div>
          <strong>${entry.date}</strong>
          <div class="tiny muted">${entry.cycle || 'Bez cyklu'} ¬∑ W: ${entry.weight ?? '--'} kg ¬∑ BF: ${entry.bf ?? '--'}% ¬∑ BMI: ${Number.isFinite(bmiValue) ? bmiValue.toFixed(1) : '--'} ¬∑ LBM: ${Number.isFinite(lbmValue) ? lbmValue.toFixed(1) : '--'} kg</div>
        </div>
        <div class="metrics-actions">
          <button class="btn ghost small" data-edit-id="${entry.id}"><i data-lucide="edit-3" class="icon"></i></button>
          <button class="btn ghost small" data-delete-id="${entry.id}"><i data-lucide="trash-2" class="icon"></i></button>
        </div>
      `;
      item.querySelector('[data-delete-id]')?.addEventListener('click', () => {
        bodyMetrics = bodyMetrics.filter(item => item.id !== entry.id);
        saveBodyMetrics('Usuniƒôto log');
        renderBodyMetrics();
      });
      item.querySelector('[data-edit-id]')?.addEventListener('click', () => showEditMetricsModal(entry));
      logList.appendChild(item);
    });
  }
  lucide.createIcons();
}

function getWeekKey(date) {
  const info = getISOWeekInfo(date);
  return `${info.year}-W${String(info.week).padStart(2, '0')}`;
}

function getCssVar(name, fallback) {
  const value = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return value || fallback;
}

function getLastWeeks(count) {
  const result = [];
  const today = normalizeDate(new Date());
  for (let i = count - 1; i >= 0; i--) {
    const date = addDays(today, -7 * i);
    const weekInfo = getISOWeekInfo(date);
    const weekStart = startOfWeek(date);
    result.push({ key: getWeekKey(date), label: `${weekInfo.week}`, start: weekStart, end: addDays(weekStart, 6), info: weekInfo });
  }
  return result;
}

// ==========================================
// NEW ANALYTICS LOGIC
// ==========================================

function calculateHabitScore() {
    const today = normalizeDate(new Date());
    let activeDays = 0;
    
    // Last 30 days
    for(let i=0; i<30; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const k = toYYYYMMDD(d);
        const acts = (state.activities[k] || []).filter(a => a.completed);
        const extras = (state.extras[k] || []).filter(e => e.completed);
        if (acts.length > 0 || extras.length > 0) activeDays++;
    }
    
    const consistency = (activeDays / 30) * 100;
    return Math.round(consistency);
}

function calculateStreak() {
    const today = normalizeDate(new Date());
    let streak = 0;
    let checkDate = new Date(today);
    
    // Check up to 365 days back
    for(let i=0; i<365; i++) {
        const k = toYYYYMMDD(checkDate);
        const acts = (state.activities[k] || []).filter(a => a.completed);
        const extras = (state.extras[k] || []).filter(e => e.completed);
        
        // If today has no activity yet, don't break streak, just don't count it yet
        if (i === 0 && acts.length === 0 && extras.length === 0) {
            checkDate.setDate(checkDate.getDate() - 1);
            continue;
        }

        if (acts.length > 0 || extras.length > 0) {
            streak++;
        } else {
            break;
        }
        checkDate.setDate(checkDate.getDate() - 1);
    }
    return streak;
}

function getAnalyticsData() {
    // 1. Momentum (Last 12 weeks activity volume)
    const weeks = getLastWeeks(12);
    const momentumData = weeks.map(w => {
        let count = 0;
        let d = new Date(w.start);
        while(d <= w.end) {
            const k = toYYYYMMDD(d);
            const acts = (state.activities[k] || []).filter(a => a.completed);
            count += acts.length;
            d.setDate(d.getDate() + 1);
        }
        return count;
    });

    // 2. Current Week Radar Data
    const weekStats = calculateWeeklyGoalStats(new Date());
    const weekRadarData = [
        weekStats.goalPercents.gym?.percent || 0,
        weekStats.goalPercents.running?.percent || 0,
        weekStats.goalPercents.reading?.percent || 0
    ];

    // 3. Rhythm (Day of week frequency - all time or last 90 days)
    const rhythmCounts = [0,0,0,0,0,0,0]; // Mon-Sun
    const dayMap = [6, 0, 1, 2, 3, 4, 5]; // Sun(0)->6, Mon(1)->0
    const today = normalizeDate(new Date());
    
    const ninetyDaysAgo = new Date(today);
    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
    let cursor = new Date(ninetyDaysAgo);
    while(cursor <= today) {
        const k = toYYYYMMDD(cursor);
        const acts = (state.activities[k] || []).filter(a => a.completed);
        if(acts.length > 0) {
            const jsDay = cursor.getDay();
            const idx = dayMap[jsDay];
            rhythmCounts[idx] += acts.length; // Count volume not just days
        }
        cursor.setDate(cursor.getDate() + 1);
    }

    return { weeks, momentumData, weekRadarData, rhythmCounts };
}

function renderNewAnalytics() {
    if (typeof Chart === 'undefined') return;
    
    const data = getAnalyticsData();
    const score = calculateHabitScore();
    const streak = calculateStreak();

    // Update DOM Score Cards
    document.getElementById('habit-score-value').textContent = score;
    document.getElementById('streak-value').textContent = streak;

    const colors = {
        primary: getCssVar('--primary', '#6366f1'),
        success: getCssVar('--success', '#22c55e'),
        warning: getCssVar('--warning', '#f59e0b'),
        surface: getCssVar('--surface', '#ffffff'),
        gray: '#e2e8f0'
    };

    // 1. Momentum Chart (Last 12 Weeks)
    const ctxMomentum = document.getElementById('analytics-12w-chart')?.getContext('2d');
    if (ctxMomentum) {
        if (analyticsCharts.momentum) analyticsCharts.momentum.destroy();
        
        const gradient = ctxMomentum.createLinearGradient(0, 0, 0, 200);
        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
        gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

        analyticsCharts.momentum = new Chart(ctxMomentum, {
            type: 'line',
            data: {
                labels: data.weeks.map(w => w.label),
                datasets: [{
                    label: 'Uko≈Ñczone sesje',
                    data: data.momentumData,
                    borderColor: colors.primary,
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: colors.primary,
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } },
                    y: { beginAtZero: true, grid: { color: '#e2e8f0', borderDash: [5, 5] }, ticks: { color: '#94a3b8', stepSize: 1 } }
                }
            }
        });
    }

    // 2. Current Week Radar
    const ctxRadar = document.getElementById('analytics-week-radar')?.getContext('2d');
    if (ctxRadar) {
        if (analyticsCharts.radar) analyticsCharts.radar.destroy();
        analyticsCharts.radar = new Chart(ctxRadar, {
            type: 'radar',
            data: {
                labels: ['Si≈Çownia', 'Bieganie', 'Czytanie'],
                datasets: [{
                    label: 'Postƒôp %',
                    data: data.weekRadarData,
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    borderColor: colors.primary,
                    pointBackgroundColor: colors.primary,
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: colors.primary
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    r: {
                        angleLines: { color: '#e2e8f0' },
                        grid: { color: '#e2e8f0' },
                        pointLabels: { color: '#64748b', font: { size: 11, weight: 600 } },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        ticks: { backdropColor: 'transparent', display: false }
                    }
                }
            }
        });
    }

    // 3. Monthly Consistency (Stacked Bar with specific "Week end determines month" logic)
    renderAnalyticsMonthlyComparison(colors);

    // 4. Rhythm Chart (Bar)
    const ctxRhythm = document.getElementById('analytics-weekly-consistency')?.getContext('2d');
    if (ctxRhythm) {
        if (analyticsCharts.rhythm) analyticsCharts.rhythm.destroy();
        analyticsCharts.rhythm = new Chart(ctxRhythm, {
            type: 'bar',
            data: {
                labels: ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So', 'Nd'],
                datasets: [{
                    label: 'Wolumen aktywno≈õci',
                    data: data.rhythmCounts,
                    backgroundColor: colors.primary,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                    y: { display: false }
                }
            }
        });
    }
}

function renderAnalyticsMonthlyComparison(colors) {
    const canvas = document.getElementById('analytics-monthly-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const year = currentMonth.getFullYear();
    const monthStats = Array.from({ length: 12 }, () => ({ totalWeeks: 0, completedWeeks: 0 }));
    
    // Logic: Iterate all weeks of the year. Week belongs to Month of the Sunday (End of week).
    // Start from Week 1 of the year.
    let currentWeekStart = getISOWeekStart(year, 1);
    // Safety break loop
    let guard = 0;
    
    while (guard < 60) { // Max 53 weeks
        const weekEnd = addDays(currentWeekStart, 6);
        
        // If week starts in next year, stop. But handle weeks spanning years carefully.
        // We focus on weeks where the END date is in the current year.
        if (weekEnd.getFullYear() > year) break;
        if (weekEnd.getFullYear() < year) {
             currentWeekStart = addDays(currentWeekStart, 7);
             guard++;
             continue;
        }

        const monthIndex = weekEnd.getMonth();
        monthStats[monthIndex].totalWeeks++;

        // Check if week is completed (100% of all goals)
        const stats = calculateWeeklyGoalStats(currentWeekStart);
        const goals = Object.values(stats.goalPercents || {});
        // Consider week completed if at least one goal exists and ALL goals are >= 100%
        if (goals.length > 0 && goals.every(goal => Number(goal.percent || 0) >= 100)) {
            monthStats[monthIndex].completedWeeks++;
        }

        currentWeekStart = addDays(currentWeekStart, 7);
        guard++;
    }

    const monthLabels = ['Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze', 'Lip', 'Sie', 'Wrz', 'Pa≈∫', 'Lis', 'Gru'];
    
    if (analyticsCharts.monthly) analyticsCharts.monthly.destroy();
    
    analyticsCharts.monthly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: monthLabels,
            datasets: [
                { 
                    label: 'Uko≈Ñczone', 
                    data: monthStats.map(m => m.completedWeeks), 
                    backgroundColor: colors.success, 
                    borderRadius: 4,
                    stack: 'Stack 0'
                },
                { 
                    label: 'Pozosta≈Çe', 
                    data: monthStats.map(m => m.totalWeeks - m.completedWeeks), 
                    backgroundColor: colors.gray, 
                    borderRadius: 4,
                    stack: 'Stack 0'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { stacked: true, grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } },
                y: { stacked: true, display: false } // Hide Y axis for cleaner look
            }
        }
    });
}


function showEditMetricsModal(entry) {
  if (!entry) return;
  showModal({
    title: 'Edytuj log',
    text: 'Zmie≈Ñ dane i zapisz ponownie.',
    inputs: [
      { label: 'Data', type: 'date', value: entry.date, key: 'date' },
      { label: 'Cykl', type: 'text', value: entry.cycle, key: 'cycle' },
      { label: 'Waga (kg)', type: 'number', value: entry.weight ?? '', step: '0.1', key: 'weight' },
      { label: 'BF (%)', type: 'number', value: entry.bf ?? '', step: '0.1', key: 'bf' },
      { label: 'Wzrost (cm)', type: 'number', value: entry.height ?? '', step: '0.1', key: 'height' }
    ],
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Zapisz', class: 'btn', action: (value) => {
          if (!value || !value.cycle) return false;
          entry.date = value.date || entry.date;
          entry.cycle = value.cycle || entry.cycle;
          entry.weight = parseMetricValue(value.weight);
          entry.bf = parseMetricValue(value.bf);
          entry.height = parseMetricValue(value.height);
          selectedCycle = entry.cycle;
          saveBodyMetrics('Zaktualizowano log');
          renderBodyMetrics();
        } }
    ]
  });
}

function evaluateProgress(current, previous) {
  const classification = classifyBodyChange(current, previous);
  if (classification.status === 'start') {
    return { tone: 'success', message: 'Super start! Pierwszy log zapisany ‚Äî teraz budujemy trend.' };
  }
  if (classification.status === 'incomplete') {
    return { tone: 'warning', message: 'Dodaj wagƒô i BF w obu logach, aby sklasyfikowaƒá zmianƒô sylwetki.' };
  }

  const messages = {
    clean_cut: { tone: 'success', message: 'Czysta redukcja: waga w d√≥≈Ç i BF w d√≥≈Ç.' },
    recomp: { tone: 'success', message: 'Rekompozycja: BF w d√≥≈Ç, waga stoi lub lekko ro≈õnie.' },
    clean_bulk: { tone: 'success', message: 'Czysta masa: waga w g√≥rƒô i LBM w g√≥rƒô.' },
    dirty_bulk: { tone: 'danger', message: 'Nadmiar kalorii (Dirty bulk): waga i BF rosnƒÖ.' },
    mixed: { tone: 'warning', message: 'Zmiana niejednoznaczna. Sprawd≈∫ trend w kolejnych pomiarach.' }
  };
  return messages[classification.status] || messages.mixed;
}


function addTraining(dateString, type, plannedValue) {
  ensureDay(dateString);
  state.activities[dateString].push({
    id: `act_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    type,
    plannedValue: type === 'gym' ? 1 : Number(plannedValue) || 0,
    loggedValue: 0,
    completed: false,
    createdAt: Date.now()
  });
  if (state.vacations && state.vacations[dateString]) delete state.vacations[dateString];
  saveState();
  render();
}

function addExtra(dateString, title, category, emoji) {
  ensureDay(dateString);
  state.extras[dateString].push({
    id: `extra_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    title,
    category,
    emoji: emoji || ACTIVITY_EMOJIS.extra,
    completed: false,
    createdAt: Date.now()
  });
  if (state.vacations && state.vacations[dateString]) delete state.vacations[dateString];
  saveState();
  render();
}

function completeActivity(day, id) {
  const activities = state.activities[day] || [];
  const activity = activities.find(a => a.id === id);
  if (!activity) return;
  if (activity.type === 'gym') {
    activity.completed = true;
    activity.loggedValue = 1;
    saveState();
    render();
  } else {
    showLogModal(activity, day);
  }
}

function showLogModal(activity, day) {
  const goal = GOAL_DEFINITIONS[activity.type];
  showModal({
    title: `Zaloguj ${goal.label.toLowerCase()}`,
    text: `Podaj zrealizowanƒÖ warto≈õƒá dla ${formatDateWithDay(parseDate(day))}.`,
    input: { type: 'number', value: activity.loggedValue || activity.plannedValue || '', placeholder: `Warto≈õƒá w ${goal.unit}`, min: '0', step: '1' },
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Zapisz', class: 'btn', action: (value) => {
          const numeric = Number(value);
          if (Number.isNaN(numeric) || numeric < 0) return false;
          activity.loggedValue = numeric;
          activity.completed = true;
          saveState();
          render();
        } }
    ]
  });
}

function editActivity(day, id) {
  const activity = (state.activities[day] || []).find(a => a.id === id);
  if (!activity || activity.type === 'gym') return;
  showLogModal(activity, day);
}

function undoActivity(day, id) {
  const activity = (state.activities[day] || []).find(a => a.id === id);
  if (!activity) return;
  activity.completed = false;
  activity.loggedValue = 0;
  saveState();
  render();
}

function deleteActivity(day, id) {
  if (!state.activities[day]) return;
  state.activities[day] = state.activities[day].filter(a => a.id !== id);
  saveState();
  render();
}

function toggleExtra(day, id) {
  const extra = (state.extras[day] || []).find(e => e.id === id);
  if (!extra) return;
  extra.completed = !extra.completed;
  saveState();
  render();
}

function deleteExtra(day, id) {
  if (!state.extras[day]) return;
  state.extras[day] = state.extras[day].filter(e => e.id !== id);
  saveState();
  render();
}

function showAddTrainingModal() {
  const date = parseDate(selectedDate);
  showModal({
    title: 'Zaplanuj trening',
    text: `Dodaj aktywno≈õƒá na ${date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' })}.`,
    input: { type: 'number', placeholder: 'Docelowa warto≈õƒá', min: '0', step: '1' },
    options: [
      { value: 'gym', label: 'üèãÔ∏è Trening si≈Çowy', checked: true },
      { value: 'running', label: 'üèÉ Bieganie' },
      { value: 'reading', label: 'üìö Czytanie' }
    ],
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Planowanie wielu dni', class: 'btn ghost', action: (value, selected) => {
          const type = selected || 'gym';
          if (type !== 'gym') {
            const numeric = Number(value);
            if (!numeric || numeric <= 0) return false;
            startPlanningMode(type, numeric);
          } else {
            startPlanningMode(type, 1);
          }
        } },
      { text: 'Dodaj na dzi≈õ', class: 'btn', action: (value, selected) => {
          const type = selected || 'gym';
          if (type !== 'gym') {
            const numeric = Number(value);
            if (!numeric || numeric <= 0) return false;
            addTraining(selectedDate, type, numeric);
          } else {
            addTraining(selectedDate, type, 1);
          }
        } }
    ],
    onShow: ({ overlay, input }) => {
      const radios = overlay.querySelectorAll('input[name="modal-option"]');
      const update = () => {
        const type = overlay.querySelector('input[name="modal-option"]:checked')?.value;
        if (!input) return;
        if (type === 'gym') {
          input.value = '';
          input.placeholder = 'Sesja si≈Çowa ‚Äì bez dodatkowej warto≈õci';
          input.disabled = true;
        } else if (type === 'running') {
          input.disabled = false;
          input.placeholder = 'Cel w kilometrach';
        } else if (type === 'reading') {
          input.disabled = false;
          input.placeholder = 'Cel w stronach';
        }
      };
      update();
      radios.forEach(radio => radio.addEventListener('change', update));
    }
  });
}

function showAddExtraModal() {
  const date = parseDate(selectedDate);
  showModal({
    title: 'Dodaj aktywno≈õƒá dodatkowƒÖ',
    text: `Dodaj drobne dzia≈Çanie na ${date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' })}.`,
    inputs: [
        { type: 'text', placeholder: 'Opis aktywno≈õci', key: 'title', required: true },
        { type: 'text', placeholder: 'Emoji (np. ‚ú®)', key: 'emoji', maxLength: 2 }
    ],
    options: EXTRA_ACTIVITY_CATEGORIES.map((cat, index) => ({ value: cat.value, label: cat.label, checked: index === 0 })),
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { 
        text: 'Dodaj i zapisz szablon', 
        class: 'btn ghost', 
        action: (value, selected) => {
            const textValue = (value.title || '').trim();
            if (!textValue) return false;
            const newExtra = {
                id: `pre_${Date.now()}_${Math.random().toString(16).slice(2)}`,
                title: textValue,
                category: selected || 'other',
                emoji: value.emoji || ACTIVITY_EMOJIS.extra
            };
            if (!state.predefinedExtras.find(p => p.title === newExtra.title)) {
                state.predefinedExtras.push(newExtra);
            }
            addExtra(selectedDate, newExtra.title, newExtra.category, newExtra.emoji);
        }
      },
      { text: 'Dodaj', class: 'btn', action: (value, selected) => {
          const textValue = (value.title || '').trim();
          if (!textValue) return false;
          addExtra(selectedDate, textValue, selected || 'other', value.emoji);
        } }
    ]
  });
}

function showManagePredefinedExtrasModal() {
    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.gap = '8px';

    state.predefinedExtras.forEach(extra => {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.justifyContent = 'space-between';
        item.style.alignItems = 'center';
        item.style.padding = '8px';
        item.style.borderRadius = '8px';
        item.style.background = '#f8fafc';
        item.innerHTML = `<span>${extra.emoji || ''} ${extra.title}</span>`;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn ghost';
        deleteBtn.innerHTML = `<i data-lucide="trash-2" class="icon"></i>`;
        deleteBtn.style.padding = '4px';
        deleteBtn.style.height = 'auto';
        deleteBtn.onclick = () => {
            state.predefinedExtras = state.predefinedExtras.filter(p => p.id !== extra.id);
            saveState();
            // Re-render modal content
            const newContainer = showManagePredefinedExtrasModal();
            const modalInput = document.getElementById('modal-input-container');
            modalInput.innerHTML = '';
            modalInput.appendChild(newContainer);
            lucide.createIcons();
        };
        item.appendChild(deleteBtn);
        container.appendChild(item);
    });

    if (state.predefinedExtras.length === 0) {
        container.innerHTML = `<p class="muted tiny">Brak zapisanych szablon√≥w.</p>`;
    }

    showModal({
        title: 'ZarzƒÖdzaj szablonami',
        text: 'Usu≈Ñ szablony, kt√≥rych ju≈º nie potrzebujesz.',
        customHTML: container,
        buttons: [
            { text: 'Zamknij', class: 'btn', action: 'close' }
        ],
        onShow: () => {
          lucide.createIcons();
        }
    });
    return container;
}

function showVacationRangeModal() {
  showModal({
    title: 'Plan urlopu',
    text: 'Oznacz ca≈Çy zakres dat jako urlop, aby kalendarz uwzglƒôdni≈Ç przerwƒô.',
    inputs: [
      { type: 'date', value: selectedDate, label: 'PoczƒÖtek urlopu', key: 'start' },
      { type: 'date', value: selectedDate, label: 'Koniec urlopu', key: 'end' }
    ],
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Zapisz', class: 'btn', action: (value) => {
          if (!value || !value.start || !value.end) return false;
          if (value.end < value.start) return false;
          planVacationRange(value.start, value.end);
        } }
    ],
    onShow: ({ inputs }) => {
      if (!inputs || inputs.length < 2) return;
      const [startField, endField] = inputs;
      if (!startField || !endField) return;
      endField.min = startField.value;
      startField.addEventListener('change', () => {
        if (endField.value < startField.value) {
          endField.value = startField.value;
        }
        endField.min = startField.value;
      });
    }
  });
}

function showModal(config) {
  const overlay = document.getElementById('modal-overlay');
  document.getElementById('modal-title').textContent = config.title || '';
  document.getElementById('modal-text').innerHTML = config.text || '';
  const inputContainer = document.getElementById('modal-input-container');
  const optionsContainer = document.getElementById('modal-options-container');
  const actions = document.getElementById('modal-actions');
  inputContainer.innerHTML = '';
  optionsContainer.innerHTML = '';
  actions.innerHTML = '';

  if (config.customHTML) {
    inputContainer.appendChild(config.customHTML);
  }

  const inputConfigs = [];
  if (Array.isArray(config.inputs)) inputConfigs.push(...config.inputs);
  if (config.input) inputConfigs.push(config.input);

  inputConfigs.forEach(inputConfig => {
    const wrapper = document.createElement('div');
    wrapper.className = 'modal-field';
    if (inputConfig.label) {
      const label = document.createElement('span');
      label.className = 'modal-field-label';
      label.textContent = inputConfig.label;
      wrapper.appendChild(label);
    }
    const input = document.createElement('input');
    input.type = inputConfig.type || 'text';
    if (inputConfig.placeholder) input.placeholder = inputConfig.placeholder;
    if (inputConfig.value !== undefined) input.value = inputConfig.value;
    if (inputConfig.min !== undefined) input.min = inputConfig.min;
    if (inputConfig.max !== undefined) input.max = inputConfig.max;
    if (inputConfig.step !== undefined) input.step = inputConfig.step;
    if (inputConfig.maxLength !== undefined) input.maxLength = inputConfig.maxLength;
    if (inputConfig.required) input.required = true;
    input.autocomplete = 'off';
    input.dataset.modalInput = 'true';
    if (inputConfig.key) input.dataset.modalKey = inputConfig.key;
    if (inputConfig.name) input.name = inputConfig.name;
    wrapper.appendChild(input);
    inputContainer.appendChild(wrapper);
  });

  if (config.textarea) {
    const wrapper = document.createElement('div');
    wrapper.className = 'modal-field';
    const textarea = document.createElement('textarea');
    textarea.placeholder = config.textarea.placeholder || '';
    textarea.value = config.textarea.value || '';
    textarea.rows = config.textarea.rows || 4;
    textarea.autocomplete = 'off';
    textarea.dataset.modalInput = 'true';
    wrapper.appendChild(textarea);
    inputContainer.appendChild(wrapper);
  }

  if (config.options) {
    const optionsDiv = document.createElement('div');
    optionsDiv.className = 'modal-options';
    config.options.forEach(opt => {
      const label = document.createElement('label');
      label.className = 'option-label';
      label.innerHTML = `<input type="radio" name="modal-option" value="${opt.value}" ${opt.checked ? 'checked' : ''}> <span>${opt.label}</span>`;
      optionsDiv.appendChild(label);
    });
    optionsContainer.appendChild(optionsDiv);
  }

  config.buttons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.text;
    button.className = btn.class;
    button.addEventListener('click', () => {
      if (btn.action === 'close') {
        overlay.classList.remove('visible');
        render(); // Re-render to reflect changes if modal was for management
        return;
      }
      const fields = Array.from(inputContainer.querySelectorAll('[data-modal-input]'));
      const selectedOption = optionsContainer.querySelector('input[name="modal-option"]:checked')?.value;
      let value = '';
      if (fields.length === 1) {
        value = fields[0].value;
      } else if (fields.length > 1) {
        value = {};
        fields.forEach((field, index) => {
          const key = field.dataset.modalKey || field.name || `field${index + 1}`;
          value[key] = field.value;
        });
      }
      const result = btn.action(value, selectedOption);
      if (result === false) return;
      overlay.classList.remove('visible');
    });
    actions.appendChild(button);
  });

  overlay.classList.add('visible');
  if (typeof config.onShow === 'function') {
    const inputs = Array.from(inputContainer.querySelectorAll('[data-modal-input]'));
    config.onShow({ overlay, input: inputs[0] || null, inputs, optionsContainer, inputContainer });
  }
  const focusTarget = inputContainer.querySelector('[data-modal-input]');
  if (focusTarget && !focusTarget.disabled) focusTarget.focus();
}

function setupEventListeners() {
  const sectionButtons = document.querySelectorAll('.subnav [data-section-target]');
  const sectionPanels = document.querySelectorAll('.section-panel');
      sectionButtons.forEach(button => {
    button.addEventListener('click', () => {
      const target = button.dataset.sectionTarget;
      sectionButtons.forEach(btn => btn.classList.toggle('is-active', btn === button));
      sectionPanels.forEach(panel => panel.classList.toggle('is-active', panel.id === target));
      const main = document.querySelector('.page-content');
      if (main) main.scrollIntoView({ behavior: 'smooth', block: 'start' });
      if (target === 'analytics') {
        // Wait for display:block to apply then render
        requestAnimationFrame(() => renderNewAnalytics());
      }
    });
  });


  document.getElementById('prev-month-btn').addEventListener('click', () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
    render();
  });
  document.getElementById('next-month-btn').addEventListener('click', () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
    render();
  });
  document.getElementById('today-month-btn').addEventListener('click', () => {
    const today = new Date();
    currentMonth = startOfMonth(today);
    selectedDate = toYYYYMMDD(today);
    render();
  });
  
  document.getElementById('stop-planning-btn').addEventListener('click', () => stopPlanningMode());

  document.getElementById('modal-overlay').addEventListener('click', (event) => {
    if (event.target === event.currentTarget) {
      event.currentTarget.classList.remove('visible');
      render(); // Re-render in case a management modal was closed
    }
  });

  const metricsForm = document.getElementById('metrics-form');
  if (metricsForm) {
    metricsForm.addEventListener('submit', event => {
      event.preventDefault();
      const date = document.getElementById('metrics-date')?.value || toYYYYMMDD(new Date());
      const cycle = document.getElementById('metrics-cycle')?.value?.trim();
      if (!cycle) {
        updateMetricsFeedback('Uzupe≈Çnij nazwƒô cyklu.', 'warning');
        return;
      }

      const entry = {
        id: `metric_${Date.now()}_${Math.random().toString(16).slice(2)}`,
        date,
        cycle,
        weight: parseMetricValue(document.getElementById('metrics-weight')?.value),
        bf: parseMetricValue(document.getElementById('metrics-bf')?.value),
        height: parseMetricValue(document.getElementById('metrics-height')?.value)
      };

      bodyMetrics.push(entry);
      selectedCycle = cycle;
      const sortedCycle = getMetricsForCycle(cycle);
      const currentIndex = sortedCycle.findIndex(item => item.id === entry.id);
      const previous = currentIndex > 0 ? sortedCycle[currentIndex - 1] : null;
      const progress = evaluateProgress(entry, previous);
      updateMetricsFeedback(progress.message, progress.tone);
      saveBodyMetrics('Zapisano log wagi');
      renderBodyMetrics();

      ['metrics-weight', 'metrics-bf', 'metrics-height'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.value = '';
      });
      updateMetricsPreview();
    });
  }

  document.getElementById('metrics-clear-btn')?.addEventListener('click', () => {
    ['metrics-weight', 'metrics-bf', 'metrics-height'].forEach(id => {
      const input = document.getElementById(id);
      if (input) input.value = '';
    });
    updateMetricsPreview();
    updateMetricsFeedback('Pola wyczyszczone. Dodaj nowe warto≈õci.', '');
  });

  document.getElementById('metrics-delete-last-btn')?.addEventListener('click', () => {
    const filtered = getMetricsForCycle(selectedCycle);
    const lastEntry = filtered[filtered.length - 1];
    if (!lastEntry) {
      updateMetricsFeedback('Brak pomiar√≥w do usuniƒôcia.', 'warning');
      return;
    }
    const confirmText = `UsunƒÖƒá ostatni pomiar (${lastEntry.date})?`;
    if (!window.confirm(confirmText)) return;
    bodyMetrics = bodyMetrics.filter(item => item.id !== lastEntry.id);
    saveBodyMetrics('Usuniƒôto ostatni pomiar');
    renderBodyMetrics();
  });

  ['metrics-weight', 'metrics-bf', 'metrics-height'].forEach(id => {
    const input = document.getElementById(id);
    if (input) input.addEventListener('input', () => updateMetricsPreview());
  });

  document.getElementById('metrics-cycle-filter')?.addEventListener('change', event => {
    selectedCycle = event.target.value;
    renderBodyMetrics();
  });

  const targetBfInput = document.getElementById('metrics-target-bf');
  if (targetBfInput) {
    targetBfInput.addEventListener('input', () => {
      targetBfGoal = parseMetricValue(targetBfInput.value);
      saveBodyMetricsGoal();
      renderRoadToSummer(getMetricsForCycle(selectedCycle));
    });
  }

}

document.addEventListener('DOMContentLoaded', () => {
  loadState();
  loadBodyMetrics();
  loadBodyMetricsGoal();
  ensureDay(selectedDate);
  render();
  setupEventListeners();
});
</script>
</body>
</html>
