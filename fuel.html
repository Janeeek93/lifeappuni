<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS ‚Äî Paliwo</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .fuel-insights-grid {
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .fuel-insight-card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: var(--shadow-sm);
    }

    .fuel-insight-card .label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    .fuel-insight-card .value {
      font-size: 20px;
      font-weight: 700;
      color: var(--ink);
    }

    .fuel-insight-card .note {
      font-size: 12px;
      color: var(--muted);
    }

    .fuel-form-grid {
      align-items: flex-end;
    }

    .fuel-form-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .fuel-analytics-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .summary-delta {
      font-weight: 600;
    }

    .summary-delta.up {
      color: var(--red);
    }

    .summary-delta.down {
      color: var(--green);
    }

    .summary-delta.flat {
      color: var(--muted);
    }

    .last-invoice-card {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .table-wrapper.scrollable {
      max-height: 320px;
      overflow: auto;
    }
  </style>
</head>
<body data-page="fuel">
  <div class="layout">
    <aside class="sidebar" aria-label="G≈Ç√≥wna nawigacja">
      <div class="sidebar__header">
        <span class="sidebar__emoji">üß≠</span>
        <span class="sidebar__brand">LifeOS</span>
      </div>
      <nav class="sidebar__nav" aria-label="Sekcje LifeOS">
        <ul class="sidebar__list">
          <li class="sidebar__item">
            <a class="sidebar__link" href="index.html" data-page="dashboard">
              <span class="sidebar__icon">üìä</span>
              <span class="sidebar__label">Dashboard</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="budget.html" data-page="budget">
              <span class="sidebar__icon">üí∞</span>
              <span class="sidebar__label">Bud≈ºet</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="fuel.html" data-page="fuel">
              <span class="sidebar__icon">‚õΩ</span>
              <span class="sidebar__label">Paliwo</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="trainings.html" data-page="trainings">
              <span class="sidebar__icon">üí™</span>
              <span class="sidebar__label">Treningi</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="loan.html" data-page="loan">
              <span class="sidebar__icon">üè¶</span>
              <span class="sidebar__label">Kredyt</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="tasks.html" data-page="tasks">
              <span class="sidebar__icon">‚úÖ</span>
              <span class="sidebar__label">Zadania</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="house.html" data-page="house">
              <span class="sidebar__icon">üè†</span>
              <span class="sidebar__label">Budowa</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar__footer">
        <strong>Tw√≥j cyfrowy dom</strong>
        ZarzƒÖdzaj bud≈ºetem, zadaniami i celami w jednym miejscu.
      </div>
    </aside>

    <div class="main">
      <header class="page-header" role="banner">
        <div class="page-header__top">
          <span class="page-overline">Finanse</span>
          <h1 class="page-title">
            <span class="page-title__icon">‚õΩ</span>
            <span class="page-title__text">Paliwo</span>
          </h1>
        </div>
        <div class="page-header__actions" aria-label="Akcje strony">
          <button id="import-csv-btn" class="btn soft">Importuj z CSV</button>
          <input type="file" id="csv-file-input" accept=".csv" style="display:none;">
          <button id="export-csv-btn" class="btn soft">Eksportuj do CSV</button>
          <button id="clear-all-btn" class="btn danger">Wyczy≈õƒá wszystko</button>
        </div>
      </header>

      <div class="content">
        <main class="content-main stack">
          <section class="card card-section">
            <div class="section-heading">
              <h2 class="title">Kluczowe wnioski</h2>
              <span class="tiny muted">Aktualizowane automatycznie na podstawie historii tankowa≈Ñ</span>
            </div>
            <div id="insights-grid" class="grid-3 fuel-insights-grid"></div>
            <div class="insight-bubble" id="fuel-kpi-insight">Dodaj pierwszƒÖ transakcjƒô, aby zobaczyƒá trend wydatk√≥w.</div>
          </section>

          <section class="card card-section">
            <div class="section-heading">
              <h2 class="title">Ostatnia faktura</h2>
              <span class="tiny muted">Historia aktualizuje siƒô po ka≈ºdym dodaniu faktury</span>
            </div>
            <div class="last-invoice-card" id="last-invoice-card">
              <div class="muted">Brak faktur w historii</div>
            </div>
          </section>

          <section class="card card-section">
            <div class="section-heading">
              <h2 class="title">Podsumowanie miesiƒôczne</h2>
              <p class="tiny muted" id="monthly-summary-caption">Ostatnie 6 miesiƒôcy</p>
            </div>
            <div class="table-wrapper scrollable">
              <table>
                <thead>
                  <tr>
                    <th>MiesiƒÖc</th>
                    <th>Faktury</th>
                    <th>Litry</th>
                    <th>≈ör. cena</th>
                    <th>Zmiana m/m</th>
                  </tr>
                </thead>
                <tbody id="monthly-summary-body"></tbody>
              </table>
            </div>
          </section>

          <section class="card card-section">
            <div class="section-heading">
              <h2 class="title">Analityka</h2>
              <select id="analytics-period-filter" style="width:auto;">
                <option value="12" selected>Ostatni rok</option>
                <option value="24">Ostatnie 2 lata</option>
                <option value="36">Ostatnie 3 lata</option>
                <option value="all">Wszystkie dane</option>
              </select>
            </div>
            <div class="fuel-analytics-grid">
              <article class="chart-card">
                <h3 class="title">Miesiƒôczne koszty i liczba tankowa≈Ñ</h3>
                <div class="chart-area"><canvas id="monthly-costs-chart"></canvas></div>
              </article>
              <article class="chart-card">
                <h3 class="title">≈örednia cena za litr</h3>
                <div class="chart-area"><canvas id="avg-price-chart"></canvas></div>
              </article>
            </div>
          </section>

          <section class="card card-section">
            <div class="section-heading">
              <h2 class="title" id="form-title">Dodaj transakcjƒô</h2>
              <span class="tiny muted">Obs≈Çugujemy faktury i zaliczki firmowe</span>
            </div>
            <div class="grid g-4 fuel-form-grid">
              <input type="hidden" id="tx-id">
              <input type="date" id="tx-date">
              <select id="tx-type">
                <option value="invoice">Faktura (koszt)</option>
                <option value="advance">Zaliczka (wp≈Çyw)</option>
              </select>
              <input type="text" id="tx-ref" placeholder="Nr faktury / Opis">
              <input type="text" id="tx-liters" placeholder="Litry (opcjonalnie)" inputmode="decimal">
              <input type="text" id="tx-amount" placeholder="Kwota" inputmode="decimal" required>
              <div class="fuel-form-actions">
                <button id="cancel-edit-btn" class="btn soft" style="display:none;">Anuluj</button>
                <button id="add-tx-btn" class="btn primary">Dodaj</button>
              </div>
            </div>
          </section>

          <section class="card card-section">
            <div class="section-heading">
              <h2 class="title">Historia transakcji</h2>
              <span class="tiny muted">Kliknij wpis, aby edytowaƒá lub usu≈Ñ w przypadku pomy≈Çki</span>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Typ</th>
                    <th>Opis/Nr faktury</th>
                    <th>Litry</th>
                    <th>Cena/l</th>
                    <th>Kwota</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="history-tbody"></tbody>
              </table>
            </div>
          </section>
        </main>

        <aside class="right-rail">
          <div class="kpi-compact">
            <div class="kpi-emoji">‚õΩ</div>
            <div class="kpi-body">
              <div class="kpi-label">Saldo rozlicze≈Ñ</div>
              <div class="kpi-value ok" id="fuel-balance">0,00 PLN</div>
              <p class="tiny muted" id="balance-info">‚Äî</p>
            </div>
          </div>
          <div class="kpi-compact">
            <div class="kpi-emoji">üßæ</div>
            <div class="kpi-body">
              <div class="kpi-label">≈ör. cena/L (12m)</div>
              <div class="kpi-value" id="avg-price-12m">‚Äî</div>
              <p class="tiny muted" id="avg-price-12m-note">Brak danych z ostatniego roku</p>
            </div>
          </div>
          <div class="kpi-compact">
            <div class="kpi-emoji">üü¢</div>
            <div class="kpi-body">
              <div class="kpi-label">Najlepsza cena</div>
              <div class="kpi-value" id="best-price">‚Äî</div>
              <p class="tiny muted" id="best-price-note">Dodaj faktury z litrami</p>
            </div>
          </div>
          <div class="kpi-compact">
            <div class="kpi-emoji">üî¥</div>
            <div class="kpi-body">
              <div class="kpi-label">Najwy≈ºsza cena</div>
              <div class="kpi-value" id="worst-price">‚Äî</div>
              <p class="tiny muted" id="worst-price-note">Dodaj faktury z litrami</p>
            </div>
          </div>
          <div class="kpi-compact">
            <div class="kpi-emoji">üí≥</div>
            <div class="kpi-body">
              <div class="kpi-label">≈ör. faktura</div>
              <div class="kpi-value" id="avg-invoice">‚Äî</div>
              <p class="tiny muted" id="avg-invoice-note">Czekamy na nowe dane</p>
            </div>
          </div>
          <div class="insight-bubble" id="kpi-context-bubble">Wprowad≈∫ historyczne faktury, aby zobaczyƒá trend koszt√≥w paliwa.</div>
        </aside>
      </div>
    </div>
  </div>

<script>
  (function activateSidebarLink() {
    const currentPage = document.body.dataset.page;
    if (!currentPage) return;
    document.querySelectorAll('.sidebar__link[data-page]').forEach((link) => {
      if (link.dataset.page === currentPage) {
        link.classList.add('sidebar__link--active');
        link.setAttribute('aria-current', 'page');
      } else {
        link.classList.remove('sidebar__link--active');
        link.removeAttribute('aria-current');
      }
    });
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const FUEL_STORAGE_KEY = 'lifeos_fuel_v1';
const KPI_STORAGE_KEY = 'lifeos_kpis_v1';

function fmt(n, c = 'PLN') {
    try {
        const numValue = Number(n || 0);
        const parts = numValue.toFixed(2).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "\u00A0");
        return `${parts.join(',')}\u00A0${c}`;
    } catch {
        return `${Number(n || 0).toFixed(2)}\u00A0${c}`;
    }
}

function num(s){
    if(typeof s==='number') return s;
    if(!s) return 0;
    const raw = String(s).replace(/\s|\u00A0/g,'');
    let normalized = raw;
    if(raw.includes(',') && raw.includes('.')) normalized = raw.replace(/\./g,'').replace(',','.');
    else normalized = raw.replace(',','.');
    normalized = normalized.replace(/[^0-9.\-]/g,'');
    const n = Number(normalized);
    return Number.isFinite(n) ? n : 0;
}

function normalizeTransactions(list){
    if(!Array.isArray(list)) return [];
    return list.map(tx => {
        if(!tx) return null;
        const normalized = { ...tx };
        const rawAmount = num(tx.amount ?? tx.value);
        let type = (tx.type || '').toLowerCase();
        if(type !== 'invoice' && type !== 'advance') {
            type = rawAmount >= 0 ? 'advance' : 'invoice';
        }
        normalized.type = type;
        normalized.amount = type === 'invoice' ? -Math.abs(rawAmount) : Math.abs(rawAmount);
        const litersSource = tx.liters ?? tx.details?.liters ?? tx.volume;
        const litersValue = num(litersSource);
        normalized.liters = type === 'invoice' && litersValue > 0 ? litersValue : null;
        if(!normalized.ref && tx.reference) normalized.ref = tx.reference;
        if(!normalized.id){
            const seed = `${tx.date || Date.now()}_${Math.random().toString(16).slice(2,8)}`;
            normalized.id = `tx_${seed}`;
        }
        return normalized;
    }).filter(Boolean);
}

function loadState(){
    try {
        const raw = localStorage.getItem(FUEL_STORAGE_KEY);
        if(!raw) return { transactions: [] };
        const parsed = JSON.parse(raw);
        if(parsed && typeof parsed === 'object'){
            const transactions = Array.isArray(parsed.transactions) ? parsed.transactions : [];
            return { ...parsed, transactions: normalizeTransactions(transactions) };
        }
    } catch {
        return { transactions: [] };
    }
    return { transactions: [] };
}

function saveState(state) {
    localStorage.setItem(FUEL_STORAGE_KEY, JSON.stringify(state));
    updateKPIs(state);
}

function updateKPIs(state) {
    const balance = state.transactions.reduce((acc, tx) => acc + tx.amount, 0);
    const kpis = JSON.parse(localStorage.getItem(KPI_STORAGE_KEY) || '{}');
    kpis.fuelBalance = balance;
    kpis.timestamp = new Date().toISOString();
    localStorage.setItem(KPI_STORAGE_KEY, JSON.stringify(kpis));
}

let state = loadState();

const formTitle = document.getElementById('form-title');
const txIdInput = document.getElementById('tx-id');
const dateInput = document.getElementById('tx-date');
const typeInput = document.getElementById('tx-type');
const refInput = document.getElementById('tx-ref');
const litersInput = document.getElementById('tx-liters');
const amountInput = document.getElementById('tx-amount');
const addBtn = document.getElementById('add-tx-btn');
const cancelEditBtn = document.getElementById('cancel-edit-btn');
const historyTbody = document.getElementById('history-tbody');
const balanceEl = document.getElementById('fuel-balance');
const balanceInfoEl = document.getElementById('balance-info');
const avgPriceEl = document.getElementById('avg-price-12m');
const avgPriceNoteEl = document.getElementById('avg-price-12m-note');
const bestPriceEl = document.getElementById('best-price');
const bestPriceNoteEl = document.getElementById('best-price-note');
const worstPriceEl = document.getElementById('worst-price');
const worstPriceNoteEl = document.getElementById('worst-price-note');
const avgInvoiceEl = document.getElementById('avg-invoice');
const avgInvoiceNoteEl = document.getElementById('avg-invoice-note');
const kpiContextBubble = document.getElementById('kpi-context-bubble');
const fuelInsightBubble = document.getElementById('fuel-kpi-insight');
const lastInvoiceCard = document.getElementById('last-invoice-card');
const exportBtn = document.getElementById('export-csv-btn');
const importBtn = document.getElementById('import-csv-btn');
const csvFileInput = document.getElementById('csv-file-input');
const clearAllBtn = document.getElementById('clear-all-btn');

function computeFuelMetrics() {
    const transactions = Array.isArray(state.transactions) ? state.transactions : [];
    const invoices = transactions.filter(tx => tx.type === 'invoice');
    const advances = transactions.filter(tx => tx.type === 'advance');

    const lastYearThreshold = (() => {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        d.setFullYear(d.getFullYear() - 1);
        return d;
    })();

    const invoicesLastYear = invoices.filter(tx => {
        if (!tx.date) return false;
        const parsed = new Date(tx.date);
        if (Number.isNaN(parsed.valueOf())) return false;
        return parsed >= lastYearThreshold;
    });

    const costLastYear = invoicesLastYear.reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
    const litersLastYear = invoicesLastYear.reduce((sum, tx) => sum + (tx.liters || 0), 0);
    const avgPrice = litersLastYear > 0 ? costLastYear / litersLastYear : 0;
    const avgInvoice = invoicesLastYear.length > 0 ? costLastYear / invoicesLastYear.length : 0;

    const last30Threshold = new Date();
    last30Threshold.setDate(last30Threshold.getDate() - 30);
    const last30Invoices = invoices.filter(tx => tx.date && new Date(tx.date) >= last30Threshold);
    const last30Cost = last30Invoices.reduce((sum, tx) => sum + Math.abs(tx.amount), 0);

    const bestPriceInvoice = invoices.reduce((best, tx) => {
        if (!tx.liters) return best;
        const unitPrice = Math.abs(tx.amount) / tx.liters;
        if (!best || unitPrice < best.unitPrice) {
            return { unitPrice, ref: tx.ref, date: tx.date };
        }
        return best;
    }, null);

    const worstPriceInvoice = invoices.reduce((worst, tx) => {
        if (!tx.liters) return worst;
        const unitPrice = Math.abs(tx.amount) / tx.liters;
        if (!worst || unitPrice > worst.unitPrice) {
            return { unitPrice, ref: tx.ref, date: tx.date };
        }
        return worst;
    }, null);

    const balance = transactions.reduce((acc, tx) => acc + tx.amount, 0);
    const advancesValue = advances.reduce((sum, tx) => sum + tx.amount, 0);

    const monthlyTotals = invoices.reduce((acc, tx) => {
        if (!tx.date) return acc;
        const key = tx.date.slice(0, 7);
        acc[key] = (acc[key] || 0) + Math.abs(tx.amount);
        return acc;
    }, {});
    const sortedMonths = Object.keys(monthlyTotals).sort();
    const latestMonthKey = sortedMonths.length ? sortedMonths[sortedMonths.length - 1] : null;
    const prevMonthKey = sortedMonths.length > 1 ? sortedMonths[sortedMonths.length - 2] : null;
    const latestTotal = latestMonthKey ? monthlyTotals[latestMonthKey] : 0;
    const prevTotal = prevMonthKey ? monthlyTotals[prevMonthKey] : 0;
    let monthDelta = null;
    if (latestMonthKey) {
        const diff = latestTotal - prevTotal;
        const percent = prevTotal ? (diff / prevTotal) * 100 : null;
        const direction = diff > 0 ? 'up' : (diff < 0 ? 'down' : 'flat');
        monthDelta = { latestMonthKey, prevMonthKey, latestTotal, prevTotal, diff, percent, direction };
    }

    const lastInvoice = transactions.find(tx => tx.type === 'invoice' && tx.date);

    return {
        balance,
        advancesValue,
        invoicesLastYearCount: invoicesLastYear.length,
        litersLastYear,
        avgPrice,
        avgInvoice,
        bestPriceInvoice,
        worstPriceInvoice,
        last30Cost,
        last30InvoicesCount: last30Invoices.length,
        monthDelta,
        lastInvoice,
        costLastYear,
        monthlyTotals
    };
}

function render() {
    state.transactions = normalizeTransactions(state.transactions || []);
    state.transactions.sort((a,b) => (b.date || '').localeCompare(a.date || ''));

    const metrics = computeFuelMetrics();

    // Render KPI rail
    balanceEl.textContent = fmt(metrics.balance);
    balanceEl.className = `kpi-value ${metrics.balance >= 0 ? 'ok' : 'bad'}`;
    balanceInfoEl.textContent = metrics.balance >= 0
        ? 'Masz jeszcze ≈õrodki z zaliczki do wykorzystania'
        : 'Musisz zwr√≥ciƒá pieniƒÖdze firmie';

    if (metrics.avgPrice > 0) {
        avgPriceEl.textContent = fmt(metrics.avgPrice, 'PLN/L');
        avgPriceNoteEl.textContent = `${metrics.litersLastYear.toFixed(1)} L w ${metrics.invoicesLastYearCount} fakturach (12 mies.)`;
    } else {
        avgPriceEl.textContent = '‚Äî';
        avgPriceNoteEl.textContent = 'Brak danych z ostatniego roku';
    }

    if (metrics.bestPriceInvoice) {
        bestPriceEl.textContent = fmt(metrics.bestPriceInvoice.unitPrice, 'PLN/L');
        const bestLabel = metrics.bestPriceInvoice.ref || 'Faktura';
        bestPriceNoteEl.textContent = `${bestLabel} ‚Ä¢ ${metrics.bestPriceInvoice.date}`;
    } else {
        bestPriceEl.textContent = '‚Äî';
        bestPriceNoteEl.textContent = 'Dodaj faktury z litrami';
    }

    if (metrics.worstPriceInvoice) {
        worstPriceEl.textContent = fmt(metrics.worstPriceInvoice.unitPrice, 'PLN/L');
        const worstLabel = metrics.worstPriceInvoice.ref || 'Faktura';
        worstPriceNoteEl.textContent = `${worstLabel} ‚Ä¢ ${metrics.worstPriceInvoice.date}`;
    } else {
        worstPriceEl.textContent = '‚Äî';
        worstPriceNoteEl.textContent = 'Dodaj faktury z litrami';
    }

    if (metrics.avgInvoice > 0) {
        avgInvoiceEl.textContent = fmt(metrics.avgInvoice);
        avgInvoiceNoteEl.textContent = `${metrics.invoicesLastYearCount} faktur w ostatnich 12 mies.`;
    } else {
        avgInvoiceEl.textContent = '‚Äî';
        avgInvoiceNoteEl.textContent = metrics.advancesValue > 0
            ? `Zaliczki: ${fmt(metrics.advancesValue)}`
            : 'Czekamy na nowe dane';
    }

    if (metrics.monthDelta && metrics.monthDelta.percent !== null) {
        const directionWord = metrics.monthDelta.direction === 'down' ? 'spad≈Çy' : (metrics.monthDelta.direction === 'up' ? 'wzros≈Çy' : 'pozosta≈Çy bez zmian');
        const percentText = `${Math.abs(metrics.monthDelta.percent).toFixed(1)}%`;
        const compareLabel = metrics.monthDelta.prevMonthKey ? ` vs ${metrics.monthDelta.prevMonthKey}` : '';
        kpiContextBubble.textContent = `Wydatki m/m ${directionWord} o ${percentText}${compareLabel}.`;
    } else if (metrics.monthDelta && metrics.monthDelta.diff) {
        const directionWord = metrics.monthDelta.diff < 0 ? 'spad≈Çy' : 'wzros≈Çy';
        kpiContextBubble.textContent = `Wydatki m/m ${directionWord} o ${fmt(Math.abs(metrics.monthDelta.diff))}.`;
    } else if (metrics.last30Cost > 0) {
        kpiContextBubble.textContent = `Ostatnie 30 dni kosztowa≈Çy ${fmt(metrics.last30Cost)} (${metrics.last30InvoicesCount} faktur).`;
    } else {
        kpiContextBubble.textContent = 'Wprowad≈∫ historyczne faktury, aby zobaczyƒá trend koszt√≥w paliwa.';
    }

    const lastInvoice = metrics.lastInvoice;
    if (lastInvoice) {
        const daysSince = Math.floor((new Date() - new Date(lastInvoice.date)) / (1000 * 60 * 60 * 24));
        const litersValue = typeof lastInvoice.liters === 'number' ? lastInvoice.liters : num(lastInvoice.liters);
        const pricePerLiter = litersValue ? Math.abs(lastInvoice.amount) / litersValue : 0;
        lastInvoiceCard.innerHTML = `
            <div class="label">Ostatnia faktura ‚Ä¢ ${daysSince} dni temu</div>
            <div class="value">${fmt(Math.abs(lastInvoice.amount))}</div>
            <div class="note">${lastInvoice.date} ‚Ä¢ ${litersValue ? litersValue.toFixed(2) + ' L' : '‚Äî'} ‚Ä¢ ${litersValue ? fmt(pricePerLiter, 'PLN/L') : '‚Äî'}</div>
        `;
    } else {
        lastInvoiceCard.innerHTML = `<div class="label">Brak faktur w historii</div>`;
    }

    // Render History Table
    historyTbody.innerHTML = '';
    state.transactions.forEach(tx => {
        const tr = document.createElement('tr');
        const pricePerLiter = (tx.liters && tx.amount < 0) ? Math.abs(tx.amount / tx.liters) : 0;
        tr.innerHTML = `
            <td>${tx.date}</td>
            <td><span class="pill" style="background-color: ${tx.type === 'invoice' ? '#fee2e2' : '#dcfce7'}; color: ${tx.type === 'invoice' ? '#b91c1c' : '#166534'}">${tx.type === 'invoice' ? 'Faktura' : 'Zaliczka'}</span></td>
            <td>${tx.ref}</td>
            <td>${tx.liters ? tx.liters.toFixed(2) + ' L' : '‚Äî'}</td>
            <td>${pricePerLiter > 0 ? fmt(pricePerLiter, 'PLN/L') : '‚Äî'}</td>
            <td class="${tx.amount < 0 ? 'bad' : 'ok'}">${fmt(tx.amount)}</td>
            <td style="display:flex; gap: 8px;">
                <button class="btn soft" data-edit-id="${tx.id}">Edytuj</button>
                <button class="btn danger" data-del-id="${tx.id}">Usu≈Ñ</button>
            </td>
        `;
        historyTbody.appendChild(tr);
    });
    
    if (state.transactions.length === 0) {
        historyTbody.innerHTML = '<tr><td colspan="7" style="text-align:center;" class="muted">Brak transakcji</td></tr>';
    }

    document.querySelectorAll('[data-del-id]').forEach(btn => {
        btn.onclick = (e) => {
            const id = e.target.dataset.delId;
            if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô transakcjƒô?')) {
                state.transactions = state.transactions.filter(tx => tx.id !== id);
                saveState(state);
                render();
            }
        };
    });
    
    document.querySelectorAll('[data-edit-id]').forEach(btn => {
        btn.onclick = (e) => {
            startEdit(e.target.dataset.editId);
        };
    });

    renderInsightsSection(metrics);
    renderMonthlySummary();
    renderAnalytics();
}

function renderInsightsSection(metrics) {
    const grid = document.getElementById('insights-grid');
    if (!grid) return;

    if (!state.transactions.length) {
        grid.innerHTML = '<p class="tiny muted">Dodaj pierwszƒÖ transakcjƒô, aby zobaczyƒá kluczowe wska≈∫niki.</p>';
        if (fuelInsightBubble) {
            fuelInsightBubble.textContent = 'Gdy pojawiƒÖ siƒô pierwsze faktury poka≈ºemy tu dynamikƒô koszt√≥w.';
        }
        return;
    }

    const monthEntries = metrics.monthlyTotals ? Object.entries(metrics.monthlyTotals) : [];
    const referenceStart = '2022-01';
    const recentEntries = monthEntries.filter(([month]) => month >= referenceStart);
    const monthsWithData = recentEntries.length;
    const totalMonthlyCost = recentEntries.reduce((sum, [, value]) => sum + value, 0);
    const avgMonthlyCost = monthsWithData ? totalMonthlyCost / monthsWithData : 0;

    const cards = [
        {
            label: 'Koszt ostatnich 30 dni',
            value: metrics.last30Cost > 0 ? fmt(metrics.last30Cost) : '‚Äî',
            note: metrics.last30InvoicesCount ? `${metrics.last30InvoicesCount} faktur w tym okresie` : 'Brak nowych faktur'
        },
        {
            label: '≈ör. miesiƒôczny koszt',
            value: avgMonthlyCost > 0 ? fmt(avgMonthlyCost) : '‚Äî',
            note: monthsWithData ? `${monthsWithData} mies. z fakturami` : 'Dodaj wiƒôcej danych do analizy'
        },
        {
            label: 'Zaliczki przyjƒôte',
            value: metrics.advancesValue > 0 ? fmt(metrics.advancesValue) : '‚Äî',
            note: metrics.advancesValue > 0 ? 'Wliczone w saldo rozlicze≈Ñ' : 'Brak nowych zaliczek'
        }
    ];

    if (metrics.costLastYear > 0) {
        cards.push({
            label: '≈ÅƒÖczny koszt (12 mies.)',
            value: fmt(metrics.costLastYear),
            note: `${metrics.invoicesLastYearCount} faktur w roku`
        });
    }

    grid.innerHTML = cards.map(card => `
        <div class="fuel-insight-card">
            <div class="label">${card.label}</div>
            <div class="value">${card.value}</div>
            <div class="note">${card.note}</div>
        </div>
    `).join('');

    if (fuelInsightBubble) {
        if (metrics.bestPriceInvoice && metrics.worstPriceInvoice) {
            const spread = metrics.worstPriceInvoice.unitPrice - metrics.bestPriceInvoice.unitPrice;
            const spreadText = spread > 0 ? fmt(spread, 'PLN/L') : fmt(0, 'PLN/L');
            fuelInsightBubble.textContent = `R√≥≈ºnica pomiƒôdzy najlepszƒÖ a najdro≈ºszƒÖ cenƒÖ paliwa to ${spreadText}.`;
        } else if (metrics.monthDelta && metrics.monthDelta.diff) {
            const directionWord = metrics.monthDelta.diff < 0 ? 'spad≈Çy' : 'wzros≈Çy';
            fuelInsightBubble.textContent = `Wydatki miesiƒÖc do miesiƒÖca ${directionWord} o ${fmt(Math.abs(metrics.monthDelta.diff))}.`;
        } else if (metrics.last30Cost > 0) {
            fuelInsightBubble.textContent = `W ciƒÖgu 30 dni zatankowano za ${fmt(metrics.last30Cost)}.`;
        } else {
            fuelInsightBubble.textContent = 'Dodaj litra≈º przy fakturach, by por√≥wnaƒá ceny za litr.';
        }
    }
}

function renderMonthlySummary() {
    const tbody = document.getElementById('monthly-summary-body');
    const caption = document.getElementById('monthly-summary-caption');
    if (!tbody) return;

    const invoices = state.transactions.filter(tx => tx.type === 'invoice' && tx.date);
    if (!invoices.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;">Brak danych do wy≈õwietlenia.</td></tr>';
        if (caption) caption.textContent = 'Brak danych miesiƒôcznych';
        return;
    }

    const monthly = {};
    invoices.forEach(tx => {
        const month = tx.date.slice(0, 7);
        if (!monthly[month]) monthly[month] = { cost: 0, liters: 0, count: 0 };
        monthly[month].cost += Math.abs(tx.amount);
        monthly[month].liters += tx.liters || 0;
        monthly[month].count += 1;
    });

    const months = Object.keys(monthly).sort();
    const recentMonths = months.slice(-6);
    if (caption) caption.textContent = recentMonths.length ? `Ostatnie ${recentMonths.length} miesiƒôcy` : 'Brak danych miesiƒôcznych';

    tbody.innerHTML = recentMonths.map((month, index) => {
        const data = monthly[month];
        const avgPrice = data.liters > 0 ? data.cost / data.liters : 0;
        const prevMonthKey = recentMonths[index - 1];
        const prev = prevMonthKey ? monthly[prevMonthKey] : null;
        let deltaCell = '‚Äî';
        if (prev) {
            const delta = data.cost - prev.cost;
            const deltaClass = delta > 0 ? 'up' : delta < 0 ? 'down' : 'flat';
            const symbol = delta > 0 ? '‚Üë' : delta < 0 ? '‚Üì' : '‚Üí';
            deltaCell = `<span class="summary-delta ${deltaClass}">${symbol} ${fmt(Math.abs(delta))}</span>`;
        }
        const label = new Date(`${month}-01`).toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
        return `
            <tr>
                <td>${label}</td>
                <td>${data.count}</td>
                <td>${data.liters ? data.liters.toFixed(1) + ' L' : '‚Äî'}</td>
                <td>${data.liters ? fmt(avgPrice, 'PLN/L') : '‚Äî'}</td>
                <td>${deltaCell}</td>
            </tr>
        `;
    }).join('');
}

function startEdit(id) {
    const tx = state.transactions.find(t => t.id === id);
    if (!tx) return;
    
    txIdInput.value = tx.id;
    dateInput.value = tx.date;
    typeInput.value = tx.type;
    refInput.value = tx.ref;
    litersInput.value = tx.liters || '';
    amountInput.value = String(Math.abs(tx.amount)).replace('.',',');

    formTitle.textContent = "Edytuj Transakcjƒô";
    addBtn.textContent = "Zapisz zmiany";
    cancelEditBtn.style.display = 'inline-flex';
}

function resetForm() {
    txIdInput.value = '';
    dateInput.value = new Date().toISOString().slice(0,10);
    refInput.value = '';
    litersInput.value = '';
    amountInput.value = '';
    typeInput.value = 'invoice';

    formTitle.textContent = "Dodaj Transakcjƒô";
    addBtn.textContent = "Dodaj";
    cancelEditBtn.style.display = 'none';
}

function renderAnalytics() {
    const periodMonths = document.getElementById('analytics-period-filter').value;
    const now = new Date();
    let startDate = new Date(1970, 0, 1);

    if (periodMonths !== 'all') {
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        startDate.setMonth(startDate.getMonth() - parseInt(periodMonths, 10));
    }

    const invoices = state.transactions.filter(tx => tx.type === 'invoice' && new Date(tx.date) >= startDate);
    
    const monthlyData = invoices.reduce((acc, tx) => {
        const month = tx.date.slice(0, 7);
        if (!acc[month]) {
            acc[month] = { totalCost: 0, totalLiters: 0, count: 0 };
        }
        acc[month].totalCost += Math.abs(tx.amount);
        acc[month].totalLiters += tx.liters || 0;
        acc[month].count += 1;
        return acc;
    }, {});

    const labels = Object.keys(monthlyData).sort();
    const costs = labels.map(m => monthlyData[m].totalCost);
    const counts = labels.map(m => monthlyData[m].count);
    const avgPrices = labels.map(m => monthlyData[m].totalLiters > 0 ? monthlyData[m].totalCost / monthlyData[m].totalLiters : 0);
    
    renderMonthlyCostsChart(labels, costs, counts);
    renderAvgPriceChart(labels, avgPrices);
}

const datalabelsPlugin = {
    id: 'datalabels',
    afterDraw: (chart) => {
        const ctx = chart.ctx;
        chart.data.datasets.forEach((dataset, i) => {
            if (dataset.type === 'bar' || !dataset.type) {
                const meta = chart.getDatasetMeta(i);
                meta.data.forEach((bar, index) => {
                    const data = dataset.data[index];
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillStyle = '#64748b';
                    ctx.font = '11px sans-serif';
                    ctx.fillText(Math.round(data), bar.x, bar.y - 5);
                    ctx.restore();
                });
            }
        });
    }
};

function renderMonthlyCostsChart(labels, costs, counts) {
    const ctx = document.getElementById('monthly-costs-chart').getContext('2d');
    if(window.monthlyCostsChart) window.monthlyCostsChart.destroy();
    window.monthlyCostsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'Miesiƒôczny koszt paliwa',
                    data: costs,
                    backgroundColor: 'rgba(190, 18, 60, 0.7)',
                    yAxisID: 'y',
                },
                {
                    label: 'Liczba tankowa≈Ñ',
                    data: counts,
                    type: 'line',
                    borderColor: 'rgba(3, 105, 161, 0.7)',
                    yAxisID: 'y1',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: true }, datalabels: { display: true } },
            scales: {
                x: { grid: { display: false } },
                y: { display: true, position: 'left', beginAtZero: true, grid: { display: false }, ticks: {callback: (v) => fmt(v) } },
                y1: { display: true, position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, ticks: { stepSize: 1 } }
            }
        },
        plugins: [datalabelsPlugin]
    });
}


function renderAvgPriceChart(labels, prices) {
    const ctx = document.getElementById('avg-price-chart').getContext('2d');
    if(window.avgPriceChart) window.avgPriceChart.destroy();
    window.avgPriceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: '≈örednia cena za litr',
                data: prices,
                borderColor: 'rgba(234, 88, 12, 0.7)',
                backgroundColor: 'rgba(234, 88, 12, 0.1)',
                fill: true,
                tension: 0.1
            }]
        },
        options: { 
            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }},
            scales: { x: { grid: { display: false } }, y: { grid: { display: false }, beginAtZero: false, ticks: { callback: (v) => fmt(v, 'PLN/L') } } } 
        }
    });
}

addBtn.addEventListener('click', () => {
    const id = txIdInput.value;
    const date = dateInput.value;
    const type = typeInput.value;
    const ref = refInput.value;
    const liters = num(litersInput.value);
    const amountRaw = num(amountInput.value);

    if (!date || !amountRaw) {
        alert('Data i kwota sƒÖ wymagane.');
        return;
    }
    const amount = type === 'invoice' ? -Math.abs(amountRaw) : Math.abs(amountRaw);
    
    if (id) { // Edit mode
        const index = state.transactions.findIndex(tx => tx.id === id);
        if (index > -1) {
            state.transactions[index] = { id, date, type, ref, liters: type === 'invoice' ? liters : null, amount };
        }
    } else { // Add mode
        state.transactions.push({ id: `tx_${Date.now()}`, date, type, ref, liters: type === 'invoice' ? liters : null, amount });
    }

    saveState(state);
    resetForm();
    render();
});

cancelEditBtn.addEventListener('click', resetForm);

exportBtn.addEventListener('click', () => {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Data;Typ;Opis;Litry;Kwota\n";

    state.transactions.forEach(tx => {
        const row = [
            tx.date,
            tx.type,
            `"${tx.ref.replace(/"/g, '""')}"`,
            tx.liters || 0,
            Math.abs(tx.amount)
        ].join(';');
        csvContent += row + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `paliwo_export_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

importBtn.addEventListener('click', () => csvFileInput.click());
csvFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        const text = event.target.result;
        const rows = text.split('\n').slice(1); // Skip header
        let importedCount = 0;
        rows.forEach(rowStr => {
            if (!rowStr.trim()) return;
            const columns = rowStr.split(';');
            if (columns.length < 5) return;

            const [date, type, ref, liters, amountRaw] = columns;
            
            const amount = type.trim().toLowerCase() === 'invoice' 
                ? -Math.abs(num(amountRaw)) 
                : Math.abs(num(amountRaw));

            state.transactions.push({
                id: `tx_${Date.now()}_${Math.random()}`,
                date: date.trim(),
                type: type.trim().toLowerCase(),
                ref: ref.replace(/"/g, '').trim(),
                liters: num(liters),
                amount: amount
            });
            importedCount++;
        });
        saveState(state);
        render();
        alert(`Zaimportowano ${importedCount} transakcji.`);
    };
    reader.readAsText(file);
    e.target.value = ''; // Reset file input
});


clearAllBtn.addEventListener('click', () => {
    if (confirm('Czy na pewno chcesz usunƒÖƒá wszystkie dane z modu≈Çu paliwowego? Tej operacji nie mo≈ºna cofnƒÖƒá.')) {
        state.transactions = [];
        saveState(state);
        render();
        alert('Wszystkie dane zosta≈Çy usuniƒôte.');
    }
});

// Initial setup
dateInput.value = new Date().toISOString().slice(0,10);
document.getElementById('analytics-period-filter').onchange = renderAnalytics;
render();

</script>
</body>
</html>