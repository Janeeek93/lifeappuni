<!doctype html>
<html lang="pl" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS ‚Äî Kredyt</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <style>
    .grid { display: grid; gap: 14px; }
    .g-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .g-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 900px) {
      .g-2 { grid-template-columns: 1fr; }
      .g-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .g-3 { grid-template-columns: 1fr; }
    }

    .loan-setup-card {
      text-align: center;
      padding: 48px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }

    .setup-icon {
      font-size: 48px;
    }

    .loan-progress-card {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .loan-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .loan-progress-header .title {
      margin: 0;
    }

    .loan-progress-percent {
      font-size: 24px;
      font-weight: 800;
      color: var(--ink);
    }

    .loan-progress-bar {
      height: 14px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--line);
      overflow: hidden;
    }

    .loan-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), hsl(152 76% 48%));
      transition: width 0.5s ease-out;
    }

    .loan-progress-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .loan-progress-stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--surface);
    }

    .loan-progress-stat .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-weight: 600;
    }

    .loan-progress-stat .value {
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
    }

    .loan-progress-stat .note {
      font-size: 12px;
      color: var(--muted);
    }

    .loan-progress-stat .value .currency {
      font-size: 12px;
      color: var(--muted);
      margin-left: 4px;
      font-weight: 600;
    }

    .kpi-value .currency {
      font-size: 12px;
      color: var(--muted);
      margin-left: 4px;
      font-weight: 600;
    }

    /* Projected badge for chart legend */
    .projected-legend {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px dashed var(--line);
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
      margin-left: auto;
    }

    .loan-charts-card {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .loan-analytics-hub {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .loan-tab-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .loan-tab-btn {
      border: 1px solid var(--line);
      background: var(--surface);
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    .loan-tab-btn.active {
      background: var(--ink);
      color: var(--card);
      border-color: transparent;
    }

    .loan-tab-panels {
      position: relative;
      min-height: 320px;
    }

    .loan-tab-panel {
      display: none;
      flex-direction: column;
      gap: 18px;
    }

    .loan-tab-panel.active {
      display: flex;
    }

    .loan-chart-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .loan-chart-actions.with-switch {
      justify-content: space-between;
    }

    .loan-chart-toggle {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--surface);
      color: var(--ink);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .loan-chart-switch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--surface);
    }

    .loan-chart-mode-btn {
      border: none;
      background: transparent;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .loan-chart-mode-btn.active {
      background: var(--blue-soft);
      color: var(--blue);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.06);
    }

    .loan-chart-mode-btn:focus-visible {
      outline: 2px solid var(--blue);
      outline-offset: 2px;
    }

    .loan-chart-toggle:hover,
    .loan-chart-toggle:focus {
      background: var(--card);
      color: var(--ink);
      outline: none;
    }

    .loan-chart-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 18px;
    }

    .loan-chart-area,
    .loan-donut-area {
      position: relative;
      min-height: 300px;
    }

    .loan-donut-area { min-height: 260px; }

    @media (max-width: 1200px) {
      .loan-chart-grid { grid-template-columns: 1fr; }
      .loan-donut-area { min-height: 240px; }
    }

    .loan-chart-placeholder {
      display: none;
      border: 1px dashed var(--line);
      border-radius: 14px;
      padding: 32px;
      text-align: center;
      font-size: 14px;
      color: var(--muted);
      align-items: center;
      justify-content: center;
      min-height: 220px;
    }

    .loan-table-card {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .table-wrapper.scrollable {
      max-height: 360px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: middle;
      font-size: 13px;
    }

    thead th {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    tbody tr:hover { background: var(--surface); }

    .rate-history-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .rate-history-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .rate-history-entry {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--surface);
    }

    .rate-history-entry.current {
      border-color: var(--accent);
      background: var(--accent-weak);
    }

    .rate-history-entry .rate {
      font-weight: 700;
      font-size: 16px;
    }

    .rate-history-entry .date {
      font-size: 12px;
      color: var(--muted);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: var(--card);
      font-size: 14px;
    }

    hr.divider {
      border: none;
      border-top: 1px solid var(--line);
      margin: 20px 0;
    }

    /* === Schedule Timeline === */
    .schedule-card {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .schedule-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .schedule-filter-btn {
      border: 1px solid var(--line);
      background: var(--surface);
      color: var(--muted);
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    .schedule-filter-btn.active {
      background: var(--ink);
      color: var(--card);
      border-color: transparent;
    }

    .schedule-filter-btn .count {
      margin-left: 4px;
      font-size: 10px;
      opacity: 0.7;
    }

    .schedule-timeline {
      display: flex;
      flex-direction: column;
      gap: 0;
      position: relative;
    }

    .schedule-timeline::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 24px;
      bottom: 24px;
      width: 2px;
      background: var(--line);
      z-index: 0;
    }

    .schedule-item {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      padding: 12px 0;
      position: relative;
      z-index: 1;
    }

    .schedule-dot {
      width: 32px;
      height: 32px;
      min-width: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border: 2px solid var(--line);
      background: var(--card);
      transition: all 0.2s ease;
    }

    .schedule-item[data-status="paid"] .schedule-dot {
      background: var(--green-soft);
      border-color: var(--green);
    }

    .schedule-item[data-status="current"] .schedule-dot {
      background: var(--blue-soft);
      border-color: var(--blue);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }

    .schedule-item[data-status="planned"] .schedule-dot {
      background: var(--surface);
      border-color: var(--line);
      border-style: dashed;
    }

    .schedule-item[data-status="overdue"] .schedule-dot {
      background: hsl(0 76% 95%);
      border-color: hsl(0 76% 55%);
    }

    .schedule-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .schedule-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    .schedule-date {
      font-weight: 600;
      font-size: 14px;
      color: var(--ink);
    }

    .schedule-amount {
      font-weight: 700;
      font-size: 15px;
      color: var(--ink);
    }

    .schedule-breakdown {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }

    .schedule-breakdown span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .schedule-breakdown .dot-green { color: var(--green); }
    .schedule-breakdown .dot-orange { color: var(--orange); }
    .schedule-breakdown .dot-blue { color: var(--blue); }

    .schedule-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .schedule-badge.paid {
      background: var(--green-soft);
      color: var(--green);
    }

    .schedule-badge.current {
      background: var(--blue-soft);
      color: var(--blue);
    }

    .schedule-badge.planned {
      background: var(--surface);
      color: var(--muted);
      border: 1px dashed var(--line);
    }

    .schedule-badge.overdue {
      background: hsl(0 76% 95%);
      color: hsl(0 76% 55%);
    }

    .schedule-actions {
      display: flex;
      gap: 6px;
      margin-top: 2px;
    }

    .schedule-actions .btn {
      font-size: 11px;
      padding: 4px 10px;
    }

    .schedule-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      padding: 14px;
      border-radius: 12px;
      background: var(--surface);
      border: 1px solid var(--line);
    }

    .schedule-summary-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .schedule-summary-item .label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-weight: 600;
    }

    .schedule-summary-item .value {
      font-size: 15px;
      font-weight: 700;
      color: var(--ink);
    }

    .schedule-empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--muted);
      font-size: 14px;
    }

    .schedule-show-more {
      text-align: center;
      padding: 8px;
    }

    .schedule-show-more .btn {
      font-size: 12px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 5vh;
      z-index: 1000;
      backdrop-filter: blur(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease-out;
      overflow-y: auto;
    }

    .modal-overlay.visible {
      opacity: 1;
      pointer-events: all;
    }

    .modal-card {
      background: var(--card);
      padding: 0;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      max-width: 520px;
      width: 92%;
      transform: scale(0.96);
      transition: transform 0.2s ease;
      border: 1px solid var(--line);
      overflow: hidden;
      margin-bottom: 5vh;
    }

    .modal-overlay.visible .modal-card {
      transform: scale(1);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--line);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--line);
      background: var(--surface);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>
<body data-page="loan">

  <div class="layout">
    <aside class="sidebar" aria-label="G≈Ç√≥wna nawigacja">
      <div class="sidebar__header">
        <span class="sidebar__emoji">üß≠</span>
        <span class="sidebar__brand">LifeOS</span>
      </div>
      <nav class="sidebar__nav" aria-label="Sekcje LifeOS">
        <ul class="sidebar__list">
          <li class="sidebar__item">
            <a class="sidebar__link" href="index.html" data-page="dashboard">
              <span class="sidebar__icon">üìä</span>
              <span class="sidebar__label">Dashboard</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="budget.html" data-page="budget">
              <span class="sidebar__icon">üí∞</span>
              <span class="sidebar__label">Bud≈ºet</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="tasks.html" data-page="tasks">
              <span class="sidebar__icon">‚úÖ</span>
              <span class="sidebar__label">Zadania</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="trainings.html" data-page="trainings">
              <span class="sidebar__icon">üí™</span>
              <span class="sidebar__label">Progres</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="fuel.html" data-page="fuel">
              <span class="sidebar__icon">‚õΩ</span>
              <span class="sidebar__label">Paliwo</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="loan.html" data-page="loan">
              <span class="sidebar__icon">üè¶</span>
              <span class="sidebar__label">Kredyt</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="inventory.html" data-page="inventory">
              <span class="sidebar__icon">üì¶</span>
              <span class="sidebar__label">Magazyn</span>
            </a>
          </li>
          <li class="sidebar__item">
            <a class="sidebar__link" href="house.html" data-page="house">
              <span class="sidebar__icon">üè†</span>
              <span class="sidebar__label">Budowa</span>
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar__footer">
        <strong>Tw√≥j cyfrowy dom</strong>
        ZarzƒÖdzaj bud≈ºetem, zadaniami i celami w jednym miejscu.
      </div>
    </aside>

    <div class="main">
      <header class="page-header" role="banner">
        <div class="page-header__top">
          <span class="page-overline">Finanse</span>
          <h1 class="page-title">
            <span class="page-title__icon">üè¶</span>
            <span class="page-title__text">Kredyt</span>
          </h1>
        </div>
        <div class="page-header__actions" aria-label="Akcje strony">
          <button class="btn soft" id="settings-btn" style="display: none;">‚öôÔ∏è Ustawienia</button>
          <button class="btn primary" id="add-payment-btn" style="display: none;">+ Dodaj sp≈Çatƒô</button>
        </div>
      </header>

      <div class="content">
        <main class="stack tight">
          <div id="app-container" class="stack tight">

            <section id="setup-container" class="card loan-setup-card" style="display: none;">
              <div class="setup-icon">üìä</div>
              <h2 class="title">Witaj w module kredytowym!</h2>
              <p class="muted" style="max-width: 420px; margin: 0 auto;">Aby rozpoczƒÖƒá, wprowad≈∫ podstawowe informacje o swoim kredycie. Te dane pos≈Çu≈ºƒÖ do wszystkich dalszych oblicze≈Ñ.</p>
              <button class="btn primary" id="setup-loan-btn">Skonfiguruj kredyt</button>
            </section>

            <div id="dashboard-container" class="stack tight" style="display: none;">
              <section class="card loan-progress-card">
                <div class="loan-progress-header">
                  <h2 class="title">Postƒôp sp≈Çaty kapita≈Çu</h2>
                  <span id="progress-percent" class="loan-progress-percent">0%</span>
                </div>
                <span id="progress-text" class="tiny muted"></span>
                <div class="loan-progress-bar">
                  <div id="progress-bar-inner" class="loan-progress-fill" style="width: 0%;"></div>
                </div>
                <div class="loan-progress-stats">
                  <div class="loan-progress-stat">
                    <span class="label">Suma nadp≈Çat</span>
                    <span id="overpayments-total" class="value"></span>
                  </div>
                  <div class="loan-progress-stat">
                    <span class="label">Raty wykonane</span>
                    <span id="payments-count" class="value"></span>
                    <span id="payments-sub" class="note"></span>
                  </div>
                  <div class="loan-progress-stat">
                    <span class="label">Kredyt skr√≥cony o</span>
                    <span id="time-saved" class="value"></span>
                  </div>
                </div>
              </section>

              <section class="card loan-charts-card" id="loan-analytics-card">
                <div class="section-heading">
                  <h2 class="title">Hub analityczny</h2>
                  <span class="tiny muted">Prze≈ÇƒÖcz zak≈Çadki, aby por√≥wnaƒá strukturƒô rat i postƒôpy sp≈Çaty</span>
                </div>
                <div class="loan-analytics-hub">
                  <div class="loan-tab-nav" id="loan-tab-nav">
                    <button class="loan-tab-btn active" data-chart="mix">Struktura raty</button>
                    <button class="loan-tab-btn" data-chart="line">Kapita≈Ç vs odsetki</button>
                    <button class="loan-tab-btn" data-chart="share">Udzia≈Çy w czasie</button>
                    <button class="loan-tab-btn" data-chart="cumulative">Kumulacja sp≈Çat</button>
                    <button class="loan-tab-btn" data-chart="balance">Saldo kredytu</button>
                    <button class="loan-tab-btn" data-chart="rate">Trend oprocentowania</button>
                    <button class="loan-tab-btn" data-chart="change">Zmiana raty</button>
                  </div>
                  <div id="loan-chart-placeholder" class="loan-chart-placeholder">
                    Dodaj raty, aby zobaczyƒá analizy sp≈Çaty kredytu.
                  </div>
                  <div class="loan-tab-panels" id="loan-tab-panels">
                    <div class="loan-tab-panel active" data-chart="mix">
                      <div style="display:flex; justify-content:flex-end; margin-bottom: 6px;">
                        <span class="projected-legend" id="projected-legend" style="display:none;">Bladsze s≈Çupki = 3 prognozowane raty</span>
                      </div>
                      <div class="loan-chart-grid">
                        <div class="loan-chart-area">
                          <canvas id="capital-chart"></canvas>
                        </div>
                        <div class="loan-donut-area">
                          <canvas id="structure-chart"></canvas>
                        </div>
                      </div>
                    </div>
                    <div class="loan-tab-panel" data-chart="line">
                      <div class="loan-chart-actions">
                        <button class="loan-chart-toggle" type="button" data-chart-toggle="line">Poka≈º dane</button>
                      </div>
                      <div class="loan-chart-area" style="min-height:320px;">
                        <canvas id="monthly-line-chart"></canvas>
                      </div>
                    </div>
                    <div class="loan-tab-panel" data-chart="share">
                      <div class="loan-chart-actions">
                        <button class="loan-chart-toggle" type="button" data-chart-toggle="share">Poka≈º dane</button>
                      </div>
                      <div class="loan-chart-area" style="min-height:320px;">
                        <canvas id="share-area-chart"></canvas>
                      </div>
                    </div>
                    <div class="loan-tab-panel" data-chart="cumulative">
                      <div class="loan-chart-actions">
                        <button class="loan-chart-toggle" type="button" data-chart-toggle="cumulative">Poka≈º dane</button>
                      </div>
                      <div class="loan-chart-area" style="min-height:320px;">
                        <canvas id="cumulative-chart"></canvas>
                      </div>
                    </div>
                    <div class="loan-tab-panel" data-chart="balance">
                      <div class="loan-chart-area" style="min-height:320px;">
                        <canvas id="balance-chart"></canvas>
                      </div>
                    </div>
                    <div class="loan-tab-panel" data-chart="rate">
                      <div class="loan-chart-area" style="min-height:320px;">
                        <canvas id="rate-trend-chart"></canvas>
                      </div>
                    </div>
                    <div class="loan-tab-panel" data-chart="change">
                      <div class="loan-chart-actions with-switch">
                        <div class="loan-chart-switch" role="group" aria-label="Tryb zmian raty">
                          <button class="loan-chart-mode-btn active" type="button" data-change-mode="value">Kwotowo</button>
                          <button class="loan-chart-mode-btn" type="button" data-change-mode="percent">Procentowo</button>
                        </div>
                        <button class="loan-chart-toggle" type="button" data-chart-toggle="change">Poka≈º dane</button>
                      </div>
                      <div class="loan-chart-area" style="min-height:320px;">
                        <canvas id="payment-change-chart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section class="card schedule-card" id="schedule-card">
                <div class="section-heading">
                  <h2 class="title">Harmonogram rat</h2>
                  <span class="tiny muted">O≈õ czasu sp≈Çat z planowanymi ratami i statusami</span>
                </div>
                <div id="schedule-summary" class="schedule-summary" style="display:none;"></div>
                <div class="schedule-controls" id="schedule-controls">
                  <button class="schedule-filter-btn active" data-filter="all">Wszystkie</button>
                  <button class="schedule-filter-btn" data-filter="paid">Op≈Çacone</button>
                  <button class="schedule-filter-btn" data-filter="planned">Planowane</button>
                  <button class="schedule-filter-btn" data-filter="overdue">Zaleg≈Çe</button>
                </div>
                <div id="schedule-timeline" class="schedule-timeline"></div>
                <div id="schedule-show-more" class="schedule-show-more" style="display:none;">
                  <button class="btn soft" id="schedule-show-more-btn">Poka≈º wiƒôcej rat</button>
                </div>
              </section>

              <section class="card loan-table-card">
                <div class="section-heading">
                  <h2 class="title">Historia sp≈Çat</h2>
                  <span class="tiny muted">Edytuj dowolny wpis, aby zaktualizowaƒá harmonogram</span>
                </div>
                <div class="table-wrapper scrollable">
                  <table>
                    <thead>
                      <tr>
                        <th>Data</th>
                        <th>Kapita≈Ç</th>
                        <th>Odsetki</th>
                        <th>Nadp≈Çata</th>
                        <th>Suma raty</th>
                        <th>Akcje</th>
                      </tr>
                    </thead>
                    <tbody id="history-tbody"></tbody>
                  </table>
                </div>
              </section>

              <section class="card rate-history-card" id="rate-history-card">
                <div class="section-heading">
                  <h2 class="title">Historia oprocentowania</h2>
                  <span class="tiny muted">Aktualne stawki wp≈ÇywajƒÖ na kolejne raty</span>
                </div>
                <ul id="rate-history-list" class="rate-history-list"></ul>
              </section>
            </div>
          </div>
        </main>

        <aside class="right-rail">
          <div class="kpi-compact">
            <span class="kpi-emoji">üí∞</span>
            <div class="kpi-body">
              <span class="kpi-label">Kapita≈Ç pozosta≈Çy</span>
              <span class="kpi-value" id="capital-remaining">‚Äî</span>
              <span class="tiny muted" id="capital-remaining-note"></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">üìâ</span>
            <div class="kpi-body">
              <span class="kpi-label">Kapita≈Ç sp≈Çacony</span>
              <span class="kpi-value" id="capital-paid">‚Äî</span>
              <span class="tiny muted" id="capital-paid-note"></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">üìà</span>
            <div class="kpi-body">
              <span class="kpi-label">Odsetki sp≈Çacone</span>
              <span class="kpi-value" id="interest-paid">‚Äî</span>
              <span class="tiny muted" id="interest-paid-note"></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">üí∏</span>
            <div class="kpi-body">
              <span class="kpi-label">≈ör. rata</span>
              <span class="kpi-value" id="avg-installment">‚Äî</span>
              <span class="tiny muted" id="avg-installment-note"></span>
            </div>
          </div>
          <div class="kpi-compact">
            <span class="kpi-emoji">‚è≥</span>
            <div class="kpi-body">
              <span class="kpi-label">Nastƒôpna rata</span>
              <span class="kpi-value" id="next-payment">‚Äî</span>
              <span class="tiny muted" id="next-payment-note"></span>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <div id="modal-overlay" class="modal-overlay" role="dialog">
    <div class="modal-card" id="modal-card">
      <div class="modal-header">
        <h3 id="modal-title" class="modal-title"></h3>
      </div>
      <div id="modal-body" class="modal-body"></div>
      <div id="modal-footer" class="modal-footer"></div>
    </div>
  </div>

<script>
  (function activateSidebarLink() {
    const currentPage = document.body.dataset.page;
    if (!currentPage) return;
    document.querySelectorAll('.sidebar__link[data-page]').forEach((link) => {
      if (link.dataset.page === currentPage) {
        link.classList.add('sidebar__link--active');
        link.setAttribute('aria-current', 'page');
      } else {
        link.classList.remove('sidebar__link--active');
        link.removeAttribute('aria-current');
      }
    });
  })();
</script>
<script>
const STORAGE_KEY = 'lifeos_loan_v1';

const defaultState = {
  loanDetails: null, // contains totalCapital, startDate, loanTerm, interestRateHistory
  payments: [], // contains id, date, capital, interest, overpayment
  projectedPayments: [], // { monthKey, interest } - user overrides for projected interest
};

let state = {};
let charts = {};
let chartDataCache = null;
const chartLabelState = {
  line: false,
  share: false,
  cumulative: false,
  change: false
};

let paymentChangeMode = 'value';

function $(selector) { return document.querySelector(selector); }
function $$(selector) { return document.querySelectorAll(selector); }

/* === State Management === */
function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  state = saved ? JSON.parse(saved) : { ...defaultState };
  if (!state.projectedPayments) state.projectedPayments = [];
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function fmt(n) {
  try {
    const value = Number(n || 0);
    const formatter = new Intl.NumberFormat('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const formatted = formatter.format(value).replace(/\u00a0/g, ' ');
    if (Math.abs(value) < 10000) {
      const compact = formatted.replace(/\s(?=\d)/g, '');
      return `${compact} z≈Ç`;
    }
    return `${formatted} z≈Ç`;
  } catch {
    return `${(n || 0).toFixed(2)} z≈Ç`;
  }
}

function fmtPlain(n) {
  try {
    const value = Number(n || 0);
    const formatter = new Intl.NumberFormat('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    return formatter.format(value).replace(/\u00a0/g, ' ');
  } catch {
    return Number(n || 0).toFixed(2);
  }
}

function formatThousands(value, fractionDigits = 1) {
  const formatter = new Intl.NumberFormat('pl-PL', {
    minimumFractionDigits: fractionDigits,
    maximumFractionDigits: fractionDigits,
  });
  return formatter.format(value).replace(/\u00a0/g, ' ');
}

function fmtChartValue(n) {
  try {
    const value = Number(n || 0);
    if (!Number.isFinite(value)) return '0 z≈Ç';
    if (Math.abs(value) >= 1000) {
      return `${formatThousands(value / 1000, 1)} k z≈Ç`;
    }
    return fmt(value);
  } catch {
    const numeric = Number(n || 0);
    if (Math.abs(numeric) >= 1000) {
      return `${(numeric / 1000).toFixed(1)} k z≈Ç`;
    }
    return fmt(numeric);
  }
}

function fmtChartTick(n) {
  try {
    const value = Number(n || 0);
    if (!Number.isFinite(value)) return '0 z≈Ç';
    if (Math.abs(value) >= 1000) {
      return `${formatThousands(value / 1000, 1)} k z≈Ç`;
    }
    return `${fmtPlain(value)} z≈Ç`;
  } catch {
    const numeric = Number(n || 0);
    if (Math.abs(numeric) >= 1000) {
      return `${(numeric / 1000).toFixed(1)} k z≈Ç`;
    }
    return `${Number(numeric || 0).toFixed(2)} z≈Ç`;
  }
}

function formatRateValue(value) {
  const numeric = Number.parseFloat(value || 0);
  if (Number.isNaN(numeric)) return 0;
  return Number(numeric.toFixed(2));
}

/* === Modal Logic === */
function openModal(title, body, footer) {
  $('#modal-title').textContent = title;
  $('#modal-body').innerHTML = body;
  $('#modal-footer').innerHTML = footer;
  $('#modal-overlay').classList.add('visible');
}

function closeModal() {
  $('#modal-overlay').classList.remove('visible');
}

/* === Initial Setup & Settings === */
function openSetupModal() {
  const loan = state.loanDetails || { interestRateHistory: [] };
  const title = loan.totalCapital ? 'Edytuj dane kredytu' : 'Konfiguracja kredytu';
  
  let historyHTML = loan.interestRateHistory.map(h => `
    <div class="grid g-3" style="align-items: center; gap: 8px; margin-bottom: 8px;" data-id="${h.id}">
      <input type="month" class="form-input" data-field="date" value="${h.date}">
      <input type="number" step="0.01" class="form-input" data-field="rate" value="${h.rate}">
      <button class="btn danger" onclick="this.parentElement.remove()">Usu≈Ñ</button>
    </div>
  `).join('');

  const body = `
    <div class="form-group">
        <label class="form-label">Ca≈Çkowita kwota kapita≈Çu</label>
        <input type="number" id="totalCapital" class="form-input" value="${loan.totalCapital || ''}">
    </div>
    <div class="form-group">
        <label class="form-label">Okres kredytowania (lata)</label>
        <input type="number" id="loanTerm" class="form-input" value="${loan.loanTerm || ''}">
    </div>
     <hr class="divider">
    <h4 class="title tiny" style="text-transform: uppercase; color: var(--muted);">Historia oprocentowania</h4>
    <div id="interest-history-list">
        <div class="grid g-3 tiny" style="padding: 0 8px; margin-bottom: 4px;">
            <span>MiesiƒÖc zmiany</span><span>Nowa stawka (%)</span>
        </div>
        ${historyHTML}
    </div>
    <button class="btn" onclick="addInterestRateRow()" style="margin-top: 10px;">+ Dodaj zmianƒô</button>
  `;
  const footer = `
    <button class="btn" onclick="closeModal()">Anuluj</button>
    <button class="btn primary" onclick="saveSetup()">Zapisz</button>
  `;
  openModal(title, body, footer);
}

function addInterestRateRow() {
    const list = $('#interest-history-list');
    const newId = 'rate_' + Date.now();
    const row = document.createElement('div');
    row.className = 'grid g-3';
    row.style.cssText = 'align-items: center; gap: 8px; margin-bottom: 8px;';
    row.dataset.id = newId;
    row.innerHTML = `
        <input type="month" class="form-input" data-field="date">
        <input type="number" step="0.01" class="form-input" data-field="rate" placeholder="np. 7.25">
        <button class="btn danger" onclick="this.parentElement.remove()">Usu≈Ñ</button>
    `;
    list.appendChild(row);
}

function saveSetup() {
  const totalCapital = parseFloat($('#totalCapital').value);
  const loanTerm = parseInt($('#loanTerm').value);

  if (!totalCapital || !loanTerm) {
    alert('Kapita≈Ç i okres kredytowania sƒÖ wymagane!');
    return;
  }
  
  const interestRateHistory = [];
  $$('#interest-history-list > div[data-id]').forEach(row => {
      const date = row.querySelector('[data-field="date"]').value;
      const rate = parseFloat(row.querySelector('[data-field="rate"]').value);
      if (date && !isNaN(rate)) {
          interestRateHistory.push({ id: row.dataset.id, date, rate });
      }
  });
  
  interestRateHistory.sort((a, b) => a.date.localeCompare(b.date));
  
  state.loanDetails = { 
      ...state.loanDetails,
      totalCapital, 
      loanTerm, 
      startDate: state.loanDetails?.startDate || interestRateHistory[0]?.date + '-01',
      interestRateHistory 
  };
  saveState();
  closeModal();
  render();
}

/* === Payment Entry === */
function openPaymentModal(paymentId = null) {
    const payment = paymentId ? state.payments.find(p => p.id === paymentId) : null;
    const title = payment ? 'Edytuj sp≈Çatƒô' : 'Dodaj miesiƒôcznƒÖ sp≈Çatƒô';
    const today = new Date();
    const defaultDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

    const body = `
        <div class="form-group">
            <label class="form-label">MiesiƒÖc i rok sp≈Çaty</label>
            <input type="month" id="paymentDate" class="form-input" value="${payment ? payment.date : defaultDate}">
        </div>
        <div class="form-group">
            <label class="form-label">Sp≈Çacony kapita≈Ç</label>
            <input type="number" id="capitalPaid" class="form-input" step="0.01" value="${payment ? payment.capital : ''}">
        </div>
        <div class="form-group">
            <label class="form-label">Zap≈Çacone odsetki</label>
            <input type="number" id="interestPaid" class="form-input" step="0.01" value="${payment ? payment.interest : ''}">
        </div>
        <div class="form-group">
            <label class="form-label">Nadp≈Çata kapita≈Çu (opcjonalnie)</label>
            <input type="number" id="overpayment" class="form-input" step="0.01" value="${payment ? payment.overpayment || '' : ''}">
        </div>
    `;
    const footer = `
        <button class="btn" onclick="closeModal()">Anuluj</button>
        ${payment ? `<button class="btn danger" onclick="deletePayment('${payment.id}')">Usu≈Ñ</button>` : ''}
        <button class="btn primary" onclick="savePayment('${payment ? payment.id : ''}')">Zapisz</button>
    `;
    openModal(title, body, footer);
}

function savePayment(paymentId) {
    const date = $('#paymentDate').value;
    const capital = parseFloat($('#capitalPaid').value);
    const interest = parseFloat($('#interestPaid').value);
    const overpayment = parseFloat($('#overpayment').value) || 0;

    if (!date || isNaN(capital) || isNaN(interest)) {
        alert('Data, kapita≈Ç i odsetki muszƒÖ byƒá poprawnie wype≈Çnione.');
        return;
    }
    
    if (paymentId) {
        const index = state.payments.findIndex(p => p.id === paymentId);
        if (index > -1) {
            state.payments[index] = { ...state.payments[index], date, capital, interest, overpayment };
        }
    } else {
        state.payments.push({ id: 'payment_' + Date.now(), date, capital, interest, overpayment });
    }
    
    state.payments.sort((a, b) => a.date.localeCompare(b.date));
    saveState();
    closeModal();
    render();
}

function deletePayment(paymentId) {
    if (confirm('Czy na pewno chcesz usunƒÖƒá ten wpis?')) {
        state.payments = state.payments.filter(p => p.id !== paymentId);
        saveState();
        closeModal();
        render();
    }
}

/* === Rendering Logic === */
function render() {
  if (!state.loanDetails) {
    $('#setup-container').style.display = 'block';
    $('#dashboard-container').style.display = 'none';
    $('#add-payment-btn').style.display = 'none';
    $('#settings-btn').style.display = 'none';
  } else {
    $('#setup-container').style.display = 'none';
    $('#dashboard-container').style.display = 'flex';
    $('#add-payment-btn').style.display = 'inline-flex';
    $('#settings-btn').style.display = 'inline-flex';
    renderDashboard();
    renderHistoryTable();
    renderSchedule();
    renderCharts();
  }
}

function renderDashboard() {
    const { loanDetails, payments } = state;
    const totalOverpayments = payments.reduce((sum, p) => sum + (p.overpayment || 0), 0);
    const totalCapitalPaid = payments.reduce((sum, p) => sum + p.capital, 0) + totalOverpayments;
    const totalInterestPaid = payments.reduce((sum, p) => sum + p.interest, 0);
    const capitalRemaining = loanDetails.totalCapital - totalCapitalPaid;
    const progress = (totalCapitalPaid / loanDetails.totalCapital) * 100;

    $('#capital-remaining').textContent = fmt(capitalRemaining);
    $('#capital-paid').textContent = fmt(totalCapitalPaid);
    $('#overpayments-total').textContent = fmt(totalOverpayments);
    $('#interest-paid').textContent = fmt(totalInterestPaid);
    $('#payments-count').innerHTML = `${payments.length}<span class="currency">z ${loanDetails.loanTerm * 12}</span>`;

    const originalMonths = loanDetails.loanTerm * 12;
    const monthsPaid = payments.length;
    const avgMonthlyPrincipal = monthsPaid > 0 ? payments.reduce((s, p) => s + p.capital, 0) / monthsPaid : 0;
    const avgInstallment = monthsPaid > 0 ? payments.reduce((s, p) => s + p.capital + p.interest + (p.overpayment || 0), 0) / monthsPaid : 0;
    const projectedMonthsRemaining = avgMonthlyPrincipal > 0 ? capitalRemaining / avgMonthlyPrincipal : Infinity;
    const monthsSaved = originalMonths - monthsPaid - projectedMonthsRemaining;

    const capitalRemainingNoteEl = $('#capital-remaining-note');
    const capitalPaidNoteEl = $('#capital-paid-note');
    const interestPaidNoteEl = $('#interest-paid-note');
    const avgInstallmentNoteEl = $('#avg-installment-note');

    if (capitalRemainingNoteEl) {
        if (payments.length && projectedMonthsRemaining && isFinite(projectedMonthsRemaining)) {
            const monthsLeft = Math.max(0, Math.round(projectedMonthsRemaining));
            const label = monthsLeft > 0 ? `~${monthsLeft} rat do ko≈Ñca` : 'Finisz w zasiƒôgu rƒôki';
            capitalRemainingNoteEl.textContent = label;
        } else if (loanDetails.totalCapital) {
            capitalRemainingNoteEl.textContent = 'Dodaj raty, by wyliczyƒá prognozƒô';
        } else {
            capitalRemainingNoteEl.textContent = '';
        }
    }

    if (capitalPaidNoteEl) {
        if (payments.length) {
            capitalPaidNoteEl.textContent = totalOverpayments > 0 ? `Nadp≈Çaty ${fmt(totalOverpayments)}` : "Standardowe raty bez nadp≈Çat";
        } else {
            capitalPaidNoteEl.textContent = 'Dodaj pierwszƒÖ ratƒô';
        }
    }

    if (interestPaidNoteEl) {
        const totalOutflow = payments.reduce((sum, p) => sum + p.capital + p.interest + (p.overpayment || 0), 0);
        if (totalOutflow > 0) {
            const share = ((totalInterestPaid / totalOutflow) * 100).toFixed(1);
            interestPaidNoteEl.textContent = `To ${share}% wszystkich wp≈Çat`;
        } else {
            interestPaidNoteEl.textContent = 'Brak danych o odsetkach';
        }
    }

    if (avgInstallmentNoteEl) {
        if (payments.length) {
            const latestPayment = [...payments].sort((a, b) => (a.date || '').localeCompare(b.date || '')).pop();
            const latestTotal = latestPayment ? latestPayment.capital + latestPayment.interest + (latestPayment.overpayment || 0) : 0;
            avgInstallmentNoteEl.textContent = latestPayment ? `Ostatnia rata ${fmt(latestTotal)}` : '';
        } else {
            avgInstallmentNoteEl.textContent = 'Brak danych o ratach';
        }
    }

    const avgInstallmentEl = $('#avg-installment');
    if (avgInstallmentEl) {
        avgInstallmentEl.textContent = monthsPaid > 0 ? fmt(avgInstallment) : '‚Äî';
    }

    if (monthsSaved > 0) {
        const years = Math.floor(monthsSaved / 12);
        const months = Math.round(monthsSaved % 12);
        $('#time-saved').innerHTML = `${years > 0 ? `${years} lat ` : ''}${months} mies.`;
    } else {
        $('#time-saved').innerHTML = `0 mies.`;
    }

    const projectedEndDate = new Date();
    projectedEndDate.setMonth(projectedEndDate.getMonth() + projectedMonthsRemaining);
    $('#payments-sub').textContent = `Nowy przewidywany koniec: ${projectedEndDate.toLocaleDateString('pl-PL', {year: 'numeric', month: 'long'})}`;

    $('#progress-bar-inner').style.width = `${progress}%`;
    $('#progress-percent').textContent = `${progress.toFixed(2)}%`;
    $('#progress-text').textContent = `${fmt(totalCapitalPaid)} / ${fmt(loanDetails.totalCapital)}`;

    const nextPaymentMonth = getNextPaymentMonth(payments, loanDetails);

    // Update right rail KPI notes
    const nextLabel = new Date(`${nextPaymentMonth}-01`).toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
    const nextRate = getRateForDate(nextPaymentMonth, loanDetails.interestRateHistory || []);
    const nextPaymentEl = $('#next-payment');
    const nextNoteEl = $('#next-payment-note');
    if (nextPaymentEl) nextPaymentEl.textContent = nextLabel || '‚Äî';
    if (nextNoteEl) nextNoteEl.textContent = nextRate ? `Oprocentowanie ${Number(nextRate).toFixed(2)}%` : '';

    renderRateHistory(loanDetails, nextPaymentMonth);
}

function renderHistoryTable() {
    const tbody = $('#history-tbody');
    if (state.payments.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;" class="muted">Brak zarejestrowanych sp≈Çat.</td></tr>`;
        return;
    }
    tbody.innerHTML = state.payments.map(p => {
        const date = new Date(p.date + '-02');
        const formattedDate = date.toLocaleDateString('pl-PL', { year: 'numeric', month: 'long' });
        return `
            <tr>
                <td>${formattedDate}</td>
                <td>${fmt(p.capital)}</td>
                <td>${fmt(p.interest)}</td>
                <td>${(p.overpayment || 0) > 0 ? fmt(p.overpayment) : '‚Äî'}</td>
                <td><strong>${fmt(p.capital + p.interest + (p.overpayment || 0))}</strong></td>
                <td><button class="btn tiny" onclick="openPaymentModal('${p.id}')">Edytuj</button></td>
            </tr>
        `;
    }).reverse().join('');
}

const doughnutCenterText = {
  id: 'doughnutCenterText',
  afterDraw: (chart) => {
    if (chart.config.type !== 'doughnut' || !chart.data.datasets[0].data.length) return;
    const { ctx, data } = chart;
    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
    ctx.save();
    const x = chart.getDatasetMeta(0).data[0].x;
    const y = chart.getDatasetMeta(0).data[0].y;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = 'bold 22px Inter, sans-serif';
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--ink').trim();
    ctx.fillText(fmt(total), x, y - 8);
    ctx.font = '12px Inter, sans-serif';
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted').trim();
    ctx.fillText('Suma sp≈Çat', x, y + 15);
    ctx.restore();
  }
};

function getRateForDate(paymentDate, history) {
    let currentRate = history[0]?.rate || 0;
    for (const change of history) {
        if (paymentDate >= change.date) {
            currentRate = change.rate;
        } else {
            break;
        }
    }
    return formatRateValue(currentRate);
}

function getNextPaymentMonth(payments, loanDetails) {
    const sorted = [...payments].filter(p => p.date).sort((a, b) => a.date.localeCompare(b.date));
    if (sorted.length) {
        const [year, month] = sorted[sorted.length - 1].date.split('-').map(Number);
        const next = new Date(Date.UTC(year, month - 1, 1));
        next.setUTCMonth(next.getUTCMonth() + 1);
        return `${next.getUTCFullYear()}-${String(next.getUTCMonth() + 1).padStart(2, '0')}`;
    }
    if (loanDetails?.startDate) {
        return loanDetails.startDate.slice(0, 7);
    }
    const history = loanDetails?.interestRateHistory || [];
    if (history.length) {
        return history[0].date;
    }
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
}

function renderRateHistory(loanDetails, nextPaymentMonth) {
    const list = $('#rate-history-list');
    if (!list) return;
    const history = loanDetails?.interestRateHistory || [];
    if (!history.length) {
        list.innerHTML = '<li class="muted" style="padding: 8px 0;">Brak historii zmian oprocentowania.</li>';
        return;
    }

    const sorted = [...history].sort((a, b) => a.date.localeCompare(b.date));
    const currentEntry = sorted.reduce((acc, entry) => entry.date <= nextPaymentMonth ? entry : acc, sorted[0]);

    list.innerHTML = sorted.map(entry => {
        const dateLabel = new Date(`${entry.date}-01`).toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
        const rateValue = Number(entry.rate || 0).toFixed(2);
        const isCurrent = currentEntry && entry.date === currentEntry.date;
        const badge = isCurrent ? '<span class="tiny" style="margin-left:8px; color:var(--accent); font-weight:600;">obecna</span>' : '';
        return `
            <li class="rate-history-entry${isCurrent ? ' current' : ''}">
                <span class="date">${dateLabel}${badge}</span>
                <span class="rate">${rateValue}%</span>
            </li>
        `;
    }).join('');
}

function renderCharts() {
  const placeholder = $('#loan-chart-placeholder');
  const panels = $('#loan-tab-panels');
  const tabNav = $('#loan-tab-nav');
  const payments = state.payments || [];
  const loanDetails = state.loanDetails || { interestRateHistory: [] };
  const hasPayments = payments.length > 0;

  if (placeholder) {
    placeholder.style.display = hasPayments ? 'none' : 'flex';
  }
  if (panels) {
    panels.style.display = hasPayments ? 'block' : 'none';
  }
  if (tabNav) {
    tabNav.style.display = hasPayments ? 'flex' : 'none';
  }

  if (!hasPayments) {
    destroyAllLoanCharts();
    chartDataCache = null;
    return;
  }

  Chart.defaults.font.family = "'Inter', sans-serif";
  Chart.defaults.color = getComputedStyle(document.body).getPropertyValue('--muted').trim();

  // === Paid data ===
  const paidCount = payments.length;
  const paymentLabels = payments.map(p => new Date(p.date + '-02').toLocaleDateString('pl-PL', { month: 'short', year: '2-digit' }));
  const basePrincipalSeries = payments.map(p => p.capital);
  const overpaymentSeries = payments.map(p => p.overpayment || 0);
  const principalSeries = payments.map((p, index) => basePrincipalSeries[index] + overpaymentSeries[index]);
  const interestSeries = payments.map(p => p.interest);
  const totalSeries = principalSeries.map((value, index) => value + interestSeries[index]);

  // === Projected data (3 future payments) ===
  const projections = generateProjections(3);
  const projLabels = projections.map(p => new Date(p.monthKey + '-02').toLocaleDateString('pl-PL', { month: 'short', year: '2-digit' }));
  const projPrincipal = projections.map(p => p.capital);
  const projInterest = projections.map(p => p.interest);
  const projTotal = projections.map(p => p.capital + p.interest);
  const projRates = projections.map(p => formatRateValue(p.rate));

  // === Combined data (paid + projected) for overview chart ===
  const allLabels = [...paymentLabels, ...projLabels];
  const allPrincipal = [...principalSeries, ...projPrincipal];
  const allInterest = [...interestSeries, ...projInterest];
  const allTotal = [...totalSeries, ...projTotal];

  const rateHistory = loanDetails.interestRateHistory || [];
  const paidRates = payments.map(p => formatRateValue(getRateForDate(p.date, rateHistory)));
  const allRates = [...paidRates, ...projRates];

  // === Cumulative (paid only) ===
  const cumulativePrincipal = [];
  const cumulativeInterest = [];
  let principalRunning = 0;
  let interestRunning = 0;
  principalSeries.forEach((value, index) => {
    principalRunning += value;
    interestRunning += interestSeries[index];
    cumulativePrincipal.push(principalRunning);
    cumulativeInterest.push(interestRunning);
  });

  // === Share % (paid only) ===
  const sharePrincipal = [];
  const shareInterest = [];
  totalSeries.forEach((total, index) => {
    if (total > 0) {
      const principalShare = Number(((principalSeries[index] / total) * 100).toFixed(1));
      const interestShare = Math.max(0, Number((100 - principalShare).toFixed(1)));
      sharePrincipal.push(principalShare);
      shareInterest.push(interestShare);
    } else {
      sharePrincipal.push(0);
      shareInterest.push(0);
    }
  });

  // === Balance (paid + projected) ===
  const totalCapitalAmount = Number(loanDetails.totalCapital || 0);
  let runningBalance = totalCapitalAmount;
  const paidBalances = payments.map((p, index) => {
    runningBalance -= principalSeries[index];
    return Math.max(runningBalance, 0);
  });
  const projBalances = projections.map(p => {
    runningBalance -= p.capital;
    return Math.max(runningBalance, 0);
  });
  const remainingBalances = paidBalances;
  const allBalances = [...paidBalances, ...projBalances];
  const allBalanceLabels = [...paymentLabels, ...projLabels];

  // === Rate history ===
  const rateHistoryLabels = paymentLabels;
  const rateHistoryValues = paidRates;
  const rateHistoryDiffs = rateHistoryValues.map((value, index) => {
    if (index === 0) return 0;
    const previous = rateHistoryValues[index - 1];
    const diff = value - previous;
    return formatRateValue(diff);
  });

  // === Aggregates ===
  const totalCapitalPaid = principalSeries.reduce((sum, value) => sum + value, 0);
  const totalInterestPaid = interestSeries.reduce((sum, value) => sum + value, 0);
  const averageInstallment = totalSeries.length
    ? Number((totalSeries.reduce((sum, value) => sum + value, 0) / totalSeries.length).toFixed(2))
    : 0;

  const paymentChangeValues = totalSeries.map((value, index) => {
    if (index === 0) return 0;
    return value - totalSeries[index - 1];
  });

  const paymentChangePercentages = totalSeries.map((value, index) => {
    if (index === 0) return 0;
    const previous = totalSeries[index - 1];
    if (!previous) return 0;
    return Number(((value - previous) / previous * 100).toFixed(2));
  });

  chartDataCache = {
    labels: paymentLabels,
    paidCount,
    principalSeries,
    basePrincipalSeries,
    overpaymentSeries,
    interestSeries,
    totalSeries,
    cumulativePrincipal,
    cumulativeInterest,
    sharePrincipal,
    shareInterest,
    interestRateData: paidRates,
    remainingBalances,
    rateHistoryLabels,
    rateHistoryValues,
    rateHistoryDiffs,
    paymentChangeValues,
    paymentChangePercentages,
    averageInstallment,
    totals: { principal: totalCapitalPaid, interest: totalInterestPaid },
    // Projection data
    projections,
    allLabels,
    allPrincipal,
    allInterest,
    allTotal,
    allRates,
    allBalances,
    allBalanceLabels,
    projLabels,
    projPrincipal,
    projInterest,
    projTotal,
    projRates,
    projBalances
  };

  // Show/hide projected legend
  const projLegend = $('#projected-legend');
  if (projLegend) projLegend.style.display = projections.length > 0 ? 'inline-flex' : 'none';

  const activePanel = document.querySelector('.loan-tab-panel.active');
  const activeChart = activePanel ? activePanel.dataset.chart : 'mix';
  renderChartForPanel(activeChart);
}

function destroyAllLoanCharts() {
  Object.keys(charts).forEach(key => {
    if (charts[key]) {
      charts[key].destroy();
      delete charts[key];
    }
  });
}

function getLoanPalette() {
  const styles = getComputedStyle(document.body);
  return {
    green: styles.getPropertyValue('--green').trim(),
    greenSoft: styles.getPropertyValue('--green-soft').trim(),
    orange: styles.getPropertyValue('--orange').trim(),
    orangeSoft: styles.getPropertyValue('--orange-soft').trim(),
    blue: styles.getPropertyValue('--blue').trim(),
    blueSoft: styles.getPropertyValue('--blue-soft').trim(),
    line: styles.getPropertyValue('--line').trim(),
    card: styles.getPropertyValue('--card').trim(),
    ink: styles.getPropertyValue('--ink').trim()
  };
}

function renderChartForPanel(panelType) {
  if (!chartDataCache) return;
  const palette = getLoanPalette();
  const {
    labels,
    paidCount,
    principalSeries,
    basePrincipalSeries,
    overpaymentSeries,
    interestSeries,
    totalSeries,
    interestRateData,
    totals,
    sharePrincipal,
    shareInterest,
    cumulativePrincipal,
    cumulativeInterest,
    remainingBalances,
    rateHistoryLabels,
    rateHistoryValues,
    rateHistoryDiffs,
    paymentChangeValues,
    paymentChangePercentages,
    averageInstallment,
    // Projections
    allLabels,
    allPrincipal,
    allInterest,
    allTotal,
    allRates,
    allBalances,
    allBalanceLabels,
    projections
  } = chartDataCache;

  if (panelType === 'mix') {
    const capitalCanvas = $('#capital-chart');
    if (capitalCanvas) {
      const capitalCtx = capitalCanvas.getContext('2d');
      const pc = paidCount || 0;
      // Build per-bar color arrays: solid for paid, soft for projected
      const capitalBg = allPrincipal.map((_, i) => i < pc ? palette.green : palette.greenSoft);
      const capitalBorder = allPrincipal.map((_, i) => i < pc ? 'transparent' : palette.green);
      const capitalBorderW = allPrincipal.map((_, i) => i < pc ? 0 : 2);
      const interestBg = allInterest.map((_, i) => i < pc ? palette.orange : palette.orangeSoft);
      const interestBorder = allInterest.map((_, i) => i < pc ? 'transparent' : palette.orange);
      const interestBorderW = allInterest.map((_, i) => i < pc ? 0 : 2);

      const minRateValue = allRates.length ? Math.min(...allRates) : 0;
      const maxRateValue = allRates.length ? Math.max(...allRates) : 0;
      const ratePadding = 0.4;
      const suggestedRateMin = Number.isFinite(minRateValue) ? Math.min(minRateValue - ratePadding, 4) : 0;
      const yRateMin = Math.max(0, Number.isFinite(suggestedRateMin) ? suggestedRateMin : 0);
      const yRateMax = Number.isFinite(maxRateValue) ? maxRateValue + ratePadding : undefined;

      if (charts.capital) {
        charts.capital.data.labels = allLabels;
        const rateDataset = charts.capital.data.datasets.find(ds => ds.label === 'Oprocentowanie');
        const principalDataset = charts.capital.data.datasets.find(ds => ds.label === 'Kapita≈Ç');
        const interestDataset = charts.capital.data.datasets.find(ds => ds.label === 'Odsetki');
        const averageDataset = charts.capital.data.datasets.find(ds => ds.label === '≈örednia rata');
        if (rateDataset) rateDataset.data = allRates;
        if (principalDataset) {
          principalDataset.data = allPrincipal;
          principalDataset.backgroundColor = capitalBg;
          principalDataset.borderColor = capitalBorder;
          principalDataset.borderWidth = capitalBorderW;
        }
        if (interestDataset) {
          interestDataset.data = allInterest;
          interestDataset.backgroundColor = interestBg;
          interestDataset.borderColor = interestBorder;
          interestDataset.borderWidth = interestBorderW;
        }
        if (averageDataset) {
          averageDataset.data = allLabels.map(() => averageInstallment);
          averageDataset.hidden = !averageInstallment;
        }
        if (charts.capital.options?.scales?.yRate) {
          charts.capital.options.scales.yRate.min = yRateMin;
          charts.capital.options.scales.yRate.max = yRateMax;
        }
        charts.capital.update();
      } else {
        charts.capital = new Chart(capitalCtx, {
          type: 'bar',
          data: {
            labels: allLabels,
            datasets: [
              { type: 'line', label: 'Oprocentowanie', data: allRates, borderColor: palette.blue, yAxisID: 'yRate', tension: 0.2, pointRadius: 3, pointBackgroundColor: palette.blue, borderWidth: 2, datalabels: { display: false } },
              { label: 'Kapita≈Ç', data: allPrincipal, backgroundColor: capitalBg, borderColor: capitalBorder, borderWidth: capitalBorderW, borderRadius: 4, order: 2, datalabels: { display: false } },
              {
                label: 'Odsetki',
                data: allInterest,
                backgroundColor: interestBg,
                borderColor: interestBorder,
                borderWidth: interestBorderW,
                borderRadius: 4,
                order: 3,
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  color: (ctx) => ctx.dataIndex < pc ? palette.ink : palette.muted || '#999',
                  font: (ctx) => ({ weight: ctx.dataIndex < pc ? 700 : 500, size: 11, style: ctx.dataIndex < pc ? 'normal' : 'italic' }),
                  formatter: (value, context) => {
                    const index = context.dataIndex;
                    const principalValue = context.chart.data.datasets[1].data[index] || 0;
                    const total = (value || 0) + principalValue;
                    return total ? fmtChartValue(total) : '';
                  }
                }
              },
              { type: 'line', label: '≈örednia rata', data: allLabels.map(() => averageInstallment), borderColor: palette.ink, borderDash: [6, 4], borderWidth: 1.5, yAxisID: 'y', pointRadius: 0, tension: 0, datalabels: { display: false }, hidden: !averageInstallment }
            ]
          },
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { stacked: true, grid: { display: false } },
              y: { stacked: true, grid: { color: palette.line }, ticks: { callback: (value) => fmtChartTick(value) } },
              yRate: { type: 'linear', position: 'right', grid: { display: false }, min: yRateMin, max: yRateMax, ticks: { callback: (value) => `${value}%` } }
            },
            plugins: {
              legend: { position: 'bottom', labels: { usePointStyle: true } },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    if (context.dataset.yAxisID === 'yRate') {
                      return `${context.dataset.label}: ${context.raw}%`;
                    }
                    return `${context.dataset.label}: ${fmtChartValue(context.raw)}`;
                  }
                }
              }
            }
          }
        });
      }
      setTimeout(() => charts.capital && charts.capital.resize(), 30);
    }

    const structureCanvas = $('#structure-chart');
    if (structureCanvas) {
      const structureCtx = structureCanvas.getContext('2d');
      const totalPaid = totals.principal + totals.interest;
      if (charts.structure) {
        charts.structure.data.datasets[0].data = [totals.principal, totals.interest];
        charts.structure.options.plugins.datalabels.formatter = (value, ctx) => {
          const sum = totals.principal + totals.interest;
          if (sum === 0) return '0%';
          const percentage = ((value / sum) * 100).toFixed(1) + '%';
          return ctx.dataset.data[ctx.dataIndex] > 0 ? percentage : '';
        };
        charts.structure.options.plugins.tooltip.callbacks.label = (context) => {
          const label = context.label || '';
          const value = context.raw || 0;
          const sum = totals.principal + totals.interest;
          const percentage = sum > 0 ? ((value / sum) * 100).toFixed(2) : 0;
          return `${label}: ${fmtChartValue(value)} (${percentage}%)`;
        };
        charts.structure.update();
      } else {
        charts.structure = new Chart(structureCtx, {
          type: 'doughnut',
          data: {
            labels: ['Sp≈Çacony kapita≈Ç', 'Zap≈Çacone odsetki'],
            datasets: [{ data: [totals.principal, totals.interest], backgroundColor: [palette.green, palette.orange], borderColor: palette.card, borderWidth: 5, hoverOffset: 8 }]
          },
          plugins: [ChartDataLabels, doughnutCenterText],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
              datalabels: {
                formatter: (value, ctx) => {
                  if (totalPaid === 0) return '0%';
                  const percentage = ((value / totalPaid) * 100).toFixed(1) + '%';
                  return ctx.dataset.data[ctx.dataIndex] > 0 ? percentage : '';
                },
                color: '#fff',
                font: { weight: 'bold', size: 12 }
              },
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const percentage = totalPaid > 0 ? ((value / totalPaid) * 100).toFixed(2) : 0;
                    return `${label}: ${fmtChartValue(value)} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }
      setTimeout(() => charts.structure && charts.structure.resize(), 30);
    }
  }

  if (panelType === 'line') {
    const lineCanvas = $('#monthly-line-chart');
    if (lineCanvas) {
      const lineCtx = lineCanvas.getContext('2d');
      if (charts.monthlyLine) {
        charts.monthlyLine.data.labels = labels;
        charts.monthlyLine.data.datasets[0].data = principalSeries;
        charts.monthlyLine.data.datasets[1].data = interestSeries;
        charts.monthlyLine.options.plugins.datalabels.display = chartLabelState.line;
        charts.monthlyLine.update();
      } else {
        charts.monthlyLine = new Chart(lineCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Kapita≈Ç', data: principalSeries, borderColor: palette.green, backgroundColor: palette.greenSoft, fill: false, tension: 0.25, pointRadius: 3, pointBackgroundColor: palette.green },
              { label: 'Odsetki', data: interestSeries, borderColor: palette.orange, backgroundColor: palette.orangeSoft, fill: false, tension: 0.25, pointRadius: 3, pointBackgroundColor: palette.orange }
            ]
          },
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${fmtChartValue(context.raw)}`
                }
              },
              datalabels: {
                display: chartLabelState.line,
                align: (context) => (context.datasetIndex === 0 ? 'top' : 'bottom'),
                anchor: (context) => (context.datasetIndex === 0 ? 'end' : 'start'),
                color: (context) => context.dataset.borderColor || palette.ink,
                font: { weight: 600, size: 10 },
                formatter: (value) => fmtChartValue(value)
              }
            },
            scales: {
              y: {
                grid: { color: palette.line },
                ticks: { callback: (value) => fmtChartTick(value) }
              }
            }
          }
        });
      }
      setTimeout(() => charts.monthlyLine && charts.monthlyLine.resize(), 30);
    }
  }
  if (panelType === 'share') {
    const shareCanvas = $('#share-area-chart');
    if (shareCanvas) {
      const shareCtx = shareCanvas.getContext('2d');
      const shareLabelFormatter = (value) => `${Number(value).toFixed(1)}%`;
      const shareLabelOffset = (context) => {
        const chart = context.chart;
        const datasetIndex = context.datasetIndex;
        const dataIndex = context.dataIndex;
        const yScale = chart.scales.y;
        if (!yScale) return 0;
        const meta = chart.getDatasetMeta(datasetIndex);
        if (!meta || !meta.data || !meta.data[dataIndex]) return 0;
        const element = meta.data[dataIndex];
        const target = datasetIndex === 0 ? 10 : 80;
        const targetPixel = yScale.getPixelForValue(target);
        const baseOffset = targetPixel - element.y;
        const separation = datasetIndex === 0 ? -14 : 14;
        return baseOffset + separation;
      };
      const shareLabelColor = (context) => (context.datasetIndex === 0 ? palette.green : palette.orange);
      if (charts.shareArea) {
        charts.shareArea.data.labels = labels;
        charts.shareArea.data.datasets[0].data = sharePrincipal;
        charts.shareArea.data.datasets[1].data = shareInterest;
        charts.shareArea.options.plugins.datalabels.display = (ctx) => chartLabelState.share && !ctx.dataset.hidden;
        charts.shareArea.options.plugins.datalabels.offset = shareLabelOffset;
        charts.shareArea.options.plugins.datalabels.color = shareLabelColor;
        charts.shareArea.options.plugins.datalabels.align = (ctx) => (ctx.datasetIndex === 0 ? 'end' : 'start');
        charts.shareArea.options.plugins.datalabels.anchor = (ctx) => (ctx.datasetIndex === 0 ? 'end' : 'start');
        charts.shareArea.options.plugins.datalabels.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        charts.shareArea.options.plugins.datalabels.borderRadius = 6;
        charts.shareArea.options.plugins.datalabels.padding = { top: 2, bottom: 2, left: 6, right: 6 };
        charts.shareArea.options.plugins.datalabels.formatter = shareLabelFormatter;
        charts.shareArea.update();
      } else {
        charts.shareArea = new Chart(shareCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Kapita≈Ç %', data: sharePrincipal, borderColor: palette.green, backgroundColor: palette.greenSoft, fill: 'origin', tension: 0.25, pointRadius: 0, stack: 'shares' },
              { label: 'Odsetki %', data: shareInterest, borderColor: palette.orange, backgroundColor: palette.orangeSoft, fill: '-1', tension: 0.25, pointRadius: 0, stack: 'shares' }
            ]
          },
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { usePointStyle: true } },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${context.raw.toFixed(1)}%`
                }
              },
              datalabels: {
                display: (ctx) => chartLabelState.share && !ctx.dataset.hidden,
                align: (ctx) => (ctx.datasetIndex === 0 ? 'end' : 'start'),
                anchor: (ctx) => (ctx.datasetIndex === 0 ? 'end' : 'start'),
                clip: false,
                offset: shareLabelOffset,
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderRadius: 6,
                padding: { top: 2, bottom: 2, left: 6, right: 6 },
                color: shareLabelColor,
                font: { weight: 600, size: 10 },
                formatter: shareLabelFormatter
              }
            },
            scales: {
              x: {
                grid: { color: palette.line, drawOnChartArea: false }
              },
              y: {
                stacked: true,
                min: 0,
                max: 100,
                ticks: { callback: (value) => `${value}%` },
                grid: { color: palette.line }
              }
            }
          }
        });
      }
      setTimeout(() => charts.shareArea && charts.shareArea.resize(), 30);
    }
  }
  if (panelType === 'cumulative') {
    const cumulativeCanvas = $('#cumulative-chart');
    if (cumulativeCanvas) {
      const cumulativeCtx = cumulativeCanvas.getContext('2d');
      if (charts.cumulative) {
        charts.cumulative.data.labels = labels;
        charts.cumulative.data.datasets[0].data = cumulativePrincipal;
        charts.cumulative.data.datasets[1].data = cumulativeInterest;
        charts.cumulative.data.datasets[2].data = cumulativePrincipal.map((value, index) => value + cumulativeInterest[index]);
        charts.cumulative.options.plugins.datalabels.display = chartLabelState.cumulative;
        charts.cumulative.options.plugins.datalabels.align = (context) => {
          if (context.datasetIndex === 2) return 'end';
          return context.datasetIndex === 1 ? 'bottom' : 'top';
        };
        charts.cumulative.options.plugins.datalabels.anchor = (context) => {
          if (context.datasetIndex === 2) return 'end';
          return context.datasetIndex === 1 ? 'start' : 'end';
        };
        charts.cumulative.options.plugins.datalabels.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        charts.cumulative.options.plugins.datalabels.borderRadius = 6;
        charts.cumulative.options.plugins.datalabels.padding = { top: 2, bottom: 2, left: 6, right: 6 };
        charts.cumulative.options.plugins.datalabels.clamp = true;
        charts.cumulative.options.plugins.datalabels.formatter = (value) => fmtChartValue(value);
        charts.cumulative.update();
      } else {
        charts.cumulative = new Chart(cumulativeCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Kapita≈Ç skumulowany', data: cumulativePrincipal, borderColor: palette.green, backgroundColor: palette.greenSoft, fill: false, tension: 0.25, pointRadius: 0 },
              { label: 'Odsetki skumulowane', data: cumulativeInterest, borderColor: palette.orange, backgroundColor: palette.orangeSoft, fill: false, tension: 0.25, pointRadius: 0 },
              { label: '≈ÅƒÖcznie', data: cumulativePrincipal.map((value, index) => value + cumulativeInterest[index]), borderColor: palette.blue, backgroundColor: palette.blueSoft, fill: false, borderDash: [6, 4], tension: 0.25, pointRadius: 0 }
            ]
          },
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${fmtChartValue(context.raw)}`
                }
              },
              datalabels: {
                display: chartLabelState.cumulative,
                align: (context) => {
                  if (context.datasetIndex === 2) return 'end';
                  return context.datasetIndex === 1 ? 'bottom' : 'top';
                },
                anchor: (context) => {
                  if (context.datasetIndex === 2) return 'end';
                  return context.datasetIndex === 1 ? 'start' : 'end';
                },
                color: (context) => context.dataset.borderColor || palette.ink,
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderRadius: 6,
                padding: { top: 2, bottom: 2, left: 6, right: 6 },
                font: { weight: 600, size: 10 },
                clamp: true,
                formatter: (value) => fmtChartValue(value)
              }
            },
            scales: {
              y: {
                grid: { color: palette.line },
                ticks: { callback: (value) => fmtChartTick(value) }
              }
            }
          }
        });
      }
      setTimeout(() => charts.cumulative && charts.cumulative.resize(), 30);
    }
  }
  if (panelType === 'balance') {
    const balanceCanvas = $('#balance-chart');
    if (balanceCanvas) {
      const balanceCtx = balanceCanvas.getContext('2d');
      const pc = paidCount || 0;
      const balPointBg = allBalances.map((_, i) => i < pc ? palette.blue : palette.blueSoft);
      const balPointBorder = allBalances.map((_, i) => i < pc ? palette.blue : palette.blue);
      const balPointRadius = allBalances.map((_, i) => i < pc ? 4 : 5);
      const balSegment = {
        borderDash: (ctx) => ctx.p0DataIndex >= pc - 1 ? [6, 4] : undefined,
        borderColor: (ctx) => ctx.p0DataIndex >= pc - 1 ? palette.line : palette.blue,
      };
      if (charts.balance) {
        charts.balance.data.labels = allBalanceLabels;
        charts.balance.data.datasets[0].data = allBalances;
        charts.balance.data.datasets[0].pointBackgroundColor = balPointBg;
        charts.balance.data.datasets[0].pointBorderColor = balPointBorder;
        charts.balance.data.datasets[0].pointRadius = balPointRadius;
        charts.balance.data.datasets[0].segment = balSegment;
        charts.balance.update();
      } else {
        charts.balance = new Chart(balanceCtx, {
          type: 'line',
          data: {
            labels: allBalanceLabels,
            datasets: [
              {
                label: 'Saldo po sp≈Çacie',
                data: allBalances,
                borderColor: palette.blue,
                backgroundColor: palette.blueSoft,
                fill: 'start',
                tension: 0.25,
                pointRadius: balPointRadius,
                pointHoverRadius: 6,
                pointBackgroundColor: balPointBg,
                pointBorderColor: balPointBorder,
                segment: balSegment
              }
            ]
          },
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const isProjIdx = context.dataIndex >= pc;
                    const prefix = isProjIdx ? 'Prognoza: ' : 'Saldo: ';
                    return `${prefix}${fmtChartValue(context.raw)}`;
                  }
                }
              },
              datalabels: {
                align: 'top',
                anchor: 'end',
                color: (ctx) => ctx.dataIndex >= pc ? palette.muted || '#999' : palette.ink,
                font: (ctx) => ({ weight: ctx.dataIndex >= pc ? 500 : 700, size: 11, style: ctx.dataIndex >= pc ? 'italic' : 'normal' }),
                formatter: (value, context) => {
                  const dataset = context.dataset.data || [];
                  if (context.dataIndex === dataset.length - 1) return fmtChartValue(value);
                  if (context.dataIndex === pc - 1 && projections.length > 0) return fmtChartValue(value);
                  return '';
                }
              }
            },
            scales: {
              y: {
                grid: { color: palette.line },
                ticks: { callback: (value) => fmtChartTick(value) }
              }
            }
          }
        });
      }
      setTimeout(() => charts.balance && charts.balance.resize(), 30);
    }
  }

  if (panelType === 'change') {
    const changeCanvas = $('#payment-change-chart');
    if (changeCanvas) {
      updateChangeModeButtons();
      const changeCtx = changeCanvas.getContext('2d');
      const barColors = paymentChangeValues.map(value => {
        if (value < 0) return palette.green;
        if (value > 0) return palette.orange;
        return palette.line;
      });
      const showValue = paymentChangeMode === 'value';
      const showPercent = paymentChangeMode === 'percent';
      if (charts.paymentChange) {
        charts.paymentChange.data.labels = labels;
        const valueDataset = charts.paymentChange.data.datasets.find(ds => ds.label === 'Zmiana kwotowa');
        const percentDataset = charts.paymentChange.data.datasets.find(ds => ds.label === 'Zmiana %');
        if (valueDataset) {
          valueDataset.data = paymentChangeValues;
          valueDataset.backgroundColor = barColors;
          valueDataset.hidden = !showValue;
        }
        if (percentDataset) {
          percentDataset.data = paymentChangePercentages;
          percentDataset.hidden = !showPercent;
        }
        if (charts.paymentChange.options?.scales?.yValue) {
          charts.paymentChange.options.scales.yValue.display = showValue;
        }
        if (charts.paymentChange.options?.scales?.yPercent) {
          charts.paymentChange.options.scales.yPercent.display = showPercent;
        }
        charts.paymentChange.options.plugins.datalabels.display = (ctx) => chartLabelState.change && !ctx.dataset.hidden;
        charts.paymentChange.update();
      } else {
        charts.paymentChange = new Chart(changeCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                type: 'bar',
                label: 'Zmiana kwotowa',
                data: paymentChangeValues,
                backgroundColor: barColors,
                borderRadius: 4,
                yAxisID: 'yValue',
                hidden: !showValue
              },
              {
                type: 'line',
                label: 'Zmiana %',
                data: paymentChangePercentages,
                borderColor: palette.blue,
                backgroundColor: palette.blueSoft,
                fill: false,
                tension: 0.25,
                pointRadius: 3,
                yAxisID: 'yPercent',
                hidden: !showPercent
              }
            ]
          },
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
              x: { grid: { display: false } },
              yValue: {
                type: 'linear',
                position: 'left',
                display: showValue,
                grid: { color: palette.line },
                ticks: { callback: (value) => fmtChartTick(value) }
              },
              yPercent: {
                type: 'linear',
                position: 'right',
                display: showPercent,
                grid: { display: false },
                ticks: {
                  callback: (value) => `${value}%`
                }
              }
            },
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    if (context.dataset.type === 'line') {
                      const numeric = Number(context.raw || 0);
                      const sign = numeric > 0 ? '+' : '';
                      return `${context.dataset.label}: ${sign}${numeric.toFixed(2)}%`;
                    }
                    return `${context.dataset.label}: ${fmtChartValue(context.raw)}`;
                  }
                }
              },
              datalabels: {
                display: (ctx) => chartLabelState.change && !ctx.dataset.hidden,
                align: (context) => {
                  if (context.dataset.type === 'line') return 'bottom';
                  return Number(context.raw || 0) >= 0 ? 'top' : 'bottom';
                },
                anchor: (context) => {
                  if (context.dataset.type === 'line') return 'start';
                  return Number(context.raw || 0) >= 0 ? 'end' : 'start';
                },
                color: (context) => {
                  if (context.dataset.type === 'line') return palette.blue;
                  const numeric = Number(context.raw || 0);
                  if (numeric < 0) return palette.green;
                  if (numeric > 0) return palette.orange;
                  return palette.ink;
                },
                font: { weight: 600, size: 10 },
                formatter: (value, context) => {
                  if (context.dataset.type === 'line') {
                    const numeric = Number(value || 0);
                    if (!numeric) return '0.00%';
                    const sign = numeric > 0 ? '+' : '';
                    return `${sign}${numeric.toFixed(2)}%`;
                  }
                  return fmtChartValue(value);
                }
              }
            }
          }
        });
      }
      setTimeout(() => charts.paymentChange && charts.paymentChange.resize(), 30);
    }
  }

  if (panelType === 'rate') {
    const rateCanvas = $('#rate-trend-chart');
    if (rateCanvas) {
      const rateCtx = rateCanvas.getContext('2d');
      const minRateValue = rateHistoryValues.length ? Math.min(...rateHistoryValues) : 0;
      const maxRateValue = rateHistoryValues.length ? Math.max(...rateHistoryValues) : 0;
      const ratePadding = 0.25;
      const yRateMin = Math.max(0, Math.min(minRateValue - ratePadding, 4));
      const yRateMax = maxRateValue + ratePadding;
      const pointColor = (index) => {
        const diff = rateHistoryDiffs[index] || 0;
        if (diff > 0.01) return palette.orange;
        if (diff < -0.01) return palette.green;
        return palette.line;
      };
      const pointRadius = (index) => (Math.abs(rateHistoryDiffs[index] || 0) >= 0.01 ? 4 : 2);
      if (charts.rateTrend) {
        charts.rateTrend.data.labels = rateHistoryLabels;
        charts.rateTrend.data.datasets[0].data = rateHistoryValues;
        charts.rateTrend.data.datasets[0].pointBackgroundColor = (ctx) => pointColor(ctx.dataIndex);
        charts.rateTrend.data.datasets[0].pointBorderColor = (ctx) => pointColor(ctx.dataIndex);
        charts.rateTrend.data.datasets[0].pointRadius = (ctx) => pointRadius(ctx.dataIndex);
        charts.rateTrend.data.datasets[0].pointHoverRadius = (ctx) => Math.max(5, pointRadius(ctx.dataIndex) + 1);
        charts.rateTrend.data.datasets[0].segment = {
          borderDash: (ctx) => (ctx.p0.parsed.y === ctx.p1.parsed.y ? [4, 4] : undefined),
          borderColor: (ctx) => (ctx.p0.parsed.y === ctx.p1.parsed.y ? palette.line : palette.orange)
        };
        charts.rateTrend.options.plugins.tooltip.callbacks.label = (context) => {
          const value = Number(context.raw || 0);
          const diff = rateHistoryDiffs[context.dataIndex] || 0;
          const base = `${context.dataset.label}: ${value.toFixed(2)}%`;
          if (context.dataIndex === 0 || Math.abs(diff) < 0.01) {
            return `${base} (bez zmian)`;
          }
          const sign = diff > 0 ? '+' : '';
          return `${base} (${sign}${diff.toFixed(2)} pp)`;
        };
        charts.rateTrend.options.plugins.datalabels.formatter = (value, context) => {
          const idx = context.dataIndex;
          const numeric = Number(value || 0);
          if (idx === 0) {
            return `${numeric.toFixed(2)}%`;
          }
          const diff = rateHistoryDiffs[idx] || 0;
          if (Math.abs(diff) < 0.01) {
            return '';
          }
          const sign = diff > 0 ? '+' : '';
          return `${sign}${diff.toFixed(2)} pp`;
        };
        if (charts.rateTrend.options?.scales?.y) {
          charts.rateTrend.options.scales.y.min = yRateMin;
          charts.rateTrend.options.scales.y.max = yRateMax;
        }
        charts.rateTrend.update();
      } else {
        charts.rateTrend = new Chart(rateCtx, {
          type: 'line',
          data: {
            labels: rateHistoryLabels,
            datasets: [
              {
                label: 'Oprocentowanie',
                data: rateHistoryValues,
                borderColor: palette.orange,
                backgroundColor: palette.orangeSoft,
                fill: 'start',
                tension: 0.25,
                pointRadius: (ctx) => pointRadius(ctx.dataIndex),
                pointHoverRadius: (ctx) => Math.max(5, pointRadius(ctx.dataIndex) + 1),
                pointBackgroundColor: (ctx) => pointColor(ctx.dataIndex),
                pointBorderColor: (ctx) => pointColor(ctx.dataIndex),
                segment: {
                  borderDash: (ctx) => (ctx.p0.parsed.y === ctx.p1.parsed.y ? [4, 4] : undefined),
                  borderColor: (ctx) => (ctx.p0.parsed.y === ctx.p1.parsed.y ? palette.line : palette.orange)
                }
              }
            ]
          },
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const value = Number(context.raw || 0);
                    const diff = rateHistoryDiffs[context.dataIndex] || 0;
                    const base = `${context.dataset.label}: ${value.toFixed(2)}%`;
                    if (context.dataIndex === 0 || Math.abs(diff) < 0.01) {
                      return `${base} (bez zmian)`;
                    }
                    const sign = diff > 0 ? '+' : '';
                    return `${base} (${sign}${diff.toFixed(2)} pp)`;
                  }
                }
              },
              datalabels: {
                align: 'top',
                anchor: 'end',
                color: palette.orange,
                font: { weight: 700, size: 11 },
                formatter: (value, context) => {
                  const idx = context.dataIndex;
                  const numeric = Number(value || 0);
                  if (idx === 0) {
                    return `${numeric.toFixed(2)}%`;
                  }
                  const diff = rateHistoryDiffs[idx] || 0;
                  if (Math.abs(diff) < 0.01) {
                    return '';
                  }
                  const sign = diff > 0 ? '+' : '';
                  return `${sign}${diff.toFixed(2)} pp`;
                }
              }
            },
            scales: {
              y: {
                grid: { color: palette.line },
                ticks: { callback: (value) => `${value}%` },
                min: yRateMin,
                max: yRateMax
              }
            }
          }
        });
      }
      setTimeout(() => charts.rateTrend && charts.rateTrend.resize(), 30);
    }
  }
}

function updateChartToggleLabels() {
  document.querySelectorAll('.loan-chart-toggle').forEach(button => {
    const target = button.dataset.chartToggle;
    if (!target) return;
    button.textContent = chartLabelState[target] ? 'Ukryj dane' : 'Poka≈º dane';
  });
}

function setupLoanChartToggles() {
  document.querySelectorAll('.loan-chart-toggle').forEach(button => {
    button.addEventListener('click', () => {
      const target = button.dataset.chartToggle;
      if (!target) return;
      chartLabelState[target] = !chartLabelState[target];
      updateChartToggleLabels();
      const activePanel = document.querySelector('.loan-tab-panel.active');
      const activeType = activePanel ? activePanel.dataset.chart : 'mix';
      renderChartForPanel(activeType);
    });
  });
  updateChartToggleLabels();
}

function updateChangeModeButtons() {
  document.querySelectorAll('.loan-chart-mode-btn').forEach(button => {
    const mode = button.dataset.changeMode;
    button.classList.toggle('active', mode === paymentChangeMode);
  });
}

function setupChangeModeSwitch() {
  document.querySelectorAll('.loan-chart-mode-btn').forEach(button => {
    button.addEventListener('click', () => {
      const mode = button.dataset.changeMode;
      if (!mode || mode === paymentChangeMode) return;
      paymentChangeMode = mode;
      updateChangeModeButtons();
      const activePanel = document.querySelector('.loan-tab-panel.active');
      if (activePanel && activePanel.dataset.chart === 'change') {
        renderChartForPanel('change');
      }
    });
  });
  updateChangeModeButtons();
}

function setupLoanChartTabs() {
  document.querySelectorAll('.loan-tab-btn').forEach(button => {
    button.addEventListener('click', () => {
      const target = button.dataset.chart;
      if (button.classList.contains('active')) {
        return;
      }
      document.querySelectorAll('.loan-tab-btn').forEach(btn => btn.classList.toggle('active', btn === button));
      document.querySelectorAll('.loan-tab-panel').forEach(panel => panel.classList.toggle('active', panel.dataset.chart === target));
      renderChartForPanel(target);
    });
  });
}

/* === Projections === */
function generateProjections(count = 3) {
  const { loanDetails, payments } = state;
  if (!loanDetails || !payments.length) return [];

  const sorted = [...payments].sort((a, b) => a.date.localeCompare(b.date));
  const totalOverpayments = sorted.reduce((s, p) => s + (p.overpayment || 0), 0);
  const totalCapitalPaid = sorted.reduce((s, p) => s + p.capital, 0) + totalOverpayments;
  let remainingCapital = loanDetails.totalCapital - totalCapitalPaid;

  const avgCapital = sorted.reduce((s, p) => s + p.capital, 0) / sorted.length;
  const history = loanDetails.interestRateHistory || [];
  const overrides = state.projectedPayments || [];

  const lastDate = sorted[sorted.length - 1].date;
  const [y, m] = lastDate.split('-').map(Number);
  const cursor = new Date(Date.UTC(y, m - 1, 1));

  const projections = [];
  for (let i = 0; i < count && remainingCapital > 0.01; i++) {
    cursor.setUTCMonth(cursor.getUTCMonth() + 1);
    const monthKey = `${cursor.getUTCFullYear()}-${String(cursor.getUTCMonth() + 1).padStart(2, '0')}`;

    const capital = Math.min(avgCapital, Math.max(remainingCapital, 0));
    const rate = getRateForDate(monthKey, history);
    const defaultInterest = Math.max(remainingCapital, 0) * ((rate || 0) / 100 / 12);

    const override = overrides.find(o => o.monthKey === monthKey);
    const interest = override ? override.interest : defaultInterest;

    projections.push({ monthKey, capital, interest, rate, isEdited: !!override });
    remainingCapital -= capital;
  }
  return projections;
}

function openProjectedEditModal(monthKey) {
  const projections = generateProjections(6);
  const proj = projections.find(p => p.monthKey === monthKey);
  if (!proj) return;

  const dateLabel = new Date(`${monthKey}-01`).toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
  const body = `
    <div class="form-group">
      <label class="form-label">MiesiƒÖc</label>
      <input type="text" class="form-input" value="${dateLabel}" disabled>
    </div>
    <div class="form-group">
      <label class="form-label">Prognozowany kapita≈Ç (obliczony ze ≈õredniej)</label>
      <input type="text" class="form-input" value="${proj.capital.toFixed(2)} z≈Ç" disabled>
    </div>
    <div class="form-group">
      <label class="form-label">Odsetki</label>
      <input type="number" id="projected-interest" class="form-input" step="0.01" value="${proj.interest.toFixed(2)}">
      <span class="tiny muted" style="margin-top:4px;display:block;">Domy≈õlnie z oprocentowania ${Number(proj.rate || 0).toFixed(2)}%. Zmie≈Ñ kwotƒô je≈õli np. inna liczba dni w miesiƒÖcu.</span>
    </div>
  `;
  const footer = `
    <button class="btn" onclick="closeModal()">Anuluj</button>
    ${proj.isEdited ? '<button class="btn" onclick="resetProjectedPayment(\'' + monthKey + '\')">Resetuj</button>' : ''}
    <button class="btn primary" onclick="saveProjectedPayment('${monthKey}')">Zapisz</button>
  `;
  openModal('Edytuj prognozƒô ‚Äî ' + dateLabel, body, footer);
}

function saveProjectedPayment(monthKey) {
  const interest = parseFloat($('#projected-interest').value);
  if (isNaN(interest) || interest < 0) { alert('Podaj prawid≈ÇowƒÖ kwotƒô odsetek.'); return; }
  if (!state.projectedPayments) state.projectedPayments = [];
  const idx = state.projectedPayments.findIndex(p => p.monthKey === monthKey);
  if (idx > -1) { state.projectedPayments[idx].interest = interest; }
  else { state.projectedPayments.push({ monthKey, interest }); }
  saveState(); closeModal(); render();
}

function resetProjectedPayment(monthKey) {
  if (!state.projectedPayments) return;
  state.projectedPayments = state.projectedPayments.filter(p => p.monthKey !== monthKey);
  saveState(); closeModal(); render();
}

/* === Schedule Timeline === */
let scheduleFilter = 'all';
let scheduleVisibleCount = 12;

function generateSchedule() {
  const { loanDetails, payments } = state;
  if (!loanDetails) return [];

  const schedule = [];
  const paidMap = {};
  (payments || []).forEach(p => {
    paidMap[p.date] = p;
  });

  const totalMonths = (loanDetails.loanTerm || 30) * 12;
  const history = loanDetails.interestRateHistory || [];
  const sortedPayments = [...(payments || [])].sort((a, b) => a.date.localeCompare(b.date));

  // Determine start month
  let startDate;
  if (sortedPayments.length) {
    const [y, m] = sortedPayments[0].date.split('-').map(Number);
    startDate = new Date(Date.UTC(y, m - 1, 1));
  } else if (history.length) {
    const [y, m] = history[0].date.split('-').map(Number);
    startDate = new Date(Date.UTC(y, m - 1, 1));
  } else {
    startDate = new Date();
    startDate.setDate(1);
  }

  const now = new Date();
  const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

  // Calculate averages from paid installments for projections
  const avgCapital = sortedPayments.length
    ? sortedPayments.reduce((s, p) => s + p.capital, 0) / sortedPayments.length
    : 0;
  const avgInterest = sortedPayments.length
    ? sortedPayments.reduce((s, p) => s + p.interest, 0) / sortedPayments.length
    : 0;

  let remainingCapital = loanDetails.totalCapital;
  // Subtract all paid amounts from remaining
  sortedPayments.forEach(p => {
    remainingCapital -= (p.capital + (p.overpayment || 0));
  });

  const cursor = new Date(startDate);
  for (let i = 0; i < totalMonths && remainingCapital > 0.01; i++) {
    const monthKey = `${cursor.getUTCFullYear()}-${String(cursor.getUTCMonth() + 1).padStart(2, '0')}`;
    const paid = paidMap[monthKey];

    let status;
    if (paid) {
      status = 'paid';
    } else if (monthKey === currentMonthKey) {
      status = 'current';
    } else if (monthKey < currentMonthKey) {
      status = 'overdue';
    } else {
      status = 'planned';
    }

    const rate = getRateForDate(monthKey, history);
    let capital, interest, overpayment, total;

    if (paid) {
      capital = paid.capital;
      interest = paid.interest;
      overpayment = paid.overpayment || 0;
      total = capital + interest + overpayment;
    } else {
      // Project from averages
      capital = avgCapital > 0 ? Math.min(avgCapital, Math.max(remainingCapital, 0)) : 0;
      const monthlyRate = (rate || 0) / 100 / 12;
      interest = avgInterest > 0 ? avgInterest : Math.max(remainingCapital, 0) * monthlyRate;
      overpayment = 0;
      total = capital + interest;
    }

    if (!paid && avgCapital > 0) {
      remainingCapital -= capital;
    }

    schedule.push({
      monthKey,
      date: new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth(), 1)),
      status,
      capital,
      interest,
      overpayment,
      total,
      rate,
      remainingCapital: Math.max(remainingCapital, 0),
      paymentId: paid ? paid.id : null
    });

    cursor.setUTCMonth(cursor.getUTCMonth() + 1);
  }

  return schedule;
}

function renderSchedule() {
  const timeline = $('#schedule-timeline');
  const summaryEl = $('#schedule-summary');
  const showMoreContainer = $('#schedule-show-more');
  if (!timeline) return;

  const schedule = generateSchedule();

  if (schedule.length === 0) {
    timeline.innerHTML = '<div class="schedule-empty">Skonfiguruj kredyt i dodaj raty, aby zobaczyƒá harmonogram.</div>';
    if (summaryEl) summaryEl.style.display = 'none';
    if (showMoreContainer) showMoreContainer.style.display = 'none';
    updateScheduleFilterCounts(schedule);
    return;
  }

  // Summary
  const paidCount = schedule.filter(s => s.status === 'paid').length;
  const plannedCount = schedule.filter(s => s.status === 'planned').length;
  const overdueCount = schedule.filter(s => s.status === 'overdue').length;
  const currentItem = schedule.find(s => s.status === 'current');
  const totalPaidAmount = schedule.filter(s => s.status === 'paid').reduce((s, item) => s + item.total, 0);
  const totalPlannedAmount = schedule.filter(s => s.status === 'planned' || s.status === 'current').reduce((s, item) => s + item.total, 0);

  if (summaryEl) {
    summaryEl.style.display = 'grid';
    summaryEl.innerHTML = `
      <div class="schedule-summary-item">
        <span class="label">Op≈Çacone raty</span>
        <span class="value">${paidCount} <span class="currency">/ ${schedule.length}</span></span>
      </div>
      <div class="schedule-summary-item">
        <span class="label">Zap≈Çacono ≈ÇƒÖcznie</span>
        <span class="value">${fmt(totalPaidAmount)}</span>
      </div>
      <div class="schedule-summary-item">
        <span class="label">Do zap≈Çacenia</span>
        <span class="value">${fmt(totalPlannedAmount)}</span>
      </div>
      ${overdueCount > 0 ? `
      <div class="schedule-summary-item">
        <span class="label">Zaleg≈Çe</span>
        <span class="value" style="color: hsl(0 76% 55%);">${overdueCount} rat</span>
      </div>` : `
      <div class="schedule-summary-item">
        <span class="label">Pozosta≈Ço rat</span>
        <span class="value">${plannedCount + (currentItem ? 1 : 0)}</span>
      </div>`}
    `;
  }

  updateScheduleFilterCounts(schedule);

  // Filter
  const filtered = scheduleFilter === 'all'
    ? schedule
    : schedule.filter(s => s.status === scheduleFilter || (scheduleFilter === 'planned' && s.status === 'current'));

  if (filtered.length === 0) {
    timeline.innerHTML = '<div class="schedule-empty">Brak rat w wybranej kategorii.</div>';
    if (showMoreContainer) showMoreContainer.style.display = 'none';
    return;
  }

  const visible = filtered.slice(0, scheduleVisibleCount);
  const hasMore = filtered.length > scheduleVisibleCount;

  const statusEmoji = {
    paid: '&#10003;',
    current: '&#9679;',
    planned: '&#8943;',
    overdue: '!'
  };

  const statusLabel = {
    paid: 'Op≈Çacona',
    current: 'Bie≈ºƒÖca',
    planned: 'Planowana',
    overdue: 'Zaleg≈Ça'
  };

  timeline.innerHTML = visible.map(item => {
    const dateLabel = item.date.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
    const breakdownParts = [];
    if (item.capital > 0) breakdownParts.push(`<span><span class="dot-green">&#9679;</span> Kapita≈Ç ${fmtPlain(item.capital)} z≈Ç</span>`);
    if (item.interest > 0) breakdownParts.push(`<span><span class="dot-orange">&#9679;</span> Odsetki ${fmtPlain(item.interest)} z≈Ç</span>`);
    if (item.overpayment > 0) breakdownParts.push(`<span><span class="dot-blue">&#9679;</span> Nadp≈Çata ${fmtPlain(item.overpayment)} z≈Ç</span>`);

    let actions = '';
    if (item.paymentId) {
      actions = `<div class="schedule-actions"><button class="btn tiny" onclick="openPaymentModal('${item.paymentId}')">Edytuj</button></div>`;
    } else if (item.status === 'current' || item.status === 'overdue') {
      actions = `<div class="schedule-actions"><button class="btn tiny primary" onclick="openPaymentModal(null)">Zarejestruj</button></div>`;
    } else if (item.status === 'planned') {
      actions = `<div class="schedule-actions"><button class="btn tiny" onclick="openProjectedEditModal('${item.monthKey}')">Edytuj prognozƒô</button></div>`;
    }

    return `
      <div class="schedule-item" data-status="${item.status}">
        <div class="schedule-dot">${statusEmoji[item.status]}</div>
        <div class="schedule-body">
          <div class="schedule-row">
            <span class="schedule-date">${dateLabel}</span>
            <span class="schedule-amount">${fmt(item.total)}</span>
          </div>
          <div class="schedule-row">
            <div class="schedule-breakdown">${breakdownParts.join('')}</div>
            <span class="schedule-badge ${item.status}">${statusLabel[item.status]}</span>
          </div>
          ${actions}
        </div>
      </div>
    `;
  }).join('');

  if (showMoreContainer) {
    showMoreContainer.style.display = hasMore ? 'block' : 'none';
  }
}

function updateScheduleFilterCounts(schedule) {
  const controls = $('#schedule-controls');
  if (!controls) return;

  const counts = {
    all: schedule.length,
    paid: schedule.filter(s => s.status === 'paid').length,
    planned: schedule.filter(s => s.status === 'planned' || s.status === 'current').length,
    overdue: schedule.filter(s => s.status === 'overdue').length
  };

  controls.querySelectorAll('.schedule-filter-btn').forEach(btn => {
    const filter = btn.dataset.filter;
    const countSpan = btn.querySelector('.count');
    if (countSpan) {
      countSpan.textContent = `(${counts[filter] || 0})`;
    } else {
      const span = document.createElement('span');
      span.className = 'count';
      span.textContent = `(${counts[filter] || 0})`;
      btn.appendChild(span);
    }
  });
}

function setupScheduleControls() {
  const controls = $('#schedule-controls');
  if (!controls) return;

  controls.addEventListener('click', (e) => {
    const btn = e.target.closest('.schedule-filter-btn');
    if (!btn) return;
    scheduleFilter = btn.dataset.filter;
    scheduleVisibleCount = 12;
    controls.querySelectorAll('.schedule-filter-btn').forEach(b => b.classList.toggle('active', b === btn));
    renderSchedule();
  });

  const showMoreBtn = $('#schedule-show-more-btn');
  if (showMoreBtn) {
    showMoreBtn.addEventListener('click', () => {
      scheduleVisibleCount += 12;
      renderSchedule();
    });
  }
}

/* === Event Listeners & Boot === */
function init() {
  loadState();
  render();
  setupLoanChartTabs();
  setupLoanChartToggles();
  setupChangeModeSwitch();
  setupScheduleControls();
  $('#setup-loan-btn').addEventListener('click', openSetupModal);
  $('#settings-btn').addEventListener('click', openSetupModal);
  $('#add-payment-btn').addEventListener('click', () => openPaymentModal(null));
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
  $('#modal-overlay').addEventListener('click', (e) => { if (e.target === $('#modal-overlay')) closeModal(); });
}
window.addEventListener('load', init);
</script>
</body>
</html>